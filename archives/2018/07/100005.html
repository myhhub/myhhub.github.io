<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="kubernetes,集群,高可用,安装">


    <meta name="description" content="kubernetes集群搭建系列之 kubeadm方式部署:

使用kubeadm搭建kubernetes集群(非高可用)、
使用kubeadm搭建高可用的kubernetes集群。



本系...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>二进制搭建高可用的kubernetes集群(一) | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx">


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="二进制搭建高可用的kubernetes集群(一)">
            
	            二进制搭建高可用的kubernetes集群(一)
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/cloud/">云计算</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/kubernetes/">kubernetes</a> <a class="tag-link" href="/tags/install/">安装</a> <a class="tag-link" href="/tags/colony/">集群</a> <a class="tag-link" href="/tags/availability/">高可用</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2018/07/03</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>1738</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <p>kubernetes集群搭建系列之 kubeadm方式部署:</p>
<ul>
<li><a href="100119.html">使用kubeadm搭建kubernetes集群(非高可用)</a>、</li>
<li><a href="100350.html">使用kubeadm搭建高可用的kubernetes集群</a>。</li>
</ul>
<hr>
<blockquote>
<p>本系列系文档适用于 CentOS 7、Ubuntu 16.04 及以上版本系统，由于启用了 TLS 双向认证、RBAC 授权等严格的安全机制，建议从头开始部署，否则可能会认证、授权等失败！</p>
</blockquote>
<h1 id="1-组件版本-amp-amp-集群环境"><a href="#1-组件版本-amp-amp-集群环境" class="headerlink" title="1. 组件版本 &amp;&amp; 集群环境"></a>1. 组件版本 &amp;&amp; 集群环境</h1><h2 id="组件版本"><a href="#组件版本" class="headerlink" title="组件版本"></a>组件版本</h2><ul>
<li>KKubernetes 1.8.2(1.9.x版本也可以，只有细微的差别)</li>
<li>Docker 17.10.0-ce</li>
<li>Etcd 3.2.9</li>
<li>Flanneld<h2 id="TLS-认证通信（所有组件，如etcd、kubernetes-master-和node）"><a href="#TLS-认证通信（所有组件，如etcd、kubernetes-master-和node）" class="headerlink" title="TLS 认证通信（所有组件，如etcd、kubernetes master 和node）"></a>TLS 认证通信（所有组件，如etcd、kubernetes master 和node）</h2></li>
<li>RBAC 授权</li>
<li>kubelet TLS Bootstrapping</li>
<li>kubedns、dashboard、heapster等插件</li>
<li>harbor，使用nfs后端存储</li>
<li>etcd 集群 &amp;&amp; k8s master 机器 &amp;&amp; k8s node 机器</li>
<li>master01：192.168.1.137</li>
<li>master02：192.168.1.138</li>
<li>master03/node03：192.168.1.170</li>
<li>由于机器有限，所以我们将master03 也作为node 节点，后续有新的机器增加即可</li>
<li>node01: 192.168.1.161</li>
<li>node02: 192.168.1.162</li>
</ul>
<h2 id="集群环境变量"><a href="#集群环境变量" class="headerlink" title="集群环境变量"></a>集群环境变量</h2><p>后面的嗯部署将会使用到的全局变量，定义如下（根据自己的机器、网络修改）：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># TLS Bootstrapping 使用的Token，可以使用命令 head -c 16 /dev/urandom | od -An -t x | tr -d ' ' 生成</span></span><br><span class="line"><span class="attr">BOOTSTRAP_TOKEN</span>=<span class="string">"8981b594122ebed7596f1d3b69c78223"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 建议使用未用的网段来定义服务网段和Pod 网段</span></span><br><span class="line"><span class="comment"># 服务网段(Service CIDR)，部署前路由不可达，部署后集群内部使用IP:Port可达</span></span><br><span class="line"><span class="attr">SERVICE_CIDR</span>=<span class="string">"10.254.0.0/16"</span></span><br><span class="line"><span class="comment"># Pod 网段(Cluster CIDR)，部署前路由不可达，部署后路由可达(flanneld 保证)</span></span><br><span class="line"><span class="attr">CLUSTER_CIDR</span>=<span class="string">"172.30.0.0/16"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务端口范围(NodePort Range)</span></span><br><span class="line"><span class="attr">NODE_PORT_RANGE</span>=<span class="string">"30000-32766"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># etcd集群服务地址列表</span></span><br><span class="line"><span class="attr">ETCD_ENDPOINTS</span>=<span class="string">"https://192.168.1.137:2379,https://192.168.1.138:2379,https://192.168.1.170:2379"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># flanneld 网络配置前缀</span></span><br><span class="line"><span class="attr">FLANNEL_ETCD_PREFIX</span>=<span class="string">"/kubernetes/network"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubernetes 服务IP(预先分配，一般为SERVICE_CIDR中的第一个IP)</span></span><br><span class="line"><span class="attr">CLUSTER_KUBERNETES_SVC_IP</span>=<span class="string">"10.254.0.1"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群 DNS 服务IP(从SERVICE_CIDR 中预先分配)</span></span><br><span class="line"><span class="attr">CLUSTER_DNS_SVC_IP</span>=<span class="string">"10.254.0.2"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 集群 DNS 域名</span></span><br><span class="line"><span class="attr">CLUSTER_DNS_DOMAIN</span>=<span class="string">"cluster.local."</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MASTER API Server 地址</span></span><br><span class="line"><span class="attr">MASTER_URL</span>=<span class="string">"k8s-api.virtual.local"</span></span><br></pre></td></tr></table></figure></p>
<p>将上面变量保存为: env.sh，然后将脚本拷贝到所有机器的/usr/k8s/bin目录。 为方便后面迁移，我们在集群内定义一个域名用于访问apiserver，在每个节点的/etc/hosts文件中添加记录：192.168.1.137 k8s-api.virtual.local k8s-api</p>
<p>其中192.168.1.137为master01 的IP，暂时使用该IP 来做apiserver 的负载地址</p>
<blockquote>
<p>如果你使用的是阿里云的ECS 服务，强烈建议你先将上述节点的安全组配置成允许所有访问，不然在安装过程中会遇到各种访问不了的问题，待集群配置成功以后再根据需要添加安全限制。</p>
</blockquote>
<h1 id="2-创建CA-证书和密钥"><a href="#2-创建CA-证书和密钥" class="headerlink" title="2. 创建CA 证书和密钥"></a>2. 创建CA 证书和密钥</h1><p>kubernetes 系统各个组件需要使用TLS证书对通信进行加密，这里我们使用CloudFlare的PKI 工具集cfssl 来生成Certificate Authority(CA) 证书和密钥文件， CA 是自签名的证书，用来签名后续创建的其他TLS 证书。</p>
<h2 id="安装-CFSSL"><a href="#安装-CFSSL" class="headerlink" title="安装 CFSSL"></a>安装 CFSSL</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>wget <span class="symbol">https:</span>/<span class="regexp">/pkg.cfssl.org/</span>R1.<span class="number">2</span>/cfssl_linux-amd64</span><br><span class="line"><span class="variable">$ </span>chmod +x cfssl_linux-amd64</span><br><span class="line"><span class="variable">$ </span>sudo mv cfssl_linux-amd64 /usr/k8s/bin/cfssl</span><br><span class="line"></span><br><span class="line"><span class="variable">$ </span>wget <span class="symbol">https:</span>/<span class="regexp">/pkg.cfssl.org/</span>R1.<span class="number">2</span>/cfssljson_linux-amd64</span><br><span class="line"><span class="variable">$ </span>chmod +x cfssljson_linux-amd64</span><br><span class="line"><span class="variable">$ </span>sudo mv cfssljson_linux-amd64 /usr/k8s/bin/cfssljson</span><br><span class="line"></span><br><span class="line"><span class="variable">$ </span>wget <span class="symbol">https:</span>/<span class="regexp">/pkg.cfssl.org/</span>R1.<span class="number">2</span>/cfssl-certinfo_linux-amd64</span><br><span class="line"><span class="variable">$ </span>chmod +x cfssl-certinfo_linux-amd64</span><br><span class="line"><span class="variable">$ </span>sudo mv cfssl-certinfo_linux-amd64 /usr/k8s/bin/cfssl-certinfo</span><br><span class="line"></span><br><span class="line"><span class="variable">$ </span>export PATH=<span class="regexp">/usr/k</span>8s/<span class="symbol">bin:</span><span class="variable">$PATH</span></span><br><span class="line"><span class="variable">$ </span>mkdir ssl &amp;&amp; cd ssl</span><br><span class="line"><span class="variable">$ </span>cfssl print-defaults config &gt; config.json</span><br><span class="line"><span class="variable">$ </span>cfssl print-defaults csr &gt; csr.json</span><br></pre></td></tr></table></figure>
<p>为了方便，将/usr/k8s/bin设置成环境变量，为了重启也有效，可以将上面的export PATH=/usr/k8s/bin:$PATH添加到/etc/rc.local文件中。</p>
<h2 id="创建CA"><a href="#创建CA" class="headerlink" title="创建CA"></a>创建CA</h2><p>修改上面创建的config.json文件为ca-config.json：<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ cat ca-<span class="built_in">config</span>.<span class="keyword">json</span></span><br><span class="line"><span class="keyword">&#123;</span></span><br><span class="line"><span class="keyword"> </span>   <span class="string">"signing"</span>: &#123;</span><br><span class="line">        <span class="string">"default"</span>: &#123;</span><br><span class="line">            <span class="string">"expiry"</span>: <span class="string">"87600h"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"profiles"</span>: &#123;</span><br><span class="line">            <span class="string">"kubernetes"</span>: &#123;</span><br><span class="line">                <span class="string">"expiry"</span>: <span class="string">"87600h"</span>,</span><br><span class="line">                <span class="string">"usages"</span>: [</span><br><span class="line">                    <span class="string">"signing"</span>,</span><br><span class="line">                    <span class="string">"key encipherment"</span>,</span><br><span class="line">                    <span class="string">"server auth"</span>,</span><br><span class="line">                    <span class="string">"client auth"</span></span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>config.json：可以定义多个profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个profile；</li>
<li>signing: 表示该证书可用于签名其它证书；生成的ca.pem 证书中CA=TRUE；</li>
<li>server auth: 表示client 可以用该CA 对server 提供的证书进行校验；</li>
<li>client auth: 表示server 可以用该CA 对client 提供的证书进行验证。</li>
</ul>
<p>修改CA 证书签名请求为ca-csr.json：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">	$ <span class="keyword">cat</span> <span class="keyword">ca</span>-csr.json</span><br><span class="line">	&#123;</span><br><span class="line">	    <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">	    <span class="string">"key"</span>: &#123;</span><br><span class="line">	        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">	        <span class="string">"size"</span>: 2048</span><br><span class="line">	    &#125;,</span><br><span class="line">	    <span class="string">"names"</span>: [</span><br><span class="line">	        &#123;</span><br><span class="line">	            <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">	            <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">	            <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">	            <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">	            <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">	        &#125;</span><br><span class="line">	    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>CN: Common Name，kube-apiserver 从证书中提取该字段作为请求的用户名(User Name)；浏览器使用该字段验证网站是否合法；</li>
<li>O: Organization，kube-apiserver 从证书中提取该字段作为请求用户所属的组(Group)；</li>
</ul>
<p>生成CA 证书和私钥：<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl gencert -initca <span class="keyword">ca</span>-csr.json | cfssljson -bare <span class="keyword">ca</span></span><br><span class="line">$ <span class="keyword">ls</span> <span class="keyword">ca</span>*</span><br><span class="line">$ <span class="keyword">ca</span>-config.json  <span class="keyword">ca</span>.csr  <span class="keyword">ca</span>-csr.json  <span class="keyword">ca</span>-key.pem  <span class="keyword">ca</span>.pem</span><br></pre></td></tr></table></figure></p>
<h2 id="分发证书"><a href="#分发证书" class="headerlink" title="分发证书"></a>分发证书</h2><p>将生成的CA 证书、密钥文件、配置文件拷贝到所有机器的/etc/kubernetes/ssl目录下面：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>sudo mkdir -p /etc/kubernetes/ssl</span><br><span class="line"><span class="variable">$ </span>sudo cp ca* <span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl</span></span><br></pre></td></tr></table></figure></p>
<h1 id="3-部署高可用etcd-集群"><a href="#3-部署高可用etcd-集群" class="headerlink" title="3. 部署高可用etcd 集群"></a>3. 部署高可用etcd 集群</h1><p>kubernetes 系统使用etcd存储所有的数据，我们这里部署3个节点的etcd 集群，这3个节点直接复用kubernetes master的3个节点，分别命名为etcd01、etcd02、etcd03:</p>
<ul>
<li>etcd01：192.168.1.137</li>
<li>etcd02：192.168.1.138</li>
<li>etcd03：192.168.1.170</li>
</ul>
<h2 id="定义环境变量"><a href="#定义环境变量" class="headerlink" title="定义环境变量"></a>定义环境变量</h2><p>使用到的变量如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="builtin-name">export</span> <span class="attribute">NODE_NAME</span>=etcd01 # 当前部署的机器名称(随便定义，只要能区分不同机器即可)</span><br><span class="line">$ <span class="builtin-name">export</span> <span class="attribute">NODE_IP</span>=192.168.1.137 # 当前部署的机器IP</span><br><span class="line">$ <span class="builtin-name">export</span> <span class="attribute">NODE_IPS</span>=<span class="string">"192.168.1.137 192.168.1.138 192.168.1.170"</span> # etcd 集群所有机器 IP</span><br><span class="line">$ # etcd 集群间通信的IP和端口</span><br><span class="line">$ <span class="builtin-name">export</span> <span class="attribute">ETCD_NODES</span>=etcd01=https://192.168.1.137:2380,etcd02=https://192.168.1.138:2380,etcd03=https://192.168.1.170:2380</span><br><span class="line">$ # 导入用到的其它全局变量：ETCD_ENDPOINTS、FLANNEL_ETCD_PREFIX、CLUSTER_CIDR</span><br><span class="line">$ source /usr/k8s/bin/env.sh</span><br></pre></td></tr></table></figure></p>
<p>33 下载etcd 二进制文件<br>到<a href="https://github.com/coreos/etcd/releases页面下载最新版本的二进制文件：" target="_blank" rel="noopener">https://github.com/coreos/etcd/releases页面下载最新版本的二进制文件：</a><br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://github.com/coreos/etcd/releases/download/v3<span class="meta">.2</span><span class="meta">.9</span>/etcd-v3<span class="meta">.2</span><span class="meta">.9</span>-linux-amd64.tar.gz</span><br><span class="line">$ tar -xvf etcd-v3<span class="meta">.2</span><span class="meta">.9</span>-linux-amd64.tar.gz</span><br><span class="line">$ sudo mv etcd-v3<span class="meta">.2</span><span class="meta">.9</span>-linux-amd64/etcd* /usr/k8s/bin/</span><br></pre></td></tr></table></figure></p>
<h2 id="创建TLS-密钥和证书"><a href="#创建TLS-密钥和证书" class="headerlink" title="创建TLS 密钥和证书"></a>创建TLS 密钥和证书</h2><p>为了保证通信安全，客户端(如etcdctl)与etcd 集群、etcd 集群之间的通信需要使用TLS 加密。</p>
<p>创建etcd 证书签名请求：<br><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; etcd-csr.json &lt;&lt;<span class="symbol">EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"etcd"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"$&#123;NODE_IP&#125;"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="symbol">EOF</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>hosts 字段指定授权使用该证书的etcd节点IP</li>
</ul>
<p>生成etcd证书和私钥：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>cfssl gencert -ca=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \</span><br><span class="line">  -ca-key=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>-key.pem \</span><br><span class="line">  -config=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>-config.json \</span><br><span class="line">  -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class="line"><span class="variable">$ </span>ls etcd*</span><br><span class="line">etcd.csr  etcd-csr.json  etcd-key.pem  etcd.pem</span><br><span class="line"><span class="variable">$ </span>sudo mkdir -p /etc/etcd/ssl</span><br><span class="line"><span class="variable">$ </span>sudo mv etcd*.pem /etc/etcd/ssl/</span><br></pre></td></tr></table></figure></p>
<h2 id="创建etcd-的systemd-unit-文件"><a href="#创建etcd-的systemd-unit-文件" class="headerlink" title="创建etcd 的systemd unit 文件"></a>创建etcd 的systemd unit 文件</h2><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir -p /var/<span class="class"><span class="keyword">lib</span>/<span class="title">etcd</span>  <span class="comment"># 必须要先创建工作目录</span></span></span><br><span class="line">$ cat &gt; etcd.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Documentation=<span class="symbol">https:</span>/<span class="regexp">/github.com/coreos</span></span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=<span class="regexp">/var/lib</span><span class="regexp">/etcd/</span></span><br><span class="line">ExecStart=<span class="regexp">/usr/k</span>8s/bin/etcd \\</span><br><span class="line">  --name=$&#123;NODE_NAME&#125; \\</span><br><span class="line">  --cert-file=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/etcd</span>.pem \\</span><br><span class="line">  --key-file=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/etcd</span>-key.pem \\</span><br><span class="line">  --peer-cert-file=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/etcd</span>.pem \\</span><br><span class="line">  --peer-key-file=<span class="regexp">/etc/etcd</span><span class="regexp">/ssl/etcd</span>-key.pem \\</span><br><span class="line">  --trusted-ca-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span><br><span class="line">  --peer-trusted-ca-file=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \\</span><br><span class="line">  --initial-advertise-peer-urls=<span class="symbol">https:</span>/<span class="regexp">/$&#123;NODE_IP&#125;:2380 \\</span></span><br><span class="line"><span class="regexp">  --listen-peer-urls=https:/</span><span class="regexp">/$&#123;NODE_IP&#125;:2380 \\</span></span><br><span class="line"><span class="regexp">  --listen-client-urls=https:/</span><span class="regexp">/$&#123;NODE_IP&#125;:2379,http:/</span><span class="regexp">/127.0.0.1:2379 \\</span></span><br><span class="line"><span class="regexp">  --advertise-client-urls=https:/</span><span class="regexp">/$&#123;NODE_IP&#125;:2379 \\</span></span><br><span class="line"><span class="regexp">  --initial-cluster-token=etcd-cluster-0 \\</span></span><br><span class="line"><span class="regexp">  --initial-cluster=$&#123;ETCD_NODES&#125; \\</span></span><br><span class="line"><span class="regexp">  --initial-cluster-state=new \\</span></span><br><span class="line"><span class="regexp">  --data-dir=/var</span><span class="regexp">/lib/etcd</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=<span class="number">5</span></span><br><span class="line">LimitNOFILE=<span class="number">65536</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ul>
<li>指定etcd的工作目录和数据目录为/var/lib/etcd，需要在启动服务前创建这个目录；</li>
<li>为了保证通信安全，需要指定etcd 的公私钥(cert-file和key-file)、Peers通信的公私钥和CA 证书(peer-cert-file、peer-key-file、peer-trusted-ca-file)、客户端的CA 证书(trusted-ca-file)；</li>
<li>–initial-cluster-state值为new时，–name的参数值必须位于–initial-cluster列表中；</li>
</ul>
<h2 id="启动etcd-服务"><a href="#启动etcd-服务" class="headerlink" title="启动etcd 服务"></a>启动etcd 服务</h2><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span> sudo mv etcd.service /etc/systemd/<span class="keyword">system</span>/</span><br><span class="line"><span class="symbol">$</span> sudo systemctl daemon-reload</span><br><span class="line"><span class="symbol">$</span> sudo systemctl enable etcd</span><br><span class="line"><span class="symbol">$</span> sudo systemctl start etcd</span><br><span class="line"><span class="symbol">$</span> sudo systemctl status etcd</span><br></pre></td></tr></table></figure>
<p>最先启动的etcd 进程会卡住一段时间，等待其他节点启动加入集群，在所有的etcd 节点重复上面的步骤，直到所有的机器etcd 服务都已经启动。</p>
<p>33 验证服务<br>部署完etcd 集群后，在任一etcd 节点上执行下面命令：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span><span class="built_in"> ip </span><span class="keyword">in</span> <span class="variable">$&#123;NODE_IPS&#125;</span>; <span class="keyword">do</span></span><br><span class="line">  <span class="attribute">ETCDCTL_API</span>=3 /usr/k8s/bin/etcdctl \</span><br><span class="line">  <span class="attribute">--endpoints</span>=https://$&#123;ip&#125;:2379  \</span><br><span class="line">  <span class="attribute">--cacert</span>=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  <span class="attribute">--cert</span>=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  <span class="attribute">--key</span>=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  endpoint<span class="built_in"> health; </span>done</span><br></pre></td></tr></table></figure></p>
<p>输出如下结果：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">https:</span><span class="string">//192.168.1.137:2379</span> <span class="string">is</span> <span class="attr">healthy:</span> <span class="string">successfully</span> <span class="string">committed</span> <span class="attr">proposal:</span> <span class="string">took</span> <span class="string">=</span> <span class="number">1.509032</span><span class="string">ms</span></span><br><span class="line"><span class="attr">https:</span><span class="string">//192.168.1.138:2379</span> <span class="string">is</span> <span class="attr">healthy:</span> <span class="string">successfully</span> <span class="string">committed</span> <span class="attr">proposal:</span> <span class="string">took</span> <span class="string">=</span> <span class="number">1.639228</span><span class="string">ms</span></span><br><span class="line"><span class="attr">https:</span><span class="string">//192.168.1.170:2379</span> <span class="string">is</span> <span class="attr">healthy:</span> <span class="string">successfully</span> <span class="string">committed</span> <span class="attr">proposal:</span> <span class="string">took</span> <span class="string">=</span> <span class="number">1.4152</span><span class="string">ms</span></span><br></pre></td></tr></table></figure></p>
<p>可以看到上面的信息3个节点上的etcd 均为healthy，则表示集群服务正常。</p>
<hr>
<p>接下文：<a href="100006.html">手动搭建高可用的kubernetes集群(二)</a></p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2018/07/100006.html" class="pre-post btn btn-default" title='二进制搭建高可用的kubernetes集群(二)'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">二进制搭建高可用的kubernetes集群(二)</span>
        </a>
    
    
        <a href="/archives/2018/07/100125.html" class="next-post btn btn-default" title='kubernetes基础知识'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">kubernetes基础知识</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-组件版本-amp-amp-集群环境"><span class="toc-text">1. 组件版本 &amp;&amp; 集群环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#组件版本"><span class="toc-text">组件版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TLS-认证通信（所有组件，如etcd、kubernetes-master-和node）"><span class="toc-text">TLS 认证通信（所有组件，如etcd、kubernetes master 和node）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#集群环境变量"><span class="toc-text">集群环境变量</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-创建CA-证书和密钥"><span class="toc-text">2. 创建CA 证书和密钥</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装-CFSSL"><span class="toc-text">安装 CFSSL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建CA"><span class="toc-text">创建CA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分发证书"><span class="toc-text">分发证书</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-部署高可用etcd-集群"><span class="toc-text">3. 部署高可用etcd 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#定义环境变量"><span class="toc-text">定义环境变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建TLS-密钥和证书"><span class="toc-text">创建TLS 密钥和证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建etcd-的systemd-unit-文件"><span class="toc-text">创建etcd 的systemd unit 文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#启动etcd-服务"><span class="toc-text">启动etcd 服务</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2023&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>