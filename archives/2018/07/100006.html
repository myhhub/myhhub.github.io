<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="kubernetes,集群,高可用,安装">


    <meta name="description" content="接上文：手动搭建高可用的kubernetes集群(一) 

4. 配置kubectl 命令行工具kubectl默认从~/.kube/config配置文件中获取访问kube-apiserver 地...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>二进制搭建高可用的kubernetes集群(二) | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx">


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="二进制搭建高可用的kubernetes集群(二)">
            
	            二进制搭建高可用的kubernetes集群(二)
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/cloud/">云计算</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/kubernetes/">kubernetes</a> <a class="tag-link" href="/tags/install/">安装</a> <a class="tag-link" href="/tags/colony/">集群</a> <a class="tag-link" href="/tags/availability/">高可用</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2018/07/04</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>1746</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <p>接上文：<a href="100005.html">手动搭建高可用的kubernetes集群(一)</a> </p>
<hr>
<h1 id="4-配置kubectl-命令行工具"><a href="#4-配置kubectl-命令行工具" class="headerlink" title="4. 配置kubectl 命令行工具"></a>4. 配置kubectl 命令行工具</h1><p>kubectl默认从~/.kube/config配置文件中获取访问kube-apiserver 地址、证书、用户名等信息，需要正确配置该文件才能正常使用kubectl命令。</p>
<p>需要将下载的kubectl 二进制文件和生产的~/.kube/config配置文件拷贝到需要使用kubectl 命令的机器上。</p>
<blockquote>
<p>很多童鞋说这个地方不知道在哪个节点上执行，kubectl只是一个和kube-apiserver进行交互的一个命令行工具，所以你想安装到那个节点都行，master或者node任意节点都可以，比如你先在master节点上安装，这样你就可以在master节点使用kubectl命令行工具了，如果你想在node节点上使用(当然安装的过程肯定会用到的)，你就把master上面的kubectl二进制文件和~/.kube/config文件拷贝到对应的node节点上就行了。</p>
</blockquote>
<h2 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">source</span> /usr/k8s/bin/env.sh</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> KUBE_APISERVER=<span class="string">"https://<span class="variable">$&#123;MASTER_URL&#125;</span>:6443"</span></span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意这里的KUBE_APISERVER地址，因为我们还没有安装haproxy，所以暂时需要手动指定使用apiserver的6443端口，等haproxy安装完成后就可以用使用443端口转发到6443端口去了。</p>
</blockquote>
<ul>
<li>变量KUBE_APISERVER 指定kubelet 访问的kube-apiserver 的地址，后续被写入~/.kube/config配置文件</li>
</ul>
<h2 id="下载kubectl"><a href="#下载kubectl" class="headerlink" title="下载kubectl"></a>下载kubectl</h2><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>wget <span class="symbol">https:</span>/<span class="regexp">/dl.k8s.io/v</span>1.<span class="number">8.2</span>/kubernetes-client-linux-amd64.tar.gz <span class="comment"># 如果服务器上下载不下来，可以想办法下载到本地，然后scp上去即可</span></span><br><span class="line"><span class="variable">$ </span>tar -xzvf kubernetes-client-linux-amd64.tar.gz</span><br><span class="line"><span class="variable">$ </span>sudo cp kubernetes/client/bin/kube* <span class="regexp">/usr/k</span>8s/bin/</span><br><span class="line"><span class="variable">$ </span>sudo chmod a+x /usr/k8s/bin/kube*</span><br><span class="line"><span class="variable">$ </span>export PATH=<span class="regexp">/usr/k</span>8s/<span class="symbol">bin:</span><span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>
<h2 id="创建admin-证书"><a href="#创建admin-证书" class="headerlink" title="创建admin 证书"></a>创建admin 证书</h2><p>kubectl 与kube-apiserver 的安全端口通信，需要为安全通信提供TLS 证书和密钥。创建admin 证书签名请求：<br><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; admin-csr.json &lt;&lt;<span class="symbol">EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"admin"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="symbol">EOF</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>后续kube-apiserver使用RBAC 对客户端(如kubelet、kube-proxy、Pod)请求进行授权</li>
<li>kube-apiserver 预定义了一些RBAC 使用的RoleBindings，如cluster-admin 将Group system:masters与Role cluster-admin绑定，该Role 授予了调用kube-apiserver所有API 的权限</li>
<li>O 指定了该证书的Group 为system:masters，kubectl使用该证书访问kube-apiserver时，由于证书被CA 签名，所以认证通过，同时由于证书用户组为经过预授权的system:masters，所以被授予访问所有API 的劝降</li>
<li>hosts 属性值为空列表</li>
</ul>
<p>生成admin 证书和私钥：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>cfssl gencert -ca=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \</span><br><span class="line">  -ca-key=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>-key.pem \</span><br><span class="line">  -config=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>-config.json \</span><br><span class="line">  -profile=kubernetes admin-csr.json | cfssljson -bare admin</span><br><span class="line"><span class="variable">$ </span>ls admin</span><br><span class="line">admin.csr  admin-csr.json  admin-key.pem  admin.pem</span><br><span class="line"><span class="variable">$ </span>sudo mv admin*.pem /etc/kubernetes/ssl/</span><br></pre></td></tr></table></figure></p>
<h2 id="创建kubectl-kubeconfig-文件"><a href="#创建kubectl-kubeconfig-文件" class="headerlink" title="创建kubectl kubeconfig 文件"></a>创建kubectl kubeconfig 文件</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置集群参数</span></span><br><span class="line">$ kubectl<span class="built_in"> config </span>set-cluster kubernetes \</span><br><span class="line">  <span class="attribute">--certificate-authority</span>=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--server</span>=<span class="variable">$&#123;KUBE_APISERVER&#125;</span></span><br><span class="line"><span class="comment"># 设置客户端认证参数</span></span><br><span class="line">$ kubectl<span class="built_in"> config </span>set-credentials admin \</span><br><span class="line">  <span class="attribute">--client-certificate</span>=/etc/kubernetes/ssl/admin.pem \</span><br><span class="line">  <span class="attribute">--embed-certs</span>=<span class="literal">true</span> \</span><br><span class="line">  <span class="attribute">--client-key</span>=/etc/kubernetes/ssl/admin-key.pem \</span><br><span class="line">  <span class="attribute">--token</span>=<span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span></span><br><span class="line"><span class="comment"># 设置上下文参数</span></span><br><span class="line">$ kubectl<span class="built_in"> config </span>set-context kubernetes \</span><br><span class="line">  <span class="attribute">--cluster</span>=kubernetes \</span><br><span class="line">  <span class="attribute">--user</span>=admin</span><br><span class="line"><span class="comment"># 设置默认上下文</span></span><br><span class="line">$ kubectl<span class="built_in"> config </span>use-context kubernetes</span><br></pre></td></tr></table></figure>
<ul>
<li>admin.pem证书O 字段值为system:masters，kube-apiserver 预定义的 RoleBinding cluster-admin 将 Group system:masters 与 Role cluster-admin 绑定，该 Role 授予了调用kube-apiserver 相关 API 的权限</li>
<li>生成的kubeconfig 被保存到 ~/.kube/config 文件</li>
</ul>
<h2 id="分发kubeconfig-文件"><a href="#分发kubeconfig-文件" class="headerlink" title="分发kubeconfig 文件"></a>分发kubeconfig 文件</h2><p>将~/.kube/config文件拷贝到运行kubectl命令的机器的~/.kube/目录下去。</p>
<h1 id="5-部署Flannel-网络"><a href="#5-部署Flannel-网络" class="headerlink" title="5. 部署Flannel 网络"></a>5. 部署Flannel 网络</h1><p>kubernetes 要求集群内各节点能通过Pod 网段互联互通，下面我们来使用Flannel 在所有节点上创建互联互通的Pod 网段的步骤。</p>
<blockquote>
<p>需要在所有的Node节点安装。</p>
</blockquote>
<h2 id="环境变量-1"><a href="#环境变量-1" class="headerlink" title="环境变量"></a>环境变量</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> NODE_IP=192.168.1.137  <span class="comment"># 当前部署节点的IP</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 导入全局变量</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">source</span> /usr/k8s/bin/env.sh</span></span><br></pre></td></tr></table></figure>
<h2 id="创建TLS-密钥和证书"><a href="#创建TLS-密钥和证书" class="headerlink" title="创建TLS 密钥和证书"></a>创建TLS 密钥和证书</h2><p>etcd 集群启用了双向TLS 认证，所以需要为flanneld 指定与etcd 集群通信的CA 和密钥。</p>
<p>创建flanneld 证书签名请求：<br><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; flanneld-csr.json &lt;&lt;<span class="symbol">EOF</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"flanneld"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: <span class="number">2048</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="symbol">EOF</span></span><br></pre></td></tr></table></figure></p>
<p>生成flanneld 证书和私钥：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>cfssl gencert -ca=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>.pem \</span><br><span class="line">  -ca-key=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>-key.pem \</span><br><span class="line">  -config=<span class="regexp">/etc/kubernetes</span><span class="regexp">/ssl/ca</span>-config.json \</span><br><span class="line">  -profile=kubernetes flanneld-csr.json | cfssljson -bare flanneld</span><br><span class="line"><span class="variable">$ </span>ls flanneld*</span><br><span class="line">flanneld.csr  flanneld-csr.json  flanneld-key.pem flanneld.pem</span><br><span class="line"><span class="variable">$ </span>sudo mkdir -p /etc/flanneld/ssl</span><br><span class="line"><span class="variable">$ </span>sudo mv flanneld*.pem /etc/flanneld/ssl</span><br></pre></td></tr></table></figure></p>
<h2 id="向etcd-写入集群Pod-网段信息"><a href="#向etcd-写入集群Pod-网段信息" class="headerlink" title="向etcd 写入集群Pod 网段信息"></a>向etcd 写入集群Pod 网段信息</h2><blockquote>
<p>该步骤只需在第一次部署Flannel 网络时执行，后续在其他节点上部署Flanneld 时无需再写入该信息</p>
</blockquote>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ etcdctl \</span><br><span class="line">  --endpoints=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  --<span class="keyword">ca</span>-<span class="keyword">file</span>=/etc/kubernetes/ssl/<span class="keyword">ca</span>.pem \</span><br><span class="line">  --cert-<span class="keyword">file</span>=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  --key-<span class="keyword">file</span>=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  <span class="keyword">set</span> <span class="variable">$&#123;FLANNEL_ETCD_PREFIX&#125;</span>/config '&#123;<span class="string">"Network"</span>:<span class="string">"'$&#123;CLUSTER_CIDR&#125;'"</span>, <span class="string">"SubnetLen"</span>: 24, <span class="string">"Backend"</span>: &#123;<span class="string">"Type"</span>: <span class="string">"vxlan"</span>&#125;&#125;'</span><br><span class="line"># 得到如下反馈信息</span><br><span class="line">&#123;<span class="string">"Network"</span>:<span class="string">"172.30.0.0/16"</span>, <span class="string">"SubnetLen"</span>: 24, <span class="string">"Backend"</span>: &#123;<span class="string">"Type"</span>: <span class="string">"vxlan"</span>&#125;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>写入的 Pod 网段(${CLUSTER_CIDR}，172.30.0.0/16) 必须与kube-controller-manager 的 –cluster-cidr 选项值一致；</li>
</ul>
<h2 id="安装和配置flanneld"><a href="#安装和配置flanneld" class="headerlink" title="安装和配置flanneld"></a>安装和配置flanneld</h2><p>前往<a href="https://github.com/coreos/flannel/releases" target="_blank" rel="noopener">flanneld release</a>页面下载最新版的flanneld 二进制文件：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>mkdir flannel</span><br><span class="line"><span class="variable">$ </span>wget <span class="symbol">https:</span>/<span class="regexp">/github.com/coreos</span><span class="regexp">/flannel/releases</span><span class="regexp">/download/v</span><span class="number">0</span>.<span class="number">9.0</span>/flannel-v<span class="number">0</span>.<span class="number">9.0</span>-linux-amd64.tar.gz</span><br><span class="line"><span class="variable">$ </span>tar -xzvf flannel-v<span class="number">0</span>.<span class="number">9.0</span>-linux-amd64.tar.gz -C flannel</span><br><span class="line"><span class="variable">$ </span>sudo cp flannel/&#123;flanneld,mk-docker-opts.sh&#125; /usr/k8s/bin</span><br></pre></td></tr></table></figure></p>
<p>创建flanneld的systemd unit 文件<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; flanneld.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Flanneld overlay<span class="built_in"> address </span>etcd agent</span><br><span class="line"><span class="attribute">After</span>=network.target</span><br><span class="line"><span class="attribute">After</span>=network-online.target</span><br><span class="line"><span class="attribute">Wants</span>=network-online.target</span><br><span class="line"><span class="attribute">After</span>=etcd.service</span><br><span class="line"><span class="attribute">Before</span>=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">Type</span>=notify</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/k8s/bin/flanneld \\</span><br><span class="line">  <span class="attribute">-etcd-cafile</span>=/etc/kubernetes/ssl/ca.pem \\</span><br><span class="line">  <span class="attribute">-etcd-certfile</span>=/etc/flanneld/ssl/flanneld.pem \\</span><br><span class="line">  <span class="attribute">-etcd-keyfile</span>=/etc/flanneld/ssl/flanneld-key.pem \\</span><br><span class="line">  <span class="attribute">-etcd-endpoints</span>=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \\</span><br><span class="line">  <span class="attribute">-etcd-prefix</span>=<span class="variable">$&#123;FLANNEL_ETCD_PREFIX&#125;</span></span><br><span class="line"><span class="attribute">ExecStartPost</span>=/usr/k8s/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker</span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line"><span class="attribute">RequiredBy</span>=docker.service</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<ul>
<li>mk-docker-opts.sh脚本将分配给flanneld 的Pod 子网网段信息写入到/run/flannel/docker 文件中，后续docker 启动时使用这个文件中的参数值为 docker0 网桥</li>
<li>flanneld 使用系统缺省路由所在的接口和其他节点通信，对于有多个网络接口的机器(内网和公网)，可以用 –iface 选项值指定通信接口(上面的 systemd unit 文件没指定这个选项)</li>
</ul>
<h2 id="启动flanneld"><a href="#启动flanneld" class="headerlink" title="启动flanneld"></a>启动flanneld</h2><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span> sudo cp flanneld.service /etc/systemd/<span class="keyword">system</span>/</span><br><span class="line"><span class="symbol">$</span> sudo systemctl daemon-reload</span><br><span class="line"><span class="symbol">$</span> sudo systemctl enable flanneld</span><br><span class="line"><span class="symbol">$</span> sudo systemctl start flanneld</span><br><span class="line"><span class="symbol">$</span> systemctl status flanneld</span><br></pre></td></tr></table></figure>
<h2 id="检查flanneld-服务"><a href="#检查flanneld-服务" class="headerlink" title="检查flanneld 服务"></a>检查flanneld 服务</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ifconfig</span> <span class="selector-tag">flannel</span><span class="selector-class">.1</span></span><br></pre></td></tr></table></figure>
<h2 id="检查分配给各flanneld-的Pod-网段信息"><a href="#检查分配给各flanneld-的Pod-网段信息" class="headerlink" title="检查分配给各flanneld 的Pod 网段信息"></a>检查分配给各flanneld 的Pod 网段信息</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ # 查看集群 Pod 网段(/16)</span><br><span class="line">$ etcdctl \</span><br><span class="line">  <span class="attribute">--endpoints</span>=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  <span class="attribute">--ca-file</span>=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  <span class="attribute">--cert-file</span>=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  <span class="attribute">--key-file</span>=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  <span class="builtin-name">get</span> <span class="variable">$&#123;FLANNEL_ETCD_PREFIX&#125;</span>/config</span><br><span class="line">&#123; <span class="string">"Network"</span>: <span class="string">"172.30.0.0/16"</span>, <span class="string">"SubnetLen"</span>: 24, <span class="string">"Backend"</span>: &#123; <span class="string">"Type"</span>: <span class="string">"vxlan"</span> &#125; &#125;</span><br><span class="line">$ # 查看已分配的 Pod 子网段列表(/24)</span><br><span class="line">$ etcdctl \</span><br><span class="line">  <span class="attribute">--endpoints</span>=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  <span class="attribute">--ca-file</span>=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  <span class="attribute">--cert-file</span>=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  <span class="attribute">--key-file</span>=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  ls <span class="variable">$&#123;FLANNEL_ETCD_PREFIX&#125;</span>/subnets</span><br><span class="line">/kubernetes/network/subnets/172.30.77.0-24</span><br><span class="line">$ # 查看某一 Pod 网段对应的 flanneld 进程监听的<span class="built_in"> IP </span>和网络参数</span><br><span class="line">$ etcdctl \</span><br><span class="line">  <span class="attribute">--endpoints</span>=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \</span><br><span class="line">  <span class="attribute">--ca-file</span>=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  <span class="attribute">--cert-file</span>=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  <span class="attribute">--key-file</span>=/etc/flanneld/ssl/flanneld-key.pem \</span><br><span class="line">  <span class="builtin-name">get</span> <span class="variable">$&#123;FLANNEL_ETCD_PREFIX&#125;</span>/subnets/172.30.77.0-24</span><br><span class="line">&#123;<span class="string">"PublicIP"</span>:<span class="string">"192.168.1.137"</span>,<span class="string">"BackendType"</span>:<span class="string">"vxlan"</span>,<span class="string">"BackendData"</span>:&#123;<span class="string">"VtepMAC"</span>:<span class="string">"62:fc:03:83:1b:2b"</span>&#125;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="确保各节点间Pod-网段能互联互通"><a href="#确保各节点间Pod-网段能互联互通" class="headerlink" title="确保各节点间Pod 网段能互联互通"></a>确保各节点间Pod 网段能互联互通</h2><p>在各个节点部署完Flanneld 后，查看已分配的Pod 子网段列表：<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ etcdctl \</span><br><span class="line">  --endpoints=$&#123;ETCD_ENDPOINTS&#125; \</span><br><span class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --cert-file=/etc/flanneld/ssl/flanneld.pem \</span><br><span class="line">  --<span class="type">key</span>-file=/etc/flanneld/ssl/flanneld-<span class="type">key</span>.pem \</span><br><span class="line">  ls $&#123;FLANNEL_ETCD_PREFIX&#125;/subnets</span><br><span class="line"></span><br><span class="line">/kubernetes/network/subnets/<span class="number">172.30</span><span class="number">.19</span><span class="number">.0</span><span class="number">-24</span></span><br><span class="line">/kubernetes/network/subnets/<span class="number">172.30</span><span class="number">.30</span><span class="number">.0</span><span class="number">-24</span></span><br><span class="line">/kubernetes/network/subnets/<span class="number">172.30</span><span class="number">.77</span><span class="number">.0</span><span class="number">-24</span></span><br><span class="line">/kubernetes/network/subnets/<span class="number">172.30</span><span class="number">.41</span><span class="number">.0</span><span class="number">-24</span></span><br><span class="line">/kubernetes/network/subnets/<span class="number">172.30</span><span class="number">.83</span><span class="number">.0</span><span class="number">-24</span></span><br></pre></td></tr></table></figure></p>
<p>当前五个节点分配的 Pod 网段分别是：172.30.77.0-24、172.30.30.0-24、172.30.19.0-24、172.30.41.0-24、172.30.83.0-24。</p>
<h1 id="6-部署master-节点"><a href="#6-部署master-节点" class="headerlink" title="6. 部署master 节点"></a>6. 部署master 节点</h1><p>kubernetes master 节点包含的组件有：</p>
<ul>
<li>kube-apiserver</li>
<li>kube-scheduler</li>
<li>kube-controller-manager</li>
</ul>
<p>目前这3个组件需要部署到同一台机器上：（后面再部署高可用的master）</p>
<ul>
<li>kube-scheduler、kube-controller-manager 和 kube-apiserver 三者的功能紧密相关；</li>
<li>同时只能有一个 kube-scheduler、kube-controller-manager 进程处于工作状态，如果运行多个，则需要通过选举产生一个 leader；</li>
</ul>
<p>master 节点与node 节点上的Pods 通过Pod 网络通信，所以需要在master 节点上部署Flannel 网络。</p>
<h2 id="环境变量-2"><a href="#环境变量-2" class="headerlink" title="环境变量"></a>环境变量</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> NODE_IP=192.168.1.137  <span class="comment"># 当前部署的master 机器IP</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">source</span> /usr/k8s/bin/env.sh</span></span><br></pre></td></tr></table></figure>
<h2 id="下载最新版本的二进制文件"><a href="#下载最新版本的二进制文件" class="headerlink" title="下载最新版本的二进制文件"></a>下载最新版本的二进制文件</h2><p>在<a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG-1.8.md#server-binaries" target="_blank" rel="noopener">kubernetes changelog</a> 页面下载最新版本的文件：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ wget https:<span class="comment">//dl.k8s.io/v1.8.2/kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line">$ tar -xzvf kubernetes-server-linux-amd64<span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure></p>
<p>将二进制文件拷贝到/usr/k8s/bin目录<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo cp -r server<span class="regexp">/bin/</span>&#123;kube-apiserver,kube-controller-manager,kube-scheduler&#125; <span class="regexp">/usr/</span>k8s<span class="regexp">/bin/</span></span><br></pre></td></tr></table></figure></p>
<h2 id="创建kubernetes-证书"><a href="#创建kubernetes-证书" class="headerlink" title="创建kubernetes 证书"></a>创建kubernetes 证书</h2><p>创建kubernetes 证书签名请求：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; kubernetes-csr.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"CN"</span>: <span class="string">"kubernetes"</span>,</span><br><span class="line">  <span class="string">"hosts"</span>: [</span><br><span class="line">    <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"<span class="variable">$&#123;NODE_IP&#125;</span>"</span>,</span><br><span class="line">    <span class="string">"<span class="variable">$&#123;MASTER_URL&#125;</span>"</span>,</span><br><span class="line">    <span class="string">"<span class="variable">$&#123;CLUSTER_KUBERNETES_SVC_IP&#125;</span>"</span>,</span><br><span class="line">    <span class="string">"kubernetes"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster"</span>,</span><br><span class="line">    <span class="string">"kubernetes.default.svc.cluster.local"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">"key"</span>: &#123;</span><br><span class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</span><br><span class="line">    <span class="string">"size"</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"names"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</span><br><span class="line">      <span class="string">"ST"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"L"</span>: <span class="string">"BeiJing"</span>,</span><br><span class="line">      <span class="string">"O"</span>: <span class="string">"k8s"</span>,</span><br><span class="line">      <span class="string">"OU"</span>: <span class="string">"System"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<ul>
<li>如果 hosts 字段不为空则需要指定授权使用该证书的 IP 或域名列表，所以上面分别指定了当前部署的 master 节点主机 IP 以及apiserver 负载的内部域名</li>
<li>还需要添加 kube-apiserver 注册的名为 kubernetes 的服务 IP (Service Cluster IP)，一般是 kube-apiserver –service-cluster-ip-range 选项值指定的网段的第一个IP，如 “10.254.0.1”</li>
</ul>
<p>生成kubernetes 证书和私钥：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cfssl gencert -ca=<span class="regexp">/etc/</span>kubernetes<span class="regexp">/ssl/</span>ca.pem \</span><br><span class="line">  -ca-key=<span class="regexp">/etc/</span>kubernetes<span class="regexp">/ssl/</span>ca-key.pem \</span><br><span class="line">  -config=<span class="regexp">/etc/</span>kubernetes<span class="regexp">/ssl/</span>ca-config.json \</span><br><span class="line">  -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span><br><span class="line">$ ls kubernetes*</span><br><span class="line">kubernetes.csr  kubernetes-csr.json  kubernetes-key.pem  kubernetes.pem</span><br><span class="line">$ sudo mkdir -p <span class="regexp">/etc/</span>kubernetes<span class="regexp">/ssl/</span></span><br><span class="line">$ sudo mv kubernetes*.pem <span class="regexp">/etc/</span>kubernetes<span class="regexp">/ssl/</span></span><br></pre></td></tr></table></figure></p>
<h2 id="6-1-配置和启动kube-apiserver"><a href="#6-1-配置和启动kube-apiserver" class="headerlink" title="6.1 配置和启动kube-apiserver"></a>6.1 配置和启动kube-apiserver</h2><p><strong>创建kube-apiserver 使用的客户端token 文件</strong><br>kubelet 首次启动时向kube-apiserver 发送TLS Bootstrapping 请求，kube-apiserver 验证请求中的token 是否与它配置的token.csv 一致，如果一致则自动为kubelet 生成证书和密钥。<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ # 导入的 environment.<span class="keyword">sh</span> 文件定义了 BOOTSTRAP_TOKEN 变量</span><br><span class="line">$ <span class="keyword">cat</span> &gt; <span class="keyword">token</span>.csv &lt;&lt;EOF</span><br><span class="line"><span class="variable">$&#123;BOOTSTRAP_TOKEN&#125;</span>,kubelet-<span class="keyword">bootstrap</span>,10001,<span class="string">"system:kubelet-bootstrap"</span></span><br><span class="line">EOF</span><br><span class="line">$ sudo mv <span class="keyword">token</span>.csv /etc/kubernetes/</span><br></pre></td></tr></table></figure></p>
<p><strong>创建kube-apiserver 的systemd unit文件</strong><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ cat  &gt; kube-apiserver.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Kubernetes API Server</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"><span class="attribute">After</span>=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/k8s/bin/kube-apiserver \\</span><br><span class="line">  <span class="attribute">--admission-control</span>=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \\</span><br><span class="line">  <span class="attribute">--advertise-address</span>=<span class="variable">$&#123;NODE_IP&#125;</span> \\</span><br><span class="line">  <span class="attribute">--bind-address</span>=0.0.0.0 \\</span><br><span class="line">  <span class="attribute">--insecure-bind-address</span>=<span class="variable">$&#123;NODE_IP&#125;</span> \\</span><br><span class="line">  <span class="attribute">--authorization-mode</span>=Node,RBAC \\</span><br><span class="line">  <span class="attribute">--runtime-config</span>=rbac.authorization.k8s.io/v1alpha1 \\</span><br><span class="line">  <span class="attribute">--kubelet-https</span>=<span class="literal">true</span> \\</span><br><span class="line">  --experimental-bootstrap-token-auth \\</span><br><span class="line">  <span class="attribute">--token-auth-file</span>=/etc/kubernetes/token.csv \\</span><br><span class="line">  <span class="attribute">--service-cluster-ip-range</span>=<span class="variable">$&#123;SERVICE_CIDR&#125;</span> \\</span><br><span class="line">  <span class="attribute">--service-node-port-range</span>=<span class="variable">$&#123;NODE_PORT_RANGE&#125;</span> \\</span><br><span class="line">  <span class="attribute">--tls-cert-file</span>=/etc/kubernetes/ssl/kubernetes.pem \\</span><br><span class="line">  <span class="attribute">--tls-private-key-file</span>=/etc/kubernetes/ssl/kubernetes-key.pem \\</span><br><span class="line">  <span class="attribute">--client-ca-file</span>=/etc/kubernetes/ssl/ca.pem \\</span><br><span class="line">  <span class="attribute">--service-account-key-file</span>=/etc/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">  <span class="attribute">--etcd-cafile</span>=/etc/kubernetes/ssl/ca.pem \\</span><br><span class="line">  <span class="attribute">--etcd-certfile</span>=/etc/kubernetes/ssl/kubernetes.pem \\</span><br><span class="line">  <span class="attribute">--etcd-keyfile</span>=/etc/kubernetes/ssl/kubernetes-key.pem \\</span><br><span class="line">  <span class="attribute">--etcd-servers</span>=<span class="variable">$&#123;ETCD_ENDPOINTS&#125;</span> \\</span><br><span class="line">  <span class="attribute">--enable-swagger-ui</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--allow-privileged</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--apiserver-count</span>=2 \\</span><br><span class="line">  <span class="attribute">--audit-log-maxage</span>=30 \\</span><br><span class="line">  <span class="attribute">--audit-log-maxbackup</span>=3 \\</span><br><span class="line">  <span class="attribute">--audit-log-maxsize</span>=100 \\</span><br><span class="line">  <span class="attribute">--audit-log-path</span>=/var/lib/audit.log \\</span><br><span class="line">  <span class="attribute">--audit-policy-file</span>=/etc/kubernetes/audit-policy.yaml \\</span><br><span class="line">  <span class="attribute">--event-ttl</span>=1h \\</span><br><span class="line">  <span class="attribute">--logtostderr</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--v</span>=6</span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"><span class="attribute">Type</span>=notify</span><br><span class="line"><span class="attribute">LimitNOFILE</span>=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<ul>
<li>如果你安装的是1.9.x版本的，一定要记住上面的参数experimental-bootstrap-token-auth，需要替换成enable-bootstrap-token-auth，因为这个参数在1.9.x里面已经废弃掉了</li>
<li>kube-apiserver 1.6 版本开始使用 etcd v3 API 和存储格式</li>
<li>–authorization-mode=RBAC 指定在安全端口使用RBAC 授权模式，拒绝未通过授权的请求</li>
<li>kube-scheduler、kube-controller-manager 一般和 kube-apiserver 部署在同一台机器上，它们使用非安全端口和 kube-apiserver通信</li>
<li>kubelet、kube-proxy、kubectl 部署在其它 Node 节点上，如果通过安全端口访问 kube-apiserver，则必须先通过 TLS 证书认证，再通过 RBAC 授权</li>
<li>kube-proxy、kubectl 通过使用证书里指定相关的 User、Group 来达到通过 RBAC 授权的目的</li>
<li>如果使用了 kubelet TLS Boostrap 机制，则不能再指定 –kubelet-certificate-authority、–kubelet-client-certificate 和 –kubelet-client-key 选项，否则后续 kube-apiserver 校验 kubelet 证书时出现 ”x509: certificate signed by unknown authority“ 错误</li>
<li>–admission-control 值必须包含 ServiceAccount，否则部署集群插件时会失败</li>
<li>–bind-address 不能为 127.0.0.1</li>
<li>–service-cluster-ip-range 指定 Service Cluster IP 地址段，该地址段不能路由可达</li>
<li>–service-node-port-range=${NODE_PORT_RANGE} 指定 NodePort 的端口范围</li>
<li>缺省情况下 kubernetes 对象保存在etcd/registry 路径下，可以通过 –etcd-prefix 参数进行调整</li>
<li>kube-apiserver 1.8版本后需要在–authorization-mode参数中添加Node，即：–authorization-mode=Node,RBAC，否则Node 节点无法注册</li>
<li>注意要开启审查日志功能，指定–audit-log-path参数是不够的，这只是指定了日志的路径，还需要指定一个审查日志策略文件：–audit-policy-file，我们也可以使用日志收集工具收集相关的日志进行分析。</li>
</ul>
<p>审查日志策略文件内容如下：（/etc/kubernetes/audit-policy.yaml）<br><figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: audit.k8s.io/v1beta1 # This <span class="keyword">is</span> required.</span><br><span class="line">kind: Policy</span><br><span class="line"># Don<span class="symbol">'t</span> <span class="keyword">generate</span> audit events <span class="keyword">for</span> <span class="keyword">all</span> requests <span class="keyword">in</span> RequestReceived stage.</span><br><span class="line">omitStages:</span><br><span class="line">  - <span class="string">"RequestReceived"</span></span><br><span class="line">rules:</span><br><span class="line">  # Log pod changes at RequestResponse level</span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    resources:</span><br><span class="line">    - <span class="keyword">group</span>: <span class="string">""</span></span><br><span class="line">      # Resource <span class="string">"pods"</span> doesn<span class="symbol">'t</span> match requests <span class="keyword">to</span> any subresource <span class="keyword">of</span> pods,</span><br><span class="line">      # which <span class="keyword">is</span> consistent <span class="keyword">with</span> the RBAC policy.</span><br><span class="line">      resources: [<span class="string">"pods"</span>]</span><br><span class="line">  # Log <span class="string">"pods/log"</span>, <span class="string">"pods/status"</span> at Metadata level</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - <span class="keyword">group</span>: <span class="string">""</span></span><br><span class="line">      resources: [<span class="string">"pods/log"</span>, <span class="string">"pods/status"</span>]</span><br><span class="line"></span><br><span class="line">  # Don<span class="symbol">'t</span> log requests <span class="keyword">to</span> a configmap called <span class="string">"controller-leader"</span></span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">    - <span class="keyword">group</span>: <span class="string">""</span></span><br><span class="line">      resources: [<span class="string">"configmaps"</span>]</span><br><span class="line">      resourceNames: [<span class="string">"controller-leader"</span>]</span><br><span class="line"></span><br><span class="line">  # Don<span class="symbol">'t</span> log watch requests by the <span class="string">"system:kube-proxy"</span> <span class="keyword">on</span> endpoints <span class="keyword">or</span> services</span><br><span class="line">  - level: None</span><br><span class="line">    users: [<span class="string">"system:kube-proxy"</span>]</span><br><span class="line">    verbs: [<span class="string">"watch"</span>]</span><br><span class="line">    resources:</span><br><span class="line">    - <span class="keyword">group</span>: <span class="string">""</span> # core API <span class="keyword">group</span></span><br><span class="line">      resources: [<span class="string">"endpoints"</span>, <span class="string">"services"</span>]</span><br><span class="line"></span><br><span class="line">  # Don<span class="symbol">'t</span> log authenticated requests <span class="keyword">to</span> certain non-resource URL paths.</span><br><span class="line">  - level: None</span><br><span class="line">    userGroups: [<span class="string">"system:authenticated"</span>]</span><br><span class="line">    nonResourceURLs:</span><br><span class="line">    - <span class="string">"/api*"</span> # Wildcard matching.</span><br><span class="line">    - <span class="string">"/version"</span></span><br><span class="line"></span><br><span class="line">  # Log the request <span class="keyword">body</span> <span class="keyword">of</span> configmap changes <span class="keyword">in</span> kube-system.</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - <span class="keyword">group</span>: <span class="string">""</span> # core API <span class="keyword">group</span></span><br><span class="line">      resources: [<span class="string">"configmaps"</span>]</span><br><span class="line">    # This rule only applies <span class="keyword">to</span> resources <span class="keyword">in</span> the <span class="string">"kube-system"</span> namespace.</span><br><span class="line">    # The empty <span class="built_in">string</span> <span class="string">""</span> can be used <span class="keyword">to</span> <span class="keyword">select</span> non-namespaced resources.</span><br><span class="line">    namespaces: [<span class="string">"kube-system"</span>]</span><br><span class="line"></span><br><span class="line">  # Log configmap <span class="keyword">and</span> secret changes <span class="keyword">in</span> <span class="keyword">all</span> other namespaces at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - <span class="keyword">group</span>: <span class="string">""</span> # core API <span class="keyword">group</span></span><br><span class="line">      resources: [<span class="string">"secrets"</span>, <span class="string">"configmaps"</span>]</span><br><span class="line"></span><br><span class="line">  # Log <span class="keyword">all</span> other resources <span class="keyword">in</span> core <span class="keyword">and</span> extensions at the Request level.</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - <span class="keyword">group</span>: <span class="string">""</span> # core API <span class="keyword">group</span></span><br><span class="line">    - <span class="keyword">group</span>: <span class="string">"extensions"</span> # Version <span class="keyword">of</span> <span class="keyword">group</span> should <span class="keyword">NOT</span> be included.</span><br><span class="line"></span><br><span class="line">  # A catch-<span class="keyword">all</span> rule <span class="keyword">to</span> log <span class="keyword">all</span> other requests at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    # Long-running requests like watches that fall under this rule will <span class="keyword">not</span></span><br><span class="line">    # <span class="keyword">generate</span> an audit event <span class="keyword">in</span> RequestReceived.</span><br><span class="line">    omitStages:</span><br><span class="line">      - <span class="string">"RequestReceived"</span></span><br></pre></td></tr></table></figure></p>
<p>审查日志的相关配置可以查看文档了解：<a href="https://kubernetes.io/docs/tasks/debug-application-cluster/audit/" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/debug-application-cluster/audit/</a></p>
<p><strong>启动kube-apiserver</strong><br><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span> sudo cp kube-apiserver.service /etc/systemd/<span class="keyword">system</span>/</span><br><span class="line"><span class="symbol">$</span> sudo systemctl daemon-reload</span><br><span class="line"><span class="symbol">$</span> sudo systemctl enable kube-apiserver</span><br><span class="line"><span class="symbol">$</span> sudo systemctl start kube-apiserver</span><br><span class="line"><span class="symbol">$</span> sudo systemctl status kube-apiserver</span><br></pre></td></tr></table></figure></p>
<h2 id="6-2-配置和启动kube-controller-manager"><a href="#6-2-配置和启动kube-controller-manager" class="headerlink" title="6.2 配置和启动kube-controller-manager"></a>6.2 配置和启动kube-controller-manager</h2><p><strong>创建kube-controller-manager 的systemd unit 文件</strong><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; kube-controller-manager.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Kubernetes Controller Manager</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/k8s/bin/kube-controller-manager \\</span><br><span class="line">  <span class="attribute">--address</span>=127.0.0.1 \\</span><br><span class="line">  <span class="attribute">--master</span>=http://$&#123;MASTER_URL&#125;:8080 \\</span><br><span class="line">  <span class="attribute">--allocate-node-cidrs</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--service-cluster-ip-range</span>=<span class="variable">$&#123;SERVICE_CIDR&#125;</span> \\</span><br><span class="line">  <span class="attribute">--cluster-cidr</span>=<span class="variable">$&#123;CLUSTER_CIDR&#125;</span> \\</span><br><span class="line">  <span class="attribute">--cluster-name</span>=kubernetes \\</span><br><span class="line">  <span class="attribute">--cluster-signing-cert-file</span>=/etc/kubernetes/ssl/ca.pem \\</span><br><span class="line">  <span class="attribute">--cluster-signing-key-file</span>=/etc/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">  <span class="attribute">--service-account-private-key-file</span>=/etc/kubernetes/ssl/ca-key.pem \\</span><br><span class="line">  <span class="attribute">--root-ca-file</span>=/etc/kubernetes/ssl/ca.pem \\</span><br><span class="line">  <span class="attribute">--leader-elect</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--v</span>=2</span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p>–address 值必须为 127.0.0.1，因为当前 kube-apiserver 期望 scheduler 和 controller-manager 在同一台机器</p>
</li>
<li><p>–master=http://${MASTER_URL}:8080：使用http(非安全端口)与 kube-apiserver 通信，需要下面的haproxy安装成功后才能去掉8080端口。</p>
</li>
<li><p>–cluster-cidr 指定 Cluster 中 Pod 的 CIDR 范围，该网段在各 Node 间必须路由可达(flanneld保证)</p>
</li>
<li><p>–service-cluster-ip-range 参数指定 Cluster 中 Service 的CIDR范围，该网络在各 Node 间必须路由不可达，必须和 kube-apiserver 中的参数一致</p>
</li>
<li><p>–cluster-signing-* 指定的证书和私钥文件用来签名为 TLS BootStrap 创建的证书和私钥</p>
</li>
<li><p>–root-ca-file 用来对 kube-apiserver 证书进行校验，指定该参数后，才会在Pod 容器的 ServiceAccount 中放置该 CA 证书文件</p>
</li>
<li><p>–leader-elect=true 部署多台机器组成的 master 集群时选举产生一处于工作状态的 kube-controller-manager 进程</p>
</li>
</ul>
<p><strong>启动kube-controller-manager</strong><br><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span> sudo cp kube-controller-manager.service /etc/systemd/<span class="keyword">system</span>/</span><br><span class="line"><span class="symbol">$</span> sudo systemctl daemon-reload</span><br><span class="line"><span class="symbol">$</span> sudo systemctl enable kube-controller-manager</span><br><span class="line"><span class="symbol">$</span> sudo systemctl start kube-controller-manager</span><br><span class="line"><span class="symbol">$</span> sudo systemctl status kube-controller-manager</span><br></pre></td></tr></table></figure></p>
<h2 id="6-3-配置和启动kube-scheduler"><a href="#6-3-配置和启动kube-scheduler" class="headerlink" title="6.3 配置和启动kube-scheduler"></a>6.3 配置和启动kube-scheduler</h2><p><strong>创建kube-scheduler 的systemd unit文件</strong><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt; kube-scheduler.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Kubernetes Scheduler</span><br><span class="line"><span class="attribute">Documentation</span>=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/k8s/bin/kube-scheduler \\</span><br><span class="line">  <span class="attribute">--address</span>=127.0.0.1 \\</span><br><span class="line">  <span class="attribute">--master</span>=http://$&#123;MASTER_URL&#125;:8080 \\</span><br><span class="line">  <span class="attribute">--leader-elect</span>=<span class="literal">true</span> \\</span><br><span class="line">  <span class="attribute">--v</span>=2</span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">RestartSec</span>=5</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure></p>
<ul>
<li>–address 值必须为 127.0.0.1，因为当前 kube-apiserver 期望 scheduler 和 controller-manager 在同一台机器</li>
<li>–master=http://${MASTER_URL}:8080：使用http(非安全端口)与 kube-apiserver 通信，需要下面的haproxy启动成功后才能去掉8080端口</li>
<li>–leader-elect=true 部署多台机器组成的 master 集群时选举产生一处于工作状态的 kube-controller-manager 进程</li>
</ul>
<p><strong>启动kube-scheduler</strong><br><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span> sudo cp kube-scheduler.service /etc/systemd/<span class="keyword">system</span>/</span><br><span class="line"><span class="symbol">$</span> sudo systemctl daemon-reload</span><br><span class="line"><span class="symbol">$</span> sudo systemctl enable kube-scheduler</span><br><span class="line"><span class="symbol">$</span> sudo systemctl start kube-scheduler</span><br><span class="line"><span class="symbol">$</span> sudo systemctl status kube-scheduler</span><br></pre></td></tr></table></figure></p>
<h2 id="6-4-验证master-节点"><a href="#6-4-验证master-节点" class="headerlink" title="6.4 验证master 节点"></a>6.4 验证master 节点</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="builtin-name">get</span> componentstatuses</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">scheduler            Healthy   ok</span><br><span class="line">controller-manager   Healthy   ok</span><br><span class="line">etcd-1               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;</span><br><span class="line">etcd-2               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;</span><br><span class="line">etcd-0               Healthy   &#123;<span class="string">"health"</span>: <span class="string">"true"</span>&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>接下文：<a href="100007.html">手动搭建高可用的kubernetes集群(三)</a></p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2018/07/100007.html" class="pre-post btn btn-default" title='二进制搭建高可用的kubernetes集群(三)'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">二进制搭建高可用的kubernetes集群(三)</span>
        </a>
    
    
        <a href="/archives/2018/07/100005.html" class="next-post btn btn-default" title='二进制搭建高可用的kubernetes集群(一)'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">二进制搭建高可用的kubernetes集群(一)</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#4-配置kubectl-命令行工具"><span class="toc-text">4. 配置kubectl 命令行工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#环境变量"><span class="toc-text">环境变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#下载kubectl"><span class="toc-text">下载kubectl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建admin-证书"><span class="toc-text">创建admin 证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建kubectl-kubeconfig-文件"><span class="toc-text">创建kubectl kubeconfig 文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#分发kubeconfig-文件"><span class="toc-text">分发kubeconfig 文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-部署Flannel-网络"><span class="toc-text">5. 部署Flannel 网络</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#环境变量-1"><span class="toc-text">环境变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建TLS-密钥和证书"><span class="toc-text">创建TLS 密钥和证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#向etcd-写入集群Pod-网段信息"><span class="toc-text">向etcd 写入集群Pod 网段信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装和配置flanneld"><span class="toc-text">安装和配置flanneld</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#启动flanneld"><span class="toc-text">启动flanneld</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#检查flanneld-服务"><span class="toc-text">检查flanneld 服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#检查分配给各flanneld-的Pod-网段信息"><span class="toc-text">检查分配给各flanneld 的Pod 网段信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#确保各节点间Pod-网段能互联互通"><span class="toc-text">确保各节点间Pod 网段能互联互通</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-部署master-节点"><span class="toc-text">6. 部署master 节点</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#环境变量-2"><span class="toc-text">环境变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#下载最新版本的二进制文件"><span class="toc-text">下载最新版本的二进制文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建kubernetes-证书"><span class="toc-text">创建kubernetes 证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-配置和启动kube-apiserver"><span class="toc-text">6.1 配置和启动kube-apiserver</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-配置和启动kube-controller-manager"><span class="toc-text">6.2 配置和启动kube-controller-manager</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-配置和启动kube-scheduler"><span class="toc-text">6.3 配置和启动kube-scheduler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-验证master-节点"><span class="toc-text">6.4 验证master 节点</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2023&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>