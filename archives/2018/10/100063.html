<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="kubernetes,helm" />


    <meta name="description" content="接上文: kubernetes包管理工具Helm之 一.Helm安装

内置函数和Values定义一个chart包，了解 Helm 中模板的一些使用方法。
定义 chartHelm 的 gith..." />



<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />

    <!--Title-->


<title>kubernetes包管理工具Helm之 二.Helm模板使用 | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    




<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7.css">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash.css">





    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx" />


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

<meta name="generator" content="Hexo 7.3.0"></head>


<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="kubernetes包管理工具Helm之 二.Helm模板使用">
            
	            kubernetes包管理工具Helm之 二.Helm模板使用
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/cloud/">云计算</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-none-link" href="/tags/helm/" rel="tag">helm</a> <a class="tag-none-link" href="/tags/kubernetes/" rel="tag">kubernetes</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2018/10/22</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>2338</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <p>接上文: <a href="100056.html">kubernetes包管理工具Helm之 一.Helm安装</a></p>
<hr>
<h1 id="内置函数和Values"><a href="#内置函数和Values" class="headerlink" title="内置函数和Values"></a>内置函数和Values</h1><p>定义一个<code>chart</code>包，了解 Helm 中模板的一些使用方法。</p>
<h2 id="定义-chart"><a href="#定义-chart" class="headerlink" title="定义 chart"></a>定义 chart</h2><p>Helm 的 github 上面有一个比较<a href="https://github.com/kubernetes/helm/blob/master/docs/charts.md">完整的文档</a>，建议大家好好阅读下该文档，这里我们来一起创建一个<code>chart</code>包。</p>
<p>一个 chart 包就是一个文件夹的集合，文件夹名称就是 chart 包的名称，比如创建一个 mychart 的 chart 包：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ helm create mychart</span><br><span class="line">Creating mychart</span><br><span class="line">$ tree mychart/</span><br><span class="line">mychart/</span><br><span class="line">├── charts</span><br><span class="line">├── Chart<span class="selector-class">.yaml</span></span><br><span class="line">├── templates</span><br><span class="line">│   ├── deployment<span class="selector-class">.yaml</span></span><br><span class="line">│   ├── _helpers<span class="selector-class">.tpl</span></span><br><span class="line">│   ├── ingress<span class="selector-class">.yaml</span></span><br><span class="line">│   ├── NOTES<span class="selector-class">.txt</span></span><br><span class="line">│   └── service<span class="selector-class">.yaml</span></span><br><span class="line">└── values<span class="selector-class">.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span> directories, <span class="number">7</span> files</span><br></pre></td></tr></table></figure>

<p>chart 包的目录上节课我们就已经学习过了，这里我们再来仔细看看 templates 目录下面的文件:</p>
<ul>
<li>NOTES.txt：chart 的 “帮助文本”。这会在用户运行 helm install 时显示给用户。</li>
<li>deployment.yaml：创建 Kubernetes deployment 的基本 manifest</li>
<li>service.yaml：为 deployment 创建 service 的基本 manifest</li>
<li>ingress.yaml: 创建 ingress 对象的资源清单文件</li>
<li>_helpers.tpl：放置模板助手的地方，可以在整个 chart 中重复使用</li>
</ul>
<p>这里我们明白每一个文件是干嘛的就行，然后我们把 templates 目录下面所有文件全部删除掉，这里我们自己来创建模板文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">rm</span> -rf mychart/templates/*.*</span></span><br></pre></td></tr></table></figure>

<h2 id="创建模板"><a href="#创建模板" class="headerlink" title="创建模板"></a>创建模板</h2><p>这里我们来创建一个非常简单的模板 ConfigMap，在 templates 目录下面新建一个<code>configmap.yaml</code>文件：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> ConfigMap</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> mychart-configmap</span><br><span class="line"><span class="symbol">data:</span></span><br><span class="line"><span class="symbol">  myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br></pre></td></tr></table></figure>

<p>实际上现在我们就有一个可安装的 chart 包了，通过<code>helm install</code>命令来进行安装：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ helm install .<span class="operator">/</span>mychart<span class="symbol">/</span></span><br><span class="line"><span class="params">NAME:</span>   ringed-lynx</span><br><span class="line">LAST <span class="params">DEPLOYED:</span> Fri Sep  <span class="number">7</span> <span class="number">22</span>:<span class="number">59</span>:<span class="number">22</span> <span class="number">2018</span></span><br><span class="line"><span class="params">NAMESPACE:</span> default</span><br><span class="line"><span class="params">STATUS:</span> DEPLOYED</span><br><span class="line"></span><br><span class="line"><span class="params">RESOURCES:</span></span><br><span class="line"><span class="operator">==</span><span class="operator">&gt;</span> v1<span class="symbol">/ConfigMap</span></span><br><span class="line">NAME               DATA  AGE</span><br><span class="line">mychart-configmap  <span class="number">1</span>     <span class="number">0</span>s</span><br></pre></td></tr></table></figure>

<p>在上面的输出中，我们可以看到我们的 ConfigMap 资源对象已经创建了。然后使用如下命令我们可以看到实际的模板被渲染过后的资源文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">get</span> <span class="string">manifest</span> <span class="string">ringed-lynx</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mychart-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br></pre></td></tr></table></figure>

<p>现在我们看到上面的 ConfigMap 文件是不是正是我们前面在模板文件中设计的，现在我们删除当前的<code>release</code>:</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm <span class="keyword">delete</span> ringed-lynx</span><br><span class="line">release <span class="string">&quot;ringed-lynx&quot;</span> deleted</span><br></pre></td></tr></table></figure>

<h2 id="添加一个简单的模板"><a href="#添加一个简单的模板" class="headerlink" title="添加一个简单的模板"></a>添加一个简单的模板</h2><p>我们可以看到上面我们定义的 ConfigMap 的名字是固定的，但往往这并不是一种很好的做法，我们可以通过插入 release 的名称来生成资源的名称，比如这里 ConfigMap 的名称我们希望是：ringed-lynx-configmap，这就需要用到 Chart 的模板定义方法了。</p>
<p>Helm Chart 模板使用的是<a href="https://golang.org/pkg/text/template/"><code>Go</code>语言模板</a>编写而成，并添加了<a href="https://github.com/Masterminds/sprig"><code>Sprig</code>库</a>中的50多个附件模板函数以及一些其他<a href="https://github.com/kubernetes/helm/blob/master/docs/charts_tips_and_tricks.md">特殊的函</a>。</p>
<blockquote>
<p>需要注意的是<code>kubernetes</code>资源对象的 labels 和 name 定义被<a href="http://kubernetes.io/docs/user-guide/labels/#syntax-and-character-set">限制 63个字符</a>，所以需要注意名称的定义。</p>
</blockquote>
<p>现在我们来重新定义下上面的 configmap.yaml 文件：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> ConfigMap</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> &#123;&#123; &#x27;&#123;&#123;&#x27; &#125;&#125;.Release.Name &#125;&#125;-configmap</span><br><span class="line"><span class="params">data:</span></span><br><span class="line">  <span class="params">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br></pre></td></tr></table></figure>

<p>我们将名称替换成了<code>&#123;&#123; '&#123;&#123;' &#125;&#125;.Release.Name &#125;&#125;-configmap</code>，其中包含在<code>&#123;&#123; '&#123;&#123;' &#125;&#125;</code>和<code>&#125;&#125;</code>之中的就是模板指令，<code>&#123;&#123; '&#123;&#123;' &#125;&#125;.Release.Name &#125;&#125;</code> 将 release 的名称注入到模板中来，这样最终生成的 ConfigMap 名称就是以 release 的名称开头的了。这里的 Release 模板对象属于 Helm 内置的一种对象，还有其他很多内置的对象，稍后我们将接触到。</p>
<p>现在我们来重新安装我们的 Chart 包，注意观察 ConfigMap 资源对象的名称：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ helm install <span class="symbol">./mychart</span></span><br><span class="line">helm install .<span class="operator">/</span>mychart<span class="symbol">/</span></span><br><span class="line"><span class="params">NAME:</span>   quoting-zebra</span><br><span class="line">LAST <span class="params">DEPLOYED:</span> Fri Sep  <span class="number">7</span> <span class="number">23</span>:<span class="number">20</span>:<span class="number">12</span> <span class="number">2018</span></span><br><span class="line"><span class="params">NAMESPACE:</span> default</span><br><span class="line"><span class="params">STATUS:</span> DEPLOYED</span><br><span class="line"></span><br><span class="line"><span class="params">RESOURCES:</span></span><br><span class="line"><span class="operator">==</span><span class="operator">&gt;</span> v1<span class="symbol">/ConfigMap</span></span><br><span class="line">NAME                     DATA  AGE</span><br><span class="line">quoting-zebra-configmap  <span class="number">1</span>     <span class="number">0</span>s</span><br></pre></td></tr></table></figure>

<p>可以看到现在生成的名称变成了<strong>quoting-zebra-configmap</strong>，证明已经生效了，当然我们也可以使用命令<code>helm get manifest quoting-zebra</code>查看最终生成的清单文件的样子。</p>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><p>我们用模板来生成资源文件的清单，但是如果我们想要调试就非常不方便了，不可能我们每次都去部署一个<code>release</code>实例来校验模板是否正确，所幸的时 Helm 为我们提供了<code>--dry-run --debug</code>这个可选参数，在执行<code>helm install</code>的时候带上这两个参数就可以把对应的 values 值和生成的最终的资源清单文件打印出来，而不会真正的去部署一个<code>release</code>实例，比如我们来调试上面创建的 chart 包：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">.</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">./mychart</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;35286&#x27;</span></span><br><span class="line"></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">SERVER:</span> <span class="string">&quot;127.0.0.1:35286&quot;</span></span><br><span class="line"></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Original chart version:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">CHART PATH:</span> <span class="string">/root/course/kubeadm/helm/mychart</span></span><br><span class="line"></span><br><span class="line"><span class="attr">NAME:</span>   <span class="string">wrapping-bunny</span></span><br><span class="line"><span class="attr">REVISION:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">RELEASED:</span> <span class="string">Fri</span> <span class="string">Sep</span>  <span class="number">7</span> <span class="number">23</span><span class="string">:23:09</span> <span class="number">2018</span></span><br><span class="line"><span class="attr">CHART:</span> <span class="string">mychart-0.1.0</span></span><br><span class="line"><span class="attr">USER-SUPPLIED VALUES:</span></span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">COMPUTED VALUES:</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">HOOKS:</span></span><br><span class="line"><span class="attr">MANIFEST:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">wrapping-bunny-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br></pre></td></tr></table></figure>

<p>现在我们使用<code>--dry-run</code>就可以很容易地测试代码了，不需要每次都去安装一个 release 实例了，但是要注意的是这不能确保 Kubernetes 本身就一定会接受生成的模板，在调试完成后，还是需要去安装一个实际的 release 实例来进行验证的。</p>
<h2 id="内置对象"><a href="#内置对象" class="headerlink" title="内置对象"></a>内置对象</h2><p>刚刚我们使用<code>&#123;&#123; '&#123;&#123;' &#125;&#125;.Release.Name&#125;&#125;</code>将 release 的名称插入到模板中。这里的 Release 就是 Helm 的内置对象，下面是一些常用的内置对象，在需要的时候直接使用就可以：</p>
<ul>
<li><strong>Release</strong>：这个对象描述了 release 本身。它里面有几个对象：<ul>
<li>Release.Name：release 名称</li>
<li>Release.Time：release 的时间</li>
<li>Release.Namespace：release 的 namespace（如果清单未覆盖）</li>
<li>Release.Service：release 服务的名称（始终是 Tiller）。</li>
<li>Release.Revision：此 release 的修订版本号，从1开始累加。</li>
<li>Release.IsUpgrade：如果当前操作是升级或回滚，则将其设置为 true。</li>
<li>Release.IsInstall：如果当前操作是安装，则设置为 true。</li>
</ul>
</li>
<li><strong>Values</strong>：从<code>values.yaml</code>文件和用户提供的文件传入模板的值。默认情况下，Values 是空的。</li>
<li>Chart：<code>Chart.yaml</code>文件的内容。所有的 Chart 对象都将从该文件中获取。chart 指南中<a href="https://github.com/kubernetes/helm/blob/master/docs/charts.md#the-chartyaml-file">Charts Guide</a>列出了可用字段，可以前往查看。</li>
<li>Files：这提供对 chart 中所有非特殊文件的访问。虽然无法使用它来访问模板，但可以使用它来访问 chart 中的其他文件。请参阅 “访问文件” 部分。<ul>
<li>Files.Get 是一个按名称获取文件的函数（.Files.Get config.ini）</li>
<li>Files.GetBytes 是将文件内容作为字节数组而不是字符串获取的函数。这对于像图片这样的东西很有用。</li>
</ul>
</li>
<li>Capabilities：这提供了关于 Kubernetes 集群支持的功能的信息。<ul>
<li>Capabilities.APIVersions 是一组版本信息。</li>
<li>Capabilities.APIVersions.Has $version 指示是否在群集上启用版本（batch&#x2F;v1）。</li>
<li>Capabilities.KubeVersion 提供了查找 Kubernetes 版本的方法。它具有以下值：Major，Minor，GitVersion，GitCommit，GitTreeState，BuildDate，GoVersion，Compiler，和 Platform。</li>
<li>Capabilities.TillerVersion 提供了查找 Tiller 版本的方法。它具有以下值：SemVer，GitCommit，和 GitTreeState。</li>
</ul>
</li>
<li>Template：包含有关正在执行的当前模板的信息</li>
<li>Name：到当前模板的文件路径（例如 mychart&#x2F;templates&#x2F;mytemplate.yaml）</li>
<li>BasePath：当前 chart 模板目录的路径（例如 mychart&#x2F;templates）。</li>
</ul>
<p>上面这些值可用于任何顶级模板，要注意内置值始终以大写字母开头。这也符合<code>Go</code>的命名约定。当你创建自己的名字时，你可以自由地使用适合你的团队的惯例。</p>
<h2 id="values-文件"><a href="#values-文件" class="headerlink" title="values 文件"></a>values 文件</h2><p>上面的内置对象中有一个对象就是 Values，该对象提供对传入 chart 的值的访问，Values 对象的值有4个来源：</p>
<ul>
<li>chart 包中的 values.yaml 文件</li>
<li>父 chart 包的 values.yaml 文件</li>
<li>通过 helm install 或者 helm upgrade 的<code>-f</code>或者<code>--values</code>参数传入的自定义的 yaml 文件(上节课我们已经学习过)</li>
<li>通过<code>--set</code> 参数传入的值</li>
</ul>
<p>chart 的 values.yaml 提供的值可以被用户提供的 values 文件覆盖，而该文件同样可以被<code>--set</code>提供的参数所覆盖。</p>
<p>这里我们来重新编辑 mychart&#x2F;values.yaml 文件，将默认的值全部清空，添加一个新的数据：(values.yaml)</p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">course:</span> k8s</span><br></pre></td></tr></table></figure>

<p>然后我们在上面的 templates&#x2F;configmap.yaml 模板文件中就可以使用这个值了：(configmap.yaml)</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> ConfigMap</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> &#123;&#123; &#x27;&#123;&#123;&#x27; &#125;&#125;.Release.Name &#125;&#125;-configmap</span><br><span class="line"><span class="params">data:</span></span><br><span class="line">  <span class="params">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="params">course:</span> &#123;&#123; &#x27;&#123;&#123;&#x27; &#125;&#125;.Values.course &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到最后一行我们是通过<code>&#123;&#123; '&#123;&#123;' &#125;&#125;.Values.course &#125;&#125;</code>来获取 course 的值的。现在我们用 debug 模式来查看下我们的模板会被如何渲染：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">./mychart</span></span><br><span class="line"><span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;33509&#x27;</span></span><br><span class="line"></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">SERVER:</span> <span class="string">&quot;127.0.0.1:33509&quot;</span></span><br><span class="line"></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Original chart version:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">CHART PATH:</span> <span class="string">/root/course/kubeadm/helm/mychart</span></span><br><span class="line"></span><br><span class="line"><span class="attr">NAME:</span>   <span class="string">nasal-anaconda</span></span><br><span class="line"><span class="attr">REVISION:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">RELEASED:</span> <span class="string">Sun</span> <span class="string">Sep</span>  <span class="number">9</span> <span class="number">17</span><span class="string">:37:52</span> <span class="number">2018</span></span><br><span class="line"><span class="attr">CHART:</span> <span class="string">mychart-0.1.0</span></span><br><span class="line"><span class="attr">USER-SUPPLIED VALUES:</span></span><br><span class="line">&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="attr">COMPUTED VALUES:</span></span><br><span class="line"><span class="attr">course:</span> <span class="string">k8s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">HOOKS:</span></span><br><span class="line"><span class="attr">MANIFEST:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nasal-anaconda-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">course:</span> <span class="string">k8s</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到 ConfigMap 中 course 的值被渲染成了 k8s，这是因为在默认的 values.yaml 文件中该参数值为 k8s，同样的我们可以通过<code>--set</code>参数来轻松的覆盖 course 的值：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">--set</span> <span class="string">course=python</span> <span class="string">./mychart</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;44571&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">named-scorpion-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">course:</span> <span class="string">python</span></span><br></pre></td></tr></table></figure>

<p>由于<code>--set</code> 比默认 values.yaml 文件具有更高的优先级，所以我们的模板生成为 course: python。</p>
<p>values 文件也可以包含更多结构化内容，例如，我们在 values.yaml 文件中可以创建 course 部分，然后在其中添加几个键：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">course:</span></span><br><span class="line"><span class="symbol">  k8s:</span> devops</span><br><span class="line"><span class="symbol">  python:</span> django</span><br></pre></td></tr></table></figure>

<p>现在我们稍微修改模板：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; <span class="string">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;<span class="selector-class">.Release</span><span class="selector-class">.Name</span> &#125;&#125;-configmap</span><br><span class="line">data:</span><br><span class="line">  myvalue: <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  k8s: &#123;&#123; <span class="string">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;<span class="selector-class">.Values</span><span class="selector-class">.course</span><span class="selector-class">.k8s</span> &#125;&#125;</span><br><span class="line">  python: &#123;&#123; <span class="string">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;<span class="selector-class">.Values</span><span class="selector-class">.course</span><span class="selector-class">.python</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>同样可以使用 debug 模式查看渲染结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">./mychart</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;33801&#x27;</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">exhaling-turtle-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">devops</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">django</span></span><br></pre></td></tr></table></figure>

<p>可以看到模板中的参数已经被 values.yaml 文件中的值给替换掉了。虽然以这种方式构建数据是可以的，但我们还是建议保持 value 树浅一些，平一些，这样维护起来要简单一点。</p>
<p>到这里，我们已经看到了几个内置对象的使用方法，并用它们将信息注入到了模板之中。下节课我们来看看模板引擎中的其他用法，比如<strong>函数、管道、控制结构</strong>等等的用法。</p>
<h1 id="模板函数与管道"><a href="#模板函数与管道" class="headerlink" title="模板函数与管道"></a>模板函数与管道</h1><p>上面学习了如何将信息渲染到模板之中，但是这些信息都是直接传入模板引擎中进行渲染的，有的时候我们想要转换一下这些数据才进行渲染，这就需要使用到 Go 模板语言中的一些其他用法。</p>
<h2 id="模板函数"><a href="#模板函数" class="headerlink" title="模板函数"></a>模板函数</h2><p>比如我们需要从<code>.Values</code>中读取的值变成字符串的时候就可以通过调用<code>quote</code>模板函数来实现：(templates&#x2F;configmap.yaml)</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; <span class="string">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;<span class="selector-class">.Release</span><span class="selector-class">.Name</span> &#125;&#125;-configmap</span><br><span class="line">data:</span><br><span class="line">  myvalue: <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  k8s: &#123;&#123; <span class="string">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;<span class="selector-tag">quote</span> <span class="selector-class">.Values</span><span class="selector-class">.course</span><span class="selector-class">.k8s</span> &#125;&#125;</span><br><span class="line">  python: &#123;&#123; <span class="string">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;<span class="selector-class">.Values</span><span class="selector-class">.course</span><span class="selector-class">.python</span> &#125;&#125;</span><br></pre></td></tr></table></figure>

<p>模板函数遵循调用的语法为：<code>functionName arg1 arg2...</code>。在上面的模板文件中，<code>quote .Values.course.k8s</code>调用<code>quote</code>函数并将后面的值作为一个参数传递给它。最终被渲染为：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;39405&#x27;</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">masked-saola-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;devops&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">django</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到<code>.Values.course.k8s</code>被渲染成了字符串<code>devops</code>。上节课我们也提到过 Helm 是一种 Go 模板语言，拥有超过60多种可用的内置函数，一部分是由<a href="https://godoc.org/text/template">Go 模板语言</a>本身定义的，其他大部分都是<a href="https://godoc.org/github.com/Masterminds/sprig"><code>Sprig</code>模板库</a>提供的一部分，我们可以前往这两个文档中查看这些函数的用法。</p>
<p>比如我们这里使用的<code>quote</code>函数就是<code>Sprig 模板库</code>提供的一种字符串函数，用途就是用双引号将字符串括起来，如果需要双引号<code>&quot;</code>，则需要添加<code>\</code>来进行转义，而<code>squote</code>函数的用途则是用双引号将字符串括起来，而不会对内容进行转义。</p>
<p>所以在我们遇到一些需求的时候，首先要想到的是去查看下上面的两个模板文档中是否提供了对应的模板函数，这些模板函数可以很好的解决我们的需求。</p>
<h2 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h2><p>模板语言除了提供了丰富的内置函数之外，其另一个强大的功能就是<strong>管道</strong>的概念。和<code>UNIX</code>中一样，管道我们通常称为<code>Pipeline</code>，是一个链在一起的一系列模板命令的工具，以紧凑地表达一系列转换。简单来说，管道是可以按顺序完成一系列事情的一种方法。比如我们用管道来重写上面的 ConfigMap 模板：（templates&#x2F;configmap.yaml）</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">apiVersion: v1</span></span><br><span class="line"><span class="language-xml">kind: ConfigMap</span></span><br><span class="line"><span class="language-xml">metadata:</span></span><br><span class="line"><span class="language-xml">  name: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;-configmap</span></span><br><span class="line"><span class="language-xml">data:</span></span><br><span class="line"><span class="language-xml">  myvalue: &quot;Hello World&quot;</span></span><br><span class="line"><span class="language-xml">  k8s: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.course.k8s | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  python: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.course.python &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>这里我们直接调用<code>quote</code>函数，而是调换了一个顺序，使用一个管道符<code>|</code>将前面的<strong>参数</strong>发送给后面的<strong>模板函数</strong>：<code>&#123;&#123; '&#123;&#123;' &#125;&#125;.Values.course.k8s | quote &#125;&#125;</code>，使用管道我们可以将几个功能顺序的连接在一起，比如我们希望上面的 ConfigMap 模板中的 k8s 的 value 值被渲染后是大写的字符串，则我们就可以使用管道来修改：（templates&#x2F;configmap.yaml）</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">apiVersion: v1</span></span><br><span class="line"><span class="language-xml">kind: ConfigMap</span></span><br><span class="line"><span class="language-xml">metadata:</span></span><br><span class="line"><span class="language-xml">  name: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;-configmap</span></span><br><span class="line"><span class="language-xml">data:</span></span><br><span class="line"><span class="language-xml">  myvalue: &quot;Hello World&quot;</span></span><br><span class="line"><span class="language-xml">  k8s: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.course.k8s | upper | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  python: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.course.python &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>这里我们在管道中增加了一个<code>upper</code>函数，该函数同样是<a href="https://godoc.org/github.com/Masterminds/sprig"><code>Sprig 模板库</code></a>提供的，表示将字符串每一个字母都变成大写。然后我们用<code>debug</code>模式来查看下上面的模板最终会被渲染成什么样子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;46651&#x27;</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">maudlin-labradoodle-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;DEVOPS&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">django</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到之前我们的<code>devops</code>已经被渲染成了<code>&quot;DEVOPS&quot;</code>了，要注意的是使用管道操作的时候，前面的操作结果会作为参数传递给后面的模板函数，比如我们这里希望将上面模板中的 python 的值渲染为重复出现3次的字符串，则我们就可以使用到<a href="https://godoc.org/github.com/Masterminds/sprig"><code>Sprig 模板库</code></a>提供的<code>repeat</code>函数，不过该函数需要传入一个参数<code>repeat COUNT STRING</code>表示重复的次数：（templates&#x2F;configmap.yaml）</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">apiVersion: v1</span></span><br><span class="line"><span class="language-xml">kind: ConfigMap</span></span><br><span class="line"><span class="language-xml">metadata:</span></span><br><span class="line"><span class="language-xml">  name: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;-configmap</span></span><br><span class="line"><span class="language-xml">data:</span></span><br><span class="line"><span class="language-xml">  myvalue: &quot;Hello World&quot;</span></span><br><span class="line"><span class="language-xml">  k8s: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.course.k8s | upper | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  python: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.course.python | quote | repeat 3 &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>该<code>repeat</code>函数会将给定的字符串重复3次返回，所以我们将得到这个输出：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;39712&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Error: YAML parse error on mychart/templates/configmap.yaml: error converting YAML to JSON: yaml: line 7:</span> <span class="string">did</span> <span class="string">not</span> <span class="string">find</span> <span class="string">expected</span> <span class="string">key</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">piquant-butterfly-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;DEVOPS&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">&quot;django&quot;</span><span class="string">&quot;django&quot;</span><span class="string">&quot;django&quot;</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到上面的输出中 python 对应的值变成了3个相同的字符串，这显然是不符合我们预期的，我们的预期是形成一个字符串，而现在是3个字符串了，而且上面还有错误信息，根据管道处理的顺序，我们将<code>quote</code>函数放到<code>repeat</code>函数后面去是不是就可以解决这个问题了：（templates&#x2F;configmap.yaml）</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">apiVersion: v1</span></span><br><span class="line"><span class="language-xml">kind: ConfigMap</span></span><br><span class="line"><span class="language-xml">metadata:</span></span><br><span class="line"><span class="language-xml">  name: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;-configmap</span></span><br><span class="line"><span class="language-xml">data:</span></span><br><span class="line"><span class="language-xml">  myvalue: &quot;Hello World&quot;</span></span><br><span class="line"><span class="language-xml">  k8s: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.course.k8s | upper | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  python: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.course.python | repeat 3 | quote &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>现在是不是就是先重复3次<code>.Values.course.python</code>的值，然后调用<code>quote</code>函数：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;33837&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">braided-manatee-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;DEVOPS&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">&quot;djangodjangodjango&quot;</span></span><br></pre></td></tr></table></figure>

<p>现在是不是就正常了，也得到了我们的预期结果，所以我们在使用管道操作的时候一定要注意是按照从前到后一步一步顺序处理的。</p>
<h2 id="default-函数"><a href="#default-函数" class="headerlink" title="default 函数"></a>default 函数</h2><p>另外一个我们会经常使用的一个函数是<code>default 函数</code>：<code>default DEFAULT_VALUE GIVEN_VALUE</code>。该函数允许我们在模板内部指定默认值，以防止该值被忽略掉了。比如我们来修改上面的 ConfigMap 的模板：（templates&#x2F;configmap.yaml）</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">apiVersion: v1</span></span><br><span class="line"><span class="language-xml">kind: ConfigMap</span></span><br><span class="line"><span class="language-xml">metadata:</span></span><br><span class="line"><span class="language-xml">  name: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;-configmap</span></span><br><span class="line"><span class="language-xml">data:</span></span><br><span class="line"><span class="language-xml">  myvalue: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.hello | default  &quot;Hello World&quot; | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  k8s: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.course.k8s | upper | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  python: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.course.python | repeat 5 | quote &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>由于我们的<code>values.yaml</code>文件中只定义了 course 结构的信息，并没有定义 hello 的值，所以如果没有设置默认值的话是得不到<code>&#123;&#123; '&#123;&#123;' &#125;&#125;.Values.hello &#125;&#125;</code>的值的，这里我们为该值定义了一个默认值：<code>Hello World</code>，所以现在如果在<code>values.yaml</code>文件中没有定义这个值，则我们也可以得到默认值：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;42670&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">orbiting-hog-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;DEVOPS&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">&quot;djangodjangodjangodjangodjango&quot;</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到<code>myvalue</code>值被渲染成了<strong>Hello World</strong>，证明我们的默认值生效了。</p>
<h1 id="控制流程"><a href="#控制流程" class="headerlink" title="控制流程"></a>控制流程</h1><p><code>模板函数和管道</code>是通过转换信息并将其插入到<code>YAML</code>文件中的强大方法。但有时候需要添加一些比插入字符串更复杂一些的模板逻辑。这就需要使用到模板语言中提供的控制结构了。</p>
<p>控制流程为我们提供了控制模板生成流程的一种能力，Helm 的模板语言提供了以下几种流程控制：</p>
<ul>
<li><code>if/else</code> 条件块</li>
<li><code>with</code> 指定范围</li>
<li><code>range</code> 循环块</li>
</ul>
<p>除此之外，它还提供了一些声明和使用命名模板段的操作：</p>
<ul>
<li><code>define</code>在模板中声明一个新的命名模板</li>
<li><code>template</code>导入一个命名模板</li>
<li><code>block</code>声明了一种特殊的可填写的模板区域</li>
</ul>
<p>关于<code>命名模板</code>的相关知识点，我们会在后面的课程中和大家接触到，这里我们暂时和大家介绍<code>if/else</code>、<code>with</code>、<code>range</code>这3中控制流程的用法。</p>
<h2 id="if-else-条件"><a href="#if-else-条件" class="headerlink" title="if&#x2F;else 条件"></a>if&#x2F;else 条件</h2><p><code>if/else</code>块是用于在模板中有条件地包含文本块的方法，条件块的基本结构如下：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">if PIPELINE &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  # Do something</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">else if OTHER PIPELINE &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  # Do something else</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">else &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  # Default case</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>当然要使用条件块就得判断条件是否为真，如果值为下面的几种情况，则管道的结果为 false：</p>
<ul>
<li>一个布尔类型的<code>假</code></li>
<li>一个数字<code>零</code></li>
<li>一个<code>空</code>的字符串</li>
<li>一个<code>nil</code>（空或<code>null</code>）</li>
<li>一个空的集合（<code>map</code>、<code>slice</code>、<code>tuple</code>、<code>dict</code>、<code>array</code>）</li>
</ul>
<p>除了上面的这些情况外，其他所有条件都为<code>真</code>。</p>
<p>同样还是以上面的 ConfigMap 模板文件为例，添加一个简单的条件判断，如果 python 被设置为 django，则添加一个<code>web: true</code>：（tempaltes&#x2F;configmap.yaml）</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">apiVersion: v1</span></span><br><span class="line"><span class="language-xml">kind: ConfigMap</span></span><br><span class="line"><span class="language-xml">metadata:</span></span><br><span class="line"><span class="language-xml">  name: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;-configmap</span></span><br><span class="line"><span class="language-xml">data:</span></span><br><span class="line"><span class="language-xml">  myvalue: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.hello | default  &quot;Hello World&quot; | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  k8s: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.course.k8s | upper | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  python: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.course.python | repeat 3 | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">if eq .Values.course.python &quot;django&quot; &#125;&#125;web: true</span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>在上面的模板文件中我们增加了一个条件语句判断<code>&#123;&#123; '&#123;&#123;' &#125;&#125;if eq .Values.course.python &quot;django&quot; &#125;&#125;web: true&#123;&#123; '&#123;&#123;' &#125;&#125;end &#125;&#125;</code>，其中运算符<code>eq</code>是判断是否相等的操作，除此之外，还有<code>ne</code>、<code>lt</code>、<code>gt</code>、<code>and</code>、<code>or</code>等运算符都是 Helm 模板已经实现了的，直接使用即可。这里我们<code>&#123;&#123; '&#123;&#123;' &#125;&#125;.Values.course.python &#125;&#125;</code>的值在<code>values.yaml</code>文件中默认被设置为了<strong>django</strong>，所以正常来说下面的条件语句判断为<strong>真</strong>，所以模板文件最终被渲染后会有<code>web: true</code>这样的的一个条目：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;40143&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fallacious-prawn-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;DEVOPS&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">&quot;djangodjangodjangodjangodjango&quot;</span></span><br><span class="line">  <span class="attr">web:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>可以看到上面模板被渲染后出现了<code>web: true</code>的条目，如果我们在安装的时候覆盖下 python 的值呢，比如我们改成 ai:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">--set</span> <span class="string">course.python=ai</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;42802&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dull-mite-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;DEVOPS&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">&quot;aiaiai&quot;</span></span><br></pre></td></tr></table></figure>

<p>根据我们模板文件中的定义，如果<code>&#123;&#123; '&#123;&#123;' &#125;&#125;.Values.course.python &#125;&#125;</code>的值为<code>django</code>的话就会新增<code>web: true</code>这样的一个条目，但是现在我们是不是通过参数<code>--set</code>将值设置为了 ai，所以这里条件判断为<strong>假</strong>，正常来说就不应该出现这个条目了，上面我们通过 debug 模式查看最终被渲染的值也没有出现这个条目，证明条件判断是正确的。</p>
<h2 id="空格控制"><a href="#空格控制" class="headerlink" title="空格控制"></a>空格控制</h2><p>上面我们的条件判断语句是在一整行中的，如果平时经常写代码的同学可能非常不习惯了，我们一般会将其格式化为更容易阅读的形式，比如：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">if eq .Values.course.python &quot;django&quot; &#125;&#125;</span></span><br><span class="line"><span class="language-xml">web: true</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>这样的话看上去比之前要清晰很多了，但是我们通过模板引擎来渲染一下，会得到如下结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;44537&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">bald-narwhal-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;DEVOPS&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">&quot;djangodjangodjango&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">web:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到渲染出来会有多余的空行，这是因为当模板引擎运行时，它将一些值渲染过后，之前的指令被删除，但它之前所占的位置完全按原样保留剩余的空白了，所以就出现了多余的空行。<code>YAML</code>文件中的空格是非常严格的，所以对于空格的管理非常重要，一不小心就会导致你的<code>YAML</code>文件格式错误。</p>
<p>我们可以通过使用在模板标识<code>&#123;&#123; '&#123;&#123;' &#125;&#125;</code>后面添加破折号和空格<code>&#123;&#123; '&#123;&#123;' &#125;&#125;-</code>来表示将空白左移，而在<code>&#125;&#125;</code>前面添加一个空格和破折号<code>-&#125;&#125;</code>表示应该删除右边的空格，另外需要注意的是<strong>换行符也是空格！</strong></p>
<p>使用这个语法，我们来修改我们上面的模板文件去掉多余的空格：（templates&#x2F;configmap.yaml）</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">apiVersion: v1</span></span><br><span class="line"><span class="language-xml">kind: ConfigMap</span></span><br><span class="line"><span class="language-xml">metadata:</span></span><br><span class="line"><span class="language-xml">  name: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;-configmap</span></span><br><span class="line"><span class="language-xml">data:</span></span><br><span class="line"><span class="language-xml">  myvalue: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.hello | default  &quot;Hello World&quot; | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  k8s: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.course.k8s | upper | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  python: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.course.python | repeat 3 | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- if eq .Values.course.python &quot;django&quot; &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  web: true</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>现在我们来查看上面模板渲染过后的样子：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;34702&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mangy-olm-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;DEVOPS&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">&quot;djangodjangodjango&quot;</span></span><br><span class="line">  <span class="attr">web:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>现在是不是没有多余的空格了，另外我们需要谨慎使用<code>-&#125;&#125;</code>，比如上面模板文件中：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">python: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.course.python | repeat 3 | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- if eq .Values.course.python &quot;django&quot; -&#125;&#125;</span></span><br><span class="line"><span class="language-xml">web: true</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果我们在<code>if</code>条件后面增加<code>-&#125;&#125;</code>，这会渲染成：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="params">python:</span> <span class="string">&quot;djangodjangodjango&quot;</span><span class="params">web:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>因为<code>-&#125;&#125;</code>它删除了双方的换行符，显然这是不正确的。</p>
<blockquote>
<p>有关模板中空格控制的详细信息，请参阅官方 Go 模板文档<a href="https://godoc.org/text/template">Official Go template documentation</a></p>
</blockquote>
<h2 id="使用-with-修改范围"><a href="#使用-with-修改范围" class="headerlink" title="使用 with 修改范围"></a>使用 with 修改范围</h2><p>接下来我们来看下<code>with</code>关键词的使用，它用来控制变量作用域。还记得之前我们的<code>&#123;&#123; '&#123;&#123;' &#125;&#125;.Release.xxx &#125;&#125;</code>或者<code>&#123;&#123; '&#123;&#123;' &#125;&#125;.Values.xxx &#125;&#125;</code>吗？其中的<code>.</code>就是表示对当前范围的引用，<code>.Values</code>就是告诉模板在当前范围中查找<code>Values</code>对象的值。而<code>with</code>语句就可以来控制变量的作用域范围，其语法和一个简单的<code>if</code>语句比较类似：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">with PIPELINE &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  #  restricted scope</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>with</code>语句可以允许将当前范围<code>.</code>设置为特定的对象，比如我们前面一直使用的<code>.Values.course</code>，我们可以使用<code>with</code>来将<code>.</code>范围指向<code>.Values.course</code>：(templates&#x2F;configmap.yaml)</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">apiVersion: v1</span></span><br><span class="line"><span class="language-xml">kind: ConfigMap</span></span><br><span class="line"><span class="language-xml">metadata:</span></span><br><span class="line"><span class="language-xml">  name: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;-configmap</span></span><br><span class="line"><span class="language-xml">data:</span></span><br><span class="line"><span class="language-xml">  myvalue: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.hello | default  &quot;Hello World&quot; | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- with .Values.course &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  k8s: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.k8s | upper | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  python: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.python | repeat 3 | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- if eq .python &quot;django&quot; &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  web: true</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以看到上面我们增加了一个<code>&#123;&#123; '&#123;&#123;' &#125;&#125;- with .Values.course &#125;&#125;xxx&#123;&#123; '&#123;&#123;' &#125;&#125;- end &#125;&#125;</code>的一个块，这样的话我们就可以在当前的块里面直接引用<code>.python</code>和<code>.k8s</code>了，而不需要进行限定了，这是因为该<code>with</code>声明将<code>.</code>指向了<code>.Values.course</code>，在<code>&#123;&#123; '&#123;&#123;' &#125;&#125;- end &#125;&#125;</code>后<code>.</code>就会复原其之前的作用范围了，我们可以使用模板引擎来渲染上面的模板查看是否符合预期结果。</p>
<p>不过需要注意的是在<code>with</code>声明的范围内，此时将无法从父范围访问到其他对象了，比如下面的模板渲染的时候将会报错，因为显然<code>.Release</code>根本就不在当前的<code>.</code>范围内，当然如果我们最后两行交换下位置就正常了，因为<code>&#123;&#123; '&#123;&#123;' &#125;&#125;- end &#125;&#125;</code>之后范围就被重置了：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- with .Values.course &#125;&#125;</span></span><br><span class="line"><span class="language-xml">k8s: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.k8s | upper | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">python: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.python | repeat 3 | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">release: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="range-循环"><a href="#range-循环" class="headerlink" title="range 循环"></a>range 循环</h2><p>如果大家对编程语言熟悉的话，几乎所有的编程语言都支持类似于<code>for</code>、<code>foreach</code>或者类似功能的循环机制，在 Helm 模板语言中，是使用<code>range</code>关键字来进行循环操作。</p>
<p>我们在<code>values.yaml</code>文件中添加上一个课程列表：</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">course</span><span class="punctuation">:</span></span><br><span class="line">  <span class="attribute">k8s</span><span class="punctuation">:</span> <span class="string">devops</span></span><br><span class="line">  <span class="attribute">python</span><span class="punctuation">:</span> <span class="string">django</span></span><br><span class="line"><span class="attribute">courselist</span><span class="punctuation">:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">k8s</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">python</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">search</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">golang</span></span><br></pre></td></tr></table></figure>

<p>现在我们有一个课程列表，修改 ConfigMap 模板文件来循环打印出该列表：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">apiVersion: v1</span></span><br><span class="line"><span class="language-xml">kind: ConfigMap</span></span><br><span class="line"><span class="language-xml">metadata:</span></span><br><span class="line"><span class="language-xml">  name: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;-configmap</span></span><br><span class="line"><span class="language-xml">data:</span></span><br><span class="line"><span class="language-xml">  myvalue: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Values.hello | default  &quot;Hello World&quot; | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- with .Values.course &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  k8s: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.k8s | upper | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  python: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.python | repeat 3 | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- if eq .python &quot;django&quot; &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  web: true</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  courselist:</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- range .Values.courselist &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  - </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">. | title | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以看到最下面我们使用了一个<code>range</code>函数，该函数将会遍历<code>&#123;&#123; '&#123;&#123;' &#125;&#125;.Values.courselist &#125;&#125;</code>列表，循环内部我们使用的是一个<code>.</code>，这是因为当前的作用域就在当前循环内，这个<code>.</code>从列表的第一个元素一直遍历到最后一个元素，然后在遍历过程中使用了<code>title</code>和<code>quote</code>这两个函数，前面这个函数是将字符串首字母变成大写，后面就是加上双引号变成字符串，所以按照上面这个模板被渲染过后的结果为：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;34626&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dining-terrier-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myvalue:</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;DEVOPS&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">&quot;djangodjangodjango&quot;</span></span><br><span class="line">  <span class="attr">web:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">courselist:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;K8s&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;Python&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;Search&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;Golang&quot;</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到<code>courselist</code>按照我们的要求循环出来了。除了 list 或者 tuple，range 还可以用于遍历具有键和值的集合（如map 或 dict），这个就需要用到变量的概念了。</p>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>前面我们已经学习了函数、管理以及控制流程的使用方法，我们知道编程语言中还有一个很重要的概念叫：<strong>变量</strong>，在 Helm 模板中，使用变量的场合不是特别多，但是在合适的时候使用变量可以很好的解决我们的问题。如下面的模板：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- with .Values.course &#125;&#125;</span></span><br><span class="line"><span class="language-xml">k8s: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.k8s | upper | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">python: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.python | repeat 3 | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">release: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>我们在<code>with</code>语句块内添加了一个<code>.Release.Name</code>对象，但这个模板是错误的，编译的时候会失败，这是因为<code>.Release.Name</code>不在该<code>with</code>语句块限制的作用范围之内，我们可以将该对象赋值给一个变量可以来解决这个问题：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">apiVersion: v1</span></span><br><span class="line"><span class="language-xml">kind: ConfigMap</span></span><br><span class="line"><span class="language-xml">metadata:</span></span><br><span class="line"><span class="language-xml">  name: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;-configmap</span></span><br><span class="line"><span class="language-xml">data:</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- $releaseName := .Release.Name -&#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- with .Values.course &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  k8s: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.k8s | upper | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  python: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.python | repeat 3 | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  release: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">$releaseName &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到我们在<code>with</code>语句上面增加了一句<code>&#123;&#123; '&#123;&#123;' &#125;&#125;- $releaseName := .Release.Name -&#125;&#125;</code>，其中<code>$releaseName</code>就是后面的对象的一个引用变量，它的形式就是<code>$name</code>，赋值操作使用<code>:=</code>，这样<code>with</code>语句块内部的<code>$releaseName</code>变量仍然指向的是<code>.Release.Name</code>，同样，我们 DEBUG 下查看结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;45474&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nosy-seagull-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;DEVOPS&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">&quot;djangodjangodjango&quot;</span></span><br><span class="line">  <span class="attr">release:</span> <span class="string">nosy-seagull</span></span><br></pre></td></tr></table></figure>

<p>可以看到已经正常了，另外变量在<code>range</code>循环中也非常有用，我们可以在循环中用变量来同时捕获索引的值：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">courselist:</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- range $index, $course := .Values.courselist &#125;&#125;</span></span><br><span class="line"><span class="language-xml">- </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">$index &#125;&#125;: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">$course | title | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>例如上面的这个列表，我们在<code>range</code>循环中使用<code>$index</code>和<code>$course</code>两个变量来接收后面列表循环的索引和对应的值，最终可以得到如下结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;38876&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">vetoed-anaconda-configmap</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">courselist:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">0:</span> <span class="string">&quot;K8s&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">1:</span> <span class="string">&quot;Python&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">2:</span> <span class="string">&quot;Search&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">3:</span> <span class="string">&quot;Golang&quot;</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到 courselist 下面将索引和对应的值都打印出来了，实际上具有键和值的数据结构我们都可以使用<code>range</code>来循环获得二者的值，比如我们可以对<code>.Values.course</code>这个字典来进行循环：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">apiVersion: v1</span></span><br><span class="line"><span class="language-xml">kind: ConfigMap</span></span><br><span class="line"><span class="language-xml">metadata:</span></span><br><span class="line"><span class="language-xml">  name: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;-configmap</span></span><br><span class="line"><span class="language-xml">data:</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- range $key, $value := .Values.course &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">$key &#125;&#125;: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">$value | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>直接使用<code>range</code>循环，用变量<code>$key</code>、<code>$value</code>来接收字段<code>.Values.course</code>的键和值。这就是变量在 Helm 模板中的使用方法。</p>
<h1 id="命名模板"><a href="#命名模板" class="headerlink" title="命名模板"></a>命名模板</h1><p>前面我们学习了一些<code>Helm</code>模板中的一些常用使用方法，但是我们都是操作的一个模板文件，在实际的应用中，很多都是相对比较复杂的，往往会超过一个模板，如果有多个应用模板，我们应该如何进行处理呢？这就需要用到新的概念：<strong>命名模板</strong>。</p>
<p>命名模板我们也可以称为子模板，是限定在一个文件内部的模板，然后给一个名称。在使用命名模板的时候有一个需要特别注意的是：<strong>模板名称是全局的</strong>，如果我们声明了两个相同名称的模板，最后加载的一个模板会覆盖掉另外的模板，由于子 chart 中的模板也是和顶层的模板一起编译的，所以在命名的时候一定要注意，不要重名了。</p>
<p>为了避免重名，有个通用的约定就是为每个定义的模板添加上 chart 名称：<code>&#123;&#123; '&#123;&#123;' &#125;&#125;define &quot;mychart.labels&quot;&#125;&#125;</code>，<code>define</code>关键字就是用来声明命名模板的，加上 chart 名称就可以避免不同 chart 间的模板出现冲突的情况。</p>
<h2 id="声明和使用命名模板"><a href="#声明和使用命名模板" class="headerlink" title="声明和使用命名模板"></a>声明和使用命名模板</h2><p>使用<code>define</code>关键字就可以允许我们在模板文件内部创建一个命名模板，它的语法格式如下：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">define &quot;ChartName.TplName&quot; &#125;&#125;</span></span><br><span class="line"><span class="language-xml"># 模板内容区域</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>比如，现在我们可以定义一个模板来封装一个 label 标签：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- define &quot;mychart.labels&quot; &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  labels:</span></span><br><span class="line"><span class="language-xml">    from: helm</span></span><br><span class="line"><span class="language-xml">    date: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">now | htmlDate &#125;&#125;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后我们可以将该模板嵌入到现有的 ConfigMap 中，然后使用<code>template</code>关键字在需要的地方包含进来即可：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- define &quot;mychart.labels&quot; &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  labels:</span></span><br><span class="line"><span class="language-xml">    from: helm</span></span><br><span class="line"><span class="language-xml">    date: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">now | htmlDate &#125;&#125;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br><span class="line"><span class="language-xml">apiVersion: v1</span></span><br><span class="line"><span class="language-xml">kind: ConfigMap</span></span><br><span class="line"><span class="language-xml">metadata:</span></span><br><span class="line"><span class="language-xml">  name: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;-configmap</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- template &quot;mychart.labels&quot; &#125;&#125;</span></span><br><span class="line"><span class="language-xml">data:</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- range $key, $value := .Values.course &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">$key &#125;&#125;: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">$value | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>我们这个模板文件被渲染过后的结果如下所示：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;42058&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ardent-bunny-configmap</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">from:</span> <span class="string">helm</span></span><br><span class="line">    <span class="attr">date:</span> <span class="number">2018-09-22</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;devops&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">&quot;django&quot;</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到<code>define</code>区域定义的命名模板被嵌入到了<code>template</code>所在的区域，但是如果我们将命名模板全都写入到一个模板文件中的话无疑也会增大模板的复杂性。</p>
<p>还记得我们在创建 chart 包的时候，templates 目录下面默认会生成一个<code>_helpers.tpl</code>文件吗？我们前面也提到过 templates 目录下面除了<code>NOTES.txt</code>文件和以下划线<code>_</code>开头命令的文件之外，都会被当做 kubernetes 的资源清单文件，而这个下划线开头的文件不会被当做资源清单外，还可以被其他 chart 模板中调用，这个就是 Helm 中的<code>partials</code>文件，所以其实我们完全就可以将命名模板定义在这些<code>partials</code>文件中，默认就是<code>_helpers.tpl</code>文件了。</p>
<p>现在我们将上面定义的命名模板移动到 templates&#x2F;_helpers.tpl 文件中去：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">/* 生成基本的 labels 标签 */&#125;&#125;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- define &quot;mychart.labels&quot; &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  labels:</span></span><br><span class="line"><span class="language-xml">    from: helm</span></span><br><span class="line"><span class="language-xml">    date: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">now | htmlDate &#125;&#125;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>一般情况下面，我们都会在命名模板头部加一个简单的文档块，用<code>/**/</code>包裹起来，用来描述我们这个命名模板的用途的。</p>
<p>现在我们讲命名模板从模板文件 templates&#x2F;configmap.yaml 中移除，当然还是需要保留 template 来嵌入命名模板内容，名称还是之前的 mychart.lables，这是因为<strong>模板名称是全局</strong>的，所以我们可以能够直接获取到。我们再用 DEBUG 模式来调试下是否符合预期？</p>
<h2 id="模板范围"><a href="#模板范围" class="headerlink" title="模板范围"></a>模板范围</h2><p>上面我们定义的命名模板中，没有使用任何对象，只是使用了一个简单的函数，如果我们在里面来使用 chart 对象相关信息呢：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">/* 生成基本的 labels 标签 */&#125;&#125;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- define &quot;mychart.labels&quot; &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  labels:</span></span><br><span class="line"><span class="language-xml">    from: helm</span></span><br><span class="line"><span class="language-xml">    date: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">now | htmlDate &#125;&#125;</span></span><br><span class="line"><span class="language-xml">    chart: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Chart.Name &#125;&#125;</span></span><br><span class="line"><span class="language-xml">    version: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Chart.Version &#125;&#125;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果这样的直接进行渲染测试的话，是不会得到我们的预期结果的：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;42058&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">peeking-zorse-configmap</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">from:</span> <span class="string">helm</span></span><br><span class="line">    <span class="attr">date:</span> <span class="number">2018-09-22</span></span><br><span class="line">    <span class="attr">chart:</span></span><br><span class="line">    <span class="attr">version:</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;devops&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">&quot;django&quot;</span></span><br></pre></td></tr></table></figure>

<p>chart 的名称和版本都没有正确被渲染，这是因为他们不在我们定义的模板范围内，当命名模板被渲染时，它会接收由 template 调用时传入的作用域，有我们我们这里并没有传入对应的作用域，因此模板中我们无法调用到 .Chart 对象，要解决也非常简单，我们只需要在 template 后面加上作用域范围即可：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">apiVersion: v1</span></span><br><span class="line"><span class="language-xml">kind: ConfigMap</span></span><br><span class="line"><span class="language-xml">metadata:</span></span><br><span class="line"><span class="language-xml">  name: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;-configmap</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- template &quot;mychart.labels&quot; . &#125;&#125;</span></span><br><span class="line"><span class="language-xml">data:</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- range $key, $value := .Values.course &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">$key &#125;&#125;: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">$value | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>我们在 template 末尾传递了<code>.</code>，表示当前的最顶层的作用范围，如果我们想要在命名模板中使用<code>.Values</code>范围内的数据，当然也是可以的，现在我们再来渲染下我们的模板：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;32768&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">oldfashioned-mule-configmap</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">from:</span> <span class="string">helm</span></span><br><span class="line">    <span class="attr">date:</span> <span class="number">2018-09-22</span></span><br><span class="line">    <span class="attr">chart:</span> <span class="string">mychart</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;devops&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">&quot;django&quot;</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到 chart 的名称和版本号都已经被正常渲染出来了。</p>
<h2 id="include-函数"><a href="#include-函数" class="headerlink" title="include 函数"></a>include 函数</h2><p>假如现在我们将上面的定义的 labels 单独提取出来放置到 _helpers.tpl 文件中：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">/* 生成基本的 labels 标签 */&#125;&#125;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- define &quot;mychart.labels&quot; &#125;&#125;</span></span><br><span class="line"><span class="language-xml">from: helm</span></span><br><span class="line"><span class="language-xml">date: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">now | htmlDate &#125;&#125;</span></span><br><span class="line"><span class="language-xml">chart: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Chart.Name &#125;&#125;</span></span><br><span class="line"><span class="language-xml">version: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Chart.Version &#125;&#125;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>现在我们将该命名模板插入到 configmap 模板文件的 labels 部分和 data 部分：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">apiVersion: v1</span></span><br><span class="line"><span class="language-xml">kind: ConfigMap</span></span><br><span class="line"><span class="language-xml">metadata:</span></span><br><span class="line"><span class="language-xml">  name: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;-configmap</span></span><br><span class="line"><span class="language-xml">  labels:</span></span><br><span class="line"><span class="language-xml">    </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- template &quot;mychart.labels&quot; . &#125;&#125;</span></span><br><span class="line"><span class="language-xml">data:</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- range $key, $value := .Values.course &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">$key &#125;&#125;: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">$value | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- template &quot;mychart.labels&quot; . &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>然后同样的查看下渲染的结果：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;42652&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Error: YAML parse error on mychart/templates/configmap.yaml: error converting YAML to JSON: yaml: line 9:</span> <span class="string">mapping</span> <span class="string">values</span> <span class="string">are</span> <span class="string">not</span> <span class="string">allowed</span> <span class="string">in</span> <span class="string">this</span> <span class="string">context</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">altered-wombat-configmap</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line"><span class="attr">from:</span> <span class="string">helm</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2018-09-22</span></span><br><span class="line"><span class="attr">chart:</span> <span class="string">mychart</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;devops&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">&quot;django&quot;</span></span><br><span class="line"><span class="attr">from:</span> <span class="string">helm</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2018-09-22</span></span><br><span class="line"><span class="attr">chart:</span> <span class="string">mychart</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到渲染结果是有问题的，不是一个正常的 YAML 文件格式，这是因为<code>template</code>只是表示一个嵌入动作而已，不是一个函数，所以原本命名模板中是怎样的格式就是怎样的格式被嵌入进来了，比如我们可以在命名模板中给内容区域都空了两个空格，再来查看下渲染的结构：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mortal-cricket-configmap</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">  <span class="attr">from:</span> <span class="string">helm</span></span><br><span class="line">  <span class="attr">date:</span> <span class="number">2018-09-22</span></span><br><span class="line">  <span class="attr">chart:</span> <span class="string">mychart</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;devops&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">&quot;django&quot;</span></span><br><span class="line">  <span class="attr">from:</span> <span class="string">helm</span></span><br><span class="line">  <span class="attr">date:</span> <span class="number">2018-09-22</span></span><br><span class="line">  <span class="attr">chart:</span> <span class="string">mychart</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到 data 区域里面的内容是渲染正确的，但是上面 labels 区域是不正常的，因为命名模板里面的内容是属于 labels 标签的，是不符合我们的预期的，但是我们又不可能再去把命名模板里面的内容再增加两个空格，因为这样的话 data 里面的格式又不符合预期了。</p>
<p>为了解决这个问题，Helm 提供了另外一个方案来代替<code>template</code>，那就是使用<code>include</code>函数，在需要控制空格的地方使用<code>indent</code>管道函数来自己控制，比如上面的例子我们替换成<code>include</code>函数：</p>
<figure class="highlight handlebars"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml">apiVersion: v1</span></span><br><span class="line"><span class="language-xml">kind: ConfigMap</span></span><br><span class="line"><span class="language-xml">metadata:</span></span><br><span class="line"><span class="language-xml">  name: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">.Release.Name &#125;&#125;-configmap</span></span><br><span class="line"><span class="language-xml">  labels:</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- include &quot;mychart.labels&quot; . | indent 4 &#125;&#125;</span></span><br><span class="line"><span class="language-xml">data:</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- range $key, $value := .Values.course &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">$key &#125;&#125;: </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">$value | quote &#125;&#125;</span></span><br><span class="line"><span class="language-xml">  </span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- end &#125;&#125;</span></span><br><span class="line"><span class="language-xml"></span><span class="template-variable">&#123;&#123; <span class="name">&#x27;&#123;&#123;&#x27;</span> &#125;&#125;</span><span class="language-xml">- include &quot;mychart.labels&quot; . | indent 2 &#125;&#125;</span></span><br></pre></td></tr></table></figure>

<p>在 labels 区域我们需要4个空格，所以在管道函数<code>indent</code>中，传入参数4就可以，而在 data 区域我们只需要2个空格，所以我们传入参数2即可以，现在我们来渲染下我们这个模板看看是否符合预期呢：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">helm</span> <span class="string">install</span> <span class="string">--dry-run</span> <span class="string">--debug</span> <span class="string">.</span></span><br><span class="line">[<span class="string">debug</span>] <span class="attr">Created tunnel using local port:</span> <span class="string">&#x27;38481&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">......</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: mychart/templates/configmap.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">torpid-bobcat-configmap</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">from:</span> <span class="string">helm</span></span><br><span class="line">    <span class="attr">date:</span> <span class="number">2018-09-22</span></span><br><span class="line">    <span class="attr">chart:</span> <span class="string">mychart</span></span><br><span class="line">    <span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">k8s:</span> <span class="string">&quot;devops&quot;</span></span><br><span class="line">  <span class="attr">python:</span> <span class="string">&quot;django&quot;</span></span><br><span class="line">  <span class="attr">from:</span> <span class="string">helm</span></span><br><span class="line">  <span class="attr">date:</span> <span class="number">2018-09-22</span></span><br><span class="line">  <span class="attr">chart:</span> <span class="string">mychart</span></span><br><span class="line">  <span class="attr">version:</span> <span class="number">0.1</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>

<p>可以看到是符合我们的预期，所以在 Helm 模板中我们使用 include 函数要比 template 更好，可以更好地处理 YAML 文件输出格式。</p>
<hr>
<p>接下文: <a href="100058.html">kubernetes包管理工具Helm之 三.Helm Hooks使用</a></p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2018/10/100058.html" class="pre-post btn btn-default" title='kubernetes包管理工具Helm之 三.Helm Hooks使用'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">kubernetes包管理工具Helm之 三.Helm Hooks使用</span>
        </a>
    
    
        <a href="/archives/2018/10/100056.html" class="next-post btn btn-default" title='kubernetes包管理工具Helm之 一.Helm安装'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">kubernetes包管理工具Helm之 一.Helm安装</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>


    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%E5%92%8CValues"><span class="toc-text">内置函数和Values</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89-chart"><span class="toc-text">定义 chart</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%A8%A1%E6%9D%BF"><span class="toc-text">创建模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%A8%A1%E6%9D%BF"><span class="toc-text">添加一个简单的模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95"><span class="toc-text">调试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E7%BD%AE%E5%AF%B9%E8%B1%A1"><span class="toc-text">内置对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#values-%E6%96%87%E4%BB%B6"><span class="toc-text">values 文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E5%87%BD%E6%95%B0%E4%B8%8E%E7%AE%A1%E9%81%93"><span class="toc-text">模板函数与管道</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E5%87%BD%E6%95%B0"><span class="toc-text">模板函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E9%81%93"><span class="toc-text">管道</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#default-%E5%87%BD%E6%95%B0"><span class="toc-text">default 函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E6%B5%81%E7%A8%8B"><span class="toc-text">控制流程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#if-else-%E6%9D%A1%E4%BB%B6"><span class="toc-text">if&#x2F;else 条件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A9%BA%E6%A0%BC%E6%8E%A7%E5%88%B6"><span class="toc-text">空格控制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-with-%E4%BF%AE%E6%94%B9%E8%8C%83%E5%9B%B4"><span class="toc-text">使用 with 修改范围</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#range-%E5%BE%AA%E7%8E%AF"><span class="toc-text">range 循环</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%98%E9%87%8F"><span class="toc-text">变量</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E6%A8%A1%E6%9D%BF"><span class="toc-text">命名模板</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%92%8C%E4%BD%BF%E7%94%A8%E5%91%BD%E5%90%8D%E6%A8%A1%E6%9D%BF"><span class="toc-text">声明和使用命名模板</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E8%8C%83%E5%9B%B4"><span class="toc-text">模板范围</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#include-%E5%87%BD%E6%95%B0"><span class="toc-text">include 函数</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2025&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>








<script src="/js/app.js?rev=@@hash.js"></script>


</body>
</html>