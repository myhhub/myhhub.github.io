<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="docker,swarm">


    <meta name="description" content="接上文:  Docker基础之 八.Docker Machine

基本概念Swarm是使用SwarmKit构建的 Docker 引擎内置（原生）的集群管理和编排工具。Docker Swarm是...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>Docker基础之 九.Docker Swarm | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx">


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="Docker基础之 九.Docker Swarm">
            
	            Docker基础之 九.Docker Swarm
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/cloud/">云计算</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/docker/">docker</a> <a class="tag-link" href="/tags/swarm/">swarm</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2018/06/15</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>1766</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <p>接上文: <a href="100214.html"> Docker基础之 八.Docker Machine</a></p>
<hr>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p><code>Swarm</code>是使用<a href="https://github.com/docker/swarmkit/" target="_blank" rel="noopener">SwarmKit</a>构建的 Docker 引擎内置（原生）的集群管理和编排工具。<code>Docker Swarm</code>是 Docker 官方三剑客项目之一，提供 Docker 容器集群服务，是 Docker 官方对容器云生态进行支持的核心方案。</p>
<p>使用它，用户可以将多个 Docker 主机封装为单个大型的虚拟 Docker 主机，快速打造一套容器云平台。Swarm mode 内置 kv 存储功能，提供了众多的新特性，比如：具有容错能力的去中心化设计、内置服务发现、负载均衡、路由网格、动态伸缩、滚动更新、安全传输等。使得 Docker 原生的 Swarm 集群具备与<code>Mesos</code>、<code>Kubernetes</code>竞争的实力。使用 Swarm 集群之前需要了解以下几个概念。</p>
<h3 id="节点"><a href="#节点" class="headerlink" title="节点"></a>节点</h3><p>运行 Docker 的主机可以主动初始化一个 Swarm 集群或者加入一个已存在的 Swarm 集群，这样这个运行 Docker 的主机就成为一个 Swarm 集群的节点 (node) 。节点分为<code>管理 (manager) 节点和工作 (worker) 节点</code>。</p>
<p>管理节点用于<code>Swarm</code>集群的管理，<code>docker swarm</code>命令基本只能在管理节点执行（节点退出集群命令<code>docker swarm leave</code>可以在工作节点执行）。一个 Swarm 集群可以有多个管理节点，但只有一个管理节点可以成为<code>leader</code>，leader 通过<code>raft</code>协议实现。</p>
<p>工作节点是任务执行节点，管理节点将服务 (<code>service</code>) 下发至工作节点执行。管理节点默认也作为工作节点。你也可以通过配置让服务只运行在管理节点。来自<code>Docker</code>官网的这张图片形象的展示了集群中管理节点与工作节点的关系。<br><img src="/img/docker/docker-swarm-structrue.png" alt="docker swarm structrue"></p>
<h3 id="服务和任务"><a href="#服务和任务" class="headerlink" title="服务和任务"></a>服务和任务</h3><p><code>任务（Task）</code>是 Swarm 中的最小的调度单位，目前来说就是一个单一的容器；<code>服务（Services）</code>是指一组任务的集合，服务定义了任务的属性。服务有两种模式：</p>
<ul>
<li><code>replicated services</code>按照一定规则在各个工作节点上运行指定个数的任务。</li>
<li><code>global services</code>每个工作节点上运行一个任务</li>
</ul>
<p>两种模式通过<code>docker service create</code>的<code>--mode</code>参数指定。来自 Docker 官网的这张图片形象的展示了容器、任务、服务的关系。<br><img src="/img/docker/docker-swarm-task-service.png" alt="docker swarm task service"></p>
<h2 id="初始化集群"><a href="#初始化集群" class="headerlink" title="初始化集群"></a>初始化集群</h2><p>我们这里利用上一节的<code>docker machine</code>来充当集群的主机，首先先创建一个<code>manager</code>节点，然后在该节点上执行初始化集群命令：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">☁  ~  docker-machine create -d virtualbox manager</span><br><span class="line">Running pre-create checks<span class="built_in">..</span>.</span><br><span class="line">Creating machine<span class="built_in">..</span>.</span><br><span class="line">(manager) Copying /Users/ych/.docker/machine/cache/boot2docker.iso <span class="keyword">to</span> /Users/ych/.docker/machine/machines/manager/boot2docker.iso<span class="built_in">..</span>.</span><br><span class="line">(manager) Creating VirtualBox VM<span class="built_in">..</span>.</span><br><span class="line">(manager) Creating SSH key<span class="built_in">..</span>.</span><br><span class="line">(manager) Starting the VM<span class="built_in">..</span>.</span><br><span class="line">(manager) Check<span class="built_in"> network </span><span class="keyword">to</span> re-create <span class="keyword">if</span> needed<span class="built_in">..</span>.</span><br><span class="line">(manager) Waiting <span class="keyword">for</span> an IP<span class="built_in">..</span>.</span><br><span class="line">Waiting <span class="keyword">for</span> machine <span class="keyword">to</span> be running, this may take a few minutes<span class="built_in">..</span>.</span><br><span class="line">Detecting operating<span class="built_in"> system </span>of created instance<span class="built_in">..</span>.</span><br><span class="line">Waiting <span class="keyword">for</span> SSH <span class="keyword">to</span> be available<span class="built_in">..</span>.</span><br><span class="line">Detecting the provisioner<span class="built_in">..</span>.</span><br><span class="line">Provisioning with boot2docker<span class="built_in">..</span>.</span><br><span class="line">Copying certs <span class="keyword">to</span> the local machine directory<span class="built_in">..</span>.</span><br><span class="line">Copying certs <span class="keyword">to</span> the remote machine<span class="built_in">..</span>.</span><br><span class="line">Setting Docker configuration on the remote daemon<span class="built_in">..</span>.</span><br><span class="line">Checking<span class="built_in"> connection </span><span class="keyword">to</span> Docker<span class="built_in">..</span>.</span><br><span class="line">Docker is up <span class="keyword">and</span> running!</span><br><span class="line"><span class="keyword">To</span> see how <span class="keyword">to</span> connect your Docker<span class="built_in"> Client </span><span class="keyword">to</span> the Docker Engine running on this virtual machine, run: docker-machine env manager</span><br><span class="line">☁  ~  docker-machine env manager</span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">DOCKER_TLS_VERIFY</span>=<span class="string">"1"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">DOCKER_HOST</span>=<span class="string">"tcp://192.168.99.101:2376"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">DOCKER_CERT_PATH</span>=<span class="string">"/Users/ych/.docker/machine/machines/manager"</span></span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">DOCKER_MACHINE_NAME</span>=<span class="string">"manager"</span></span><br><span class="line"><span class="comment"># Run this command to configure your shell:</span></span><br><span class="line"><span class="comment"># eval $(docker-machine env manager)</span></span><br><span class="line">☁  ~  eval $(docker-machine env manager)</span><br><span class="line">☁  ~  docker-machine ssh manager</span><br><span class="line">                        ##         .</span><br><span class="line">                  ## ## ##        ==</span><br><span class="line">               ## ## ## ## ##    ===</span><br><span class="line">           /<span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">"\___/ ===</span></span><br><span class="line"><span class="string">      ~~~ &#123;~~ ~~~~ ~~~ ~~~~ ~~~ ~ /  ===- ~~~</span></span><br><span class="line"><span class="string">           \______ o           __/</span></span><br><span class="line"><span class="string">             \    \         __/</span></span><br><span class="line"><span class="string">              \____\_______/</span></span><br><span class="line"><span class="string"> _                 _   ____     _            _</span></span><br><span class="line"><span class="string">| |__   ___   ___ | |_|___ \ __| | ___   ___| | _____ _ __</span></span><br><span class="line"><span class="string">| '_ \ / _ \ / _ \| __| __) / _` |/ _ \ / __| |/ / _ \ '__|</span></span><br><span class="line"><span class="string">| |_) | (_) | (_) | |_ / __/ (_| | (_) | (__|   &lt;  __/ |</span></span><br><span class="line"><span class="string">|_.__/ \___/ \___/ \__|_____\__,_|\___/ \___|_|\_\___|_|</span></span><br><span class="line"><span class="string">Boot2Docker version 18.03.1-ce, build HEAD : cb77972 - Thu Apr 26 16:40:36 UTC 2018</span></span><br><span class="line"><span class="string">Docker version 18.03.1-ce, build 9ee9f40</span></span><br><span class="line"><span class="string">docker@manager:~$ docker swarm init --advertise-addr 192.168.99.101</span></span><br><span class="line"><span class="string">Swarm initialized: current node (3gsjpckj5ag1vvdg44fgzylow) is now a manager.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To add a worker to this swarm, run the following command:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    docker swarm join --token SWMTKN-1-1aqikkhsz91l4n7k9ig3xinjz0iv0fh4gcrlhp9mk3643rblca-aqgqldlrw33k8heiao7yx27w5 192.168.99.101:2377</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.</span></span><br></pre></td></tr></table></figure>
<p>执行<code>docker swarm init</code>命令的节点自动成为管理节点。</p>
<h2 id="增加工作节点"><a href="#增加工作节点" class="headerlink" title="增加工作节点"></a>增加工作节点</h2><p>管理节点初始化完成后，然后同样的用<code>docker-machine</code>创建工作节点，然后将其加入到管理节点之中去即可：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">☁  ~  docker-machine create -d virtualbox worker1</span><br><span class="line">Running pre-create checks<span class="built_in">..</span>.</span><br><span class="line">Creating machine<span class="built_in">..</span>.</span><br><span class="line">(worker1) Copying /Users/ych/.docker/machine/cache/boot2docker.iso <span class="keyword">to</span> /Users/ych/.docker/machine/machines/worker1/boot2docker.iso<span class="built_in">..</span>.</span><br><span class="line">(worker1) Creating VirtualBox VM<span class="built_in">..</span>.</span><br><span class="line">(worker1) Creating SSH key<span class="built_in">..</span>.</span><br><span class="line">(worker1) Starting the VM<span class="built_in">..</span>.</span><br><span class="line">(worker1) Check<span class="built_in"> network </span><span class="keyword">to</span> re-create <span class="keyword">if</span> needed<span class="built_in">..</span>.</span><br><span class="line">(worker1) Waiting <span class="keyword">for</span> an IP<span class="built_in">..</span>.</span><br><span class="line">Waiting <span class="keyword">for</span> machine <span class="keyword">to</span> be running, this may take a few minutes<span class="built_in">..</span>.</span><br><span class="line">Detecting operating<span class="built_in"> system </span>of created instance<span class="built_in">..</span>.</span><br><span class="line">Waiting <span class="keyword">for</span> SSH <span class="keyword">to</span> be available<span class="built_in">..</span>.</span><br><span class="line">Detecting the provisioner<span class="built_in">..</span>.</span><br><span class="line">Provisioning with boot2docker<span class="built_in">..</span>.</span><br><span class="line">Copying certs <span class="keyword">to</span> the local machine directory<span class="built_in">..</span>.</span><br><span class="line">Copying certs <span class="keyword">to</span> the remote machine<span class="built_in">..</span>.</span><br><span class="line">Setting Docker configuration on the remote daemon<span class="built_in">..</span>.</span><br><span class="line">Checking<span class="built_in"> connection </span><span class="keyword">to</span> Docker<span class="built_in">..</span>.</span><br><span class="line">Docker is up <span class="keyword">and</span> running!</span><br><span class="line"><span class="keyword">To</span> see how <span class="keyword">to</span> connect your Docker<span class="built_in"> Client </span><span class="keyword">to</span> the Docker Engine running on this virtual machine, run: docker-machine env worker1</span><br><span class="line"></span><br><span class="line">☁  ~  docker-machine ssh worker1</span><br><span class="line">                        ##         .</span><br><span class="line">                  ## ## ##        ==</span><br><span class="line">               ## ## ## ## ##    ===</span><br><span class="line">           /<span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">""</span><span class="string">"\___/ ===</span></span><br><span class="line"><span class="string">      ~~~ &#123;~~ ~~~~ ~~~ ~~~~ ~~~ ~ /  ===- ~~~</span></span><br><span class="line"><span class="string">           \______ o           __/</span></span><br><span class="line"><span class="string">             \    \         __/</span></span><br><span class="line"><span class="string">              \____\_______/</span></span><br><span class="line"><span class="string"> _                 _   ____     _            _</span></span><br><span class="line"><span class="string">| |__   ___   ___ | |_|___ \ __| | ___   ___| | _____ _ __</span></span><br><span class="line"><span class="string">| '_ \ / _ \ / _ \| __| __) / _` |/ _ \ / __| |/ / _ \ '__|</span></span><br><span class="line"><span class="string">| |_) | (_) | (_) | |_ / __/ (_| | (_) | (__|   &lt;  __/ |</span></span><br><span class="line"><span class="string">|_.__/ \___/ \___/ \__|_____\__,_|\___/ \___|_|\_\___|_|</span></span><br><span class="line"><span class="string">Boot2Docker version 18.03.1-ce, build HEAD : cb77972 - Thu Apr 26 16:40:36 UTC 2018</span></span><br><span class="line"><span class="string">Docker version 18.03.1-ce, build 9ee9f40</span></span><br><span class="line"><span class="string">docker@worker1:~$ docker swarm join --token SWMTKN-1-1aqikkhsz91l4n7k9ig3xinjz0iv0fh4gcrlhp9mk364</span></span><br><span class="line"><span class="string">3rblca-aqgqldlrw33k8heiao7yx27w5 192.168.99.101:2377</span></span><br><span class="line"><span class="string">This node joined a swarm as a worker.</span></span><br></pre></td></tr></table></figure>
<p>我们可以看到上面的提示信息：<strong>This node joined a swarm as a worker.</strong>，表明节点已经加入到<code>swarm</code>集群之中了。</p>
<h2 id="查看集群"><a href="#查看集群" class="headerlink" title="查看集群"></a>查看集群</h2><p>经过上边的两步，我们已经拥有了一个最小的 Swarm 集群，包含一个管理节点和两个工作节点。</p>
<p>管理节点使用<code>docker node ls</code>查看集群:</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">☁  ~  docker node ls</span><br><span class="line">ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION</span><br><span class="line">3gsjpckj5ag1vvdg44fgzylow *   manager             Ready               Active              Leader              <span class="number">18.03</span><span class="meta">.1</span>-ce</span><br><span class="line">cxmj5lr0vbwo1em9y9oang5m8     worker1             Ready               Active                                  <span class="number">18.03</span><span class="meta">.1</span>-ce</span><br><span class="line">ksruum3uc1c265ywm4kn9a88g     worker2             Ready               Active                                  <span class="number">18.03</span><span class="meta">.1</span>-ce</span><br><span class="line">☁  ~  docker service ls</span><br><span class="line">ID                  NAME                MODE                REPLICAS            IMAGE               PORTS</span><br><span class="line">☁  ~  docker service create --replicas <span class="number">3</span> -p <span class="number">80</span>:<span class="number">80</span> --name nginx nginx:<span class="number">1.13</span><span class="meta">.7</span>-alpine</span><br><span class="line">4k9cbna8ive87p4or9mny9kfs</span><br><span class="line">overall progress: <span class="number">3</span> <span class="keyword">out</span> of <span class="number">3</span> tasks</span><br><span class="line"><span class="number">1</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line"><span class="number">2</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line"><span class="number">3</span>/<span class="number">3</span>: running   [==================================================&gt;]</span><br><span class="line"><span class="symbol">verify:</span> Service converged</span><br><span class="line"></span><br><span class="line">☁  ~  docker-machine ls</span><br><span class="line">NAME      ACTIVE   DRIVER       STATE     URL                         SWARM   DOCKER        ERRORS</span><br><span class="line">manager   *        virtualbox   Running   tcp://<span class="number">192.168</span><span class="meta">.99</span><span class="meta">.101</span>:<span class="number">2376</span>           v18<span class="meta">.03</span><span class="meta">.1</span>-ce</span><br><span class="line">worker1   -        virtualbox   Running   tcp://<span class="number">192.168</span><span class="meta">.99</span><span class="meta">.102</span>:<span class="number">2376</span>           v18<span class="meta">.03</span><span class="meta">.1</span>-ce</span><br><span class="line">worker2   -        virtualbox   Running   tcp://<span class="number">192.168</span><span class="meta">.99</span><span class="meta">.103</span>:<span class="number">2376</span>           v18<span class="meta">.03</span><span class="meta">.1</span>-ce</span><br><span class="line">☁  ~  docker service ls</span><br><span class="line">ID                  NAME                MODE                REPLICAS            IMAGE                 PORTS</span><br><span class="line">4k9cbna8ive8        nginx               replicated          <span class="number">3</span>/<span class="number">3</span>                 nginx:<span class="number">1.13</span><span class="meta">.7</span>-alpine   *:<span class="number">80</span>-&gt;<span class="number">80</span>/tcp</span><br><span class="line">☁  ~  docker service ps nginx</span><br><span class="line">ID                  NAME                IMAGE                 NODE                DESIRED STATE       CURRENT STATE                ERROR               PORTS</span><br><span class="line">r7hmzkqsri8p        nginx<span class="meta">.1</span>             nginx:<span class="number">1.13</span><span class="meta">.7</span>-alpine   worker1             Running             Running about a minute ago</span><br><span class="line">y0xgrfwmjfrj        nginx<span class="meta">.2</span>             nginx:<span class="number">1.13</span><span class="meta">.7</span>-alpine   worker2             Running             Running about a minute ago</span><br><span class="line">j8k7be8xkbg3        nginx<span class="meta">.3</span>             nginx:<span class="number">1.13</span><span class="meta">.7</span>-alpine   manager             Running             Running about a minute ago</span><br></pre></td></tr></table></figure>
<p>使用<code>docker service logs</code>来查看某个服务的日志。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">☁  ~  docker<span class="built_in"> service </span>logs nginx</span><br></pre></td></tr></table></figure>
<p>使用<code>docker service rm</code>来从 Swarm 集群移除某个服务:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">☁  ~  docker<span class="built_in"> service </span>rm nginx</span><br><span class="line">nginx</span><br></pre></td></tr></table></figure>
<p>正如之前使用<code>docker-compose.yml</code>来一次配置、启动多个容器，在<code>Swarm</code>集群中也可以使用<code>compose</code>文件（docker-compose.yml）来配置、启动多个服务。</p>
<p>上一节中，我们使用<code>docker service create</code>一次只能部署一个服务，使用<code>docker-compose.yml</code>我们可以一次启动多个关联的服务。</p>
<p>我们以在<code>Swarm</code>集群中部署<code>WordPress</code>为例进行说明：（docker-compose.yml）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">  wordpress:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">overlay</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      WORDPRESS_DB_HOST:</span> <span class="attr">db:3306</span></span><br><span class="line"><span class="attr">      WORDPRESS_DB_USER:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">      WORDPRESS_DB_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">    deploy:</span></span><br><span class="line"><span class="attr">      mode:</span> <span class="string">replicated</span></span><br><span class="line"><span class="attr">      replicas:</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  db:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">    networks:</span></span><br><span class="line"><span class="bullet">       -</span> <span class="string">overlay</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="attr">      - db-data:</span><span class="string">/var/lib/mysql</span></span><br><span class="line"><span class="attr">    environment:</span></span><br><span class="line"><span class="attr">      MYSQL_ROOT_PASSWORD:</span> <span class="string">somewordpress</span></span><br><span class="line"><span class="attr">      MYSQL_DATABASE:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">      MYSQL_USER:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">      MYSQL_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">    deploy:</span></span><br><span class="line"><span class="attr">      placement:</span></span><br><span class="line"><span class="attr">        constraints:</span> <span class="string">[node.role</span> <span class="string">==</span> <span class="string">manager]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">  visualizer:</span></span><br><span class="line"><span class="attr">    image:</span> <span class="string">dockersamples/visualizer:stable</span></span><br><span class="line"><span class="attr">    ports:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"8080:8080"</span></span><br><span class="line"><span class="attr">    stop_grace_period:</span> <span class="number">1</span><span class="string">m30s</span></span><br><span class="line"><span class="attr">    volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"/var/run/docker.sock:/var/run/docker.sock"</span></span><br><span class="line"><span class="attr">    deploy:</span></span><br><span class="line"><span class="attr">      placement:</span></span><br><span class="line"><span class="attr">        constraints:</span> <span class="string">[node.role</span> <span class="string">==</span> <span class="string">manager]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="attr">  db-data:</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line"><span class="attr">  overlay:</span></span><br></pre></td></tr></table></figure>
<p>其中<strong>constraints: [node.role == manager]</strong>是调度策略，文档地址：<a href="https://docs.docker.com/swarm/scheduler/filter/" target="_blank" rel="noopener">https://docs.docker.com/swarm/scheduler/filter/</a></p>
<p>在 Swarm 集群管理节点新建该文件，其中的 visualizer 服务提供一个可视化页面，我们可以从浏览器中很直观的查看集群中各个服务的运行节点。</p>
<p>在 Swarm 集群中使用 docker-compose.yml 我们用<code>docker stack</code>命令，下面我们对该命令进行详细讲解。</p>
<h3 id="部署服务"><a href="#部署服务" class="headerlink" title="部署服务"></a>部署服务</h3><p>部署服务使用<code>docker stack deploy</code>，其中<code>-c</code>参数指定 compose 文件名。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker stack deploy -c docker-compose<span class="selector-class">.yml</span> wordpress</span><br></pre></td></tr></table></figure>
<h3 id="查看服务"><a href="#查看服务" class="headerlink" title="查看服务"></a>查看服务</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="keyword">stack</span> <span class="keyword">ls</span></span><br><span class="line">NAME                SERVICES</span><br><span class="line">wordpress           3</span><br></pre></td></tr></table></figure>
<h3 id="移除服务"><a href="#移除服务" class="headerlink" title="移除服务"></a>移除服务</h3><p>要移除服务，使用<code>docker stack down</code>:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ docker stack down wordpress</span><br><span class="line">Removing<span class="built_in"> service </span>wordpress_db</span><br><span class="line">Removing<span class="built_in"> service </span>wordpress_visualizer</span><br><span class="line">Removing<span class="built_in"> service </span>wordpress_wordpress</span><br><span class="line">Removing<span class="built_in"> network </span>wordpress_overlay</span><br><span class="line">Removing<span class="built_in"> network </span>wordpress_default</span><br></pre></td></tr></table></figure>
<p>该命令不会移除服务所使用的<code>数据卷</code>，如果你想移除数据卷请使用<code>docker volume rm</code>。</p>
<hr>
<p>接下文: <a href="100216.html">Docker基础之 十.图形化管理和监控</a></p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2018/06/100216.html" class="pre-post btn btn-default" title='Docker基础之 十.图形化管理和监控'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">Docker基础之 十.图形化管理和监控</span>
        </a>
    
    
        <a href="/archives/2018/06/100214.html" class="next-post btn btn-default" title='Docker基础之 八.Docker Machine'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">Docker基础之 八.Docker Machine</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#基本概念"><span class="toc-text">基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#节点"><span class="toc-text">节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务和任务"><span class="toc-text">服务和任务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#初始化集群"><span class="toc-text">初始化集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#增加工作节点"><span class="toc-text">增加工作节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查看集群"><span class="toc-text">查看集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#部署服务"><span class="toc-text">部署服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看服务"><span class="toc-text">查看服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#移除服务"><span class="toc-text">移除服务</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2023&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>