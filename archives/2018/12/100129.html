<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="kubernetes,ci,cd,devops">


    <meta name="description" content="接上文: kubernetes CI/CD建设之 七.Gitlab CI与Kubernetes结合

现在结合前面所学的知识点给大家介绍一个完整的示例：使用 Jenkins + Gitlab +...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>kubernetes CI/CD建设之 八.Devops | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx">


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="kubernetes CI/CD建设之 八.Devops">
            
	            kubernetes CI/CD建设之 八.Devops
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/cloud/">云计算</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/cd/">cd</a> <a class="tag-link" href="/tags/ci/">ci</a> <a class="tag-link" href="/tags/devops/">devops</a> <a class="tag-link" href="/tags/kubernetes/">kubernetes</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2018/12/22</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>1887</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <p>接上文: <a href="100062.html">kubernetes CI/CD建设之 七.Gitlab CI与Kubernetes结合</a></p>
<hr>
<p>现在结合前面所学的知识点给大家介绍一个完整的示例：使用 Jenkins + Gitlab + Harbor + Helm + Kubernetes 来实现一个完整的 CI/CD 流水线作业。</p>
<p>其实前面我们就<a href="100126.html">已经学习了 Jenkins Pipeline 与 Kubernetes 的完美结合</a>，我们利用 Kubernetes 来动态运行 Jenkins 的 Slave 节点，可以和好的来解决传统的 Jenkins Slave 浪费大量资源的缺点。之前的示例中我们是将项目放置在 Github 仓库上的，将 Docker 镜像推送到了 Docker Hub，这节课我们来结合我们前面学习的知识点来综合运用下，使用 Jenkins、Gitlab、Harbor、Helm、Kubernetes 来实现一个完整的持续集成和持续部署的流水线作业。</p>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p>下图是我们当前示例的流程图</p>
<div align="center"><img src="/img/posts/2D3KxY.jpg" alt="ci/cd demo"><br>ci/cd demo</div>

<ol>
<li>开发人员提交代码到 Gitlab 代码仓库</li>
<li>通过 Gitlab 配置的 Jenkins Webhook 触发 Pipeline 自动构建</li>
<li>Jenkins 触发构建构建任务，根据 Pipeline 脚本定义分步骤构建</li>
<li>先进行代码静态分析，单元测试</li>
<li>然后进行 Maven 构建（Java 项目）</li>
<li>根据构建结果构建 Docker 镜像</li>
<li>推送 Docker 镜像到 Harbor 仓库</li>
<li>触发更新服务阶段，使用 Helm 安装/更新 Release</li>
<li>查看服务是否更新成功。</li>
</ol>
<h2 id="项目"><a href="#项目" class="headerlink" title="项目"></a>项目</h2><p>本次示例项目是一个完整的基于 Spring Boot、Spring Security、JWT、React 和 Ant Design 构建的一个开源的投票应用，项目地址：<a href="https://github.com/callicoder/spring-security-react-ant-design-polls-app" target="_blank" rel="noopener">https://github.com/callicoder/spring-security-react-ant-design-polls-app</a>。</p>
<div align="center"><img src="/img/posts/NTe3id.jpg" alt="polling app1"><br>polling app1</div>

<p>我们将会在该项目的基础上添加部分代码，并实践 CI/CD 流程。</p>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><p>首先需要更改的是服务端配置，我们需要将数据库链接的配置更改成环境变量的形式，写死了的话就没办法进行定制了，修改服务端文件<code>src/main/resources/application.properties</code>，将下面的数据库配置部分修改成如下形式：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.url</span>= jdbc:mysql://<span class="variable">$&#123;DB_HOST:localhost&#125;</span>:<span class="variable">$&#123;DB_PORT:3306&#125;</span>/<span class="variable">$&#123;DB_NAME:polling_app&#125;</span>?useSSL=<span class="literal">false</span>&amp;serverTimezone=UTC&amp;useLegacyDatetimeCode=<span class="literal">false</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>= <span class="variable">$&#123;DB_USER:root&#125;</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>= <span class="variable">$&#123;DB_PASSWORD:root&#125;</span></span><br></pre></td></tr></table></figure>
<p>当环境变量中有上面的数据配置的时候，就会优先使用环境变量中的值，没有的时候就会用默认的值进行数据库配置。</p>
<p>由于我们要将项目部署到 Kubernetes 集群中去，所以我们需要将服务端进行容器化，所以我们在项目根目录下面添加一个<code>Dockerfile</code>文件进行镜像构建：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span> myhhub &lt;imyhhub@gmail.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> LANG en_US.UTF-<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> LANGUAGE en_US:en</span><br><span class="line"><span class="keyword">ENV</span> LC_ALL en_US.UTF-<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> target/polls-0.0.1-SNAPSHOT.jar /app/polls.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"java"</span>, <span class="string">"-Djava.security.egd=file:/dev/./urandom"</span>, <span class="string">"-jar"</span>,<span class="string">"/app/polls.jar"</span>]</span></span><br></pre></td></tr></table></figure>
<p>由于服务端代码是基于<code>Spring Boot</code>构建的，所以我们这里使用一个<code>openjdk</code>的基础镜像，将打包过后的<code>jar</code>包放入镜像之中，然后用过<code>java -jar</code>命令直接启动即可，这里就会存在一个问题了，我们是在 Jenkins 的 Pipeline 中去进行镜像构建的，这个时候项目中并没有打包好的<code>jar</code>包文件，那么我们应该如何获取打包好的<code>jar</code>包文件呢？这里我们可以使用两种方法：</p>
<p>第一种就是如果你用于镜像打包的 Docker 版本大于<code>17.06</code>版本的话，那么我墙裂推荐你使用 Docker 的多阶段构建功能来完成镜像的打包过程，我们只需要将上面的<code>Dockerfile</code>文件稍微更改下即可，将使用<code>maven</code>进行构建的工作放到同一个文件中：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> maven:<span class="number">3.6</span>-alpine as BUILD</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> src /usr/app/src</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> pom.xml /usr/app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mvn -f /usr/app/pom.xml clean package -Dmaven.test.skip=<span class="literal">true</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> openjdk:<span class="number">8</span>-jdk-alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span> myhhub &lt;imyhhub@gmail.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> LANG en_US.UTF-<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> LANGUAGE en_US:en</span><br><span class="line"><span class="keyword">ENV</span> LC_ALL en_US.UTF-<span class="number">8</span></span><br><span class="line"><span class="keyword">ENV</span> TZ=Asia/Shanghai</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=BUILD /usr/app/target/polls-0.0.1-SNAPSHOT.jar /app/polls.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"java"</span>, <span class="string">"-Djava.security.egd=file:/dev/./urandom"</span>, <span class="string">"-jar"</span>,<span class="string">"/app/polls.jar"</span>]</span></span><br></pre></td></tr></table></figure>
<p>前面课程中我们就讲解过 Docker 的多阶段构建，这里我们定义了两个阶段，第一个阶段利用<code>maven:3.6-alpine</code>这个基础镜像将我们的项目进行打包，然后将该阶段打包生成的<code>jar</code>包文件复制到第二阶段进行最后的镜像打包，这样就可以很好的完成我们的 Docker 镜像的构建工作。</p>
<p>第二种方式就是我们传统的方式，在 Jenkins Pipeline 中添加一个<code>maven</code>构建的阶段，然后在第二个 Docker 构建的阶段就可以直接获取到前面的<code>jar</code>包了，也可以很方便的完成镜像的构建工作，为了更加清楚的说明 Jenkins Pipeline 的用法，我们这里采用这种方式，所以 Dockerfile 文件还是使用第一个就行。</p>
<p>现在我们可以将服务端的代码推送到 Gitlab 上去，我们这里的仓库地址为：<a href="http://git.ljjyy.com/course/polling-app-server.git" target="_blank" rel="noopener">http://git.ljjyy.com/course/polling-app-server.git</a></p>
<blockquote>
<p>注意，这里我们只推送的服务端代码。</p>
</blockquote>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>客户端我们需要修改 API 的链接地址，修改文件<code>src/constants/index.js</code>中<code>API_BASE_URL</code>的地址，我们同样通过环境变量来进行区分，如果有环境变量<code>APISERVER_URL</code>，则优先使用这个环境变量来作为 API 请求的地址：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> API_URL = <span class="string">'http://localhost:8080/api'</span>;</span><br><span class="line"><span class="keyword">if</span> (process.env.APISERVER_URL) &#123;</span><br><span class="line">    API_URL = <span class="string">`<span class="subst">$&#123;process.env.APISERVER_URL&#125;</span>/api`</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> API_BASE_URL = API_URL;</span><br></pre></td></tr></table></figure>
<p>因为我们这里的项目使用的就是前后端分离的架构，所以我们同样需要将前端代码进行单独的部署，同样我们要将项目部署到 Kubernetes 环境中，所以也需要做容器化，同样在项目根目录下面添加一个<code>Dockerfile</code>文件：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nginx:<span class="number">1.15</span>.<span class="number">10</span>-alpine</span><br><span class="line">ADD build <span class="regexp">/usr/</span>share<span class="regexp">/nginx/</span>html</span><br><span class="line"></span><br><span class="line">ADD nginx.conf</span><br><span class="line"><span class="regexp">/etc/</span>nginx<span class="regexp">/conf.d/</span><span class="keyword">default</span>.conf</span><br></pre></td></tr></table></figure>
<p>由于前端页面是单纯的静态页面，所以一般我们使用一个<code>nginx</code>镜像来运行，所以我们提供一个<code>nginx.conf</code>配置文件：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">root</span>   /usr/share/nginx/html;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">try_files</span> <span class="variable">$uri</span> /index.html;</span><br><span class="line">        <span class="attribute">expires</span> <span class="number">1h</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">    <span class="attribute">location</span> = /50x.html &#123;</span><br><span class="line">        <span class="attribute">root</span>   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们可以看到我们需要将前面页面打包到一个<code>build</code>目录，然后将改目录添加到 nginx 镜像中的<code>/usr/share/nginx/html</code>目录，这样当 nginx 镜像启动的时候就是直接使用的改文件夹下面的文件。</p>
<p>所以现在我们需要获取打包后的目录<code>build</code>，同样的，和上面服务端项目一样，我们可以使用两种方式来完成这个工作。</p>
<p>第一种方式自然是推荐的 Docker 的多阶段构建，我们在一个<code>node</code>镜像的环境中就可以打包我们的前端项目了，所以我们可以更改下<code>Dockerfile</code>文件，先进行 node 打包，然后再进行 nginx 启动：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:alpine as BUILD</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /usr/src/app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /usr/src/app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> . /usr/src/app</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> npm install &amp;&amp; \</span></span><br><span class="line"><span class="bash">    npm run build</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> nginx:<span class="number">1.15</span>.<span class="number">10</span>-alpine</span><br><span class="line"><span class="keyword">MAINTAINER</span> myhhub &lt;imyhhub@gmail.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --from=BUILD /usr/src/app/build /usr/share/nginx/html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> nginx.conf</span></span><br><span class="line">/etc/nginx/conf.d/default.conf</span><br></pre></td></tr></table></figure>
<p>第二种方式和上面一样在 Jenkins Pipeline 中添加一个打包构建的阶段即可，我们这里采用这种方式，所以 Dockerfile 文件还是使用第一个就行。</p>
<p>现在我们可以将客户端的代码推送到 Gitlab 上去，我们这里的仓库地址为：<a href="http://git.ljjyy.com/course/polling-app-client.git" target="_blank" rel="noopener">http://git.ljjyy.com/course/polling-app-client.git</a></p>
<h2 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h2><p>现在项目准备好了，接下来我们可以开始 Jenkins 的配置，还记得前面在 Pipeline 结合 Kubernetes 的课程中我们使用了一个<code>kubernetes</code>的 Jenkins 插件，但是之前使用的方式有一些不妥的地方，我们 Jenkins Pipeline 构建任务绑定到了一个固定的 Slave Pod 上面，这样就需要我们的 Slave Pod 中必须包含一系列构建所需要的依赖，比如 docker、maven、node、java 等等，这样就难免需要我们自己定义一个很庞大的 Slave 镜像，我们直接直接在 Pipeline 中去自定义 Slave Pod 中所需要用到的容器模板，这样我们需要什么镜像只需要在 Slave Pod Template 中声明即可，完全不需要去定义一个庞大的 Slave 镜像了。</p>
<p>首先去掉 Jenkins 中 kubernetes 插件中的 Pod Template 的定义，Jenkins -&gt; 系统管理 -&gt; 系统设置 -&gt; 云 -&gt; Kubernetes区域，删除下方的<code>Kubernetes Pod Template</code> -&gt; 保存。</p>
<div align="center"><img src="/img/posts/2iNvFm.jpg" alt="jenkins kubernetes plugin"><br>jenkins kubernetes plugin</div>

<p>然后新建一个名为<code>polling-app-server</code>类型为<code>流水线(Pipeline)</code>的任务：</p>
<div align="center"><img src="/img/posts/PVHJXH.jpg" alt="new pipeline task"><br>new pipeline task</div>

<p>然后在这里需要勾选<code>触发远程构建</code>的触发器，其中令牌我们可以随便写一个字符串，然后记住下面的 URL，将 JENKINS_URL 替换成 Jenkins 的地址,我们这里的地址就是：<code>http://jenkins.ljjyy.com/job/polling-app-server/build?token=server321</code></p>
<div align="center"><img src="/img/posts/pajeby.jpg" alt="trigger"><br>trigger</div>

<p>然后在下面的<code>流水线</code>区域我们可以选择<code>Pipeline script</code>然后在下面测试流水线脚本，我们这里选择<code>Pipeline script from SCM</code>，意思就是从代码仓库中通过<code>Jenkinsfile</code>文件获取<code>Pipeline script</code>脚本定义，然后选择 SCM 来源为<code>Git</code>，在出现的列表中配置上仓库地址<code>http://git.ljjyy.com/course/polling-app-server.git</code>，由于我们是在一个 Slave Pod 中去进行构建，所以如果使用 SSH 的方式去访问 Gitlab 代码仓库的话就需要频繁的去更新 SSH-KEY，所以我们这里采用直接使用用户名和密码的形式来方式：</p>
<div align="center"><img src="/img/posts/ecnRly.jpg" alt="pipeline scm"><br>pipeline scm</div>

<p>在<code>Credentials</code>区域点击<code>添加</code>按钮添加我们访问 Gitlab 的用户名和密码：</p>
<div align="center"><img src="/img/posts/UwFxro.jpg" alt="gitlab auth"><br>gitlab auth</div>

<p>然后需要我们配置用于构建的分支，如果所有的分支我们都想要进行构建的话，只需要将<code>Branch Specifier</code>区域留空即可，一般情况下不同的环境对应的分支才需要构建，比如 master、develop、test 等，平时开发的 feature 或者 bugfix 的分支没必要频繁构建，我们这里就只配置 master 和 develop 两个分支用户构建：</p>
<div align="center"><img src="/img/posts/itdSlI.jpg" alt="gitlab branch config"><br>gitlab branch config</div>

<p>然后前往 Gitlab 中配置项目<code>polling-app-server</code> Webhook，settings -&gt; Integrations，填写上面得到的 trigger 地址：</p>
<div align="center"><img src="/img/posts/aJTq7E.jpg" alt="webhook"><br>webhook</div>

<p>保存后，可以直接点击<code>Test</code> -&gt; <code>Push Event</code>测试是否可以正常访问 Webhook 地址，这里需要注意的是我们需要配置下 Jenkins 的安全配置，否则这里的触发器没权限访问 Jenkins，系统管理 -&gt; 全局安全配置：取消<code>防止跨站点请求伪造</code>，勾选上<code>匿名用户具有可读权限</code>：</p>
<div align="center"><img src="/img/posts/kaEQZ0.jpg" alt="security config"><br>security config</div>

<p>如果测试出现了<code>Hook executed successfully: HTTP 201</code>则证明 Webhook 配置成功了，否则就需要检查下 Jenkins 的安全配置是否正确了。</p>
<p>配置成功后我们只需要往 Gitlab 仓库推送代码就会触发 Pipeline 构建了。接下来我们直接在服务端代码仓库根目录下面添加<code>Jenkinsfile</code>文件，用于描述流水线构建流程。</p>
<p>首先定义最简单的流程，要注意这里和前面课程的不同之处，这里我们使用<code>podTemplate</code>来定义不同阶段使用的的容器，有哪些阶段呢？</p>
<p>Clone 代码 -&gt; 代码静态分析 -&gt; 单元测试 -&gt; Maven 打包 -&gt; Docker 镜像构建/推送 -&gt; Helm 更新服务。</p>
<p>Clone 代码在默认的 Slave 容器中即可；静态分析和单元测试我们这里直接忽略，有需要这个阶段的同学自己添加上即可；Maven 打包肯定就需要 Maven 的容器了；Docker 镜像构建/推送是不是就需要 Docker 环境了呀；最后的 Helm 更新服务是不是就需要一个有 Helm 的容器环境了，所以我们这里就可以很简单的定义<code>podTemplate</code>了，如下定义：(添加一个<code>kubectl</code>工具用于测试)</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> label = <span class="string">"slave-$&#123;UUID.randomUUID().toString()&#125;"</span></span><br><span class="line"></span><br><span class="line">podTemplate(<span class="string">label:</span> label, <span class="string">containers:</span> [</span><br><span class="line">  containerTemplate(<span class="string">name:</span> <span class="string">'maven'</span>, <span class="string">image:</span> <span class="string">'maven:3.6-alpine'</span>, <span class="string">command:</span> <span class="string">'cat'</span>, <span class="string">ttyEnabled:</span> <span class="literal">true</span>),</span><br><span class="line">  containerTemplate(<span class="string">name:</span> <span class="string">'docker'</span>, <span class="string">image:</span> <span class="string">'docker'</span>, <span class="string">command:</span> <span class="string">'cat'</span>, <span class="string">ttyEnabled:</span> <span class="literal">true</span>),</span><br><span class="line">  containerTemplate(<span class="string">name:</span> <span class="string">'kubectl'</span>, <span class="string">image:</span> <span class="string">'myhhub/kubectl'</span>, <span class="string">command:</span> <span class="string">'cat'</span>, <span class="string">ttyEnabled:</span> <span class="literal">true</span>),</span><br><span class="line">  containerTemplate(<span class="string">name:</span> <span class="string">'helm'</span>, <span class="string">image:</span> <span class="string">'myhhub/helm'</span>, <span class="string">command:</span> <span class="string">'cat'</span>, <span class="string">ttyEnabled:</span> <span class="literal">true</span>)</span><br><span class="line">], <span class="string">volumes:</span> [</span><br><span class="line">  hostPathVolume(<span class="string">mountPath:</span> <span class="string">'/root/.m2'</span>, <span class="string">hostPath:</span> <span class="string">'/var/run/m2'</span>),</span><br><span class="line">  hostPathVolume(<span class="string">mountPath:</span> <span class="string">'/home/jenkins/.kube'</span>, <span class="string">hostPath:</span> <span class="string">'/root/.kube'</span>),</span><br><span class="line">  hostPathVolume(<span class="string">mountPath:</span> <span class="string">'/var/run/docker.sock'</span>, <span class="string">hostPath:</span> <span class="string">'/var/run/docker.sock'</span>)</span><br><span class="line">]) &#123;</span><br><span class="line">  node(label) &#123;</span><br><span class="line">    <span class="keyword">def</span> myRepo = checkout scm</span><br><span class="line">    <span class="keyword">def</span> gitCommit = myRepo.GIT_COMMIT</span><br><span class="line">    <span class="keyword">def</span> gitBranch = myRepo.GIT_BRANCH</span><br><span class="line"></span><br><span class="line">    stage(<span class="string">'单元测试'</span>) &#123;</span><br><span class="line">      echo <span class="string">"测试阶段"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'代码编译打包'</span>) &#123;</span><br><span class="line">      container(<span class="string">'maven'</span>) &#123;</span><br><span class="line">        echo <span class="string">"代码编译打包阶段"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'构建 Docker 镜像'</span>) &#123;</span><br><span class="line">      container(<span class="string">'docker'</span>) &#123;</span><br><span class="line">        echo <span class="string">"构建 Docker 镜像阶段"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'运行 Kubectl'</span>) &#123;</span><br><span class="line">      container(<span class="string">'kubectl'</span>) &#123;</span><br><span class="line">        echo <span class="string">"查看 K8S 集群 Pod 列表"</span></span><br><span class="line">        sh <span class="string">"kubectl get pods"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'运行 Helm'</span>) &#123;</span><br><span class="line">      container(<span class="string">'helm'</span>) &#123;</span><br><span class="line">        echo <span class="string">"查看 Helm Release 列表"</span></span><br><span class="line">        sh <span class="string">"helm list"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这段<code>groovy</code>脚本比较简单，我们需要注意的是<code>volumes</code>区域的定义，将容器中的<code>/root/.m2</code>目录挂载到宿主机上是为了给<code>Maven</code>构建添加缓存的，不然每次构建的时候都需要去重新下载依赖，这样就非常慢了；挂载<code>.kube</code>目录是为了能够让<code>kubectl</code>和<code>helm</code>两个工具可以读取到 Kubernetes 集群的连接信息，不然我们是没办法访问到集群的；最后挂载<code>/var/run/docker.sock</code>文件是为了能够让我们的<code>docker</code>这个容器获取到<code>Docker Daemon</code>的信息的，因为<code>docker</code>这个镜像里面只有客户端的二进制文件，我们需要使用宿主机的<code>Docker Daemon</code>来构建镜像，当然我们也需要在运行 Slave Pod 的节点上拥有访问集群的文件，然后在每个<code>Stage</code>阶段使用特定需要的容器来进行任务的描述即可，所以这几个<code>volumes</code>都是非常重要的</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">volumes:</span> [</span><br><span class="line">  hostPathVolume(<span class="string">mountPath:</span> <span class="string">'/root/.m2'</span>, <span class="string">hostPath:</span> <span class="string">'/var/run/m2'</span>),</span><br><span class="line">  hostPathVolume(<span class="string">mountPath:</span> <span class="string">'/home/jenkins/.kube'</span>, <span class="string">hostPath:</span> <span class="string">'/root/.kube'</span>),</span><br><span class="line">  hostPathVolume(<span class="string">mountPath:</span> <span class="string">'/var/run/docker.sock'</span>, <span class="string">hostPath:</span> <span class="string">'/var/run/docker.sock'</span>)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>另外一个值得注意的就是<code>label</code>标签的定义，我们这里使用 UUID 生成一个随机的字符串，这样可以让 Slave Pod 每次的名称都不一样，而且这样就不会被固定在一个 Pod 上面了，以后有多个构建任务的时候就不会存在等待的情况了，这和我们之前的课程中讲到的固定在一个 label 标签上有所不同。</p>
<p>然后我们将上面的<code>Jenkinsfile</code>文件提交到 Gitlab 代码仓库上：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>git add Jenkinsfile</span><br><span class="line"><span class="variable">$ </span>git commit -m <span class="string">"添加 Jenkinsfile 文件"</span></span><br><span class="line"><span class="variable">$ </span>git push origin master</span><br></pre></td></tr></table></figure>
<p>然后切换到 Jenkins 页面上，正常情况就可以看到我们的流水线任务<code>polling-app-server</code>已经被触发构建了，然后回到我们的 Kubernetes 集群中可以看到多了一个 slave 开头的 Pod，里面有5个容器，就是我们上面 podTemplate 中定义的4个容器，加上一个默认的 jenkins slave 容器，同样的，构建任务完成后，这个 Pod 也会被自动销毁掉：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-ops</span><br><span class="line">NAME                                                      READY     STATUS    RESTARTS   AGE</span><br><span class="line">jenkins<span class="number">-7</span>fbfcc5ddc-xsqmt                                  <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">1</span>d</span><br><span class="line">slave<span class="number">-6e898009</span><span class="number">-62</span>a2<span class="number">-4798</span><span class="number">-948</span>f<span class="number">-9</span>c80c3de419b<span class="number">-0</span>jwml<span class="number">-6</span>t6hb   <span class="number">5</span>/<span class="number">5</span>       Running   <span class="number">0</span>          <span class="number">36</span>s</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>正常可以看到 Jenkins 中的任务构建成功了：</p>
<div align="center"><img src="/img/posts/DVIDeb.jpg" alt="build successfully"><br>build successfully</div>

<p>接下来的工作就是来实现上面具体的 Pipeline 脚本了。</p>
<h2 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h2><p>第一个阶段：单元测试，我们可以在这个阶段是运行一些单元测试或者静态代码分析的脚本，我们这里直接忽略。</p>
<p>第二个阶段：代码编译打包，我们可以看到我们是在一个<code>maven</code>的容器中来执行的，所以我们只需要在该容器中获取到代码，然后在代码目录下面执行 maven 打包命令即可，如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">'代码编译打包'</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    container(<span class="string">'maven'</span>) &#123;</span><br><span class="line">      echo <span class="string">"2. 代码编译打包阶段"</span></span><br><span class="line">      sh <span class="string">"mvn clean package -Dmaven.test.skip=true"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (exc) &#123;</span><br><span class="line">    println <span class="string">"构建失败 - $&#123;currentBuild.fullDisplayName&#125;"</span></span><br><span class="line">    <span class="keyword">throw</span>(exc)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三个阶段：构建 Docker 镜像，要构建 Docker 镜像，就需要提供镜像的名称和 tag，要推送到 Harbor 仓库，就需要提供登录的用户名和密码，所以我们这里使用到了<code>withCredentials</code>方法，在里面可以提供一个<code>credentialsId</code>为<code>dockerhub</code>的认证信息，如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">'构建 Docker 镜像'</span>) &#123;</span><br><span class="line">  withCredentials([[<span class="string">$class:</span> <span class="string">'UsernamePasswordMultiBinding'</span>,</span><br><span class="line"><span class="symbol">    credentialsId:</span> <span class="string">'dockerhub'</span>,</span><br><span class="line"><span class="symbol">    usernameVariable:</span> <span class="string">'DOCKER_HUB_USER'</span>,</span><br><span class="line"><span class="symbol">    passwordVariable:</span> <span class="string">'DOCKER_HUB_PASSWORD'</span>]]) &#123;</span><br><span class="line">      container(<span class="string">'docker'</span>) &#123;</span><br><span class="line">        echo <span class="string">"3. 构建 Docker 镜像阶段"</span></span><br><span class="line">        sh <span class="string">"""</span></span><br><span class="line"><span class="string">          docker login $&#123;dockerRegistryUrl&#125; -u $&#123;DOCKER_HUB_USER&#125; -p $&#123;DOCKER_HUB_PASSWORD&#125;</span></span><br><span class="line"><span class="string">          docker build -t $&#123;image&#125;:$&#123;imageTag&#125; .</span></span><br><span class="line"><span class="string">          docker push $&#123;image&#125;:$&#123;imageTag&#125;</span></span><br><span class="line"><span class="string">          """</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中 ${image} 和 ${imageTag} 我们可以在上面定义成全局变量：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> imageTag = sh(<span class="string">script:</span> <span class="string">"git rev-parse --short HEAD"</span>, <span class="string">returnStdout:</span> <span class="literal">true</span>).trim()</span><br><span class="line"><span class="keyword">def</span> dockerRegistryUrl = <span class="string">"registry.ljjyy.com"</span></span><br><span class="line"><span class="keyword">def</span> imageEndpoint = <span class="string">"course/polling-app-server"</span></span><br><span class="line"><span class="keyword">def</span> image = <span class="string">"$&#123;dockerRegistryUrl&#125;/$&#123;imageEndpoint&#125;"</span></span><br></pre></td></tr></table></figure>
<p>docker 的用户名和密码信息则需要通过<code>凭据</code>来进行添加，进入 jenkins 首页 -&gt; 左侧菜单<code>凭据</code> -&gt; <code>添加凭据</code>，选择用户名和密码类型的，其中 ID 一定要和上面的<code>credentialsId</code>的值保持一致：</p>
<div align="center"><img src="/img/posts/6uXfeq.jpg" alt="add docker hub credential"><br>add docker hub credential</div>

<p>第四个阶段：运行 kubectl 工具，其实在我们当前使用的流水线中是用不到 kubectl 工具的，那么为什么我们这里要使用呢？这还不是因为我们暂时还没有去写应用的 Helm Chart 包吗？所以我们先去用原始的 YAML 文件来编写应用部署的资源清单文件，这也是我们写出 Chart 包前提，因为只有知道了应用如何部署才可能知道 Chart 包如何编写，所以我们先编写应用部署资源清单。</p>
<p>首先当然就是 Deployment 控制器了，如下所示：（k8s.yaml）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">polling-server</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">course</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">polling-server</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    rollingUpdate:</span></span><br><span class="line"><span class="attr">      maxSurge:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      maxUnavailable:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">RollingUpdate</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">polling-server</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">      imagePullSecrets:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">myreg</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - image:</span> <span class="string">&lt;IMAGE&gt;:&lt;IMAGE_TAG&gt;</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">polling-server</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">api</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">DB_HOST</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">DB_PORT</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">"3306"</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">DB_NAME</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">polling_app</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">DB_USER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">polling</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">DB_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">polling321</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">polling-server</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">course</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">polling-server</span></span><br><span class="line"><span class="attr">  type:</span>  <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">api-port</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">    targetPort:</span>  <span class="string">api</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">course</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      restartPolicy:</span> <span class="string">Always</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">        image:</span> <span class="attr">mysql:5.7</span></span><br><span class="line"><span class="attr">        imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">        ports:</span></span><br><span class="line"><span class="attr">        - containerPort:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">          name:</span> <span class="string">dbport</span></span><br><span class="line"><span class="attr">        env:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MYSQL_ROOT_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">rootPassW0rd</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MYSQL_DATABASE</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">polling_app</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MYSQL_USER</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">polling</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">MYSQL_PASSWORD</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">polling321</span></span><br><span class="line"><span class="attr">        volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">db</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">db</span></span><br><span class="line"><span class="attr">        hostPath:</span></span><br><span class="line"><span class="attr">          path:</span> <span class="string">/var/lib/mysql</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">course</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  selector:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">  type:</span>  <span class="string">ClusterIP</span></span><br><span class="line"><span class="attr">  ports:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">dbport</span></span><br><span class="line"><span class="attr">    port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">    targetPort:</span> <span class="string">dbport</span></span><br></pre></td></tr></table></figure>
<p>可以看到我们上面的 YAML 文件中添加使用的镜像是用标签代替的：<code>&lt;IMAGE&gt;:&lt;IMAGE_TAG&gt;</code>，这是因为我们的镜像地址是动态的，下依赖我们在上一个阶段打包出来的镜像地址的，所以我们这里用标签代替，然后将标签替换成真正的值即可，另外为了保证应用的稳定性，我们还在应用中添加了健康检查，所以需要在代码中添加一个健康检查的 Controller：（src/main/java/com/example/polls/controller/StatusController.java）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.polls.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api/_status/healthz"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StatusController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">healthCheck</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"UP"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后就是环境变量了，还记得前面我们更改了资源文件中数据库的配置吗？（src/main/resources/application.properties）因为要尽量通用，我们在部署应用的时候很有可能已经有一个外部的数据库服务了，所以这个时候通过环境变量传入进来即可。另外由于我们这里使用的是私有镜像仓库，所以需要在集群中提前创建一个对应的 Secret 对象：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create<span class="built_in"> secret </span>docker-registry myreg <span class="attribute">--docker-server</span>=registry.ljjyy.com <span class="attribute">--docker-username</span>=DOCKER_USER <span class="attribute">--docker-password</span>=DOCKER_PASSWORD <span class="attribute">--docker-email</span>=DOCKER_EMAIL --namespace course</span><br></pre></td></tr></table></figure>
<p>在代码根目录下面创建一个 manifests 的目录，用来存放上面的资源清单文件，正常来说是不是我们只需要在镜像构建成功后，将上面的 k8s.yaml 文件中的镜像标签替换掉就 OK，所以这一步的动作如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">'运行 Kubectl'</span>) &#123;</span><br><span class="line">  container(<span class="string">'kubectl'</span>) &#123;</span><br><span class="line">    echo <span class="string">"查看 K8S 集群 Pod 列表"</span></span><br><span class="line">    sh <span class="string">"kubectl get pods"</span></span><br><span class="line">    sh <span class="string">"""</span></span><br><span class="line"><span class="string">      sed -i "s/&lt;IMAGE&gt;/$&#123;image&#125;" manifests/k8s.yaml</span></span><br><span class="line"><span class="string">      sed -i "s/&lt;IMAGE_TAG&gt;/$&#123;imageTag&#125;" manifests/k8s.yaml</span></span><br><span class="line"><span class="string">      kubectl apply -f k8s.yaml</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第五阶段：运行 Helm 工具，就是直接使用 Helm 来部署应用了，现在有了上面的基本的资源对象了，要创建 Chart 模板就相对容易了，Chart 模板仓库地址：<a href="https://github.com/myhhub/polling-helm" target="_blank" rel="noopener">https://github.com/myhhub/polling-helm</a>，我们可以根据<code>values.yaml</code>文件来进行自定义安装，模板中我们定义了可以指定使用外部数据库服务或者内部独立的数据库服务，具体的我们可以去看模板中的定义。首先我们可以先使用这个模板在集群中来测试下。首先在集群中 Clone 上面的 Chart 模板：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="keyword">clone</span> <span class="title">https</span>://github.com/myhhub/polling-helm.git</span><br></pre></td></tr></table></figure>
<p>然后我们使用内部的数据库服务，新建一个 custom.yaml 文件来覆盖 values.yaml 文件中的值：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">persistence:</span></span><br><span class="line"><span class="symbol">  enabled:</span> true</span><br><span class="line"><span class="symbol">  persistentVolumeClaim:</span></span><br><span class="line"><span class="symbol">    database:</span></span><br><span class="line"><span class="symbol">      storageClass:</span> <span class="string">"database"</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">database:</span></span><br><span class="line"><span class="symbol">  type:</span> internal</span><br><span class="line"><span class="symbol">  internal:</span></span><br><span class="line"><span class="symbol">    database:</span> <span class="string">"polling"</span></span><br><span class="line">    <span class="meta"># 数据库用户</span></span><br><span class="line"><span class="symbol">    username:</span> <span class="string">"polling"</span></span><br><span class="line">    <span class="meta"># 数据库用户密码</span></span><br><span class="line"><span class="symbol">    password:</span> <span class="string">"polling321"</span></span><br></pre></td></tr></table></figure>
<p>可以看到我们这里使用了一个名为<code>database</code>的 StorgeClass 对象，所以还得创建先创建这个资源对象：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> storage.k8s.io/v1</span><br><span class="line"><span class="symbol">kind:</span> StorageClass</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> database</span><br><span class="line"><span class="symbol">provisioner:</span> fuseim.pri/ifs</span><br></pre></td></tr></table></figure>
<p>然后我们就可以在 Chart 根目录下面安装应用，执行下面的命令：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">$ helm upgrade <span class="comment">--install polling -f custom.yaml . --namespace course</span></span><br><span class="line"><span class="keyword">Release</span> <span class="string">"polling"</span> does <span class="keyword">not</span> exist. Installing it now.</span><br><span class="line"><span class="keyword">NAME</span>:   polling</span><br><span class="line"><span class="keyword">LAST</span> DEPLOYED: Sat May  <span class="number">4</span> <span class="number">23</span>:<span class="number">31</span>:<span class="number">42</span> <span class="number">2019</span></span><br><span class="line">NAMESPACE: course</span><br><span class="line"><span class="keyword">STATUS</span>: DEPLOYED</span><br><span class="line"></span><br><span class="line">RESOURCES:</span><br><span class="line">==&gt; v1/Pod(related)</span><br><span class="line"><span class="keyword">NAME</span>                                  READY  <span class="keyword">STATUS</span>             RESTARTS  AGE</span><br><span class="line">polling-polling-api<span class="number">-6</span>b699478d6-lqwhw  <span class="number">0</span>/<span class="number">1</span>    ContainerCreating  <span class="number">0</span>         <span class="number">0</span>s</span><br><span class="line">polling-polling-ui<span class="number">-587</span>bbfb7b5-xr2ff   <span class="number">0</span>/<span class="number">1</span>    ContainerCreating  <span class="number">0</span>         <span class="number">0</span>s</span><br><span class="line">polling-polling-<span class="keyword">database</span><span class="number">-0</span>            <span class="number">0</span>/<span class="number">1</span>    Pending            <span class="number">0</span>         <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Secret</span><br><span class="line"><span class="keyword">NAME</span>                      <span class="keyword">TYPE</span>    <span class="keyword">DATA</span>  AGE</span><br><span class="line">polling-polling-<span class="keyword">database</span>  <span class="keyword">Opaque</span>  <span class="number">1</span>     <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line">==&gt; v1/Service</span><br><span class="line"><span class="keyword">NAME</span>                      <span class="keyword">TYPE</span>       CLUSTER-IP     <span class="keyword">EXTERNAL</span>-IP  PORT(S)   AGE</span><br><span class="line">polling-polling-api       ClusterIP  <span class="number">10.109</span><span class="number">.19</span><span class="number">.220</span>  &lt;<span class="keyword">none</span>&gt;       <span class="number">8080</span>/TCP  <span class="number">0</span>s</span><br><span class="line">polling-polling-<span class="keyword">database</span>  ClusterIP  <span class="number">10.98</span><span class="number">.136</span><span class="number">.190</span>  &lt;<span class="keyword">none</span>&gt;       <span class="number">3306</span>/TCP  <span class="number">0</span>s</span><br><span class="line">polling-polling-ui        ClusterIP  <span class="number">10.108</span><span class="number">.170</span><span class="number">.43</span>  &lt;<span class="keyword">none</span>&gt;       <span class="number">80</span>/TCP    <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line">==&gt; v1beta2/Deployment</span><br><span class="line"><span class="keyword">NAME</span>                 DESIRED  <span class="keyword">CURRENT</span>  UP-<span class="keyword">TO</span>-<span class="built_in">DATE</span>  AVAILABLE  AGE</span><br><span class="line">polling-polling-api  <span class="number">1</span>        <span class="number">1</span>        <span class="number">1</span>           <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line">polling-polling-ui   <span class="number">1</span>        <span class="number">1</span>        <span class="number">1</span>           <span class="number">0</span>          <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line">==&gt; v1/StatefulSet</span><br><span class="line"><span class="keyword">NAME</span>                      DESIRED  <span class="keyword">CURRENT</span>  AGE</span><br><span class="line">polling-polling-<span class="keyword">database</span>  <span class="number">1</span>        <span class="number">1</span>        <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line">==&gt; v1beta1/Ingress</span><br><span class="line"><span class="keyword">NAME</span>                     <span class="keyword">HOSTS</span>              ADDRESS  PORTS  AGE</span><br><span class="line">polling-polling-ingress  ui.polling.domain  <span class="number">80</span>       <span class="number">0</span>s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTES:</span><br><span class="line"><span class="number">1.</span> <span class="keyword">Get</span> the application <span class="keyword">URL</span> <span class="keyword">by</span> running these commands:</span><br><span class="line">  <span class="keyword">http</span>://ui.polling.domain</span><br><span class="line"></span><br><span class="line">You have <span class="keyword">new</span> mail <span class="keyword">in</span> /<span class="keyword">var</span>/spool/mail/root</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意我们这里安装也是使用的<code>helm upgrade</code>命令，这样有助于安装和更新的时候命令统一。</p>
</blockquote>
<p>安装完成后，查看下 Pod 的运行状态：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n course</span><br><span class="line">NAME                                   READY     STATUS    RESTARTS   AGE</span><br><span class="line">polling-polling-api<span class="number">-6</span>b699478d6-lqwhw   <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">3</span>m</span><br><span class="line">polling-polling-database<span class="number">-0</span>             <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">3</span>m</span><br><span class="line">polling-polling-ui<span class="number">-587</span>bbfb7b5-xr2ff    <span class="number">1</span>/<span class="number">1</span>       Running   <span class="number">0</span>          <span class="number">3</span>m</span><br></pre></td></tr></table></figure>
<p>然后我们可以在本地<code>/etc/hosts</code>里面加上<code>http://ui.polling.domain</code>的的映射，这样我们就可以通过这个域名来访问我们安装的应用了，可以注册、登录、发表投票内容了：</p>
<div align="center"><img src="/img/posts/oblr3.png" alt="polling app"><br>polling app</div>

<p>这样我们就完成了使用 Helm Chart 安装应用的过程，但是现在我们使用的包还是直接使用的 git 仓库中的，平常我们正常安装的时候都是使用的 Chart 仓库中的包，所以我们需要将该 Chart 包上传到一个仓库中去，比较幸运的是我们的 Harbor 也是支持 Helm Chart 包的。我们可以选择手动通过 Harbor 的 Dashboard 将 Chart 包进行上传，也可以通过使用<code>Helm Push</code>插件：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ helm plugin install https://github.com/chartmuseum/helm-<span class="keyword">push</span></span><br><span class="line">Downloading <span class="keyword">and</span> installing helm-<span class="keyword">push</span> v0<span class="meta">.7</span><span class="meta">.1</span> ...</span><br><span class="line"><span class="symbol">https:</span>//github.com/chartmuseum/helm-<span class="keyword">push</span>/releases/download/v0<span class="meta">.7</span><span class="meta">.1</span>/helm-push_0<span class="meta">.7</span>.1_linux_amd64.tar.gz</span><br><span class="line"></span><br><span class="line">Installed plugin: <span class="keyword">push</span></span><br></pre></td></tr></table></figure>
<p>当然我们需要首先将 Harbor 提供的仓库添加到 helm repo 中，由于是私有仓库，所以在添加的时候我们需要添加用户名和密码：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ helm repo <span class="built_in">add</span> course http<span class="variable">s:</span>//registry.ljjyy.<span class="keyword">com</span>/chartrepo/course --username=&lt;harbor用户名&gt; --password=&lt;harbor密码&gt;</span><br><span class="line"><span class="string">"course"</span> <span class="built_in">has</span> been added <span class="keyword">to</span> your repositories</span><br></pre></td></tr></table></figure>
<p>这里的 repo 的地址是<code>&lt;Harbor URL&gt;/chartrepo/&lt;Harbor中项目名称&gt;</code>，Harbor 中每个项目是分开的 repo，如果不提供项目名称，则默认使用<code>library</code>这个项目。</p>
<blockquote>
<p>需要注意的是如果你的 Harbor 是采用的自建的 https 证书，这里就需要提供 ca 证书和私钥文件了，否则会出现证书校验失败的错误<code>x509: certificate signed by unknown authority</code>。我们这里是通过<code>cert-manager</code>为 Harbor 提供的一个信任的 https 证书，所以没有指定 ca 证书相关的参数。</p>
</blockquote>
<p>然后我们将上面的<code>polling-helm</code>这个 Chart 包上传到 Harbor 仓库中去：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ helm <span class="keyword">push </span>polling-helm course</span><br><span class="line"><span class="keyword">Pushing </span>polling-<span class="number">0</span>.<span class="number">1</span>.<span class="number">0</span>.tgz to course...</span><br><span class="line"><span class="symbol">Done.</span></span><br></pre></td></tr></table></figure>
<p>这个时候我们登录的 Harbor 仓库中去，查看 course 这个项目下面的<code>Helm Charts</code>就可以发现多了一个 polling 的应用了：</p>
<div align="center"><img src="/img/posts/96e57.png" alt="helm chart"><br>helm chart</div>

<p>我们也可以在右下角看到有添加仓库和安装 Chart 的相关命令。</p>
<p>到这里 Helm 相关的工作就准备好了。那么我们如何在 Jenkins Pipeline 中去使用 Helm 呢？我们可以回顾下，我们平时的一个 CI/CD 的流程：开发代码 -&gt; 提交代码 -&gt; 触发镜像构建 -&gt; 修改镜像tag -&gt; 推送到镜像仓库中去 -&gt; 然后更改 YAML 文件镜像版本 -&gt; 使用 kubectl 工具更新应用。</p>
<p>现在我们是不是直接使用 Helm 了，就不需要去手动更改 YAML 文件了，也不需要使用 kubectl 工具来更新应用了，而是只需要去覆盖下 helm 中的镜像版本，直接 upgrade 是不是就可以达到应用更新的结果了。我们可以去查看下 chart 包的 values.yaml 文件中关于 api 服务的定义：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">api:</span></span><br><span class="line"><span class="symbol">  image:</span></span><br><span class="line"><span class="symbol">    repository:</span> myhhub/polling-api</span><br><span class="line"><span class="symbol">    tag:</span> <span class="number">0.0</span><span class="number">.7</span></span><br><span class="line"><span class="symbol">    pullPolicy:</span> IfNotPresent</span><br></pre></td></tr></table></figure>
<p>我们是不是只需要将上面关于 api 服务使用的镜像用我们这里 Jenkins 构建后的替换掉就可以了，这样我们更改上面的最后<code>运行 Helm</code>的阶段如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stage(<span class="string">'运行 Helm'</span>) &#123;</span><br><span class="line">  container(<span class="string">'helm'</span>) &#123;</span><br><span class="line">    echo <span class="string">"更新 polling 应用"</span></span><br><span class="line">    sh <span class="string">"""</span></span><br><span class="line"><span class="string">      helm upgrade --install polling polling --set persistence.persistentVolumeClaim.database.storageClass=database --set database.type=internal --set database.internal.database=polling --set database.internal.username=polling --set database.internal.password=polling321 --set api.image.repository=$&#123;image&#125; --set api.image.tag=$&#123;imageTag&#125; --set imagePullSecrets[0].name=myreg --namespace course</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然我们可以将需要更改的值都放入一个 YAML 之中来进行修改，我们这里通过<code>--set</code>来覆盖对应的值，这样整个 API 服务的完整 Jenkinsfile 文件如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> label = <span class="string">"slave-$&#123;UUID.randomUUID().toString()&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> helmLint(String chartDir) &#123;</span><br><span class="line">    println <span class="string">"校验 chart 模板"</span></span><br><span class="line">    sh <span class="string">"helm lint $&#123;chartDir&#125;"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> helmInit() &#123;</span><br><span class="line">  println <span class="string">"初始化 helm client"</span></span><br><span class="line">  sh <span class="string">"helm init --client-only --stable-repo-url https://mirror.azure.cn/kubernetes/charts/"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> helmRepo(Map args) &#123;</span><br><span class="line">  println <span class="string">"添加 course repo"</span></span><br><span class="line">  sh <span class="string">"helm repo add --username $&#123;args.username&#125; --password $&#123;args.password&#125; course https://registry.ljjyy.com/chartrepo/course"</span></span><br><span class="line"></span><br><span class="line">  println <span class="string">"更新 repo"</span></span><br><span class="line">  sh <span class="string">"helm repo update"</span></span><br><span class="line"></span><br><span class="line">  println <span class="string">"获取 Chart 包"</span></span><br><span class="line">  sh <span class="string">"""</span></span><br><span class="line"><span class="string">    helm fetch course/polling</span></span><br><span class="line"><span class="string">    tar -xzvf polling-0.1.0.tgz</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> helmDeploy(Map args) &#123;</span><br><span class="line">    helmInit()</span><br><span class="line">    helmRepo(args)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (args.dry_run) &#123;</span><br><span class="line">        println <span class="string">"Debug 应用"</span></span><br><span class="line">        sh <span class="string">"helm upgrade --dry-run --debug --install $&#123;args.name&#125; $&#123;args.chartDir&#125; --set persistence.persistentVolumeClaim.database.storageClass=database --set api.image.repository=$&#123;args.image&#125; --set api.image.tag=$&#123;args.tag&#125; --set imagePullSecrets[0].name=myreg --namespace=$&#123;args.namespace&#125;"</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        println <span class="string">"部署应用"</span></span><br><span class="line">        sh <span class="string">"helm upgrade --install $&#123;args.name&#125; $&#123;args.chartDir&#125; --set persistence.persistentVolumeClaim.database.storageClass=database --set api.image.repository=$&#123;args.image&#125; --set api.image.tag=$&#123;args.tag&#125; --set imagePullSecrets[0].name=myreg --namespace=$&#123;args.namespace&#125;"</span></span><br><span class="line">        echo <span class="string">"应用 $&#123;args.name&#125; 部署成功. 可以使用 helm status $&#123;args.name&#125; 查看应用状态"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">podTemplate(<span class="string">label:</span> label, <span class="string">containers:</span> [</span><br><span class="line">  containerTemplate(<span class="string">name:</span> <span class="string">'maven'</span>, <span class="string">image:</span> <span class="string">'maven:3.6-alpine'</span>, <span class="string">command:</span> <span class="string">'cat'</span>, <span class="string">ttyEnabled:</span> <span class="literal">true</span>),</span><br><span class="line">  containerTemplate(<span class="string">name:</span> <span class="string">'docker'</span>, <span class="string">image:</span> <span class="string">'docker'</span>, <span class="string">command:</span> <span class="string">'cat'</span>, <span class="string">ttyEnabled:</span> <span class="literal">true</span>),</span><br><span class="line">  containerTemplate(<span class="string">name:</span> <span class="string">'helm'</span>, <span class="string">image:</span> <span class="string">'myhhub/helm'</span>, <span class="string">command:</span> <span class="string">'cat'</span>, <span class="string">ttyEnabled:</span> <span class="literal">true</span>)</span><br><span class="line">], <span class="string">volumes:</span> [</span><br><span class="line">  hostPathVolume(<span class="string">mountPath:</span> <span class="string">'/root/.m2'</span>, <span class="string">hostPath:</span> <span class="string">'/var/run/m2'</span>),</span><br><span class="line">  hostPathVolume(<span class="string">mountPath:</span> <span class="string">'/home/jenkins/.kube'</span>, <span class="string">hostPath:</span> <span class="string">'/root/.kube'</span>),</span><br><span class="line">  hostPathVolume(<span class="string">mountPath:</span> <span class="string">'/var/run/docker.sock'</span>, <span class="string">hostPath:</span> <span class="string">'/var/run/docker.sock'</span>)</span><br><span class="line">]) &#123;</span><br><span class="line">  node(label) &#123;</span><br><span class="line">    <span class="keyword">def</span> myRepo = checkout scm</span><br><span class="line">    <span class="keyword">def</span> gitCommit = myRepo.GIT_COMMIT</span><br><span class="line">    <span class="keyword">def</span> gitBranch = myRepo.GIT_BRANCH</span><br><span class="line">    <span class="keyword">def</span> imageTag = sh(<span class="string">script:</span> <span class="string">"git rev-parse --short HEAD"</span>, <span class="string">returnStdout:</span> <span class="literal">true</span>).trim()</span><br><span class="line">    <span class="keyword">def</span> dockerRegistryUrl = <span class="string">"registry.ljjyy.com"</span></span><br><span class="line">    <span class="keyword">def</span> imageEndpoint = <span class="string">"course/polling-api"</span></span><br><span class="line">    <span class="keyword">def</span> image = <span class="string">"$&#123;dockerRegistryUrl&#125;/$&#123;imageEndpoint&#125;"</span></span><br><span class="line"></span><br><span class="line">    stage(<span class="string">'单元测试'</span>) &#123;</span><br><span class="line">      echo <span class="string">"1.测试阶段"</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'代码编译打包'</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        container(<span class="string">'maven'</span>) &#123;</span><br><span class="line">          echo <span class="string">"2. 代码编译打包阶段"</span></span><br><span class="line">          sh <span class="string">"mvn clean package -Dmaven.test.skip=true"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (exc) &#123;</span><br><span class="line">        println <span class="string">"构建失败 - $&#123;currentBuild.fullDisplayName&#125;"</span></span><br><span class="line">        <span class="keyword">throw</span>(exc)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'构建 Docker 镜像'</span>) &#123;</span><br><span class="line">      withCredentials([[<span class="string">$class:</span> <span class="string">'UsernamePasswordMultiBinding'</span>,</span><br><span class="line"><span class="symbol">        credentialsId:</span> <span class="string">'dockerhub'</span>,</span><br><span class="line"><span class="symbol">        usernameVariable:</span> <span class="string">'DOCKER_HUB_USER'</span>,</span><br><span class="line"><span class="symbol">        passwordVariable:</span> <span class="string">'DOCKER_HUB_PASSWORD'</span>]]) &#123;</span><br><span class="line">          container(<span class="string">'docker'</span>) &#123;</span><br><span class="line">            echo <span class="string">"3. 构建 Docker 镜像阶段"</span></span><br><span class="line">            sh <span class="string">"""</span></span><br><span class="line"><span class="string">              docker login $&#123;dockerRegistryUrl&#125; -u $&#123;DOCKER_HUB_USER&#125; -p $&#123;DOCKER_HUB_PASSWORD&#125;</span></span><br><span class="line"><span class="string">              docker build -t $&#123;image&#125;:$&#123;imageTag&#125; .</span></span><br><span class="line"><span class="string">              docker push $&#123;image&#125;:$&#123;imageTag&#125;</span></span><br><span class="line"><span class="string">              """</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">'运行 Helm'</span>) &#123;</span><br><span class="line">      withCredentials([[<span class="string">$class:</span> <span class="string">'UsernamePasswordMultiBinding'</span>,</span><br><span class="line"><span class="symbol">        credentialsId:</span> <span class="string">'dockerhub'</span>,</span><br><span class="line"><span class="symbol">        usernameVariable:</span> <span class="string">'DOCKER_HUB_USER'</span>,</span><br><span class="line"><span class="symbol">        passwordVariable:</span> <span class="string">'DOCKER_HUB_PASSWORD'</span>]]) &#123;</span><br><span class="line">          container(<span class="string">'helm'</span>) &#123;</span><br><span class="line">            <span class="comment">// todo，可以做分支判断</span></span><br><span class="line">            echo <span class="string">"4. [INFO] 开始 Helm 部署"</span></span><br><span class="line">            helmDeploy(</span><br><span class="line">                <span class="string">dry_run     :</span> <span class="literal">false</span>,</span><br><span class="line">                <span class="string">name        :</span> <span class="string">"polling"</span>,</span><br><span class="line">                <span class="string">chartDir    :</span> <span class="string">"polling"</span>,</span><br><span class="line">                <span class="string">namespace   :</span> <span class="string">"course"</span>,</span><br><span class="line">                <span class="string">tag         :</span> <span class="string">"$&#123;imageTag&#125;"</span>,</span><br><span class="line">                <span class="string">image       :</span> <span class="string">"$&#123;image&#125;"</span>,</span><br><span class="line">                <span class="string">username    :</span> <span class="string">"$&#123;DOCKER_HUB_USER&#125;"</span>,</span><br><span class="line">                <span class="string">password    :</span> <span class="string">"$&#123;DOCKER_HUB_PASSWORD&#125;"</span></span><br><span class="line">            )</span><br><span class="line">            echo <span class="string">"[INFO] Helm 部署应用成功..."</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于我们没有将 chart 包放入到 API 服务的代码仓库中，这是因为我们这里使用的 chart 包涉及到两个应用，一个 API 服务，一个是前端展示的服务，所以我们这里是通过脚本里面去主动获取到 chart 包来进行安装的，如果 chart 包跟随代码仓库一起管理当然就要简单许多了。</p>
<p>现在我们去更新 Jenkinsfile 文件，然后提交到 gitlab 中，然后去观察下 Jenkins 中的构建是否成功，我们重点观察下 Helm 阶段：</p>
<div align="center"><img src="/img/posts/yfilp.png" alt="jenkins helm console"><br>jenkins helm console</div>

<p>当然我们还可以去做一些必要的判断工作，比如根据分支判断是否需要自动部署等等，同样也可以切换到 Blue Occean 界面查看构建结果。</p>
<div align="center"><img src="/img/posts/sq24p.jpg" alt="jenkins blue occean"><br>jenkins blue occean</div>

<p>现在大家可以尝试去修改下代码，然后提交代码到 gitlab 上，观察下 Jenkins 是否能够自动帮我们完成整个 CI/CD 的过程。</p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2018/12/100131.html" class="pre-post btn btn-default" title='通常排查Kubernetes网络故障的方法'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">通常排查Kubernetes网络故障的方法</span>
        </a>
    
    
        <a href="/archives/2018/12/100062.html" class="next-post btn btn-default" title='kubernetes CI/CD建设之 七.Gitlab CI与Kubernetes结合'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">kubernetes CI/CD建设之 七.Gitlab CI与Kubernetes结合</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#流程"><span class="toc-text">流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目"><span class="toc-text">项目</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务端"><span class="toc-text">服务端</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端"><span class="toc-text">客户端</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jenkins"><span class="toc-text">Jenkins</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pipeline"><span class="toc-text">Pipeline</span></a></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2024&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>