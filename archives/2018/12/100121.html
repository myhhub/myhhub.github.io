<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="kubernetes,grafana,安装,监控">


    <meta name="description" content="接上文：kubernetes集群监控之 二.Prometheus Operator 

前面我们使用 Prometheus 采集了 Kubernetes 集群中的一些监控数据指标，我们也尝试使用...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>kubernetes集群监控之 三.Grafana | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx">


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="kubernetes集群监控之 三.Grafana">
            
	            kubernetes集群监控之 三.Grafana
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/cloud/">云计算</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/grafana/">grafana</a> <a class="tag-link" href="/tags/kubernetes/">kubernetes</a> <a class="tag-link" href="/tags/install/">安装</a> <a class="tag-link" href="/tags/monitor/">监控</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2018/12/11</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>2043</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <p>接上文：<a href="100120.html">kubernetes集群监控之 二.Prometheus Operator</a> </p>
<hr>
<p>前面我们使用 Prometheus 采集了 Kubernetes 集群中的一些监控数据指标，我们也尝试使用<code>promQL</code>语句查询出了一些数据，并且在 Prometheus 的 Dashboard 中进行了展示，但是明显可以感觉到 Prometheus 的图表功能相对较弱，所以一般情况下我们会一个第三方的工具来展示这些数据，今天我们要和大家使用到的就是<code>grafana</code>。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>grafana 是一个可视化面板，有着非常漂亮的图表和布局展示，功能齐全的度量仪表盘和图形编辑器，支持 Graphite、zabbix、InfluxDB、Prometheus、OpenTSDB、Elasticsearch 等作为数据源，比 Prometheus 自带的图表展示功能强大太多，更加灵活，有丰富的插件，功能更加强大。</p>
<p>接下来我们就来直接安装，同样的，我们将 grafana 安装到 Kubernetes 集群中，第一步同样是去查看 grafana 的 docker 镜像的介绍，我们可以在 dockerhub 上去搜索，也可以在官网去查看相关资料，镜像地址如下：<a href="https://hub.docker.com/r/grafana/grafana/" target="_blank" rel="noopener">https://hub.docker.com/r/grafana/grafana/</a>，我们可以看到介绍中运行 grafana 容器的命令非常简单：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="builtin-name">run</span> -d <span class="attribute">--name</span>=grafana -p 3000:3000 grafana/grafana</span><br></pre></td></tr></table></figure>
<p>但是还有一个需要注意的是 Changelog 中<code>v5.1.0</code>版本的更新介绍：</p>
<ul>
<li>Major restructuring of the container</li>
<li>Usage of chown removed</li>
<li>File permissions incompatibility with previous versions<ul>
<li>user id changed from 104 to 472</li>
<li>group id changed from 107 to 472</li>
</ul>
</li>
<li>Runs as the grafana user by default (instead of root)</li>
<li>All default volumes removed</li>
</ul>
<p>特别需要注意第3条，userid 和 groupid 都有所变化，所以我们在运行的容器的时候需要注意这个变化。现在我们将这个容器转化成 Kubernetes 中的 Pod：(grafana-deploy.yaml)</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: extensions/v1beta1</span><br><span class="line"><span class="attribute">kind</span>: Deployment</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: grafana</span><br><span class="line">  <span class="attribute">namespace</span>: kube-ops</span><br><span class="line">  <span class="attribute">labels</span>:</span><br><span class="line">    <span class="attribute">app</span>: grafana</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">revisionHistoryLimit</span>: <span class="number">10</span></span><br><span class="line">  <span class="attribute">template</span>:</span><br><span class="line">    <span class="attribute">metadata</span>:</span><br><span class="line">      <span class="attribute">labels</span>:</span><br><span class="line">        <span class="attribute">app</span>: grafana</span><br><span class="line">    <span class="attribute">spec</span>:</span><br><span class="line">      <span class="attribute">containers</span>:</span><br><span class="line">      - <span class="attribute">name</span>: grafana</span><br><span class="line">        <span class="attribute">image</span>: grafana/<span class="attribute">grafana</span>:<span class="number">5.3</span>.<span class="number">4</span></span><br><span class="line">        <span class="attribute">imagePullPolicy</span>: IfNotPresent</span><br><span class="line">        <span class="attribute">ports</span>:</span><br><span class="line">        - <span class="attribute">containerPort</span>: <span class="number">3000</span></span><br><span class="line">          <span class="attribute">name</span>: grafana</span><br><span class="line">        <span class="attribute">env</span>:</span><br><span class="line">        - <span class="attribute">name</span>: GF_SECURITY_ADMIN_USER</span><br><span class="line">          <span class="attribute">value</span>: admin</span><br><span class="line">        - <span class="attribute">name</span>: GF_SECURITY_ADMIN_PASSWORD</span><br><span class="line">          <span class="attribute">value</span>: admin321</span><br><span class="line">        <span class="attribute">readinessProbe</span>:</span><br><span class="line">          <span class="attribute">failureThreshold</span>: <span class="number">10</span></span><br><span class="line">          <span class="attribute">httpGet</span>:</span><br><span class="line">            <span class="attribute">path</span>: /api/health</span><br><span class="line">            <span class="attribute">port</span>: <span class="number">3000</span></span><br><span class="line">            <span class="attribute">scheme</span>: HTTP</span><br><span class="line">          <span class="attribute">initialDelaySeconds</span>: <span class="number">60</span></span><br><span class="line">          <span class="attribute">periodSeconds</span>: <span class="number">10</span></span><br><span class="line">          <span class="attribute">successThreshold</span>: <span class="number">1</span></span><br><span class="line">          <span class="attribute">timeoutSeconds</span>: <span class="number">30</span></span><br><span class="line">        <span class="attribute">livenessProbe</span>:</span><br><span class="line">          <span class="attribute">failureThreshold</span>: <span class="number">3</span></span><br><span class="line">          <span class="attribute">httpGet</span>:</span><br><span class="line">            <span class="attribute">path</span>: /api/health</span><br><span class="line">            <span class="attribute">port</span>: <span class="number">3000</span></span><br><span class="line">            <span class="attribute">scheme</span>: HTTP</span><br><span class="line">          <span class="attribute">periodSeconds</span>: <span class="number">10</span></span><br><span class="line">          <span class="attribute">successThreshold</span>: <span class="number">1</span></span><br><span class="line">          <span class="attribute">timeoutSeconds</span>: <span class="number">1</span></span><br><span class="line">        <span class="attribute">resources</span>:</span><br><span class="line">          <span class="attribute">limits</span>:</span><br><span class="line">            <span class="attribute">cpu</span>: <span class="number">100</span>m</span><br><span class="line">            <span class="attribute">memory</span>: <span class="number">256</span>Mi</span><br><span class="line">          <span class="attribute">requests</span>:</span><br><span class="line">            <span class="attribute">cpu</span>: <span class="number">100</span>m</span><br><span class="line">            <span class="attribute">memory</span>: <span class="number">256</span>Mi</span><br><span class="line">        <span class="attribute">volumeMounts</span>:</span><br><span class="line">        - <span class="attribute">mountPath</span>: /var/lib/grafana</span><br><span class="line">          <span class="attribute">subPath</span>: grafana</span><br><span class="line">          <span class="attribute">name</span>: storage</span><br><span class="line">      <span class="attribute">securityContext</span>:</span><br><span class="line">        <span class="attribute">fsGroup</span>: <span class="number">472</span></span><br><span class="line">        <span class="attribute">runAsUser</span>: <span class="number">472</span></span><br><span class="line">      <span class="attribute">volumes</span>:</span><br><span class="line">      - <span class="attribute">name</span>: storage</span><br><span class="line">        <span class="attribute">persistentVolumeClaim</span>:</span><br><span class="line">          <span class="attribute">claimName</span>: grafana</span><br></pre></td></tr></table></figure>
<p>我们使用了最新的镜像<code>grafana/grafana:5.3.4</code>，然后添加了监控检查、资源声明，另外两个比较重要的环境变量<code>GF_SECURITY_ADMIN_USER</code>和<code>GF_SECURITY_ADMIN_PASSWORD</code>，用来配置 grafana 的管理员用户和密码的，由于 grafana 将 dashboard、插件这些数据保存在<code>/var/lib/grafana</code>这个目录下面的，所以我们这里如果需要做数据持久化的话，就需要针对这个目录进行 volume 挂载声明，其他的和我们之前的 Deployment 没什么区别，由于上面我们刚刚提到的 Changelog 中 grafana 的 userid 和 groupid 有所变化，所以我们这里需要增加一个<code>securityContext</code>的声明来进行声明。</p>
<p>当然如果要使用一个 pvc 对象来持久化数据，我们就需要添加一个可用的 pv 供 pvc 绑定使用：（grafana-volume.yaml）</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  capacity:</span></span><br><span class="line"><span class="attr">    storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line"><span class="attr">  nfs:</span></span><br><span class="line"><span class="attr">    server:</span> <span class="number">10.151</span><span class="number">.30</span><span class="number">.57</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">/data/k8s</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">kube-ops</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">ReadWriteOnce</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">1</span><span class="string">Gi</span></span><br></pre></td></tr></table></figure>
<p>最后，我们需要对外暴露 grafana 这个服务，所以我们需要一个对应的 Service 对象，当然用 NodePort 或者再建立一个 ingress 对象都是可行的：(grafana-svc.yaml)</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: v1</span><br><span class="line"><span class="attribute">kind</span>: Service</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: grafana</span><br><span class="line">  <span class="attribute">namespace</span>: kube-ops</span><br><span class="line">  <span class="attribute">labels</span>:</span><br><span class="line">    <span class="attribute">app</span>: grafana</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">type</span>: NodePort</span><br><span class="line">  <span class="attribute">ports</span>:</span><br><span class="line">    - <span class="attribute">port</span>: <span class="number">3000</span></span><br><span class="line">  <span class="attribute">selector</span>:</span><br><span class="line">    <span class="attribute">app</span>: grafana</span><br></pre></td></tr></table></figure>
<p>现在我们直接创建上面的这些资源对象：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl create -f grafana-volume.yaml</span><br><span class="line">persistentvolume <span class="string">"grafana"</span> created</span><br><span class="line">persistentvolumeclaim <span class="string">"grafana"</span> created</span><br><span class="line">$ kubectl create -f grafana-deploy.yaml</span><br><span class="line">deployment.extensions <span class="string">"grafana"</span> created</span><br><span class="line">$ kubectl create -f grafana-svc.yaml</span><br><span class="line">service <span class="string">"grafana"</span> created</span><br></pre></td></tr></table></figure>
<p>创建完成后，我们可以查看 grafana 对应的 Pod 是否正常：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-ops</span><br><span class="line">NAME                          READY     STATUS             RESTARTS   AGE</span><br><span class="line">grafana<span class="number">-5</span>f7b965b55-wxvvk      <span class="number">0</span>/<span class="number">1</span>       CrashLoopBackOff   <span class="number">1</span>          <span class="number">22</span>s</span><br></pre></td></tr></table></figure>
<p>我们可以看到这里的状态是<code>CrashLoopBackOff</code>，并没有正常启动，我们查看下这个 Pod 的日志：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs -f grafana<span class="number">-5</span>f7b965b55-wxvvk -n kube-ops</span><br><span class="line">GF_PATHS_DATA=<span class="string">'/var/lib/grafana'</span> is <span class="keyword">not</span> writable.</span><br><span class="line">You may have issues <span class="keyword">with</span> <span class="built_in">file</span> permissions, more information here: <span class="keyword">http</span>://docs.grafana.org/installation/docker/<span class="comment">#migration-from-a-previous-version-of-the-docker-container-to-5-1-or-later</span></span><br><span class="line">mkdir: cannot <span class="built_in">create</span> <span class="built_in">directory</span> <span class="string">'/var/lib/grafana/plugins'</span>: Permission denied</span><br></pre></td></tr></table></figure>
<blockquote>
<p>上面的错误是在<code>5.1</code>版本之后才会出现的，当然你也可以使用之前的版本来规避这个问题。</p>
</blockquote>
<p>可以看到是日志中错误很明显就是<code>/var/lib/grafana</code>目录的权限问题，这还是因为5.1版本后 groupid 更改了引起的问题，我们这里增加了<code>securityContext</code>，但是我们将目录<code>/var/lib/grafana</code>挂载到 pvc 这边后目录的拥有者并不是上面的 grafana(472)这个用户了，所以我们需要更改下这个目录的所属用户，这个时候我们可以利用一个 Job 任务去更改下该目录的所属用户：（grafana-chown-job.yaml）</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">apiVersion</span>: batch/v1</span><br><span class="line"><span class="attribute">kind</span>: Job</span><br><span class="line"><span class="attribute">metadata</span>:</span><br><span class="line">  <span class="attribute">name</span>: grafana-chown</span><br><span class="line">  <span class="attribute">namespace</span>: kube-ops</span><br><span class="line"><span class="attribute">spec</span>:</span><br><span class="line">  <span class="attribute">template</span>:</span><br><span class="line">    <span class="attribute">spec</span>:</span><br><span class="line">      <span class="attribute">restartPolicy</span>: Never</span><br><span class="line">      <span class="attribute">containers</span>:</span><br><span class="line">      - <span class="attribute">name</span>: grafana-chown</span><br><span class="line">        <span class="attribute">command</span>: [<span class="string">"chown"</span>, <span class="string">"-R"</span>, <span class="string">"472:472"</span>, <span class="string">"/var/lib/grafana"</span>]</span><br><span class="line">        <span class="attribute">image</span>: busybox</span><br><span class="line">        <span class="attribute">imagePullPolicy</span>: IfNotPresent</span><br><span class="line">        <span class="attribute">volumeMounts</span>:</span><br><span class="line">        - <span class="attribute">name</span>: storage</span><br><span class="line">          <span class="attribute">subPath</span>: grafana</span><br><span class="line">          <span class="attribute">mountPath</span>: /var/lib/grafana</span><br><span class="line">      <span class="attribute">volumes</span>:</span><br><span class="line">      - <span class="attribute">name</span>: storage</span><br><span class="line">        <span class="attribute">persistentVolumeClaim</span>:</span><br><span class="line">          <span class="attribute">claimName</span>: grafana</span><br></pre></td></tr></table></figure>
<p>上面我们利用一个 busybox 镜像将<code>/var/lib/grafana</code>目录更改成了<code>472</code>这个 user 和 group，不过还需要注意的是下面的 volumeMounts 和 volumes 需要和上面的 Deployment 对应上。</p>
<p>现在我们删除之前创建的 Deployment 对象，重新创建：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl delete -f grafana-deploy.yaml</span><br><span class="line">deployment<span class="selector-class">.extensions</span> <span class="string">"grafana"</span> deleted</span><br><span class="line">$ kubectl create -f grafana-deploy.yaml</span><br><span class="line">deployment<span class="selector-class">.extensions</span> <span class="string">"grafana"</span> created</span><br><span class="line">$ kubectl create -f grafana-chown-job.yaml</span><br><span class="line">job<span class="selector-class">.batch</span> <span class="string">"grafana-chown"</span> created</span><br></pre></td></tr></table></figure>
<p>重新执行完成后，可以查看下上面的创建的资源对象是否正确了：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -n kube-ops</span><br><span class="line">NAME                          READY     STATUS      RESTARTS   AGE</span><br><span class="line">grafana<span class="number">-79477</span>fbb7c<span class="number">-2</span>mb84      <span class="number">1</span>/<span class="number">1</span>       Running     <span class="number">0</span>          <span class="number">2</span>m</span><br><span class="line">grafana-chown-k8zt7           <span class="number">0</span>/<span class="number">1</span>       Completed   <span class="number">0</span>          <span class="number">2</span>m</span><br></pre></td></tr></table></figure>
<p>我们可以看到有一个状态为<code>Completed</code>的 Pod，这就是上面我们用来更改 grafana 目录权限的 Pod，是一个 Job 任务，所以执行成功后就退出了，状态变成了<code>Completed</code>，而上面的 grafana 的 Pod 也已经是<code>Running</code>状态了，可以查看下该 Pod 的日志确认下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl logs -f grafana-79477fbb7c-2mb84 -n kube-ops</span><br><span class="line"><span class="attribute">t</span>=2018-11-14T19:57:31+0000 <span class="attribute">lvl</span>=info <span class="attribute">msg</span>=<span class="string">"Starting Grafana"</span> <span class="attribute">logger</span>=server <span class="attribute">version</span>=5.3.4 <span class="attribute">commit</span>=69630b9 <span class="attribute">compiled</span>=2018-11-13T12:19:12+0000</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line"><span class="attribute">logger</span>=settings <span class="attribute">var</span>=<span class="string">"GF_SECURITY_ADMIN_USER=admin"</span></span><br><span class="line"><span class="attribute">t</span>=2018-11-14T19:57:31+0000 <span class="attribute">lvl</span>=info <span class="attribute">msg</span>=<span class="string">"Config overridden from Environment variable"</span></span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span></span><br><span class="line"><span class="attribute">t</span>=2018-11-14T19:57:32+0000 <span class="attribute">lvl</span>=info <span class="attribute">msg</span>=<span class="string">"Initializing Stream Manager"</span></span><br><span class="line"><span class="attribute">t</span>=2018-11-14T19:57:32+0000 <span class="attribute">lvl</span>=info <span class="attribute">msg</span>=<span class="string">"HTTP Server Listen"</span> <span class="attribute">logger</span>=http.server <span class="attribute">address</span>=0.0.0.0:3000 <span class="attribute">protocol</span>=http subUrl= socket=</span><br></pre></td></tr></table></figure>
<p>看到上面的日志信息就证明我们的 grafana 的 Pod 已经正常启动起来了。这个时候我们可以查看 Service 对象：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="builtin-name">get</span> svc -n kube-ops</span><br><span class="line">NAME        <span class="built_in"> TYPE </span>       CLUSTER-IP      EXTERNAL-IP   PORT(S)                          AGE</span><br><span class="line">grafana      NodePort    10.97.46.27     &lt;none&gt;        3000:30105/TCP                   1h</span><br></pre></td></tr></table></figure>
<p>现在我们就可以在浏览器中使用<code>http://&lt;任意节点IP:30105&gt;</code>来访问 grafana 这个服务了： <div align="center"><img src="/img/posts/grafana-login.png" alt="grafana login"></div></p>
<p>由于上面我们配置了管理员的，所以第一次打开的时候会跳转到登录界面，然后就可以用上面我们配置的两个环境变量的值来进行登录了，登录完成后就可以进入到下面 Grafana 的首页： </p>
<div align="center"><img src="/img/posts/grafana-index.png" alt="grafana index"></div>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>在上面的首页中我们可以看到已经安装了 Grafana，接下来点击<code>Add data source</code>进入添加数据源界面。</p>
<h3 id="数据源"><a href="#数据源" class="headerlink" title="数据源"></a>数据源</h3><p>我们这个地方配置的数据源是 Prometheus，所以选择这个 Type 即可，给改数据源添加一个 name：prometheus-ds，最主要的是下面<code>HTTP</code>区域是配置数据源的访问模式。</p>
<p>访问模式是用来控制如何处理对数据源的请求的：</p>
<ul>
<li>服务器(Server)访问模式（默认）：所有请求都将从浏览器发送到 Grafana 后端的服务器，后者又将请求转发到数据源，通过这种方式可以避免一些跨域问题，其实就是在 Grafana 后端做了一次转发，需要从Grafana 后端服务器访问该 URL。</li>
<li>浏览器(Browser)访问模式：所有请求都将从浏览器直接发送到数据源，但是有可能会有一些跨域的限制，使用此访问模式，需要从浏览器直接访问该 URL。</li>
</ul>
<p>由于我们这个地方 Prometheus 通过 NodePort 的方式的对外暴露的服务，所以我们这个地方是不是可以使用浏览器访问模式直接访问 Prometheus 的外网地址，但是这种方式显然不是最好的，相当于走的是外网，而我们这里 Prometheus 和 Grafana 都处于 kube-ops 这同一个 namespace 下面，是不是在集群内部直接通过 DNS 的形式就可以访问了，而且还都是走的内网流量，所以我们这里用服务器访问模式显然更好，数据源地址：<code>http://prometheus:9090</code>（因为在同一个 namespace 下面所以直接用 Service 名也可以），然后其他的配置信息就根据实际情况了，比如 Auth 认证，我们这里没有，所以跳过即可，点击最下方的<code>Save &amp; Test</code>提示成功证明我们的数据源配置正确：</p>
<div align="center"><img src="/img/posts/grafana-prometheus-ds.png" alt="grafana datasource"><br>grafana datasource</div>

<p>数据源添加完成后，就可以来添加 Dashboard 了。</p>
<h3 id="Dashboard"><a href="#Dashboard" class="headerlink" title="Dashboard"></a>Dashboard</h3><p>同样，切换到主页，我们可以根据自己的需求手动新建一个 Dashboard，除此之外，grafana 的官方网站上还有很多公共的 Dashboard 可以供我们使用，我们这里可以使用<a href="https://grafana.com/dashboards/162/revisions" target="_blank" rel="noopener">Kubernetes cluster monitoring (via Prometheus)(dashboard id 为162)</a>这个 Dashboard 来展示 Kubernetes 集群的监控信息，在左侧侧边栏 Create 中点击<code>import</code>导入：</p>
<div align="center"><img src="/img/posts/grafana-dashboard-import.png" alt="grafana import"></div>

<p>我们可以将上面编号<code>162</code>的 dashboard 下载到本地，然后这里重新上传即可，也可以在上面的文本框中直接输入<code>162</code>编号回车即可，导入这个 dashboard： </p>
<div align="center"><img src="/img/posts/grafana-dashboard-import2.png" alt="grafana import2"></div>

<p>需要注意的是在执行上面的 import 之前要记得选择我们的<code>prometheus-ds</code>这个名字的数据源，执行<code>import</code>操作，就可以进入到 dashboard 页面： </p>
<div align="center"><img src="/img/posts/grafana-k8s-monitor.png" alt="grafana k8s cluster monitor"></div>

<p>我们可以看到 dashboard 页面上出现了很多漂亮的图表，但是看上去数据不正常，这是因为这个 dashboard 里面需要的数据指标名称和我们 Prometheus 里面采集到的数据指标不一致造成的，比如，第一个<code>Cluster memory usage(集群内存使用情况)</code>，我们可以点击标题 -&gt; Edit，进入编辑这个图表的编辑页面： </p>
<div align="center"><img src="/img/posts/grafana-dashboard-edit.png" alt="grafana dashboard edit"></div>

<p>进入编辑页面我们就可以看到这个图表的查询语句：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">sum</span>(<span class="name">node_memory_MemTotal</span>) - sum(<span class="name">node_memory_MemFree+node_memory_Buffers+node_memory_Cached</span>) ) / sum(<span class="name">node_memory_MemTotal</span>) * <span class="number">100</span></span><br></pre></td></tr></table></figure>
<div align="center"><img src="/img/posts/grafana-dashboard-edit2.png" alt="grafana dashboard edit2"><br>grafana dashboard edit2</div>

<p>这就是我们之前在 Prometheus 里面查询的<code>promQL</code>语句，我们可以将上面的查询语句复制到 Prometheus 的 Graph 页面进行查询，其实可以预想到是没有对应的数据的，因为我们用<code>node_exporter</code>采集到的数据指标不是<code>node_memory_MemTotal</code>关键字，而是<code>node_memory_MemTotal_bytes</code>，将上面的<code>promQL</code>语句做相应的更改：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">sum</span>(<span class="name">node_memory_MemTotal_bytes</span>) - sum(<span class="name">node_memory_MemFree_bytes</span> + node_memory_Buffers_bytes+node_memory_Cached_bytes)) / sum(<span class="name">node_memory_MemTotal_bytes</span>) * <span class="number">100</span></span><br></pre></td></tr></table></figure>
<p>这个语句的意思就是<code>(整个集群的内存-(整个集群剩余的内存以及Buffer和Cached))/整个集群的内存</code>，简单来说就是总的集群内存使用百分比。将上面 grafana 的<code>promQL</code>语句替换掉，就可以看到图表正常了： </p>
<div align="center"><img src="/img/posts/grafana-table.png" alt="grafana table"></div>

<p>同样的，我们可以更改后面的 CPU 和 FileSystem 的使用率： </p>
<div align="center"><img src="/img/posts/grafana-cluster-table.png" alt="grafana cluster table"></div>

<p>同样下面的<code>Pod CPU Usage</code>用来展示 Pod CPU 的使用情况，对应的<code>promQL</code>语句如下，根据 pod_name 来进行统计：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sum by (<span class="name">pod_name</span>)(<span class="name">rate</span>(<span class="name">container_cpu_usage_seconds_total</span>&#123;image!=<span class="string">""</span>, pod_name!=<span class="string">""</span>&#125;[<span class="number">1</span>m]))</span><br></pre></td></tr></table></figure>
<p>按照上面的方法替换 grafana 中的 dashboard 图表中的查询语句： </p>
<div align="center"><img src="/img/posts/grafana-cpu-usage.png" alt="grafana cpu usage"></div>

<p>其他的也按照我们的实际需求重新编辑下就可以，下图是最终整个 dashboard 的效果图： </p>
<div align="center"><img src="/img/posts/grafana-k8s-cluster-dashboard.png" alt="grafana k8s cluster dashboard"></div>

<p>最后要记得保存这个 dashboard，下面的链接是我修改后的 dashboard json 文件地址，你可以直接下载下来导入到 grafana 当中，当然你也可以根据实际情况进行相应的更改：<a href="https://www.qikqiak.com/k8s-book/docs/files/grafana-k8s-cluster-dashboard.json" target="_blank" rel="noopener">k8s-cluster-grafana-dashboard.json</a>。</p>
<p>除此之外，我们也可以前往 grafana dashboard 的页面去搜索其他的关于 Kubernetes 的监控页面，地址：<a href="https://grafana.com/dashboards" target="_blank" rel="noopener">https://grafana.com/dashboards</a>，比如id 为747和741的这两个 dashboard。</p>
<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><p>上面是我们最常用的 grafana 当中的 dashboard 的功能的使用，然后我们也可以来进行一些其他的系统管理，比如添加用户，为用户添加权限等等，我们也可以安装一些其他插件，比如 grafana 就有一个专门针对 Kubernetes 集群监控的插件：<a href="https://grafana.com/plugins/grafana-kubernetes-app/installation" target="_blank" rel="noopener">grafana-kubernetes-app</a></p>
<p>要安装这个插件，需要到 grafana 的 Pod 里面去执行安装命令：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pods -n kube-ops</span><br><span class="line">NAME                          READY     STATUS      RESTARTS   AGE</span><br><span class="line">grafana-<span class="number">79477</span>fbb7c-v4prs      <span class="number">1</span>/<span class="number">1</span>       Running     <span class="number">0</span>          <span class="number">23</span>m</span><br><span class="line">$ kubectl exec -it grafana-<span class="number">79477</span>fbb7c-v4prs /bin/bash -n kube-ops</span><br><span class="line">grafana@grafana-<span class="number">79477</span>fbb7c-<span class="symbol">v4prs:</span>/usr/share/grafana$ grafana-cli plugins install grafana-kubernetes-app</span><br><span class="line">installing grafana-kubernetes-app @ <span class="number">1.0</span>.<span class="number">1</span></span><br><span class="line">from <span class="symbol">url:</span> <span class="symbol">https:</span>/<span class="regexp">/grafana.com/api</span><span class="regexp">/plugins/grafana</span>-kubernetes-app/versions/<span class="number">1.0</span>.<span class="number">1</span>/download</span><br><span class="line"><span class="symbol">into:</span> /var/<span class="class"><span class="keyword">lib</span>/<span class="title">grafana</span>/<span class="title">plugins</span></span></span><br><span class="line"></span><br><span class="line">✔ Installed grafana-kubernetes-app successfully</span><br><span class="line"></span><br><span class="line">Restart grafana after installing plugins . &lt;service grafana-server restart&gt;</span><br><span class="line"></span><br><span class="line">grafana@grafana-<span class="number">79477</span>fbb7c-<span class="symbol">v4prs:</span>/usr/share/grafana$</span><br></pre></td></tr></table></figure>
<p>安装完成后需要重启 grafana 才会生效，我们这里直接删除 Pod，重建即可，然后回到 grafana 页面中，切换到 plugins 页面可以发现下面多了一个 Kubernetes 的插件，点击进来启用即可，然后点击<code>Next up</code>旁边的链接配置集群 </p>
<div align="center"><img src="/img/posts/grafana-k8s-plugin.png" alt="grafana k8s plugins"></div>

<p>这里我们可以添加一个新的 Kubernetes 集群，这里需要填写集群的访问地址：<code>https://kubernetes.default</code>，然后比较重要的是集群访问的证书，勾选上<code>TLS Client Auth</code>和<code>With CA Cert</code>这两项。 </p>
<div align="center"><img src="/img/posts/grafana-k8s-plugin-config.png" alt="grafana k8s plugin config"></div>

<p>集群访问的证书文件，用我们访问集群的 kubectl 的配置文件中的证书信息(~/.kube/config)即可，其中属性<code>certificate-authority-data</code>、<code>client-certificate-data</code>、<code>client-key-data</code>就对应这 CA 证书、Client 证书、Client 私钥，不过 config 文件里面的内容是<code>base64</code>编码过后的，所以我们这里填写的时候要做<code>base64</code>解码。</p>
<blockquote>
<p>另外需要将解码过后的<code>\n</code>换成换行符，不然认证会失败。</p>
</blockquote>
<p>配置完成后，可以直接点击<code>Deploy</code>(实际上前面的课程中我们都已经部署过相关的资源了)，然后点击<code>Save</code>，就可以获取到集群的监控资源信息了。</p>
<div align="center"><img src="/img/posts/grafana-k8s-plugin2.png" alt="grafana k8s plugins"><br>grafana k8s plugins</div>

<p>可以看到上面展示了整个集群的状态，可以查看上面的一些 Dashboard: </p>
<div align="center"><img src="/img/posts/grafana-k8s-plugin-cluster.png" alt="grafana k8s cluster dashboard"></div>

<h2 id="报警"><a href="#报警" class="headerlink" title="报警"></a>报警</h2><p>grafana 4 版本以上就支持了报警功能，这使得我们利用 grafana 作为监控面板更为完整，因为报警是监控系统中必不可少的环节，grafana 支持很多种形式的报警功能，比如 email、钉钉、slack、webhook 等等，我们这里来测试下 email 和 钉钉。</p>
<h3 id="email-报警"><a href="#email-报警" class="headerlink" title="email 报警"></a>email 报警</h3><p>要启用 email 报警需要在启动配置文件中<code>/etc/grafana/grafan.ini</code>开启 SMTP 服务，我们这里同样利用一个 ConfigMap 资源对象挂载到 grafana Pod 中：（grafana-cm.yaml）</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana-config</span><br><span class="line">  namespace: kube-ops</span><br><span class="line">data:</span><br><span class="line">  grafana.ini: |</span><br><span class="line">    [server]</span><br><span class="line">    <span class="attr">root_url</span> = http://&lt;你grafana的url地址&gt;</span><br><span class="line">    [smtp]</span><br><span class="line">    <span class="attr">enabled</span> = <span class="literal">true</span></span><br><span class="line">    <span class="attr">host</span> = smtp.<span class="number">163</span>.com:<span class="number">25</span></span><br><span class="line">    <span class="attr">user</span> = ych_1024@<span class="number">163</span>.com</span><br><span class="line">    <span class="attr">password</span> = &lt;邮箱密码&gt;</span><br><span class="line">    <span class="attr">skip_verify</span> = <span class="literal">true</span></span><br><span class="line">    <span class="attr">from_address</span> = ych_1024@<span class="number">163</span>.com</span><br><span class="line">    [alerting]</span><br><span class="line">    <span class="attr">enabled</span> = <span class="literal">true</span></span><br><span class="line">    <span class="attr">execute_alerts</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>上面配置了我的 163 邮箱，开启报警功能，当然我们还得将这个 ConfigMap 文件挂载到 Pod 中去：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  volumeMounts:</span><br><span class="line">  - mountPath: <span class="string">"/etc/grafana"</span></span><br><span class="line">    name: config</span><br><span class="line">volumes:</span><br><span class="line">- name: config</span><br><span class="line">  configMap:</span><br><span class="line">    name: grafana-config</span><br></pre></td></tr></table></figure>
<p>创建 ConfigMap 对象，更新 Deployment：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>kubectl create -f grafana-cm.yaml</span><br><span class="line"><span class="variable">$ </span>kubectl apply -f grafana-deploy.yaml</span><br></pre></td></tr></table></figure>
<p>更新完成后，在 grafana 的 webui 中<code>Alert</code>页面测试邮件报警：</p>
<div align="center"><img src="/img/posts/grafana-alert-email.png" alt="grafana email alert"><br>grafana email alert</div>

<p>发送测试后，正常情况下就可以收到测试报警邮件：</p>
<div align="center"><img src="/img/posts/grafana-email-alert.png" alt="grafana alert email"><br>grafana alert email</div>

<h3 id="钉钉报警"><a href="#钉钉报警" class="headerlink" title="钉钉报警"></a>钉钉报警</h3><p>上面我们也说了 grafana 也是支持钉钉报警的，在钉钉群里面添加群机器人，选择最后的自定义机器人：</p>
<div align="center"><img src="/img/posts/grafana-add-dingtalk-robot.png" alt="grafana add dingtalk robot"><br>grafana add dingtalk robot</div>

<p>添加完成后可以得到一个 webhook 的地址，然后将这个 webhook 地址添加到上面 grafana webui 的报警测试页面进行测试，就可以在钉钉群里面收到报警测试信息了：</p>
<div align="center"><img src="/img/posts/grafana-alert-dingtalk-robot.png" alt="grafana dingtalk alert"><br>grafana dingtalk alert</div>

<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><p>目前只有 Graph 支持报警功能，所以我们选择 Graph 相关图表，点击编辑，进入 Graph 编辑页面可以看到有一个 Alert 模块，切换过来创建报警：</p>
<div align="center"><img src="/img/posts/grafana-graph-alert.png" alt="grafana graph alert"><br>grafana graph alert</div>

<p>然后配置相关参数：</p>
<ul>
<li>1、Alert 名称，可以自定义。</li>
<li>2、执行的频率，这里我选择每60s检测一次。</li>
<li>3、判断标准，默认是 avg，这里是下拉框，自己按需求选择。</li>
<li>4、query（A,5m,now），字母A代表选择的metrics 中设置的 sql，也可以选择其它在 metrics中设置的，但这里是单选。<code>5m</code>代表从现在起往之前的五分钟，即<code>5m</code>之前的那个点为时间的起始点，<code>now</code>为时间的结束点，此外这里可以自己手动输入时间。</li>
<li>5、设置的预警临界点，这里手动输入，和6是同样功能，6可以手动移动，两种操作是等同的。</li>
</ul>
<p>然后需要设置报警发送信息，点击侧边的<code>Notifications</code>:</p>
<div align="center"><img src="/img/posts/grafana-graph-notify.png" alt="grafana graph notify"><br>grafana graph notify</div>

<p>其中<code>Send to</code>就是前面我们配置过的发送邮件和钉钉的报警频道的名称。</p>
<p>配置完成后需要保存下这个 graph，否则发送报警可能会失败，然后点击 Alert 区域的<code>Test Rule</code>可以来测试报警规则，然后邮件和钉钉正常来说就可以收到报警信息了。</p>
<p>邮件报警信息：</p>
<div align="center"><img src="/img/posts/grafana-email-alert2.png" alt="grafana test rule email"><br>grafana test rule email</div>

<p>钉钉报警信息：</p>
<div align="center"><img src="/img/posts/grafana-dingtalk-alert2.png" alt="grafana test rule dingtalk"><br>grafana test rule dingtalk</div>

<p>到这里就完成了使用 grafana 来展示 Kubernetes 集群的监控图表信息以及报警配置，但是我们明显可以感觉到 grafana 的优势在于图表的展示，报警功能有点弱，所以一般来说，在生产环境我们不会直接使用 grafana 的报警功能，更多的是使用功能更加强大的 <code>AlertManager</code>。</p>
<hr>
<p>接下文：<a href="100122.html">kubernetes集群监控之 四.AlertManager</a> </p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2018/12/100122.html" class="pre-post btn btn-default" title='kubernetes集群监控之 四.AlertManager'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">kubernetes集群监控之 四.AlertManager</span>
        </a>
    
    
        <a href="/archives/2018/12/100120.html" class="next-post btn btn-default" title='kubernetes集群监控之 二.Prometheus Operator'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">kubernetes集群监控之 二.Prometheus Operator</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装"><span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置"><span class="toc-text">配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据源"><span class="toc-text">数据源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dashboard"><span class="toc-text">Dashboard</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#插件"><span class="toc-text">插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#报警"><span class="toc-text">报警</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#email-报警"><span class="toc-text">email 报警</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#钉钉报警"><span class="toc-text">钉钉报警</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-1"><span class="toc-text">配置</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2024&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>