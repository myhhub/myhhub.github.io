<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="java">


    <meta name="description" content="介绍官网地址： https://github.com/brettwooldridge/HikariCP现在介绍一款非常强大，高效，并且号称“史上最快连接池”，它是一个高速、免费、开源的JAVA连...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>史上最快数据源连接池HikariCP | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx">


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="史上最快数据源连接池HikariCP">
            
	            史上最快数据源连接池HikariCP
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/back/">后端</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/java/">java</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2018/11/05</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>1627</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>官网地址： <a href="https://github.com/brettwooldridge/HikariCP" target="_blank" rel="noopener">https://github.com/brettwooldridge/HikariCP</a><br>现在介绍一款非常强大，高效，并且号称“史上最快连接池”，它是一个高速、免费、开源的JAVA连接池，它的性能几乎是C3P0、DBCP的25倍，十分强悍。spring boot2.0已经将HikariCP做为了默认的数据源链接池，在官网测试中秒杀一切其他数据源，比如commons-dbcp,tomcat,c3po,druid。</p>
<div align="center"><img src="/img/posts/HikariCP-bench-2.6.0.png" alt="入图片描述"></div>



<h2 id="基本设计"><a href="#基本设计" class="headerlink" title="基本设计"></a>基本设计</h2><p>Hikari链接池采用了很多优化来提高并发数，可参考<a href="https://github.com/brettwooldridge/HikariCP/wiki/Down-the-Rabbit-Hole" target="_blank" rel="noopener">这里</a><br>所有数据库链接池都遵守基本的设计规则，实现 javax.sql.DataSource 接口，里面最重要的方法就是 Connection getConnection() throws SQLException; 用于获取一个Connection， 一个Connection就是一个数据库链接，就是一个TCP链接，建立TCP链接是需要进行3次握手的，这降低来链接的使用效率，也是各种数据库链接池存在的原因。</p>
<p>数据库链接池通过事先建立好Connection并缓存起来，这样应用需要做数据查询的时候，直接从缓存中拿到Connection就可以使用来。数据库链接池还能够检测异常的链接，释放闲置的链接。</p>
<h2 id="HikariDataSource"><a href="#HikariDataSource" class="headerlink" title="HikariDataSource"></a>HikariDataSource</h2><p>Hikari中提供的DataSource是HikariDataSource ，HikariDataSource 实现了 HikariConfig，和数据库的各种参数超时时间配置就正HikariaConfig中。</p>
<p>其中提供两种初始化方式，一种是默认的构造函数，单new一个HikariDataSource时，数据源的链接不会建立，需要等到第一次调用HikariDataSource的getConnection方法。数据源建立后的相关信息保存在 HikariDataSource 中变量HikariPool pool。</p>
<p>另一种建立方式是调用带有HikariConfig的构造函数，这种方式适合多个数据源的建立，共享同一份配置。 这种方式在调用构造函数的时候就建立了数据源的链接。</p>
<p>HikariDataSource的所有数据源获取都委托给了HikariPool，一个数据源会有一个HikariPool，一个HikariPool中有一个ConcurrentBag，一个ConcurrentBag中多个PoolEntry，一个PoolEntry对应一个Connection。</p>
<h2 id="HikariPool"><a href="#HikariPool" class="headerlink" title="HikariPool"></a>HikariPool</h2><p>HikariPool中的基本field介绍。</p>
<p>PoolEntryCreator POOL_ENTRY_CREATOR：用于创建PoolEntry，也就是用于创建Connection了，创建Connection是委托给驱动程序的。</p>
<p>Collection<runnable> addConnectionQueue ：就是一个LinkedBlockingQueue，不过不能修改其中的内容。当正在创建底层Connection的时候这个Queue会有值。用户后续判断当前线程池里面还是否需要创建新的链接。</runnable></p>
<p>ThreadPoolExecutor addConnectionExecutor：创建Connection链接的执行是有这个线程池调度的。使用新的链接池不会而不使用当前的工作线程，为了不影响工作线程的执行（比如会导致工作线程超时）。</p>
<p>ThreadPoolExecutor closeConnectionExecutor：关闭Connection的链接是有这个线程池调度的。</p>
<p>ConcurrentBag<poolentry> connectionBag：这个是最重要的，每次获取Connection都是从这里面获取，采用了ThreadLocal来减少竞争。</poolentry></p>
<p>ProxyLeakTaskFactory leakTaskFactory；参考ProxyLeakTask用于检测Connection泄漏。</p>
<p>ScheduledFuture&lt;?&gt; houseKeeperTask：用于管理链接池里面的链接，比如链接不够用了要创建链接，链接最大生存时间到了要关闭链接。线程池中的Connection就是有它初始化的。</p>
<h2 id="ConcurrentBag"><a href="#ConcurrentBag" class="headerlink" title="ConcurrentBag"></a>ConcurrentBag</h2><p>ConcurrentBag设计主要为了解决并发对资源的争用，其中主要有CopyOnWriteArrayList<t> sharedList和ThreadLocal&lt;List<object>&gt; threadList，SynchronousQueue<t> handoffQueue，当一个线程获取链接的时候首先从自己的ThreadLocal中的threadList获取，当获取失败的时候才从sharedList获取，当从sharedList获取还是失败的话，就等待在 handoffQueue，这是一个同步的Queue，当其他线程释放链接的时候，自己就会被唤醒。</t></object></t></p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T borrow(<span class="keyword">long</span> timeout, <span class="keyword">final</span> TimeUnit timeUnit) <span class="keyword">throws</span> InterruptedException</span><br><span class="line">  &#123;</span><br><span class="line">     <span class="comment">// 从threadList获取链接</span></span><br><span class="line">     <span class="keyword">final</span> List&lt;<span class="keyword">Object</span>&gt; list = threadList.<span class="built_in">get</span>();</span><br><span class="line">     <span class="keyword">for</span> (<span class="built_in">int</span> i = list.<span class="built_in">size</span>() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">Object</span> entry = list.remove(i);</span><br><span class="line">        <span class="keyword">final</span> T bagEntry = weakThreadLocals ? ((WeakReference&lt;T&gt;) entry).<span class="built_in">get</span>() : (T) entry;</span><br><span class="line">        <span class="keyword">if</span> (bagEntry != <span class="keyword">null</span> &amp;&amp; bagEntry.compareAndSet(STATE_NOT_IN_USE, STATE_IN_USE)) &#123;</span><br><span class="line">           <span class="keyword">return</span> bagEntry;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// 从sharedList获取链接</span></span><br><span class="line">     <span class="keyword">final</span> <span class="built_in">int</span> waiting = waiters.incrementAndGet();</span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (T bagEntry : sharedList) &#123;</span><br><span class="line">           <span class="keyword">if</span> (bagEntry.compareAndSet(STATE_NOT_IN_USE, STATE_IN_USE)) &#123;</span><br><span class="line">              <span class="comment">// If we may have stolen another waiter's connection, request another bag add.</span></span><br><span class="line">              <span class="keyword">if</span> (waiting &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                 listener.addBagItem(waiting - <span class="number">1</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">return</span> bagEntry;</span><br><span class="line">           &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        listener.addBagItem(waiting);</span><br><span class="line">        timeout = timeUnit.toNanos(timeout);</span><br><span class="line">        do &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">long</span> start = currentTime();</span><br><span class="line">           <span class="comment">//等待其他线程释放链接，超过timeout就获取失败了</span></span><br><span class="line">           <span class="keyword">final</span> T bagEntry = handoffQueue.poll(timeout, NANOSECONDS);</span><br><span class="line">           <span class="keyword">if</span> (bagEntry == <span class="keyword">null</span> || bagEntry.compareAndSet(STATE_NOT_IN_USE, STATE_IN_USE)) &#123;</span><br><span class="line">              <span class="keyword">return</span> bagEntry;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           timeout -= elapsedNanos(start);</span><br><span class="line">        &#125; <span class="keyword">while</span> (timeout &gt; <span class="number">10</span>_000);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">finally</span> &#123;</span><br><span class="line">        waiters.decrementAndGet();</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="详细配置"><a href="#详细配置" class="headerlink" title="详细配置"></a>详细配置</h2><p>原版英文详细配置查看<a href="https://github.com/brettwooldridge/HikariCP" target="_blank" rel="noopener">这里</a></p>
<style>
table th:first-of-type {
    width: 20%;
}
table th:nth-of-type(2) {
    width: 18%;
}
table th:nth-of-type(3) {
    width: 12%;
}
</style>


<p>springboot的HikariDataSource默认配置的默认值如下</p>
<table>
<thead>
<tr>
<th>name</th>
<th>构造器默认值</th>
<th>默认配置validate之后的值</th>
<th>validate重置</th>
</tr>
</thead>
<tbody>
<tr>
<td>minIdle</td>
<td>-1</td>
<td>10</td>
<td>minIdle&lt;0或者minIdle&gt;maxPoolSize,则被重置为maxPoolSize</td>
</tr>
<tr>
<td>maxPoolSize</td>
<td>-1</td>
<td>10</td>
<td>如果maxPoolSize小于1，则会被重置。当minIdle&lt;=0被重置为DEFAULT_POOL_SIZE则为10;如果minIdle&gt;0则重置为minIdle的值</td>
</tr>
<tr>
<td>maxLifetime</td>
<td>MINUTES.toMillis(30) = 1800000</td>
<td>1800000</td>
<td>如果不等于0且小于30秒则会被重置回30分钟</td>
</tr>
<tr>
<td>connectionTimeout</td>
<td>SECONDS.toMillis(30) = 30000</td>
<td>30000</td>
<td>如果小于250毫秒，则被重置回30秒</td>
</tr>
<tr>
<td>validationTimeout</td>
<td>SECONDS.toMillis(5) = 5000</td>
<td>5000</td>
<td>如果小于250毫秒，则会被重置回5秒</td>
</tr>
<tr>
<td>loginTimeout</td>
<td>10</td>
<td>30</td>
<td>Math.max(1, (int) MILLISECONDS.toSeconds(500L + connectionTimeout))，为connectionTimeout+500ms转为秒数取整 与 1 取最大者</td>
</tr>
<tr>
<td>idleTimeout</td>
<td>MINUTES.toMillis(10) = 600000</td>
<td>600000</td>
<td>如果idleTimeout+1秒&gt;maxLifetime 且 maxLifetime&gt;0，则会被重置为0；如果idleTimeout!=0且小于10秒，则会被重置为10秒</td>
</tr>
<tr>
<td>leakDetectionThreshold</td>
<td>0</td>
<td>0</td>
<td>如果大于0且不是单元测试，则进一步判断：(leakDetectionThreshold &lt; SECONDS.toMillis(2) or (leakDetectionThreshold &gt; maxLifetime &amp;&amp; maxLifetime &gt; 0)，会被重置为0 . 即如果要生效则必须&gt;0，而且不能小于2秒，而且当maxLifetime &gt; 0时不能大于maxLifetime</td>
</tr>
<tr>
<td>initializationFailTimeout</td>
<td>1</td>
<td>1</td>
<td>-</td>
</tr>
<tr>
<td>isAutoCommit</td>
<td>true</td>
<td>true</td>
<td>-</td>
</tr>
<tr>
<td>isReadOnly</td>
<td>false</td>
<td>fasle</td>
<td>-</td>
</tr>
<tr>
<td>isAllowPoolSuspension</td>
<td>false</td>
<td>false</td>
<td>-</td>
</tr>
<tr>
<td>isIsolateInternalQueries</td>
<td>false</td>
<td>false</td>
<td>-</td>
</tr>
<tr>
<td>isRegisterMbeans</td>
<td>false</td>
<td>false</td>
<td>-</td>
</tr>
<tr>
<td>sealed</td>
<td>false</td>
<td>true</td>
<td>运行启动后这个标志为true，表示不再运行修改</td>
</tr>
<tr>
<td>poolName</td>
<td>null</td>
<td>HikariPool-1</td>
<td>-</td>
</tr>
<tr>
<td>catalog</td>
<td>null</td>
<td>null</td>
<td>-</td>
</tr>
<tr>
<td>connectionInitSql</td>
<td>null</td>
<td>null</td>
<td>-</td>
</tr>
<tr>
<td>connectionTestQuery</td>
<td>null</td>
<td>null</td>
<td>-</td>
</tr>
<tr>
<td>dataSourceClassName</td>
<td>null</td>
<td>null</td>
<td>-</td>
</tr>
<tr>
<td>schema</td>
<td>null</td>
<td>null</td>
<td>-</td>
</tr>
<tr>
<td>transactionIsolationName</td>
<td>null</td>
<td>null</td>
<td>-</td>
</tr>
<tr>
<td>dataSource</td>
<td>null</td>
<td>null</td>
<td>-</td>
</tr>
<tr>
<td>dataSourceProperties</td>
<td>{}</td>
<td>{}</td>
<td>-</td>
</tr>
<tr>
<td>threadFactory</td>
<td>null</td>
<td>null</td>
<td>-</td>
</tr>
<tr>
<td>scheduledExecutor</td>
<td>null</td>
<td>null</td>
<td>-</td>
</tr>
<tr>
<td>metricsTrackerFactory</td>
<td>null</td>
<td>null</td>
<td>-</td>
</tr>
<tr>
<td>metricRegistry</td>
<td>null</td>
<td>null</td>
<td>-</td>
</tr>
<tr>
<td>healthCheckRegistry</td>
<td>null</td>
<td>null</td>
<td>-</td>
</tr>
<tr>
<td>healthCheckProperties</td>
<td>{}</td>
<td>{}</td>
<td>-</td>
</tr>
</tbody>
</table>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 数据库配置</span></span><br><span class="line"><span class="attr">spring.datasource.type</span>=com.zaxxer.hikari.HikariDataSource</span><br><span class="line"><span class="attr">spring.datasource.driverClassName</span> = com.mysql.jdbc.Driver</span><br><span class="line"><span class="attr">spring.datasource.url</span> = jdbc:mysql://localhost:<span class="number">3306</span>/ssm?useUnicode=<span class="literal">true</span>&amp;characterEncoding=utf-<span class="number">8</span>&amp;useSSL=<span class="literal">false</span></span><br><span class="line"><span class="attr">spring.datasource.username</span> = root</span><br><span class="line"><span class="attr">spring.datasource.password</span> = root</span><br><span class="line"><span class="comment">##  Hikari 连接池配置 ------ 详细配置请访问：https://github.com/brettwooldridge/HikariCP</span></span><br><span class="line"><span class="comment">## 最小空闲连接数量</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.minimum-idle</span>=<span class="number">5</span></span><br><span class="line"><span class="comment">## 空闲连接存活最大时间，默认600000（10分钟）</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.idle-timeout</span>=<span class="number">180000</span></span><br><span class="line"><span class="comment">## 连接池最大连接数，默认是10</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.maximum-pool-size</span>=<span class="number">10</span></span><br><span class="line"><span class="comment">## 此属性控制从池返回的连接的默认自动提交行为,默认值：true</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.auto-commit</span>=<span class="literal">true</span></span><br><span class="line"><span class="comment">## 连接池母子</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.pool-name</span>=MyHikariCP</span><br><span class="line"><span class="comment">## 此属性控制池中连接的最长生命周期，值0表示无限生命周期，默认1800000即30分钟</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.max-lifetime</span>=<span class="number">1800000</span></span><br><span class="line"><span class="comment">## 数据库连接超时时间,默认30秒，即30000</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.connection-timeout</span>=<span class="number">30000</span></span><br><span class="line"><span class="attr">spring.datasource.hikari.connection-test-query</span>=SELECT <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h2 id="配置多数据源"><a href="#配置多数据源" class="headerlink" title="配置多数据源"></a>配置多数据源</h2><p>application.yml :<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">hikari</span>:</span><br><span class="line">    <span class="attribute">primary</span>:</span><br><span class="line">        <span class="attribute">jdbc-url</span>: <span class="attribute">jdbc</span>:<span class="attribute">mysql</span>:<span class="comment">//localhost:3306/xu?useSSL=false</span></span><br><span class="line">        <span class="attribute">username</span>: root</span><br><span class="line">        <span class="attribute">password</span>: <span class="number">1234</span></span><br><span class="line">    <span class="attribute">second</span>:</span><br><span class="line">        <span class="attribute">jdbc-url</span>: <span class="attribute">jdbc</span>:<span class="attribute">mysql</span>:<span class="comment">//localhost:3306/hua?useSSL=false</span></span><br><span class="line">        <span class="attribute">username</span>: root</span><br><span class="line">        <span class="attribute">password</span>: <span class="number">1234</span></span><br></pre></td></tr></table></figure></p>
<p>PrimaryDatasourceConfig:<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(basePackages = PrimaryDatasourceConfig.PACKAGE,sqlSessionFactoryRef = <span class="meta-string">"primarySqlSessionFactory"</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrimaryDatasourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    static <span class="keyword">final</span> String PACKAGE = <span class="string">"com.xu.scaffold.repository.primary"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="meta-string">"primaryDataSource"</span>)</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = <span class="meta-string">"hikari.primary"</span>)</span></span><br><span class="line">    <span class="keyword">public</span> HikariDataSource dataSource() &#123;</span><br><span class="line">        <span class="keyword">return</span> new HikariDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="meta-string">"primaryTransactionManager"</span>)</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceTransactionManager transactionManager() &#123;</span><br><span class="line">        <span class="keyword">return</span> new DataSourceTransactionManager(<span class="keyword">this</span>.dataSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="meta-string">"primarySqlSessionFactory"</span>)</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactory sqlSessionFactory(<span class="meta">@Qualifier(<span class="meta-string">"primaryDataSource"</span>)</span> DataSource dataSource) throws Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> SqlSessionFactoryBean sessionFactory = new SqlSessionFactoryBean();</span><br><span class="line">        sessionFactory.setDataSource(dataSource);</span><br><span class="line">        sessionFactory.getObject().getConfiguration().setMapUnderscoreToCamelCase(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> sessionFactory.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>SecondDatasourceConfig:<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@MapperScan(basePackages = SecondDatasourceConfig.PACKAGE, sqlSessionFactoryRef = <span class="meta-string">"secondSqlSessionFactory"</span>)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecondDatasourceConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    static <span class="keyword">final</span> String PACKAGE = <span class="string">"com.xu.scaffold.repository.second"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="meta-string">"secondDataSource"</span>)</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = <span class="meta-string">"hikari.second"</span>)</span></span><br><span class="line">    <span class="keyword">public</span> HikariDataSource dataSource() &#123;</span><br><span class="line">        <span class="keyword">return</span> new HikariDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="meta-string">"secondTransactionManager"</span>)</span></span><br><span class="line">    <span class="keyword">public</span> DataSourceTransactionManager transactionManager() &#123;</span><br><span class="line">        <span class="keyword">return</span> new DataSourceTransactionManager(<span class="keyword">this</span>.dataSource());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean(name = <span class="meta-string">"secondSqlSessionFactory"</span>)</span></span><br><span class="line">    <span class="keyword">public</span> SqlSessionFactory sqlSessionFactory(<span class="meta">@Qualifier(<span class="meta-string">"secondDataSource"</span>)</span> DataSource dataSource) throws Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> SqlSessionFactoryBean sessionFactory = new SqlSessionFactoryBean();</span><br><span class="line">        sessionFactory.setDataSource(dataSource);</span><br><span class="line">        sessionFactory.getObject().getConfiguration().setMapUnderscoreToCamelCase(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> sessionFactory.getObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2018/11/100076.html" class="pre-post btn btn-default" title='JAVA开发软件必须掌握的框架'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">JAVA开发软件必须掌握的框架</span>
        </a>
    
    
        <a href="/archives/2018/11/100074.html" class="next-post btn btn-default" title='解读.NET Core跨平台'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">解读.NET Core跨平台</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍"><span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本设计"><span class="toc-text">基本设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HikariDataSource"><span class="toc-text">HikariDataSource</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HikariPool"><span class="toc-text">HikariPool</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConcurrentBag"><span class="toc-text">ConcurrentBag</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#详细配置"><span class="toc-text">详细配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置多数据源"><span class="toc-text">配置多数据源</span></a></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2023&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>