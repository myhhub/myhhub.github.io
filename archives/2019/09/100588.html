<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="知识图谱">


    <meta name="description" content="一. 半结构化数据的获取简介本文章针对半结构化数据的获取，介绍基于scrapy构建的百度百科爬虫和互动百科爬虫。同时为了练手还根据教程制作了基于BeautifulSoup和urllib2的百度百...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>从零开始构建知识图谱-Windows下开发环境搭建 | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx">


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="从零开始构建知识图谱-Windows下开发环境搭建">
            
	            从零开始构建知识图谱-Windows下开发环境搭建
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/cloud/">云计算</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/knowledgegraph/">知识图谱</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2019/09/23</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>1301</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <h1 id="一-半结构化数据的获取"><a href="#一-半结构化数据的获取" class="headerlink" title="一. 半结构化数据的获取"></a>一. 半结构化数据的获取</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>本文章针对半结构化数据的获取，介绍基于scrapy构建的百度百科爬虫和互动百科爬虫。同时为了练手还根据教程制作了基于BeautifulSoup和urllib2的百度百科爬虫、微信公众号爬虫和虎嗅网爬虫。</p>
<p>目前百度百科爬虫，爬取电影类数据，包含电影22219部，演员13967人。互动百科爬虫， 爬取电影类数据，包含电影13866部，演员5931 人。</p>
<h2 id="1-mysql"><a href="#1-mysql" class="headerlink" title="1. mysql"></a>1. mysql</h2><p>MySQL是一个关系型数据库管理系统，由瑞典MySQL AB 公司开发，目前属于 Oracle 旗下产品。MySQL 是最流行的关系型数据库管理系统之一，在 WEB 应用方面，MySQL是最好的 RDBMS (Relational Database Management System，关系数据库管理系统) 应用软件之一。</p>
<p>MySQL官网<a href="https://cdn.mysql.com//Downloads/MySQLInstaller/mysql-installer-community-8.0.17.0.msi" target="_blank" rel="noopener">安装包</a>，该安装包有安装指引，按步骤完成即可。</p>
<p>如果想安装MySQL绿色版（不建议），需要手工配置，请参考文章<a href="https://blog.csdn.net/qq_37350706/article/details/81707862" target="_blank" rel="noopener">MySQL 8.0.16安装教程(windows 64位)</a>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> actor_to_movie <span class="keyword">DROP</span> actor_movie_id;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> actor_to_movie <span class="keyword">ADD</span> PRIMARY <span class="keyword">KEY</span> (actor_id,movie_id);</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> actor_to_movie <span class="keyword">ADD</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> actor_to_movie_fk_1 (movie_id) <span class="keyword">REFERENCES</span> movie (movie_id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> actor_to_movie <span class="keyword">ADD</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> actor_to_movie_fk_2 (actor_id) <span class="keyword">REFERENCES</span> actor (actor_id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> movie_to_genre <span class="keyword">DROP</span> movie_genre_id;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> movie_to_genre <span class="keyword">ADD</span> PRIMARY <span class="keyword">KEY</span> (movie_id,genre_id);</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> movie_to_genre <span class="keyword">ADD</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> movie_to_genre_fk_1 (movie_id) <span class="keyword">REFERENCES</span> movie (movie_id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> movie_to_genre <span class="keyword">ADD</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> movie_to_genre_fk_2 (genre_id) <span class="keyword">REFERENCES</span> genre (genre_id) <span class="keyword">ON</span> <span class="keyword">DELETE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">NO</span> <span class="keyword">ACTION</span>;</span><br></pre></td></tr></table></figure>
<h2 id="2-Python"><a href="#2-Python" class="headerlink" title="2. Python"></a>2. Python</h2><p>Python是一种跨平台的计算机程序设计语言。是一种面向对象的动态类型语言，最初被设计用于编写自动化脚本(shell)，随着版本的不断更新和语言新功能的添加，越来越多被用于独立的、大型项目的开发。</p>
<p>对于初学者和完成普通任务，Python语言是非常简单易用的。连Google都在大规模使用Python，你就不用担心学了会没用。</p>
<p>项目是Python2开发的，建议安装Python3。</p>
<p>Python官网下载地址：<a href="https://www.python.org/downloads/" target="_blank" rel="noopener">https://www.python.org/downloads/</a> ，该安装包有安装指引，按步骤完成即可。</p>
<p>详细步骤请参考文章<a href="https://baijiahao.baidu.com/s?id=1606573927720991570&amp;wfr=spider&amp;for=pc" target="_blank" rel="noopener">新手必看！如何在windows下安装Python(Python入门教程)</a>。</p>
<p>python安装好之后，我们要检测一下是否安装成功，用系统管理员打开命令行工具cmd，输入“python -V”,然后敲回车，如果出现如下信息，则表示我们安装成功了。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">C</span>:\<span class="selector-tag">Users</span>\<span class="selector-tag">mmm</span>&gt;<span class="selector-tag">python</span> <span class="selector-tag">-V</span></span><br><span class="line"><span class="selector-tag">Python</span> 3<span class="selector-class">.7</span><span class="selector-class">.4</span></span><br></pre></td></tr></table></figure>
<h2 id="3-IDE（PyCharm）"><a href="#3-IDE（PyCharm）" class="headerlink" title="3. IDE（PyCharm）"></a>3. IDE（PyCharm）</h2><p>PyCharm是一种Python IDE，带有一整套可以帮助用户在使用Python语言开发时提高其效率的工具，比如调试、语法高亮、Project管理、代码跳转、智能提示、自动完成、单元测试、版本控制。此外，该IDE提供了一些高级功能，以用于支持Django框架下的专业Web开发。</p>
<p>a. 官网Professional(专业版)下载地址：<a href="https://www.jetbrains.com/pycharm/download/#section=windows" target="_blank" rel="noopener">https://www.jetbrains.com/pycharm/download/#section=windows</a></p>
<p>b. 下载Jetbrains系列产品2019.2.2激活破解补丁jetbrains-agent.jar文件</p>
<p>网盘链接：<a href="https://pan.baidu.com/s/1FGZ9d5J5amnvf0vMFqSOsQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1FGZ9d5J5amnvf0vMFqSOsQ</a> 提取码：mmk6</p>
<p>c. 参考<a href="https://www.cnblogs.com/RyanLea/p/11289424.html" target="_blank" rel="noopener">pycharm永久激活教程</a>，永久激活。</p>
<h2 id="4-Scrapy"><a href="#4-Scrapy" class="headerlink" title="4. Scrapy"></a>4. Scrapy</h2><p>Scrapy是一个为了爬取网站数据，提取结构性数据而编写的应用框架。 可以应用在包括数据挖掘，信息处理或存储历史数据等一系列的程序中。</p>
<p>Scrapy依赖的库比较多，在安装之前，你需要确保以下库已经安装：wheel、lxml、pyOpenSSL、Twisted、pywin32，先装完，再装Scrapy。使用可阅读文章<a href="https://www.jianshu.com/p/0c0759bc3d27" target="_blank" rel="noopener">Scrapy入门简介及Demo</a>。<br>库地址：<a href="https://www.lfd.uci.edu/~gohlke/pythonlibs/" target="_blank" rel="noopener">https://www.lfd.uci.edu/~gohlke/pythonlibs/</a></p>
<h3 id="安装wheel"><a href="#安装wheel" class="headerlink" title="安装wheel"></a>安装wheel</h3><h4 id="用途："><a href="#用途：" class="headerlink" title="用途："></a>用途：</h4><p>pip安装固然方便，但有时候会遇到安装失败的问题。wheel和egg都是打包的格式，支持不需要编译或制作的安装过程。wheel现在被认为是Python标准的二进制打包格式。</p>
<h4 id="安装命令："><a href="#安装命令：" class="headerlink" title="安装命令："></a>安装命令：</h4><p>pip install wheel</p>
<p><em>注意：如果你是刚刚安装过python并且从没有安装过wheel，你可以直接运行上述命令。但如果你的pip版本不够新，你需要在执行install命令之前更新一下pip，在命令行中输入：python -m pip install –upgrade pip更新pip，再输入安装命令即可。</em></p>
<h3 id="安装lxml"><a href="#安装lxml" class="headerlink" title="安装lxml"></a>安装lxml</h3><h4 id="用途：-1"><a href="#用途：-1" class="headerlink" title="用途："></a>用途：</h4><p>python的一个解析库,支持HTML和XML的解析,支持XPath解析方式,而且解析效率非常高。</p>
<h4 id="安装命令：-1"><a href="#安装命令：-1" class="headerlink" title="安装命令："></a>安装命令：</h4><h4 id="安装方式一-在线-："><a href="#安装方式一-在线-：" class="headerlink" title="安装方式一(在线)："></a>安装方式一(在线)：</h4><p>pip install lxml</p>
<h4 id="安装方式二（离线-："><a href="#安装方式二（离线-：" class="headerlink" title="安装方式二（离线)："></a>安装方式二（离线)：</h4><p>你可以进入地址<br>[<a href="https://www.lfd.uci.edu/~gohlke/pythonlibs/#lxml]" target="_blank" rel="noopener">https://www.lfd.uci.edu/~gohlke/pythonlibs/#lxml]</a>:</p>
<p>去下载lxml，然后用安装.whl文件的方式安装。<br>pip install lxml‑4.4.1‑cp37‑cp37m‑win_amd64.whl</p>
<p><strong>下面安装都省略离线安装方式。</strong></p>
<h3 id="安装zope-interface"><a href="#安装zope-interface" class="headerlink" title="安装zope.interface"></a>安装zope.interface</h3><h4 id="用途：-2"><a href="#用途：-2" class="headerlink" title="用途："></a>用途：</h4><p>python本身不提供interface的实现,需要通过第三方扩展库来使用类似interface的功能,一般都是zope.interface。</p>
<p><em>注意：不安装zope.interface可能会出现pyOpenSSL安装失败。</em></p>
<h4 id="安装命令：-2"><a href="#安装命令：-2" class="headerlink" title="安装命令："></a>安装命令：</h4><p>pip install zope.interface</p>
<h3 id="安装pyOpenSSL"><a href="#安装pyOpenSSL" class="headerlink" title="安装pyOpenSSL"></a>安装pyOpenSSL</h3><h4 id="用途：-3"><a href="#用途：-3" class="headerlink" title="用途："></a>用途：</h4><p>让python支持SSL通信协议，简单来说就是加密解密等这系列操作。</p>
<h4 id="安装命令：-3"><a href="#安装命令：-3" class="headerlink" title="安装命令："></a>安装命令：</h4><p>pip install pyOpenSSL</p>
<h3 id="安装Twisted"><a href="#安装Twisted" class="headerlink" title="安装Twisted"></a>安装Twisted</h3><h4 id="用途：-4"><a href="#用途：-4" class="headerlink" title="用途："></a>用途：</h4><p>Twisted是用Python实现的基于事件驱动的网络引擎框架，Twisted支持许多常见的传输及应用层协议，包括TCP、UDP、SSL/TLS、HTTP、IMAP、SSH、IRC以及FTP。就像Python一样，Twisted也具有“内置电池”（batteries-included）的特点。Twisted对于其支持的所有协议都带有客户端和服务器实现，同时附带有基于命令行的工具，使得配置和部署产品级的Twisted应用变得非常方便。</p>
<p>详情参见[<a href="https://www.cnblogs.com/misswangxing/p/7712318.html]" target="_blank" rel="noopener">https://www.cnblogs.com/misswangxing/p/7712318.html]</a></p>
<h4 id="安装命令：-4"><a href="#安装命令：-4" class="headerlink" title="安装命令："></a>安装命令：</h4><p>pip install Twisted</p>
<h3 id="安装pywin32"><a href="#安装pywin32" class="headerlink" title="安装pywin32"></a>安装pywin32</h3><h4 id="用途：-5"><a href="#用途：-5" class="headerlink" title="用途："></a>用途：</h4><p>python不自带访问Windows API的库，需要下载这个库做支持。</p>
<h4 id="安装命令：-5"><a href="#安装命令：-5" class="headerlink" title="安装命令："></a>安装命令：</h4><p>pip install pywin32</p>
<p>#在python安装根路径的Scripts目录下执行<br>python pywin32_postinstall.py -install</p>
<h3 id="安装Scrapy"><a href="#安装Scrapy" class="headerlink" title="安装Scrapy"></a>安装Scrapy</h3><h4 id="安装命令：-6"><a href="#安装命令：-6" class="headerlink" title="安装命令："></a>安装命令：</h4><p>命令：pip install scrapy</p>
<h3 id="可能出现的问题"><a href="#可能出现的问题" class="headerlink" title="可能出现的问题"></a><strong>可能出现的问题</strong></h3><p>问题：You are using pip version 19.0.3, however version 19.X is available.<br>解决方法：输入命令python -m pip install -U pip 或 python -m pip install –upgrade pip </p>
<p>模块安装完毕，输入’scrapy -h’, 输出信息如下则表示Scrapy安装成功。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\mmm&gt;scrapy -h</span><br><span class="line">Scrapy 1.7.3 - <span class="literal">no</span> active project</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  scrapy &lt;command&gt; [options] [args]</span><br><span class="line"></span><br><span class="line">Available commands:</span><br><span class="line">  bench         <span class="builtin-name">Run</span> quick benchmark test</span><br><span class="line">  fetch         Fetch a URL using the Scrapy downloader</span><br><span class="line">  genspider     Generate new spider using pre-defined templates</span><br><span class="line">  runspider     <span class="builtin-name">Run</span> a self-contained spider (without creating a project)</span><br><span class="line"> <span class="built_in"> settings </span>     <span class="builtin-name">Get</span><span class="built_in"> settings </span>values</span><br><span class="line">  shell         Interactive scraping console</span><br><span class="line">  startproject  Create new project</span><br><span class="line">  version       <span class="builtin-name">Print</span> Scrapy version</span><br><span class="line">  view          Open URL <span class="keyword">in</span> browser, as seen by Scrapy</span><br><span class="line"></span><br><span class="line">  [ more ]      More commands available when <span class="builtin-name">run</span> <span class="keyword">from</span> project directory</span><br></pre></td></tr></table></figure>
<h3 id="使用工具，快速解决系列：Anaconda"><a href="#使用工具，快速解决系列：Anaconda" class="headerlink" title="使用工具，快速解决系列：Anaconda"></a>使用工具，快速解决系列：Anaconda</h3><p>其实，你还可以登录Scrapy中文网，使用Anaconda进行安装，这个方式可能更适合初学编程的童鞋。地址如下：</p>
<p>[ <a href="http://www.scrapyd.cn/doc/124.html" target="_blank" rel="noopener">http://www.scrapyd.cn/doc/124.html</a> ]</p>
<h3 id="验证安装是否成功"><a href="#验证安装是否成功" class="headerlink" title="验证安装是否成功"></a>验证安装是否成功</h3><h4 id="方法一："><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h4><p>命令行：pip list</p>
<p>列表中出现了Scrapy，安装成功。</p>
<h4 id="方法二："><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h4><p>命令行：scrapy</p>
<p>正确执行命令，安装成功。</p>
<h3 id="文件的功能"><a href="#文件的功能" class="headerlink" title="文件的功能"></a>文件的功能</h3><p>scrapy.cfg：配置文件</p>
<p>spiders：存放你Spider文件，也就是你爬取的py文件</p>
<p>items.py：相当于一个容器，和字典较像</p>
<p>middlewares.py：定义Downloader Middlewares(下载器中间件)和Spider Middlewares(蜘蛛中间件)的实现</p>
<p>pipelines.py:定义Item Pipeline的实现，实现数据的清洗，储存，验证。</p>
<p>settings.py：全局配置</p>
<h3 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h3><p>a. 创建工程结构</p>
<p>cmd中执行命令：scrapy startproject  工程名</p>
<p><strong>快速打开当前文件夹的dos命令窗口：找到指定文件的文件夹，按住“shift+右键”，选择“在此处打开命令窗口”或“在此处打开Powershell窗口”即可。</strong></p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PS C:<span class="symbol">\d</span><span class="symbol">\m</span>mm<span class="symbol">\p</span>ycharm&gt; scrapy startproject baidu_baike</span><br><span class="line">New Scrapy project 'baidu_baike', using template directory 'c:<span class="symbol">\m</span>y<span class="symbol">\p</span>ython<span class="symbol">\l</span>ib<span class="symbol">\s</span>ite-packages<span class="symbol">\s</span>crapy<span class="symbol">\t</span>emplates<span class="symbol">\p</span>roject', created in:</span><br><span class="line">    C:<span class="symbol">\d</span><span class="symbol">\m</span>mm<span class="symbol">\p</span>ycharm<span class="symbol">\b</span>aidu_baike</span><br><span class="line"></span><br><span class="line">You can start your first spider with:</span><br><span class="line">    cd baidu_baike</span><br><span class="line">    scrapy genspider example example.com</span><br></pre></td></tr></table></figure>
<p>b. 创建一个spider（爬虫文件）</p>
<p>cmd中执行命令：scrapy genspider 文件名 要爬取的网址。</p>
<p>在spiders文件夹下创建</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PS C:\d\mmm\pycharm\baidu_baike\baidu_baike\spiders&gt; scrapy genspider -t basic baidubaike baike<span class="selector-class">.baidu</span><span class="selector-class">.com</span></span><br><span class="line">Created spider <span class="string">'baidubaike'</span> using template <span class="string">'basic'</span> <span class="keyword">in</span> module:</span><br><span class="line">  baidu_baike<span class="selector-class">.spiders</span><span class="selector-class">.baidubaike</span></span><br></pre></td></tr></table></figure>
<p>生成baidubaike.py的代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaidubaikeSpider</span><span class="params">(scrapy.Spider)</span>:</span></span><br><span class="line">    name = <span class="string">'baidu'</span></span><br><span class="line">    allowed_domains = [<span class="string">'baike.baidu.com'</span>]</span><br><span class="line">    start_urls = [<span class="string">'http://baike.baidu.com/'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parse</span><span class="params">(self, response)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>name：是项目的名字</p>
<p>allowed_domains：是允许爬取的域名，比如一些网站有相关链接，域名就和本网站不同，这些就会忽略。</p>
<p>atart_urls：是Spider爬取的网站，定义初始的请求url，可以多个。</p>
<p>parse方法：是Spider的一个方法，在请求start_url后，之后的方法，这个方法是对网页的解析，与提取自己想要的东西。</p>
<p>response参数：是请求网页后返回的内容，也就是你需要解析的网页。</p>
<p>c. 运行</p>
<p>项目<a href="https://github.com/Pelhans/Z_knowledge_graph" target="_blank" rel="noopener">从零开始构建知识图谱项目链接</a>是python2编写的，在python3环境下运行需要修改代码</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#settings.py文件</span></span><br><span class="line"><span class="meta">#修改前 mysql的配置，PORT的值为数字，不可加单引号</span></span><br><span class="line">HOST_IP = <span class="string">'localhost'</span></span><br><span class="line">PORT = <span class="number">3306</span>  </span><br><span class="line">USER = <span class="string">'root'</span></span><br><span class="line">PASSWD = <span class="string">'root'</span></span><br><span class="line">DB_NAME = <span class="string">'baidu_baike'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#baidu_baike.py文件</span></span><br><span class="line"><span class="meta">#修改前 urlparse.urljoin</span></span><br><span class="line">urllib.parse.urljoin</span><br><span class="line"><span class="meta">#修改前 urlparse</span></span><br><span class="line">urllib</span><br><span class="line"></span><br><span class="line"><span class="meta">#pipelines.py文件</span></span><br><span class="line"><span class="meta">#修改前 .decode('utf-8')</span></span><br><span class="line">.encode(<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="meta">#删除#port=settings.PORT的注释</span></span><br><span class="line">port=settings.PORT</span><br><span class="line"><span class="meta">#删除代码</span></span><br><span class="line">import sys</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf-8'</span>)</span><br></pre></td></tr></table></figure>
<p>cmd中执行命令：scrapy crawl 项目名</p>
<p>在项目根路径下执行</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">PS C:\d\mmm\pycharm\baidu_baike&gt; scrapy crawl baidu</span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">40</span> [scrapy<span class="selector-class">.utils</span><span class="selector-class">.log</span>] INFO: Scrapy <span class="number">1.7</span>.<span class="number">3</span> started (bot: baidu_baike)</span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">40</span> [scrapy<span class="selector-class">.utils</span><span class="selector-class">.log</span>] INFO: Versions: lxml <span class="number">4.4</span>.<span class="number">1.0</span>, libxml2 <span class="number">2.9</span>.<span class="number">5</span>, cssselect <span class="number">1.1</span>.<span class="number">0</span>, parsel <span class="number">1.5</span>.<span class="number">2</span>, w3lib <span class="number">1.21</span>.<span class="number">0</span>, Twisted <span class="number">19.7</span>.<span class="number">0</span>, Python <span class="number">3.7</span>.<span class="number">4</span> (tags/v3.<span class="number">7.4</span>:e09359112e, Jul  <span class="number">8</span> <span class="number">2019</span>, <span class="number">20</span>:<span class="number">34</span>:<span class="number">20</span>) [MSC v.<span class="number">1916</span> <span class="number">64</span> bit (AMD64)], pyOpenSSL <span class="number">19.0</span>.<span class="number">0</span> (OpenSSL <span class="number">1.1</span>.<span class="number">1</span>c  <span class="number">28</span> May <span class="number">2019</span>), cryptography <span class="number">2.7</span>, Platform Windows-<span class="number">10</span>-<span class="number">10.0</span>.<span class="number">18362</span>-SP0</span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">40</span> [scrapy.crawler] INFO: Overridden settings: &#123;<span class="string">'BOT_NAME'</span>: <span class="string">'baidu_baike'</span>, <span class="string">'NEWSPIDER_MODULE'</span>: <span class="string">'baidu_baike.spiders'</span>, <span class="string">'SPIDER_MODULES'</span>: [<span class="string">'baidu_baike.spiders'</span>], <span class="string">'USER_AGENT'</span>: <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36'</span>&#125;</span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">40</span> [scrapy<span class="selector-class">.extensions</span><span class="selector-class">.telnet</span>] INFO: Telnet Password: <span class="number">4</span>e0e039c01ca23b2</span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">40</span> [scrapy.middleware] INFO: Enabled extensions:</span><br><span class="line">[<span class="string">'scrapy.extensions.corestats.CoreStats'</span>,</span><br><span class="line"> <span class="string">'scrapy.extensions.telnet.TelnetConsole'</span>,</span><br><span class="line"> <span class="string">'scrapy.extensions.logstats.LogStats'</span>]</span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">41</span> [scrapy.middleware] INFO: Enabled downloader middlewares:</span><br><span class="line">[<span class="string">'baidu_baike.middlewares.RandomUserAgent'</span>,</span><br><span class="line"> <span class="string">'baidu_baike.middlewares.ProxyMiddleWare'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.httpauth.HttpAuthMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.downloadtimeout.DownloadTimeoutMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.defaultheaders.DefaultHeadersMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.useragent.UserAgentMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.retry.RetryMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.redirect.MetaRefreshMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.httpcompression.HttpCompressionMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.redirect.RedirectMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.cookies.CookiesMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.httpproxy.HttpProxyMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.downloadermiddlewares.stats.DownloaderStats'</span>]</span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">41</span> [scrapy.middleware] INFO: Enabled spider middlewares:</span><br><span class="line">[<span class="string">'scrapy.spidermiddlewares.httperror.HttpErrorMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.spidermiddlewares.offsite.OffsiteMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.spidermiddlewares.referer.RefererMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.spidermiddlewares.urllength.UrlLengthMiddleware'</span>,</span><br><span class="line"> <span class="string">'scrapy.spidermiddlewares.depth.DepthMiddleware'</span>]</span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">41</span> [scrapy.middleware] INFO: Enabled item pipelines:</span><br><span class="line">[<span class="string">'baidu_baike.pipelines.BaiduBaikePipeline'</span>]</span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">41</span> [scrapy<span class="selector-class">.core</span><span class="selector-class">.engine</span>] INFO: Spider opened</span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">41</span> [scrapy<span class="selector-class">.extensions</span><span class="selector-class">.logstats</span>] INFO: Crawled <span class="number">0</span> pages (at <span class="number">0</span> pages/min), scraped <span class="number">0</span> items (at <span class="number">0</span> items/min)</span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">41</span> [scrapy<span class="selector-class">.extensions</span><span class="selector-class">.telnet</span>] INFO: Telnet console listening on <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6023</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">41</span> [scrapy<span class="selector-class">.core</span><span class="selector-class">.engine</span>] DEBUG: Crawled (<span class="number">200</span>) &lt;GET https:<span class="comment">//baike.baidu.com/item/%E5%88%98%E5%BE%B7%E5%8D%8E/114923&gt; (referer: None)</span></span><br><span class="line">Get <span class="selector-tag">a</span> actor page</span><br><span class="line"><span class="number">2019</span>-<span class="number">09</span>-<span class="number">26</span> <span class="number">09</span>:<span class="number">45</span>:<span class="number">42</span> [scrapy<span class="selector-class">.core</span><span class="selector-class">.scraper</span>] DEBUG: Scraped from &lt;<span class="number">200</span> https:<span class="comment">//baike.baidu.com/item/%E5%88%98%E5%BE%B7%E5%8D%8E/114923&gt;</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<h1 id="二-数据库到-NTriples-以及通过Apache-jena-访问NT"><a href="#二-数据库到-NTriples-以及通过Apache-jena-访问NT" class="headerlink" title="二. 数据库到 NTriples 以及通过Apache jena 访问NT"></a>二. 数据库到 NTriples 以及通过Apache jena 访问NT</h1><h2 id="1-Protege"><a href="#1-Protege" class="headerlink" title="1. Protege"></a>1. Protege</h2><p>斯坦福大学开发的本体编辑和知识获取软件。开发语言采用Java，属于开放源码软件。由于其优秀的设计和众多的插件，<a href="https://protege.stanford.edu/" target="_blank" rel="noopener">Protege</a>已成为目前使用最广泛的本体论编辑器之一。软件不需要安装，需要配置相应的Java环境。详细使用可阅读<a href="https://protegewiki.stanford.edu/wiki/Main_Page" target="_blank" rel="noopener">官方教程</a>。</p>
<p>打开protege，看到和下图类似的界面。在Ontology IRI中填写我们新建本体资源的IRI。读者可以填写自己的符合标准的IRI。如下：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//www.kgdemo.com</span></span><br></pre></td></tr></table></figure></p>
<h2 id="2-d2rq"><a href="#2-d2rq" class="headerlink" title="2. d2rq"></a>2. d2rq</h2><p>D2RQ平台用于访问关系数据库系统是虚拟的,只读RDF图。它提供了基于RDF的访问关系数据库的内容,而无需复制成RDF存储。使用D2RQ可参考文章<a href="https://blog.csdn.net/dqc406839653/article/details/83054710" target="_blank" rel="noopener">使用d2rq的第一步</a>，<a href="http://d2rq.org/d2rq-language" target="_blank" rel="noopener">官方文档</a>。</p>
<p>官方网站：<a href="http://d2rq.org/" target="_blank" rel="noopener">http://d2rq.org/</a></p>
<p>a. 下载后得到了<a href="https://github.s3.amazonaws.com/downloads/d2rq/d2rq/d2rq-0.8.1.zip?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=AKIAISTNZFOVBIJMK3TQ%2F20190925%2Fus-east-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20190925T071020Z&amp;X-Amz-Expires=300&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=dbb8bdb6cb59c0f812600b5089aabd5173e84852d3c349706befbb1be0c60aeb" target="_blank" rel="noopener">d2rq-0.8.1.zip</a>的压缩文件，d2rq不需要安装，直接将其解压到运行目录，再配置运行环境即可。</p>
<p>b. 项目需要将d2rq与java、mysql进行联合应用，因此需要JDBC driver，将<a href="https://cdn.mysql.com//Downloads/Connector-J/mysql-connector-java-5.1.48.zip" target="_blank" rel="noopener">mysql-connector-java-5.1.48-bin.jar</a>文件放入d2rq的/lib文件夹中。</p>
<p>c. 用generate-mapping工具为数据库创建mapping file（映射文件）。cmd中运行 cd C:\my\d2rq命令，转到d2rq目录。<br>运行以下命令，创建mappling映射文件。?useSSL=false语句设置SSL为false以避免提示警告，数据库没设置主键会提示警告。</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PS C:\my\d2rq&gt; .\<span class="keyword">generate</span>-mapping -u root -p root -o kg_demo_mapping_baidu_baike<span class="variable">.ttl</span> jdbc:mysql:<span class="comment">///baidu_baike?useSSL=false</span></span><br><span class="line">## -u 后root是数据库用户，-p 后root是用户密码,jdbc:mysql: 后baidu_baike是数据库名称；</span><br><span class="line">## 注意笔者是Windows PowerShell命令窗口运行命令，若在cmd中去掉前面的.\，即：<span class="keyword">generate</span>-mapping开始。下面的命令也如此。</span><br></pre></td></tr></table></figure>
<p>下面是根据我们定义的本体修改的mapping文件。</p>
<p>1) 为了表达简练，我们给本体做一些修改。</p>
<p>这样<code>http://www.kgdemo.com#Actor就可以表达为</code>:Actor`，其他的词汇同理。</p>
<p><em>vocab</em>前缀，它表示输出本体的命名空间，也就是说，所有来自<em>D2RQ</em>的<em>RDF</em>都必须使用具有<em>vocab</em>前缀的命名空间的类和属性描述。这样做的目的是为了使它们是唯一的，在需要读取某个类或属性时可以直接操作，而不必先动态获得命名空间了。</p>
<p>2) 把默认的映射词汇改为我们本体中的词汇即可。在处理外键的时候要注意当前编辑的属性的domain和range，belongsToClassMap是domain，refersToClassMap是range。</p>
<p>为了实现生成及修改全自自动，需编写dos下的bat实现，auto.bat代码如下：</p>
<figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off&amp;<span class="built_in">setlocal</span> enabledelayedexpansion</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> db=baidu_baike</span><br><span class="line"><span class="built_in">set</span> file=kg_demo_mapping_<span class="variable">%db%</span>.ttl</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> generate-mapping -u root -p root -o <span class="variable">%file%</span> jdbc:mysql:///<span class="variable">%db%</span>?useSSL=false</span><br><span class="line"></span><br><span class="line">:: <span class="keyword">call</span> <span class="built_in">findstr</span> /i /v /C:"@prefix vocab" "<span class="variable">%file%</span>"&gt;&gt;<span class="variable">%file%</span>.bk</span><br><span class="line">:: <span class="built_in">move</span> /y <span class="variable">%file%</span>.bk <span class="variable">%file%</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> /f "tokens=<span class="number">1</span>,* delims=:" <span class="variable">%%b</span> <span class="keyword">in</span> ('<span class="built_in">findstr</span> /n ".*" "<span class="variable">%file%</span>"')<span class="keyword">do</span> (</span><br><span class="line">	<span class="built_in">set</span> "var=<span class="variable">%%c</span>"</span><br><span class="line">	<span class="keyword">if</span> "<span class="variable">!var!</span>" <span class="keyword">neq</span> "@prefix vocab: &lt;vocab/&gt; ." (</span><br><span class="line">		<span class="keyword">if</span> "<span class="variable">!var!</span>" <span class="keyword">equ</span> "" (</span><br><span class="line">			&gt;&gt;<span class="variable">%file%</span>.bk <span class="built_in">echo</span>,<span class="variable">!var!</span>) ^</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> "<span class="variable">!var!</span>" <span class="keyword">equ</span> "@prefix jdbc: &lt;http://d2rq.org/terms/jdbc/&gt; ." (</span><br><span class="line">		  &gt;&gt;<span class="variable">%file%</span>.bk <span class="built_in">echo</span>,<span class="variable">!var!</span></span><br><span class="line">			&gt;&gt;<span class="variable">%file%</span>.bk <span class="built_in">echo</span>,@prefix : ^&lt;http://www.kgdemo.com#^&gt; .) ^</span><br><span class="line">		<span class="keyword">else</span> (</span><br><span class="line">			<span class="built_in">echo</span>;"<span class="variable">!var!</span>"|<span class="built_in">find</span> "jdbcDSN"&amp;&amp;(</span><br><span class="line">				&gt;&gt;<span class="variable">%file%</span>.bk <span class="built_in">echo</span>,  d2rq:jdbcDSN ^"jdbc:mysql:///<span class="variable">%db%</span>?useUnicode=true^&amp;characterEncoding=utf8^&amp;useSSL=false^";)||(</span><br><span class="line">				<span class="built_in">set</span> "var=!var:vocab= !"</span><br><span class="line">	    	<span class="built_in">set</span> "var=<span class="variable">!var:actor_actor=actor!</span>"</span><br><span class="line">	    	&gt;&gt;<span class="variable">%file%</span>.bk <span class="built_in">echo</span>,<span class="variable">!var!</span>))</span><br><span class="line">	)</span><br><span class="line">)</span><br><span class="line"><span class="built_in">move</span> /y <span class="variable">%file%</span>.bk <span class="variable">%file%</span></span><br></pre></td></tr></table></figure>
<p>d. 运行dump-rdf工具，创建rdf的转存,命令将数据转换为Ntriples。<br>按照官方的介绍，运行以下命令生成rdf，在d2rq文件夹中查看生成的nt文件可以看到RDF结构。</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\<span class="keyword">my</span>\d2rq&gt; ./<span class="keyword">dump</span>-rdf -o baidu_baike.nt kg_demo_mapping_baidu_baike.ttl</span><br></pre></td></tr></table></figure>
<p>e. 使用下面的命令启动D2R Server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\my\d2rq&gt; ./d2r-server kg_demo_mapping_baidu_baike.ttl</span><br><span class="line">17:10:16 INFO  JettyLauncher        :: [[[ Server started at http://localhost:2020/ ]]]</span><br></pre></td></tr></table></figure>
<p>f.SPARQL查询</p>
<p>例如：“周星驰出演了哪些电影？”</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT <span class="string">?n</span> WHERE &#123;</span><br><span class="line">  <span class="string">?s</span> <span class="symbol">rdf:</span>type <span class="symbol">:Actor</span>.</span><br><span class="line">  <span class="string">?s</span> <span class="symbol">:actor_chName</span> <span class="string">'周星驰'</span>.</span><br><span class="line">  <span class="string">?o</span> <span class="symbol">:movie_chName</span> <span class="string">?n</span></span><br><span class="line">&#125;</span><br><span class="line">LIMIT <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>结果为:<br><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SPARQL resul<span class="symbol">ts:</span></span><br><span class="line"><span class="built_in">n</span></span><br><span class="line"><span class="string">"七小福"</span></span><br><span class="line"><span class="string">"大众电影百花奖"</span></span><br><span class="line"><span class="string">"台湾电影金马奖"</span></span><br><span class="line"><span class="string">"香港电影金像奖"</span></span><br><span class="line"><span class="string">"香港电影导演会"</span></span><br><span class="line"><span class="string">"长江7号"</span></span><br><span class="line"><span class="string">"第28届香港电影金像奖"</span></span><br><span class="line"><span class="string">"跳出去"</span></span><br><span class="line"><span class="string">"少林少女"</span></span><br><span class="line"><span class="string">"西游：降魔篇"</span></span><br></pre></td></tr></table></figure></p>
<p>就我们这个例子而言，可以不要“?s rdf:type :Actor”，这里只是让查询图更具体（在拥有复杂关系的RDF图中，可能会存在不同的类拥有相同的属性名。比如，猫和狗名字的属性名都是”name”，我们想查询一只叫汤姆的猫；如果不指定类型，返回结果可能也包含一只叫汤姆的狗）。图模式中，每个RDF用英文句号进行分割。</p>
<p>例如：“少林足球这部电影有哪些演员参演”：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT <span class="string">?n</span> WHERE &#123;</span><br><span class="line">  <span class="string">?s</span> <span class="symbol">rdf:</span>type <span class="symbol">:Movie</span>.</span><br><span class="line">  <span class="string">?s</span> <span class="symbol">:movie_chName</span> <span class="string">'少林足球'</span>.</span><br><span class="line">  <span class="string">?a</span> <span class="symbol">:hasActedIn</span> <span class="string">?s</span>.</span><br><span class="line">  <span class="string">?a</span> <span class="symbol">:actor_chName</span> <span class="string">?n</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果为:</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">n</span></span><br><span class="line"><span class="string">"周星驰"</span></span><br><span class="line"><span class="string">"吴孟达"</span></span><br></pre></td></tr></table></figure>
<h2 id="3-Apache-jena"><a href="#3-Apache-jena" class="headerlink" title="3. Apache jena"></a>3. Apache jena</h2><p>Apache Jena是一个开源的Java语义网框架（open source Semantic Web Framework for Java），用于构建语义网和链接数据应用。安装可阅读文章<a href="https://blog.csdn.net/weixin_41104835/article/details/88635600" target="_blank" rel="noopener">Jena 和 Fuseki安装与SPARQL查询</a>。</p>
<p>下载地址：<a href="http://jena.apache.org/download/" target="_blank" rel="noopener">http://jena.apache.org/download/</a></p>
<p>TDB：用于存储RDF的组件。<br>Jena：提供了RDFS、OWL和通用规则推理机。下载<a href="https://mirrors.tuna.tsinghua.edu.cn/apache/jena/binaries/apache-jena-3.12.0.zip" target="_blank" rel="noopener">Jena</a><br>Fuseki：Jena提供的SPARQL服务器，也就是SPARQL endpoint。下载<a href="https://mirrors.tuna.tsinghua.edu.cn/apache/jena/binaries/apache-jena-fuseki-3.12.0.zip" target="_blank" rel="noopener">Fuseki</a></p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>java开发的软件免安装。</p>
<h3 id="基本使用-1"><a href="#基本使用-1" class="headerlink" title="基本使用"></a>基本使用</h3><p>a. 将RDF数据转换以TDB的方式存储<br>运行命令：tdbloader –loc=”..\tdb” “....\d2rq\baidu_baike.nt”</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">PS <span class="string">C:</span>\my\apache-jena\bat&gt; ./tdbloader --loc=<span class="string">"..\tdb"</span> <span class="string">"..\..\d2rq\baidu_baike.nt"</span></span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">28</span> INFO  <span class="string">loader               :</span>: -- Start triples data phase</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">28</span> INFO  <span class="string">loader               :</span>: ** Load empty triples table</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">28</span> INFO  <span class="string">loader               :</span>: -- Start quads data phase</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">28</span> INFO  <span class="string">loader               :</span>: ** Load empty quads table</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">28</span> INFO  <span class="string">loader               :</span>: <span class="string">Load:</span> ..\..\d2rq\baidu_baike.nt -- <span class="number">2019</span><span class="regexp">/09/</span><span class="number">27</span> <span class="number">16</span>:<span class="number">03</span>:<span class="number">28</span> CST</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">30</span> INFO  <span class="string">loader               :</span>: <span class="string">Add:</span> <span class="number">50</span>,<span class="number">000</span> triples (<span class="string">Batch:</span> <span class="number">31</span>,<span class="number">867</span> / <span class="string">Avg:</span> <span class="number">31</span>,<span class="number">867</span>)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">30</span> INFO  <span class="string">loader               :</span>: <span class="string">Add:</span> <span class="number">100</span>,<span class="number">000</span> triples (<span class="string">Batch:</span> <span class="number">124</span>,<span class="number">688</span> / <span class="string">Avg:</span> <span class="number">50</span>,<span class="number">761</span>)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">31</span> INFO  <span class="string">loader               :</span>: <span class="string">Add:</span> <span class="number">150</span>,<span class="number">000</span> triples (<span class="string">Batch:</span> <span class="number">147</span>,<span class="number">928</span> / <span class="string">Avg:</span> <span class="number">64</span>,<span class="number">991</span>)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">31</span> INFO  <span class="string">loader               :</span>: <span class="string">Add:</span> <span class="number">200</span>,<span class="number">000</span> triples (<span class="string">Batch:</span> <span class="number">124</span>,<span class="number">378</span> / <span class="string">Avg:</span> <span class="number">73</span>,<span class="number">800</span>)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">31</span> INFO  <span class="string">loader               :</span>: <span class="string">Add:</span> <span class="number">250</span>,<span class="number">000</span> triples (<span class="string">Batch:</span> <span class="number">128</span>,<span class="number">534</span> / <span class="string">Avg:</span> <span class="number">80</span>,<span class="number">671</span>)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">32</span> INFO  <span class="string">loader               :</span>: <span class="string">Add:</span> <span class="number">300</span>,<span class="number">000</span> triples (<span class="string">Batch:</span> <span class="number">152</span>,<span class="number">905</span> / <span class="string">Avg:</span> <span class="number">87</span>,<span class="number">565</span>)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">32</span> INFO  <span class="string">loader               :</span>: <span class="string">Add:</span> <span class="number">350</span>,<span class="number">000</span> triples (<span class="string">Batch:</span> <span class="number">131</span>,<span class="number">926</span> / <span class="string">Avg:</span> <span class="number">91</span>,<span class="number">984</span>)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">32</span> INFO  <span class="string">loader               :</span>: <span class="string">Add:</span> <span class="number">400</span>,<span class="number">000</span> triples (<span class="string">Batch:</span> <span class="number">135</span>,<span class="number">501</span> / <span class="string">Avg:</span> <span class="number">95</span>,<span class="number">831</span>)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">33</span> INFO  <span class="string">loader               :</span>: <span class="string">Add:</span> <span class="number">450</span>,<span class="number">000</span> triples (<span class="string">Batch:</span> <span class="number">154</span>,<span class="number">798</span> / <span class="string">Avg:</span> <span class="number">100</span>,<span class="number">066</span>)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">33</span> INFO  <span class="string">loader               :</span>: <span class="string">Add:</span> <span class="number">500</span>,<span class="number">000</span> triples (<span class="string">Batch:</span> <span class="number">145</span>,<span class="number">348</span> / <span class="string">Avg:</span> <span class="number">103</span>,<span class="number">284</span>)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">33</span> INFO  <span class="string">loader               :</span>:   <span class="string">Elapsed:</span> <span class="number">4.84</span> seconds [<span class="number">2019</span><span class="regexp">/09/</span><span class="number">27</span> <span class="number">16</span>:<span class="number">03</span>:<span class="number">33</span> CST]</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">33</span> INFO  <span class="string">loader               :</span>: <span class="string">Add:</span> <span class="number">550</span>,<span class="number">000</span> triples (<span class="string">Batch:</span> <span class="number">160</span>,<span class="number">256</span> / <span class="string">Avg:</span> <span class="number">106</span>,<span class="number">733</span>)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">34</span> INFO  <span class="string">loader               :</span>: <span class="string">Add:</span> <span class="number">600</span>,<span class="number">000</span> triples (<span class="string">Batch:</span> <span class="number">145</span>,<span class="number">348</span> / <span class="string">Avg:</span> <span class="number">109</span>,<span class="number">150</span>)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">34</span> INFO  <span class="string">loader               :</span>: <span class="string">Add:</span> <span class="number">650</span>,<span class="number">000</span> triples (<span class="string">Batch:</span> <span class="number">125</span>,<span class="number">628</span> / <span class="string">Avg:</span> <span class="number">110</span>,<span class="number">262</span>)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">34</span> INFO  <span class="string">loader               :</span>: -- Finish triples data phase</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">34</span> INFO  <span class="string">loader               :</span>: ** <span class="string">Data:</span> <span class="number">663</span>,<span class="number">080</span> triples loaded <span class="keyword">in</span> <span class="number">6.08</span> seconds [<span class="string">Rate:</span> <span class="number">109</span>,<span class="number">059.21</span> per second]</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">34</span> INFO  <span class="string">loader               :</span>: -- Finish quads data phase</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">34</span> INFO  <span class="string">loader               :</span>: -- Start triples index phase</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">35</span> INFO  <span class="string">loader               :</span>: Index SPO-&gt;<span class="string">POS:</span> <span class="number">100</span>,<span class="number">000</span> slots (<span class="string">Batch:</span> <span class="number">418</span>,<span class="number">410</span> slots<span class="regexp">/s /</span> <span class="string">Avg:</span> <span class="number">418</span>,<span class="number">410</span> slots/s)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">35</span> INFO  <span class="string">loader               :</span>: Index SPO-&gt;<span class="string">POS:</span> <span class="number">200</span>,<span class="number">000</span> slots (<span class="string">Batch:</span> <span class="number">662</span>,<span class="number">251</span> slots<span class="regexp">/s /</span> <span class="string">Avg:</span> <span class="number">512</span>,<span class="number">820</span> slots/s)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">35</span> INFO  <span class="string">loader               :</span>: Index SPO-&gt;<span class="string">POS:</span> <span class="number">300</span>,<span class="number">000</span> slots (<span class="string">Batch:</span> <span class="number">598</span>,<span class="number">802</span> slots<span class="regexp">/s /</span> <span class="string">Avg:</span> <span class="number">538</span>,<span class="number">599</span> slots/s)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">35</span> INFO  <span class="string">loader               :</span>: Index SPO-&gt;<span class="string">POS:</span> <span class="number">400</span>,<span class="number">000</span> slots (<span class="string">Batch:</span> <span class="number">588</span>,<span class="number">235</span> slots<span class="regexp">/s /</span> <span class="string">Avg:</span> <span class="number">550</span>,<span class="number">206</span> slots/s)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">35</span> INFO  <span class="string">loader               :</span>: Index SPO-&gt;<span class="string">POS:</span> <span class="number">500</span>,<span class="number">000</span> slots (<span class="string">Batch:</span> <span class="number">581</span>,<span class="number">395</span> slots<span class="regexp">/s /</span> <span class="string">Avg:</span> <span class="number">556</span>,<span class="number">173</span> slots/s)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">35</span> INFO  <span class="string">loader               :</span>: Index SPO-&gt;<span class="string">POS:</span> <span class="number">600</span>,<span class="number">000</span> slots (<span class="string">Batch:</span> <span class="number">598</span>,<span class="number">802</span> slots<span class="regexp">/s /</span> <span class="string">Avg:</span> <span class="number">562</span>,<span class="number">851</span> slots/s)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">36</span> INFO  <span class="string">loader               :</span>: ** Index SPO-&gt;<span class="string">POS:</span> <span class="number">663</span>,<span class="number">080</span> slots indexed <span class="keyword">in</span> <span class="number">1.19</span> seconds [<span class="string">Rate:</span> <span class="number">558</span>,<span class="number">618.38</span> per second]</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">36</span> INFO  <span class="string">loader               :</span>: Index SPO-&gt;<span class="string">OSP:</span> <span class="number">100</span>,<span class="number">000</span> slots (<span class="string">Batch:</span> <span class="number">657</span>,<span class="number">894</span> slots<span class="regexp">/s /</span> <span class="string">Avg:</span> <span class="number">657</span>,<span class="number">894</span> slots/s)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">36</span> INFO  <span class="string">loader               :</span>: Index SPO-&gt;<span class="string">OSP:</span> <span class="number">200</span>,<span class="number">000</span> slots (<span class="string">Batch:</span> <span class="number">694</span>,<span class="number">444</span> slots<span class="regexp">/s /</span> <span class="string">Avg:</span> <span class="number">675</span>,<span class="number">675</span> slots/s)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">36</span> INFO  <span class="string">loader               :</span>: Index SPO-&gt;<span class="string">OSP:</span> <span class="number">300</span>,<span class="number">000</span> slots (<span class="string">Batch:</span> <span class="number">584</span>,<span class="number">795</span> slots<span class="regexp">/s /</span> <span class="string">Avg:</span> <span class="number">642</span>,<span class="number">398</span> slots/s)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">36</span> INFO  <span class="string">loader               :</span>: Index SPO-&gt;<span class="string">OSP:</span> <span class="number">400</span>,<span class="number">000</span> slots (<span class="string">Batch:</span> <span class="number">561</span>,<span class="number">797</span> slots<span class="regexp">/s /</span> <span class="string">Avg:</span> <span class="number">620</span>,<span class="number">155</span> slots/s)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">36</span> INFO  <span class="string">loader               :</span>: Index SPO-&gt;<span class="string">OSP:</span> <span class="number">500</span>,<span class="number">000</span> slots (<span class="string">Batch:</span> <span class="number">595</span>,<span class="number">238</span> slots<span class="regexp">/s /</span> <span class="string">Avg:</span> <span class="number">615</span>,<span class="number">006</span> slots/s)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">37</span> INFO  <span class="string">loader               :</span>: Index SPO-&gt;<span class="string">OSP:</span> <span class="number">600</span>,<span class="number">000</span> slots (<span class="string">Batch:</span> <span class="number">546</span>,<span class="number">448</span> slots<span class="regexp">/s /</span> <span class="string">Avg:</span> <span class="number">602</span>,<span class="number">409</span> slots/s)</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">37</span> INFO  <span class="string">loader               :</span>: ** Index SPO-&gt;<span class="string">OSP:</span> <span class="number">663</span>,<span class="number">080</span> slots indexed <span class="keyword">in</span> <span class="number">1.11</span> seconds [<span class="string">Rate:</span> <span class="number">595</span>,<span class="number">224.44</span> per second]</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">37</span> INFO  <span class="string">loader               :</span>: -- Finish triples index phase</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">37</span> INFO  <span class="string">loader               :</span>: ** <span class="number">663</span>,<span class="number">080</span> triples indexed <span class="keyword">in</span> <span class="number">2.31</span> seconds [<span class="string">Rate:</span> <span class="number">287</span>,<span class="number">171.94</span> per second]</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">37</span> INFO  <span class="string">loader               :</span>: -- Finish triples load</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">37</span> INFO  <span class="string">loader               :</span>: ** <span class="string">Completed:</span> <span class="number">663</span>,<span class="number">080</span> triples loaded <span class="keyword">in</span> <span class="number">8.41</span> seconds [<span class="string">Rate:</span> <span class="number">78</span>,<span class="number">844.23</span> per second]</span><br><span class="line"><span class="number">16</span>:<span class="number">03</span>:<span class="number">37</span> INFO  <span class="string">loader               :</span>: -- Finish quads load</span><br></pre></td></tr></table></figure>
<p><em>注意：“–loc”指定tdb存储的位置；第二个参数是由Mysql数据转换得到的RDF数据。</em></p>
<p>b. 通过Fuseki进行开启服务<br>进入fuseki目录下，运行命令：fuseki-server –loc=..\apache-jena\tdb /kg_movie</p>
<p><em>注意：–loc的参数是上一步TDB数据库的路径,kg_movie是显示的数据库名。</em></p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PS C:\my\apache-jena-fuseki&gt; ./fuseki-server --loc=..\apache-jena\tdb /kg_movie</span><br><span class="line">[2019<span class="string">-09</span><span class="string">-25</span> 16:35:32] Server     INFO  Running in read-only mode for /kg_movie</span><br><span class="line">[2019<span class="string">-09</span><span class="string">-25</span> 16:35:32] Server     INFO  Apache Jena Fuseki 3.12.0</span><br><span class="line">[2019<span class="string">-09</span><span class="string">-25</span> 16:35:32] Config     INFO  FUSEKI_HOME=C:\my\apache-jena-fuseki\.</span><br><span class="line">[2019<span class="string">-09</span><span class="string">-25</span> 16:35:32] Config     INFO  FUSEKI_BASE=C:\my\apache-jena-fuseki\run</span><br><span class="line">[2019<span class="string">-09</span><span class="string">-25</span> 16:35:32] Config     INFO  Shiro file: file://C:\my\apache-jena-fuseki\run\shiro.ini</span><br><span class="line">[2019<span class="string">-09</span><span class="string">-25</span> 16:35:32] Config     INFO  Template file: templates/config-tdb-dir</span><br><span class="line">[2019<span class="string">-09</span><span class="string">-25</span> 16:35:32] Config     INFO  TDB dataset: directory=..\apache-jena\tdb</span><br><span class="line">[2019<span class="string">-09</span><span class="string">-25</span> 16:35:33] Config     INFO  Register: /kg_movie</span><br><span class="line">[2019<span class="string">-09</span><span class="string">-25</span> 16:35:33] Server     INFO  Started 2019/09/25 16:35:33 CST on port 3030</span><br></pre></td></tr></table></figure>
<p>测试查询,可以通过网页端和命令行方式进行SPQRQL查询</p>
<p>如：过滤出变量包含“长江7号”的实体</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT ?subject ?predicate ?object</span><br><span class="line">WHERE &#123;</span><br><span class="line">  ?subject ?predicate ?object</span><br><span class="line"> <span class="built_in"> FILTER </span>regex(?object, <span class="string">"长江7号"</span>) </span><br><span class="line">&#125;</span><br><span class="line">LIMIT 25</span><br></pre></td></tr></table></figure>
<p>返回结果：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">	subject	predicate	object</span><br><span class="line"><span class="number">1</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/6&gt;</span></span><br><span class="line">&lt;http:<span class="regexp">//</span>www.kgdemo.com<span class="comment">#movie_chName&gt;</span></span><br><span class="line"><span class="string">"长江7号"</span></span><br><span class="line"><span class="number">2</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/6&gt;</span></span><br><span class="line">&lt;http:<span class="regexp">//</span>www.kgdemo.com<span class="comment">#movie_bio&gt;</span></span><br><span class="line"><span class="string">" 《长江7号》是由周星驰执导，周星驰、徐娇、张雨绮、林子聪主演的科幻喜剧电影。该片于2008年1月30日在中国上映。影片讲述一名父亲将意外拾获的外星玩具狗当做礼物送给儿子，从而让父子两人的生活发生变化的故事。 [1]  "</span></span><br><span class="line"><span class="number">3</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/10221&gt;</span></span><br><span class="line">&lt;http:<span class="regexp">//</span>www.kgdemo.com<span class="comment">#movie_chName&gt;</span></span><br><span class="line"><span class="string">"长江7号爱地球"</span></span><br><span class="line"><span class="number">4</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/10221&gt;</span></span><br><span class="line">&lt;http:<span class="regexp">//</span>www.kgdemo.com<span class="comment">#movie_bio&gt;</span></span><br><span class="line"><span class="string">" 《长江7号爱地球》是由袁建滔执导的动画电影，石班瑜、徐娇、董洁等联合配音。该片于2010年7月9日在中国内地上映。该片讲述了狄爸以在建筑工地打散工养家，在垃圾堆意外捡到神秘外星生物7仔的故事。 [1]  "</span></span><br><span class="line"><span class="number">5</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#actor/1&gt;</span></span><br><span class="line">&lt;http:<span class="regexp">//</span>www.kgdemo.com<span class="comment">#actor_bio&gt;</span></span><br><span class="line"><span class="string">" 周星驰，1962年6月22日生于香港，祖籍浙江宁波，中国香港演员、导演、编剧、制作人、商人，毕业于无线电视艺员训练班。1980年成为丽的电视台的特约演员，从而进入演艺圈。1981年出演个人首部电视剧《IQ成熟时》。1988年将演艺事业的重心转向大银幕，并于同年出演电影处女作《捕风汉子》。1990年凭借喜剧片《一本漫画闯天涯》确立其无厘头的表演风格 [1]  ；同年，因其主演的喜剧动作片《赌圣》打破香港地区票房纪录而获得关注 [2]  。1991年主演喜剧片《逃学威龙》，并再次打破香港地区票房纪录 [3]  。1995年凭借喜剧爱情片《大话西游》奠定其在华语影坛的地位。1999年自导自演的喜剧片《喜剧之王》获得香港电影年度票房冠军 [4]  。2002年凭借喜剧片《少林足球》获得第21届香港电影金像奖最佳男主角奖以及最佳导演奖 [5]  。2003年成为美国《时代周刊》封面人物 [6]  。2005年凭借喜剧动作片《功夫》获得第42届台湾电影金马奖最佳导演奖 [7]  。2008年自导自演的科幻喜剧片《长江7号》获得香港电影年度票房冠军 [8]  。2013年执导古装喜剧片《西游·降魔篇》，该片以2.18亿美元的票房成绩打破华语电影在全球的票房纪录 [9-10]  。2016年担任科幻喜剧片《美人鱼》的导演、编剧、制作人，该片以超过33亿元的票房创下中国内地电影票房纪录 [11-14]  。2017年1月28日，担任监制、编剧的古装喜剧片《西游伏妖篇》上映 [15]  。2018年执导《美人鱼2》 [16]  。演艺事业外，周星驰还涉足商界。1989年成立星炜有限公司 [17]  。1996年成立星辉公司 [18]  。2010年出任比高集团有限公司执行董事 [19]  。 "</span></span><br><span class="line"><span class="number">6</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/10218&gt;</span></span><br><span class="line">&lt;http:<span class="regexp">//</span>www.kgdemo.com<span class="comment">#movie_bio&gt;</span></span><br><span class="line"><span class="string">" 曾谨昌是香港资深编剧家。他于1981年加入电视广播有限公司(TVB)，编写过多部脍炙人口的电视剧，作品有《白蛇传说》、《长江7号爱地球》等。 "</span></span><br></pre></td></tr></table></figure></p>
<p>c. 实现OWL推理</p>
<p>上一步运行完退出。程序会为我们在当前目录自动创建“run”文件夹实现。将我们的本体文件“kg_movie_tultle.owl”移动到“run”文件夹下的“databases”文件夹中，并将“owl”后缀名改为“ttl”。在“run”文件夹下的“configuration”中，我们创建名为“fuseki_conf.ttl”的文本文件（取名没有要求），加入如下内容：</p>
<p>1) TDB</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">@prefix</span> <span class="string">:</span>       <span class="string">&lt;#&gt;</span> <span class="string">.</span></span><br><span class="line"><span class="string">@prefix</span> <span class="attr">fuseki:</span> <span class="string">&lt;http://jena.apache.org/fuseki#&gt;</span> <span class="string">.</span></span><br><span class="line"><span class="string">@prefix</span> <span class="attr">rdf:</span> 		<span class="string">&lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt;</span> <span class="string">.</span></span><br><span class="line"><span class="string">@prefix</span> <span class="attr">rdfs:</span> 	<span class="string">&lt;http://www.w3.org/2000/01/rdf-schema#&gt;</span> <span class="string">.</span></span><br><span class="line"><span class="string">@prefix</span> <span class="attr">tdb:</span> 		<span class="string">&lt;http://jena.hpl.hp.com/2008/tdb#&gt;</span> <span class="string">.</span></span><br><span class="line"><span class="string">@prefix</span> <span class="attr">ja:</span> 		<span class="string">&lt;http://jena.hpl.hp.com/2005/11/Assembler#&gt;</span> <span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">[]</span> <span class="attr">rdf:type</span> <span class="attr">fuseki:Server</span> <span class="string">;</span></span><br><span class="line"><span class="attr"> fuseki:</span><span class="string">services</span> <span class="string">(</span></span><br><span class="line"> <span class="string">&lt;#service1&gt;</span></span><br><span class="line"> <span class="string">)</span> <span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment">## Service with only SPARQL query on an inference model.</span></span><br><span class="line"><span class="comment">## Inference model base data in TDB.</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;#service1&gt;</span> <span class="attr">rdf:type</span> <span class="attr">fuseki:Service</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    fuseki:</span><span class="string">name</span>         <span class="string">"kg_movie"</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    fuseki:</span><span class="string">endpoint</span> <span class="string">[</span> <span class="attr">fuseki:operation</span> <span class="attr">fuseki:query;</span>  <span class="attr">fuseki:name</span> <span class="string">"sparql"</span>  <span class="string">]</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    fuseki:</span><span class="string">endpoint</span> <span class="string">[</span> <span class="attr">fuseki:operation</span> <span class="attr">fuseki:query;</span>  <span class="attr">fuseki:name</span> <span class="string">"query"</span>   <span class="string">]</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    fuseki:</span><span class="string">endpoint</span> <span class="string">[</span> <span class="attr">fuseki:operation</span> <span class="attr">fuseki:update;</span> <span class="attr">fuseki:name</span> <span class="string">"update"</span>  <span class="string">]</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    fuseki:</span><span class="string">endpoint</span> <span class="string">[</span> <span class="attr">fuseki:operation</span> <span class="attr">fuseki:upload;</span> <span class="attr">fuseki:name</span> <span class="string">"upload"</span>  <span class="string">]</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    fuseki:</span><span class="string">endpoint</span> <span class="string">[</span> <span class="attr">fuseki:operation</span> <span class="attr">fuseki:gsp_r;</span>  <span class="attr">fuseki:name</span> <span class="string">"get"</span>     <span class="string">]</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    fuseki:</span><span class="string">endpoint</span> <span class="string">[</span> <span class="attr">fuseki:operation</span> <span class="attr">fuseki:gsp_rw;</span> <span class="attr">fuseki:name</span> <span class="string">"data"</span>    <span class="string">]</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    fuseki:</span><span class="string">dataset</span>  <span class="string">&lt;#dataset&gt;</span> <span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;#dataset&gt;</span> <span class="attr">rdf:type</span> <span class="attr">tdb:DatasetTDB</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    ja:</span><span class="string">context</span> <span class="string">[</span> <span class="attr">ja:cxtName</span> <span class="string">"arq:queryTimeout"</span> <span class="string">;</span>  <span class="attr">ja:cxtValue</span> <span class="string">"10000,30000"</span> <span class="string">]</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    tdb:</span><span class="string">location</span> <span class="string">"../apache-jena/tdb"</span> <span class="string">.</span></span><br></pre></td></tr></table></figure>
<p>2)  在内存，同步加载本体和三元组</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">@prefix</span> <span class="string">:</span>       <span class="string">&lt;#&gt;</span> <span class="string">.</span></span><br><span class="line"><span class="string">@prefix</span> <span class="attr">fuseki:</span> <span class="string">&lt;http://jena.apache.org/fuseki#&gt;</span> <span class="string">.</span></span><br><span class="line"><span class="string">@prefix</span> <span class="attr">rdf:</span> 		<span class="string">&lt;http://www.w3.org/1999/02/22-rdf-syntax-ns#&gt;</span> <span class="string">.</span></span><br><span class="line"><span class="string">@prefix</span> <span class="attr">rdfs:</span> 	<span class="string">&lt;http://www.w3.org/2000/01/rdf-schema#&gt;</span> <span class="string">.</span></span><br><span class="line"><span class="string">@prefix</span> <span class="attr">tdb:</span> 		<span class="string">&lt;http://jena.hpl.hp.com/2008/tdb#&gt;</span> <span class="string">.</span></span><br><span class="line"><span class="string">@prefix</span> <span class="attr">ja:</span> 		<span class="string">&lt;http://jena.hpl.hp.com/2005/11/Assembler#&gt;</span> <span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">[]</span> <span class="attr">rdf:type</span> <span class="attr">fuseki:Server</span> <span class="string">;</span></span><br><span class="line"><span class="attr"> fuseki:</span><span class="string">services</span> <span class="string">(</span></span><br><span class="line"> <span class="string">&lt;#service1&gt;</span></span><br><span class="line"> <span class="string">)</span> <span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment">## Service with only SPARQL query on an inference model.</span></span><br><span class="line"><span class="comment">## Inference model base data in TDB.</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;#service1&gt;</span> <span class="attr">rdf:type</span> <span class="attr">fuseki:Service</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    fuseki:</span><span class="string">name</span>         <span class="string">"kg_movie"</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    fuseki:</span><span class="string">endpoint</span> <span class="string">[</span> <span class="attr">fuseki:operation</span> <span class="attr">fuseki:query;</span>  <span class="attr">fuseki:name</span> <span class="string">"sparql"</span>  <span class="string">]</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    fuseki:</span><span class="string">endpoint</span> <span class="string">[</span> <span class="attr">fuseki:operation</span> <span class="attr">fuseki:query;</span>  <span class="attr">fuseki:name</span> <span class="string">"query"</span>   <span class="string">]</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    fuseki:</span><span class="string">endpoint</span> <span class="string">[</span> <span class="attr">fuseki:operation</span> <span class="attr">fuseki:update;</span> <span class="attr">fuseki:name</span> <span class="string">"update"</span>  <span class="string">]</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    fuseki:</span><span class="string">endpoint</span> <span class="string">[</span> <span class="attr">fuseki:operation</span> <span class="attr">fuseki:upload;</span> <span class="attr">fuseki:name</span> <span class="string">"upload"</span>  <span class="string">]</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    fuseki:</span><span class="string">endpoint</span> <span class="string">[</span> <span class="attr">fuseki:operation</span> <span class="attr">fuseki:gsp_r;</span>  <span class="attr">fuseki:name</span> <span class="string">"get"</span>     <span class="string">]</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    fuseki:</span><span class="string">endpoint</span> <span class="string">[</span> <span class="attr">fuseki:operation</span> <span class="attr">fuseki:gsp_rw;</span> <span class="attr">fuseki:name</span> <span class="string">"data"</span>    <span class="string">]</span> <span class="string">;</span></span><br><span class="line"><span class="attr">    fuseki:</span><span class="string">dataset</span>  <span class="string">&lt;#dataset&gt;</span> <span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">&lt;#dataset&gt;</span> <span class="attr">rdf:type</span> <span class="attr">ja:RDFDataset</span> <span class="string">;</span></span><br><span class="line">	<span class="attr">ja:defaultGraph</span></span><br><span class="line">      <span class="string">[</span> <span class="string">a</span> <span class="attr">ja:MemoryModel</span> <span class="string">;</span></span><br><span class="line"><span class="attr">        ja:</span><span class="string">content</span> <span class="string">[ja:externalContent</span> <span class="string">&lt;file:../databases/kg_movie_tultle.ttl&gt;</span> <span class="string">]</span> <span class="string">;</span></span><br><span class="line"><span class="attr">        ja:</span><span class="string">content</span> <span class="string">[ja:externalContent</span> <span class="string">&lt;file:../../../d2rq/baidu_baike.nt&gt;</span> <span class="string">]</span> <span class="string">;</span></span><br><span class="line">      <span class="string">]</span> <span class="string">;</span></span><br><span class="line">    <span class="string">.</span></span><br></pre></td></tr></table></figure>
<p>再次运行“fuseki-server.bat”，如果出现如下界面表示运行成功：</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PS C:<span class="symbol">\m</span>y<span class="symbol">\a</span>pache-jena-fuseki&gt; ./fuseki-server</span><br><span class="line">[2019-09-26 10:48:42] Server     INFO  Apache Jena Fuseki 3.12.0</span><br><span class="line">[2019-09-26 10:48:42] Config     INFO  FUSEKI_HOME=C:<span class="symbol">\m</span>y<span class="symbol">\a</span>pache-jena-fuseki<span class="symbol">\.</span></span><br><span class="line">[2019-09-26 10:48:42] Config     INFO  FUSEKI_BASE=C:<span class="symbol">\m</span>y<span class="symbol">\a</span>pache-jena-fuseki<span class="symbol">\r</span>un</span><br><span class="line">[2019-09-26 10:48:42] Config     INFO  Shiro file: file://C:<span class="symbol">\m</span>y<span class="symbol">\a</span>pache-jena-fuseki<span class="symbol">\r</span>un<span class="symbol">\s</span>hiro.ini</span><br><span class="line">[2019-09-26 10:48:42] Config     INFO  Configuration file: C:<span class="symbol">\m</span>y<span class="symbol">\a</span>pache-jena-fuseki<span class="symbol">\r</span>un<span class="symbol">\c</span>onfig.ttl</span><br><span class="line">[2019-09-26 10:48:42] riot       WARN  [line: 5, col: 9 ] Bad IRI: &lt;C:<span class="symbol">\m</span>y<span class="symbol">\a</span>pache-jena-fuseki<span class="symbol">\r</span>un<span class="symbol">\c</span>onfig.ttl#&gt; Code: 4/UNWISE_CHARACTER in PATH: The character matches no grammar rules of URIs/IRIs. These characters are permitted in RDF URI References, XML system identifiers, and XML Schema anyURIs.</span><br><span class="line">[2019-09-26 10:48:43] Config     INFO  Load configuration: file:///C:/my/apache-jena-fuseki/run/configuration/fuseki_conf.ttl</span><br><span class="line">[2019-09-26 10:48:43] Config     INFO  Register: /kg_movie</span><br><span class="line">[2019-09-26 10:48:43] Server     INFO  Started 2019/09/26 10:48:43 CST on port 3030</span><br></pre></td></tr></table></figure>
<p><strong>需要注意的是，每次运行fuseki服务器后，会在TDB文件夹内生成一些以prefix*开头的文件，重新运行fuseki服务的话不删除它们可能会报错。</strong></p>
<p>测试查询,可以通过网页端和命令行方式进行SPQRQL查询，经过实践，发现丧失推理能力。</p>
<p>如：查询电影鹿鼎记的所有属性</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">PREFIX :</span> &lt;<span class="string">http:</span><span class="comment">//www.kgdemo.com#&gt;</span></span><br><span class="line">PREFIX <span class="string">rdf:</span> &lt;<span class="string">http:</span><span class="comment">//www.w3.org/1999/02/22-rdf-syntax-ns#&gt;</span></span><br><span class="line">PREFIX <span class="string">rdfs:</span> &lt;<span class="string">http:</span><span class="comment">//www.w3.org/2000/01/rdf-schema#&gt;</span></span><br><span class="line"></span><br><span class="line">SELECT * WHERE &#123;</span><br><span class="line">?x :movie_chName <span class="string">'鹿鼎记'</span>.</span><br><span class="line">?x ?p ?o.</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回的结果：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">x	p	o</span><br><span class="line"><span class="number">1</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/35&gt;</span></span><br><span class="line">rdfs:label</span><br><span class="line"><span class="string">"movie #35"</span></span><br><span class="line"><span class="number">2</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/35&gt;</span></span><br><span class="line">rdf:type</span><br><span class="line">:Movie</span><br><span class="line"><span class="number">3</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/35&gt;</span></span><br><span class="line">:movie_language</span><br><span class="line"><span class="string">"粤语"</span></span><br><span class="line"><span class="number">4</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/35&gt;</span></span><br><span class="line">:movie_screenwriter</span><br><span class="line"><span class="string">"王晶"</span></span><br><span class="line"><span class="number">5</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/35&gt;</span></span><br><span class="line">:movie_rekeaseTime</span><br><span class="line"><span class="string">"1992年07月30日"</span></span><br><span class="line"><span class="number">6</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/35&gt;</span></span><br><span class="line">:movie_prodTime</span><br><span class="line"><span class="string">"None"</span></span><br><span class="line"><span class="number">7</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/35&gt;</span></span><br><span class="line">:movie_id</span><br><span class="line"><span class="string">"35"</span>^^xsd:integer</span><br><span class="line"><span class="number">8</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/35&gt;</span></span><br><span class="line">:movie_foreName</span><br><span class="line"><span class="string">"Royal Tramp"</span></span><br><span class="line"><span class="number">9</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/35&gt;</span></span><br><span class="line">:movie_genre</span><br><span class="line"><span class="string">"动作"</span></span><br><span class="line"><span class="number">10</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/35&gt;</span></span><br><span class="line">:movie_star</span><br><span class="line"><span class="string">"周星驰，温兆伦，邱淑贞，张敏，吴孟达，徐锦江"</span></span><br><span class="line"><span class="number">11</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/35&gt;</span></span><br><span class="line">:movie_achiem</span><br><span class="line"><span class="string">"None"</span></span><br><span class="line"><span class="number">12</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/35&gt;</span></span><br><span class="line">:movie_chName</span><br><span class="line"><span class="string">"鹿鼎记"</span></span><br><span class="line"><span class="number">13</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/35&gt;</span></span><br><span class="line">:movie_director</span><br><span class="line"><span class="string">"王晶"</span></span><br><span class="line"><span class="number">14</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/35&gt;</span></span><br><span class="line">:movie_prodCompany</span><br><span class="line"><span class="string">"香港永盛电影公司"</span></span><br><span class="line"><span class="number">15</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/35&gt;</span></span><br><span class="line">:movie_bio</span><br><span class="line"><span class="string">" 《鹿鼎记》是改编自金庸小说的一部武侠喜剧。影片由王晶执导，周星驰、吴孟达、温兆伦、林青霞 、 李嘉欣、袁洁莹、邱淑贞、陈德容等联合出演。影片讲述清朝初期，康熙皇帝年少，奸臣鳌拜从中控制政权。韦小宝有幸加入推翻清朝的民间组织“天地会”，被派到王宫当卧底，偷取藏有清朝秘密的四十二章经。韦小宝很快成为皇上的心腹，做了大官。他既要执行任务却又跟皇帝成为了好朋友，陷入了两难的状态。 [1]  该片于1992年7月30日上映。 "</span></span><br><span class="line"><span class="number">16</span>	</span><br><span class="line">&lt;file:<span class="regexp">//</span><span class="regexp">/C:/my</span><span class="regexp">/d2rq/</span>baidu_baike.nt<span class="comment">#movie/35&gt;</span></span><br><span class="line">:movie_length</span><br><span class="line"><span class="string">"106 分钟"</span></span><br></pre></td></tr></table></figure>
<h1 id="三-基于REfO的简单知识问答"><a href="#三-基于REfO的简单知识问答" class="headerlink" title="三. 基于REfO的简单知识问答"></a>三. 基于REfO的简单知识问答</h1><p>项目<a href="https://github.com/Pelhans/Z_knowledge_graph" target="_blank" rel="noopener">从零开始构建知识图谱项目链接</a>是python2编写的，在python3环境下运行需要修改代码</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#word_tagging</span>.py文件</span><br><span class="line">#修改前 word.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">bytes.decode(word.encode(<span class="string">'utf-8'</span>))</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#rules</span>.py文件</span><br><span class="line">#原代码 w<span class="selector-class">.token</span><span class="selector-class">.encode</span>(<span class="string">"utf-8"</span>) </span><br><span class="line">w.token</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#query</span>.py文件</span><br><span class="line">#原代码 raw_input()</span><br><span class="line"><span class="function"><span class="title">input</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>运行，提问示例结果：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">C:\my\Python\python.exe C:/d/mmm/pycharm/patternREfO/query.py</span><br><span class="line">Building<span class="built_in"> prefix </span>dict <span class="keyword">from</span> the<span class="built_in"> default </span>dictionary <span class="built_in">..</span>.</span><br><span class="line">init<span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line">Loading model <span class="keyword">from</span> cache C:\Users\mmm\AppData\Local\Temp\jieba.cache</span><br><span class="line">Loading model cost 0.816 seconds.</span><br><span class="line">Prefix dict has been built succesfully.</span><br><span class="line">done </span><br><span class="line"></span><br><span class="line">Please input your question: </span><br><span class="line">刘德华是哪个</span><br><span class="line">Result:   刘德华（Andy Lau），1961年9月27日出生于中国香港，中国香港男演员、歌手、作词人、制片人。1981年出演电影处女作《彩云曲》 [1]  。1983年主演的武侠剧《神雕侠侣》在香港获得62点的收视纪录 [2-3]  。1991年创办天幕电影公司 [4]  。1992年，凭借传记片《五亿探长雷洛传》获得第11届香港电影金像奖最佳男主角提名 [5]  。1994年担任剧情片《天与地》的制片人 [6]  。2000年凭借警匪片《暗战》获得第19届香港电影金像奖最佳男主角奖 [7]  。2004年凭借警匪片《无间道3：终极无间》获得第41届台湾金马奖最佳男主角奖 [8]  。2005年获得香港UA院线颁发的全港最高累积票房香港男演员”奖 [9]  。2006年获得釜山国际电影节亚洲最有贡献电影人奖 [10]  。2011年主演剧情片《桃姐》，并凭借该片先后获得台湾金马奖最佳男主角奖、香港电影金像奖最佳男主角奖 [11]  ；同年担任第49届台湾电影金马奖评审团主席 [12]  。2017年主演警匪动作片《拆弹专家》 [13]  。1985年发行首张个人专辑《只知道此刻爱你》 [14]  。1990年凭借专辑《可不可以》在歌坛获得关注 [15]  。1994年获得十大劲歌金曲最受欢迎男歌星奖 [16]  。1995年在央视春晚上演唱歌曲《忘情水》 [17]  。2000年被《吉尼斯世界纪录大全》评为“获奖最多的香港男歌手” [18]  。2004年第六次获得十大劲歌金曲最受欢迎男歌星奖。2016年参与填词的歌曲《原谅我》正式发行 [19]  。1994年创立刘德华慈善基金会 [20]  。2000年被评为世界十大杰出青年 [21]  。2005年发起亚洲新星导计划 [22]  。2008年被委任为香港非官守太平绅士 [23]  。2016年连任中国残疾人福利基金会副理事长。 [21]   </span><br><span class="line">Please input your question: </span><br><span class="line">刘德华出生地</span><br><span class="line">Result:  香港新界大埔镇泰亨村</span><br><span class="line">Please input your question: </span><br><span class="line">七小福简介</span><br><span class="line">Result:   《七小福》（Painted Faces）是由罗启锐导演，洪金宝、郑佩佩、林正英、岑建勋、午马等领衔主演的喜剧电影。影片讲述京剧大师于占元当年创办的“中国戏剧研究学院”，名字虽然取得唬人，但要论规模在香港众多戏校中也只算得中等，而且校舍破败，条件简陋，所幸师傅并未误人子弟，教得认真。“七小福“戏班最终名扬天下的故事。</span><br></pre></td></tr></table></figure>
<h1 id="四-基于ElasticSearch的简单语义搜索"><a href="#四-基于ElasticSearch的简单语义搜索" class="headerlink" title="四. 基于ElasticSearch的简单语义搜索"></a>四. 基于ElasticSearch的简单语义搜索</h1><p>ElasticSearch是一个基于<a href="https://baike.baidu.com/item/Lucene/6753302" target="_blank" rel="noopener">Lucene</a>的搜索服务器。它提供了一个分布式多用户能力的全文搜索引擎，基于RESTful web接口。Elasticsearch是用Java语言开发的，并作为Apache许可条款下的开放源码发布，是一种流行的企业级搜索引擎。ElasticSearch用于<a href="https://baike.baidu.com/item/云计算/9969353" target="_blank" rel="noopener">云计算</a>中，能够达到实时搜索，稳定，可靠，快速，安装使用方便。根据DB-Engines的排名显示，Elasticsearch是最受欢迎的企业搜索引擎，其次是Apache Solr，也是基于Lucene。</p>
<h2 id="1-安装"><a href="#1-安装" class="headerlink" title="1. 安装"></a>1. 安装</h2><p><a href="https://www.elastic.co/cn/downloads/elasticsearch" target="_blank" rel="noopener">elasticsearch 官网</a>下载安装包，软件不需要安装，需要配置相应的Java环境。详细使用可阅读<a href="https://protegewiki.stanford.edu/wiki/Main_Page" target="_blank" rel="noopener">官方教程</a>。</p>
<p>运行 <code>./bin/elasticsearch.bat</code>即可开启服务。</p>
<p>在开启服务后，您可以通过 <code>curl &#39;http://localhost:9200&#39;</code>来访问 elasticsearch。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span> : <span class="string">"DESKTOP-3AFDEBF"</span>,</span><br><span class="line">  <span class="attr">"cluster_name"</span> : <span class="string">"elasticsearch"</span>,</span><br><span class="line">  <span class="attr">"cluster_uuid"</span> : <span class="string">"0HpHJxLAREq6SntFdfVSPQ"</span>,</span><br><span class="line">  <span class="attr">"version"</span> : &#123;</span><br><span class="line">    <span class="attr">"number"</span> : <span class="string">"7.4.0"</span>,</span><br><span class="line">    <span class="attr">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="attr">"build_type"</span> : <span class="string">"zip"</span>,</span><br><span class="line">    <span class="attr">"build_hash"</span> : <span class="string">"22e1767283e61a198cb4db791ea66e3f11ab9910"</span>,</span><br><span class="line">    <span class="attr">"build_date"</span> : <span class="string">"2019-09-27T08:36:48.569419Z"</span>,</span><br><span class="line">    <span class="attr">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"lucene_version"</span> : <span class="string">"8.2.0"</span>,</span><br><span class="line">    <span class="attr">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="attr">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-修改代码"><a href="#2-修改代码" class="headerlink" title="2. 修改代码"></a>2. 修改代码</h2><p>项目<a href="https://github.com/Pelhans/Z_knowledge_graph" target="_blank" rel="noopener">从零开始构建知识图谱项目链接</a>是python2编写的，在python3环境下运行需要修改代码</p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#query.py文件</span></span><br><span class="line"><span class="meta">#原代码 raw_input()</span></span><br><span class="line">input()</span><br><span class="line"></span><br><span class="line"><span class="meta">#get_json.py文件</span></span><br><span class="line"><span class="meta">#删除代码</span></span><br><span class="line">import sys</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">#get_ac_attr.py文件</span></span><br><span class="line"><span class="meta">#ahocorasick要安装pyahocorasick(pip install pyahocorasick)</span></span><br><span class="line"><span class="meta">#原代码 cPickle</span></span><br><span class="line">pickle</span><br><span class="line"><span class="meta">#原代码 open(attr_mapping_file)</span></span><br><span class="line">open(attr_mapping_file,<span class="string">'r'</span>,encoding=<span class="string">'UTF-8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">#get_total_val.py文件</span></span><br><span class="line"><span class="meta">#删除代码</span></span><br><span class="line">import sys</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="meta">#原代码  open(__package__ + "/../data/&#123;&#125;.txt".format(cate), "w+")</span></span><br><span class="line">open(<span class="string">"../data/&#123;&#125;.txt"</span>.format(cate), <span class="string">"w+"</span>,encoding=<span class="string">'utf-8'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="meta">#build_dict.py文件</span></span><br><span class="line"><span class="meta">#删除代码</span></span><br><span class="line">import sys</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="meta">#ahocorasick要安装pyahocorasick(pip install pyahocorasick)</span></span><br><span class="line"><span class="meta">#原代码 cPickle</span></span><br><span class="line">pickle</span><br><span class="line"></span><br><span class="line"><span class="meta">#views.py文件</span></span><br><span class="line"><span class="meta">#原代码 cPickle</span></span><br><span class="line">pickle</span><br><span class="line"><span class="meta">#原代码 from Queue import Queue</span></span><br><span class="line">from queue import Queue</span><br></pre></td></tr></table></figure>
<p><strong>可能出现的问题：</strong><br><a href="https://blog.csdn.net/weixin_40771521/article/details/89317180" target="_blank" rel="noopener">python pyahocorasick包安装失败解决方法</a></p>
<h2 id="3-运行"><a href="#3-运行" class="headerlink" title="3. 运行"></a>3. 运行</h2><h3 id="1）数据库到JSON"><a href="#1）数据库到JSON" class="headerlink" title="1）数据库到JSON"></a>1）数据库到JSON</h3><p>运行get_json.py，生成actor.json和movie.json</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\my\Python\python.exe C:<span class="regexp">/d/mmm</span><span class="regexp">/pycharm/</span>elasticsearch<span class="regexp">/utils/g</span>et_json.py</span><br><span class="line">max_id:  <span class="number">13967</span></span><br><span class="line">max_id:  <span class="number">22219</span></span><br><span class="line">tuple index out of range</span><br><span class="line"></span><br><span class="line">Process finished with <span class="keyword">exit</span> code <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h3 id="2）建立属性间映射"><a href="#2）建立属性间映射" class="headerlink" title="2）建立属性间映射"></a>2）建立属性间映射</h3><p>运行get_ac_attr.py，生成./data/attr_ac.pkl</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\my\Python\python.exe C:<span class="regexp">/d/mmm</span><span class="regexp">/pycharm/</span>elasticsearch<span class="regexp">/utils/g</span>et_ac_attr.py</span><br><span class="line"></span><br><span class="line">Process finished with <span class="keyword">exit</span> code <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h3 id="3）获取属性值和属性间的映射"><a href="#3）获取属性值和属性间的映射" class="headerlink" title="3）获取属性值和属性间的映射"></a>3）获取属性值和属性间的映射</h3><p>运行get_total_val.py，生成actor.txt和movie.txt</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\my\Python\python.exe C:<span class="regexp">/d/mmm</span><span class="regexp">/pycharm/</span>elasticsearch<span class="regexp">/utils/g</span>et_total_val.py</span><br><span class="line">max_id:  <span class="number">13967</span></span><br><span class="line">max_id:  <span class="number">22219</span></span><br><span class="line">tuple index out of range</span><br><span class="line"></span><br><span class="line">Process finished with <span class="keyword">exit</span> code <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h3 id="4）在-elasticsearch-中新建-index-和-type"><a href="#4）在-elasticsearch-中新建-index-和-type" class="headerlink" title="4）在 elasticsearch 中新建 index 和 type"></a>4）在 elasticsearch 中新建 index 和 type</h3><p>可以用elasticsearch-head或CURL。</p>
<p>ealsticsearch只是后端提供各种api，那么怎么直观的使用它呢？elasticsearch-head将是一款专门针对于elasticsearch的客户端工具。elasticsearch-head配置包，下载地址：<a href="https://github.com/mobz/elasticsearch-head" target="_blank" rel="noopener">https://github.com/mobz/elasticsearch-head</a> 。安装可以参考文章<a href="https://www.cnblogs.com/hts-technology/p/8477258.html" target="_blank" rel="noopener">windows下安装ElasticSearch的Head插件</a> 。</p>
<p>我们这里选择用CURL，去<a href="https://curl.haxx.se/download.html" target="_blank" rel="noopener">curl官网</a>下载对应版本的包，解压后打开CMD切换到对应目录下运行CURL.exe文件，</p>
<p>如果把该CURL.exe文件复制到C:\Windows\System32目录下，则不需要切换目录，可以直接运行curl命令。</p>
<p>a. 用下列命令建立 index 和 type：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT <span class="string">"localhost:9200/demo?pretty"</span> -H <span class="string">"Content-Type: application/json"</span> -d<span class="string">" &#123; <span class="subst">\"</span>mappings<span class="subst">\"</span>: &#123; <span class="subst">\"</span>properties<span class="subst">\"</span>: &#123; <span class="subst">\"</span>subj<span class="subst">\"</span>: &#123;<span class="subst">\"</span>type<span class="subst">\"</span>: <span class="subst">\"</span>keyword<span class="subst">\"</span>&#125;, <span class="subst">\"</span>po<span class="subst">\"</span>:&#123; <span class="subst">\"</span>type<span class="subst">\"</span>: <span class="subst">\"</span>nested<span class="subst">\"</span>, <span class="subst">\"</span>properties<span class="subst">\"</span>:&#123; <span class="subst">\"</span>pred<span class="subst">\"</span>:&#123;<span class="subst">\"</span>type<span class="subst">\"</span>:<span class="subst">\"</span>keyword<span class="subst">\"</span>&#125;, <span class="subst">\"</span>obj<span class="subst">\"</span>:&#123;<span class="subst">\"</span>type<span class="subst">\"</span>:<span class="subst">\"</span>keyword<span class="subst">\"</span>&#125; &#125; &#125; &#125; &#125; &#125; "</span></span><br></pre></td></tr></table></figure>
<p>运行结果</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:<span class="symbol">\U</span>sers<span class="symbol">\m</span>mm&gt;curl -XPUT "localhost:9200/demo?pretty" -H "Content-Type: application/json" -d" &#123; <span class="symbol">\"</span>mappings<span class="symbol">\"</span>: &#123; <span class="symbol">\"</span>properties<span class="symbol">\"</span>: &#123; <span class="symbol">\"</span>subj<span class="symbol">\"</span>: &#123;<span class="symbol">\"</span>type<span class="symbol">\"</span>: <span class="symbol">\"</span>keyword<span class="symbol">\"</span>&#125;, <span class="symbol">\"</span>po<span class="symbol">\"</span>:&#123; <span class="symbol">\"</span>type<span class="symbol">\"</span>: <span class="symbol">\"</span>nested<span class="symbol">\"</span>, <span class="symbol">\"</span>properties<span class="symbol">\"</span>:&#123; <span class="symbol">\"</span>pred<span class="symbol">\"</span>:&#123;<span class="symbol">\"</span>type<span class="symbol">\"</span>:<span class="symbol">\"</span>keyword<span class="symbol">\"</span>&#125;, <span class="symbol">\"</span>obj<span class="symbol">\"</span>:&#123;<span class="symbol">\"</span>type<span class="symbol">\"</span>:<span class="symbol">\"</span>keyword<span class="symbol">\"</span>&#125; &#125; &#125; &#125; &#125; &#125; "</span><br><span class="line">&#123;</span><br><span class="line">  "acknowledged" : true,</span><br><span class="line">  "shards_acknowledged" : true,</span><br><span class="line">  "index" : "demo"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意：笔者使用的Elasticsearch&gt;7.0，Elasticsearch 7.0及以后版本移除映射类型</strong></p>
<p>b. 可用下列命令查询是否添加成功</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">curl</span> <span class="literal">-</span><span class="comment">XGET</span> <span class="comment">localhost:9200/_search?pretty</span></span><br></pre></td></tr></table></figure>
<p>运行结果<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\mmm&gt;curl -XGET localhost:<span class="number">9200</span>/_search?pretty</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"took"</span> : 3,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="type">false</span>,</span><br><span class="line">  <span class="string">"_shards"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : 1,</span><br><span class="line">    <span class="string">"successful"</span> : 1,</span><br><span class="line">    <span class="string">"skipped"</span> : 0,</span><br><span class="line">    <span class="string">"failed"</span> : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"hits"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : &#123;</span><br><span class="line">      <span class="string">"value"</span> : 0,</span><br><span class="line">      <span class="string">"relation"</span> : "<span class="type">eq</span><span class="string">"</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "</span>max_score<span class="string">" : null,</span></span><br><span class="line"><span class="string">    "</span>hits<span class="string">" : [ ]</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p>
<p>c. 如果创建错了，可用下列命令删除索引</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XDELETE <span class="string">localhost:</span><span class="number">9200</span>/demo</span><br></pre></td></tr></table></figure>
<h3 id="5）数据导入"><a href="#5）数据导入" class="headerlink" title="5）数据导入"></a>5）数据导入</h3><p>Elastic search 7.0及以后版本移除映射类型，修改insert.py</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#原代码 begin_insert_job(<span class="string">"demo"</span>, <span class="string">"baidu_baike"</span>, <span class="string">"../data/baidu_baike.json"</span>)</span><br><span class="line"><span class="function"><span class="title">begin_insert_job</span><span class="params">(<span class="string">"demo"</span>, <span class="string">"_doc"</span>, <span class="string">"../data/baidu_baike.json"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>为了测试简单，把actor.json文件改名为../data/baidu_baike.json。</p>
<p>运行 insert.py</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">C:\my\Python\python.exe C:<span class="regexp">/d/mmm</span><span class="regexp">/pycharm/</span>elasticsearch<span class="regexp">/utils/i</span>nsert.py</span><br><span class="line"><span class="number">1000</span></span><br><span class="line"><span class="number">2000</span></span><br><span class="line"><span class="number">3000</span></span><br><span class="line"><span class="number">4000</span></span><br><span class="line"><span class="number">5000</span></span><br><span class="line"><span class="number">6000</span></span><br><span class="line"><span class="number">7000</span></span><br><span class="line"><span class="number">8000</span></span><br><span class="line"><span class="number">9000</span></span><br><span class="line"><span class="number">10000</span></span><br><span class="line"><span class="number">11000</span></span><br><span class="line"><span class="number">12000</span></span><br><span class="line"><span class="number">13000</span></span><br><span class="line"></span><br><span class="line">Process finished with <span class="keyword">exit</span> code <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h3 id="6）检索知识库"><a href="#6）检索知识库" class="headerlink" title="6）检索知识库"></a>6）检索知识库</h3><p>DOS默认的是（GB2312)，让cmd dos 支持utf-8方法<code>CHCP 65001</code>，关闭cmd，CHCP又还原成936。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">C:</span>\Users\mmm&gt;CHCP <span class="number">65001</span> </span><br><span class="line">Active code <span class="string">page:</span> <span class="number">65001</span></span><br></pre></td></tr></table></figure>
<p>curl方式检索知识库，可用下列命令，如检索：周星驰</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET "localhost:9200/demo/_doc/_search?&amp;pretty" -H "Content-Type:application/json" -d" &#123; <span class="symbol">\"</span>query<span class="symbol">\"</span>:&#123; <span class="symbol">\"</span>bool<span class="symbol">\"</span>:&#123; <span class="symbol">\"</span>filter<span class="symbol">\"</span>:&#123; <span class="symbol">\"</span>term<span class="symbol">\"</span>:&#123;<span class="symbol">\"</span>subj<span class="symbol">\"</span>:<span class="symbol">\"</span><span class="symbol">\u</span>5468<span class="symbol">\u</span>661f<span class="symbol">\u</span>9a70<span class="symbol">\"</span>&#125; &#125; &#125; &#125; &#125;</span><br></pre></td></tr></table></figure>
<p>运行结果<br><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">curl -XGET <span class="string">"localhost:9200/demo/_doc/_search?&amp;pretty"</span> -H <span class="string">"Content-Type:application/json"</span> -d<span class="string">" &#123; \"</span>query\<span class="string">":&#123; \"</span>bool\<span class="string">":&#123; \"</span>filter\<span class="string">":&#123; \"</span>term\<span class="string">":&#123;\"</span>subj\<span class="string">":\"</span>\u5468\u661f\u9a70\<span class="string">"&#125; &#125; &#125; &#125; &#125;"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"took"</span> : 2,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="type">false</span>,</span><br><span class="line">  <span class="string">"_shards"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : 1,</span><br><span class="line">    <span class="string">"successful"</span> : 1,</span><br><span class="line">    <span class="string">"skipped"</span> : 0,</span><br><span class="line">    <span class="string">"failed"</span> : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"hits"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : &#123;</span><br><span class="line">      <span class="string">"value"</span> : 1,</span><br><span class="line">      <span class="string">"relation"</span> : "<span class="type">eq</span><span class="string">"</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "</span>max_score<span class="string">" : 0.0,</span></span><br><span class="line"><span class="string">    "</span>hits<span class="string">" : [</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        "</span>_index<span class="string">" : "</span>demo<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>_type<span class="string">" : "</span>_doc<span class="string">",</span></span><br><span class="line"><span class="string">        "</span>_id<span class="string">" : "</span><span class="number">1</span><span class="string">",</span></span><br><span class="line"><span class="string">        "</span>_score<span class="string">" : 0.0,</span></span><br><span class="line"><span class="string">        "</span>_source<span class="string">" : &#123;</span></span><br><span class="line"><span class="string">          "</span>subj<span class="string">" : "</span>周星驰<span class="string">",</span></span><br><span class="line"><span class="string">          "</span>po<span class="string">" : [</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              "</span>pred<span class="string">" : "</span>actor_bio<span class="string">",</span></span><br><span class="line"><span class="string">              "</span>obj<span class="string">" : "</span> 周星驰，<span class="number">1962</span>年<span class="number">6</span>月<span class="number">22</span>日生于香港，祖籍浙江宁波，中国香港演员、导演、编剧、制作人、商人，毕业于无线电视艺员训练班。<span class="number">1980</span>年成为丽的电视台的特约演员，从而进入演艺圈。<span class="number">1981</span>年出演个人首部电视剧《IQ成熟时》。<span class="number">1988</span>年将演艺事业的重心转向大银幕，并于同年出演电 影处女作《捕风汉子》。<span class="number">1990</span>年凭借喜剧片《一本漫画闯天涯》确立其无厘头的表演风格 [<span class="number">1</span>]  ；同年，因其主演的喜剧动作片《赌圣》打破香港地区票 房纪录而获得关注 [<span class="number">2</span>]  。<span class="number">1991</span>年主演喜剧片《逃学威龙》，并再次打破香港地区票房纪录 [<span class="number">3</span>]  。<span class="number">1995</span>年凭借喜剧爱情片《大话西游》奠定其在华语影 坛的地位。<span class="number">1999</span>年自导自演的喜剧片《喜剧之王》获得香港电影年度票房冠军 [<span class="number">4</span>]  。<span class="number">2002</span>年凭借喜剧片《少林足球》获得第<span class="number">21</span>届香港电影金像奖最佳男 主角奖以及最佳导演奖 [<span class="number">5</span>]  。<span class="number">2003</span>年成为美国《时代周刊》封面人物 [<span class="number">6</span>]  。<span class="number">2005</span>年凭借喜剧动作片《功夫》获得第<span class="number">42</span>届台湾电影金马奖最佳导演奖 [<span class="number">7</span>]  。<span class="number">2008</span>年自导自演的科幻喜剧片《长江<span class="number">7</span>号》获得香港电影年度票房冠军 [<span class="number">8</span>]  。<span class="number">2013</span>年执导古装喜剧片《西游·降魔篇》，该片以<span class="number">2.18</span>亿美元的票房 成绩打破华语电影在全球的票房纪录 [<span class="number">9</span>-<span class="number">10</span>]  。<span class="number">2016</span>年担任科幻喜剧片《美人鱼》的导演、编剧、制作人，该片以超过<span class="number">33</span>亿元的票房创下中国内地电影票房纪录 [<span class="number">11</span>-<span class="number">14</span>]  。<span class="number">2017</span>年<span class="number">1</span>月<span class="number">28</span>日，担任监制、编剧的古装喜剧片《西游伏妖篇》上映 [<span class="number">15</span>]  。<span class="number">2018</span>年执导《美人鱼<span class="number">2</span>》 [<span class="number">16</span>]  。演艺事业外，周星驰 还涉足商界。<span class="number">1989</span>年成立星炜有限公司 [<span class="number">17</span>]  。<span class="number">1996</span>年成立星辉公司 [<span class="number">18</span>]  。<span class="number">2010</span>年出任比高集团有限公司执行董事 [<span class="number">19</span>]  。 <span class="string">"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              "</span>pred<span class="string">" : "</span>actor_foreName<span class="string">",</span></span><br><span class="line"><span class="string">              "</span>obj<span class="string">" : "</span>Stephen Chow<span class="string">"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              "</span>pred<span class="string">" : "</span>actor_nationality<span class="string">",</span></span><br><span class="line"><span class="string">              "</span>obj<span class="string">" : "</span>中国<span class="string">"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              "</span>pred<span class="string">" : "</span>actor_constellation<span class="string">",</span></span><br><span class="line"><span class="string">              "</span>obj<span class="string">" : "</span>巨蟹座<span class="string">"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              "</span>pred<span class="string">" : "</span>actor_birthPlace<span class="string">",</span></span><br><span class="line"><span class="string">              "</span>obj<span class="string">" : "</span>香港<span class="string">"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              "</span>pred<span class="string">" : "</span>actor_birthDay<span class="string">",</span></span><br><span class="line"><span class="string">              "</span>obj<span class="string">" : "</span><span class="number">1962</span>年<span class="number">6</span>月<span class="number">22</span>日<span class="string">"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              "</span>pred<span class="string">" : "</span>actor_repWorks<span class="string">",</span></span><br><span class="line"><span class="string">              "</span>obj<span class="string">" : "</span>赌圣、逃学威龙系列、唐伯虎点秋香、大话西游系列、喜剧之王、少林足球、功夫、长江七号<span class="string">"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              "</span>pred<span class="string">" : "</span>actor_achiem<span class="string">",</span></span><br><span class="line"><span class="string">              "</span>obj<span class="string">" : "</span>获得两届香港电影金像奖最佳影片\n第<span class="number">21</span>届香港电影金像奖最佳导演\n第<span class="number">21</span>届香港电影金像奖最佳男主角\n第<span class="number">42</span>届台湾电影金马奖最佳导演\n第<span class="number">42</span>届台湾电影金马奖最佳剧情片\n\n第<span class="number">25</span>届台湾电影金马奖最佳男配角\n第<span class="number">28</span>届大众电影百花奖优秀故事片\n第<span class="number">23</span>届香港电影评论学会大 奖最佳导演\n第<span class="number">8</span>届香港电影评论学会大奖最佳电影\n第<span class="number">2</span>届香港电影评论学会大奖最佳男主角\n第<span class="number">37</span>届亚太电影节最佳男主角\n第<span class="number">13</span>届亚洲电影博览会最 佳导演\n获得两届香港电影金紫荆奖最佳影片\n第<span class="number">01</span>届香港电影金紫荆奖最佳男主角\n国际杰人会港澳杰人之星等\n收起<span class="string">"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              "</span>pred<span class="string">" : "</span>actor_brokerage<span class="string">",</span></span><br><span class="line"><span class="string">              "</span>obj<span class="string">" : "</span>星辉公司、比高集团<span class="string">"</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">          ]</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p>
<h1 id="五-Deepdive抽取演员-电影间关系"><a href="#五-Deepdive抽取演员-电影间关系" class="headerlink" title="五. Deepdive抽取演员-电影间关系"></a>五. Deepdive抽取演员-电影间关系</h1><p>deepdive是由斯坦福大学InfoLab实验室开发的一个开源知识抽取系统。它通过弱监督学习，从非结构化的文本中抽取结构化的关系数据 。<a href="https://pan.baidu.com/s/1slLpYVz" target="_blank" rel="noopener">本项目CNDeepdive</a>修改了自然语言处理的model包，使它支持中文，并提供中文tutorial。 DeepDive项目处于维护模式，并且不再处于主动开发状态。用户社区保持活跃，但是原始项目成员不能再承诺令人兴奋的新功能/改进或响应请求。有关最新研究，请参阅<a href="https://hazyresearch.github.io/snorkel/" target="_blank" rel="noopener">Snorkel项目</a>或<a href="https://ds3lab.org/~czhang/" target="_blank" rel="noopener">Ce Zhang的项目</a>。 </p>
<p>DeepDive可在macOS，Linux和Docker容器中运行，install.sh脚本文件可以检测当前的安装系统环境，并可以一键式完成安装，安装可以参考文档<a href="https://github.com/theDoctor2013/DeepDive-tutorial/blob/master/Deepdive_new.md" target="_blank" rel="noopener">Deepdive 实战-从下载到跑路</a>。</p>
<p><strong>deepdive在 Ubuntu 17.04下的支持并不好，虽然作者修改安装代码最终也装上了，但是不建议新手来处理。所以推荐Ubuntu 16.04的版本。 </strong><a href="http://old-releases.ubuntu.com/releases/xenial/" target="_blank" rel="noopener">Ubuntu 16.04下载地址</a>，安装Ubuntu主机可参考文章<a href="100590.html">VirtualBox虚拟机安装Ubuntu</a>。</p>
<h2 id="1-安装JDK"><a href="#1-安装JDK" class="headerlink" title="1. 安装JDK"></a>1. 安装JDK</h2><p>1) 设置下载目录</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ubuntu</span>-mmm CNdeepdive]<span class="meta"># cd /usr/local/</span></span><br><span class="line">[root<span class="symbol">@ubuntu</span>-mmm <span class="keyword">local</span>]<span class="meta"># mkdir jdk/</span></span><br><span class="line">[root<span class="symbol">@ubuntu</span>-mmm <span class="keyword">local</span>]<span class="meta"># cd jdk/</span></span><br></pre></td></tr></table></figure>
<p>2) 下载JDK</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu-mmm jdk]# wget https://download.oracle.com/otn/java/jdk/<span class="number">8</span>u221-b11/<span class="number">230d</span>eb18db3e4014bb8e3e<span class="number">8324f81b43</span>/jdk-<span class="number">8</span>u221-linux-x64.tar.gz?AuthParam=<span class="number">1570778301</span>_521350e291b71079469aa571d925a2ec</span><br><span class="line">--<span class="number">2019-10-11</span> <span class="number">14</span>:<span class="number">04</span>:<span class="number">37</span>--  https://download.oracle.com/otn/java/jdk/<span class="number">8</span>u221-b11/<span class="number">230d</span>eb18db3e4014bb8e3e<span class="number">8324f81b43</span>/jdk-<span class="number">8</span>u221-linux-x64.tar.gz?AuthParam=<span class="number">1570778301</span>_521350e291b71079469aa571d925a2ec</span><br><span class="line">正在解析主机 download.oracle.com (download.oracle.com)... <span class="number">23.195.255.150</span></span><br><span class="line">正在连接 download.oracle.com (download.oracle.com)|<span class="number">23.195.255.150</span>|:<span class="number">443</span>... 已连接。</span><br><span class="line">已发出 HTTP 请求，正在等待回应... <span class="number">200</span> OK</span><br><span class="line">长度：<span class="number">195094741</span> (<span class="number">186</span>M) [application/x-gzip]</span><br><span class="line">正在保存至: “jdk-<span class="number">8</span>u221-linux-x64.tar.gz?AuthParam=<span class="number">1570778301</span>_521350e291b71079469aa571d925a2ec”</span><br><span class="line"></span><br><span class="line">r.gz?AuthParam=<span class="number">1570778301</span>_521350e<span class="number">291b7107</span>   <span class="number">5</span>%[===&gt;</span><br></pre></td></tr></table></figure>
<p>3) 解压</p>
<p>使用tar -zxvf 文件名进行解压。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@ubuntu-mmm jdk]</span># <span class="selector-tag">tar</span> <span class="selector-tag">-zxvf</span> <span class="selector-tag">jdk-8u221-linux-x64</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br></pre></td></tr></table></figure>
<p>4) 配置环境变量</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ubuntu</span>-mmm jdk]<span class="meta"># vi /etc/profile</span></span><br></pre></td></tr></table></figure>
<p>将如下配置添加至文件中，然后保存退出。</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#java</span></span><br><span class="line">export JAVA_HOME=<span class="regexp">/usr/local</span><span class="regexp">/jdk/jdk</span>1.<span class="number">8.0_221</span></span><br><span class="line">export PATH=$JAVA_HOME/<span class="symbol">bin:</span>$PATH</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/<span class="class"><span class="keyword">lib</span>/<span class="title">dt</span>.<span class="title">jar</span>:$<span class="title">JAVA_HOME</span>/<span class="title">lib</span></span></span><br></pre></td></tr></table></figure>
<p>执行命令，使文件修改后立即生效<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@ubuntu</span>-mmm jdk]<span class="meta"># source /etc/profile</span></span><br></pre></td></tr></table></figure></p>
<p>5) 验证</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu-mmm <span class="keyword">jdk]# </span><span class="keyword">java </span>-version</span><br><span class="line"></span><br><span class="line"><span class="keyword">java </span>version <span class="string">"1.8.0_221"</span></span><br><span class="line"><span class="keyword">Java(TM) </span>SE Runtime Environment (<span class="keyword">build </span><span class="number">1</span>.<span class="number">8</span>.<span class="number">0</span>_221-<span class="keyword">b11)</span></span><br><span class="line"><span class="keyword">Java </span>HotSpot(TM) <span class="number">64</span>-<span class="keyword">Bit </span>Server VM (<span class="keyword">build </span><span class="number">25</span>.<span class="number">221</span>-<span class="keyword">b11, </span>mixed mode)</span><br></pre></td></tr></table></figure>
<h2 id="2-安装Deepdive"><a href="#2-安装Deepdive" class="headerlink" title="2. 安装Deepdive"></a>2. 安装Deepdive</h2><p>修改install.sh，否则出现报错，无法安装</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 修改前 tar xzvf <span class="string">"<span class="subst">$tarball</span>"</span> -C <span class="string">"<span class="subst">$PREFIX</span>"</span></span><br><span class="line">tar zvf <span class="string">"<span class="subst">$tarball</span>"</span> -C <span class="string">"<span class="subst">$PREFIX</span>"</span></span><br></pre></td></tr></table></figure>
<p>运行install.sh 选择【1 】安装deepdive，选择【6】 安装postgresql。<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@ubuntu-mmm CNdeepdive]# <span class="keyword">cd</span> /usr/<span class="keyword">local</span>/CNdeepdive</span><br><span class="line">[root@ubuntu-mmm CNdeepdive]# bash install.<span class="keyword">sh</span></span><br><span class="line">#运行install.<span class="keyword">sh</span> 分别选择【1 】安装deepdive，选择【6】 安装postgresql。</span><br><span class="line">正在处理用于 dbus (1.10.6-1ubuntu3.3) 的触发器 ...</span><br><span class="line">正在处理用于 <span class="keyword">ca</span>-certificates (20170717~16.04.1) 的触发器 ...</span><br><span class="line">Updating certificates <span class="keyword">in</span> /etc/ssl/certs...</span><br><span class="line">0 added, 0 removed; done.</span><br><span class="line">Running hooks <span class="keyword">in</span> /etc/<span class="keyword">ca</span>-certificates/<span class="keyword">update</span>.<span class="keyword">d</span>...</span><br><span class="line"></span><br><span class="line">done.</span><br><span class="line">done.</span><br><span class="line">+ sudo localedef -i en_US -f UTF-8 en_US.UTF-8</span><br><span class="line">## Finished installation <span class="keyword">for</span> _deepdive_runtime_deps</span><br><span class="line">## Finished installation <span class="keyword">for</span> deepdive</span><br><span class="line">......</span><br><span class="line">+ trap '<span class="keyword">rm</span> -f /tmp/pg_hba.<span class="keyword">conf</span>.ixUUNdF' <span class="keyword">EXIT</span></span><br><span class="line">+ echo 'host	all	all	127.0.0.1/32	trust'</span><br><span class="line">+ echo 'host	all	all	::1/128	trust'</span><br><span class="line">+ sudo <span class="keyword">cat</span> /etc/postgresql/9.5/main/pg_hba.<span class="keyword">conf</span></span><br><span class="line">+ sudo tee /etc/postgresql/9.5/main/pg_hba.<span class="keyword">conf</span></span><br><span class="line">+ sudo service postgresql restart</span><br><span class="line">++ <span class="keyword">rm</span> -f /tmp/pg_hba.<span class="keyword">conf</span>.ixUUNdF</span><br><span class="line">## Finished installation <span class="keyword">for</span> postgres</span><br><span class="line">......</span><br></pre></td></tr></table></figure></p>
<p>配置环境变量，deepdive的可执⾏⽂件⼀般安装在~/local/bin⽂件夹下。 在~/.bashrc 文件的末尾添加下面的内容： </p>
<figure class="highlight julia"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@ubuntu</span>-mmm CNdeepdive]<span class="comment"># vi ~/.bashrc</span></span><br><span class="line"><span class="comment">#添加如下内容</span></span><br><span class="line"><span class="comment">#除了root,其他在/home/(username)/local/bin其中的(username)要替换成你当前登录的用户名</span></span><br><span class="line"><span class="keyword">export</span> PATH=<span class="string">"/root/local/bin:<span class="variable">$PATH</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#来使我们的修改生效。</span></span><br><span class="line">[root<span class="meta">@ubuntu</span>-mmm CNdeepdive]<span class="comment"># source ~/.bashrc</span></span><br></pre></td></tr></table></figure>
<p> 然后执行下面的命令，安装自然语言处理的部分 。</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root<span class="symbol">@ubuntu</span>-mmm:/usr/<span class="keyword">local</span>/CNdeepdive<span class="meta"># bash nlp_setup.sh</span></span><br><span class="line"></span><br><span class="line">Install Dependency.</span><br><span class="line">Denpendency Already Installed.</span><br></pre></td></tr></table></figure>
<p> 好的，到这里Deepdive就已经安装完成了 。</p>
<p> 打开终端执行<code>deepdive</code>我们可以看到Deepdive的版本信息和命令参数的Help。 </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-mmm:/usr/local/CNdeepdive<span class="comment"># deepdive</span></span><br><span class="line"><span class="comment"># DeepDive (v0.8.0-79-g28a58de)</span></span><br><span class="line"><span class="comment"># Usage: deepdive COMMAND [ARG]...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># To enable bash completion for deepdive commands, run:</span></span><br><span class="line">source $(deepdive whereis installed etc/deepdive_bash_completion.sh)</span><br><span class="line"></span><br><span class="line">No COMMAND given</span><br><span class="line"></span><br><span class="line"><span class="comment"># Available COMMANDs are:</span></span><br><span class="line">deepdive  <span class="keyword">check</span>    <span class="comment">#	Checks errors in compiled DeepDive app</span></span><br><span class="line">deepdive  compile  <span class="comment">#	Compiles DeepDive source code into executables under run/</span></span><br><span class="line">deepdive  <span class="keyword">compute</span>  <span class="comment">#	Runs a UDF using a computer against the database</span></span><br><span class="line">deepdive  <span class="keyword">create</span>   <span class="comment">#	Creates a table/view in the database</span></span><br><span class="line">deepdive  db       <span class="comment">#	Exposes lower level database operations provided by the driver</span></span><br><span class="line">deepdive  <span class="keyword">do</span>       <span class="comment">#	Runs necessary processes to get something done</span></span><br><span class="line">deepdive  done     <span class="comment">#	Checks whether given targets are all done</span></span><br><span class="line">deepdive  env      <span class="comment">#	Runs commands inside DeepDive's environment</span></span><br><span class="line">deepdive  <span class="keyword">help</span>     <span class="comment">#	Shows help</span></span><br><span class="line">deepdive  initdb   <span class="comment">#	(DEPRECATED) Initializes the underlying database for the DeepDive application</span></span><br><span class="line">deepdive  <span class="keyword">load</span>     <span class="comment">#	Loads a given relation's data</span></span><br><span class="line">deepdive  mark     <span class="comment">#	Marks state of something to do</span></span><br><span class="line">deepdive  <span class="keyword">model</span>    <span class="comment">#	Supports working with the statistical inference model</span></span><br><span class="line">deepdive  plan     <span class="comment">#	Shows execution plan for given targets</span></span><br><span class="line">deepdive  <span class="keyword">query</span>    <span class="comment">#	Runs a DDlog query against the database for the DeepDive application</span></span><br><span class="line">deepdive  <span class="keyword">redo</span>     <span class="comment">#	Runs processes after marking them as 'todo'</span></span><br><span class="line">deepdive  run      <span class="comment">#	Runs the current DeepDive app end-to-end</span></span><br><span class="line">deepdive  <span class="keyword">sql</span>      <span class="comment">#	Runs a SQL query against the database for the DeepDive application</span></span><br><span class="line">deepdive  unload   <span class="comment">#	Unloads a given relation's data</span></span><br><span class="line">deepdive  <span class="keyword">version</span>  <span class="comment">#	show deepdive's version and build information</span></span><br><span class="line">deepdive  whereis  <span class="comment">#	Finds absolute paths to files in the app or DeepDive installation</span></span><br></pre></td></tr></table></figure>
<h2 id="3-建立postgresql的数据库movie"><a href="#3-建立postgresql的数据库movie" class="headerlink" title="3. 建立postgresql的数据库movie"></a>3. 建立postgresql的数据库movie</h2><p><a href="https://www.navicat.com.cn/download/navicat-premium" target="_blank" rel="noopener">Navicat Premium</a>，是一套数据库开发工具，让你从单一应用程序中同时连接 MySQL、MariaDB、MongoDB、SQL Server、Oracle、PostgreSQL 和 SQLite 数据库。Navicat系列破解工具链接：<a href="https://pan.baidu.com/s/1KmH2aaESpjozQaxr2C7D2A" target="_blank" rel="noopener">https://pan.baidu.com/s/1KmH2aaESpjozQaxr2C7D2A</a></p>
<p>可以使用它来管理PostgreSQL数据库，Navicat连接PostgreSQL，PostgreSQL需要进行如下配置：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>. 通过<span class="keyword">find</span> / -name  postgresql.<span class="keyword">conf</span> 和 <span class="keyword">find</span> / -name pg_hba.<span class="keyword">conf</span> 找到这两个文件</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>. 设置外网访问：</span><br><span class="line"></span><br><span class="line">     <span class="number">1</span>）修改配置文件 postgresql.<span class="keyword">conf</span></span><br><span class="line">           listen_addresses = <span class="string">'*'</span></span><br><span class="line">     <span class="number">2</span>）修改pg_hba.<span class="keyword">conf</span>       在原来的host下面新加一行</span><br><span class="line">           # IPv4 local connection<span class="variable">s:</span></span><br><span class="line">           host    <span class="keyword">all</span>             <span class="keyword">all</span>             <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">32</span>            trust</span><br><span class="line">           host    <span class="keyword">all</span>             <span class="keyword">all</span>             <span class="number">0.0</span>.<span class="number">0.0</span>/<span class="number">0</span>               password</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>. 重新启动服务：service postgresql restart</span><br></pre></td></tr></table></figure>
<p><strong>在这里我们不使用navicat，可以不安装。</strong></p>
<p>运行 <code>sudo -u postgres createdb</code> 建立数据库movie</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root<span class="symbol">@ubuntu</span>-mmm:CNdeepdive<span class="meta"># sudo -u postgres createdb movie</span></span><br></pre></td></tr></table></figure>
<p>如果要删除数据，可以使用下面命令<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root<span class="symbol">@ubuntu</span>-mmm:CNdeepdive<span class="meta"># sudo -u postgres dropdb movie</span></span><br></pre></td></tr></table></figure></p>
<p>验证数据库是否创建成功，首先运行sudo -i -u postgres 进入到postgresql账户</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root<span class="symbol">@ubuntu</span>-mmm:/usr/<span class="keyword">local</span>/CNdeepdive<span class="meta"># sudo -i -u postgres</span></span><br></pre></td></tr></table></figure>
<p> 输入psql进入到postgresql命令界面</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">postgres@ubuntu-mmm:~$ psql</span><br><span class="line">psql (9.5.19)</span><br><span class="line">Type <span class="string">"help"</span> <span class="keyword">for</span> help.</span><br><span class="line"></span><br><span class="line"><span class="attribute">postgres</span>=#</span><br></pre></td></tr></table></figure>
<p> 修改PostgreSQL登录密码：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">postgres</span>=# ALTER USER postgres WITH PASSWORD <span class="string">'postgres'</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">ALTER ROLE</span></span><br></pre></td></tr></table></figure>
<p>查看数据库列表</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">postgres=<span class="comment"># \l</span></span><br><span class="line">                                  List of databases</span><br><span class="line">   Name    |<span class="string">  Owner   </span>|<span class="string"> Encoding </span>|<span class="string">   Collate   </span>|<span class="string">    Ctype    </span>|<span class="string">   Access privileges   </span></span><br><span class="line"><span class="string">-----------+----------+----------+-------------+-------------+-----------------------</span></span><br><span class="line"><span class="string"> movie     </span>|<span class="string"> postgres </span>|<span class="string"> UTF8     </span>|<span class="string"> zh_CN.UTF-8 </span>|<span class="string"> zh_CN.UTF-8 </span>|<span class="string"> </span></span><br><span class="line"><span class="string"> postgres  </span>|<span class="string"> postgres </span>|<span class="string"> UTF8     </span>|<span class="string"> zh_CN.UTF-8 </span>|<span class="string"> zh_CN.UTF-8 </span>|<span class="string"> </span></span><br><span class="line"><span class="string"> template0 </span>|<span class="string"> postgres </span>|<span class="string"> UTF8     </span>|<span class="string"> zh_CN.UTF-8 </span>|<span class="string"> zh_CN.UTF-8 </span>|<span class="string"> =c/postgres          +</span></span><br><span class="line"><span class="string">           </span>|<span class="string">          </span>|<span class="string">          </span>|<span class="string">             </span>|<span class="string">             </span>|<span class="string"> postgres=CTc/postgres</span></span><br><span class="line"><span class="string"> template1 </span>|<span class="string"> postgres </span>|<span class="string"> UTF8     </span>|<span class="string"> zh_CN.UTF-8 </span>|<span class="string"> zh_CN.UTF-8 </span>|<span class="string"> =c/postgres          +</span></span><br><span class="line"><span class="string">           </span>|<span class="string">          </span>|<span class="string">          </span>|<span class="string">             </span>|<span class="string">             </span>|<span class="string"> postgres=CTc/postgres</span></span><br><span class="line"><span class="string">(4 rows)</span></span><br></pre></td></tr></table></figure>
<p>输入\q退出psql。 </p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postgres-<span class="meta"># \q</span></span><br></pre></td></tr></table></figure>
<p>运行’’’su yourusername’’’ 回到自己的程序目录。 </p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">postgres<span class="variable">@ubuntu</span>-<span class="symbol">mmm:</span>~<span class="variable">$ </span>su root</span><br></pre></td></tr></table></figure>
<h2 id="4-项目框架搭建"><a href="#4-项目框架搭建" class="headerlink" title="4. 项目框架搭建"></a>4. 项目框架搭建</h2><p>这部分的数据和代码以及程序都在前面我们解压后的<em>CNdeepdive/transaction</em>中，你可以把这个目录复制到你喜欢的地方（比如<em>~/Projects/transaction</em> 这个位置），然后再新建一个目录，可以叫做<em>transaction2</em> 我们后面的所有工作都是在这个<strong>transaction2</strong>目录中进行的，后面简称它为项目目录。 </p>
<p>建⽴⾃⼰的项⽬⽂件夹transaction2，之前已在postgresql中为项⽬建⽴数据库movie，现要在项⽬⽂件夹下建⽴数据库配置⽂件: </p>
<p>命令说明<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"postgresql://<span class="variable">$USER</span>@<span class="variable">$HOSTNAME</span>:5432/db_name"</span> &gt;db.url</span><br><span class="line"><span class="comment">#$符号是shell中用来表示变量的，所以这个蓝色部分大概就是 用户名@主机名：。。。。</span></span><br><span class="line"><span class="comment">#db_name 我们这个项目的数据库名，也可以自定义。</span></span><br></pre></td></tr></table></figure></p>
<p>创建命令<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-<span class="symbol">mmm:</span>/var/<span class="class"><span class="keyword">lib</span>/<span class="title">postgresql</span><span class="comment"># cd /usr/local/CNdeepdive</span></span></span><br><span class="line">root@ubuntu-<span class="symbol">mmm:</span>/usr/local/CNdeepdive<span class="comment"># mkdir transaction2/</span></span><br><span class="line">root@ubuntu-<span class="symbol">mmm:</span>/usr/local/CNdeepdive<span class="comment"># cd transaction2</span></span><br><span class="line">root@ubuntu-<span class="symbol">mmm:</span>/usr/local/CNdeepdive/transaction2<span class="comment"># echo "postgresql://localhost:5432/movie" &gt;db.url</span></span><br></pre></td></tr></table></figure></p>
<p>在deepdive内建立输入数据文件夹 input，用户定义函数文件夹udf，用户配置文件app.ddlog，模型配置文件deepdive.conf。</p>
<p>为了调用 stanford_nlp 进行文本处理，将下载的CNdeepdive 文件夹中的transaction/udf/bazzar复制到自己的 udf 文件夹下，并在udf/bazzar/parser/ 目录下运行 sbt/sbt stage 进行编译。编译完成后会在 target 中生成可执行文件。</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-mmm:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2/udf/bazaar/parser# chmod 777 sbt/sbt</span><br><span class="line">#获得执行权限</span><br><span class="line">root@ubuntu-mmm:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2/udf/bazaar/parser# sbt/sbt stage</span><br><span class="line"></span><br><span class="line">Getting org.<span class="keyword">scala</span>-sbt sbt 0.13.8 ...</span><br><span class="line">:: retrieving :: org.<span class="keyword">scala</span>-sbt#<span class="keyword">boot</span>-<span class="keyword">app</span></span><br><span class="line">	confs: [default]</span><br><span class="line">	52 artifacts copied, 0 already retrieved (17674kB/165ms)</span><br><span class="line">Getting <span class="keyword">Scala</span> 2.10.4 (<span class="keyword">for</span> sbt)...</span><br><span class="line">:: retrieving :: org.<span class="keyword">scala</span>-sbt#<span class="keyword">boot</span>-<span class="keyword">scala</span></span><br><span class="line">	confs: [default]</span><br><span class="line">	5 artifacts copied, 0 already retrieved (24459kB/108ms)</span><br><span class="line">[info] Loading project definition from /usr/<span class="keyword">local</span>/CNdeepdive/transaction2/udf/bazaar/parser/project/project</span><br><span class="line">[info] Updating &#123;<span class="keyword">file</span>:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2/udf/bazaar/parser/project/project/&#125;parser-build-build...</span><br><span class="line">[info] Resolving org.fusesource.jansi#jansi;1.4 ...</span><br><span class="line">[info] Done updating.</span><br><span class="line">[info] Loading project definition from /usr/<span class="keyword">local</span>/CNdeepdive/transaction2/udf/bazaar/parser/project</span><br><span class="line">[info] Updating &#123;<span class="keyword">file</span>:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2/udf/bazaar/parser/project/&#125;parser-build...</span><br><span class="line">[info] Resolving org.fusesource.jansi#jansi;1.4 ...</span><br><span class="line">[info] Done updating.</span><br><span class="line">[info] <span class="keyword">Set</span> current project to deepdive-nlp-parser (<span class="keyword">in</span> build <span class="keyword">file</span>:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2/udf/bazaar/parser/)</span><br><span class="line">[info] Updating &#123;<span class="keyword">file</span>:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2/udf/bazaar/parser/&#125;parser...</span><br><span class="line">[info] Resolving org.fusesource.jansi#jansi;1.4 ...</span><br><span class="line">[info] Done updating.</span><br><span class="line">[warn] <span class="keyword">Scala</span> <span class="keyword">version</span> was updated <span class="keyword">by</span> <span class="keyword">one</span> of library dependencies:</span><br><span class="line">[warn] 	* org.<span class="keyword">scala</span>-lang:<span class="keyword">scala</span>-library:(2.10.3, 2.10.4, 2.10.2, 2.10.0) -&gt; 2.10.5</span><br><span class="line">[warn] To force scalaVersion, add the following:</span><br><span class="line">[warn] 	ivyScala := ivyScala.value map &#123; _.<span class="keyword">copy</span>(overrideScalaVersion = true) &#125;</span><br><span class="line">[warn] <span class="keyword">Run</span> 'evicted' to see detailed eviction warnings</span><br><span class="line">[info] Compiling 6 <span class="keyword">Scala</span> sources to /usr/<span class="keyword">local</span>/CNdeepdive/transaction2/udf/bazaar/parser/target/<span class="keyword">scala</span>-2.10/classes...</span><br><span class="line">[info] Wrote start script <span class="keyword">for</span> mainClass := Some(com.clearcut.nlp.Main) to /usr/<span class="keyword">local</span>/CNdeepdive/transaction2/udf/bazaar/parser/target/start</span><br><span class="line">[success] <span class="keyword">Total</span> time: 18 s, completed 2019-10-15 16:10:54</span><br></pre></td></tr></table></figure>
<h2 id="5-修改代码"><a href="#5-修改代码" class="headerlink" title="5. 修改代码"></a>5. 修改代码</h2><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#udf/get_actor_movie.py文件</span></span><br><span class="line"><span class="meta">#删除代码</span></span><br><span class="line">import sys</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="meta">#原代码  open(out_name,'w')</span></span><br><span class="line">open(out_name,<span class="string">'w'</span>,encoding=<span class="string">'UTF-8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">#baidu_baike.py文件</span></span><br><span class="line"><span class="meta">#修改前 urlparse.urljoin</span></span><br><span class="line">urllib.parse.urljoin</span><br><span class="line"><span class="meta">#修改前 urlparse</span></span><br><span class="line">urllib</span><br><span class="line"></span><br><span class="line"><span class="meta">#pipelines.py文件</span></span><br><span class="line"><span class="meta">#修改前 open("articles.txt", "a+")</span></span><br><span class="line">open(<span class="string">"articles.txt"</span>, <span class="string">"a+"</span>,encoding=<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="meta">#修改# process info for actor后3行代码为下面</span></span><br><span class="line">articles = bytes.decode(str(item[<span class="string">'articles'</span>]).encode(<span class="string">'utf-8'</span>)).replace(<span class="string">"\n"</span>, <span class="string">" "</span>)</span><br><span class="line">article_id = bytes.decode(str(item[<span class="string">'article_id'</span>]).encode(<span class="string">'utf-8'</span>))</span><br><span class="line">self.article_file.write(article_id + <span class="string">","</span> + articles + <span class="string">"\n"</span>)</span><br><span class="line"><span class="meta">#修改前 .decode('utf-8')</span></span><br><span class="line">.encode(<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="meta">#删除代码</span></span><br><span class="line">import sys</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf-8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">#trans.py文件</span></span><br><span class="line"><span class="meta">#修改前 open("./articles.txt")</span></span><br><span class="line">open(<span class="string">"baidu_baike/articles.txt"</span>,encoding=<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="meta">#修改前 open("./articles_new.csv", "w+")</span></span><br><span class="line">open(<span class="string">"./articles_new.csv"</span>, <span class="string">"w+"</span>,encoding=<span class="string">'utf-8'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="6-先验数据导入"><a href="#6-先验数据导入" class="headerlink" title="6. 先验数据导入"></a>6. 先验数据导入</h2><p>用mysql导出工具把actor_to_movie表的数据导出到actor_movie.txt文件，数据格式如下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#actor_id movie_id</span><br><span class="line"><span class="number">900</span> <span class="number">1</span></span><br><span class="line"><span class="number">10426</span> <span class="number">9</span></span><br><span class="line"><span class="number">9412</span> <span class="number">11</span></span><br><span class="line"><span class="number">8792</span> <span class="number">25</span></span><br></pre></td></tr></table></figure>
<p> 运行udf/get_actor_movie.py 获取 input/actor_movie_dbdata.csv 文件 </p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\my\Python\python.exe C:<span class="regexp">/d/mmm</span><span class="regexp">/pycharm/</span>deepdive<span class="regexp">/udf/g</span>et_actor_movie.py</span><br><span class="line"></span><br><span class="line">Process finished with <span class="keyword">exit</span> code <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p> app.ddlog 中定义相应的数据表，文件内容如下: </p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@source</span></span><br><span class="line">actor_movie_dbdata(</span><br><span class="line">    <span class="variable">@key</span></span><br><span class="line">    actor_name text,</span><br><span class="line">    <span class="variable">@key</span></span><br><span class="line">    movie_name text</span><br><span class="line">).</span><br></pre></td></tr></table></figure>
<p>而后通过命令行生成 postgresql 数据表 </p>
<p> a. 行编译操作，也就是在项目目录执行下面的命令： </p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-mmm:/usr/local/CNdeepdive/transaction2# deepdive compile</span><br><span class="line"></span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:51.779111 ‘run/LATEST.COMPILE’ -&gt; ‘20191016/152551.724661396’</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:51.784188 ‘run/RUNNING.COMPILE’ -&gt; ‘20191016/152551.724661396’</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:51.784488 Parsing DeepDive application (/usr/local/CNdeepdive/transaction2) to generate:</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:51.784700  run/compiled/schema.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:51.784902   from app.ddlog</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:52.230712  run/compiled/deepdive.conf</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:52.230760   from app.ddlog</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:52.739134   from deepdive.conf</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:52.740832  run/compiled/deepdive.conf.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.062665 Performing sanity checks on run/compiled/deepdive.conf.json:</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.090525  checking if input_extractors_well_defined</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.090609  checking if input_schema_wellformed</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.090621 Normalizing and adding built-in processes to the data flow to compile:</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.090631  run/compiled/config<span class="string">-0</span>.00-init_objects.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.101117  run/compiled/config<span class="string">-0</span>.01-parse_calibration.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.108870  run/compiled/config<span class="string">-0</span>.01-parse_schema.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.126399  run/compiled/config<span class="string">-0</span>.51-add_init_app.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.132111  run/compiled/config<span class="string">-0</span>.52-input_loader.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.144006  run/compiled/config<span class="string">-1</span>.00-qualified_names.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.158387  run/compiled/config<span class="string">-1</span>.01-parse_inference_rules.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.185708  run/compiled/config<span class="string">-2</span>.01-grounding.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.287285  run/compiled/config<span class="string">-2</span>.02-learning_inference.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.303617  run/compiled/config<span class="string">-2</span>.03-calibration_plots.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.314917  run/compiled/config<span class="string">-9</span>.98-ensure_init_app.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.324952  run/compiled/config<span class="string">-9</span>.99-dependencies.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.336073  run/compiled/config.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.337028 Validating run/compiled/config.json:</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.382982  checking if compiled_base_relations_have_input_data</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.383035  checking if compiled_dependencies_correct</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.383047  checking if compiled_input_output_well_defined</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.383056  checking if compiled_output_uniquely_defined</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.383064 Compiling executable code into:</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.383073  run/compiled/code-cmd_extractor.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.401750  run/compiled/code-dataflow_dot.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.417009  run/compiled/code-Makefile.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.435906  run/compiled/code-sql_extractor.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.447180  run/compiled/code-tsv_extractor.json</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.461059 Generating files:</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.471287  run/process/init/app/run.sh</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.478829  run/process/init/relation/actor_movie_dbdata/run.sh</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.482429  run/dataflow.dot</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.484349  run/Makefile</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.541030  run/dataflow.svg</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.543347   (file:///usr/local/CNdeepdive/transaction2/run/dataflow.svg)</span><br><span class="line">2019<span class="string">-10</span><span class="string">-16</span> 15:25:53.544398 ‘run/compiled’ -&gt; ‘20191016/152551.724661396’</span><br></pre></td></tr></table></figure>
<p> 编译完成后，我们要执行</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-mmm:/usr/local/CNdeepdive/transaction2# deepdive do actor_movie_dbdata</span><br><span class="line"></span><br><span class="line"># on ubuntu-mmm: deepdive do actor_movie_dbdata</span><br><span class="line"># run/<span class="number">20191016</span>/<span class="number">152600.104675031</span>/plan.sh</span><br><span class="line"># execution plan for data/actor_movie_dbdata</span><br><span class="line"></span><br><span class="line">## process/init/app ##########################################################</span><br><span class="line"># Done: N/A</span><br><span class="line">process/init/app/run.sh</span><br><span class="line">mark_done process/init/app</span><br><span class="line">##############################################################################</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## process/init/relation/actor_movie_dbdata ##################################</span><br><span class="line"># Done: N/A</span><br><span class="line">process/init/relation/actor_movie_dbdata/run.sh</span><br><span class="line">mark_done process/init/relation/actor_movie_dbdata</span><br><span class="line">##############################################################################</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## data/actor_movie_dbdata ###################################################</span><br><span class="line"># Done: N/A</span><br><span class="line"># no-op</span><br><span class="line">mark_done data/actor_movie_dbdata</span><br><span class="line">##############################################################################</span><br></pre></td></tr></table></figure>
<p>这里<code>do</code> 后面应该和我们<code>app.ddlog</code> 中的名字相同，和<code>input</code> 文件夹中的文件名也相同，他们三个应该都是一致的。他会把input文件中的对应的文件导入postgresql数据库中。注意这个语句执行后，他会进入一个类似vi的界面让你审查他自动生成的处理代码是不是正确，这时候输入<code>：wq</code> 就可以保存并退出，继续执行后面的步骤。运行结果 如下：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.793180</span> </span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.793341</span> : ## process/init/app ##########################################################</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.793549</span> : # Done: <span class="number">2019</span><span class="number">-10</span><span class="number">-16</span>T15:<span class="number">31</span>:<span class="number">00</span>+<span class="number">0800</span> (<span class="number">5</span>m <span class="number">42</span>s ago)</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.793734</span> : process/init/app/run.sh</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.793938</span> : mark_done process/init/app</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.795712</span> : ##############################################################################</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.795906</span> </span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.796165</span> </span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.796308</span> ## process/init/relation/actor_movie_dbdata ##################################</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.796550</span> # Done: N/A</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.796758</span> process/init/relation/actor_movie_dbdata/run.sh</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.797006</span> ++ dirname process/init/relation/actor_movie_dbdata/run.sh</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.797202</span> + cd process/init/relation/actor_movie_dbdata</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.797407</span> + <span class="keyword">export</span> DEEPDIVE_CURRENT_PROCESS_NAME=process/init/relation/actor_movie_dbdata</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.797677</span> + DEEPDIVE_CURRENT_PROCESS_NAME=process/init/relation/actor_movie_dbdata</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.797987</span> + deepdive create table actor_movie_dbdata</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.885518</span> CREATE TABLE</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.886898</span> + deepdive load actor_movie_dbdata</span><br><span class="line">loading actor_movie_dbdata: <span class="number">0</span>:<span class="number">00</span>:<span class="number">00</span>  <span class="number">179</span>KiB [ <span class="number">816</span>MiB/s] ([ <span class="number">816</span>MiB/s])r_movie_dbdata.csv (csv format)</span><br><span class="line">loading actor_movie_dbdata: <span class="number">0</span>:<span class="number">00</span>:<span class="number">00</span> <span class="number">5.94</span>k [ <span class="number">123</span>k/s] ([ <span class="number">123</span>k/s])</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.996248</span> COPY <span class="number">5943</span></span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">50.998965</span> mark_done process/init/relation/actor_movie_dbdata</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">51.003297</span> ##############################################################################</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">51.003373</span> </span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">51.003386</span> </span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">51.003397</span> ## data/actor_movie_dbdata ###################################################</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">51.003408</span> # Done: N/A</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">51.003436</span> # no-op</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">51.003467</span> mark_done data/actor_movie_dbdata</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">51.006529</span> ##############################################################################</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">51.006568</span> </span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">15</span>:<span class="number">36</span>:<span class="number">51.006580</span> </span><br><span class="line">‘run/FINISHED’ -&gt; ‘<span class="number">20191016</span>/<span class="number">153642.492053809</span>’</span><br></pre></td></tr></table></figure>
<p> 执行完成后，可以执行下面代码在数据库中查询，看看是不是成功导入了 </p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-mmm:/usr/local/CNdeepdive/transaction2# deepdive query <span class="emphasis">'?- actor_movie_dbdata(actor_name, _).'</span></span><br><span class="line"></span><br><span class="line"><span class="code">                                actor_name                                </span></span><br><span class="line">--------------------------------------------------------------------------</span><br><span class="line"><span class="code"> 周星驰</span></span><br><span class="line"><span class="code"> 周星驰</span></span><br><span class="line"><span class="code"> Stephen Chow</span></span><br><span class="line"><span class="code"> Stephen Chow</span></span><br><span class="line"><span class="code"> 周星驰</span></span><br><span class="line"><span class="code"> 周星驰</span></span><br><span class="line"><span class="code"> Stephen Chow</span></span><br><span class="line"><span class="code"> Stephen Chow</span></span><br><span class="line"><span class="code"> 周星驰</span></span><br><span class="line"><span class="code"> 周星驰</span></span><br><span class="line"><span class="code"> Stephen Chow</span></span><br><span class="line"><span class="code"> Stephen Chow</span></span><br><span class="line"><span class="code"> 周星驰</span></span><br><span class="line"><span class="code"> 周星驰</span></span><br><span class="line"><span class="code"> Stephen Chow</span></span><br><span class="line"><span class="code"> Stephen Chow</span></span><br><span class="line"><span class="code"> 车保罗</span></span><br><span class="line"><span class="code"> 车保罗</span></span><br><span class="line"><span class="code"> Paul Che</span></span><br><span class="line"><span class="code"> Paul Che</span></span><br><span class="line"><span class="code"> 张学友</span></span><br><span class="line"><span class="code"> 张学友</span></span><br><span class="line"><span class="code"> Jacky Cheung</span></span><br><span class="line"><span class="code"> Jacky Cheung</span></span><br><span class="line"><span class="code"> 章子怡</span></span><br><span class="line"><span class="code"> Zhang Ziyi</span></span><br><span class="line"><span class="code"> 章子怡</span></span><br><span class="line"><span class="code"> Zhang Ziyi</span></span><br><span class="line"><span class="code"> 章子怡</span></span><br></pre></td></tr></table></figure>
<h2 id="7-待抽取文章的导入"><a href="#7-待抽取文章的导入" class="headerlink" title="7. 待抽取文章的导入"></a>7. 待抽取文章的导入</h2><p> 为了获取到大量的电影和演员相关文章，我们直接套用之前的半结构化数据爬虫来获取非结构文本。 </p>
<p>cmd中执行命令：scrapy crawl 项目名</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PS <span class="string">C:</span>\d\mmm\pycharm\deepdive\udf\baidu_baike\baidu_baike&gt; scrapy crawl baidu</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">06</span> [scrapy.utils.log] <span class="string">INFO:</span> Scrapy <span class="number">1.7</span><span class="number">.3</span> started (<span class="string">bot:</span> baidu_baike)</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">06</span> [scrapy.utils.log] <span class="string">INFO:</span> <span class="string">Versions:</span> lxml <span class="number">4.4</span><span class="number">.1</span><span class="number">.0</span>, libxml2 <span class="number">2.9</span><span class="number">.5</span>, cssselect <span class="number">1.1</span><span class="number">.0</span>, parsel <span class="number">1.5</span><span class="number">.2</span>, w3lib <span class="number">1.21</span><span class="number">.0</span>, Twisted <span class="number">19.7</span><span class="number">.0</span>, Python <span class="number">3.7</span><span class="number">.4</span> (tags/v3<span class="number">.7</span><span class="number">.4</span>:e09359112e, Jul  <span class="number">8</span> <span class="number">2019</span>, <span class="number">20</span>:<span class="number">34</span>:<span class="number">20</span>) [MSC v<span class="number">.1916</span> <span class="number">64</span> bit (AMD64)], pyOpenSSL <span class="number">19.0</span><span class="number">.0</span> (OpenSSL <span class="number">1.1</span><span class="number">.1</span>c  <span class="number">28</span> May <span class="number">2019</span>), cryptography <span class="number">2.7</span>, Platform Windows<span class="number">-10</span><span class="number">-10.0</span><span class="number">.18362</span>-SP0</span><br><span class="line"><span class="number">2019</span><span class="number">-10</span><span class="number">-16</span> <span class="number">16</span>:<span class="number">06</span>:<span class="number">06</span> [scrapy.crawler] <span class="string">INFO:</span> Overridden <span class="string">settings:</span> &#123;<span class="string">'BOT_NAME'</span>: <span class="string">'baidu_baike'</span>, <span class="string">'NEWSPIDER_MODULE'</span>: <span class="string">'baidu_baike.spiders'</span>, <span class="string">'SPIDER_MODULES'</span>: [<span class="string">'baidu_baike.spiders'</span>], <span class="string">'USER_AGENT'</span>: <span class="string">'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36'</span>&#125;</span><br></pre></td></tr></table></figure>
<p> 接下来为了将其导入到数据库中，需要将其转换为csv格式，这里可以使用程序 udf/trans.py 进行转换。再更改名字即可。 </p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\my\Python\python.exe C:<span class="regexp">/d/mmm</span><span class="regexp">/pycharm/</span>deepdive<span class="regexp">/udf/</span>trans.py</span><br><span class="line"></span><br><span class="line">Process finished with <span class="keyword">exit</span> code <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p> 在 app.ddlog 中建立相应的 articles 表： </p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@source</span><br><span class="line">articles(</span><br><span class="line">        <span class="built_in">id</span> <span class="built_in">text</span>,</span><br><span class="line">        content <span class="built_in">text</span></span><br><span class="line">).</span><br></pre></td></tr></table></figure>
<p>因为下面的 stanford_nlp 进行句法分析时速度特别的慢，因此我抽取出 articles.csv 的头10 行进行实验。<br>执行 ‘’’ deepdive do articles ‘’’ 将文章导入到 postgresql中<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root<span class="symbol">@ubuntu</span>-mmm:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2<span class="meta"># deepdive <span class="meta-keyword">compile</span></span></span><br><span class="line">root<span class="symbol">@ubuntu</span>-mmm:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2<span class="meta"># deepdive do articles</span></span><br></pre></td></tr></table></figure></p>
<p>验证是否成功</p>
 <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-mmm:/usr/local/CNdeepdive/transaction2# deepdive query <span class="emphasis">'?- articles(id, _).'</span></span><br><span class="line"><span class="code"> id </span></span><br><span class="line">----</span><br><span class="line"><span class="code"> 0</span></span><br><span class="line"><span class="code"> 1</span></span><br><span class="line"><span class="code"> 2</span></span><br><span class="line"><span class="code"> 3</span></span><br><span class="line"><span class="code"> 4</span></span><br><span class="line"><span class="code"> 5</span></span><br><span class="line"><span class="code"> 6</span></span><br><span class="line"><span class="code"> 7</span></span><br><span class="line"><span class="code"> 8</span></span><br><span class="line"><span class="code"> 9</span></span><br><span class="line"><span class="code"> 10</span></span><br><span class="line">(11 rows)</span><br></pre></td></tr></table></figure>
<h2 id="8-用-stanford-nlp-模块进行文本处理"><a href="#8-用-stanford-nlp-模块进行文本处理" class="headerlink" title="8. 用 stanford_nlp 模块进行文本处理"></a>8. 用 stanford_nlp 模块进行文本处理</h2><p>deepdive 默认采⽤standfor nlp进⾏⽂本处理。输⼊⽂本数据，nlp模块将以句子为单位，返回每句的分词、lemma、pos、NER和句法分析的结果，为后续特征抽取做准备。我们将这些结果存入sentences表中。</p>
<p>首先在 app.ddlog 中建立 sentences 表：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">@source</span><br><span class="line">sentences(</span><br><span class="line">        doc_id <span class="keyword">text</span>,</span><br><span class="line">        sentence_index <span class="keyword">int</span>,</span><br><span class="line">        sentences_text <span class="keyword">text</span>,</span><br><span class="line">        tokens <span class="keyword">text</span>[],</span><br><span class="line">        lemmas <span class="keyword">text</span>[],</span><br><span class="line">        pos_tags <span class="keyword">text</span>[],</span><br><span class="line">        ner_tags <span class="keyword">text</span>[],</span><br><span class="line">        doc_offsets <span class="keyword">int</span>[],</span><br><span class="line">        dep_types <span class="keyword">text</span>[],</span><br><span class="line">        dep_tokens <span class="keyword">int</span>[]</span><br><span class="line">).</span><br></pre></td></tr></table></figure>
<p> 而后定义NLP 处理的函数 nlp_markup 来调用自定义的脚本 udf/nlp_markup.sh 进行文本处理。  我们需要对数据处理的方法，deepdive只是个框架，具体要怎么处理需要我们告诉他。所以我们要定义函数来处理articles让他变成sentences。 </p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">nlp_markup</span> <span class="title">over</span> (</span></span><br><span class="line">            doc_id <span class="keyword">text</span>,</span><br><span class="line">            content <span class="keyword">text</span>,</span><br><span class="line">    ) returns rows like <span class="keyword">sentences</span></span><br><span class="line">    implementation <span class="string">"udf/nlp_markup.sh"</span> handles tsv <span class="keyword">lines</span>.</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<p>​     function用来定义函数，后面<code>nlp_markup</code> 是函数名 over后面接的是参数表。</p>
<p>​     returns 说明了函数返回的形式，返回就像我们前面定义的sentences那样的一行。</p>
<p>​     最后一句说明了我们这个程序文件是<code>udf/nlp_markup.sh</code> ,输入是tsv的一行。</p>
<p> 使用如下语法调用 nlp_markup 函数，将函数的输出存储到sentences 表中： </p>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sentences += nlp<span class="number">_m</span>arkup(<span class="meta">doc</span><span class="number">_</span>id, content) :-</span><br><span class="line">    articles(<span class="meta">doc</span><span class="number">_</span>id, content).</span><br></pre></td></tr></table></figure>
<p>说明：上面的<code>+=</code> 其实和其他语言差不多，就是对于来源是articles中的每一行的<code>doc_id</code> 和<code>content</code> 我们都调用<code>nlp_markup</code> 然后结果添加到sentences表中。 </p>
<p>编写 udf/nlp_markup.sh，代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"><span class="comment"># A shell script that runs Bazaar/Parser over documents passed as input TSV lines</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># $ deepdive env udf/nlp_markup.sh doc_id _ _ content _</span></span><br><span class="line"><span class="comment">##</span></span><br><span class="line"><span class="built_in">set</span> -euo pipefail</span><br><span class="line"><span class="built_in">cd</span> <span class="string">"<span class="variable">$(dirname "$0")</span>"</span></span><br><span class="line"></span><br><span class="line">: <span class="variable">$&#123;BAZAAR_HOME:=$PWD/bazaar&#125;</span></span><br><span class="line">[[ -x <span class="string">"<span class="variable">$BAZAAR_HOME</span>"</span>/parser/target/start ]] || &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"No Bazaar/Parser set up at: <span class="variable">$BAZAAR_HOME</span>/parser"</span></span><br><span class="line">    <span class="built_in">exit</span> 2</span><br><span class="line">&#125; &gt;&amp;2</span><br><span class="line"></span><br><span class="line">[[ <span class="variable">$#</span> -gt 0 ]] ||</span><br><span class="line">    <span class="comment"># default column order of input TSV</span></span><br><span class="line">    <span class="built_in">set</span> -- doc_id content</span><br><span class="line"></span><br><span class="line"><span class="comment"># convert input tsv lines into JSON lines for Bazaar/Parser</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># start Bazaar/Parser to emit sentences TSV</span></span><br><span class="line">tsv2json <span class="string">"<span class="variable">$@</span>"</span> |</span><br><span class="line"><span class="string">"<span class="variable">$BAZAAR_HOME</span>"</span>/parser/run.sh -i json -k doc_id -v content</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<p>所有#开头的（除了#！）都是普通注释</p>
<p>参数的用法(</p>
<ul>
<li>$0：调用文件使用的文件名，带有前面的路径,</li>
<li>$1-∞：传给脚本的各个参数,</li>
<li>$@,$*：这两个都表示传入的所有参数,</li>
<li>$#：表示传入参数的个数)</li>
</ul>
<p>第一行指定了脚本的执行程序</p>
<p>第六行指定了一些程序的错误处理方式等（详见Shell相关文档）</p>
<p>第七行改变当前目录到<code>nlp_markup.py</code> 所在目录，也就是<code>udf</code> 目录</p>
<p>第九行设置了一个变量<code>BAZZER_HOME</code> 他的值是<code>bazaar</code> 的路径</p>
<p>第10-13行执行<code>/parser/target/start</code> 文件，如果有错会不正常退出，并提示</p>
<p>第15-17行检查输入参数的正确性，看参数个数是不是大于0个，如果没有参数，自己设定参数名</p>
<p>第23-24行把全部输入的参数用<code>tsv2json</code> 工具转换成<code>json</code> 格式，然后在执行<code>parser/run.sh</code> 并以刚才的<code>json</code> 作为参数输入。</p>
<p>编译并执行<code>deepdive compile &amp;&amp; deepdive do sentences</code> 生成 sentences 表。 </p>
<p>预告：运行很慢，耐心等待……</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">root</span>@<span class="selector-tag">ubuntu-mmm</span>:/<span class="selector-tag">usr</span>/<span class="selector-tag">local</span>/<span class="selector-tag">CNdeepdive</span>/<span class="selector-tag">transaction2</span># <span class="selector-tag">chmod</span> <span class="selector-tag">777</span> <span class="selector-tag">udf</span>/<span class="selector-tag">bazaar</span>/<span class="selector-tag">parser</span>/<span class="selector-tag">run</span><span class="selector-class">.sh</span></span><br><span class="line"><span class="selector-tag">root</span>@<span class="selector-tag">ubuntu-mmm</span>:/<span class="selector-tag">usr</span>/<span class="selector-tag">local</span>/<span class="selector-tag">CNdeepdive</span>/<span class="selector-tag">transaction2</span># <span class="selector-tag">chmod</span> <span class="selector-tag">777</span> <span class="selector-tag">udf</span>/<span class="selector-tag">nlp_markup</span><span class="selector-class">.sh</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">root</span>@<span class="selector-tag">ubuntu-mmm</span>:/<span class="selector-tag">usr</span>/<span class="selector-tag">local</span>/<span class="selector-tag">CNdeepdive</span>/<span class="selector-tag">transaction2</span># <span class="selector-tag">deepdive</span> <span class="selector-tag">compile</span> <span class="selector-tag">&amp;</span><span class="selector-tag">&amp;</span> <span class="selector-tag">deepdive</span> <span class="selector-tag">do</span> <span class="selector-tag">sentences</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">loading</span> <span class="selector-tag">dd_tmp_sentences</span>: <span class="selector-tag">0</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:31</span>    <span class="selector-tag">0</span> <span class="selector-tag">B</span> <span class="selector-attr">[   0 B/s]</span> ([   <span class="number">0</span> B/s])<span class="selector-tag">2019-10-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:01</span><span class="selector-pseudo">:41.117623</span> <span class="selector-tag">Reading</span> <span class="selector-tag">POS</span> <span class="selector-tag">tagger</span> <span class="selector-tag">model</span> <span class="selector-tag">from</span> <span class="selector-tag">edu</span>/<span class="selector-tag">stanford</span>/<span class="selector-tag">nlp</span>/<span class="selector-tag">models</span>/<span class="selector-tag">pos-tagger</span>/<span class="selector-tag">chinese-distsim</span>/<span class="selector-tag">chinese-distsim</span><span class="selector-class">.tagger</span> ... <span class="selector-tag">done</span> <span class="selector-attr">[2.1 sec]</span>.</span><br><span class="line"><span class="selector-tag">2019-10-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:01</span><span class="selector-pseudo">:41.118162</span> <span class="selector-tag">Adding</span> <span class="selector-tag">annotator</span> <span class="selector-tag">lemma</span></span><br><span class="line"><span class="selector-tag">loading</span> <span class="selector-tag">dd_tmp_sentences</span>: <span class="selector-tag">0</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:42</span>    <span class="selector-tag">0</span> <span class="selector-tag">B</span> <span class="selector-attr">[   0 B/s]</span> ([   <span class="number">0</span> B/s])<span class="selector-tag">2019-10-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:01</span><span class="selector-pseudo">:52.480759</span> <span class="selector-tag">Loading</span> <span class="selector-tag">classifier</span> <span class="selector-tag">from</span> <span class="selector-tag">edu</span>/<span class="selector-tag">stanford</span>/<span class="selector-tag">nlp</span>/<span class="selector-tag">models</span>/<span class="selector-tag">ner</span>/<span class="selector-tag">chinese</span><span class="selector-class">.misc</span><span class="selector-class">.distsim</span><span class="selector-class">.crf</span><span class="selector-class">.ser</span><span class="selector-class">.gz</span> ... <span class="selector-tag">done</span> <span class="selector-attr">[11.3 sec]</span>.</span><br><span class="line"><span class="selector-tag">loading</span> <span class="selector-tag">dd_tmp_sentences</span>: <span class="selector-tag">0</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:43</span>    <span class="selector-tag">0</span> <span class="selector-tag">B</span> <span class="selector-attr">[   0 B/s]</span> ([   <span class="number">0</span> B/s])<span class="selector-tag">2019-10-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:01</span><span class="selector-pseudo">:53.716363</span> <span class="selector-tag">Loading</span> <span class="selector-tag">parser</span> <span class="selector-tag">from</span> <span class="selector-tag">serialized</span> <span class="selector-tag">file</span> <span class="selector-tag">edu</span>/<span class="selector-tag">stanford</span>/<span class="selector-tag">nlp</span>/<span class="selector-tag">models</span>/<span class="selector-tag">lexparser</span>/<span class="selector-tag">chineseloading</span> <span class="selector-tag">dd_tmp_sentences</span>: <span class="selector-tag">0</span><span class="selector-pseudo">:00</span><span class="selector-pseudo">:44</span>    <span class="selector-tag">0</span> <span class="selector-tag">B</span> <span class="selector-attr">[   0 B/s]</span> ([   <span class="number">0</span> B/s])<span class="selector-tag">2019-10-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:01</span><span class="selector-pseudo">:53.943866</span> <span class="selector-tag">Parsing</span> <span class="selector-tag">document</span> <span class="selector-tag">0</span>...</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p> 您可以通过以下命令来查询生成的结果： </p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-mmm:/usr/local/CNdeepdive/transaction2# deepdive query '</span><br><span class="line">doc_id, index, tokens, ner_tags | <span class="type">5</span></span><br><span class="line">?- sentences(doc_id, index, text, tokens, lemmas, pos_tags, ner_tags, <span class="keyword">_</span>, <span class="keyword">_</span>, <span class="keyword">_</span>).</span><br><span class="line">'</span><br><span class="line"></span><br><span class="line">doc_id | <span class="type">index</span> |                                                                                  <span class="type">tokens</span>                                                                                   |                                                 <span class="type">ner_tags</span>                                                  </span><br><span class="line">--------+-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------------------------------------------------------------------------------------</span><br><span class="line"> <span class="number">0</span>      |     <span class="type">1</span> | <span class="type">&#123;周星驰,，,1962</span>年,<span class="number">6</span>月,<span class="number">22</span>日,生,于,香港,，,祖籍,浙江,宁波,，,中国,香港,演员,、,导演,、,编剧,、,制作人,、,商人,，,毕业于,无线,电视,艺员,训练班,。&#125;                           | <span class="type">&#123;PERSON</span>,O,MISC,MISC,MISC,O,O,GPE,O,O,GPE,GPE,O,GPE,GPE,O,O,O,O,O,O,O,O,O,O,O,O,O,O,O,O&#125;</span><br><span class="line"> <span class="number">0</span>      |     <span class="type">2</span> | <span class="type">&#123;1980</span>年,成为,丽的,电视台,的,特约,演员,，,从而,进入,演艺圈,。&#125;                                                                                                             | <span class="type">&#123;O</span>,O,O,O,O,O,O,O,O,O,O,O&#125;</span><br><span class="line"> <span class="number">0</span>      |     <span class="type">3</span> | <span class="type">&#123;1981</span>年,出演,个人,首部,电视剧,《,IQ,成熟,时,》,。&#125;                                                                                                                          | <span class="type">&#123;O</span>,O,O,O,O,O,MISC,MISC,MISC,O,O&#125;</span><br><span class="line"> <span class="number">0</span>      |     <span class="type">4</span> | <span class="type">&#123;1988</span>年,将,演艺,事业,的,重心,转向,大,银幕,，,并,于,同,年,出演,电影,处女,作,《,捕,风,汉子,》,。&#125;                                                                             | <span class="type">&#123;O</span>,O,O,O,O,O,O,O,O,O,O,O,MISC,MISC,O,O,O,O,O,MISC,MISC,MISC,O,O&#125;</span><br><span class="line"> <span class="number">0</span>      |     <span class="type">5</span> | <span class="type">&#123;1990</span>年,凭借,喜剧片,《,一,本,漫画,闯,天涯,》,确立,其,无厘头,的,表演,风格,(,<span class="number">1</span>,),；,同年,，,因其,主演,的,喜剧,动作片,《,赌圣,》,打破,香港,地区,票房,纪录,而,获得,关注,(,<span class="number">2</span>,),。&#125; | <span class="type">&#123;O</span>,O,O,O,MISC,MISC,MISC,MISC,MISC,O,O,O,O,O,O,O,O,O,O,O,O,O,O,O,O,O,O,O,MISC,O,O,GPE,O,O,O,O,O,O,O,O,O,O&#125;</span><br><span class="line">(<span class="number">5</span> rows)</span><br></pre></td></tr></table></figure>
<h2 id="9-候选实体的生成"><a href="#9-候选实体的生成" class="headerlink" title="9.候选实体的生成"></a>9.候选实体的生成</h2><p> 首先介绍演员候选实体的生成。首先我们在app.ddlog 中定义实体数据表： </p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@extraction</span><br><span class="line">actor_mention(</span><br><span class="line">        mention_id <span class="keyword">text</span>,</span><br><span class="line">        mention_text <span class="keyword">text</span>,</span><br><span class="line">        doc_id <span class="keyword">text</span>,</span><br><span class="line">        sentences_index <span class="keyword">int</span>,</span><br><span class="line">        begin_index <span class="keyword">int</span>,</span><br><span class="line">        end_index <span class="keyword">int</span></span><br><span class="line">).</span><br></pre></td></tr></table></figure>
<p>该表包含了实体的id、内容、所在文本的id、所在句子的索引、起始和终止位置索引。</p>
<p>而后继续定义实体抽取函数：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">map_actor_mention</span> <span class="title">over</span>(</span></span><br><span class="line">        doc_id <span class="keyword">text</span>,</span><br><span class="line">        sentence_index int,</span><br><span class="line">        tokens <span class="keyword">text</span>[],</span><br><span class="line">        pos_tags <span class="keyword">text</span>[],</span><br><span class="line">        ner_tags <span class="keyword">text</span>[]</span><br><span class="line">    ) returns rows like actor_mention</span><br><span class="line">implementation <span class="string">"udf/map_actor_mention.py"</span> handles tsv <span class="keyword">lines</span>.</span><br></pre></td></tr></table></figure>
<p>其中 udf/map_actor_mention.py 脚本遍历数据库中的句子，找到连续的NER标记为PERSON 且 POS 标记为NR的序列，再对其做过滤整合处理，返回候选实体。</p>
<p>最后我们在 app.ddlog 中调用函数，将 函数的输出存储到 actor_mention 表中。</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">actor_mention += map_actor_mention(</span><br><span class="line">    doc_id, sentence_index, <span class="built_in">tokens</span>, pos_tags, ner_tags</span><br><span class="line">    ) :-                   </span><br><span class="line">    sentences(doc_id, sentence_index, <span class="symbol">_</span>, <span class="built_in">tokens</span>, <span class="symbol">_</span>, pos_tags, ner_tags, <span class="symbol">_</span>, <span class="symbol">_</span>, <span class="symbol">_</span>).</span><br></pre></td></tr></table></figure>
<p> 现在我们可以编译并执行得到 actor_mention 表了。 </p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root<span class="symbol">@ubuntu</span>-mmm:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2<span class="meta"># chmod 777 udf/map_actor_mention.py</span></span><br><span class="line">root<span class="symbol">@ubuntu</span>-mmm:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2<span class="meta"># deepdive <span class="meta-keyword">compile</span> &amp;&amp; deepdive do actor_mention</span></span><br></pre></td></tr></table></figure>
<p> 同理可以得到 电影类的实体表 movie_mention ： </p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@extraction</span><br><span class="line">movie_mention(</span><br><span class="line">        mention_id <span class="built_in">text</span>,  </span><br><span class="line">        mention_text <span class="built_in">text</span>,</span><br><span class="line">        doc_id <span class="built_in">text</span>,      </span><br><span class="line">        sentences_index <span class="built_in">int</span>,</span><br><span class="line">        begin_index <span class="built_in">int</span>,</span><br><span class="line">        end_index <span class="built_in">int</span></span><br><span class="line">    ).</span><br><span class="line"></span><br><span class="line">function map_movie_mention over(</span><br><span class="line">    doc_id <span class="built_in">text</span>,</span><br><span class="line">    sentence_index <span class="built_in">int</span>,</span><br><span class="line">    tokens <span class="built_in">text</span>[],</span><br><span class="line">    pos_tags <span class="built_in">text</span>[],</span><br><span class="line">    ner_tags <span class="built_in">text</span>[]</span><br><span class="line">) returns <span class="built_in">rows</span> like movie_mention</span><br><span class="line">implementation <span class="string">"udf/map_movie_mention.py"</span> handles tsv lines.</span><br><span class="line">                </span><br><span class="line">movie_mention += map_movie_mention(</span><br><span class="line">doc_id, sentence_index, tokens, pos_tags, ner_tags</span><br><span class="line">) <span class="symbol">:</span>-            </span><br><span class="line">    sentences(doc_id, sentence_index, _, tokens, _, pos_tags, ner_tags, _, _, _).</span><br></pre></td></tr></table></figure>
<p>编译并执行<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root<span class="symbol">@ubuntu</span>-mmm:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2<span class="meta"># chmod 777 udf/map_movie_mention.py</span></span><br><span class="line">root<span class="symbol">@ubuntu</span>-mmm:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2<span class="meta"># deepdive <span class="meta-keyword">compile</span> &amp;&amp; deepdive do movie_mention</span></span><br></pre></td></tr></table></figure></p>
<p>查询看一下得到的实体： </p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root<span class="meta">@ubuntu-mmm:/usr/local/CNdeepdive/transaction2#</span> deepdive query '</span><br><span class="line">mention_id, mention_text, doc_id |<span class="string"> 5</span></span><br><span class="line"><span class="string">?- movie_mention(mention_id, mention_text, doc_id, _, _, _).</span></span><br><span class="line"><span class="string">'</span></span><br><span class="line"></span><br><span class="line"><span class="string"> mention_id </span>|<span class="string"> mention_text </span>|<span class="string"> doc_id </span></span><br><span class="line"><span class="string">------------+--------------+--------</span></span><br><span class="line"><span class="string"> 0_5_28_28  </span>|<span class="string"> 赌圣         </span>|<span class="string"> 0</span></span><br><span class="line"><span class="string"> 0_7_6_6    </span>|<span class="string"> 大话西游     </span>|<span class="string"> 0</span></span><br><span class="line"><span class="string"> 0_7_11_11  </span>|<span class="string"> 华语         </span>|<span class="string"> 0</span></span><br><span class="line"><span class="string"> 0_8_6_6    </span>|<span class="string"> 喜剧         </span>|<span class="string"> 0</span></span><br><span class="line"><span class="string"> 0_9_4_4    </span>|<span class="string"> 少林足球     </span>|<span class="string"> 0</span></span><br><span class="line"><span class="string">(5 rows)</span></span><br></pre></td></tr></table></figure>
<h2 id="10-生成候选实体对"><a href="#10-生成候选实体对" class="headerlink" title="10. 生成候选实体对"></a>10. 生成候选实体对</h2><p> 这一步我们要生成候选实体对，首先定义数据表如下： </p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@extraction</span><br><span class="line">play_candidate(</span><br><span class="line">    p1_id <span class="keyword">text</span>,</span><br><span class="line">    p1_name <span class="keyword">text</span>,</span><br><span class="line">    p2_id <span class="keyword">text</span>,</span><br><span class="line">    p2_name <span class="keyword">text</span></span><br><span class="line">).</span><br></pre></td></tr></table></figure>
<p> 包含实体1/2 的id 和内容。接下来统计每个句子的实体数量以限制同一句内出现过多实体： </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">num_entity</span><span class="params">(doc_id, sentence_index, COUNT(p)</span></span> + COUNT(q)) :-</span><br><span class="line">	actor_mention(<span class="selector-tag">p</span>, _, doc_id, sentence_index, _, _),</span><br><span class="line">	movie_mention(<span class="selector-tag">q</span>, _, doc_id, sentence_index, _, _).</span><br></pre></td></tr></table></figure>
<p> 而后定义过滤函数： </p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">map_play_candidate</span> <span class="title">over</span> (</span></span><br><span class="line">    p1_id <span class="keyword">text</span>,</span><br><span class="line">    p1_name <span class="keyword">text</span>,</span><br><span class="line">    p2_id <span class="keyword">text</span>,</span><br><span class="line">    p2_name <span class="keyword">text</span></span><br><span class="line">) returns rows like play_candidate</span><br><span class="line">implementation <span class="string">"udf/map_play_candidate.py"</span> handles tsv <span class="keyword">lines</span>.</span><br></pre></td></tr></table></figure>
<p>该函数内您可以定义一些规则对候选实体对进行筛选。</p>
<p>接下来调用上述函数并结合一些规则对实体对进行进一步的筛选，将筛选结果存储到 play_candidate 数据表中：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">play_candidate += map_play_candidate(p1, p1_name, p2, p2_name)<span class="keyword"> :</span>-</span><br><span class="line">    num_entity(same_doc, same_sentence, num_e),</span><br><span class="line">    actor_mention(p1, p1_name, same_doc, same_sentence, p1_begin, _),</span><br><span class="line">    movie_mention(p2, p2_name, same_doc, same_sentence, p2_begin, _),</span><br><span class="line">    num_e &lt; 5,  </span><br><span class="line">    p1_name != p2_name,</span><br><span class="line">    p1_begin != p2_begin.</span><br></pre></td></tr></table></figure>
<p> 编译并执行得到候选实体对表： </p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root<span class="symbol">@ubuntu</span>-mmm:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2<span class="meta"># chmod 777 udf/map_play_candidate.py</span></span><br><span class="line">root<span class="symbol">@ubuntu</span>-mmm:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2<span class="meta"># deepdive <span class="meta-keyword">compile</span> &amp;&amp; deepdive do play_candidate</span></span><br></pre></td></tr></table></figure>
<p> 查询一下看看结果： </p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-mmm:/usr/local/CNdeepdive/transaction2# deepdive query <span class="emphasis">'</span></span><br><span class="line"><span class="emphasis">p1_text, p2_text | 5</span></span><br><span class="line"><span class="emphasis">?- play_candidate(_, p1_text, _, p2_text).</span></span><br><span class="line"><span class="emphasis">'</span></span><br><span class="line"></span><br><span class="line"><span class="code">   p1_text    | p2_text  </span></span><br><span class="line">--------------+----------</span><br><span class="line"><span class="code"> 周星驰       | 滕王阁序</span></span><br><span class="line"><span class="code"> 周星驰       | 北斗</span></span><br><span class="line"><span class="code"> 龙炳基       | 北斗</span></span><br><span class="line"><span class="code"> 赵子龙       | 生命</span></span><br><span class="line"><span class="code"> 郑佩佩       | 审死官</span></span><br><span class="line">(5 rows)</span><br></pre></td></tr></table></figure>
<h2 id="11-特征抽取"><a href="#11-特征抽取" class="headerlink" title="11. 特征抽取"></a>11. 特征抽取</h2><p>现在我们要用deeodive自带的 ddlib 库抽选实体对的文本特征。</p>
<p>首先定义特征表：</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@extraction</span><br><span class="line">play_feature(                 </span><br><span class="line">    p1_id <span class="keyword">text</span>,               </span><br><span class="line">    p2_id <span class="keyword">text</span>,               </span><br><span class="line">    feature <span class="keyword">text</span>              </span><br><span class="line">).</span><br></pre></td></tr></table></figure>
<p>该特征是实体对间一系列文本特征的集合。</p>
<p>而后我们定义特征提取函数得到各种 POS/NER/次序列的窗口特征等。</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function extract_play_features over (</span><br><span class="line">    p1_id          <span class="built_in">text</span>,     </span><br><span class="line">    p2_id          <span class="built_in">text</span>,     </span><br><span class="line">    p1_begin_index <span class="built_in">int</span>,      </span><br><span class="line">    p1_end_index   <span class="built_in">int</span>,      </span><br><span class="line">    p2_begin_index <span class="built_in">int</span>,      </span><br><span class="line">    p2_end_index   <span class="built_in">int</span>,      </span><br><span class="line">    doc_id         <span class="built_in">text</span>,     </span><br><span class="line">    sent_index     <span class="built_in">int</span>,    </span><br><span class="line">    tokens         <span class="built_in">text</span>[],   </span><br><span class="line">    lemmas         <span class="built_in">text</span>[],   </span><br><span class="line">    pos_tags       <span class="built_in">text</span>[], </span><br><span class="line">    ner_tags       <span class="built_in">text</span>[], </span><br><span class="line">    dep_types      <span class="built_in">text</span>[], </span><br><span class="line">    dep_tokens     <span class="built_in">int</span>[]   </span><br><span class="line">) returns <span class="built_in">rows</span> like play_feature</span><br><span class="line">implementation <span class="string">"udf/extract_play_features.py"</span> handles tsv lines.</span><br></pre></td></tr></table></figure>
<p>而后调用该函数：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">play_feature += extract_play_features(</span><br><span class="line">p1_id, p2_id, p1_begin_index, p1_end_index, p2_begin_index, p2_end_index,</span><br><span class="line">doc_id, sent_index, tokens, lemmas, pos_tags, ner_tags, dep_types, dep_tokens</span><br><span class="line">)<span class="keyword"> :</span>-                       </span><br><span class="line">    actor_mention(p1_id, _, doc_id, sent_index, p1_begin_index, p1_end_index),</span><br><span class="line">    movie_mention(p2_id, _, doc_id, sent_index, p2_begin_index, p2_end_index),</span><br><span class="line">    sentences(doc_id, sent_index, _, tokens, lemmas, pos_tags, ner_tags, _, dep_types, dep_tokens).</span><br></pre></td></tr></table></figure>
<p>编译并执行：</p>
<p>预告：运行很慢，耐心等待……</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root<span class="symbol">@ubuntu</span>-mmm:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2<span class="meta"># chmod 777 udf/extract_play_features.py</span></span><br><span class="line">root<span class="symbol">@ubuntu</span>-mmm:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2<span class="meta"># deepdive <span class="meta-keyword">compile</span> &amp;&amp; deepdive do play_feature</span></span><br></pre></td></tr></table></figure>
<p>查询看一下特征：</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-mmm:/usr/local/CNdeepdive/transaction2# deepdive query <span class="string">'| 5 ?- play_feature(_, _, feature).'</span></span><br><span class="line"></span><br><span class="line"> IS_INVERTED</span><br><span class="line"> INV_WORD_SEQ_[》 是 <span class="number">2006</span>年 上映 的 一 部 宫廷 悲剧 电影 ， 该 片 根据 莎士比亚 名剧 《 哈姆雷特 》 改编 ， 由 冯小刚 导演 ， 主要 演员 有 章子怡 、 葛优 、 吴彦祖 、]</span><br><span class="line"> INV_LEMMA_SEQ_[》 是 <span class="number">2006</span>年 上映 的 一 部 宫廷 悲剧 电影 ， 该 片 根据 莎士比亚 名剧 《 哈姆雷特 》 改编 ， 由 冯小刚 导演 ， 主要 演员 有 章子怡 、 葛优 、 吴彦祖 、]</span><br><span class="line"> INV_NER_SEQ_[<span class="keyword">O</span> <span class="keyword">O</span> MISC <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> MISC <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> PERSON <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> <span class="keyword">O</span> PERSON <span class="keyword">O</span> PERSON <span class="keyword">O</span> PERSON <span class="keyword">O</span>]</span><br><span class="line"> INV_POS_SEQ_[PU VC NT VV DEC CD M NN NN NN PU DT NN P NR NN PU NR PU VV PU P NR NN PU JJ NN VE NR PU NR PU NR PU]</span><br><span class="line">(<span class="number">5</span> rows)</span><br></pre></td></tr></table></figure>
<h2 id="12-有监督数据处理"><a href="#12-有监督数据处理" class="headerlink" title="12. 有监督数据处理"></a>12. 有监督数据处理</h2><p> 首先在 app.ddlog 中定义 play_label 表存放有监督数据： </p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@extraction</span>             </span><br><span class="line">play_label(             </span><br><span class="line">    <span class="variable">@key</span>                </span><br><span class="line">    <span class="variable">@references</span>(relation=<span class="string">"has_play"</span>, column=<span class="string">"p1_id"</span>, alias=<span class="string">"has_play"</span>)</span><br><span class="line">    p1_id text,         </span><br><span class="line">    <span class="variable">@key</span>                </span><br><span class="line">    <span class="variable">@references</span>(relation=<span class="string">"has_play"</span>, column=<span class="string">"p2_id"</span>, alias=<span class="string">"has_play"</span>)</span><br><span class="line">    p2_id text,         </span><br><span class="line">    <span class="variable">@navigable</span>          </span><br><span class="line">    label int,          </span><br><span class="line">    <span class="variable">@navigable</span>          </span><br><span class="line">    rule_id text        </span><br><span class="line">).</span><br></pre></td></tr></table></figure>
<p>rule_id 表示相关性的规则名称，label 为正值表示正相关，负值表示负相关。绝对值越大，相关性越大。</p>
<p>初始化定义，复制 play_candidate 表，label 初始化为0，rule_id 为 NULL：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">paly_label</span>(<span class="built_in">p1</span>, <span class="built_in">p2</span>, <span class="number">0</span>, NULL) :- play_candidate(<span class="built_in">p1</span>, _, <span class="built_in">p2</span>, _).</span><br></pre></td></tr></table></figure>
<p>接下来将最开始导入的有监督数据表 actor_movie_dbdata 导入到 play_label 中，并赋予权重3：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">play_label(p1, p2, 3, <span class="string">"from_dbdata"</span>)<span class="keyword"> :</span>-</span><br><span class="line">    play_candidate(p1, p1_name, p2, p2_name),</span><br><span class="line">    actor_movie_dbdata(n1, n2),</span><br><span class="line">    [lower(n1) = lower(p1_name), lower(n2) = lower(p2_name)].</span><br></pre></td></tr></table></figure>
<h2 id="13-预标记"><a href="#13-预标记" class="headerlink" title="13. 预标记"></a>13. 预标记</h2><p>接下来定义一些逻辑规则对文本进行预标记：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">function supervise over (      </span><br><span class="line">    p1_id <span class="built_in">text</span>, p1_begin <span class="keyword">int</span>, p1_end <span class="keyword">int</span>,</span><br><span class="line">    p2_id <span class="built_in">text</span>, p2_begin <span class="keyword">int</span>, p2_end <span class="keyword">int</span>,</span><br><span class="line">    doc_id <span class="built_in">text</span>,               </span><br><span class="line">    doc_id <span class="built_in">text</span>,               </span><br><span class="line">    sentence_index <span class="keyword">int</span>,        </span><br><span class="line">    sentence_text <span class="built_in">text</span>,        </span><br><span class="line">    tokens <span class="built_in">text</span>[],             </span><br><span class="line">    lemmas <span class="built_in">text</span>[],             </span><br><span class="line">    pos_tags <span class="built_in">text</span>[],           </span><br><span class="line">    ner_tags <span class="built_in">text</span>[],           </span><br><span class="line">    dep_types <span class="built_in">text</span>[],          </span><br><span class="line">    dep_tokens <span class="keyword">int</span>[]           </span><br><span class="line">) returns (p1_id <span class="built_in">text</span>, p2_id <span class="built_in">text</span>, label <span class="keyword">int</span>, rule_id <span class="built_in">text</span>)</span><br><span class="line">implementation <span class="string">"udf/supervise_play.py"</span> handles tsv lines.</span><br></pre></td></tr></table></figure>
<p>程序 udf/supervise_play.py 里通过一些指定的规则如 出演这种特征来进行预标记。给出label和rule_id的值。</p>
<p>接下来调用标记函数，将规则抽到的数据写到play_label 表中：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">play_label += supervise(</span><br><span class="line">    p1_id, p1_begin, p1_end,</span><br><span class="line">    p2_id, p2_begin, p2_end,</span><br><span class="line">    doc_id, sentence_index, sentence_text,</span><br><span class="line">    tokens, lemmas, pos_tags, ner_tags, dep_types, dep_tokens_indexes</span><br><span class="line">    )<span class="keyword"> :</span>-</span><br><span class="line">    play_candidate(p1_id, _, p2_id, _),</span><br><span class="line">    actor_mention(p1_id, p1_text, doc_id, sentence_index, p1_begin, p1_end),</span><br><span class="line">    movie_mention(p2_id, p2_text, _, _, p2_begin, p2_end),</span><br><span class="line">    sentences(  doc_id, sentence_index, sentence_text,</span><br><span class="line">                tokens, lemmas, pos_tags, ner_tags, _, dep_types, dep_tokens_indexes</span><br><span class="line">    ).</span><br></pre></td></tr></table></figure>
<p>由于不同的规则可能覆盖了相同的实体对，因此利用 vote方法进行综合给出最终标记：</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">play_label_resolved(p1_id, p2_id, SUM(vote))<span class="keyword"> :</span>-</span><br><span class="line">    play_label(p1_id, p2_id, vote, rule_id).</span><br></pre></td></tr></table></figure>
<p>最后编译并执行：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root<span class="symbol">@ubuntu</span>-mmm:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2<span class="meta"># chmod 777 udf/supervise_play.py</span></span><br><span class="line">root<span class="symbol">@ubuntu</span>-mmm:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2<span class="meta"># deepdive <span class="meta-keyword">compile</span> &amp;&amp; deepdive do play_label_resolved</span></span><br></pre></td></tr></table></figure>
<h2 id="14-变量表定义"><a href="#14-变量表定义" class="headerlink" title="14. 变量表定义"></a>14. 变量表定义</h2><p>首先定义最终存储的表格，[?]表示此表是用户模式下的变量表，即需要推到关系的表。这里我们需要推到的是演员和电影间是否存在演出关系。</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@extraction</span><br><span class="line">has_play?(</span><br><span class="line">    p1_id <span class="keyword">text</span>,</span><br><span class="line">    p2_id <span class="keyword">text</span></span><br><span class="line">).</span><br></pre></td></tr></table></figure>
<p>根据打标结果，写入已知的变量：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">has_play(p1_id, p2_id) = <span class="keyword">if</span> l &gt; <span class="number">0</span> <span class="keyword">then</span> <span class="literal">TRUE</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> l &lt; <span class="number">0</span> <span class="keyword">then</span> <span class="literal">FALSE</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="literal">NULL</span> <span class="function"><span class="keyword">end</span> :-</span></span><br><span class="line">                    play_label_resolved(p1_id, p2_id, l).</span><br></pre></td></tr></table></figure>
<p>此时表中部分变量的label 已知，成为了先验变量。编译并执行：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root<span class="symbol">@ubuntu</span>-mmm:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2<span class="meta"># deepdive <span class="meta-keyword">compile</span> &amp;&amp; deepdive do has_play</span></span><br></pre></td></tr></table></figure>
<h2 id="15-构建因子图"><a href="#15-构建因子图" class="headerlink" title="15. 构建因子图"></a>15. 构建因子图</h2><p>指定特征：</p>
<p>将每一对 has_play 中的实体对和特征表连接起来，通过特征因子连接，全局学习这些特征的权重 f</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@weight(f)</span><br><span class="line">has_play(p1_id, p2_id)<span class="keyword"> :</span>-</span><br><span class="line">    play_candidate(p1_id, _, p2_id, _),</span><br><span class="line">    play_feature(p1_id, p2_id, f).</span><br></pre></td></tr></table></figure>
<p>编译并生成最终的概率模型：</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root<span class="symbol">@ubuntu</span>-mmm:/usr/<span class="keyword">local</span>/CNdeepdive/transaction2<span class="meta"># deepdive <span class="meta-keyword">compile</span> &amp;&amp; deepdive do probabilities</span></span><br></pre></td></tr></table></figure>
<p>就完成了我们的推断，现在查询我们预测的演员-电影间的交易关系概率：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root<span class="meta">@ubuntu-mmm:/usr/local/CNdeepdive/transaction2#</span> deepdive sql <span class="string">"SELECT p1_id, p2_id, expectation FROM has_play_label_inference ORDER BY random() LIMIT 5"</span></span><br><span class="line"> </span><br><span class="line">   p1_id    |<span class="string">   p2_id    </span>|<span class="string"> expectation </span></span><br><span class="line"><span class="string">------------+------------+-------------</span></span><br><span class="line"><span class="string"> 6_38_20_20 </span>|<span class="string"> 6_38_44_44 </span>|<span class="string">       0.926</span></span><br><span class="line"><span class="string"> 0_30_36_36 </span>|<span class="string"> 0_30_57_57 </span>|<span class="string">       0.082</span></span><br><span class="line"><span class="string"> 0_39_83_83 </span>|<span class="string"> 0_39_94_95 </span>|<span class="string">       0.214</span></span><br><span class="line"><span class="string"> 6_21_7_8   </span>|<span class="string"> 6_21_43_43 </span>|<span class="string">       0.003</span></span><br><span class="line"><span class="string"> 5_66_0_0   </span>|<span class="string"> 5_66_20_21 </span>|<span class="string">       0.008</span></span><br><span class="line"><span class="string">(5 rows)</span></span><br></pre></td></tr></table></figure>
<p>至此，使用deepdive 抽取非结构文本的演员-电影关系实战完成。</p>
<p>待续……</p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2019/10/100604.html" class="pre-post btn btn-default" title='windows系统安装JDK'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">windows系统安装JDK</span>
        </a>
    
    
        <a href="/archives/2019/09/100587.html" class="next-post btn btn-default" title='百度文库文档免费下载（原文档下载,可编辑）'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">百度文库文档免费下载（原文档下载,可编辑）</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一-半结构化数据的获取"><span class="toc-text">一. 半结构化数据的获取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-mysql"><span class="toc-text">1. mysql</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Python"><span class="toc-text">2. Python</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-IDE（PyCharm）"><span class="toc-text">3. IDE（PyCharm）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Scrapy"><span class="toc-text">4. Scrapy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装wheel"><span class="toc-text">安装wheel</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#用途："><span class="toc-text">用途：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装命令："><span class="toc-text">安装命令：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装lxml"><span class="toc-text">安装lxml</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#用途：-1"><span class="toc-text">用途：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装命令：-1"><span class="toc-text">安装命令：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装方式一-在线-："><span class="toc-text">安装方式一(在线)：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装方式二（离线-："><span class="toc-text">安装方式二（离线)：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装zope-interface"><span class="toc-text">安装zope.interface</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#用途：-2"><span class="toc-text">用途：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装命令：-2"><span class="toc-text">安装命令：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装pyOpenSSL"><span class="toc-text">安装pyOpenSSL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#用途：-3"><span class="toc-text">用途：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装命令：-3"><span class="toc-text">安装命令：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装Twisted"><span class="toc-text">安装Twisted</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#用途：-4"><span class="toc-text">用途：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装命令：-4"><span class="toc-text">安装命令：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装pywin32"><span class="toc-text">安装pywin32</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#用途：-5"><span class="toc-text">用途：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#安装命令：-5"><span class="toc-text">安装命令：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装Scrapy"><span class="toc-text">安装Scrapy</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#安装命令：-6"><span class="toc-text">安装命令：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#可能出现的问题"><span class="toc-text">可能出现的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用工具，快速解决系列：Anaconda"><span class="toc-text">使用工具，快速解决系列：Anaconda</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证安装是否成功"><span class="toc-text">验证安装是否成功</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#方法一："><span class="toc-text">方法一：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#方法二："><span class="toc-text">方法二：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#文件的功能"><span class="toc-text">文件的功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基本使用"><span class="toc-text">基本使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二-数据库到-NTriples-以及通过Apache-jena-访问NT"><span class="toc-text">二. 数据库到 NTriples 以及通过Apache jena 访问NT</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Protege"><span class="toc-text">1. Protege</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-d2rq"><span class="toc-text">2. d2rq</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Apache-jena"><span class="toc-text">3. Apache jena</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装"><span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基本使用-1"><span class="toc-text">基本使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#三-基于REfO的简单知识问答"><span class="toc-text">三. 基于REfO的简单知识问答</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#四-基于ElasticSearch的简单语义搜索"><span class="toc-text">四. 基于ElasticSearch的简单语义搜索</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-安装"><span class="toc-text">1. 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-修改代码"><span class="toc-text">2. 修改代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-运行"><span class="toc-text">3. 运行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1）数据库到JSON"><span class="toc-text">1）数据库到JSON</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2）建立属性间映射"><span class="toc-text">2）建立属性间映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3）获取属性值和属性间的映射"><span class="toc-text">3）获取属性值和属性间的映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4）在-elasticsearch-中新建-index-和-type"><span class="toc-text">4）在 elasticsearch 中新建 index 和 type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5）数据导入"><span class="toc-text">5）数据导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6）检索知识库"><span class="toc-text">6）检索知识库</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#五-Deepdive抽取演员-电影间关系"><span class="toc-text">五. Deepdive抽取演员-电影间关系</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-安装JDK"><span class="toc-text">1. 安装JDK</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-安装Deepdive"><span class="toc-text">2. 安装Deepdive</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-建立postgresql的数据库movie"><span class="toc-text">3. 建立postgresql的数据库movie</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-项目框架搭建"><span class="toc-text">4. 项目框架搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-修改代码"><span class="toc-text">5. 修改代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-先验数据导入"><span class="toc-text">6. 先验数据导入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-待抽取文章的导入"><span class="toc-text">7. 待抽取文章的导入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-用-stanford-nlp-模块进行文本处理"><span class="toc-text">8. 用 stanford_nlp 模块进行文本处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-候选实体的生成"><span class="toc-text">9.候选实体的生成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-生成候选实体对"><span class="toc-text">10. 生成候选实体对</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-特征抽取"><span class="toc-text">11. 特征抽取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-有监督数据处理"><span class="toc-text">12. 有监督数据处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-预标记"><span class="toc-text">13. 预标记</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-变量表定义"><span class="toc-text">14. 变量表定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-构建因子图"><span class="toc-text">15. 构建因子图</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2023&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>