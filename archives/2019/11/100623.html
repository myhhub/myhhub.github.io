<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="区块链,baas,kubernetes,fabric" />


    <meta name="description" content="一. 环境说明1. 系统说明


IP
Hostname
标识



192.168.0.247
kubernetes-1
K8S-Master and Kubectl-Cli


192.16..." />



<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />

    <!--Title-->


<title>在Kubernetes 上部署 Hyperledger Fabric v1.4 | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    




<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7.css">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash.css">





    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx" />


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

<meta name="generator" content="Hexo 7.3.0"></head>


<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="在Kubernetes 上部署 Hyperledger Fabric v1.4">
            
	            在Kubernetes 上部署 Hyperledger Fabric v1.4
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/cloud/">云计算</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-none-link" href="/tags/baas/" rel="tag">baas</a> <a class="tag-none-link" href="/tags/fabric/" rel="tag">fabric</a> <a class="tag-none-link" href="/tags/kubernetes/" rel="tag">kubernetes</a> <a class="tag-none-link" href="/tags/blockchain/" rel="tag">区块链</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2019/11/28</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>1937</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <h1 id="一-环境说明"><a href="#一-环境说明" class="headerlink" title="一. 环境说明"></a>一. 环境说明</h1><h2 id="1-系统说明"><a href="#1-系统说明" class="headerlink" title="1. 系统说明"></a>1. 系统说明</h2><table>
<thead>
<tr>
<th align="left">IP</th>
<th align="left">Hostname</th>
<th align="left">标识</th>
</tr>
</thead>
<tbody><tr>
<td align="left">192.168.0.247</td>
<td align="left">kubernetes-1</td>
<td align="left">K8S-Master and Kubectl-Cli</td>
</tr>
<tr>
<td align="left">192.168.0.248</td>
<td align="left">kubernetes-2</td>
<td align="left">K8S-Master and Node</td>
</tr>
<tr>
<td align="left">192.168.0.249</td>
<td align="left">kubernetes-3</td>
<td align="left">K8S-Node and NFS Server</td>
</tr>
</tbody></table>
<h2 id="2-服务说明"><a href="#2-服务说明" class="headerlink" title="2. 服务说明"></a>2. 服务说明</h2><table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">版本</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CentOS</td>
<td align="left">7 x64</td>
</tr>
<tr>
<td align="left">Hyperledger Fabric</td>
<td align="left">1.4</td>
</tr>
<tr>
<td align="left">kubernetes</td>
<td align="left">1.13.2</td>
</tr>
<tr>
<td align="left">docker</td>
<td align="left">18.06.1-ce</td>
</tr>
</tbody></table>
<h1 id="二-Fabric-环境配置"><a href="#二-Fabric-环境配置" class="headerlink" title="二. Fabric 环境配置"></a>二. Fabric 环境配置</h1><h2 id="1-docker-配置"><a href="#1-docker-配置" class="headerlink" title="1. docker 配置"></a>1. docker 配置</h2><blockquote>
<p>由于 实例化 chaincode 需要由 docker 创建容器</p>
<p>而 这个容器需要跟 k8s 里的 peer svc 通信, 所以需要额外配置</p>
</blockquote>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 配置 docker 配置</span><br><span class="line"></span><br><span class="line">修改 docker 选项 DOCKER_OPTS </span><br><span class="line"></span><br><span class="line">在 DOCKER_OPTS 中 增加 <span class="comment">--dns 添加 k8s 中 dns 的 ip</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes<span class="number">-1</span> /opt/jicki/k8s-yaml]# kubectl <span class="keyword">get</span> svc -n kube-<span class="keyword">system</span>    </span><br><span class="line"></span><br><span class="line"><span class="type">NAME</span>                   <span class="keyword">TYPE</span>        <span class="keyword">CLUSTER</span>-IP     <span class="keyword">EXTERNAL</span>-IP   PORT(S)                  AGE</span><br><span class="line">coredns                ClusterIP   <span class="number">10.233</span><span class="number">.0</span><span class="number">.3</span>     &lt;<span class="keyword">none</span>&gt;        <span class="number">53</span>/UDP,<span class="number">53</span>/TCP,<span class="number">9153</span>/TCP   <span class="number">4</span>d23h</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 我这个环境中 coredns IP 为 <span class="number">10.233</span><span class="number">.0</span><span class="number">.3</span></span><br><span class="line"></span><br><span class="line"># 所以 添加</span><br><span class="line"></span><br><span class="line"><span class="comment">--dns 10.233.0.3</span></span><br></pre></td></tr></table></figure>

<h2 id="2-cryptogen-下载"><a href="#2-cryptogen-下载" class="headerlink" title="2. cryptogen 下载"></a>2. cryptogen 下载</h2><blockquote>
<p>cryptogen 用于简化生成 fabric 所需要的所有证书</p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 官方离线下载地址为 </span></span><br><span class="line">https:<span class="regexp">//</span>nexus.hyperledger.org<span class="regexp">/content/</span>repositories<span class="regexp">/releases/</span>org<span class="regexp">/hyperledger/</span>fabric<span class="regexp">/hyperledger-fabric/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 选择相应版本 CentOS 选择 linux-amd64-1.4.0</span></span><br><span class="line"><span class="comment"># Mac 选择 darwin-amd64-1.4.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建工作目录 ( 后续所有文件都存于此目录中 )</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="regexp">/opt/</span>jicki</span><br><span class="line"></span><br><span class="line">cd <span class="regexp">/opt/</span>jicki</span><br><span class="line"></span><br><span class="line">wget https:<span class="regexp">//</span>nexus.hyperledger.org<span class="regexp">/content/</span>repositories<span class="regexp">/releases/</span>org<span class="regexp">/hyperledger/</span>fabric<span class="regexp">/hyperledger-fabric/</span>linux-amd64-<span class="number">1.4</span>.<span class="number">0</span>/hyperledger-fabric-linux-amd64-<span class="number">1.4</span>.<span class="number">0</span>.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压文件</span></span><br><span class="line">[root@kubernetes-<span class="number">1</span> <span class="regexp">/opt/</span>jicki]<span class="comment"># tar zxvf hyperledger-fabric-linux-amd64-1.4.0.tar.gz</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除 config 这个文件夹,  这里用不到</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-<span class="number">1</span> <span class="regexp">/opt/</span>jicki]<span class="comment"># rm -rf config</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看文件</span></span><br><span class="line">[root@kubernetes-<span class="number">1</span> <span class="regexp">/opt/</span>jicki]<span class="comment"># tree</span></span><br><span class="line">.</span><br><span class="line">└── bin</span><br><span class="line">    ├── configtxgen</span><br><span class="line">    ├── configtxlator</span><br><span class="line">    ├── cryptogen</span><br><span class="line">    ├── discover</span><br><span class="line">    ├── get-docker-images.sh</span><br><span class="line">    ├── idemixgen</span><br><span class="line">    ├── orderer</span><br><span class="line">    └── peer</span><br><span class="line"></span><br><span class="line"><span class="number">1</span> directory, <span class="number">8</span> files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 为方便使用 我们配置一个 环境变量</span></span><br><span class="line"></span><br><span class="line">vi <span class="regexp">/etc/</span>profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># fabric env</span></span><br><span class="line">export PATH=<span class="variable">$PATH</span>:<span class="regexp">/opt/</span>jicki/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使文件生效</span></span><br><span class="line">source <span class="regexp">/etc/</span>profile</span><br></pre></td></tr></table></figure>

<h2 id="3-Fabric-源码下载"><a href="#3-Fabric-源码下载" class="headerlink" title="3. Fabric 源码下载"></a>3. Fabric 源码下载</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@kubernetes-1 /opt/jicki]# git <span class="built_in">clone</span> https://github.com/hyperledger/fabric</span><br></pre></td></tr></table></figure>

<h2 id="4-生成-证书"><a href="#4-生成-证书" class="headerlink" title="4. 生成 证书"></a>4. 生成 证书</h2><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 cryptogen.yaml 文件, 1.4版本 crypto-config.yaml 文件更改为 cryptogen.yaml</span></span><br><span class="line"></span><br><span class="line">vi cryptogen.yaml</span><br><span class="line"></span><br><span class="line"><span class="params">OrdererOrgs:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">Name:</span> Orderer</span><br><span class="line">    <span class="params">Domain:</span> orgorderer1</span><br><span class="line">    <span class="params">CA:</span></span><br><span class="line">        <span class="params">Country:</span> CN</span><br><span class="line">        <span class="params">Province:</span> GuangDong</span><br><span class="line">        <span class="params">Locality:</span> ShenZhen</span><br><span class="line">    <span class="params">Specs:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">Hostname:</span> orderer0</span><br><span class="line">      </span><br><span class="line"><span class="params">PeerOrgs:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">Name:</span> Org1</span><br><span class="line">    <span class="params">Domain:</span> org1</span><br><span class="line">    <span class="params">EnableNodeOUs:</span> <span class="literal">true</span></span><br><span class="line">    <span class="params">CA:</span></span><br><span class="line">        <span class="params">Country:</span> CN</span><br><span class="line">        <span class="params">Province:</span> GuangDong</span><br><span class="line">        <span class="params">Locality:</span> ShenZhen</span><br><span class="line">    <span class="params">Template:</span></span><br><span class="line">      <span class="params">Count:</span> <span class="number">2</span></span><br><span class="line">    <span class="params">Users:</span></span><br><span class="line">      <span class="params">Count:</span> <span class="number">1</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">Name:</span> Org2</span><br><span class="line">    <span class="params">Domain:</span> org2</span><br><span class="line">    <span class="params">EnableNodeOUs:</span> <span class="literal">true</span></span><br><span class="line">    <span class="params">CA:</span></span><br><span class="line">        <span class="params">Country:</span> CN</span><br><span class="line">        <span class="params">Province:</span> GuangDong</span><br><span class="line">        <span class="params">Locality:</span> ShenZhen</span><br><span class="line">    <span class="params">Template:</span></span><br><span class="line">      <span class="params">Count:</span> <span class="number">2</span></span><br><span class="line">    <span class="params">Users:</span></span><br><span class="line">      <span class="params">Count:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 生成证书</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@kubernetes</span><span class="number">-1</span> /opt/jicki]<span class="meta"># cryptogen generate --config=./cryptogen.yaml</span></span><br><span class="line">org1</span><br><span class="line">org2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta"># 查看生成目录结构</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@kubernetes</span><span class="number">-1</span> /opt/jicki]<span class="meta"># tree -d crypto-config/      </span></span><br><span class="line">crypto-config/</span><br><span class="line">├── ordererOrganizations</span><br><span class="line">│   └── orgorderer1</span><br><span class="line">│       ├── ca</span><br><span class="line">│       ├── msp</span><br><span class="line">│       │   ├── admincerts</span><br><span class="line">│       │   ├── cacerts</span><br><span class="line">│       │   └── tlscacerts</span><br><span class="line">│       ├── orderers</span><br><span class="line">│       │   └── orderer0.orgorderer1</span><br><span class="line">│       │       ├── msp</span><br><span class="line">│       │       │   ├── admincerts</span><br><span class="line">│       │       │   ├── cacerts</span><br><span class="line">│       │       │   ├── keystore</span><br><span class="line">│       │       │   ├── signcerts</span><br><span class="line">│       │       │   └── tlscacerts</span><br><span class="line">│       │       └── tls</span><br><span class="line">│       ├── tlsca</span><br><span class="line">│       └── users</span><br><span class="line">│           └── Admin<span class="symbol">@orgorderer1</span></span><br><span class="line">│               ├── msp</span><br><span class="line">│               │   ├── admincerts</span><br><span class="line">│               │   ├── cacerts</span><br><span class="line">│               │   ├── keystore</span><br><span class="line">│               │   ├── signcerts</span><br><span class="line">│               │   └── tlscacerts</span><br><span class="line">│               └── tls</span><br><span class="line">└── peerOrganizations</span><br><span class="line">    ├── org1</span><br><span class="line">    │   ├── ca</span><br><span class="line">    │   ├── msp</span><br><span class="line">    │   │   ├── admincerts</span><br><span class="line">    │   │   ├── cacerts</span><br><span class="line">    │   │   └── tlscacerts</span><br><span class="line">    │   ├── peers</span><br><span class="line">    │   │   ├── peer0.org1</span><br><span class="line">    │   │   │   ├── msp</span><br><span class="line">    │   │   │   │   ├── admincerts</span><br><span class="line">    │   │   │   │   ├── cacerts</span><br><span class="line">    │   │   │   │   ├── keystore</span><br><span class="line">    │   │   │   │   ├── signcerts</span><br><span class="line">    │   │   │   │   └── tlscacerts</span><br><span class="line">    │   │   │   └── tls</span><br><span class="line">    │   │   └── peer1.org1</span><br><span class="line">    │   │       ├── msp</span><br><span class="line">    │   │       │   ├── admincerts</span><br><span class="line">    │   │       │   ├── cacerts</span><br><span class="line">    │   │       │   ├── keystore</span><br><span class="line">    │   │       │   ├── signcerts</span><br><span class="line">    │   │       │   └── tlscacerts</span><br><span class="line">    │   │       └── tls</span><br><span class="line">    │   ├── tlsca</span><br><span class="line">    │   └── users</span><br><span class="line">    │       ├── Admin<span class="symbol">@org1</span></span><br><span class="line">    │       │   ├── msp</span><br><span class="line">    │       │   │   ├── admincerts</span><br><span class="line">    │       │   │   ├── cacerts</span><br><span class="line">    │       │   │   ├── keystore</span><br><span class="line">    │       │   │   ├── signcerts</span><br><span class="line">    │       │   │   └── tlscacerts</span><br><span class="line">    │       │   └── tls</span><br><span class="line">    │       └── User1<span class="symbol">@org1</span></span><br><span class="line">    │           ├── msp</span><br><span class="line">    │           │   ├── admincerts</span><br><span class="line">    │           │   ├── cacerts</span><br><span class="line">    │           │   ├── keystore</span><br><span class="line">    │           │   ├── signcerts</span><br><span class="line">    │           │   └── tlscacerts</span><br><span class="line">    │           └── tls</span><br><span class="line">    └── org2</span><br><span class="line">        ├── ca</span><br><span class="line">        ├── msp</span><br><span class="line">        │   ├── admincerts</span><br><span class="line">        │   ├── cacerts</span><br><span class="line">        │   └── tlscacerts</span><br><span class="line">        ├── peers</span><br><span class="line">        │   ├── peer0.org2</span><br><span class="line">        │   │   ├── msp</span><br><span class="line">        │   │   │   ├── admincerts</span><br><span class="line">        │   │   │   ├── cacerts</span><br><span class="line">        │   │   │   ├── keystore</span><br><span class="line">        │   │   │   ├── signcerts</span><br><span class="line">        │   │   │   └── tlscacerts</span><br><span class="line">        │   │   └── tls</span><br><span class="line">        │   └── peer1.org2</span><br><span class="line">        │       ├── msp</span><br><span class="line">        │       │   ├── admincerts</span><br><span class="line">        │       │   ├── cacerts</span><br><span class="line">        │       │   ├── keystore</span><br><span class="line">        │       │   ├── signcerts</span><br><span class="line">        │       │   └── tlscacerts</span><br><span class="line">        │       └── tls</span><br><span class="line">        ├── tlsca</span><br><span class="line">        └── users</span><br><span class="line">            ├── Admin<span class="symbol">@org2</span></span><br><span class="line">            │   ├── msp</span><br><span class="line">            │   │   ├── admincerts</span><br><span class="line">            │   │   ├── cacerts</span><br><span class="line">            │   │   ├── keystore</span><br><span class="line">            │   │   ├── signcerts</span><br><span class="line">            │   │   └── tlscacerts</span><br><span class="line">            │   └── tls</span><br><span class="line">            └── User1<span class="symbol">@org2</span></span><br><span class="line">                ├── msp</span><br><span class="line">                │   ├── admincerts</span><br><span class="line">                │   ├── cacerts</span><br><span class="line">                │   ├── keystore</span><br><span class="line">                │   ├── signcerts</span><br><span class="line">                │   └── tlscacerts</span><br><span class="line">                └── tls</span><br></pre></td></tr></table></figure>

<h2 id="5-生成初始化Fabric文件"><a href="#5-生成初始化Fabric文件" class="headerlink" title="5. 生成初始化Fabric文件"></a>5. 生成初始化Fabric文件</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 configtx.yaml 文件</span></span><br><span class="line"></span><br><span class="line"><span class="string">vi</span> <span class="string">configtx.yaml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">Organizations:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="meta">&amp;OrdererOrg</span></span><br><span class="line">        <span class="attr">Name:</span> <span class="string">Orgorderer1MSP</span></span><br><span class="line">        <span class="attr">ID:</span> <span class="string">Orgorderer1MSP</span></span><br><span class="line">        <span class="attr">MSPDir:</span> <span class="string">crypto-config/ordererOrganizations/orgorderer1/msp</span></span><br><span class="line">        <span class="attr">Policies:</span></span><br><span class="line">            <span class="attr">Readers:</span></span><br><span class="line">                <span class="attr">Type:</span> <span class="string">Signature</span></span><br><span class="line">                <span class="attr">Rule:</span> <span class="string">&quot;OR(&#x27;Orgorderer1MSP.member&#x27;)&quot;</span></span><br><span class="line">            <span class="attr">Writers:</span></span><br><span class="line">                <span class="attr">Type:</span> <span class="string">Signature</span></span><br><span class="line">                <span class="attr">Rule:</span> <span class="string">&quot;OR(&#x27;Orgorderer1MSP.member&#x27;)&quot;</span></span><br><span class="line">            <span class="attr">Admins:</span></span><br><span class="line">                <span class="attr">Type:</span> <span class="string">Signature</span></span><br><span class="line">                <span class="attr">Rule:</span> <span class="string">&quot;OR(&#x27;Orgorderer1MSP.admin&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="meta">&amp;Org1</span></span><br><span class="line">        <span class="attr">Name:</span> <span class="string">Org1MSP</span></span><br><span class="line">        <span class="attr">ID:</span> <span class="string">Org1MSP</span></span><br><span class="line">        <span class="attr">MSPDir:</span> <span class="string">crypto-config/peerOrganizations/org1/msp</span></span><br><span class="line">        <span class="attr">Policies:</span></span><br><span class="line">            <span class="attr">Readers:</span></span><br><span class="line">                <span class="attr">Type:</span> <span class="string">Signature</span></span><br><span class="line">                <span class="attr">Rule:</span> <span class="string">&quot;OR(&#x27;Org1MSP.admin&#x27;, &#x27;Org1MSP.peer&#x27;, &#x27;Org1MSP.client&#x27;)&quot;</span></span><br><span class="line">            <span class="attr">Writers:</span></span><br><span class="line">                <span class="attr">Type:</span> <span class="string">Signature</span></span><br><span class="line">                <span class="attr">Rule:</span> <span class="string">&quot;OR(&#x27;Org1MSP.admin&#x27;, &#x27;Org1MSP.client&#x27;)&quot;</span></span><br><span class="line">            <span class="attr">Admins:</span></span><br><span class="line">                <span class="attr">Type:</span> <span class="string">Signature</span></span><br><span class="line">                <span class="attr">Rule:</span> <span class="string">&quot;OR(&#x27;Org1MSP.admin&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">AnchorPeers:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">Host:</span> <span class="string">peer0.org1</span></span><br><span class="line">              <span class="attr">Port:</span> <span class="number">7051</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="meta">&amp;Org2</span></span><br><span class="line">        <span class="attr">Name:</span> <span class="string">Org2MSP</span></span><br><span class="line">        <span class="attr">ID:</span> <span class="string">Org2MSP</span></span><br><span class="line">        <span class="attr">MSPDir:</span> <span class="string">crypto-config/peerOrganizations/org2/msp</span></span><br><span class="line">        <span class="attr">Policies:</span></span><br><span class="line">            <span class="attr">Readers:</span></span><br><span class="line">                <span class="attr">Type:</span> <span class="string">Signature</span></span><br><span class="line">                <span class="attr">Rule:</span> <span class="string">&quot;OR(&#x27;Org2MSP.admin&#x27;, &#x27;Org2MSP.peer&#x27;, &#x27;Org2MSP.client&#x27;)&quot;</span></span><br><span class="line">            <span class="attr">Writers:</span></span><br><span class="line">                <span class="attr">Type:</span> <span class="string">Signature</span></span><br><span class="line">                <span class="attr">Rule:</span> <span class="string">&quot;OR(&#x27;Org2MSP.admin&#x27;, &#x27;Org2MSP.client&#x27;)&quot;</span></span><br><span class="line">            <span class="attr">Admins:</span></span><br><span class="line">                <span class="attr">Type:</span> <span class="string">Signature</span></span><br><span class="line">                <span class="attr">Rule:</span> <span class="string">&quot;OR(&#x27;Org2MSP.admin&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="attr">AnchorPeers:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">Host:</span> <span class="string">peer0.org2</span></span><br><span class="line">              <span class="attr">Port:</span> <span class="number">7051</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Capabilities:</span></span><br><span class="line">    <span class="attr">Channel:</span> <span class="meta">&amp;ChannelCapabilities</span></span><br><span class="line">        <span class="attr">V1_3:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">Orderer:</span> <span class="meta">&amp;OrdererCapabilities</span></span><br><span class="line">        <span class="attr">V1_1:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">Application:</span> <span class="meta">&amp;ApplicationCapabilities</span></span><br><span class="line">        <span class="attr">V1_3:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">V1_2:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">V1_1:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Application:</span> <span class="meta">&amp;ApplicationDefaults</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">Organizations:</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">Policies:</span></span><br><span class="line">        <span class="attr">Readers:</span></span><br><span class="line">            <span class="attr">Type:</span> <span class="string">ImplicitMeta</span></span><br><span class="line">            <span class="attr">Rule:</span> <span class="string">&quot;ANY Readers&quot;</span></span><br><span class="line">        <span class="attr">Writers:</span></span><br><span class="line">            <span class="attr">Type:</span> <span class="string">ImplicitMeta</span></span><br><span class="line">            <span class="attr">Rule:</span> <span class="string">&quot;ANY Writers&quot;</span></span><br><span class="line">        <span class="attr">Admins:</span></span><br><span class="line">            <span class="attr">Type:</span> <span class="string">ImplicitMeta</span></span><br><span class="line">            <span class="attr">Rule:</span> <span class="string">&quot;MAJORITY Admins&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">Capabilities:</span></span><br><span class="line">        <span class="string">&lt;&lt;:</span> <span class="meta">*ApplicationCapabilities</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Orderer:</span> <span class="meta">&amp;OrdererDefaults</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">OrdererType:</span> <span class="string">kafka</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">Addresses:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">orderer0.orgorderer1:7050</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">BatchTimeout:</span> <span class="string">2s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">BatchSize:</span></span><br><span class="line">        <span class="attr">MaxMessageCount:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">AbsoluteMaxBytes:</span> <span class="number">99</span> <span class="string">MB</span></span><br><span class="line">        <span class="attr">PreferredMaxBytes:</span> <span class="number">512</span> <span class="string">KB</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">Kafka:</span></span><br><span class="line">        <span class="attr">Brokers:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">kafka-0.broker.kafka:9092</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">kafka-1.broker.kafka:9092</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">kafka-2.broker.kafka:9092</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">kafka-3.broker.kafka:9092</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">Organizations:</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">Policies:</span></span><br><span class="line">        <span class="attr">Readers:</span></span><br><span class="line">            <span class="attr">Type:</span> <span class="string">ImplicitMeta</span></span><br><span class="line">            <span class="attr">Rule:</span> <span class="string">&quot;ANY Readers&quot;</span></span><br><span class="line">        <span class="attr">Writers:</span></span><br><span class="line">            <span class="attr">Type:</span> <span class="string">ImplicitMeta</span></span><br><span class="line">            <span class="attr">Rule:</span> <span class="string">&quot;ANY Writers&quot;</span></span><br><span class="line">        <span class="attr">Admins:</span></span><br><span class="line">            <span class="attr">Type:</span> <span class="string">ImplicitMeta</span></span><br><span class="line">            <span class="attr">Rule:</span> <span class="string">&quot;MAJORITY Admins&quot;</span></span><br><span class="line">        <span class="attr">BlockValidation:</span></span><br><span class="line">            <span class="attr">Type:</span> <span class="string">ImplicitMeta</span></span><br><span class="line">            <span class="attr">Rule:</span> <span class="string">&quot;ANY Writers&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Channel:</span> <span class="meta">&amp;ChannelDefaults</span></span><br><span class="line">    <span class="attr">Policies:</span></span><br><span class="line">        <span class="attr">Readers:</span></span><br><span class="line">            <span class="attr">Type:</span> <span class="string">ImplicitMeta</span></span><br><span class="line">            <span class="attr">Rule:</span> <span class="string">&quot;ANY Readers&quot;</span></span><br><span class="line">        <span class="attr">Writers:</span></span><br><span class="line">            <span class="attr">Type:</span> <span class="string">ImplicitMeta</span></span><br><span class="line">            <span class="attr">Rule:</span> <span class="string">&quot;ANY Writers&quot;</span></span><br><span class="line">        <span class="attr">Admins:</span></span><br><span class="line">            <span class="attr">Type:</span> <span class="string">ImplicitMeta</span></span><br><span class="line">            <span class="attr">Rule:</span> <span class="string">&quot;MAJORITY Admins&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">Capabilities:</span></span><br><span class="line">        <span class="string">&lt;&lt;:</span> <span class="meta">*ChannelCapabilities</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Profiles:</span></span><br><span class="line">    <span class="attr">TwoOrgsOrdererGenesis:</span></span><br><span class="line">        <span class="string">&lt;&lt;:</span> <span class="meta">*ChannelDefaults</span></span><br><span class="line">        <span class="attr">Orderer:</span></span><br><span class="line">            <span class="string">&lt;&lt;:</span> <span class="meta">*OrdererDefaults</span></span><br><span class="line">            <span class="attr">Organizations:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="meta">*OrdererOrg</span></span><br><span class="line">            <span class="attr">Capabilities:</span></span><br><span class="line">                <span class="string">&lt;&lt;:</span> <span class="meta">*OrdererCapabilities</span></span><br><span class="line">        <span class="attr">Consortiums:</span></span><br><span class="line">            <span class="attr">SampleConsortium:</span></span><br><span class="line">                <span class="attr">Organizations:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="meta">*Org1</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="meta">*Org2</span></span><br><span class="line">    <span class="attr">TwoOrgsChannel:</span></span><br><span class="line">        <span class="attr">Consortium:</span> <span class="string">SampleConsortium</span></span><br><span class="line">        <span class="attr">Application:</span></span><br><span class="line">            <span class="string">&lt;&lt;:</span> <span class="meta">*ApplicationDefaults</span></span><br><span class="line">            <span class="attr">Organizations:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="meta">*Org1</span></span><br><span class="line">                <span class="bullet">-</span> <span class="meta">*Org2</span></span><br><span class="line">            <span class="attr">Capabilities:</span></span><br><span class="line">                <span class="string">&lt;&lt;:</span> <span class="meta">*ApplicationCapabilities</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">SampleDevModeKafka:</span></span><br><span class="line">        <span class="string">&lt;&lt;:</span> <span class="meta">*ChannelDefaults</span></span><br><span class="line">        <span class="attr">Capabilities:</span></span><br><span class="line">            <span class="string">&lt;&lt;:</span> <span class="meta">*ChannelCapabilities</span></span><br><span class="line">        <span class="attr">Orderer:</span></span><br><span class="line">            <span class="string">&lt;&lt;:</span> <span class="meta">*OrdererDefaults</span></span><br><span class="line">            <span class="attr">OrdererType:</span> <span class="string">kafka</span></span><br><span class="line">            <span class="attr">Kafka:</span></span><br><span class="line">                <span class="attr">Brokers:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">kafka-0.broker.kafka:9092</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">kafka-1.broker.kafka:9092</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">kafka-2.broker.kafka:9092</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">kafka-3.broker.kafka:9092</span></span><br><span class="line"></span><br><span class="line">            <span class="attr">Organizations:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="meta">*OrdererOrg</span></span><br><span class="line">            <span class="attr">Capabilities:</span></span><br><span class="line">                <span class="string">&lt;&lt;:</span> <span class="meta">*OrdererCapabilities</span></span><br><span class="line">        <span class="attr">Application:</span></span><br><span class="line">            <span class="string">&lt;&lt;:</span> <span class="meta">*ApplicationDefaults</span></span><br><span class="line">            <span class="attr">Organizations:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">&lt;&lt;:</span> <span class="meta">*OrdererOrg</span></span><br><span class="line">        <span class="attr">Consortiums:</span></span><br><span class="line">            <span class="attr">SampleConsortium:</span></span><br><span class="line">                <span class="attr">Organizations:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="meta">*Org1</span></span><br><span class="line">                <span class="bullet">-</span> <span class="meta">*Org2</span></span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先需要创建一个文件夹</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="regexp">/opt/</span>jicki/channel-artifacts</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 创世区块  TwoOrgsOrdererGenesis 是 </span></span><br><span class="line"><span class="comment"># configtx.yaml 中 Profiles 字段下的名称</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-<span class="number">1</span> <span class="regexp">/opt/</span>jicki]<span class="comment"># configtxgen -profile TwoOrgsOrdererGenesis \</span></span><br><span class="line"> -outputBlock .<span class="regexp">/channel-artifacts/g</span>enesis.block</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 下面来生成一个 peer 服务 中使用的 tx 文件 TwoOrgsChannel 名称为 </span></span><br><span class="line">configtx.yaml 中 Profiles 字段下的，这里必须指定上面的 channelID</span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@kubernetes</span><span class="number">-1</span> /opt/jicki]<span class="meta"># configtxgen -profile TwoOrgsChannel -outputCreateChannelTx ./channel-artifacts/channel.tx -channelID mychannel</span></span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义组织 生成锚节点更新文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Org1MSP</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-<span class="number">1</span> <span class="regexp">/opt/</span>jicki]<span class="comment"># configtxgen -profile TwoOrgsChannel \</span></span><br><span class="line">-outputAnchorPeersUpdate .<span class="regexp">/channel-artifacts/</span>Org1MSPanchors.tx -channelID mychannel -asOrg Org1MSP</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Org2MSP</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-<span class="number">1</span> <span class="regexp">/opt/</span>jicki]<span class="comment"># configtxgen -profile TwoOrgsChannel \</span></span><br><span class="line">-outputAnchorPeersUpdate .<span class="regexp">/channel-artifacts/</span>Org2MSPanchors.tx -channelID mychannel -asOrg Org2MSP</span><br></pre></td></tr></table></figure>

<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 查看生成文件</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@kubernetes</span><span class="number">-1</span> /opt/jicki]<span class="meta"># tree channel-artifacts/</span></span><br><span class="line">channel-artifacts/</span><br><span class="line">├── channel.tx</span><br><span class="line">├── genesis.block</span><br><span class="line">├── Org1MSPanchors.tx</span><br><span class="line">└── Org2MSPanchors.tx</span><br><span class="line"></span><br><span class="line"><span class="number">0</span> directories, <span class="number">4</span> files</span><br></pre></td></tr></table></figure>

<h1 id="三-配置-NFS-StorageClass"><a href="#三-配置-NFS-StorageClass" class="headerlink" title="三. 配置 NFS StorageClass"></a>三. 配置 NFS StorageClass</h1><blockquote>
<p>NFS 用于 k8s 中 文件挂载，共享</p>
</blockquote>
<h2 id="1-安装-NFS"><a href="#1-安装-NFS" class="headerlink" title="1. 安装 NFS"></a>1. 安装 NFS</h2><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 服务端 安装 NFS 软件</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@kubernetes</span><span class="number">-3</span> ~]<span class="meta"># yum -y install nfs-utils rpcbind</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta"># k8s 所有节点 安装 NFS 客户端</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@kubernetes</span><span class="number">-1</span> ~]<span class="meta"># yum -y install nfs-utils</span></span><br><span class="line">[root<span class="symbol">@kubernetes</span><span class="number">-2</span> ~]<span class="meta"># yum -y install nfs-utils</span></span><br></pre></td></tr></table></figure>

<h2 id="2-配置-NFS"><a href="#2-配置-NFS" class="headerlink" title="2. 配置 NFS"></a>2. 配置 NFS</h2><blockquote>
<p>这里需要创建几个目录 &#x2F;opt&#x2F;nfs&#x2F;data, &#x2F;opt&#x2F;nfs&#x2F;fabric&#x2F;</p>
<p>&#x2F;opt&#x2F;nfs&#x2F;data 用于存放 zk, kafka 数据</p>
<p>&#x2F;opt&#x2F;nfs&#x2F;fabric 用于存放 fabric 所有的文件</p>
</blockquote>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@kubernetes</span>-<span class="number">3</span> ~]<span class="comment"># mkdir -p /opt/nfs/&#123;data,fabric&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改配置文件</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@kubernetes</span>-<span class="number">3</span> ~]<span class="comment"># vi /etc/exports</span></span><br><span class="line"></span><br><span class="line">增加</span><br><span class="line"></span><br><span class="line"><span class="regexp">/opt/nfs</span><span class="regexp">/data       192.168.0.0/</span><span class="number">24</span>(rw,sync,no_root_squash)</span><br><span class="line"><span class="regexp">/opt/nfs</span><span class="regexp">/fabric     192.168.0.0/</span><span class="number">24</span>(rw,sync,no_root_squash)</span><br></pre></td></tr></table></figure>

<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动 NFS 服务</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@kubernetes</span>-<span class="number">3</span> ~]<span class="comment"># systemctl enable rpcbind.service    </span></span><br><span class="line">[root<span class="variable">@kubernetes</span>-<span class="number">3</span> ~]<span class="comment"># systemctl enable nfs-server.service</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@kubernetes</span>-<span class="number">3</span> ~]<span class="comment"># systemctl start rpcbind.service    </span></span><br><span class="line">[root<span class="variable">@kubernetes</span>-<span class="number">3</span> ~]<span class="comment"># systemctl start nfs-server.service</span></span><br><span class="line"></span><br><span class="line">[root<span class="variable">@kubernetes</span>-<span class="number">3</span> ~]<span class="comment"># systemctl status rpcbind.service    </span></span><br><span class="line">[root<span class="variable">@kubernetes</span>-<span class="number">3</span> ~]<span class="comment"># systemctl status nfs-server.service</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看服务</span></span><br><span class="line">[root<span class="variable">@kubernetes</span>-<span class="number">3</span> ~]<span class="comment"># showmount -e 192.168.0.249</span></span><br><span class="line">Export list <span class="keyword">for</span> <span class="number">192.168</span>.<span class="number">0.249</span>:</span><br><span class="line"><span class="regexp">/opt/nfs</span><span class="regexp">/fabric 192.168.0.0/</span><span class="number">24</span></span><br><span class="line"><span class="regexp">/opt/nfs</span><span class="regexp">/data   192.168.0.0/</span><span class="number">24</span></span><br></pre></td></tr></table></figure>

<h2 id="3-配置-NFS-Client-Provisioner"><a href="#3-配置-NFS-Client-Provisioner" class="headerlink" title="3. 配置 NFS Client Provisioner"></a>3. 配置 NFS Client Provisioner</h2><blockquote>
<p>官方 说明 <a href="https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client">https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client</a></p>
</blockquote>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载官方 yaml 文件</span></span><br><span class="line"></span><br><span class="line">wget https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/kubernetes-incubator/</span>external-storage<span class="regexp">/master/</span>nfs-client<span class="regexp">/deploy/</span>rbac.yaml</span><br><span class="line"></span><br><span class="line">wget https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/kubernetes-incubator/</span>external-storage<span class="regexp">/master/</span>nfs-client<span class="regexp">/deploy/</span>deployment.yaml</span><br><span class="line"></span><br><span class="line">wget https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/kubernetes-incubator/</span>external-storage<span class="regexp">/master/</span>nfs-client<span class="regexp">/deploy/</span>class.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改 deployment.yaml 文件</span></span><br><span class="line"></span><br><span class="line"><span class="string">vi</span> <span class="string">deployment.yaml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">quay.io/external_storage/nfs-client-provisioner:latest</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.249</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/opt/nfs/data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.249</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/opt/nfs/data</span></span><br></pre></td></tr></table></figure>

<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改 class.yaml , 这里修改 name 名称</span></span><br><span class="line"></span><br><span class="line">vi class.yaml</span><br><span class="line"></span><br><span class="line"><span class="params">apiVersion:</span> storage.k8s.io<span class="symbol">/v1</span></span><br><span class="line"><span class="params">kind:</span> StorageClass</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> zk-kafka-nfs-storage</span><br><span class="line"><span class="params">provisioner:</span> fuseim.pri<span class="symbol">/ifs</span> </span><br><span class="line"><span class="params">parameters:</span></span><br><span class="line">  <span class="params">archiveOnDelete:</span> <span class="string">&quot;false&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 导入 yaml 文件</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes<span class="number">-1</span> /opt/yaml/nfs-<span class="keyword">client</span>]<span class="meta"># kubectl apply -f .</span></span><br><span class="line">storageclass.storage.k8s.io/fabric-nfs-storage created</span><br><span class="line">serviceaccount/nfs-<span class="keyword">client</span>-provisioner created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/nfs-<span class="keyword">client</span>-provisioner-runner created</span><br><span class="line">deployment.extensions/nfs-<span class="keyword">client</span>-provisioner created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/run-nfs-<span class="keyword">client</span>-provisioner created</span><br><span class="line">role.rbac.authorization.k8s.io/leader-locking-nfs-<span class="keyword">client</span>-provisioner created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/leader-locking-nfs-<span class="keyword">client</span>-provisioner created</span><br></pre></td></tr></table></figure>

<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 查看服务</span><br><span class="line"></span><br><span class="line">[root@kubernetes<span class="number">-1</span> /opt/yaml/<span class="built_in">nfs</span>-client]# kubectl <span class="built_in">get</span> storage<span class="keyword">class</span></span><br><span class="line"><span class="title class_">NAME</span>                   PROVISIONER      AGE</span><br><span class="line">zk-kafka-<span class="built_in">nfs</span>-storage   fuseim.<span class="property">pri</span>/ifs   <span class="number">27</span>s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes<span class="number">-1</span> /opt/yaml/<span class="built_in">nfs</span>-client]# kubectl <span class="built_in">get</span> pods</span><br><span class="line">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class="line"><span class="built_in">nfs</span>-client-provisioner<span class="number">-578785</span>c589-qlgnx   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>m24s</span><br></pre></td></tr></table></figure>

<h1 id="四-部署-Fabric"><a href="#四-部署-Fabric" class="headerlink" title="四. 部署 Fabric"></a>四. 部署 Fabric</h1><h2 id="1-创建-zookeeper"><a href="#1-创建-zookeeper" class="headerlink" title="1. 创建 zookeeper"></a>1. 创建 zookeeper</h2><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@kubernetes<span class="number">-1</span> <span class="keyword">/opt/</span>jicki/k8s-yaml]<span class="meta"># vi kafka-namespace.yaml</span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> Namespace</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> kafka</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 zk</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@kubernetes-1</span> <span class="string">/opt/jicki/k8s-yaml</span>]<span class="comment"># vi zookeeper.yaml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zoo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;zoo&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">zookeeper</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">zookeeper</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">hyperledger/fabric-zookeeper:0.4.14</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">2181</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">client</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">2888</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">peer</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">3888</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">leader-election</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">zkdata</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/var/lib/zookeeper</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">zkdata</span> </span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">volume.beta.kubernetes.io/storage-class:</span> <span class="string">&quot;zk-kafka-nfs-storage&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zoo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">2888</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">peer</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3888</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">leader-election</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">zookeeper</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">zookeeper</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">2181</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">client</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">zookeeper</span></span><br></pre></td></tr></table></figure>

<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 导入 yaml 文件</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@kubernetes</span><span class="number">-1</span> /opt/jicki/k8s-yaml]<span class="meta"># kubectl apply -f namespace.yaml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@kubernetes</span><span class="number">-1</span> /opt/jicki/k8s-yaml]<span class="meta"># kubectl apply -f zookeeper.yaml</span></span><br></pre></td></tr></table></figure>

<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看服务</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-<span class="number">1</span> <span class="operator">/</span>opt<span class="operator">/</span>jicki<span class="operator">/</span>k8s-yaml]<span class="comment"># kubectl get all -n kafka</span></span><br><span class="line">NAME        READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod<span class="symbol">/zoo-0</span>   <span class="number">1</span><span class="symbol">/1</span>     Running   <span class="number">0</span>          <span class="number">20</span>m</span><br><span class="line">pod<span class="symbol">/zoo-1</span>   <span class="number">1</span><span class="symbol">/1</span>     Running   <span class="number">0</span>          <span class="number">9</span>m11s</span><br><span class="line">pod<span class="symbol">/zoo-2</span>   <span class="number">1</span><span class="symbol">/1</span>     Running   <span class="number">0</span>          <span class="number">111</span>s</span><br><span class="line">pod<span class="symbol">/zoo-3</span>   <span class="number">1</span><span class="symbol">/1</span>     Running   <span class="number">0</span>          <span class="number">108</span>s</span><br><span class="line"></span><br><span class="line">NAME                TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line">service<span class="symbol">/zoo</span>         ClusterIP   None           <span class="symbol">&lt;none&gt;</span>        <span class="number">2888</span><span class="operator">/</span>TCP,<span class="number">3888</span><span class="symbol">/TCP</span>   <span class="number">21</span>m</span><br><span class="line">service<span class="symbol">/zookeeper</span>   ClusterIP   <span class="number">10.233</span>.<span class="number">22.96</span>   <span class="symbol">&lt;none&gt;</span>        <span class="number">2181</span><span class="symbol">/TCP</span>            <span class="number">21</span>m</span><br><span class="line"></span><br><span class="line">NAME                   READY   AGE</span><br><span class="line">statefulset.apps<span class="symbol">/zoo</span>   <span class="number">4</span><span class="symbol">/4</span>     <span class="number">20</span>m</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-创建-kafka"><a href="#2-创建-kafka" class="headerlink" title="2. 创建 kafka"></a>2. 创建 kafka</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">vi</span> <span class="string">kafka.yaml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kafka</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">&quot;broker&quot;</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">4</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">kafka</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">broker</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">hyperledger/fabric-kafka:0.4.14</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9092</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KAFKA_MESSAGE_MAX_BYTES</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;102760448&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KAFKA_REPLICA_FETCH_MAX_BYTES</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;102760448&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KAFKA_UNCLEAN_LEADER_ELECTION_ENABLE</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KAFKA_ZOOKEEPER_CONNECT</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">zoo-0.zoo:2181,zoo-1.zoo:2181,zoo-2.zoo:2181,zoo-3.zoo:2181</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KAFKA_PORT</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;9092&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GODEBUG</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">netdns=go</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KAFKA_ZOOKEEPER_CONNECTION_TIMEOUT_MS</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;30000&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KAFKA_LOG_DIRS</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">/opt/kafka/data</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">KAFKA_LOG_RETENTION_MS</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;-1&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kafkadata</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/opt/kafka/data</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kafkadata</span> </span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">volume.beta.kubernetes.io/storage-class:</span> <span class="string">&quot;zk-kafka-nfs-storage&quot;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">20Gi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kafka</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9092</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kafka</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">broker</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kafka</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9092</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">kafka</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入 yaml 文件</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f kafka.yaml </span><br><span class="line">statefulset.apps/kafka created</span><br><span class="line">service/kafka created</span><br><span class="line">service/broker created</span><br></pre></td></tr></table></figure>

<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看服务</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-<span class="number">1</span> <span class="operator">/</span>opt<span class="operator">/</span>jicki<span class="operator">/</span>k8s-yaml]<span class="comment"># kubectl get pods -n kafka</span></span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE</span><br><span class="line">kafka-<span class="number">0</span>   <span class="number">1</span><span class="symbol">/1</span>     Running   <span class="number">0</span>          <span class="number">2</span>m26s</span><br><span class="line">kafka-<span class="number">1</span>   <span class="number">1</span><span class="symbol">/1</span>     Running   <span class="number">0</span>          <span class="number">100</span>s</span><br><span class="line">kafka-<span class="number">2</span>   <span class="number">1</span><span class="symbol">/1</span>     Running   <span class="number">0</span>          <span class="number">53</span>s</span><br><span class="line">kafka-<span class="number">3</span>   <span class="number">1</span><span class="symbol">/1</span>     Running   <span class="number">0</span>          <span class="number">43</span>s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-<span class="number">1</span> <span class="operator">/</span>opt<span class="operator">/</span>jicki<span class="operator">/</span>k8s-yaml]<span class="comment"># kubectl get svc -n kafka</span></span><br><span class="line">NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)             AGE</span><br><span class="line">broker      ClusterIP   None            <span class="symbol">&lt;none&gt;</span>        <span class="number">9092</span><span class="symbol">/TCP</span>            <span class="number">2</span>m45s</span><br><span class="line">kafka       ClusterIP   <span class="number">10.233</span>.<span class="number">48.233</span>   <span class="symbol">&lt;none&gt;</span>        <span class="number">9092</span><span class="symbol">/TCP</span>            <span class="number">2</span>m45s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-<span class="number">1</span> <span class="operator">/</span>opt<span class="operator">/</span>jicki<span class="operator">/</span>k8s-yaml]<span class="comment"># kubectl get statefulset -n kafka</span></span><br><span class="line">NAME    READY   AGE</span><br><span class="line">kafka   <span class="number">4</span><span class="symbol">/4</span>     <span class="number">3</span>m13s</span><br></pre></td></tr></table></figure>

<h2 id="3-创建-Fabric-服务"><a href="#3-创建-Fabric-服务" class="headerlink" title="3. 创建 Fabric 服务"></a>3. 创建 Fabric 服务</h2><h3 id="3-1-初始化"><a href="#3-1-初始化" class="headerlink" title="3.1 初始化"></a>3.1 初始化</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 操作的机器上 挂载 nfs 目录 /opt/nfs/fabric</span></span><br><span class="line"><span class="comment"># 为了预先拷贝一些证书进去</span></span><br><span class="line"></span><br><span class="line">mkdir -p /opt/nfs/fabric</span><br><span class="line"></span><br><span class="line">mount -t nfs <span class="number">192.168</span>.<span class="number">0.249</span><span class="symbol">:/opt/nfs/fabric</span> /opt/nfs/fabric</span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拷贝文件到挂载目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建两个目录 data 数据目录, 以及 证书，创世区块 等文件目录</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="regexp">/opt/</span>nfs<span class="regexp">/fabric/</span>&#123;data,fabric&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拷贝 证书文件 创世区块 文件</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> ./channel-artifacts/chaincode</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> -r ./fabric/examples/chaincode/go/example* channel-artifacts/chaincode/</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> ./channel-artifacts/genesis.block ./crypto-config/ordererOrganizations/*</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> -r ./crypto-config /opt/nfs/fabric/fabric/</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> -r ./channel-artifacts /opt/nfs/fabric/fabric/</span><br></pre></td></tr></table></figure>

<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 创建 fabric 运行时生成的共享数据文件夹</span></span><br><span class="line"></span><br><span class="line"><span class="title">mkdir</span> -p /opt/nfs/fabric/<span class="class"><span class="keyword">data</span>/&#123;<span class="title">orderer</span>,<span class="title">peer</span>&#125;</span></span><br><span class="line"><span class="title">mkdir</span> -p /opt/nfs/fabric/<span class="class"><span class="keyword">data</span>/orderer/orgorderer1/orderer0</span></span><br><span class="line"><span class="title">mkdir</span> -p /opt/nfs/fabric/<span class="class"><span class="keyword">data</span>/peer/org&#123;1,2&#125;/ca</span></span><br><span class="line"><span class="title">mkdir</span> -p /opt/nfs/fabric/<span class="class"><span class="keyword">data</span>/peer/org&#123;1,2&#125;/peer&#123;0,1&#125;/&#123;<span class="title">couchdb</span>,<span class="title">peerdata</span>&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-2-配置-orderer"><a href="#3-2-配置-orderer" class="headerlink" title="3.2 配置 orderer"></a>3.2 配置 orderer</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 创建 orderer1 的 namespaces </span></span><br><span class="line"></span><br><span class="line">vi orgorderer1-namespace.yaml</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> Namespace</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">    name:</span> orgorderer1</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 orderer1 的 pv 与 pvc</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">vi</span> <span class="string">orgorderer1-pv-pvc.yaml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">orgorderer1-pv</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">orgorderer1-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">500Mi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/opt/nfs/fabric/fabric/crypto-config/ordererOrganizations/orgorderer1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.249</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">namespace:</span> <span class="string">orgorderer1</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">orgorderer1-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">accessModes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line"> <span class="attr">resources:</span></span><br><span class="line">   <span class="attr">requests:</span></span><br><span class="line">     <span class="attr">storage:</span> <span class="string">10Mi</span></span><br><span class="line"> <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">matchLabels:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">orgorderer1-pv</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">orgorderer1-pvdata</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">orgorderer1-pvdata</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/opt/nfs/fabric/data/orderer/orgorderer1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.249</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">namespace:</span> <span class="string">orgorderer1</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">orgorderer1-pvdata</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">accessModes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line"> <span class="attr">resources:</span></span><br><span class="line">   <span class="attr">requests:</span></span><br><span class="line">     <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line"> <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">matchLabels:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">orgorderer1-pvdata</span></span><br></pre></td></tr></table></figure>

<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 orderer1 Deployment 服务</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi orderer0.orgorderer1.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="params">apiVersion:</span> extensions<span class="symbol">/v1beta1</span></span><br><span class="line"><span class="params">kind:</span> Deployment</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">namespace:</span> orgorderer1</span><br><span class="line">  <span class="params">name:</span> orderer0-orgorderer1</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="params">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="params">template:</span></span><br><span class="line">    <span class="params">metadata:</span></span><br><span class="line">      <span class="params">labels:</span></span><br><span class="line">        <span class="params">app:</span> hyperledger</span><br><span class="line">        <span class="params">role:</span> orderer</span><br><span class="line">        <span class="params">org:</span> orgorderer1</span><br><span class="line">        <span class="params">orderer-id:</span> orderer0</span><br><span class="line">    <span class="params">spec:</span></span><br><span class="line">      <span class="params">containers:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> orderer0-orgorderer1</span><br><span class="line">        <span class="params">image:</span> hyperledger<span class="operator">/</span>fabric-orderer:<span class="number">1.4</span>.<span class="number">0</span></span><br><span class="line">        <span class="params">env:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> ORDERER_GENERAL_LOGLEVEL</span><br><span class="line">          <span class="params">value:</span> debug</span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> ORDERER_GENERAL_LISTENADDRESS</span><br><span class="line">          <span class="params">value:</span> <span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> ORDERER_GENERAL_GENESISMETHOD</span><br><span class="line">          <span class="params">value:</span> file</span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> ORDERER_GENERAL_GENESISFILE</span><br><span class="line">          <span class="params">value:</span> <span class="symbol">/var/hyperledger/orderer/orderer.genesis.block</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> ORDERER_GENERAL_LOCALMSPID</span><br><span class="line">          <span class="params">value:</span> Orgorderer1MSP</span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> ORDERER_GENERAL_LOCALMSPDIR</span><br><span class="line">          <span class="params">value:</span> <span class="symbol">/var/hyperledger/orderer/msp</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> ORDERER_GENERAL_TLS_ENABLED</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> ORDERER_GENERAL_TLS_PRIVATEKEY</span><br><span class="line">          <span class="params">value:</span> <span class="symbol">/var/hyperledger/orderer/tls/server.key</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> ORDERER_GENERAL_TLS_CERTIFICATE</span><br><span class="line">          <span class="params">value:</span> <span class="symbol">/var/hyperledger/orderer/tls/server.crt</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> ORDERER_GENERAL_TLS_ROOTCAS</span><br><span class="line">          <span class="params">value:</span> &#x27;[<span class="operator">/</span>var<span class="operator">/</span>hyperledger<span class="operator">/</span>orderer<span class="operator">/</span>tls<span class="operator">/</span>ca.crt]&#x27;</span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> ORDERER_KAFKA_VERSION</span><br><span class="line">          <span class="params">value:</span> <span class="number">0.10</span>.<span class="number">0.1</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> ORDERER_KAFKA_VERBOSE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> ORDERER_KAFKA_BROKERS</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;kafka-0.broker.kafka:9092,kafka-1.broker.kafka:9092,kafka-2.broker.kafka:9092,kafka-3.broker.kafka:9092&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> GODEBUG</span><br><span class="line">          <span class="params">value:</span> netdns<span class="operator">=</span>go</span><br><span class="line">        <span class="params">workingDir:</span> <span class="symbol">/opt/gopath/src/github.com/hyperledger/fabric</span></span><br><span class="line">        <span class="params">ports:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">7050</span></span><br><span class="line">        <span class="params">command:</span> [<span class="string">&quot;orderer&quot;</span>]</span><br><span class="line">        <span class="params">volumeMounts:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/var/hyperledger/orderer/msp</span></span><br><span class="line">           <span class="params">name:</span> certificate</span><br><span class="line">           <span class="params">subPath:</span> orderers<span class="symbol">/orderer0.orgorderer1/msp</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/var/hyperledger/orderer/tls</span></span><br><span class="line">           <span class="params">name:</span> certificate</span><br><span class="line">           <span class="params">subPath:</span> orderers<span class="symbol">/orderer0.orgorderer1/tls</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/var/hyperledger/orderer/orderer.genesis.block</span></span><br><span class="line">           <span class="params">name:</span> certificate</span><br><span class="line">           <span class="params">subPath:</span> genesis.block</span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/var/hyperledger/production</span></span><br><span class="line">           <span class="params">name:</span> ordererdata</span><br><span class="line">           <span class="params">subPath:</span> orderer0</span><br><span class="line">      <span class="params">volumes:</span></span><br><span class="line">       <span class="operator">-</span> <span class="params">name:</span> certificate</span><br><span class="line">         <span class="params">persistentVolumeClaim:</span></span><br><span class="line">             <span class="params">claimName:</span> orgorderer1-pv</span><br><span class="line">       <span class="operator">-</span> <span class="params">name:</span> ordererdata</span><br><span class="line">         <span class="params">persistentVolumeClaim:</span></span><br><span class="line">             <span class="params">claimName:</span> orgorderer1-pvdata</span><br><span class="line"></span><br><span class="line"><span class="operator">-</span>--</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Service</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">name:</span> orderer0</span><br><span class="line">  <span class="params">namespace:</span> orgorderer1</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line"> <span class="params">selector:</span></span><br><span class="line">   <span class="params">app:</span> hyperledger</span><br><span class="line">   <span class="params">role:</span> orderer</span><br><span class="line">   <span class="params">orderer-id:</span> orderer0</span><br><span class="line">   <span class="params">org:</span> orgorderer1</span><br><span class="line"> <span class="params">type:</span> NodePort</span><br><span class="line"> <span class="params">ports:</span></span><br><span class="line">   <span class="operator">-</span> <span class="params">name:</span> listen-endpoint</span><br><span class="line">     <span class="params">protocol:</span> TCP</span><br><span class="line">     <span class="params">port:</span> <span class="number">7050</span></span><br><span class="line">     <span class="params">targetPort:</span> <span class="number">7050</span></span><br><span class="line">     <span class="params">nodePort:</span> <span class="number">32000</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入 yaml 文件 创建服务</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 namespaces</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f orgorderer1-namespace.yaml </span><br><span class="line">namespace/orgorderer1 created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 pv pvc</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f orgorderer1-pv-pvc.yaml </span><br><span class="line">persistentvolume/orgorderer1-pv created</span><br><span class="line">persistentvolumeclaim/orgorderer1-pv created</span><br><span class="line">persistentvolume/orgorderer1-pvdata created</span><br><span class="line">persistentvolumeclaim/orgorderer1-pvdata created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 deployment</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f orderer0.orgorderer1.yaml </span><br><span class="line">deployment.extensions/orderer0-orgorderer1 created</span><br><span class="line">service/orderer0 created</span><br></pre></td></tr></table></figure>

<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 查看创建的服务</span><br><span class="line"></span><br><span class="line">[root<span class="meta">@kubernetes</span><span class="operator">-</span><span class="number">1</span> <span class="regexp">/opt/</span>jicki<span class="operator">/</span>k8s<span class="operator">-</span>yaml]# kubectl <span class="keyword">get</span> pods <span class="operator">-</span>n orgorderer1</span><br><span class="line"><span class="type">NAME</span>                                    <span class="type">READY</span>   <span class="type">STATUS</span>    <span class="type">RESTARTS</span>   <span class="type">AGE</span></span><br><span class="line">orderer0<span class="operator">-</span>orgorderer1<span class="operator">-</span>6b896b94c4<span class="operator">-</span>5gs2c   <span class="number">1</span><span class="operator">/</span><span class="number">1</span>     <span class="type">Running</span>   <span class="number">0</span>          36s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="meta">@kubernetes</span><span class="operator">-</span><span class="number">1</span> <span class="regexp">/opt/</span>jicki<span class="operator">/</span>k8s<span class="operator">-</span>yaml]# kubectl <span class="keyword">get</span> pv</span><br><span class="line"><span class="type">NAME</span>                                       <span class="type">CAPACITY</span>   <span class="type">ACCESS</span> <span class="type">MODES</span>   <span class="type">RECLAIM</span> <span class="type">POLICY</span>   <span class="type">STATUS</span>   <span class="type">CLAIM</span>                            <span class="type">STORAGECLASS</span>           <span class="type">REASON</span>   <span class="type">AGE</span></span><br><span class="line">orgorderer1<span class="operator">-</span>pv                             500Mi      <span class="type">RWX</span>            <span class="type">Retain</span>           <span class="type">Bound</span>    orgorderer1<span class="operator">/</span>orgorderer1<span class="operator">-</span>pv                                       115s</span><br><span class="line">orgorderer1<span class="operator">-</span>pvdata                         10Gi       <span class="type">RWX</span>            <span class="type">Retain</span>           <span class="type">Bound</span>    orgorderer1<span class="operator">/</span>orgorderer1<span class="operator">-</span>pvdata                                   115s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root<span class="meta">@kubernetes</span><span class="operator">-</span><span class="number">1</span> <span class="regexp">/opt/</span>jicki<span class="operator">/</span>k8s<span class="operator">-</span>yaml]# kubectl <span class="keyword">get</span> pvc <span class="operator">-</span>n orgorderer1</span><br><span class="line"><span class="type">NAME</span>                 <span class="type">STATUS</span>   <span class="type">VOLUME</span>               <span class="type">CAPACITY</span>   <span class="type">ACCESS</span> <span class="type">MODES</span>   <span class="type">STORAGECLASS</span>   <span class="type">AGE</span></span><br><span class="line">orgorderer1<span class="operator">-</span>pv       <span class="type">Bound</span>    orgorderer1<span class="operator">-</span>pv       500Mi      <span class="type">RWX</span>                           2m9s</span><br><span class="line">orgorderer1<span class="operator">-</span>pvdata   <span class="type">Bound</span>    orgorderer1<span class="operator">-</span>pvdata   10Gi       <span class="type">RWX</span> </span><br></pre></td></tr></table></figure>

<h3 id="3-3-配置-org1-服务"><a href="#3-3-配置-org1-服务" class="headerlink" title="3.3 配置 org1 服务"></a>3.3 配置 org1 服务</h3><blockquote>
<p>每个 org 包含 ca cli peer 三个服务</p>
</blockquote>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 配置 org1 namespaces</span></span><br><span class="line"></span><br><span class="line">vi org1-namespace.yaml</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> Namespace</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">    name:</span> org1</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 org1  pv 与 pvc</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">vi</span> <span class="string">org1-pv-pvc.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">org1-pv</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">org1-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">500Mi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/opt/nfs/fabric/fabric/crypto-config/peerOrganizations/org1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.249</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">namespace:</span> <span class="string">org1</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">org1-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">accessModes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line"> <span class="attr">resources:</span></span><br><span class="line">   <span class="attr">requests:</span></span><br><span class="line">     <span class="attr">storage:</span> <span class="string">10Mi</span></span><br><span class="line"> <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">matchLabels:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">org1-pv</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">org1-pvdata</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">org1-pvdata</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/opt/nfs/fabric/data/peer/org1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.249</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">namespace:</span> <span class="string">org1</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">org1-pvdata</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">accessModes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line"> <span class="attr">resources:</span></span><br><span class="line">   <span class="attr">requests:</span></span><br><span class="line">     <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line"> <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">matchLabels:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">org1-pvdata</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 org1  ca</span></span><br><span class="line"><span class="comment"># FABRIC_CA_SERVER_TLS_KEYFILE 配置为自己生成的 sk</span></span><br><span class="line"><span class="comment"># sk 存在目录 crypto-config/peerOrganizations/org1/ca/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">vi</span> <span class="string">org1-ca.yaml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">org1</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ca</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">       <span class="attr">app:</span> <span class="string">hyperledger</span></span><br><span class="line">       <span class="attr">role:</span> <span class="string">ca</span></span><br><span class="line">       <span class="attr">org:</span> <span class="string">org1</span></span><br><span class="line">       <span class="attr">name:</span> <span class="string">ca</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">     <span class="attr">containers:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ca</span></span><br><span class="line">         <span class="attr">image:</span> <span class="string">hyperledger/fabric-ca:1.4.0</span></span><br><span class="line">         <span class="attr">env:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FABRIC_CA_HOME</span></span><br><span class="line">           <span class="attr">value:</span> <span class="string">/etc/hyperledger/fabric-ca-server</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FABRIC_CA_SERVER_CA_NAME</span></span><br><span class="line">           <span class="attr">value:</span> <span class="string">ca</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FABRIC_CA_SERVER_TLS_ENABLED</span></span><br><span class="line">           <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FABRIC_CA_SERVER_TLS_CERTFILE</span></span><br><span class="line">           <span class="attr">value:</span> <span class="string">/etc/hyperledger/fabric-ca-server-config/ca.org1-cert.pem</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FABRIC_CA_SERVER_TLS_KEYFILE</span></span><br><span class="line">           <span class="attr">value:</span> <span class="string">/etc/hyperledger/fabric-ca-server-config/904aa978bf690c8198526a6410045cc308468ca7171d02af70ffc7d969eb4c7e_sk</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GODEBUG</span></span><br><span class="line">           <span class="attr">value:</span> <span class="string">netdns=go</span></span><br><span class="line">         <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">7054</span></span><br><span class="line">         <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>]</span><br><span class="line">         <span class="attr">args:</span> [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot; fabric-ca-server start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org1-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/904aa978bf690c8198526a6410045cc308468ca7171d02af70ffc7d969eb4c7e_sk -b admin:adminpw -d &quot;</span>]</span><br><span class="line">         <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/hyperledger/fabric-ca-server-config</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">certificate</span></span><br><span class="line">            <span class="attr">subPath:</span> <span class="string">ca/</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/hyperledger/fabric-ca-server</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">cadata</span></span><br><span class="line">            <span class="attr">subPath:</span> <span class="string">ca/</span></span><br><span class="line">     <span class="attr">volumes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">certificate</span></span><br><span class="line">         <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">org1-pv</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cadata</span></span><br><span class="line">         <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">org1-pvdata</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">   <span class="attr">namespace:</span> <span class="string">org1</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">ca</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">app:</span> <span class="string">hyperledger</span></span><br><span class="line">   <span class="attr">role:</span> <span class="string">ca</span></span><br><span class="line">   <span class="attr">org:</span> <span class="string">org1</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">ca</span></span><br><span class="line"> <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"> <span class="attr">ports:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">endpoint</span></span><br><span class="line">     <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">     <span class="attr">port:</span> <span class="number">7054</span></span><br><span class="line">     <span class="attr">targetPort:</span> <span class="number">7054</span></span><br><span class="line">     <span class="attr">nodePort:</span> <span class="number">30000</span></span><br></pre></td></tr></table></figure>

<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 org1  peer 服务 </span></span><br><span class="line"><span class="comment"># 这里有两个 peer 分别为 peer0, peer1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi peer0.org1.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="params">apiVersion:</span> extensions<span class="symbol">/v1beta1</span></span><br><span class="line"><span class="params">kind:</span> Deployment</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">namespace:</span> org1</span><br><span class="line">  <span class="params">name:</span> peer0-org1</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="params">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="params">template:</span></span><br><span class="line">    <span class="params">metadata:</span></span><br><span class="line">      <span class="params">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="params">labels:</span></span><br><span class="line">       <span class="params">app:</span> hyperledger</span><br><span class="line">       <span class="params">role:</span> peer</span><br><span class="line">       <span class="params">peer-id:</span> peer0</span><br><span class="line">       <span class="params">org:</span> org1</span><br><span class="line">    <span class="params">spec:</span></span><br><span class="line">      <span class="params">containers:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> couchdb</span><br><span class="line">        <span class="params">image:</span> hyperledger<span class="operator">/</span>fabric-couchdb:<span class="number">0.4</span>.<span class="number">10</span></span><br><span class="line">        <span class="params">env:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">name:</span> COUCHDB_USER</span><br><span class="line">           <span class="params">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">name:</span> COUCHDB_PASSWORD</span><br><span class="line">           <span class="params">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="params">ports:</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">5984</span></span><br><span class="line">        <span class="params">volumeMounts:</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/opt/couchdb/data</span></span><br><span class="line">            <span class="params">name:</span> peerdata</span><br><span class="line">            <span class="params">subPath:</span> peer0<span class="symbol">/couchdb</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> peer0-org1</span><br><span class="line">        <span class="params">image:</span> hyperledger<span class="operator">/</span>fabric-peer:<span class="number">1.4</span>.<span class="number">0</span></span><br><span class="line">        <span class="params">env:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LEDGER_STATE_STATEDATABASE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;CouchDB&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;localhost:5984&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_VM_ENDPOINT</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;unix:///host/var/run/docker.sock&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LOGGING_LEVEL</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;DEBUG&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_ENABLED</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_GOSSIP_USELEADERELECTION</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_GOSSIP_ORGLEADER</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_PROFILE_ENABLED</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_CERT_FILE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;/etc/hyperledger/fabric/tls/server.crt&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_KEY_FILE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;/etc/hyperledger/fabric/tls/server.key&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_ROOTCERT_FILE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;/etc/hyperledger/fabric/tls/ca.crt&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_ADDRESSAUTODETECT</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_CHAINCODELISTENADDRESS</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;0.0.0.0:7052&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_ID</span><br><span class="line">          <span class="params">value:</span> peer0.org1</span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_ADDRESS</span><br><span class="line">          <span class="params">value:</span> peer0.org1:<span class="number">7051</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_GOSSIP_BOOTSTRAP</span><br><span class="line">          <span class="params">value:</span> peer0.org1:<span class="number">7051</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_GOSSIP_EXTERNALENDPOINT</span><br><span class="line">          <span class="params">value:</span> peer0.org1:<span class="number">7051</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_LOCALMSPID</span><br><span class="line">          <span class="params">value:</span> Org1MSP</span><br><span class="line">        <span class="params">workingDir:</span> <span class="symbol">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></span><br><span class="line">        <span class="params">ports:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">7051</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">7052</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">7053</span></span><br><span class="line">        <span class="params">command:</span> [<span class="string">&quot;peer&quot;</span>]</span><br><span class="line">        <span class="params">args:</span> [<span class="string">&quot;node&quot;</span>,<span class="string">&quot;start&quot;</span>]</span><br><span class="line">        <span class="params">volumeMounts:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/etc/hyperledger/fabric/msp</span></span><br><span class="line">           <span class="params">name:</span> certificate</span><br><span class="line">           <span class="params">subPath:</span> peers<span class="symbol">/peer0.org1/msp</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/etc/hyperledger/fabric/tls</span></span><br><span class="line">           <span class="params">name:</span> certificate</span><br><span class="line">           <span class="params">subPath:</span> peers<span class="symbol">/peer0.org1/tls</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/var/hyperledger/production</span></span><br><span class="line">           <span class="params">name:</span> peerdata</span><br><span class="line">           <span class="params">subPath:</span> peer0<span class="symbol">/peerdata</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="operator">/</span>host<span class="operator">/</span>var<span class="operator">/</span>run<span class="symbol">/</span></span><br><span class="line">           <span class="params">name:</span> run</span><br><span class="line">      <span class="params">volumes:</span></span><br><span class="line">       <span class="operator">-</span> <span class="params">name:</span> certificate</span><br><span class="line">         <span class="params">persistentVolumeClaim:</span></span><br><span class="line">             <span class="params">claimName:</span> org1-pv</span><br><span class="line">       <span class="operator">-</span> <span class="params">name:</span> peerdata</span><br><span class="line">         <span class="params">persistentVolumeClaim:</span></span><br><span class="line">             <span class="params">claimName:</span> org1-pvdata</span><br><span class="line">       <span class="operator">-</span> <span class="params">name:</span> run</span><br><span class="line">         <span class="params">hostPath:</span></span><br><span class="line">           <span class="params">path:</span> <span class="symbol">/var/run</span></span><br><span class="line"></span><br><span class="line"><span class="operator">-</span>--</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Service</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">   <span class="params">namespace:</span> org1</span><br><span class="line">   <span class="params">name:</span> peer0</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line"> <span class="params">selector:</span></span><br><span class="line">   <span class="params">app:</span> hyperledger</span><br><span class="line">   <span class="params">role:</span> peer</span><br><span class="line">   <span class="params">peer-id:</span> peer0</span><br><span class="line">   <span class="params">org:</span> org1</span><br><span class="line"> <span class="params">type:</span> NodePort</span><br><span class="line"> <span class="params">ports:</span></span><br><span class="line">   <span class="operator">-</span> <span class="params">name:</span> externale-listen-endpoint</span><br><span class="line">     <span class="params">protocol:</span> TCP</span><br><span class="line">     <span class="params">port:</span> <span class="number">7051</span></span><br><span class="line">     <span class="params">targetPort:</span> <span class="number">7051</span></span><br><span class="line">     <span class="params">nodePort:</span> <span class="number">30001</span></span><br><span class="line"></span><br><span class="line">   <span class="operator">-</span> <span class="params">name:</span> chaincode-listen</span><br><span class="line">     <span class="params">protocol:</span> TCP</span><br><span class="line">     <span class="params">port:</span> <span class="number">7052</span></span><br><span class="line">     <span class="params">targetPort:</span> <span class="number">7052</span></span><br><span class="line">     <span class="params">nodePort:</span> <span class="number">30002</span></span><br><span class="line"></span><br><span class="line">   <span class="operator">-</span> <span class="params">name:</span> event-listen</span><br><span class="line">     <span class="params">protocol:</span> TCP</span><br><span class="line">     <span class="params">port:</span> <span class="number">7053</span></span><br><span class="line">     <span class="params">targetPort:</span> <span class="number">7053</span></span><br><span class="line">     <span class="params">nodePort:</span> <span class="number">30003</span></span><br></pre></td></tr></table></figure>

<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line">vi peer1.org1.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="params">apiVersion:</span> extensions<span class="symbol">/v1beta1</span></span><br><span class="line"><span class="params">kind:</span> Deployment</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">namespace:</span> org1</span><br><span class="line">  <span class="params">name:</span> peer1-org1</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="params">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="params">template:</span></span><br><span class="line">    <span class="params">metadata:</span></span><br><span class="line">      <span class="params">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="params">labels:</span></span><br><span class="line">       <span class="params">app:</span> hyperledger</span><br><span class="line">       <span class="params">role:</span> peer</span><br><span class="line">       <span class="params">peer-id:</span> peer1</span><br><span class="line">       <span class="params">org:</span> org1</span><br><span class="line">    <span class="params">spec:</span></span><br><span class="line">      <span class="params">containers:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> couchdb</span><br><span class="line">        <span class="params">image:</span> hyperledger<span class="operator">/</span>fabric-couchdb:<span class="number">0.4</span>.<span class="number">10</span></span><br><span class="line">        <span class="params">env:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">name:</span> COUCHDB_USER</span><br><span class="line">           <span class="params">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">name:</span> COUCHDB_PASSWORD</span><br><span class="line">           <span class="params">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="params">ports:</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">5984</span></span><br><span class="line">        <span class="params">volumeMounts:</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/opt/couchdb/data</span></span><br><span class="line">            <span class="params">name:</span> peerdata</span><br><span class="line">            <span class="params">subPath:</span> peer1<span class="symbol">/couchdb</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> peer1-org1</span><br><span class="line">        <span class="params">image:</span> hyperledger<span class="operator">/</span>fabric-peer:<span class="number">1.4</span>.<span class="number">0</span></span><br><span class="line">        <span class="params">env:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LEDGER_STATE_STATEDATABASE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;CouchDB&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;localhost:5984&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_VM_ENDPOINT</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;unix:///host/var/run/docker.sock&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LOGGING_LEVEL</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;DEBUG&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_ENABLED</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_GOSSIP_USELEADERELECTION</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_GOSSIP_ORGLEADER</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_PROFILE_ENABLED</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_CERT_FILE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;/etc/hyperledger/fabric/tls/server.crt&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_KEY_FILE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;/etc/hyperledger/fabric/tls/server.key&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_ROOTCERT_FILE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;/etc/hyperledger/fabric/tls/ca.crt&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_ADDRESSAUTODETECT</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_CHAINCODELISTENADDRESS</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;0.0.0.0:7052&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_ID</span><br><span class="line">          <span class="params">value:</span> peer1.org1</span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_ADDRESS</span><br><span class="line">          <span class="params">value:</span> peer1.org1:<span class="number">7051</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_GOSSIP_BOOTSTRAP</span><br><span class="line">          <span class="params">value:</span> peer1.org1:<span class="number">7051</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_GOSSIP_EXTERNALENDPOINT</span><br><span class="line">          <span class="params">value:</span> peer1.org1:<span class="number">7051</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_LOCALMSPID</span><br><span class="line">          <span class="params">value:</span> Org1MSP</span><br><span class="line">        <span class="params">workingDir:</span> <span class="symbol">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></span><br><span class="line">        <span class="params">ports:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">7051</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">7052</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">7053</span></span><br><span class="line">        <span class="params">command:</span> [<span class="string">&quot;peer&quot;</span>]</span><br><span class="line">        <span class="params">args:</span> [<span class="string">&quot;node&quot;</span>,<span class="string">&quot;start&quot;</span>]</span><br><span class="line">        <span class="params">volumeMounts:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/etc/hyperledger/fabric/msp</span></span><br><span class="line">           <span class="params">name:</span> certificate</span><br><span class="line">           <span class="params">subPath:</span> peers<span class="symbol">/peer1.org1/msp</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/etc/hyperledger/fabric/tls</span></span><br><span class="line">           <span class="params">name:</span> certificate</span><br><span class="line">           <span class="params">subPath:</span> peers<span class="symbol">/peer1.org1/tls</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/var/hyperledger/production</span></span><br><span class="line">           <span class="params">name:</span> peerdata</span><br><span class="line">           <span class="params">subPath:</span> peer1<span class="symbol">/peerdata</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="operator">/</span>host<span class="operator">/</span>var<span class="operator">/</span>run<span class="symbol">/</span></span><br><span class="line">           <span class="params">name:</span> run</span><br><span class="line">      <span class="params">volumes:</span></span><br><span class="line">       <span class="operator">-</span> <span class="params">name:</span> certificate</span><br><span class="line">         <span class="params">persistentVolumeClaim:</span></span><br><span class="line">             <span class="params">claimName:</span> org1-pv</span><br><span class="line">       <span class="operator">-</span> <span class="params">name:</span> peerdata</span><br><span class="line">         <span class="params">persistentVolumeClaim:</span></span><br><span class="line">             <span class="params">claimName:</span> org1-pvdata</span><br><span class="line">       <span class="operator">-</span> <span class="params">name:</span> run</span><br><span class="line">         <span class="params">hostPath:</span></span><br><span class="line">           <span class="params">path:</span> <span class="symbol">/var/run</span></span><br><span class="line"></span><br><span class="line"><span class="operator">-</span>--</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Service</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">   <span class="params">namespace:</span> org1</span><br><span class="line">   <span class="params">name:</span> peer1</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line"> <span class="params">selector:</span></span><br><span class="line">   <span class="params">app:</span> hyperledger</span><br><span class="line">   <span class="params">role:</span> peer</span><br><span class="line">   <span class="params">peer-id:</span> peer1</span><br><span class="line">   <span class="params">org:</span> org1</span><br><span class="line"> <span class="params">type:</span> NodePort</span><br><span class="line"> <span class="params">ports:</span></span><br><span class="line">   <span class="operator">-</span> <span class="params">name:</span> externale-listen-endpoint</span><br><span class="line">     <span class="params">protocol:</span> TCP</span><br><span class="line">     <span class="params">port:</span> <span class="number">7051</span></span><br><span class="line">     <span class="params">targetPort:</span> <span class="number">7051</span></span><br><span class="line">     <span class="params">nodePort:</span> <span class="number">30004</span></span><br><span class="line"></span><br><span class="line">   <span class="operator">-</span> <span class="params">name:</span> chaincode-listen</span><br><span class="line">     <span class="params">protocol:</span> TCP</span><br><span class="line">     <span class="params">port:</span> <span class="number">7052</span></span><br><span class="line">     <span class="params">targetPort:</span> <span class="number">7052</span></span><br><span class="line">     <span class="params">nodePort:</span> <span class="number">30005</span></span><br><span class="line"></span><br><span class="line">   <span class="operator">-</span> <span class="params">name:</span> event-listen</span><br><span class="line">     <span class="params">protocol:</span> TCP</span><br><span class="line">     <span class="params">port:</span> <span class="number">7053</span></span><br><span class="line">     <span class="params">targetPort:</span> <span class="number">7053</span></span><br><span class="line">     <span class="params">nodePort:</span> <span class="number">30006</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入 yaml 文件 创建服务</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f org1-namespace.yaml </span><br><span class="line">namespace/org1 created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f org1-pv-pvc.yaml </span><br><span class="line">persistentvolume/org1-pv created</span><br><span class="line">persistentvolumeclaim/org1-pv created</span><br><span class="line">persistentvolume/org1-pvdata created</span><br><span class="line">persistentvolumeclaim/org1-pvdata created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f org1-ca.yaml </span><br><span class="line">deployment.extensions/ca created</span><br><span class="line">service/ca created</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f peer0.org1.yaml </span><br><span class="line">deployment.extensions/peer0-org1 created</span><br><span class="line">service/peer0 created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f peer1.org1.yaml </span><br><span class="line">deployment.extensions/peer1-org1 created</span><br><span class="line">service/peer1 created</span><br></pre></td></tr></table></figure>

<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 创建的服务</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-<span class="number">1</span> <span class="operator">/</span>opt<span class="operator">/</span>jicki<span class="operator">/</span>k8s-yaml]<span class="comment"># kubectl get all -n org1</span></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod<span class="symbol">/ca-75b9859c54-d5x9b</span>           <span class="number">1</span><span class="symbol">/1</span>     Running   <span class="number">0</span>          <span class="number">120</span>m</span><br><span class="line">pod<span class="symbol">/peer0-org1-5767789cd7-7g2z7</span>   <span class="number">2</span><span class="symbol">/2</span>     Running   <span class="number">0</span>          <span class="number">22</span>m</span><br><span class="line">pod<span class="symbol">/peer1-org1-866b6bcd45-c5mbp</span>   <span class="number">2</span><span class="symbol">/2</span>     Running   <span class="number">0</span>          <span class="number">22</span>m</span><br><span class="line"></span><br><span class="line">NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                                        AGE</span><br><span class="line">service<span class="symbol">/ca</span>      NodePort   <span class="number">10.233</span>.<span class="number">5.5</span>      <span class="symbol">&lt;none&gt;</span>        <span class="number">7054</span>:<span class="number">30000</span><span class="symbol">/TCP</span>                                 <span class="number">120</span>m</span><br><span class="line">service<span class="symbol">/peer0</span>   NodePort   <span class="number">10.233</span>.<span class="number">57.55</span>    <span class="symbol">&lt;none&gt;</span>        <span class="number">7051</span>:<span class="number">30001</span><span class="operator">/</span>TCP,<span class="number">7052</span>:<span class="number">30002</span><span class="operator">/</span>TCP,<span class="number">7053</span>:<span class="number">30003</span><span class="symbol">/TCP</span>   <span class="number">36</span>m</span><br><span class="line">service<span class="symbol">/peer1</span>   NodePort   <span class="number">10.233</span>.<span class="number">31.189</span>   <span class="symbol">&lt;none&gt;</span>        <span class="number">7051</span>:<span class="number">30004</span><span class="operator">/</span>TCP,<span class="number">7052</span>:<span class="number">30005</span><span class="operator">/</span>TCP,<span class="number">7053</span>:<span class="number">30006</span><span class="symbol">/TCP</span>   <span class="number">34</span>m</span><br><span class="line"></span><br><span class="line">NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps<span class="symbol">/ca</span>           <span class="number">1</span><span class="symbol">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">120</span>m</span><br><span class="line">deployment.apps<span class="symbol">/peer0-org1</span>   <span class="number">1</span><span class="symbol">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">36</span>m</span><br><span class="line">deployment.apps<span class="symbol">/peer1-org1</span>   <span class="number">1</span><span class="symbol">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">34</span>m</span><br><span class="line"></span><br><span class="line">NAME                                    DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps<span class="symbol">/ca-75b9859c54</span>           <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>       <span class="number">120</span>m</span><br><span class="line">replicaset.apps<span class="symbol">/peer0-org1-5767789cd7</span>   <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>       <span class="number">22</span>m</span><br><span class="line">replicaset.apps<span class="symbol">/peer0-org1-8c98c4c9</span>     <span class="number">0</span>         <span class="number">0</span>         <span class="number">0</span>       <span class="number">36</span>m</span><br><span class="line">replicaset.apps<span class="symbol">/peer1-org1-768c8d8f69</span>   <span class="number">0</span>         <span class="number">0</span>         <span class="number">0</span>       <span class="number">34</span>m</span><br><span class="line">replicaset.apps<span class="symbol">/peer1-org1-866b6bcd45</span>   <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>       <span class="number">22</span>m</span><br></pre></td></tr></table></figure>

<h3 id="3-4-配置-org2-服务"><a href="#3-4-配置-org2-服务" class="headerlink" title="3.4 配置 org2 服务"></a>3.4 配置 org2 服务</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 配置 org2 namespaces</span></span><br><span class="line"></span><br><span class="line">vi org2-namespace.yaml</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> Namespace</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">    name:</span> org2</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 org2 pv pvc</span></span><br><span class="line"></span><br><span class="line"><span class="string">vi</span> <span class="string">org2-pv-pvc.yaml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">org2-pv</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">org2-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">500Mi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/opt/nfs/fabric/fabric/crypto-config/peerOrganizations/org2</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.249</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">namespace:</span> <span class="string">org2</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">org2-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">accessModes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line"> <span class="attr">resources:</span></span><br><span class="line">   <span class="attr">requests:</span></span><br><span class="line">     <span class="attr">storage:</span> <span class="string">10Mi</span></span><br><span class="line"> <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">matchLabels:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">org2-pv</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">org2-pvdata</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">org2-pvdata</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/opt/nfs/fabric/data/peer/org2</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.249</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">namespace:</span> <span class="string">org2</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">org2-pvdata</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">accessModes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line"> <span class="attr">resources:</span></span><br><span class="line">   <span class="attr">requests:</span></span><br><span class="line">     <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line"> <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">matchLabels:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">org2-pvdata</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 org2  ca</span></span><br><span class="line"><span class="comment"># FABRIC_CA_SERVER_TLS_KEYFILE 配置为自己生成的 sk</span></span><br><span class="line"><span class="comment"># sk 存在目录 crypto-config/peerOrganizations/org2/ca/</span></span><br><span class="line"></span><br><span class="line"><span class="string">vi</span> <span class="string">org2-ca.yaml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">org2</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ca</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">       <span class="attr">app:</span> <span class="string">hyperledger</span></span><br><span class="line">       <span class="attr">role:</span> <span class="string">ca</span></span><br><span class="line">       <span class="attr">org:</span> <span class="string">org2</span></span><br><span class="line">       <span class="attr">name:</span> <span class="string">ca</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">     <span class="attr">containers:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ca</span></span><br><span class="line">         <span class="attr">image:</span> <span class="string">hyperledger/fabric-ca:1.4.0</span></span><br><span class="line">         <span class="attr">env:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FABRIC_CA_HOME</span></span><br><span class="line">           <span class="attr">value:</span> <span class="string">/etc/hyperledger/fabric-ca-server</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FABRIC_CA_SERVER_CA_NAME</span></span><br><span class="line">           <span class="attr">value:</span> <span class="string">ca</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FABRIC_CA_SERVER_TLS_ENABLED</span></span><br><span class="line">           <span class="attr">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FABRIC_CA_SERVER_TLS_CERTFILE</span></span><br><span class="line">           <span class="attr">value:</span> <span class="string">/etc/hyperledger/fabric-ca-server-config/ca.org2-cert.pem</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FABRIC_CA_SERVER_TLS_KEYFILE</span></span><br><span class="line">           <span class="attr">value:</span> <span class="string">/etc/hyperledger/fabric-ca-server-config/44299d5dfb204e07b5274a7048269171876157d1efdab11a5ac631bd78d2fe0d_sk</span></span><br><span class="line">         <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GODEBUG</span></span><br><span class="line">           <span class="attr">value:</span> <span class="string">netdns=go</span></span><br><span class="line">         <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">7054</span></span><br><span class="line">         <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>]</span><br><span class="line">         <span class="attr">args:</span> [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot; fabric-ca-server start --ca.certfile /etc/hyperledger/fabric-ca-server-config/ca.org2-cert.pem --ca.keyfile /etc/hyperledger/fabric-ca-server-config/44299d5dfb204e07b5274a7048269171876157d1efdab11a5ac631bd78d2fe0d_sk -b admin:adminpw -d &quot;</span>]</span><br><span class="line">         <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/hyperledger/fabric-ca-server-config</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">certificate</span></span><br><span class="line">            <span class="attr">subPath:</span> <span class="string">ca/</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/hyperledger/fabric-ca-server</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">cadata</span></span><br><span class="line">            <span class="attr">subPath:</span> <span class="string">ca/</span></span><br><span class="line">     <span class="attr">volumes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">certificate</span></span><br><span class="line">         <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">org2-pv</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cadata</span></span><br><span class="line">         <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">org2-pvdata</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">   <span class="attr">namespace:</span> <span class="string">org2</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">ca</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">app:</span> <span class="string">hyperledger</span></span><br><span class="line">   <span class="attr">role:</span> <span class="string">ca</span></span><br><span class="line">   <span class="attr">org:</span> <span class="string">org2</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">ca</span></span><br><span class="line"> <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line"> <span class="attr">ports:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">endpoint</span></span><br><span class="line">     <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">     <span class="attr">port:</span> <span class="number">7054</span></span><br><span class="line">     <span class="attr">targetPort:</span> <span class="number">7054</span></span><br><span class="line">     <span class="attr">nodePort:</span> <span class="number">30100</span></span><br></pre></td></tr></table></figure>

<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 org2  peer 服务 </span></span><br><span class="line"><span class="comment"># 这里有两个 peer 分别为 peer0, peer1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi peer0.org2.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="params">apiVersion:</span> extensions<span class="symbol">/v1beta1</span></span><br><span class="line"><span class="params">kind:</span> Deployment</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">namespace:</span> org2</span><br><span class="line">  <span class="params">name:</span> peer0-org2</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="params">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="params">template:</span></span><br><span class="line">    <span class="params">metadata:</span></span><br><span class="line">      <span class="params">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="params">labels:</span></span><br><span class="line">       <span class="params">app:</span> hyperledger</span><br><span class="line">       <span class="params">role:</span> peer</span><br><span class="line">       <span class="params">peer-id:</span> peer0</span><br><span class="line">       <span class="params">org:</span> org2</span><br><span class="line">    <span class="params">spec:</span></span><br><span class="line">      <span class="params">containers:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> couchdb</span><br><span class="line">        <span class="params">image:</span> hyperledger<span class="operator">/</span>fabric-couchdb:<span class="number">0.4</span>.<span class="number">10</span></span><br><span class="line">        <span class="params">env:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> COUCHDB_USER</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> COUCHDB_PASSWORD</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="params">ports:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">5984</span></span><br><span class="line">        <span class="params">volumeMounts:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/opt/couchdb/data</span></span><br><span class="line">           <span class="params">name:</span> peerdata</span><br><span class="line">           <span class="params">subPath:</span> peer0<span class="symbol">/couchdb</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> peer0-org2</span><br><span class="line">        <span class="params">image:</span> hyperledger<span class="operator">/</span>fabric-peer:<span class="number">1.4</span>.<span class="number">0</span></span><br><span class="line">        <span class="params">env:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LEDGER_STATE_STATEDATABASE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;CouchDB&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;localhost:5984&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_VM_ENDPOINT</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;unix:///host/var/run/docker.sock&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LOGGING_LEVEL</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;DEBUG&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_ENABLED</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_GOSSIP_USELEADERELECTION</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_GOSSIP_ORGLEADER</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_PROFILE_ENABLED</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_CERT_FILE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;/etc/hyperledger/fabric/tls/server.crt&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_KEY_FILE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;/etc/hyperledger/fabric/tls/server.key&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_ROOTCERT_FILE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;/etc/hyperledger/fabric/tls/ca.crt&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_ADDRESSAUTODETECT</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_CHAINCODELISTENADDRESS</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;0.0.0.0:7052&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_ID</span><br><span class="line">          <span class="params">value:</span> peer0.org2</span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_ADDRESS</span><br><span class="line">          <span class="params">value:</span> peer0.org2:<span class="number">7051</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_GOSSIP_BOOTSTRAP</span><br><span class="line">          <span class="params">value:</span> peer0.org2:<span class="number">7051</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_GOSSIP_EXTERNALENDPOINT</span><br><span class="line">          <span class="params">value:</span> peer0.org2:<span class="number">7051</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_LOCALMSPID</span><br><span class="line">          <span class="params">value:</span> Org2MSP</span><br><span class="line">        <span class="params">workingDir:</span> <span class="symbol">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></span><br><span class="line">        <span class="params">ports:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">7051</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">7052</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">7053</span></span><br><span class="line">        <span class="params">command:</span> [<span class="string">&quot;peer&quot;</span>]</span><br><span class="line">        <span class="params">args:</span> [<span class="string">&quot;node&quot;</span>,<span class="string">&quot;start&quot;</span>]</span><br><span class="line">        <span class="params">volumeMounts:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/etc/hyperledger/fabric/msp</span></span><br><span class="line">           <span class="params">name:</span> certificate</span><br><span class="line">           <span class="params">subPath:</span> peers<span class="symbol">/peer0.org2/msp</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/etc/hyperledger/fabric/tls</span></span><br><span class="line">           <span class="params">name:</span> certificate</span><br><span class="line">           <span class="params">subPath:</span> peers<span class="symbol">/peer0.org2/tls</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/var/hyperledger/production</span></span><br><span class="line">           <span class="params">name:</span> peerdata</span><br><span class="line">           <span class="params">subPath:</span> peer0<span class="symbol">/peerdata</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="operator">/</span>host<span class="operator">/</span>var<span class="operator">/</span>run<span class="symbol">/</span></span><br><span class="line">           <span class="params">name:</span> run</span><br><span class="line">      <span class="params">volumes:</span></span><br><span class="line">       <span class="operator">-</span> <span class="params">name:</span> certificate</span><br><span class="line">         <span class="params">persistentVolumeClaim:</span></span><br><span class="line">             <span class="params">claimName:</span> org2-pv</span><br><span class="line">       <span class="operator">-</span> <span class="params">name:</span> peerdata</span><br><span class="line">         <span class="params">persistentVolumeClaim:</span></span><br><span class="line">             <span class="params">claimName:</span> org2-pvdata</span><br><span class="line">       <span class="operator">-</span> <span class="params">name:</span> run</span><br><span class="line">         <span class="params">hostPath:</span></span><br><span class="line">           <span class="params">path:</span> <span class="symbol">/var/run</span></span><br><span class="line"></span><br><span class="line"><span class="operator">-</span>--</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Service</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">   <span class="params">namespace:</span> org2</span><br><span class="line">   <span class="params">name:</span> peer0</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line"> <span class="params">selector:</span></span><br><span class="line">   <span class="params">app:</span> hyperledger</span><br><span class="line">   <span class="params">role:</span> peer</span><br><span class="line">   <span class="params">peer-id:</span> peer0</span><br><span class="line">   <span class="params">org:</span> org2</span><br><span class="line"> <span class="params">type:</span> NodePort</span><br><span class="line"> <span class="params">ports:</span></span><br><span class="line">   <span class="operator">-</span> <span class="params">name:</span> externale-listen-endpoint</span><br><span class="line">     <span class="params">protocol:</span> TCP</span><br><span class="line">     <span class="params">port:</span> <span class="number">7051</span></span><br><span class="line">     <span class="params">targetPort:</span> <span class="number">7051</span></span><br><span class="line">     <span class="params">nodePort:</span> <span class="number">30101</span></span><br><span class="line"></span><br><span class="line">   <span class="operator">-</span> <span class="params">name:</span> chaincode-listen</span><br><span class="line">     <span class="params">protocol:</span> TCP</span><br><span class="line">     <span class="params">port:</span> <span class="number">7052</span></span><br><span class="line">     <span class="params">targetPort:</span> <span class="number">7052</span></span><br><span class="line">     <span class="params">nodePort:</span> <span class="number">30102</span></span><br><span class="line"></span><br><span class="line">   <span class="operator">-</span> <span class="params">name:</span> event-listen</span><br><span class="line">     <span class="params">protocol:</span> TCP</span><br><span class="line">     <span class="params">port:</span> <span class="number">7053</span></span><br><span class="line">     <span class="params">targetPort:</span> <span class="number">7053</span></span><br><span class="line">     <span class="params">nodePort:</span> <span class="number">30103</span></span><br></pre></td></tr></table></figure>

<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置 org2 的 peer1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi peer1.org2.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="params">apiVersion:</span> extensions<span class="symbol">/v1beta1</span></span><br><span class="line"><span class="params">kind:</span> Deployment</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">  <span class="params">namespace:</span> org2</span><br><span class="line">  <span class="params">name:</span> peer1-org2</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="params">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="params">template:</span></span><br><span class="line">    <span class="params">metadata:</span></span><br><span class="line">      <span class="params">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">      <span class="params">labels:</span></span><br><span class="line">       <span class="params">app:</span> hyperledger</span><br><span class="line">       <span class="params">role:</span> peer</span><br><span class="line">       <span class="params">peer-id:</span> peer1</span><br><span class="line">       <span class="params">org:</span> org2</span><br><span class="line">    <span class="params">spec:</span></span><br><span class="line">      <span class="params">containers:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> couchdb</span><br><span class="line">        <span class="params">image:</span> hyperledger<span class="operator">/</span>fabric-couchdb:<span class="number">0.4</span>.<span class="number">10</span></span><br><span class="line">        <span class="params">env:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> COUCHDB_USER</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> COUCHDB_PASSWORD</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="params">ports:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">5984</span></span><br><span class="line">        <span class="params">volumeMounts:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/opt/couchdb/data</span></span><br><span class="line">           <span class="params">name:</span> peerdata</span><br><span class="line">           <span class="params">subPath:</span> peer1<span class="symbol">/couchdb</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> peer1-org2</span><br><span class="line">        <span class="params">image:</span> hyperledger<span class="operator">/</span>fabric-peer:<span class="number">1.4</span>.<span class="number">0</span></span><br><span class="line">        <span class="params">env:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LEDGER_STATE_STATEDATABASE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;CouchDB&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;localhost:5984&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_VM_ENDPOINT</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;unix:///host/var/run/docker.sock&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_LOGGING_LEVEL</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;DEBUG&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_ENABLED</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_GOSSIP_USELEADERELECTION</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_GOSSIP_ORGLEADER</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_PROFILE_ENABLED</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_CERT_FILE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;/etc/hyperledger/fabric/tls/server.crt&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_KEY_FILE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;/etc/hyperledger/fabric/tls/server.key&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_ROOTCERT_FILE</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;/etc/hyperledger/fabric/tls/ca.crt&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_ADDRESSAUTODETECT</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_CHAINCODELISTENADDRESS</span><br><span class="line">          <span class="params">value:</span> <span class="string">&quot;0.0.0.0:7052&quot;</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_ID</span><br><span class="line">          <span class="params">value:</span> peer1.org2</span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_ADDRESS</span><br><span class="line">          <span class="params">value:</span> peer1.org2:<span class="number">7051</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_GOSSIP_BOOTSTRAP</span><br><span class="line">          <span class="params">value:</span> peer1.org2:<span class="number">7051</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_GOSSIP_EXTERNALENDPOINT</span><br><span class="line">          <span class="params">value:</span> peer1.org2:<span class="number">7051</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_LOCALMSPID</span><br><span class="line">          <span class="params">value:</span> Org2MSP</span><br><span class="line">        <span class="params">workingDir:</span> <span class="symbol">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></span><br><span class="line">        <span class="params">ports:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">7051</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">7052</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">containerPort:</span> <span class="number">7053</span></span><br><span class="line">        <span class="params">command:</span> [<span class="string">&quot;peer&quot;</span>]</span><br><span class="line">        <span class="params">args:</span> [<span class="string">&quot;node&quot;</span>,<span class="string">&quot;start&quot;</span>]</span><br><span class="line">        <span class="params">volumeMounts:</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/etc/hyperledger/fabric/msp</span></span><br><span class="line">           <span class="params">name:</span> certificate</span><br><span class="line">           <span class="params">subPath:</span> peers<span class="symbol">/peer1.org2/msp</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/etc/hyperledger/fabric/tls</span></span><br><span class="line">           <span class="params">name:</span> certificate</span><br><span class="line">           <span class="params">subPath:</span> peers<span class="symbol">/peer1.org2/tls</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/var/hyperledger/production</span></span><br><span class="line">           <span class="params">name:</span> peerdata</span><br><span class="line">           <span class="params">subPath:</span> peer1<span class="symbol">/peerdata</span></span><br><span class="line">         <span class="operator">-</span> <span class="params">mountPath:</span> <span class="operator">/</span>host<span class="operator">/</span>var<span class="operator">/</span>run<span class="symbol">/</span></span><br><span class="line">           <span class="params">name:</span> run</span><br><span class="line">      <span class="params">volumes:</span></span><br><span class="line">       <span class="operator">-</span> <span class="params">name:</span> certificate</span><br><span class="line">         <span class="params">persistentVolumeClaim:</span></span><br><span class="line">             <span class="params">claimName:</span> org2-pv</span><br><span class="line">       <span class="operator">-</span> <span class="params">name:</span> peerdata</span><br><span class="line">         <span class="params">persistentVolumeClaim:</span></span><br><span class="line">             <span class="params">claimName:</span> org2-pvdata</span><br><span class="line">       <span class="operator">-</span> <span class="params">name:</span> run</span><br><span class="line">         <span class="params">hostPath:</span></span><br><span class="line">           <span class="params">path:</span> <span class="symbol">/var/run</span></span><br><span class="line"></span><br><span class="line"><span class="operator">-</span>--</span><br><span class="line"><span class="params">apiVersion:</span> v1</span><br><span class="line"><span class="params">kind:</span> Service</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">   <span class="params">namespace:</span> org2</span><br><span class="line">   <span class="params">name:</span> peer1</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line"> <span class="params">selector:</span></span><br><span class="line">   <span class="params">app:</span> hyperledger</span><br><span class="line">   <span class="params">role:</span> peer</span><br><span class="line">   <span class="params">peer-id:</span> peer1</span><br><span class="line">   <span class="params">org:</span> org2</span><br><span class="line"> <span class="params">type:</span> NodePort</span><br><span class="line"> <span class="params">ports:</span></span><br><span class="line">   <span class="operator">-</span> <span class="params">name:</span> externale-listen-endpoint</span><br><span class="line">     <span class="params">protocol:</span> TCP</span><br><span class="line">     <span class="params">port:</span> <span class="number">7051</span></span><br><span class="line">     <span class="params">targetPort:</span> <span class="number">7051</span></span><br><span class="line">     <span class="params">nodePort:</span> <span class="number">30104</span></span><br><span class="line"></span><br><span class="line">   <span class="operator">-</span> <span class="params">name:</span> chaincode-listen</span><br><span class="line">     <span class="params">protocol:</span> TCP</span><br><span class="line">     <span class="params">port:</span> <span class="number">7052</span></span><br><span class="line">     <span class="params">targetPort:</span> <span class="number">7052</span></span><br><span class="line">     <span class="params">nodePort:</span> <span class="number">30105</span></span><br><span class="line"></span><br><span class="line">   <span class="operator">-</span> <span class="params">name:</span> event-listen</span><br><span class="line">     <span class="params">protocol:</span> TCP</span><br><span class="line">     <span class="params">port:</span> <span class="number">7053</span></span><br><span class="line">     <span class="params">targetPort:</span> <span class="number">7053</span></span><br><span class="line">     <span class="params">nodePort:</span> <span class="number">30106</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 导入 yaml 文件 创建服务</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f org2-namespace.yaml </span><br><span class="line">namespace/org2 created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f org2-pv-pvc.yaml </span><br><span class="line">persistentvolume/org2-pv created</span><br><span class="line">persistentvolumeclaim/org2-pv created</span><br><span class="line">persistentvolume/org2-pvdata created</span><br><span class="line">persistentvolumeclaim/org2-pvdata created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f org2-ca.yaml </span><br><span class="line">deployment.extensions/ca created</span><br><span class="line">service/ca created</span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f peer0.org2.yaml </span><br><span class="line">deployment.extensions/peer0-org2 created</span><br><span class="line">service/peer0 created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-1 /opt/jicki/k8s-yaml]# kubectl apply -f peer1.org2.yaml </span><br><span class="line">deployment.extensions/peer1-org2 created</span><br><span class="line">service/peer1 created</span><br></pre></td></tr></table></figure>

<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 org2 的服务</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes-<span class="number">1</span> <span class="operator">/</span>opt<span class="operator">/</span>jicki<span class="operator">/</span>k8s-yaml]<span class="comment"># kubectl get all -n org2</span></span><br><span class="line">NAME                              READY   STATUS    RESTARTS   AGE</span><br><span class="line">pod<span class="symbol">/ca-594d86d8fc-fwg7r</span>           <span class="number">1</span><span class="symbol">/1</span>     Running   <span class="number">0</span>          <span class="number">55</span>s</span><br><span class="line">pod<span class="symbol">/peer0-org2-68579cc9fd-gjmdw</span>   <span class="number">2</span><span class="symbol">/2</span>     Running   <span class="number">0</span>          <span class="number">40</span>s</span><br><span class="line">pod<span class="symbol">/peer1-org2-7645b97c44-5f64k</span>   <span class="number">2</span><span class="symbol">/2</span>     Running   <span class="number">0</span>          <span class="number">30</span>s</span><br><span class="line"></span><br><span class="line">NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                                        AGE</span><br><span class="line">service<span class="symbol">/ca</span>      NodePort   <span class="number">10.233</span>.<span class="number">4.94</span>     <span class="symbol">&lt;none&gt;</span>        <span class="number">7054</span>:<span class="number">30100</span><span class="symbol">/TCP</span>                                 <span class="number">55</span>s</span><br><span class="line">service<span class="symbol">/peer0</span>   NodePort   <span class="number">10.233</span>.<span class="number">49.35</span>    <span class="symbol">&lt;none&gt;</span>        <span class="number">7051</span>:<span class="number">30101</span><span class="operator">/</span>TCP,<span class="number">7052</span>:<span class="number">30102</span><span class="operator">/</span>TCP,<span class="number">7053</span>:<span class="number">30103</span><span class="symbol">/TCP</span>   <span class="number">40</span>s</span><br><span class="line">service<span class="symbol">/peer1</span>   NodePort   <span class="number">10.233</span>.<span class="number">56.135</span>   <span class="symbol">&lt;none&gt;</span>        <span class="number">7051</span>:<span class="number">30104</span><span class="operator">/</span>TCP,<span class="number">7052</span>:<span class="number">30105</span><span class="operator">/</span>TCP,<span class="number">7053</span>:<span class="number">30106</span><span class="symbol">/TCP</span>   <span class="number">30</span>s</span><br><span class="line"></span><br><span class="line">NAME                         READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">deployment.apps<span class="symbol">/ca</span>           <span class="number">1</span><span class="symbol">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">55</span>s</span><br><span class="line">deployment.apps<span class="symbol">/peer0-org2</span>   <span class="number">1</span><span class="symbol">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">40</span>s</span><br><span class="line">deployment.apps<span class="symbol">/peer1-org2</span>   <span class="number">1</span><span class="symbol">/1</span>     <span class="number">1</span>            <span class="number">1</span>           <span class="number">30</span>s</span><br><span class="line"></span><br><span class="line">NAME                                    DESIRED   CURRENT   READY   AGE</span><br><span class="line">replicaset.apps<span class="symbol">/ca-594d86d8fc</span>           <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>       <span class="number">55</span>s</span><br><span class="line">replicaset.apps<span class="symbol">/peer0-org2-68579cc9fd</span>   <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>       <span class="number">40</span>s</span><br><span class="line">replicaset.apps<span class="symbol">/peer1-org2-7645b97c44</span>   <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>       <span class="number">30</span>s</span><br></pre></td></tr></table></figure>

<h3 id="3-5-配置-cli-服务"><a href="#3-5-配置-cli-服务" class="headerlink" title="3.5 配置 cli 服务"></a>3.5 配置 cli 服务</h3><blockquote>
<p>cli 服务，用于 命令行操作组织节点的环境。</p>
<p>这里每一个 org 配置一个 cli 服务，方便操作不同的 org 节点</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 org1  cli 的 pv pvc </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">vi</span> <span class="string">org1-cli-pv-pvc.yaml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">org1-cli-pv</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">org1-cli-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">capacity:</span></span><br><span class="line">       <span class="attr">storage:</span> <span class="string">500Mi</span></span><br><span class="line">    <span class="attr">accessModes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">    <span class="attr">nfs:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/opt/nfs/fabric/fabric/channel-artifacts</span></span><br><span class="line">      <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.249</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">org1</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">org1-cli-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">   <span class="attr">accessModes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">   <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">storage:</span> <span class="string">10Mi</span></span><br><span class="line">   <span class="attr">selector:</span></span><br><span class="line">     <span class="attr">matchLabels:</span></span><br><span class="line">       <span class="attr">app:</span> <span class="string">org1-cli-pv</span></span><br></pre></td></tr></table></figure>

<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 org1  cli  服务</span></span><br><span class="line"></span><br><span class="line">vi org1-cli.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="params">apiVersion:</span> extensions<span class="symbol">/v1beta1</span></span><br><span class="line"><span class="params">kind:</span> Deployment</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">   <span class="params">namespace:</span> org1</span><br><span class="line">   <span class="params">name:</span> cli</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="params">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="params">template:</span></span><br><span class="line">    <span class="params">metadata:</span></span><br><span class="line">      <span class="params">labels:</span></span><br><span class="line">       <span class="params">app:</span> cli</span><br><span class="line">    <span class="params">spec:</span></span><br><span class="line">      <span class="params">containers:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> cli</span><br><span class="line">          <span class="params">image:</span> hyperledger<span class="operator">/</span>fabric-tools:<span class="number">1.4</span>.<span class="number">0</span></span><br><span class="line">          <span class="params">env:</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_ENABLED</span><br><span class="line">            <span class="params">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> CORE_VM_ENDPOINT</span><br><span class="line">            <span class="params">value:</span> unix:<span class="operator">//</span><span class="symbol">/host/var/run/docker.sock</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> GOPATH</span><br><span class="line">            <span class="params">value:</span> <span class="symbol">/opt/gopath</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> CORE_LOGGING_LEVEL</span><br><span class="line">            <span class="params">value:</span> DEBUG</span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_ID</span><br><span class="line">            <span class="params">value:</span> cli</span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_ADDRESS</span><br><span class="line">            <span class="params">value:</span> peer0.org1:<span class="number">7051</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_LOCALMSPID</span><br><span class="line">            <span class="params">value:</span> Org1MSP</span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_MSPCONFIGPATH</span><br><span class="line">            <span class="params">value:</span> <span class="symbol">/etc/hyperledger/fabric/msp</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> GODEBUG</span><br><span class="line">            <span class="params">value:</span> netdns<span class="operator">=</span>go</span><br><span class="line">          <span class="params">workingDir:</span> <span class="symbol">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></span><br><span class="line">          <span class="params">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;--&quot;</span>]</span><br><span class="line">          <span class="params">args:</span> [<span class="string">&quot;while true; do sleep 30; done;&quot;</span>]</span><br><span class="line">          <span class="params">volumeMounts:</span></span><br><span class="line">           <span class="operator">-</span> <span class="params">mountPath:</span> <span class="operator">/</span>host<span class="operator">/</span>var<span class="operator">/</span>run<span class="symbol">/</span></span><br><span class="line">             <span class="params">name:</span> run</span><br><span class="line">           <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/etc/hyperledger/fabric/msp</span></span><br><span class="line">             <span class="params">name:</span> certificate</span><br><span class="line">             <span class="params">subPath:</span> users<span class="operator">/</span>Admin@org1<span class="symbol">/msp</span></span><br><span class="line">           <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts</span></span><br><span class="line">             <span class="params">name:</span> artifacts</span><br><span class="line">      <span class="params">volumes:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> certificate</span><br><span class="line">          <span class="params">persistentVolumeClaim:</span></span><br><span class="line">              <span class="params">claimName:</span> org1-pv</span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> artifacts</span><br><span class="line">          <span class="params">persistentVolumeClaim:</span></span><br><span class="line">              <span class="params">claimName:</span> org1-cli-pv</span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> run</span><br><span class="line">          <span class="params">hostPath:</span></span><br><span class="line">            <span class="params">path:</span> <span class="operator">/</span>var<span class="operator">/</span>run</span><br></pre></td></tr></table></figure>

<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 导入 yaml 文件</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes<span class="number">-1</span> /opt/jicki/k8s-yaml]<span class="meta"># kubectl apply -f org1-cli-pv-pvc.yaml </span></span><br><span class="line">persistentvolume/org1-<span class="keyword">cli</span>-pv created</span><br><span class="line">persistentvolumeclaim/org1-<span class="keyword">cli</span>-pv created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes<span class="number">-1</span> /opt/jicki/k8s-yaml]<span class="meta"># kubectl apply -f org1-cli.yaml </span></span><br><span class="line">deployment.extensions/<span class="keyword">cli</span> created</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 org2  cli 的 pv pvc </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">vi</span> <span class="string">org2-cli-pv-pvc.yaml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">org2-cli-pv</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">org2-cli-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">    <span class="attr">capacity:</span></span><br><span class="line">       <span class="attr">storage:</span> <span class="string">500Mi</span></span><br><span class="line">    <span class="attr">accessModes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">    <span class="attr">nfs:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/opt/nfs/fabric/fabric/channel-artifacts</span></span><br><span class="line">      <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.249</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">org2</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">org2-cli-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">   <span class="attr">accessModes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">   <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">storage:</span> <span class="string">10Mi</span></span><br><span class="line">   <span class="attr">selector:</span></span><br><span class="line">     <span class="attr">matchLabels:</span></span><br><span class="line">       <span class="attr">app:</span> <span class="string">org2-cli-pv</span></span><br></pre></td></tr></table></figure>

<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 org2  cli  服务</span></span><br><span class="line"></span><br><span class="line">vi org2-cli.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="params">apiVersion:</span> extensions<span class="symbol">/v1beta1</span></span><br><span class="line"><span class="params">kind:</span> Deployment</span><br><span class="line"><span class="params">metadata:</span></span><br><span class="line">   <span class="params">namespace:</span> org2</span><br><span class="line">   <span class="params">name:</span> cli</span><br><span class="line"><span class="params">spec:</span></span><br><span class="line">  <span class="params">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="params">strategy:</span> &#123;&#125;</span><br><span class="line">  <span class="params">template:</span></span><br><span class="line">    <span class="params">metadata:</span></span><br><span class="line">      <span class="params">labels:</span></span><br><span class="line">       <span class="params">app:</span> cli</span><br><span class="line">    <span class="params">spec:</span></span><br><span class="line">      <span class="params">containers:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> cli</span><br><span class="line">          <span class="params">image:</span> hyperledger<span class="operator">/</span>fabric-tools:<span class="number">1.4</span>.<span class="number">0</span></span><br><span class="line">          <span class="params">env:</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_TLS_ENABLED</span><br><span class="line">            <span class="params">value:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> CORE_VM_ENDPOINT</span><br><span class="line">            <span class="params">value:</span> unix:<span class="operator">//</span><span class="symbol">/host/var/run/docker.sock</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> GOPATH</span><br><span class="line">            <span class="params">value:</span> <span class="symbol">/opt/gopath</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> CORE_LOGGING_LEVEL</span><br><span class="line">            <span class="params">value:</span> DEBUG</span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_ID</span><br><span class="line">            <span class="params">value:</span> cli</span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_ADDRESS</span><br><span class="line">            <span class="params">value:</span> peer0.org2:<span class="number">7051</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_LOCALMSPID</span><br><span class="line">            <span class="params">value:</span> Org2MSP</span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> CORE_PEER_MSPCONFIGPATH</span><br><span class="line">            <span class="params">value:</span> <span class="symbol">/etc/hyperledger/fabric/msp</span></span><br><span class="line">          <span class="operator">-</span> <span class="params">name:</span> GODEBUG</span><br><span class="line">            <span class="params">value:</span> netdns<span class="operator">=</span>go</span><br><span class="line">          <span class="params">workingDir:</span> <span class="symbol">/opt/gopath/src/github.com/hyperledger/fabric/peer</span></span><br><span class="line">          <span class="params">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;--&quot;</span>]</span><br><span class="line">          <span class="params">args:</span> [<span class="string">&quot;while true; do sleep 30; done;&quot;</span>]</span><br><span class="line">          <span class="params">volumeMounts:</span></span><br><span class="line">           <span class="operator">-</span> <span class="params">mountPath:</span> <span class="operator">/</span>host<span class="operator">/</span>var<span class="operator">/</span>run<span class="symbol">/</span></span><br><span class="line">             <span class="params">name:</span> run</span><br><span class="line">           <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/etc/hyperledger/fabric/msp</span></span><br><span class="line">             <span class="params">name:</span> certificate</span><br><span class="line">             <span class="params">subPath:</span> users<span class="operator">/</span>Admin@org2<span class="symbol">/msp</span></span><br><span class="line">           <span class="operator">-</span> <span class="params">mountPath:</span> <span class="symbol">/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts</span></span><br><span class="line">             <span class="params">name:</span> artifacts</span><br><span class="line">      <span class="params">volumes:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> certificate</span><br><span class="line">          <span class="params">persistentVolumeClaim:</span></span><br><span class="line">              <span class="params">claimName:</span> org2-pv</span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> artifacts</span><br><span class="line">          <span class="params">persistentVolumeClaim:</span></span><br><span class="line">              <span class="params">claimName:</span> org2-cli-pv</span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> run</span><br><span class="line">          <span class="params">hostPath:</span></span><br><span class="line">            <span class="params">path:</span> <span class="operator">/</span>var<span class="operator">/</span>run</span><br></pre></td></tr></table></figure>

<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 导入 yaml 文件</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes<span class="number">-1</span> /opt/jicki/k8s-yaml]<span class="meta"># kubectl apply -f org2-cli-pv-pvc.yaml </span></span><br><span class="line">persistentvolume/org2-<span class="keyword">cli</span>-pv created</span><br><span class="line">persistentvolumeclaim/org2-<span class="keyword">cli</span>-pv created</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@kubernetes<span class="number">-1</span> /opt/jicki/k8s-yaml]<span class="meta"># kubectl apply -f org2-cli.yaml </span></span><br><span class="line">deployment.extensions/<span class="keyword">cli</span> created</span><br></pre></td></tr></table></figure>

<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看服务</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-<span class="number">1</span> <span class="operator">/</span>opt<span class="operator">/</span>jicki<span class="operator">/</span>k8s-yaml]<span class="comment"># kubectl get pods --all-namespaces</span></span><br><span class="line"></span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">org1          cli-<span class="number">68647</span>b4c-<span class="number">6</span>db4f                         <span class="number">1</span><span class="symbol">/1</span>     Running   <span class="number">0</span>          <span class="number">5</span>m12s</span><br><span class="line">org2          cli-<span class="number">5</span>bd96dc66d-bhm65                       <span class="number">1</span><span class="symbol">/1</span>     Running   <span class="number">0</span>          <span class="number">18</span>s</span><br></pre></td></tr></table></figure>

<h2 id="4-测试集群"><a href="#4-测试集群" class="headerlink" title="4. 测试集群"></a>4. 测试集群</h2><blockquote>
<p>测试集群</p>
<ol>
<li>初始化 channel 2. 加入 channel 3. 更新为 锚节点 4. 安装 chaincode 5. 实例化 chaincode 6. 操作 chaincode</li>
</ol>
</blockquote>
<h3 id="4-1-org1-节点"><a href="#4-1-org1-节点" class="headerlink" title="4.1 org1 节点"></a>4.1 org1 节点</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 登录  org1 cli</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-<span class="number">1</span> <span class="regexp">/opt/</span>jicki/k8s-yaml]<span class="comment"># kubectl exec -it cli-68647b4c-6db4f -n org1 bash</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">1</span>. 初始化 创建channel</span><br><span class="line"></span><br><span class="line">peer channel create -o orderer0.orgorderer1:<span class="number">7050</span> -c mychannel -f .<span class="regexp">/channel-artifacts/</span>channel.tx</span><br></pre></td></tr></table></figure>

<blockquote>
<p>拷贝 mychannel.block 文件到 channel-artifacts 共享目录</p>
</blockquote>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 拷贝</span><br><span class="line"></span><br><span class="line">cp mychannel.<span class="keyword">block</span> channel-artifacts</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 加入 channel</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">peer channel join -b channel-artifacts/mychannel.<span class="keyword">block</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">02</span>:<span class="number">40</span>:<span class="number">58.478</span> UTC [<span class="function"><span class="title">main</span>] InitCmd -&gt;</span> WARN <span class="number">001</span> CORE_LOGGING_LEVEL <span class="keyword">is</span> no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">02</span>:<span class="number">40</span>:<span class="number">58.497</span> UTC [<span class="function"><span class="title">main</span>] SetOrdererEnv -&gt;</span> WARN <span class="number">002</span> CORE_LOGGING_LEVEL <span class="keyword">is</span> no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">02</span>:<span class="number">40</span>:<span class="number">58.500</span> UTC [<span class="function"><span class="title">channelCmd</span>] InitCmdFactory -&gt;</span> INFO <span class="number">003</span> Endorser <span class="built_in">and</span> orderer connections initialized</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">02</span>:<span class="number">40</span>:<span class="number">58.589</span> UTC [<span class="function"><span class="title">channelCmd</span>] executeJoin -&gt;</span> INFO <span class="number">004</span> Successfully submitted proposal to join channel</span><br></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新 锚节点 peer，每个 org 只需执行一次</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新对应的 org1 的</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">peer</span> channel update -o orderer0.orgorderer1:<span class="number">7050</span> -c mychannel -f ./channel-artifacts/Org1MSPanchors.tx</span><br></pre></td></tr></table></figure>

<h3 id="4-2-org2-节点"><a href="#4-2-org2-节点" class="headerlink" title="4.2 org2 节点"></a>4.2 org2 节点</h3><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 登录 org2 节点 cli</span></span><br><span class="line"></span><br><span class="line">[root<span class="symbol">@kubernetes</span><span class="number">-1</span> /opt/jicki/k8s-yaml]<span class="meta"># kubectl exec -it cli-5bd96dc66d-j2m6d -n org2 bash</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 加入 mychannel </span><br><span class="line"></span><br><span class="line">peer channel join -b channel-artifacts/mychannel.<span class="keyword">block</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">02</span>:<span class="number">47</span>:<span class="number">14.529</span> UTC [<span class="function"><span class="title">main</span>] InitCmd -&gt;</span> WARN <span class="number">001</span> CORE_LOGGING_LEVEL <span class="keyword">is</span> no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">02</span>:<span class="number">47</span>:<span class="number">14.549</span> UTC [<span class="function"><span class="title">main</span>] SetOrdererEnv -&gt;</span> WARN <span class="number">002</span> CORE_LOGGING_LEVEL <span class="keyword">is</span> no longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">02</span>:<span class="number">47</span>:<span class="number">14.551</span> UTC [<span class="function"><span class="title">channelCmd</span>] InitCmdFactory -&gt;</span> INFO <span class="number">003</span> Endorser <span class="built_in">and</span> orderer connections initialized</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">02</span>:<span class="number">47</span>:<span class="number">14.629</span> UTC [<span class="function"><span class="title">channelCmd</span>] executeJoin -&gt;</span> INFO <span class="number">004</span> Successfully submitted proposal to join channel</span><br></pre></td></tr></table></figure>

<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 更新 锚节点 peer，每个 org 只需执行一次</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新对应的 org2 的</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">peer</span> channel update -o orderer0.orgorderer1:<span class="number">7050</span> -c mychannel -f ./channel-artifacts/Org2MSPanchors.tx</span><br></pre></td></tr></table></figure>

<h3 id="4-3-安装-chaincode"><a href="#4-3-安装-chaincode" class="headerlink" title="4.3 安装 chaincode"></a>4.3 安装 chaincode</h3><blockquote>
<p>安装 chaincode 需要在 org1 org2 的 cli 分别安装</p>
</blockquote>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  org1</span></span><br><span class="line"></span><br><span class="line">kubectl exec -it cli<span class="number">-68647</span>b4c-<span class="keyword">lhdhf </span>-n <span class="keyword">org1 </span><span class="keyword">bash</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"></span><br><span class="line"><span class="comment"># org2</span></span><br><span class="line"></span><br><span class="line">kubectl exec -it cli<span class="number">-5</span>bd96dc66d-<span class="keyword">j2m6d </span>-n <span class="keyword">org2 </span><span class="keyword">bash</span></span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 分别执行安装</span></span><br><span class="line"></span><br><span class="line">peer chaincode install -n example2 -v <span class="number">1.0</span> -p github.com<span class="regexp">/hyperledger/</span>fabric<span class="regexp">/peer/</span>channel-artifacts<span class="regexp">/chaincode/</span>example02</span><br></pre></td></tr></table></figure>

<h3 id="4-4-实例化-chaincode"><a href="#4-4-实例化-chaincode" class="headerlink" title="4.4 实例化 chaincode"></a>4.4 实例化 chaincode</h3><blockquote>
<p>实例化 chaincode 只需要在 其中一个 org 执行就可以</p>
</blockquote>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">peer</span> chaincode instantiate -o orderer0.orgorderer1:<span class="number">7050</span> <span class="punctuation">\</span></span><br><span class="line"><span class="punctuation"></span>                             -C mychannel -n example2 -v <span class="number">1</span>.<span class="number">0</span> <span class="punctuation">\</span></span><br><span class="line"><span class="punctuation"></span>                             -c &#x27;&#123;<span class="string">&quot;Args&quot;</span>:[<span class="string">&quot;init&quot;</span>,<span class="string">&quot;A&quot;</span>, <span class="string">&quot;100&quot;</span>, <span class="string">&quot;B&quot;</span>,<span class="string">&quot;200&quot;</span>]&#125;&#x27; <span class="punctuation">\</span></span><br><span class="line"><span class="punctuation"></span>                             -P <span class="string">&quot;OR (&#x27;Org1MSP.peer&#x27;,&#x27;Org2MSP.peer&#x27;)&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 实例化以后~会在 docker 中生成 一个容器<span class="punctuation">,</span> 脱离于k<span class="number">8</span>s 是由 docker 生成</span><br><span class="line"></span><br><span class="line">[root<span class="title">@kubernetes-3</span> ~]# docker ps -a</span><br><span class="line"></span><br><span class="line">CONTAINER ID        IMAGE                                                                                          COMMAND                  CREATED             STATUS                        PORTS               NAMES</span><br><span class="line"><span class="number">26666283</span>f<span class="number">935</span>        dev-peer<span class="number">0</span>.org<span class="number">1</span>-example<span class="number">2</span><span class="number">-1.0</span>-e<span class="number">8792315</span>af<span class="number">3</span>bc<span class="number">6</span>f<span class="number">98</span>b<span class="number">5</span>be<span class="number">21</span><span class="keyword">c</span><span class="number">4</span><span class="keyword">c</span><span class="number">98</span>ece<span class="number">1</span>ab<span class="number">5</span><span class="keyword">c</span><span class="number">65537e361691</span>af<span class="number">638304</span><span class="keyword">c</span><span class="number">0670</span>cd<span class="number">5</span>   <span class="string">&quot;chaincode -peer.add…&quot;</span>   <span class="number">6</span> minutes ago       Up <span class="number">6</span> minutes                                      dev-peer<span class="number">0</span>.org<span class="number">1</span>-example<span class="number">2</span><span class="number">-1.0</span></span><br></pre></td></tr></table></figure>

<h3 id="4-5-操作-chaincode"><a href="#4-5-操作-chaincode" class="headerlink" title="4.5 操作 chaincode"></a>4.5 操作 chaincode</h3><blockquote>
<p>执行 转账，查询 操作</p>
</blockquote>
<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询 A, B 账户的值</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">peer chaincode query -C mychannel -n example2 -c <span class="string">&#x27;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;A&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出如下:</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">03</span>:<span class="number">45</span>:<span class="number">18.469</span> UTC [main] InitCmd -&gt; WARN <span class="number">001</span> CORE_LOGGING_LEVEL <span class="keyword">is</span> <span class="literal">no</span> longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">03</span>:<span class="number">45</span>:<span class="number">18.485</span> UTC [main] SetOrdererEnv -&gt; WARN <span class="number">002</span> CORE_LOGGING_LEVEL <span class="keyword">is</span> <span class="literal">no</span> longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line"><span class="number">100</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">peer chaincode query -C mychannel -n example2 -c <span class="string">&#x27;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;B&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出如下:</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">03</span>:<span class="number">47</span>:<span class="number">21.683</span> UTC [main] InitCmd -&gt; WARN <span class="number">001</span> CORE_LOGGING_LEVEL <span class="keyword">is</span> <span class="literal">no</span> longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">03</span>:<span class="number">47</span>:<span class="number">21.701</span> UTC [main] SetOrdererEnv -&gt; WARN <span class="number">002</span> CORE_LOGGING_LEVEL <span class="keyword">is</span> <span class="literal">no</span> longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line"><span class="number">200</span></span><br></pre></td></tr></table></figure>

<figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># invoke 转账</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从A账户 转账 50 个币 到 B 账户</span></span><br><span class="line"></span><br><span class="line">peer chaincode invoke -C mychannel -n example2 -c <span class="string">&#x27;&#123;&quot;Args&quot;:[&quot;invoke&quot;, &quot;A&quot;, &quot;B&quot;, &quot;50&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出如下:</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">03</span>:<span class="number">48</span>:<span class="number">43.787</span> UTC [main] InitCmd -&gt; WARN <span class="number">001</span> CORE_LOGGING_LEVEL <span class="keyword">is</span> <span class="literal">no</span> longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">03</span>:<span class="number">48</span>:<span class="number">43.806</span> UTC [main] SetOrdererEnv -&gt; WARN <span class="number">002</span> CORE_LOGGING_LEVEL <span class="keyword">is</span> <span class="literal">no</span> longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">03</span>:<span class="number">48</span>:<span class="number">43.816</span> UTC [chaincodeCmd] InitCmdFactory -&gt; INFO <span class="number">003</span> Retrieved channel (mychannel) orderer endpoint: orderer0.orgorderer1:<span class="number">7050</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">03</span>:<span class="number">48</span>:<span class="number">43.830</span> UTC [chaincodeCmd] chaincodeInvokeOrQuery -&gt; INFO <span class="number">004</span> Chaincode invoke successful. result: status:<span class="number">200</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 转账后在查询 A, B 的值</span></span><br><span class="line"></span><br><span class="line">peer chaincode query -C mychannel -n example2 -c <span class="string">&#x27;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;A&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出:</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">03</span>:<span class="number">49</span>:<span class="number">10.686</span> UTC [main] InitCmd -&gt; WARN <span class="number">001</span> CORE_LOGGING_LEVEL <span class="keyword">is</span> <span class="literal">no</span> longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">03</span>:<span class="number">49</span>:<span class="number">10.702</span> UTC [main] SetOrdererEnv -&gt; WARN <span class="number">002</span> CORE_LOGGING_LEVEL <span class="keyword">is</span> <span class="literal">no</span> longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line"><span class="number">50</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">peer chaincode query -C mychannel -n example2 -c <span class="string">&#x27;&#123;&quot;Args&quot;:[&quot;query&quot;,&quot;B&quot;]&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出:</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">03</span>:<span class="number">49</span>:<span class="number">41.883</span> UTC [main] InitCmd -&gt; WARN <span class="number">001</span> CORE_LOGGING_LEVEL <span class="keyword">is</span> <span class="literal">no</span> longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">21</span> <span class="number">03</span>:<span class="number">49</span>:<span class="number">41.898</span> UTC [main] SetOrdererEnv -&gt; WARN <span class="number">002</span> CORE_LOGGING_LEVEL <span class="keyword">is</span> <span class="literal">no</span> longer supported, please use the FABRIC_LOGGING_SPEC environment variable</span><br><span class="line"><span class="number">250</span></span><br></pre></td></tr></table></figure>

<h1 id="五-blockchain-explorer-部署"><a href="#五-blockchain-explorer-部署" class="headerlink" title="五. blockchain-explorer 部署"></a>五. blockchain-explorer 部署</h1><blockquote>
<p>blockchain-explorer 是 fabric 的区块浏览器</p>
</blockquote>
<h2 id="1-配置-postgres"><a href="#1-配置-postgres" class="headerlink" title="1. 配置 postgres"></a>1. 配置 postgres</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 数据目录 , 创建于 nfs 中</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="regexp">/opt/</span>nfs<span class="regexp">/fabric/</span>data/postgres</span><br></pre></td></tr></table></figure>

<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># 创建 namesapce</span></span><br><span class="line"></span><br><span class="line">vi explorer-namespace.yaml</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">apiVersion:</span> v1</span><br><span class="line"><span class="symbol">kind:</span> Namespace</span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">    name:</span> explorer</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 pv  pvc</span></span><br><span class="line"></span><br><span class="line"><span class="string">vi</span> <span class="string">explorer-pv-pvc.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-pv</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">postgres-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/opt/nfs/fabric/data/postgres</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.249</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">namespace:</span> <span class="string">explorer</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">postgres-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">accessModes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line"> <span class="attr">resources:</span></span><br><span class="line">   <span class="attr">requests:</span></span><br><span class="line">     <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line"> <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">matchLabels:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">postgres-pv</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">explorer-pv</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">explorer-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">500Mi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/opt/nfs/fabric/fabric/crypto-config</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.249</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">namespace:</span> <span class="string">explorer</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">explorer-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">accessModes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line"> <span class="attr">resources:</span></span><br><span class="line">   <span class="attr">requests:</span></span><br><span class="line">     <span class="attr">storage:</span> <span class="string">100Mi</span></span><br><span class="line"> <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">matchLabels:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">explorer-pv</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 postgres deployment</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">vi</span> <span class="string">postgres-deployment.yaml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">explorer</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-db</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">explorer-db</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">postgres:10-alpine</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TZ</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATABASE_DATABASE</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;fabricexplorer&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATABASE_USERNAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;jicki&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATABASE_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;password&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/var/lib/postgresql/data</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">postgresdata</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgresdata</span></span><br><span class="line">         <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">           <span class="attr">claimName:</span> <span class="string">postgres-pv</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-db</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">explorer</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">explorer-db</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">explorer-db</span></span><br><span class="line"> <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5432</span></span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 服务</span></span><br><span class="line"></span><br><span class="line">[root@kubernetes-<span class="number">1</span> <span class="regexp">/opt/</span>jicki<span class="regexp">/k8s-yaml/</span>explorer]<span class="comment"># kubectl get pods -n explorer</span></span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">postgres-db-<span class="number">7884</span>d8c859-s8hqq   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">32</span>s</span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化数据库 </span></span><br><span class="line"><span class="comment"># 初始化数据库这边只能手动登录 pods 里操作一下, 导入表结构以及初始化数据。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl get pods -n explorer</span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE</span><br><span class="line">postgres-db-<span class="number">7884</span>d8c859-s8hqq   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">2</span>m33s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl exec -it postgres-db-<span class="number">7884</span>d8c859-s8hqq -n explorer bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cd <span class="regexp">/tmp/</span></span><br><span class="line"></span><br><span class="line">wget https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/hyperledger/</span>blockchain-explorer<span class="regexp">/master/</span>app<span class="regexp">/persistence/</span>fabric<span class="regexp">/postgreSQL/</span>db/createdb.sh</span><br><span class="line">wget https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/hyperledger/</span>blockchain-explorer<span class="regexp">/master/</span>app<span class="regexp">/persistence/</span>fabric<span class="regexp">/postgreSQL/</span>db/explorerpg.sql</span><br><span class="line">wget https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/hyperledger/</span>blockchain-explorer<span class="regexp">/master/</span>app<span class="regexp">/persistence/</span>fabric<span class="regexp">/postgreSQL/</span>db/processenv.js</span><br><span class="line">wget https:<span class="regexp">//</span>raw.githubusercontent.com<span class="regexp">/hyperledger/</span>blockchain-explorer<span class="regexp">/master/</span>app<span class="regexp">/persistence/</span>fabric<span class="regexp">/postgreSQL/</span>db/updatepg.sql</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装依赖软件</span></span><br><span class="line"></span><br><span class="line">apk update</span><br><span class="line">apk add jq</span><br><span class="line">apk add nodejs</span><br><span class="line">apk add sudo</span><br><span class="line">rm -rf <span class="regexp">/var/</span>cache<span class="regexp">/apk/</span>*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行创建脚本</span></span><br><span class="line"></span><br><span class="line">chmod +x ./createdb.sh</span><br><span class="line">./createdb.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 看出输出 表示完成</span></span><br><span class="line">You are now connected to database <span class="string">&quot;fabricexplorer&quot;</span> as user <span class="string">&quot;postgres&quot;</span>.</span><br><span class="line"></span><br><span class="line">退出pods</span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"># 创建 explorer 配置文件 config<span class="selector-class">.json</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi config<span class="selector-class">.json</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;network-configs&quot;: &#123;</span><br><span class="line">    &quot;network-<span class="number">1</span>&quot;: &#123;</span><br><span class="line">      &quot;version&quot;: <span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">      <span class="string">&quot;clients&quot;</span>: &#123;</span><br><span class="line">        &quot;client-<span class="number">1</span>&quot;: &#123;</span><br><span class="line">          &quot;tlsEnable&quot;: false,</span><br><span class="line">          <span class="string">&quot;organization&quot;</span>: <span class="string">&quot;Org1MSP&quot;</span>,</span><br><span class="line">          <span class="string">&quot;channel&quot;</span>: <span class="string">&quot;mychannel&quot;</span>,</span><br><span class="line">          <span class="string">&quot;credentialStore&quot;</span>: &#123;</span><br><span class="line">            &quot;<span class="selector-tag">path</span>&quot;: <span class="string">&quot;./tmp/credentialStore_Org1/credential&quot;</span>,</span><br><span class="line">            <span class="string">&quot;cryptoStore&quot;</span>: &#123;</span><br><span class="line">              &quot;<span class="selector-tag">path</span>&quot;: <span class="string">&quot;./tmp/credentialStore_Org1/crypto&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;channels&quot;: &#123;</span><br><span class="line">        &quot;mychannel&quot;: &#123;</span><br><span class="line">          &quot;peers&quot;: &#123;</span><br><span class="line">            &quot;peer0<span class="selector-class">.org1</span>&quot;: &#123;&#125;,</span><br><span class="line">            &quot;peer1<span class="selector-class">.org1</span>&quot;: &#123;&#125;,</span><br><span class="line">            &quot;peer0<span class="selector-class">.org2</span>&quot;: &#123;&#125;,</span><br><span class="line">            &quot;peer1<span class="selector-class">.org2</span>&quot;: &#123;&#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;connection&quot;: &#123;</span><br><span class="line">            &quot;timeout&quot;: &#123;</span><br><span class="line">              &quot;peer&quot;: &#123;</span><br><span class="line">                &quot;endorser&quot;: <span class="string">&quot;6000&quot;</span>,</span><br><span class="line">                <span class="string">&quot;eventHub&quot;</span>: <span class="string">&quot;6000&quot;</span>,</span><br><span class="line">                <span class="string">&quot;eventReg&quot;</span>: <span class="string">&quot;6000&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;organizations&quot;: &#123;</span><br><span class="line">        &quot;Org1MSP&quot;: &#123;</span><br><span class="line">          &quot;mspid&quot;: <span class="string">&quot;Org1MSP&quot;</span>,</span><br><span class="line">          <span class="string">&quot;fullpath&quot;</span>: false,</span><br><span class="line">          <span class="string">&quot;adminPrivateKey&quot;</span>: &#123;</span><br><span class="line">            &quot;<span class="selector-tag">path</span>&quot;:</span><br><span class="line">              <span class="string">&quot;/fabric/peerOrganizations/org1/users/Admin@org1/msp/keystore&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;signedCert&quot;: &#123;</span><br><span class="line">            &quot;<span class="selector-tag">path</span>&quot;:</span><br><span class="line">              <span class="string">&quot;/fabric/peerOrganizations/org1/users/Admin@org1/msp/signcerts&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Org2MSP&quot;: &#123;</span><br><span class="line">          &quot;mspid&quot;: <span class="string">&quot;Org2MSP&quot;</span>,</span><br><span class="line">          <span class="string">&quot;fullpath&quot;</span>: false,</span><br><span class="line">          <span class="string">&quot;adminPrivateKey&quot;</span>: &#123;</span><br><span class="line">            &quot;<span class="selector-tag">path</span>&quot;:</span><br><span class="line">              <span class="string">&quot;/fabric/peerOrganizations/org2/users/Admin@org2/msp/keystore&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;signedCert&quot;: &#123;</span><br><span class="line">            &quot;<span class="selector-tag">path</span>&quot;:</span><br><span class="line">              <span class="string">&quot;/fabric/peerOrganizations/org2/users/Admin@org2/msp/signcerts&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Orgorderer1MSP&quot;: &#123;</span><br><span class="line">          &quot;mspid&quot;: <span class="string">&quot;Orgorderer1MSP&quot;</span>,</span><br><span class="line">          <span class="string">&quot;adminPrivateKey&quot;</span>: &#123;</span><br><span class="line">            &quot;<span class="selector-tag">path</span>&quot;:</span><br><span class="line">              <span class="string">&quot;/fabric/ordererOrganizations/orgorderer1/users/Admin@orgorderer1/msp/keystore&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;peers&quot;: &#123;</span><br><span class="line">        &quot;peer0<span class="selector-class">.org1</span>&quot;: &#123;</span><br><span class="line">          &quot;tlsCACerts&quot;: &#123;</span><br><span class="line">            &quot;<span class="selector-tag">path</span>&quot;:</span><br><span class="line">              <span class="string">&quot;/fabric/peerOrganizations/org1/peers/peer0.org1/tls/ca.crt&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;url&quot;: <span class="string">&quot;grpc://peer0.org1:7051&quot;</span>,</span><br><span class="line">          <span class="string">&quot;eventUrl&quot;</span>: <span class="string">&quot;grpc://peer0.org1:7053&quot;</span>,</span><br><span class="line">          <span class="string">&quot;grpcOptions&quot;</span>: &#123;</span><br><span class="line">            &quot;ssl-target-name-override&quot;: <span class="string">&quot;peer0.org1&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;peer1<span class="selector-class">.org1</span>&quot;: &#123;</span><br><span class="line">          &quot;tlsCACerts&quot;: &#123;</span><br><span class="line">            &quot;<span class="selector-tag">path</span>&quot;:</span><br><span class="line">              <span class="string">&quot;/fabric/peerOrganizations/org1/peers/peer1.org1/tls/ca.crt&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;url&quot;: <span class="string">&quot;grpc://peer1.org1:7051&quot;</span>,</span><br><span class="line">          <span class="string">&quot;eventUrl&quot;</span>: <span class="string">&quot;grpc://peer1.org1:7053&quot;</span>,</span><br><span class="line">          <span class="string">&quot;grpcOptions&quot;</span>: &#123;</span><br><span class="line">            &quot;ssl-target-name-override&quot;: <span class="string">&quot;peer1.org1&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;peer0<span class="selector-class">.org2</span>&quot;: &#123;</span><br><span class="line">          &quot;tlsCACerts&quot;: &#123;</span><br><span class="line">            &quot;<span class="selector-tag">path</span>&quot;:</span><br><span class="line">              <span class="string">&quot;/fabric/peerOrganizations/org2/peers/peer0.org2/tls/ca.crt&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;url&quot;: <span class="string">&quot;grpc://peer0.org2:7051&quot;</span>,</span><br><span class="line">          <span class="string">&quot;eventUrl&quot;</span>: <span class="string">&quot;grpc://peer0.org2:7053&quot;</span>,</span><br><span class="line">          <span class="string">&quot;grpcOptions&quot;</span>: &#123;</span><br><span class="line">            &quot;ssl-target-name-override&quot;: <span class="string">&quot;peer0.org2&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;peer1<span class="selector-class">.org2</span>&quot;: &#123;</span><br><span class="line">          &quot;tlsCACerts&quot;: &#123;</span><br><span class="line">            &quot;<span class="selector-tag">path</span>&quot;:</span><br><span class="line">              <span class="string">&quot;/fabric/peerOrganizations/org2/peers/peer1.org2/tls/ca.crt&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;url&quot;: <span class="string">&quot;grpc://peer1.org2:7051&quot;</span>,</span><br><span class="line">          <span class="string">&quot;eventUrl&quot;</span>: <span class="string">&quot;grpc://peer1.org2:7053&quot;</span>,</span><br><span class="line">          <span class="string">&quot;grpcOptions&quot;</span>: &#123;</span><br><span class="line">            &quot;ssl-target-name-override&quot;: <span class="string">&quot;peer1.org2&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;orderers&quot;: &#123;</span><br><span class="line">        &quot;orderer0<span class="selector-class">.orgorderer1</span>&quot;: &#123;</span><br><span class="line">          &quot;url&quot;: <span class="string">&quot;grpc://orderer0.orgorderer1:7050&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;network-<span class="number">2</span>&quot;: &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;configtxgenToolPath&quot;: <span class="string">&quot;/fabric-path/workspace/fabric-samples/bin&quot;</span>,</span><br><span class="line">  <span class="string">&quot;license&quot;</span>: <span class="string">&quot;Apache-2.0&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建运行脚本 run.sh</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vi run.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">mkdir -p <span class="regexp">/opt/</span>explorer<span class="regexp">/app/</span>platform<span class="regexp">/fabric/</span></span><br><span class="line"></span><br><span class="line">mv <span class="regexp">/opt/</span>explorer<span class="regexp">/app/</span>platform<span class="regexp">/fabric/</span>config.json <span class="regexp">/opt/</span>explorer<span class="regexp">/app/</span>platform<span class="regexp">/fabric/</span>config.json.vanilla</span><br><span class="line">cp <span class="regexp">/fabric/</span>config.json <span class="regexp">/opt/</span>explorer<span class="regexp">/app/</span>platform<span class="regexp">/fabric/</span>config.json</span><br><span class="line"></span><br><span class="line">cd <span class="regexp">/opt/</span>explorer</span><br><span class="line">node <span class="variable">$EXPLORER_APP_PATH</span><span class="regexp">/main.js &amp;&amp; tail -f /</span>dev/null</span><br></pre></td></tr></table></figure>

<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拷贝文件到 NFS 目录中 并 授权</span></span><br><span class="line"></span><br><span class="line">cp config.json run.sh <span class="regexp">/opt/</span>nfs<span class="regexp">/fabric/</span>fabric<span class="regexp">/crypto-config/</span></span><br><span class="line"></span><br><span class="line">chmod +x <span class="regexp">/opt/</span>nfs<span class="regexp">/fabric/</span>fabric<span class="regexp">/crypto-config/</span>run.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建 deployment 服务</span></span><br><span class="line"></span><br><span class="line"><span class="string">vi</span> <span class="string">explorer-deployment.yaml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">explorer</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">explorer</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">explorer</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">explorer</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">hyperledger/explorer:latest</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span> , <span class="string">&quot;-c&quot;</span> , <span class="string">&quot;/fabric/run.sh&quot;</span>]</span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TZ</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;Asia/Shanghai&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATABASE_HOST</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;postgres-db&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATABASE_USERNAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;jicki&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DATABASE_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">&quot;password&quot;</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/fabric</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">certfile</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">certfile</span></span><br><span class="line">         <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">             <span class="attr">claimName:</span> <span class="string">explorer-pv</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">explorer</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">explorer</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"> <span class="attr">selector:</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">explorer</span></span><br><span class="line"> <span class="attr">ports:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">webui</span></span><br><span class="line">     <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">     <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">explorer-ingress</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">explorer</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">explorer.jicki.me</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">explorer</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>


    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2019/11/100624.html" class="pre-post btn btn-default" title='部署 hyperledger-fabric v1.4'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">部署 hyperledger-fabric v1.4</span>
        </a>
    
    
        <a href="/archives/2019/11/100622.html" class="next-post btn btn-default" title='用Kubernetes部署超级账本Fabric的区块链即服务(BaaS)'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">用Kubernetes部署超级账本Fabric的区块链即服务(BaaS)</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>


    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80-%E7%8E%AF%E5%A2%83%E8%AF%B4%E6%98%8E"><span class="toc-text">一. 环境说明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E7%B3%BB%E7%BB%9F%E8%AF%B4%E6%98%8E"><span class="toc-text">1. 系统说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%9C%8D%E5%8A%A1%E8%AF%B4%E6%98%8E"><span class="toc-text">2. 服务说明</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C-Fabric-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-text">二. Fabric 环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-docker-%E9%85%8D%E7%BD%AE"><span class="toc-text">1. docker 配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-cryptogen-%E4%B8%8B%E8%BD%BD"><span class="toc-text">2. cryptogen 下载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Fabric-%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD"><span class="toc-text">3. Fabric 源码下载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E7%94%9F%E6%88%90-%E8%AF%81%E4%B9%A6"><span class="toc-text">4. 生成 证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E7%94%9F%E6%88%90%E5%88%9D%E5%A7%8B%E5%8C%96Fabric%E6%96%87%E4%BB%B6"><span class="toc-text">5. 生成初始化Fabric文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89-%E9%85%8D%E7%BD%AE-NFS-StorageClass"><span class="toc-text">三. 配置 NFS StorageClass</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85-NFS"><span class="toc-text">1. 安装 NFS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AE-NFS"><span class="toc-text">2. 配置 NFS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%85%8D%E7%BD%AE-NFS-Client-Provisioner"><span class="toc-text">3. 配置 NFS Client Provisioner</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B-%E9%83%A8%E7%BD%B2-Fabric"><span class="toc-text">四. 部署 Fabric</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA-zookeeper"><span class="toc-text">1. 创建 zookeeper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA-kafka"><span class="toc-text">2. 创建 kafka</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BA-Fabric-%E6%9C%8D%E5%8A%A1"><span class="toc-text">3. 创建 Fabric 服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">3.1 初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E9%85%8D%E7%BD%AE-orderer"><span class="toc-text">3.2 配置 orderer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E9%85%8D%E7%BD%AE-org1-%E6%9C%8D%E5%8A%A1"><span class="toc-text">3.3 配置 org1 服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4-%E9%85%8D%E7%BD%AE-org2-%E6%9C%8D%E5%8A%A1"><span class="toc-text">3.4 配置 org2 服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-%E9%85%8D%E7%BD%AE-cli-%E6%9C%8D%E5%8A%A1"><span class="toc-text">3.5 配置 cli 服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4"><span class="toc-text">4. 测试集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-org1-%E8%8A%82%E7%82%B9"><span class="toc-text">4.1 org1 节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-org2-%E8%8A%82%E7%82%B9"><span class="toc-text">4.2 org2 节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%AE%89%E8%A3%85-chaincode"><span class="toc-text">4.3 安装 chaincode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E5%AE%9E%E4%BE%8B%E5%8C%96-chaincode"><span class="toc-text">4.4 实例化 chaincode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E6%93%8D%E4%BD%9C-chaincode"><span class="toc-text">4.5 操作 chaincode</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94-blockchain-explorer-%E9%83%A8%E7%BD%B2"><span class="toc-text">五. blockchain-explorer 部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%85%8D%E7%BD%AE-postgres"><span class="toc-text">1. 配置 postgres</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2025&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>








<script src="/js/app.js?rev=@@hash.js"></script>


</body>
</html>