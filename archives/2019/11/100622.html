<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="区块链,baas,kubernetes,fabric">


    <meta name="description" content="1. 概述盼望着，盼望着，超级账本 Fabric 1.0 正式来了，社区用户为之欢呼雀跃：终于等到一个企业级区块链应用平台了。然而在激动过后，回归平静之时，人们却往往发现，搭建Fabric平台是...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>用Kubernetes部署超级账本Fabric的区块链即服务(BaaS) | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx">


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="用Kubernetes部署超级账本Fabric的区块链即服务(BaaS)">
            
	            用Kubernetes部署超级账本Fabric的区块链即服务(BaaS)
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/cloud/">云计算</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/baas/">baas</a> <a class="tag-link" href="/tags/fabric/">fabric</a> <a class="tag-link" href="/tags/kubernetes/">kubernetes</a> <a class="tag-link" href="/tags/blockchain/">区块链</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2019/11/28</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>1239</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a><strong>1. 概述</strong></h1><p>盼望着，盼望着，超级账本 Fabric 1.0 正式来了，社区用户为之欢呼雀跃：终于等到一个企业级区块链应用平台了。然而在激动过后，回归平静之时，人们却往往发现，搭建Fabric平台是个相当披荆斩棘的历程。不仅要具备密码学、分布式计算、共识算法等区块链理论基础，而且要熟悉容器、Golang / Node.js 这些企业用户不常用的工程技术，这常常是很多人把区块链放弃在起跑线的原因。降低使用门槛，提高易用性，将是今后一段时间内推广企业区块链应用的重要工作。</p>
<p>之前我们的文章描述过安装部署多节点 Fabric 集群的步骤，旨在说明Fabric基本的运作原理，因此部署过程是手  (cao)  动  (gen)  的安装方式。在实际的开发测试中，需要自动化部署来提高效率，本文介绍如何利用容器平台Kubernetes（K8s）来自动部署 Fabric 1.0，实现区块链即服务 (Blockchain as a Service, BaaS) 的基础。</p>
<p>需要指出的是，BaaS目前多用于开发测试，即在同一个BaaS平台，部署多个区块链节点，每个节点代表不同组织机构。这样显然是中心化的部署方式，只能用于开发测试用途。真实环境的部署需要分布在网络中多个BaaS协同工作才能完成，这是另外一个尚待完善的工作。</p>
<p>我们选择把 Fabric 部署在 K8s 上有几个原因。首先 Fabric 的组件都经过容器封装好的，很方便部署在 K8s 这类容器平台上，并借助平台实现高可用、监控管理、自动化运维等目的。</p>
<p>其次，Fabric 是分布式系统，根据应用的具体需求，集群的各个组件数会有不同，需要灵活地配置和调整。而 K8s 是面向微服务架构的容器平台，扩展方便，能够很好地满足 Fabric 这方面的要求。</p>
<p>还有就是 K8s 具备了多租户的能力，可在同一个平台中运行多个互相隔离的 Fabric 实例，方便开发测试，比如一个实例作为开发用，另一个实例作为测试用。</p>
<p>在超级账本中有个子项目叫 Cello ，其目的是提供 Hyperledger 的 BaaS 。据了解，目前已经支持把 Fabric 部署在 Docker 和 Swarm 上，有关 K8s 的支持还在开发中。由于 Fabric 的设计中没有考虑到 K8s 等平台的特点，因此把 Fabric 部署在 K8s 上还需要一些变通的处理方法，后文相关部分会提到。</p>
<h1 id="2-整体架构"><a href="#2-整体架构" class="headerlink" title="2. 整体架构"></a><strong>2. 整体架构</strong></h1><h2 id="2-1-基础设施"><a href="#2-1-基础设施" class="headerlink" title="2.1 基础设施"></a><strong>2.1 基础设施</strong></h2><h3 id="1-网络部分"><a href="#1-网络部分" class="headerlink" title="1)   网络部分"></a><strong>1)   网络部分</strong></h3><p>Kubernetes 集群由多个节点组成，为使得集群上的容器正常通信，需要创建一个 overlay 网络，并把集群上的容器都连接到这个网络上。</p>
<div style="text-align:center;"><img src="/img/blockchain/515iuu058w.png" alt="img"><br>图 2- 1 </div>

<p>如图2-1所示，宿主机网络由蓝色线标记，节点有 cmd 客户机, Kubernetes 的 master 和 worker ，还有 NFS 服务器。其中，cmd 客户机作为操作 K8S和 Fabric 集群的命令行客户机。NFS服务器在各个节点间用于共享 Fabric 和 K8s 的各种配置文件，也可以用其他 K8s 支持的共享存储代替。</p>
<p>通过 Kubernetes 的 cluster add-ons 可以很方便地创建 overlay 网络，如 Flannel 。如图 2-1的红色线所示(为说明Flannel作用省去部分细节)，Kubernetes 把所有pod加入到 Flannel 网络中，因此 pod 中的容器可以相互通信。</p>
<p>Flannel网络的地址段可以在 add-on 的配置文件中指定，同时 kube_dns 的 IP 地址也可以通过配置修改，但该IP地址必须处于指定地址段中。如图2-1中 Flannel 的网络为10.0.0.1/16，kube_dns 的 IP 地址为10.0.0.10。</p>
<p>在 Fabric 设计中， chaincode 目前是以 Docker 容器的方式运行在 peer 容器所在的宿主机上，peer 容器需要调用 Docker 引擎的接口来构建和创建chaincode 容器，调用接口是通过这个连接：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unix:<span class="regexp">//</span><span class="regexp">/var/</span>run<span class="regexp">/docker.sock</span></span><br></pre></td></tr></table></figure>
<p>这种方式其实是有安全隐患的，这里不作过多讨论。正确的姿势应该是调用chaincode 专用的运行环境，如新起一个 Docker Host ，用 TCP 接口远程调用。</p>
<p>通过docker.sock 创建的容器脱离在 Kubernetes 的体系之外，虽然它仍在 Flannel 的网络上，但却无法获得 peer 节点的 IP 地址。这是因为创建该容器的 Docker 引擎使用宿主机默认的 DNS 解析来 peer 的域名，所以无法找到。</p>
<p>为了解决解析域名的问题，需要在每个 worker 的 DOCKER_OPTS 中加入相关参数，以图 2-1为例，kube_dns 的 IP 为10.0.0.10，宿主机网络 DNS 的 IP 地址假设为192.168.0.1，为使得 chaincode 的容器可以解析到 peer 节点，修改步骤如下：</p>
<p>(1). 编辑 /etc/default/docker，在 DOCKER_OPTS 中添加以下参数，设置 Kubernetes 使用的 DNS （很重要！）:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">--dns=<span class="number">10.0</span>.<span class="number">0.10</span> --dns=<span class="number">192.168</span>.<span class="number">0.1</span>  --dns-<span class="built_in">search</span> \ </span><br><span class="line"></span><br><span class="line">default.svc.cluster.local--dns-<span class="built_in">search</span> svc.cluster.local \ --dns-<span class="keyword">opt</span> ndot<span class="variable">s:2</span> --dns-<span class="keyword">opt</span> timeou<span class="variable">t:2</span> --dns-<span class="keyword">opt</span> attempt<span class="variable">s:2</span></span><br></pre></td></tr></table></figure>
<p>(2). 运行以下命令重启Docker (注: 不同的Linux环境中命令可能会有不同)：<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">restart</span> docker</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">restart</span> docker.service</span><br></pre></td></tr></table></figure></p>
<h3 id="2-共享存储"><a href="#2-共享存储" class="headerlink" title="2)  共享存储"></a><strong>2)  共享存储</strong></h3><p>K8s 和 Fabric 集群需要较多的配置文件，为方便管理，可通过 NFS 服务器来统一储存这些文件，如图 2-1所示。</p>
<p>cmd客户机可通过 cryptogen 工具生成 crypto-config 目录，该用于储存 Fabric 集群中节点的配置文件，如 peer0.org1 所用到的 msp 存放在以下目录：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crypto-config<span class="regexp">/PeerOrganization/</span>org1<span class="regexp">/peers/</span>peer0<span class="regexp">/msp</span></span><br></pre></td></tr></table></figure></p>
<p>cmd客户机只需要把 NFS 的共享目录挂载到本地 /opt/share/ ，再把 crypto-config 写到该目录，即可让各个节点访问到配置文件。</p>
<p>在 Kubernetes 中，通过 PV 和 PVC 来把 NFS 上的文件挂载到容器中，除了创建相应的 PV 和 PVC 外，还需在节点的配置文件中把正确的路径挂载进去。若NFS 服务器的共享目录为 /opt/share ，创建 PV 时可指定 peer.org1 的挂载点为：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/opt/</span>share<span class="regexp">/crypto-config/</span>PeerOrganization<span class="regexp">/org1/</span></span><br></pre></td></tr></table></figure></p>
<p>然后创建与该 PV 相对应的 PVC ，这样在节点的配置文件中就可以使用 PVC 来挂载这个目录。节点需要根据自己的 ID 在挂载点后面加上相应的路径来保证挂载的配置文件无误，如 peer0.org1 应在路径后加上 peers/peer0/msp ，则其挂载目录的完整路径如下：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/opt/</span>share<span class="regexp">/crypto-config/</span>PeerOrganization<span class="regexp">/org1/</span>peers<span class="regexp">/peer0/m</span>sp</span><br></pre></td></tr></table></figure></p>
<h2 id="2-2-组件划分"><a href="#2-2-组件划分" class="headerlink" title="2.2  组件划分"></a><strong>2.2  组件划分</strong></h2><p>在 Kubernetes 中，Namespace 是一个很重要的概念，它用于划分不同的虚拟集群，而 Fabric 中 organization 基于证书签发机构划分，把 K8S 的 namespace 与 Fabric 的 organization 对应，既使得 organization 之间相互独立，又充分利用了 K8S 的 DNS 服务，各个 organization 可以通过域名区分。采用 namespace 分隔各个组织的组件，还可实现网络策略 (network policy) 来隔离不同组织，实现多租户的能力 (本文未涉及)。</p>
<div style="text-align:center;"><img src="/img/blockchain/psmvcx0n6u.png" alt="img"><br>图 2- 2</div>

<p>如图 2-2所示，假设 Fabric 网络中有多个 peer organization 和 orderer organization ，下面阐述如何在 Kubernetes 进行划分和对应：</p>
<p>a.   若第N个 Fabric 的 peer organization 的域名为 orgN，则其在 Kubernetes 上对应的 namespace 设置为 orgN ，在该 namespace 下有多个 pod，pod 的类型如下：</p>
<p>1)   Peer Pod：包括 Fabric peer，couchDB （可选），代表每个组织的 peer节点。</p>
<p>2)   CA Server Pod： Fabric CA Server。</p>
<p>3)   CLI Pod：（可选）提供命令行工具的环境，用于操作本组织的节点、channel 或 chaincode。</p>
<p>b.   若第N个 Fabric 的 orderer organization 的域名为 orgordererN ，则其在Kubernetes 上对应的 namespace 为 orgordererN ，该 namespace 下只有一种  Pod ，它用于运行 orderer 节点。</p>
<p>c.   Kafka namespace 与 Fabric 的 organization 并无关系，它只用来运行和管理Zookeeper和Kafka容器，实现共识算法。</p>
<h2 id="2-3-Pod之间的通信"><a href="#2-3-Pod之间的通信" class="headerlink" title="2.3  Pod之间的通信"></a><strong>2.3  Pod之间的通信</strong></h2><p>Kubernetes 中的每个 Pod 都有独立的 IP 地址，然而在各个 Pod 之间直接通过 IP:port 的方式来通信会带来很多麻烦，因此有必要给每一个 Pod 绑定一个的 service ，以便用 service 名称来访问。</p>
<p>service 的命名方式应当遵循以下原则，彰显与其绑定的 Pod 信息：</p>
<p>1)   service 与 pod 的 namespace 应当一致。</p>
<p>2)   service 的 name 应与 Pod 中容器的 id 一致。</p>
<p>例如，Fabric 中属于 org1 的 peer0 节点，在 K8S 中用 namespace 为 org1、名字为 peer0 的 Pod 来运行，与该 Pod 绑定的 service 全称应为 peer0.org1 。其中 peer0 为 service 的名称，org1 为 service 的 namespace 。这样的映射关系已经和主机域名很接近了。</p>
<h1 id="3-源码的说明与使用"><a href="#3-源码的说明与使用" class="headerlink" title="3. 源码的说明与使用"></a><strong>3. 源码的说明与使用</strong></h1><h2 id="3-1-环境准备"><a href="#3-1-环境准备" class="headerlink" title="3.1 环境准备"></a><strong>3.1 环境准备</strong></h2><p>假定 K8s 平台已经成功部署，并且在各个 worker 节点已经预先下载相应的 Fabric v1.0.0 的 Docker 镜像，如表3-1。（预先下载镜像是由于国内网速较慢，在一台机器预先下载后，可用Docker命令导出并导入其他机器。）表 3- 1：</p>
<table>
<thead>
<tr>
<th style="text-align:left">IMAGE</th>
<th style="text-align:left">TAG</th>
<th style="text-align:left">ID</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">hyperledger/fabric-tools</td>
<td style="text-align:left">x86_64-1.0.0</td>
<td style="text-align:left">0403fd1c72c7</td>
</tr>
<tr>
<td style="text-align:left">hyperledger/fabric-orderer</td>
<td style="text-align:left">x86_64-1.0.0</td>
<td style="text-align:left">e317ca5638ba</td>
</tr>
<tr>
<td style="text-align:left">hyperledger/fabric-peer</td>
<td style="text-align:left">x86_64-1.0.0</td>
<td style="text-align:left">6830dcd7b9b5</td>
</tr>
<tr>
<td style="text-align:left">hyperledger/fabric-ccenv</td>
<td style="text-align:left">x86_64-1.0.0</td>
<td style="text-align:left">7182c260a5ca</td>
</tr>
<tr>
<td style="text-align:left">hyperledger/fabric-ca</td>
<td style="text-align:left">x86_64-1.0.0</td>
<td style="text-align:left">a15c59ecda5b</td>
</tr>
<tr>
<td style="text-align:left">hyperledger/fabric-baseimage</td>
<td style="text-align:left">x86_64-0.3.1</td>
<td style="text-align:left">9f2e9ec7c527</td>
</tr>
<tr>
<td style="text-align:left">hyperledger/fabric-baseos</td>
<td style="text-align:left">x86_64-0.3.1</td>
<td style="text-align:left">4b0cab202084</td>
</tr>
</tbody>
</table>
<p>本文涉及代码的目录结构及其作用如下：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Fabric-on-k8s</span><br><span class="line"></span><br><span class="line">   \- README.md</span><br><span class="line"></span><br><span class="line">   \- setupCluster</span><br><span class="line"></span><br><span class="line">         \- generateALL<span class="selector-class">.sh</span>        <span class="comment">// 负责生成K8S部署文件</span></span><br><span class="line"></span><br><span class="line">         \- <span class="attribute">transform</span>                 // 用于启动部署文件</span><br><span class="line"></span><br><span class="line">         \- templates                <span class="comment">// 存放模板</span></span><br><span class="line"></span><br><span class="line">         \- cluster-config<span class="selector-class">.yaml</span> <span class="comment">// 用于配置Fabric集群</span></span><br><span class="line"></span><br><span class="line">         \- configtx<span class="selector-class">.yaml</span>          <span class="comment">// 用于配置channel</span></span><br></pre></td></tr></table></figure></p>
<h2 id="3-2-配置文件说明"><a href="#3-2-配置文件说明" class="headerlink" title="3.2 配置文件说明"></a><strong>3.2 配置文件说明</strong></h2><p>在规划 Fabric 集群部署时，要按实际需求，编辑以下两个 Fabric 集群的定义文件：</p>
<h3 id="a-cluster-config-yaml"><a href="#a-cluster-config-yaml" class="headerlink" title="a.   cluster-config.yaml"></a><strong>a.   cluster-config.yaml</strong></h3><p>cryptogen 工具根据 cluster-config.yaml 来生成 Fabric 成员的证书，一个简单的例子如下:<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">OrdererOrgs</span>:</span><br><span class="line"></span><br><span class="line"> - <span class="attribute">Name</span>: Orderer</span><br><span class="line"></span><br><span class="line">   <span class="attribute">Domain</span>: orgorderer1</span><br><span class="line"></span><br><span class="line">   <span class="attribute">Template</span>:</span><br><span class="line"></span><br><span class="line">     <span class="attribute">Count</span>: <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">PeerOrgs</span>:</span><br><span class="line"></span><br><span class="line"> - <span class="attribute">Name</span>: Org1</span><br><span class="line"></span><br><span class="line">   <span class="attribute">Domain</span>: org1</span><br><span class="line"></span><br><span class="line">   <span class="attribute">Template</span>:</span><br><span class="line"></span><br><span class="line">     <span class="attribute">Count</span>: <span class="number">2</span></span><br><span class="line"></span><br><span class="line"> - <span class="attribute">Name</span>: Org2</span><br><span class="line"></span><br><span class="line">   <span class="attribute">Domain</span>: org2</span><br><span class="line"></span><br><span class="line">   <span class="attribute">Template</span>:</span><br><span class="line"></span><br><span class="line">     <span class="attribute">Count</span>: <span class="number">2</span></span><br></pre></td></tr></table></figure></p>
<p>其中 OrdererOrgs 和 PeerOrgs 关键字区分 organization 的类型，两种组织的内部结构如下：</p>
<p><strong>1)</strong> OrdererOrgs 中定义了一个名字为 Orderer ，域名为 orgorderer1 的 org ，并且它指定 template 中 count 的数值为 1，则在该 org 下只有一个 orderer ，其 id 为 orderer0 。</p>
<p><strong>2)</strong> PeerOrgs 中定义了两个 org ，分别为 Org1 和 Org2 ，对应的域名为 org1、 org2 与 orderer 类似，每个 org 生成了两个 peers ，虽然 org1 中 peer0 和 org2 中 peer0 的ID重复，但是他不属于同一个 org ，通过域名很容易就能区分出它们。</p>
<p>需要注意的是，由于 K8S 中的 namespace 不支持‘.’和大写字母，因此各个组织的域名不能包含这些字符。</p>
<p>更多关于 cluster-config.yaml 的配置方式，请读者可参考 Fabric 源码中的关于cryptogen 的描述 ( fabric/common/tools/cryptogen/main.go )</p>
<p>以上定义的 cluster-config.yaml ，cryptogen 工具会生成 crypto-config 目录，该目录的结构如下：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">crypto-<span class="built_in">config</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">---ordererOrganizations</span></span><br><span class="line"></span><br><span class="line">           <span class="comment">--- orgorderer1</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">---msp</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">--- ca</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">--- tlsca</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">--- users</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">--- orderers</span></span><br><span class="line"></span><br><span class="line">                     <span class="comment">---orderer0.orgorderer1</span></span><br><span class="line"></span><br><span class="line">                          <span class="comment">---msp</span></span><br><span class="line"></span><br><span class="line">                          <span class="comment">--- tls</span></span><br><span class="line"></span><br><span class="line">         <span class="comment">---peerOrganizations</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">--- org1</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">---msp</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">--- ca</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">--- tlsca</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">--- users</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">--- peers</span></span><br><span class="line"></span><br><span class="line">                      <span class="comment">---peer0.org1</span></span><br><span class="line"></span><br><span class="line">                           <span class="comment">---msp</span></span><br><span class="line"></span><br><span class="line">                           <span class="comment">--- tls</span></span><br><span class="line"></span><br><span class="line">                             <span class="comment">--- peer1.org1</span></span><br><span class="line"></span><br><span class="line">                           <span class="comment">---msp</span></span><br><span class="line"></span><br><span class="line">                           <span class="comment">--- tls</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">--- org2</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">--- msp</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">---  ca</span></span><br><span class="line"></span><br><span class="line">                  <span class="comment">--- tlsca</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">--- users</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">--- peers</span></span><br><span class="line"></span><br><span class="line">                     <span class="comment">---peer0.org2</span></span><br><span class="line"></span><br><span class="line">                          <span class="comment">--- msp</span></span><br><span class="line"></span><br><span class="line">                          <span class="comment">--- tls</span></span><br><span class="line"></span><br><span class="line">                            <span class="comment">--- peer1.org2</span></span><br><span class="line"></span><br><span class="line">                          <span class="comment">--- msp</span></span><br><span class="line"></span><br><span class="line">                          <span class="comment">--- tls</span></span><br></pre></td></tr></table></figure></p>
<p>可以看出，每个 org 都包含了 msp、 ca、 tlsca 和 users 目录，然后根据 org 类型的不同，还分别有 peers 和 orderers 目录，里面存放着 org 中每个成员的 msp 和 tls 文件。</p>
<h3 id="b-configtx-yaml"><a href="#b-configtx-yaml" class="headerlink" title="b.  configtx.yaml"></a><strong>b.  configtx.yaml</strong></h3><p>configtxgen 工具根据该文件生成 Orderer 初始化的时候要使用的 genesis.block，获知 organization 的各种信息，因此，用户要根据 cluster-config.yaml 中关于 organization 的定义来修改 configtx.yaml 以生成合适的 genesis.block 。例如，用户在 cluster-config.yaml 中增加了一个 Org3 ，并且要创建一个包含 Org1， Org2， Org3 的集群，则应该通过以下两步修改 configtx.yaml ：           </p>
<p>(1). 在 profile 中增加 Org3 ，如图3-1。</p>
<div style="text-align:center;"><img src="/img/blockchain/1r8ujk4ofv.png" alt="img"><br>图 3- 1</div>

<p>(2). 在 Organization 中增加 Org3 的 MSPDir ，如图3-2:</p>
<div style="text-align:center;"><img src="/img/blockchain/u1tnyjyl6j.png" alt="img"><br>图 3-2</div>

<p>注意的是每个 organization 中的 MSPDir 的值必须是这种形式：<br><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="xml">crypto-config/</span><span class="template-variable">&#123;OrgType&#125;</span><span class="xml">/</span><span class="template-variable">&#123;OrgName&#125;</span><span class="xml">/mps</span></span><br></pre></td></tr></table></figure></p>
<h2 id="3-3-模板文件"><a href="#3-3-模板文件" class="headerlink" title="3.3 模板文件"></a><strong>3.3 模板文件</strong></h2><p>在 Kubernetes 中部署 Fabric 时，需要为每个节点编写相应的配置文件。由于节点数可能很多，这是既复杂又易错的重复劳动。为提高效率，可通过模板自动生成配置文件。本文使用了5个模板文件，可用脚本替换其中的变量，均在笔者给出示例代码中的 templates 目录中，这些模板的作用如下：</p>
<h3 id="a-fabric-1-0-tmeplate-namespace-yaml"><a href="#a-fabric-1-0-tmeplate-namespace-yaml" class="headerlink" title="a. fabric_1_0_tmeplate_namespace.yaml"></a><strong>a. fabric_1_0_tmeplate_namespace.yaml</strong></h3><p>定义Fabric集群在 K8s 中的 namespace ，它对应着 organization 的域名。为了在多节点共享证书等文件，使用了 NFS 服务器作为存储。在 K8s 中通过相应的 PV 和 PVC ，namespace 下的 Pod 可以通过 PVC 来获取与之相应的文件。</p>
<h3 id="b-fabric-1-0-template-cli-yaml"><a href="#b-fabric-1-0-template-cli-yaml" class="headerlink" title="b. fabric_1_0_template_cli.yaml"></a><strong>b. fabric_1_0_template_cli.yaml</strong></h3><p>CLI pod 模板，每个 organization 中都配备了一个 CLI pod，目的是提供命令行界面，可统一管理组织内的所有 peer ，其中包括 channel 的创建， chaincode 的安装等。CLI Pod 的 CORE_PEER_ADDRESS 环境变量默认值为 org 中的第一个 peer，可以通过修改该环境变量来连接不同的 peer 。</p>
<p>yaml 文件中的 command 是为了防止 CLI pod 自动退出，CLI 的默认工作目录为/opt/gopath/src/github.com/hyperledger/fabric/peer 。由于该目录下的 channel-artifacts 挂载了 NFS 上 /opt/share/channel-artifacts，因此把创建 channel 时返回的 xxx.block 文件放在该目录下供所有 CLI Pod共享。</p>
<h3 id="c-fabric-1-0-template-ca-yaml"><a href="#c-fabric-1-0-template-ca-yaml" class="headerlink" title="c. fabric_1_0_template_ca.yaml"></a><strong>c. fabric_1_0_template_ca.yaml</strong></h3><p>Fabric 的 CA 服务的 pod 定义模板，用于 organization 中的证书管理，其 yaml 文件除了定义 deployment 外，还定义了 service 。service 通过 selector 与 deployment 绑定，其中 deployment 中的 label 是 selector 与其绑定的根据。   </p>
<h3 id="d-fabcric-1-0-template-orderer-yaml"><a href="#d-fabcric-1-0-template-orderer-yaml" class="headerlink" title="d. fabcric_1_0_template_orderer.yaml"></a><strong>d. fabcric_1_0_template_orderer.yaml</strong></h3><p>Orderer 的 pod 定义模板，需要注意的是，cryptogen 并不会生成 genesis.block ，然而缺少该文件时，orderer 会启动失败，因此在启动 orderer 之前需要预先生成 genesis.block ，并将其放在相应的 org 目录下。</p>
<h3 id="e-fabric-1-0-template-peer-yaml"><a href="#e-fabric-1-0-template-peer-yaml" class="headerlink" title="e. fabric_1_0_template_peer.yaml"></a><strong>e. fabric_1_0_template_peer.yaml</strong></h3><p>每个 peer pod 的定义模板。在该 yaml 中分别定义了 peer 和 couchDB 两个container 。在实例化 chaincode  (cc) 时，peer 需要连接 Docker 引擎来创建 cc 容器，因此要把 worker 宿主机的 var/run/docker.sock 映射到 peer 容器内部（参见图2-1）。</p>
<h2 id="3-4-源码使用"><a href="#3-4-源码使用" class="headerlink" title="3.4  源码使用"></a><strong>3.4  源码使用</strong></h2><p>以下操作都在图 2-1的 cmd 客户机上进行，NFS 的共享目录为 /opt/share ，该共享目录的 拥有者:用户组 建议设为 nobody:nogroup 。</p>
<h3 id="a．生成启动文件"><a href="#a．生成启动文件" class="headerlink" title="a．生成启动文件"></a><strong>a．生成启动文件</strong></h3><p>步骤：</p>
<p><strong>1）.</strong> 把 NFS 的 /opt/share 目录挂载到 host 的 /opt/share 。</p>
<p><strong>2）.</strong> 下载本文配套源码并进入 Fabric-on-K8S/ 目录，通过以下命令下载 Fabric 的 cryptogen 等工具：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl https:<span class="regexp">//</span>nexus.hyperledger.org<span class="regexp">/content/</span>repositories<span class="regexp">/releases/</span>org<span class="regexp">/hyperledger/</span>fabric<span class="regexp">/hyperledger-fabric/</span>linux-amd64-<span class="number">1.0</span>.<span class="number">0</span><span class="regexp">/hyperledger-fabric-linux-amd64-1.0.0.tar.gz| tar xz</span></span><br></pre></td></tr></table></figure></p>
<p>下载完毕后会在当前目录生成一个 bin 目录，该目录包含 cryptogen 和 configtx 等文件。</p>
<p><strong>3）.</strong> 更改 templates/fabric_1_0_template_pod_cli 的 NFS 地址，如图 3-3所示。</p>
<div style="text-align:center;"><img src="/img/blockchain/1vszrwl465.png" alt="img"><br>图 3- 3</div>

<p><strong>4）.</strong> 更改 templates/fabric_1_0_template_pod_namespace 的 NFS 地址，如图 3-4。</p>
<div style="text-align:center;"><img src="/img/blockchain/8n29dfgc6e.png" alt="img"><br>图 3- 4</div>

<p><strong>5）.</strong>  依照 3.2 的说明配置 cluster-config.yaml 和 configtx.yaml 。</p>
<p><strong>6）.</strong>   通过以下命令生成启动所需要的文件:<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo <span class="keyword">bash </span>generateAll.sh</span><br></pre></td></tr></table></figure></p>
<p>运行 generateAll.sh 脚本时，除了调用 cryptogen 生成 crypto-config 目录之外，还在目录中的各个 organization 子目录下插入相应的 K8S 配置文件。以org1 为例，其目录下会有几个 yaml 文件用于启动：<br><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">crypto-<span class="built_in">config</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">--- peerOrganizations</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">--- org1</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">---org1-ca.yaml</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">---org1-cli.yaml</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">---org1-namespace.yaml</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">---msp</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">--- ca</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">--- tlsca</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">--- users</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">--- peers</span></span><br><span class="line"></span><br><span class="line">                              <span class="comment">---peer0.org1</span></span><br><span class="line"></span><br><span class="line">                                   <span class="comment">---peer0.org1.yaml</span></span><br><span class="line"></span><br><span class="line">                                   <span class="comment">---msp</span></span><br><span class="line"></span><br><span class="line">                                   <span class="comment">--- tls</span></span><br><span class="line"></span><br><span class="line">                              <span class="comment">---peer1.org1</span></span><br><span class="line"></span><br><span class="line">                                   <span class="comment">---peer1.org1.yaml</span></span><br><span class="line"></span><br><span class="line">                                   <span class="comment">---msp</span></span><br><span class="line"></span><br><span class="line">                                   <span class="comment">--- tls</span></span><br></pre></td></tr></table></figure></p>
<h3 id="b-运行启动脚本"><a href="#b-运行启动脚本" class="headerlink" title="b.   运行启动脚本"></a><strong>b.   运行启动脚本</strong></h3><p>  通过以下命令启动Fabric集群(需要安装PyYAML-3.5):<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python3.<span class="number">5</span> transform/<span class="keyword">run</span>.<span class="bash">py</span></span><br></pre></td></tr></table></figure></p>
<p> 对每个Fabric的 PeerOrganization ，启动脚本的工作流程如下：</p>
<p>·      在 Kubernetes 中创建org的 namespace；</p>
<p>·      创建 org 的 ca pod ；</p>
<p>·      创建 org 的 CLI pod ；</p>
<p>·      遍历 orgM/peers 的子目录找出相应的 yaml 文件，并启动所有 peer 。</p>
<h3 id="c-查看-cluster-状态"><a href="#c-查看-cluster-状态" class="headerlink" title="c.   查看 cluster 状态"></a>c.   查看 cluster 状态</h3><p>创建完成后，查看各个 pod 的状态，若都显示为 running 则说明所有部件工作正常，命令如下，结果如图3-5：<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span> kubectl get pods–<span class="keyword">all</span>-namespaces</span><br></pre></td></tr></table></figure></p>
<div style="text-align:center;"><img src="/img/blockchain/62lj5vaozj.png" alt="img"><br>图 3- 5</div>

<h1 id="4-测试Fabric集群"><a href="#4-测试Fabric集群" class="headerlink" title="4. 测试Fabric集群"></a><strong>4. 测试Fabric集群</strong></h1><p>假设已经成功启动 <strong>3.2.a</strong> 中定义的 Fabric 集群，下面通过运行测试 chaincode 来判断 Fabric 集群是否如预期般工作。</p>
<p>首先创建和加入 channel，使用 configtx 工具来生成与 channel 相关的文件：</p>
<p><strong>[1]</strong>  进入 CMD 客户机的 Fabric-on-K8S/setupCluster/ 目录:<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cd Fabric-<span class="keyword">on</span>-K8S/setupCluster/</span><br></pre></td></tr></table></figure></p>
<p><strong>[2]</strong>  创建 channel 的 channel.tx 文件，该 channel 的 ID 为 mychannel :<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ../bin/configtxgen -profileTwoOrgsChannel <span class="string">\</span></span><br><span class="line"></span><br><span class="line">-outputCreateChannelTx <span class="string">\</span></span><br><span class="line"></span><br><span class="line">./channel-artifacts/channel.tx <span class="string">\</span></span><br><span class="line"></span><br><span class="line">-channelID mychannel</span><br></pre></td></tr></table></figure></p>
<p><strong>[3]</strong>  创建 channel 的升级文件，该文件用于更新 mychannel 中 Org1 的 anchor peer :<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ..<span class="regexp">/bin/</span>configtxgen  -profile TwoOrgsChannel</span><br><span class="line"></span><br><span class="line">-outputAnchorPeersUpdate\</span><br><span class="line"></span><br><span class="line">.<span class="regexp">/channel-artifacts/</span>Org1MSPanchors.tx \</span><br><span class="line"></span><br><span class="line">-channelID mychannel -asOrg Org1MSP</span><br></pre></td></tr></table></figure></p>
<p><strong>[4]</strong>  创建 channel 的升级文件，该文件用于更新 mychannel 中 Org2 的 anchor peer:<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ../bin/configtxgen  -profile TwoOrgsChannel <span class="string">\</span></span><br><span class="line"></span><br><span class="line">-outputAnchorPeersUpdate<span class="string">\</span></span><br><span class="line"></span><br><span class="line">./channel-artifacts/Org2MSPanchors.tx<span class="string">\</span></span><br><span class="line"></span><br><span class="line">-channelID mychannel -asOrg Org2MSP</span><br></pre></td></tr></table></figure></p>
<p><strong>[5]</strong>  由于每个 Org 的 CLI Pod 需要用到以上步骤创建的文件，可以通过 NFS 来跟 CLI Pod 共享这些文件:<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo <span class="meta">cp</span> -r ./channel-artifacts /<span class="meta">opt</span>/share/</span><br></pre></td></tr></table></figure></p>
<p>完成以上工作后，就可以通过各组织的 CLI Pod 来测试集群是否正常运行。</p>
<p>通过以下操作进入任意 org 的 CLI Pod 内部，以 org1 为例：</p>
<p><strong>1）.</strong> 查看 namespace 为 org1下的所有 Pod ：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="builtin-name">get</span> pods –namespaces org1</span><br></pre></td></tr></table></figure></p>
<div style="text-align:center;"><img src="/img/blockchain/k6r6ptfzqd.png" alt="img"><br>图 4- 1</div>

<p>如图 4-1所示 org1 的 CLI Pod 为 cli-2586364563-vclmr。</p>
<p><strong>2）.</strong>    进入 cli-2586364563-vclmr Pod：<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl exec -<span class="keyword">it</span> cli<span class="number">-2586364563</span>-vclmr bash <span class="comment">--namespace=org1</span></span><br></pre></td></tr></table></figure></p>
<p>进入 CLI Pod 后，可以执行以下命令以测试 Fabric 集群：</p>
<p><strong>a.</strong>   创建channel<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$<span class="built_in"> peer </span>channel create -o orderer0.orgorderer1:7050 \</span><br><span class="line"></span><br><span class="line">-c mychannel -f./channel-artifacts/channel.tx</span><br></pre></td></tr></table></figure></p>
<p><strong>b.</strong>   拷贝 mychannel.block 到 channel-artifacts 目录：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cp mychannel<span class="selector-class">.block</span>./channel-artifacts</span><br></pre></td></tr></table></figure></p>
<p><strong>c.</strong>   加入 mychannel<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$<span class="built_in"> peer </span>channel join -b./channel-artifacts/mychannel.block</span><br></pre></td></tr></table></figure></p>
<p><strong>d.</strong>   更新 anchor peer，每个 org 只需执行一次<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$<span class="built_in"> peer </span>channel update -o orderer0.orgorderer1:7050 \</span><br><span class="line"></span><br><span class="line">-c mychannel -f./channel-artifacts/Org1MSPanchors.tx</span><br></pre></td></tr></table></figure></p>
<p><strong>e.</strong>   安装chaincode</p>
<p>请读者下载 Fabric 的 chaincode_example02 目录并将其放置在 CMD 客户机的 /opt/share/channel-artifacts 目录下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$<span class="built_in"> peer </span>chaincode install -n mycc -v 1.0 \</span><br><span class="line"></span><br><span class="line">-p github.com/hyperledger/fabric/peer/channel-artifacts/chaincode_example02</span><br></pre></td></tr></table></figure></p>
<p><strong>f.</strong> 实例化 chaincode<br><figure class="highlight scilab"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ peer chaincode instantiate -o orderer0.orgorderer1:<span class="number">7050</span> \</span><br><span class="line"></span><br><span class="line">-C mychannel -n mycc -v1.<span class="number">0</span> -c <span class="string">'&#123;"</span>Args<span class="string">":["</span>init<span class="string">","</span>a<span class="string">","</span><span class="number">100</span><span class="string">","</span>b<span class="string">","</span><span class="number">200</span><span class="string">"]&#125;'</span>\</span><br><span class="line"></span><br><span class="line">-P <span class="string">"OR    ('</span>Org1MSP.member',<span class="string">'Org2MSP.member'</span>)<span class="string">"</span></span><br></pre></td></tr></table></figure></p>
<p>通过以上命令实例化 mycc 后，读者可以自行切换到其他 org 的 CLI Pod 上通过加入 channel 等步骤，验证账本是否同步。</p>
<h2 id="4-1-外部调用"><a href="#4-1-外部调用" class="headerlink" title="4.1 外部调用"></a><strong>4.1 外部调用</strong></h2><p>在配置文件中 ca、peer 和 orderer 的 service 类型定义为 NodePort，这样做的目的是为了让用户在 K8S 外也能访问到Fabric中的各个成员，端口映射规则如下 (以下出现 N 和 M 的范围分别为 N&gt;=1, M&gt;=0 ):</p>
<p><strong>1）.</strong>   orgN 端口范围是 <strong>30000+(N-1)*100 ~ 30000+(N)*100-1</strong>，也就是说每一个 org 最多能分配到 100 个端口号，如 org1 的端口范围是 30000 到 30099。</p>
<p><strong>2）.</strong>   CA 的 7054 的映射关系如下：</p>
<p><strong>ca.orgN:7054 -&gt;  worker:30000+(N-1)*100</strong></p>
<p><strong>3）.</strong>   由于每个peer需要映射7051和7052两个端口，因此org中peerM的端口映射关系如下:</p>
<p><strong>peerM.orgN:7051 -&gt;worker:30000+(N-1)*100 + 2 * M + 1</strong></p>
<p><strong>peerM.orgN:7052 -&gt;worker:30000+(N-1)*100 + 2 * M + 2</strong></p>
<p><strong>4）.</strong>   ordererN 的映射关系为：</p>
<p><strong>ordererN:7050 -&gt; worker:23700+N</strong></p>
<p>若 worker1 的IP地址为 192.168.0.7，它运行 peer0.org1 ，则 Kubernetes 外的用户需要通过 192.168.0.7:30001 地址才能访问 peer0.org1 。</p>
<h2 id="4-2-删除集群"><a href="#4-2-删除集群" class="headerlink" title="4.2 删除集群"></a><strong>4.2 删除集群</strong></h2><p>当需要删除集群的时候，可以通过 transform 目录下的 delete.py 脚本来清理环境，该脚本会遍历 crypto-config 目录，找出所有的 yaml 文件，并通过 <strong>kuberclt delete -f xxx.yaml</strong> 的方式将资源逐个删除。</p>
<h1 id="5-小结"><a href="#5-小结" class="headerlink" title="5. 小结"></a><strong>5. 小结</strong></h1><p>本文阐述了 Kubernetes 与 Fabric 结合的重要性，并给出 Fabric 与 Kubernetes 结合的思路与框架，然后结合脚本工具来解析快捷部署的实现方式，最后是测试部署的集群是否正常工作。本文介绍的部署方法，是基于 Kubernetes 容器云平台实现 BaaS 的基础步骤。在此之上，可以增加更多的区块链层管理功能，图形化运维界面，使得开发人员投入更多的精力到应用的业务逻辑上。</p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2019/11/100623.html" class="pre-post btn btn-default" title='在Kubernetes 上部署 Hyperledger Fabric v1.4'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">在Kubernetes 上部署 Hyperledger Fabric v1.4</span>
        </a>
    
    
        <a href="/archives/2019/11/100621.html" class="next-post btn btn-default" title='区块链的阶段和分类'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">区块链的阶段和分类</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-概述"><span class="toc-text">1. 概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-整体架构"><span class="toc-text">2. 整体架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-基础设施"><span class="toc-text">2.1 基础设施</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-网络部分"><span class="toc-text">1)   网络部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-共享存储"><span class="toc-text">2)  共享存储</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-组件划分"><span class="toc-text">2.2  组件划分</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-Pod之间的通信"><span class="toc-text">2.3  Pod之间的通信</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-源码的说明与使用"><span class="toc-text">3. 源码的说明与使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-环境准备"><span class="toc-text">3.1 环境准备</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-配置文件说明"><span class="toc-text">3.2 配置文件说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#a-cluster-config-yaml"><span class="toc-text">a.   cluster-config.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b-configtx-yaml"><span class="toc-text">b.  configtx.yaml</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-模板文件"><span class="toc-text">3.3 模板文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#a-fabric-1-0-tmeplate-namespace-yaml"><span class="toc-text">a. fabric_1_0_tmeplate_namespace.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b-fabric-1-0-template-cli-yaml"><span class="toc-text">b. fabric_1_0_template_cli.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c-fabric-1-0-template-ca-yaml"><span class="toc-text">c. fabric_1_0_template_ca.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#d-fabcric-1-0-template-orderer-yaml"><span class="toc-text">d. fabcric_1_0_template_orderer.yaml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#e-fabric-1-0-template-peer-yaml"><span class="toc-text">e. fabric_1_0_template_peer.yaml</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-源码使用"><span class="toc-text">3.4  源码使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#a．生成启动文件"><span class="toc-text">a．生成启动文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#b-运行启动脚本"><span class="toc-text">b.   运行启动脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c-查看-cluster-状态"><span class="toc-text">c.   查看 cluster 状态</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-测试Fabric集群"><span class="toc-text">4. 测试Fabric集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-外部调用"><span class="toc-text">4.1 外部调用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-删除集群"><span class="toc-text">4.2 删除集群</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-小结"><span class="toc-text">5. 小结</span></a></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2023&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>