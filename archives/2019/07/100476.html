<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="hadoop,flink" />


    <meta name="description" content="1. 概要如下图所示，Flink 提供了丰富的客户端操作来提交任务和与任务进行交互，包括 Flink 命令行，Scala Shell，SQL Client，Restful API 和 Web。F..." />



<meta name="robots" content="all" />
<meta name="google" content="all" />
<meta name="googlebot" content="all" />
<meta name="verify" content="all" />

    <!--Title-->


<title>Flink客户端操作的五种模式 | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    




<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7.css">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0.css">
<link rel="stylesheet" href="/css/style.css?rev=@@hash.css">





    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx" />


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

<meta name="generator" content="Hexo 7.3.0"></head>


<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="Flink客户端操作的五种模式">
            
	            Flink客户端操作的五种模式
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/cloud/">云计算</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-none-link" href="/tags/flink/" rel="tag">flink</a> <a class="tag-none-link" href="/tags/hadoop/" rel="tag">hadoop</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2019/07/22</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>2065</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <h2 id="1-概要"><a href="#1-概要" class="headerlink" title="1. 概要"></a>1. 概要</h2><p>如下图所示，Flink 提供了丰富的客户端操作来提交任务和与任务进行交互，包括 Flink 命令行，Scala Shell，SQL Client，Restful API 和 Web。Flink 首先提供的最重要的是命令行，其次是 SQL Client 用于提交 SQL 任务的运行，还有就是 Scala Shell 提交 Table API 的任务。同时，Flink 也提供了 Restful 服务，用户可以通过 http 方式进行调用。此外，还有 Web 的方式可以提交任务。</p>
<p><img src="/img/flink/6d7793bdb5bf5fed6cb42c94fdb741e0.png" alt="img"></p>
<p>在 Flink 安装目录的 bin 目录下面可以看到有 flink, start-scala-shell.sh 和 sql-client.sh等文件，这些都是客户端操作的入口。</p>
<p><img src="/img/flink/ee76eb81c48aac53492be861e3aed616.jpg" alt="img"></p>
<h2 id="2-Flink-客户端操作"><a href="#2-Flink-客户端操作" class="headerlink" title="2.Flink 客户端操作"></a>2.Flink 客户端操作</h2><h3 id="2-1-Flink-命令行"><a href="#2-1-Flink-命令行" class="headerlink" title="2.1 Flink 命令行"></a>2.1 Flink 命令行</h3><p>Flink 的命令行参数很多，输入 flink - h 能看到完整的说明：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  flink-1.7.2 bin/flink -h</span><br></pre></td></tr></table></figure>

<p>如果想看某一个命令的参数，比如 Run 命令，输入：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  flink-1.7.2 bin/flink <span class="built_in">run</span> -h</span><br></pre></td></tr></table></figure>

<p>本文主要讲解常见的一些操作，更详细的文档请参考: <a href="100470.html">Flink 命令行文档</a>。</p>
<h4 id="2-1-1-Standalone"><a href="#2-1-1-Standalone" class="headerlink" title="2.1.1 Standalone"></a>2.1.1 Standalone</h4><p>首先启动一个 Standalone 的集群：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  flink<span class="number">-1.7</span><span class="number">.2</span> bin/<span class="keyword">start</span>-<span class="keyword">cluster</span>.sh</span><br><span class="line">Starting <span class="keyword">cluster</span>.</span><br><span class="line">Starting standalonesession daemon <span class="keyword">on</span> host zkb-MBP.<span class="keyword">local</span>.</span><br><span class="line">Starting taskexecutor daemon <span class="keyword">on</span> host zkb-MBP.<span class="keyword">local</span>.</span><br></pre></td></tr></table></figure>

<p>打开 <a href="http://127.0.0.1:8081/">http://127.0.0.1:8081</a> 能看到 Web 界面。</p>
<h5 id="Run"><a href="#Run" class="headerlink" title="Run"></a>Run</h5><p>运行任务，以 Flink 自带的例子 TopSpeedWindowing 为例：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  flink-<span class="number">1</span><span class="variable">.7</span><span class="variable">.2</span> bin/flink run -d examples/streaming/TopSpeedWindowing<span class="variable">.jar</span></span><br><span class="line">Starting execution of <span class="keyword">program</span></span><br><span class="line">Executing TopSpeedWindowing example <span class="keyword">with</span> <span class="keyword">default</span> <span class="keyword">input</span> data set.</span><br><span class="line">Use --<span class="keyword">input</span> to <span class="keyword">specify</span> file <span class="keyword">input</span>.</span><br><span class="line">Printing result to stdout. Use --<span class="keyword">output</span> to <span class="keyword">specify</span> <span class="keyword">output</span> path.</span><br><span class="line">Job has been submitted <span class="keyword">with</span> JobID <span class="number">5</span>e20cb6b0f357591171dfcca2eea09de</span><br></pre></td></tr></table></figure>

<p>运行起来后默认是 1 个并发:</p>
<p><img src="/img/flink/ddc31da4c3dbfaaf8f9b7bffff33457f.jpg" alt="img"></p>
<p>点左侧「Task Manager」，然后点「Stdout」能看到输出日志：</p>
<p><img src="/img/flink/fa1848e759a53993f51420dd258c392c.jpg" alt="img"></p>
<p>或者查看本地 Log 目录下的 *.out 文件：</p>
<p><img src="/img/flink/80724cf24ba481ea16120c39d572f61d.jpg" alt="img"></p>
<h5 id="List"><a href="#List" class="headerlink" title="List"></a>List</h5><p>查看任务列表：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  flink-1.7.2 bin/flink list -m 127.0.0.1:8081</span><br><span class="line">Waiting for response...</span><br><span class="line"><span class="bullet">------------------ </span>Running/Restarting Jobs -------------------</span><br><span class="line"><span class="section">24.03.2019 10:14:06 : 5e20cb6b0f357591171dfcca2eea09de : CarTopSpeedWindowingExample (RUNNING)</span></span><br><span class="line"><span class="section">--------------------------------------------------------------</span></span><br><span class="line">No scheduled jobs.</span><br></pre></td></tr></table></figure>

<h5 id="Stop"><a href="#Stop" class="headerlink" title="Stop"></a>Stop</h5><p>停止任务。通过 -m 来指定要停止的 JobManager 的主机地址和端口。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">➜  flink-<span class="number">1.7</span>.<span class="number">2</span> bin/flink <span class="selector-tag">stop</span> -m <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8081</span> d67420e52bd051fae2fddbaa79e046bb</span><br><span class="line">Stopping job d67420e52bd051fae2fddbaa79e046bb.</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">The program finished with the following exception:</span><br><span class="line">  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.util</span><span class="selector-class">.FlinkException</span>: Could not <span class="selector-tag">stop</span> the job   d67420e52bd051fae2fddbaa79e046bb.</span><br><span class="line">  at org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.client</span><span class="selector-class">.cli</span><span class="selector-class">.CliFrontend</span>.lambda<span class="variable">$stop</span>$<span class="number">5</span>(CliFrontend<span class="selector-class">.java</span>:<span class="number">554</span>)</span><br><span class="line">  at org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.client</span><span class="selector-class">.cli</span><span class="selector-class">.CliFrontend</span><span class="selector-class">.runClusterAction</span>(CliFrontend<span class="selector-class">.java</span>:<span class="number">985</span>)</span><br><span class="line">  at org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.client</span><span class="selector-class">.cli</span><span class="selector-class">.CliFrontend</span><span class="selector-class">.stop</span>(CliFrontend<span class="selector-class">.java</span>:<span class="number">547</span>)</span><br><span class="line">  at org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.client</span><span class="selector-class">.cli</span><span class="selector-class">.CliFrontend</span><span class="selector-class">.parseParameters</span>(CliFrontend<span class="selector-class">.java</span>:<span class="number">1062</span>)</span><br><span class="line">  at org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.client</span><span class="selector-class">.cli</span><span class="selector-class">.CliFrontend</span>.lambda<span class="variable">$main</span>$<span class="number">11</span>(CliFrontend<span class="selector-class">.java</span>:<span class="number">1126</span>)</span><br><span class="line">  at java<span class="selector-class">.security</span><span class="selector-class">.AccessController</span><span class="selector-class">.doPrivileged</span>(Native Method)</span><br><span class="line">  at javax<span class="selector-class">.security</span><span class="selector-class">.auth</span><span class="selector-class">.Subject</span><span class="selector-class">.doAs</span>(Subject<span class="selector-class">.java</span>:<span class="number">422</span>)</span><br><span class="line">  at org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.security</span><span class="selector-class">.UserGroupInformation</span><span class="selector-class">.doAs</span>(UserGroupInformation<span class="selector-class">.java</span>:<span class="number">1836</span>)</span><br><span class="line">  at org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.runtime</span><span class="selector-class">.security</span><span class="selector-class">.HadoopSecurityContext</span><span class="selector-class">.runSecured</span>(HadoopSecurityContext<span class="selector-class">.java</span>:<span class="number">41</span>)</span><br><span class="line">  at org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.client</span><span class="selector-class">.cli</span><span class="selector-class">.CliFrontend</span><span class="selector-class">.main</span>(CliFrontend<span class="selector-class">.java</span>:<span class="number">1126</span>)</span><br><span class="line">Caused by: java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ExecutionException</span>: org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.runtime</span><span class="selector-class">.rest</span><span class="selector-class">.util</span><span class="selector-class">.RestClientException</span>: <span class="selector-attr">[Job termination (STOP) failed: This job is not stoppable.]</span></span><br><span class="line">  at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.CompletableFuture</span><span class="selector-class">.reportGet</span>(CompletableFuture<span class="selector-class">.java</span>:<span class="number">357</span>)</span><br><span class="line">  at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.CompletableFuture</span><span class="selector-class">.get</span>(CompletableFuture<span class="selector-class">.java</span>:<span class="number">1915</span>)</span><br><span class="line">  at org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.client</span><span class="selector-class">.program</span><span class="selector-class">.rest</span><span class="selector-class">.RestClusterClient</span><span class="selector-class">.stop</span>(RestClusterClient<span class="selector-class">.java</span>:<span class="number">392</span>)</span><br><span class="line">  at org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.client</span><span class="selector-class">.cli</span><span class="selector-class">.CliFrontend</span>.lambda<span class="variable">$stop</span>$<span class="number">5</span>(CliFrontend<span class="selector-class">.java</span>:<span class="number">552</span>)</span><br><span class="line">... <span class="number">9</span> more</span><br><span class="line">Caused by: org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.runtime</span><span class="selector-class">.rest</span><span class="selector-class">.util</span><span class="selector-class">.RestClientException</span>: <span class="selector-attr">[Job termination (STOP) failed: This job is not stoppable.]</span></span><br><span class="line">  at org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.runtime</span><span class="selector-class">.rest</span><span class="selector-class">.RestClient</span><span class="selector-class">.parseResponse</span>(RestClient<span class="selector-class">.java</span>:<span class="number">380</span>)</span><br><span class="line">  at org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.runtime</span><span class="selector-class">.rest</span><span class="selector-class">.RestClient</span>.lambda<span class="variable">$submitRequest</span>$<span class="number">3</span>(RestClient<span class="selector-class">.java</span>:<span class="number">364</span>)</span><br><span class="line">  at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.CompletableFuture</span><span class="selector-class">.uniCompose</span>(CompletableFuture<span class="selector-class">.java</span>:<span class="number">952</span>)</span><br><span class="line">  at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.CompletableFuture<span class="variable">$UniCompose</span><span class="selector-class">.tryFire</span>(CompletableFuture<span class="selector-class">.java</span>:<span class="number">926</span>)</span><br><span class="line">  at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.CompletableFuture<span class="variable">$Completion</span><span class="selector-class">.run</span>(CompletableFuture<span class="selector-class">.java</span>:<span class="number">442</span>)</span><br><span class="line">  at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span><span class="selector-class">.ThreadPoolExecutor</span><span class="selector-class">.runWorker</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">1149</span>)</span><br><span class="line">  at java<span class="selector-class">.util</span><span class="selector-class">.concurrent</span>.ThreadPoolExecutor<span class="variable">$Worker</span><span class="selector-class">.run</span>(ThreadPoolExecutor<span class="selector-class">.java</span>:<span class="number">624</span>)</span><br><span class="line">  at java<span class="selector-class">.lang</span><span class="selector-class">.Thread</span><span class="selector-class">.run</span>(Thread<span class="selector-class">.java</span>:<span class="number">748</span>)</span><br></pre></td></tr></table></figure>

<p>从日志里面能看出 Stop 命令执行失败了。一个 Job 能够被 Stop 要求所有的 Source 都是可以 Stoppable 的，即实现了 StoppableFunction 接口。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 需要能 stoppable 的函数必须实现这个接口，例如流式任务的 source。</span></span><br><span class="line"><span class="comment"> * stop() 方法在任务收到 STOP 信号的时候调用。</span></span><br><span class="line"><span class="comment"> * source 在接收到这个信号后，必须停止发送新的数据且优雅的停止。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">@PublicEvolving</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">StoppableFunction</span> &#123;</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	  * 停止 source。与 cancel() 不同的是，这是一个让 source 优雅停止的请求。</span></span><br><span class="line"><span class="comment">     * 等待中的数据可以继续发送出去，不需要立即停止。</span></span><br><span class="line"><span class="comment">	  */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">stop</span>()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Cancel"><a href="#Cancel" class="headerlink" title="Cancel"></a>Cancel</h5><p>取消任务。如果在 conf&#x2F;flink-conf.yaml 里面配置了 state.savepoints.dir，会保存 Savepoint，否则不会保存 Savepoint。</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  flink<span class="number">-1</span>.<span class="number">7</span>.<span class="number">2</span> <span class="keyword">bin/flink </span>cancel -m <span class="number">127</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>:<span class="number">8081</span> <span class="number">5</span>e20cb<span class="symbol">6b</span><span class="symbol">0f</span>357591171dfcca2eea09de</span><br><span class="line"> </span><br><span class="line">Cancelling <span class="keyword">job </span><span class="number">5</span>e20cb<span class="symbol">6b</span><span class="symbol">0f</span>357591171dfcca2eea09de.</span><br><span class="line">Cancelled <span class="keyword">job </span><span class="number">5</span>e20cb<span class="symbol">6b</span><span class="symbol">0f</span>357591171dfcca2eea09de.</span><br></pre></td></tr></table></figure>

<p>也可以在停止的时候显示指定 Savepoint 目录。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  flink<span class="number">-1.7</span><span class="number">.2</span> bin/flink cancel -m <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8081</span> -s /tmp/<span class="keyword">savepoint</span> <span class="number">29</span>da945b99dea6547c3fbafd57ed8759</span><br><span class="line"> </span><br><span class="line">Cancelling job <span class="number">29</span>da945b99dea6547c3fbafd57ed8759 <span class="keyword">with</span> <span class="keyword">savepoint</span> <span class="keyword">to</span> /tmp/<span class="keyword">savepoint</span>.</span><br><span class="line">Cancelled job <span class="number">29</span>da945b99dea6547c3fbafd57ed8759. <span class="keyword">Savepoint</span> stored <span class="keyword">in</span> file:/tmp/<span class="keyword">savepoint</span>/<span class="keyword">savepoint</span><span class="number">-29</span>da94<span class="number">-88299</span>bacafb7.</span><br><span class="line"> </span><br><span class="line">➜  flink<span class="number">-1.7</span><span class="number">.2</span> ll /tmp/<span class="keyword">savepoint</span>/<span class="keyword">savepoint</span><span class="number">-29</span>da94<span class="number">-88299</span>bacafb7</span><br><span class="line">total <span class="number">32</span>K</span><br><span class="line">-rw-r<span class="comment">--r-- 1 baoniu 29K Mar 24 10:33 _metadata</span></span><br></pre></td></tr></table></figure>

<p>取消和停止（流作业）的区别如下：</p>
<ul>
<li>cancel() 调用，立即调用作业算子的 cancel() 方法，以尽快取消它们。如果算子在接到 cancel() 调用后没有停止，Flink 将开始定期中断算子线程的执行，直到所有算子停止为止。</li>
<li>stop() 调用，是更优雅的停止正在运行流作业的方式。stop() 仅适用于 Source 实现了 StoppableFunction 接口的作业。当用户请求停止作业时，作业的所有 Source 都将接收 stop() 方法调用。直到所有 Source 正常关闭时，作业才会正常结束。这种方式，使作业正常处理完所有作业。</li>
</ul>
<h5 id="Savepoint"><a href="#Savepoint" class="headerlink" title="Savepoint"></a>Savepoint</h5><p>触发 Savepoint。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  flink<span class="number">-1.7</span><span class="number">.2</span> bin<span class="operator">/</span>flink <span class="keyword">savepoint</span> <span class="operator">-</span>m <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8081</span> ec53edcfaeb96b2a5dadbfbe5ff62bbb <span class="operator">/</span>tmp<span class="operator">/</span><span class="keyword">savepoint</span></span><br><span class="line">Triggering <span class="keyword">savepoint</span> <span class="keyword">for</span> job ec53edcfaeb96b2a5dadbfbe5ff62bbb.</span><br><span class="line">Waiting <span class="keyword">for</span> response...</span><br><span class="line"><span class="keyword">Savepoint</span> completed. Path: file:<span class="operator">/</span>tmp<span class="operator">/</span><span class="keyword">savepoint</span><span class="operator">/</span><span class="keyword">savepoint</span><span class="operator">-</span>ec53ed<span class="number">-84</span>b00ce500ee</span><br><span class="line">You can resume your program <span class="keyword">from</span> this <span class="keyword">savepoint</span> <span class="keyword">with</span> the run command.</span><br></pre></td></tr></table></figure>

<p>说明：Savepoint 和 Checkpoint 的区别（<a href="https://www.ververica.com/blog/differences-between-savepoints-and-checkpoints-in-flink">详见文档</a>）：</p>
<ul>
<li>Checkpoint 是增量做的，每次的时间较短，数据量较小，只要在程序里面启用后会自动触发，用户无须感知；Checkpoint 是作业 failover 的时候自动使用，不需要用户指定。</li>
<li>Savepoint 是全量做的，每次的时间较长，数据量较大，需要用户主动去触发。Savepoint 一般用于程序的版本更新（<a href="https://ci.apache.org/projects/flink/flink-docs-stable/ops/upgrading.html#step-1-take-a-savepoint-in-the-old-flink-version">详见文档</a>），Bug 修复，A&#x2F;B Test 等场景，需要用户指定。</li>
</ul>
<p>通过 -s 参数从指定的 Savepoint 启动：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  flink<span class="number">-1.7</span><span class="number">.2</span> bin/flink run -d -s /tmp/<span class="keyword">savepoint</span>/<span class="keyword">savepoint</span>-f049ff<span class="number">-24</span>ec0d3e0dc7 ./examples/streaming/TopSpeedWindowing.jar</span><br><span class="line">Starting execution <span class="keyword">of</span> program</span><br><span class="line">Executing TopSpeedWindowing example <span class="keyword">with</span> <span class="keyword">default</span> <span class="keyword">input</span> data <span class="keyword">set</span>.</span><br><span class="line">Use <span class="comment">--input to specify file input.</span></span><br><span class="line">Printing result <span class="keyword">to stdout</span>. Use <span class="comment">--output to specify output path.</span></span><br></pre></td></tr></table></figure>

<p>查看 JobManager 的日志，能够看到类似这样的 Log：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span><span class="number">-03</span><span class="number">-28</span> <span class="number">10</span>:<span class="number">30</span>:<span class="number">53</span>,<span class="number">957</span> <span class="keyword">INFO</span>  org.apache.flink.runtime.<span class="keyword">checkpoint</span>.CheckpointCoordinator     </span><br><span class="line">- Starting job <span class="number">790</span>d7b98db6f6af55d04aec1d773852d <span class="keyword">from</span> <span class="keyword">savepoint</span> /tmp/<span class="keyword">savepoint</span>/<span class="keyword">savepoint</span>-f049ff<span class="number">-24</span>ec0d3e0dc7 ()</span><br><span class="line"><span class="number">2019</span><span class="number">-03</span><span class="number">-28</span> <span class="number">10</span>:<span class="number">30</span>:<span class="number">53</span>,<span class="number">959</span> <span class="keyword">INFO</span>  org.apache.flink.runtime.<span class="keyword">checkpoint</span>.CheckpointCoordinator    </span><br><span class="line"> - <span class="keyword">Reset</span> the <span class="keyword">checkpoint</span> ID <span class="keyword">of</span> job <span class="number">790</span>d7b98db6f6af55d04aec1d773852d <span class="keyword">to</span> <span class="number">2.</span></span><br><span class="line"><span class="number">2019</span><span class="number">-03</span><span class="number">-28</span> <span class="number">10</span>:<span class="number">30</span>:<span class="number">53</span>,<span class="number">959</span> <span class="keyword">INFO</span>  org.apache.flink.runtime.<span class="keyword">checkpoint</span>.CheckpointCoordinator     </span><br><span class="line">- Restoring job <span class="number">790</span>d7b98db6f6af55d04aec1d773852d <span class="keyword">from</span> latest <span class="keyword">valid</span> <span class="keyword">checkpoint</span>: <span class="keyword">Checkpoint</span> <span class="number">1</span> @ <span class="number">0</span> <span class="keyword">for</span> <span class="number">790</span>d7b98db6f6af55d04aec1d773852d.</span><br></pre></td></tr></table></figure>

<h5 id="Modify"><a href="#Modify" class="headerlink" title="Modify"></a>Modify</h5><p>修改任务并行度。</p>
<p>为了方便演示，我们修改 conf&#x2F;flink-conf.yaml 将 Task Slot 数从默认的 1 改为 4，并配置 Savepoint 目录。（Modify 参数后面接 -s 指定 Savepoint 路径当前版本可能有 Bug，提示无法识别）</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">taskmanager.numberOfTaskSlots: <span class="number">4</span></span><br><span class="line"><span class="keyword">state</span>.savepoints.dir: file:///tmp/savepoint</span><br></pre></td></tr></table></figure>

<p>修改参数后需要重启集群生效，然后再启动任务：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜  flink<span class="number">-1.7</span><span class="number">.2</span> bin/stop-<span class="keyword">cluster</span>.sh &amp;&amp; bin/<span class="keyword">start</span>-<span class="keyword">cluster</span>.sh</span><br><span class="line">Stopping taskexecutor daemon (pid: <span class="number">53139</span>) <span class="keyword">on</span> host zkb-MBP.<span class="keyword">local</span>.</span><br><span class="line">Stopping standalonesession daemon (pid: <span class="number">52723</span>) <span class="keyword">on</span> host zkb-MBP.<span class="keyword">local</span>.</span><br><span class="line">Starting <span class="keyword">cluster</span>.</span><br><span class="line">Starting standalonesession daemon <span class="keyword">on</span> host zkb-MBP.<span class="keyword">local</span>.</span><br><span class="line">Starting taskexecutor daemon <span class="keyword">on</span> host zkb-MBP.<span class="keyword">local</span>.</span><br><span class="line"> </span><br><span class="line">➜  flink<span class="number">-1.7</span><span class="number">.2</span> bin/flink run -d examples/streaming/TopSpeedWindowing.jar</span><br><span class="line">Starting execution <span class="keyword">of</span> program</span><br><span class="line">Executing TopSpeedWindowing example <span class="keyword">with</span> <span class="keyword">default</span> <span class="keyword">input</span> data <span class="keyword">set</span>.</span><br><span class="line">Use <span class="comment">--input to specify file input.</span></span><br><span class="line">Printing result <span class="keyword">to stdout</span>. Use <span class="comment">--output to specify output path.</span></span><br><span class="line">Job has been submitted <span class="keyword">with</span> JobID <span class="number">7752</span>ea7b0e7303c780de9d86a5ded3fa</span><br></pre></td></tr></table></figure>

<p>从页面上能看到 Task Slot 变为了 4，这时候任务的默认并发度是 1。</p>
<p><img src="/img/flink/cac93331b0a762de1c4c888e1f651431.jpg" alt="img"></p>
<p><img src="/img/flink/a4ae14166a06027e18d3ecd0da09ca99.jpg" alt="img"></p>
<p>通过 Modify 命令依次将并发度修改为 4 和 3，可以看到每次 Modify 命令都会触发一次 Savepoint。</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  flink<span class="number">-1.7</span>.<span class="number">2</span> bin/flink modify -p <span class="number">4</span> <span class="number">7752</span>ea<span class="number">7</span>b<span class="number">0e7303</span><span class="keyword">c</span><span class="number">780</span>de<span class="number">9</span>d<span class="number">86</span>a<span class="number">5</span>ded<span class="number">3</span>fa</span><br><span class="line">Modify job <span class="number">7752</span>ea<span class="number">7</span>b<span class="number">0e7303</span><span class="keyword">c</span><span class="number">780</span>de<span class="number">9</span>d<span class="number">86</span>a<span class="number">5</span>ded<span class="number">3</span>fa.</span><br><span class="line">Rescaled job <span class="number">7752</span>ea<span class="number">7</span>b<span class="number">0e7303</span><span class="keyword">c</span><span class="number">780</span>de<span class="number">9</span>d<span class="number">86</span>a<span class="number">5</span>ded<span class="number">3</span>fa. Its new parallelism is <span class="number">4</span>.</span><br><span class="line"> </span><br><span class="line">➜  flink<span class="number">-1.7</span>.<span class="number">2</span> ll /tmp/savepoint</span><br><span class="line">total <span class="number">0</span></span><br><span class="line">drwxr-xr-<span class="keyword">x</span> <span class="number">3</span> baoniu <span class="number">96</span> Jun <span class="number">17</span> <span class="number">09</span>:<span class="number">05</span> savepoint<span class="number">-7752</span>ea<span class="number">-00</span><span class="keyword">c</span><span class="number">05</span>b<span class="number">015836</span>/</span><br><span class="line"> </span><br><span class="line">➜  flink<span class="number">-1.7</span>.<span class="number">2</span> bin/flink modify -p <span class="number">3</span> <span class="number">7752</span>ea<span class="number">7</span>b<span class="number">0e7303</span><span class="keyword">c</span><span class="number">780</span>de<span class="number">9</span>d<span class="number">86</span>a<span class="number">5</span>ded<span class="number">3</span>fa</span><br><span class="line">Modify job <span class="number">7752</span>ea<span class="number">7</span>b<span class="number">0e7303</span><span class="keyword">c</span><span class="number">780</span>de<span class="number">9</span>d<span class="number">86</span>a<span class="number">5</span>ded<span class="number">3</span>fa.</span><br><span class="line">Rescaled job <span class="number">7752</span>ea<span class="number">7</span>b<span class="number">0e7303</span><span class="keyword">c</span><span class="number">780</span>de<span class="number">9</span>d<span class="number">86</span>a<span class="number">5</span>ded<span class="number">3</span>fa. Its new parallelism is <span class="number">3</span>.</span><br><span class="line"> </span><br><span class="line">➜  flink<span class="number">-1.7</span>.<span class="number">2</span> ll /tmp/savepoint</span><br><span class="line">total <span class="number">0</span></span><br><span class="line">drwxr-xr-<span class="keyword">x</span> <span class="number">3</span> baoniu <span class="number">96</span> Jun <span class="number">17</span> <span class="number">09</span>:<span class="number">08</span> savepoint<span class="number">-7752</span>ea<span class="number">-449</span>b<span class="number">131</span>b<span class="number">2</span>bd<span class="number">4</span>/</span><br></pre></td></tr></table></figure>

<p><img src="/img/flink/a4ae14166a06027e18d3ecd0da09ca99.jpg" alt="img"></p>
<p>查看 JobManager 的日志，可以看到：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2019</span><span class="number">-06</span><span class="number">-17</span> <span class="number">09</span>:<span class="number">05</span>:<span class="number">11</span>,<span class="number">179</span> <span class="keyword">INFO</span>  org.apache.flink.runtime.<span class="keyword">checkpoint</span>.CheckpointCoordinator     - Starting job <span class="number">7752</span>ea7b0e7303c780de9d86a5ded3fa <span class="keyword">from</span> <span class="keyword">savepoint</span> file:/tmp/<span class="keyword">savepoint</span>/<span class="keyword">savepoint</span><span class="number">-790</span>d7b<span class="number">-3581698</span>f007e ()</span><br><span class="line"><span class="number">2019</span><span class="number">-06</span><span class="number">-17</span> <span class="number">09</span>:<span class="number">05</span>:<span class="number">11</span>,<span class="number">182</span> <span class="keyword">INFO</span>  org.apache.flink.runtime.<span class="keyword">checkpoint</span>.CheckpointCoordinator     - <span class="keyword">Reset</span> the <span class="keyword">checkpoint</span> ID <span class="keyword">of</span> job <span class="number">7752</span>ea7b0e7303c780de9d86a5ded3fa <span class="keyword">to</span> <span class="number">3.</span></span><br><span class="line"><span class="number">2019</span><span class="number">-06</span><span class="number">-17</span> <span class="number">09</span>:<span class="number">05</span>:<span class="number">11</span>,<span class="number">182</span> <span class="keyword">INFO</span>  org.apache.flink.runtime.<span class="keyword">checkpoint</span>.CheckpointCoordinator     - Restoring job <span class="number">790</span>d7b98db6f6af55d04aec1d773852d <span class="keyword">from</span> latest <span class="keyword">valid</span> <span class="keyword">checkpoint</span>: <span class="keyword">Checkpoint</span> <span class="number">2</span> @ <span class="number">0</span> <span class="keyword">for</span> <span class="number">7752</span>ea7b0e7303c780de9d86a5ded3fa.</span><br><span class="line"><span class="number">2019</span><span class="number">-06</span><span class="number">-17</span> <span class="number">09</span>:<span class="number">05</span>:<span class="number">11</span>,<span class="number">184</span> <span class="keyword">INFO</span>  org.apache.flink.runtime.<span class="keyword">checkpoint</span>.CheckpointCoordinator     - <span class="keyword">No</span> master state <span class="keyword">to</span> restore</span><br><span class="line"><span class="number">2019</span><span class="number">-06</span><span class="number">-17</span> <span class="number">09</span>:<span class="number">05</span>:<span class="number">11</span>,<span class="number">184</span> <span class="keyword">INFO</span>  org.apache.flink.runtime.executiongraph.ExecutionGraph        - Job CarTopSpeedWindowingExample (<span class="number">7752</span>ea7b0e7303c780de9d86a5ded3fa) switched <span class="keyword">from</span> state RUNNING <span class="keyword">to</span> SUSPENDING.</span><br><span class="line">org.apache.flink.util.FlinkException: Job <span class="keyword">is</span> being rescaled.</span><br></pre></td></tr></table></figure>

<h5 id="Info"><a href="#Info" class="headerlink" title="Info"></a>Info</h5><p>Info 命令是用来查看 Flink 任务的执行计划（StreamGraph）的。</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  flink<span class="number">-1.7</span><span class="number">.2</span> bin/flink info examples/streaming/<span class="symbol">TopSpeedWindowing</span>.jar</span><br><span class="line">----------------------- <span class="symbol">Execution</span> <span class="symbol">Plan</span> -----------------------</span><br><span class="line">&#123;<span class="string">&quot;nodes&quot;</span>:[&#123;<span class="string">&quot;id&quot;</span>:<span class="number">1</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;Source: Custom Source&quot;</span>,<span class="string">&quot;pact&quot;</span>:<span class="string">&quot;Data Source&quot;</span>,<span class="string">&quot;contents&quot;</span>:<span class="string">&quot;Source: Custom Source&quot;</span>,<span class="string">&quot;parallelism&quot;</span>:<span class="number">1</span>&#125;,&#123;<span class="string">&quot;id&quot;</span>:<span class="number">2</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;Timestamps/Watermarks&quot;</span>,<span class="string">&quot;pact&quot;</span>:<span class="string">&quot;Operator&quot;</span>,<span class="string">&quot;contents&quot;</span>:<span class="string">&quot;Timestamps/Watermarks&quot;</span>,<span class="string">&quot;parallelism&quot;</span>:<span class="number">1</span>,<span class="string">&quot;predecessors&quot;</span>:[&#123;<span class="string">&quot;id&quot;</span>:<span class="number">1</span>,<span class="string">&quot;ship_strategy&quot;</span>:<span class="string">&quot;FORWARD&quot;</span>,<span class="string">&quot;side&quot;</span>:<span class="string">&quot;second&quot;</span>&#125;]&#125;,&#123;<span class="string">&quot;id&quot;</span>:<span class="number">4</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;Window(GlobalWindows(), DeltaTrigger, TimeEvictor, ComparableAggregator, PassThroughWindowFunction)&quot;</span>,<span class="string">&quot;pact&quot;</span>:<span class="string">&quot;Operator&quot;</span>,<span class="string">&quot;contents&quot;</span>:<span class="string">&quot;Window(GlobalWindows(), DeltaTrigger, TimeEvictor, ComparableAggregator, PassThroughWindowFunction)&quot;</span>,<span class="string">&quot;parallelism&quot;</span>:<span class="number">1</span>,<span class="string">&quot;predecessors&quot;</span>:[&#123;<span class="string">&quot;id&quot;</span>:<span class="number">2</span>,<span class="string">&quot;ship_strategy&quot;</span>:<span class="string">&quot;HASH&quot;</span>,<span class="string">&quot;side&quot;</span>:<span class="string">&quot;second&quot;</span>&#125;]&#125;,&#123;<span class="string">&quot;id&quot;</span>:<span class="number">5</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;Sink: Print to Std. Out&quot;</span>,<span class="string">&quot;pact&quot;</span>:<span class="string">&quot;Data Sink&quot;</span>,<span class="string">&quot;contents&quot;</span>:<span class="string">&quot;Sink: Print to Std. Out&quot;</span>,<span class="string">&quot;parallelism&quot;</span>:<span class="number">1</span>,<span class="string">&quot;predecessors&quot;</span>:[&#123;<span class="string">&quot;id&quot;</span>:<span class="number">4</span>,<span class="string">&quot;ship_strategy&quot;</span>:<span class="string">&quot;FORWARD&quot;</span>,<span class="string">&quot;side&quot;</span>:<span class="string">&quot;second&quot;</span>&#125;]&#125;]&#125;</span><br><span class="line">--------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>拷贝输出的 Json 内容，粘贴到这个网站：<a href="http://flink.apache.org/visualizer/">http://flink.apache.org/visualizer/</a></p>
<p><img src="/img/flink/32c54c30ef5c4cd39cd6a3d9aab14623.jpg" alt="img"></p>
<p>可以和实际运行的物理执行计划对比：</p>
<p><img src="/img/flink/c59fa8c49de331c21b1eaa7ac043a27c.jpg" alt="img"></p>
<h4 id="2-1-2-Yarn-per-job"><a href="#2-1-2-Yarn-per-job" class="headerlink" title="2.1.2 Yarn per-job"></a>2.1.2 Yarn per-job</h4><h5 id="单任务-Attach-模式"><a href="#单任务-Attach-模式" class="headerlink" title="单任务 Attach 模式"></a>单任务 Attach 模式</h5><p>默认是 Attach 模式，即客户端会一直等待直到程序结束才会退出。</p>
<ul>
<li>通过 -m yarn-cluster 指定 Yarn 模式</li>
<li>Yarn 上显示名字为 Flink session cluster，这个 Batch 的 Wordcount 任务运行完会 FINISHED。</li>
<li>客户端能看到结果输出</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[admin@z17.sqa.zth /home/admin/flink/flink-1.7.2]</span></span><br><span class="line"><span class="variable">$echo</span> <span class="variable">$HADOOP_CONF_DIR</span></span><br><span class="line">/etc/hadoop/conf/</span><br><span class="line"> </span><br><span class="line"><span class="selector-attr">[admin@z17.sqa.zth /home/admin/flink/flink-1.7.2]</span></span><br><span class="line">$./bin/flink run -m yarn-cluster ./examples/batch/WordCount<span class="selector-class">.jar</span></span><br><span class="line"> </span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">15</span>:<span class="number">24</span>,<span class="number">511</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.yarn</span><span class="selector-class">.client</span><span class="selector-class">.RMProxy</span>                         - Connecting to ResourceManager at z05c05217<span class="selector-class">.sqa</span><span class="selector-class">.zth</span><span class="selector-class">.tbsite</span>.net/<span class="number">11.163</span>.<span class="number">188.29</span>:<span class="number">8050</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">15</span>:<span class="number">24</span>,<span class="number">690</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.cli</span><span class="selector-class">.FlinkYarnSessionCli</span>                 - No <span class="selector-tag">path</span> <span class="keyword">for</span> the flink jar passed. Using the location of class org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.YarnClusterDescriptor</span> to locate the jar</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">15</span>:<span class="number">24</span>,<span class="number">690</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.cli</span><span class="selector-class">.FlinkYarnSessionCli</span>                 - No <span class="selector-tag">path</span> <span class="keyword">for</span> the flink jar passed. Using the location of class org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.YarnClusterDescriptor</span> to locate the jar</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">15</span>:<span class="number">24</span>,<span class="number">907</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.AbstractYarnClusterDescriptor</span>           - Cluster specification: ClusterSpecification&#123;masterMemoryMB=<span class="number">1024</span>, taskManagerMemoryMB=<span class="number">1024</span>, numberTaskManagers=<span class="number">1</span>, slotsPerTaskManager=<span class="number">4</span>&#125;</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">15</span>:<span class="number">25</span>,<span class="number">430</span> WARN  org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.hdfs</span><span class="selector-class">.shortcircuit</span><span class="selector-class">.DomainSocketFactory</span>       - The short-circuit local reads feature cannot be used because libhadoop cannot be loaded.</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">15</span>:<span class="number">25</span>,<span class="number">438</span> WARN  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.AbstractYarnClusterDescriptor</span>           - The configuration directory (<span class="string">&#x27;/Users/baoniu/Documents/work/tool/flink/flink-1.7.2/conf&#x27;</span>) contains both LOG4J and Logback configuration files. Please delete or rename one of them.</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">15</span>:<span class="number">36</span>,<span class="number">239</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.AbstractYarnClusterDescriptor</span>           - Submitting application master application_1532332183347_0724</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">15</span>:<span class="number">36</span>,<span class="number">276</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.yarn</span><span class="selector-class">.client</span><span class="selector-class">.api</span><span class="selector-class">.impl</span><span class="selector-class">.YarnClientImpl</span>         - Submitted application application_1532332183347_0724</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">15</span>:<span class="number">36</span>,<span class="number">276</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.AbstractYarnClusterDescriptor</span>           - Waiting <span class="keyword">for</span> the cluster to be allocated</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">15</span>:<span class="number">36</span>,<span class="number">281</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.AbstractYarnClusterDescriptor</span>           - Deploying cluster, current state ACCEPTED</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">15</span>:<span class="number">40</span>,<span class="number">426</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.AbstractYarnClusterDescriptor</span>           - YARN application has been deployed successfully.</span><br><span class="line">Starting execution of program</span><br><span class="line">Executing WordCount example with default <span class="selector-tag">input</span> data set.</span><br><span class="line">Use <span class="attr">--input</span> to specify file <span class="selector-tag">input</span>.</span><br><span class="line">Printing result to stdout. Use <span class="attr">--output</span> to specify output <span class="selector-tag">path</span>.</span><br><span class="line">(<span class="selector-tag">a</span>,<span class="number">5</span>)</span><br><span class="line">(action,<span class="number">1</span>)</span><br><span class="line">(after,<span class="number">1</span>)</span><br><span class="line">(against,<span class="number">1</span>)</span><br><span class="line">(<span class="attribute">all</span>,<span class="number">2</span>)</span><br><span class="line">... ...</span><br><span class="line">(would,<span class="number">2</span>)</span><br><span class="line">(wrong,<span class="number">1</span>)</span><br><span class="line">(you,<span class="number">1</span>)</span><br><span class="line">Program execution finished</span><br><span class="line">Job with JobID <span class="number">8</span>bfe7568cb5c3254af30cbbd9cd5971e has finished.</span><br><span class="line">Job Runtime: <span class="number">9371</span> ms</span><br><span class="line">Accumulator Results:</span><br><span class="line">- <span class="number">2</span>bed2c5506e9237fb85625416a1bc508 (java<span class="selector-class">.util</span>.ArrayList) <span class="selector-attr">[170 elements]</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/flink/6c80ab3fffcaf463b856b8cbc641d712.jpg" alt="img"></p>
<p><img src="/img/flink/3d296ecc860729bcc5e850925e84b74a.jpg" alt="img"></p>
<p>如果我们以 Attach 模式运行 Streaming 的任务，客户端会一直等待不退出，可以运行以下的例子试验下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.<span class="regexp">/bin/</span>flink run -m yarn-cluster .<span class="regexp">/examples/</span>streaming/TopSpeedWindowing.jar</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="单任务-Detached-模式"><a href="#单任务-Detached-模式" class="headerlink" title="单任务 Detached 模式"></a>单任务 Detached 模式</h5><ul>
<li>由于是 Detached 模式，客户端提交完任务就退出了</li>
<li>Yarn 上显示为 Flink per-job cluster</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$./bin/flink run -yd -m yarn-cluster ./examples/streaming/TopSpeedWindowing<span class="selector-class">.jar</span></span><br><span class="line"> </span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">18</span> <span class="number">09</span>:<span class="number">21</span>:<span class="number">59</span>,<span class="number">247</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.yarn</span><span class="selector-class">.client</span><span class="selector-class">.RMProxy</span>                         - Connecting to ResourceManager at z05c05217<span class="selector-class">.sqa</span><span class="selector-class">.zth</span><span class="selector-class">.tbsite</span>.net/<span class="number">11.163</span>.<span class="number">188.29</span>:<span class="number">8050</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">18</span> <span class="number">09</span>:<span class="number">21</span>:<span class="number">59</span>,<span class="number">428</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.cli</span><span class="selector-class">.FlinkYarnSessionCli</span>                 - No <span class="selector-tag">path</span> <span class="keyword">for</span> the flink jar passed. Using the location of class org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.YarnClusterDescriptor</span> to locate the jar</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">18</span> <span class="number">09</span>:<span class="number">21</span>:<span class="number">59</span>,<span class="number">428</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.cli</span><span class="selector-class">.FlinkYarnSessionCli</span>                 - No <span class="selector-tag">path</span> <span class="keyword">for</span> the flink jar passed. Using the location of class org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.YarnClusterDescriptor</span> to locate the jar</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">18</span> <span class="number">09</span>:<span class="number">21</span>:<span class="number">59</span>,<span class="number">940</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.AbstractYarnClusterDescriptor</span>           - Cluster specification: ClusterSpecification&#123;masterMemoryMB=<span class="number">1024</span>, taskManagerMemoryMB=<span class="number">1024</span>, numberTaskManagers=<span class="number">1</span>, slotsPerTaskManager=<span class="number">4</span>&#125;</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">18</span> <span class="number">09</span>:<span class="number">22</span>:<span class="number">00</span>,<span class="number">427</span> WARN  org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.hdfs</span><span class="selector-class">.shortcircuit</span><span class="selector-class">.DomainSocketFactory</span>       - The short-circuit local reads feature cannot be used because libhadoop cannot be loaded.</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">18</span> <span class="number">09</span>:<span class="number">22</span>:<span class="number">00</span>,<span class="number">436</span> WARN  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.AbstractYarnClusterDescriptor</span>           - The configuration directory (<span class="string">&#x27;/Users/baoniu/Documents/work/tool/flink/flink-1.7.2/conf&#x27;</span>) contains both LOG4J and Logback configuration files. Please delete or rename one of them.</span><br><span class="line">^@<span class="number">2019</span>-<span class="number">06</span>-<span class="number">18</span> <span class="number">09</span>:<span class="number">22</span>:<span class="number">12</span>,<span class="number">113</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.AbstractYarnClusterDescriptor</span>           - Submitting application master application_1532332183347_0729</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">18</span> <span class="number">09</span>:<span class="number">22</span>:<span class="number">12</span>,<span class="number">151</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.yarn</span><span class="selector-class">.client</span><span class="selector-class">.api</span><span class="selector-class">.impl</span><span class="selector-class">.YarnClientImpl</span>         - Submitted application application_1532332183347_0729</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">18</span> <span class="number">09</span>:<span class="number">22</span>:<span class="number">12</span>,<span class="number">151</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.AbstractYarnClusterDescriptor</span>           - Waiting <span class="keyword">for</span> the cluster to be allocated</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">18</span> <span class="number">09</span>:<span class="number">22</span>:<span class="number">12</span>,<span class="number">155</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.AbstractYarnClusterDescriptor</span>           - Deploying cluster, current state ACCEPTED</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">18</span> <span class="number">09</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">275</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.AbstractYarnClusterDescriptor</span>           - YARN application has been deployed successfully.</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">18</span> <span class="number">09</span>:<span class="number">22</span>:<span class="number">16</span>,<span class="number">275</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.AbstractYarnClusterDescriptor</span>           - The Flink YARN client has been started <span class="keyword">in</span> detached mode. In <span class="attribute">order</span> to stop Flink on YARN, use the following command or a YARN web interface to stop it:</span><br><span class="line">yarn application -kill application_1532332183347_0729</span><br><span class="line">Please also note that the temporary files of the YARN session <span class="keyword">in</span> the home directory will not be removed.</span><br><span class="line">Job has been submitted with JobID e61b9945c33c300906ad50a9a11f36df</span><br></pre></td></tr></table></figure>

<p><img src="/img/flink/4257964380de5f6137cc9b4523dd3be2.jpg" alt="img"></p>
<p><img src="/img/flink/410639c40b59c9128fb20b33ff6b9ecd.jpg" alt="img"></p>
<h4 id="2-1-3-Yarn-session"><a href="#2-1-3-Yarn-session" class="headerlink" title="2.1.3 Yarn session"></a>2.1.3 Yarn session</h4><h5 id="启动-Session"><a href="#启动-Session" class="headerlink" title="启动 Session"></a>启动 Session</h5><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/yarn-session.<span class="keyword">sh</span> -<span class="keyword">tm</span> <span class="number">2048</span> -s <span class="number">3</span></span><br></pre></td></tr></table></figure>

<p>表示启动一个 Yarn session 集群，每个 TM 的内存是 2 G，每个 TM 有 3 个 Slot。(注意：-n 参数不生效)</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">➜  flink-<span class="number">1</span>.<span class="number">7</span>.<span class="number">2</span> ./bin/yarn-session.sh -tm <span class="number">2048</span> -s <span class="number">3</span></span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09:21:50,177</span> INFO  org.apache.flink.configuration.GlobalConfiguration            - Loading configuration property: jobmanager.rpc.address, localhost</span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09:21:50,179</span> INFO  org.apache.flink.configuration.GlobalConfiguration            - Loading configuration property: jobmanager.rpc.port, <span class="number">6123</span></span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09:21:50,179</span> INFO  org.apache.flink.configuration.GlobalConfiguration            - Loading configuration property: jobmanager.heap.size, <span class="number">1024m</span></span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09:21:50,179</span> INFO  org.apache.flink.configuration.GlobalConfiguration            - Loading configuration property: taskmanager.heap.size, <span class="number">1024m</span></span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09:21:50,179</span> INFO  org.apache.flink.configuration.GlobalConfiguration            - Loading configuration property: taskmanager.numberOfTaskSlots, <span class="number">4</span></span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09:21:50,179</span> INFO  org.apache.flink.configuration.GlobalConfiguration            - Loading configuration property: state.savepoints.dir, file:///tmp/savepoint</span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09:21:50,180</span> INFO  org.apache.flink.configuration.GlobalConfiguration            - Loading configuration property: parallelism.default, <span class="number">1</span></span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09:21:50,180</span> INFO  org.apache.flink.configuration.GlobalConfiguration            - Loading configuration property: rest.port, <span class="number">8081</span></span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09</span>:<span class="number">21:50,644</span> WARN  org.apache.hadoop.util.NativeCodeLoader                       - Unable to load native-hadoop library for your platform... using builtin-java classes where applicable</span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09</span>:<span class="number">21:50,746</span> INFO  org.apache.flink.runtime.security.modules.HadoopModule        - Hadoop user set to baoniu (auth:SIMPLE)</span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09</span>:<span class="number">21:50,848</span> INFO  org.apache.hadoop.yarn.client.RMProxy                         - Connecting to ResourceManager at z<span class="number">05c05217</span>.sqa.zth.tbsite.net/<span class="number">11.163.188.29</span>:<span class="number">8050</span></span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09:21:51,148</span> INFO  org.apache.flink.yarn.AbstractYarnClusterDescriptor           - Cluster specification: ClusterSpecification&#123;masterMemoryMB=<span class="number">1024</span>, taskManagerMemoryMB=<span class="number">2048</span>, numberTaskManagers=<span class="number">1</span>, slotsPerTaskManager=<span class="number">3</span>&#125;</span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09</span>:<span class="number">21:51,588</span> WARN  org.apache.hadoop.hdfs.shortcircuit.DomainSocketFactory       - The short-circuit local reads feature cannot be used because libhadoop cannot be loaded.</span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09</span>:<span class="number">21:51,596</span> WARN  org.apache.flink.yarn.AbstractYarnClusterDescriptor           - The configuration directory (&#x27;/Users/baoniu/Documents/work/tool/flink/flink-<span class="number">1</span>.<span class="number">7</span>.<span class="number">2</span>/conf&#x27;) contains both LOG4J and Logback configuration files. Please delete or rename one of them.</span><br><span class="line">^@<span class="number">2019-06-17</span> <span class="number">09</span>:<span class="number">22:03,304</span> INFO  org.apache.flink.yarn.AbstractYarnClusterDescriptor           - Submitting application master application_1532332<span class="number">183347_0726</span></span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09</span>:<span class="number">22:03,336</span> INFO  org.apache.hadoop.yarn.client.api.impl.YarnClientImpl         - Submitted application application_1532332<span class="number">183347_0726</span></span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09</span>:<span class="number">22:03,336</span> INFO  org.apache.flink.yarn.AbstractYarnClusterDescriptor           - Waiting for the cluster to be allocated</span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09</span>:<span class="number">22:03,340</span> INFO  org.apache.flink.yarn.AbstractYarnClusterDescriptor           - Deploying cluster, current state ACCEPTED</span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09</span>:<span class="number">22:07,722</span> INFO  org.apache.flink.yarn.AbstractYarnClusterDescriptor           - YARN application has been deployed successfully.</span><br><span class="line"><span class="number">2019-06-17</span> <span class="number">09</span>:<span class="number">22:08,050</span> INFO  org.apache.flink.runtime.rest.RestClient                      - Rest client endpoint started.</span><br><span class="line">Flink JobManager is now running on z07.sqa.net:<span class="number">37109</span> with leader id <span class="number">00000000</span>-<span class="number">0000-0000</span>-<span class="number">0000</span>-<span class="number">000000000000</span>.</span><br><span class="line">JobManager Web Interface: http://z07.sqa.net:<span class="number">37109</span></span><br></pre></td></tr></table></figure>

<p>客户端默认是 Attach 模式，不会退出：</p>
<ul>
<li>可以 ctrl + c 退出，然后再通过 .&#x2F;bin&#x2F;yarn-session.sh -id application_1532332183347_0726 连上来；</li>
<li>或者启动的时候用 -d 则为 detached 模式<br>Yarn 上显示为 Flink session cluster；</li>
</ul>
<p><img src="/img/flink/8565162baca390e4853fec5b921696af.jpg" alt="img"></p>
<p><img src="/img/flink/a7e8c910fcd0ba5005612c7512836529.jpg" alt="img"></p>
<ul>
<li>在本机的临时目录（有些机器是 &#x2F;tmp 目录）下会生成一个文件：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  flink-1.7.2 <span class="built_in">cat</span> /var/folders/2b/r6d49pcs23z43b8fqsyz885c0000gn/T/.yarn-properties-baoniu</span><br><span class="line"><span class="comment">#Generated YARN properties file</span></span><br><span class="line"><span class="comment">#Mon Jun 17 09:22:08 CST 2019</span></span><br><span class="line">parallelism=3</span><br><span class="line">dynamicPropertiesString=</span><br><span class="line">applicationID=application_1532332183347_0726</span><br></pre></td></tr></table></figure>

<h5 id="提交任务"><a href="#提交任务" class="headerlink" title="提交任务"></a>提交任务</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.<span class="regexp">/bin/</span>flink run .<span class="regexp">/examples/</span>batch/WordCount.jar</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将会根据 &#x2F;tmp&#x2F;.yarn-properties-admin 文件内容提交到了刚启动的 Session。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">➜  flink-<span class="number">1.7</span>.<span class="number">2</span> ./bin/flink run ./examples/batch/WordCount<span class="selector-class">.jar</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">42</span>,<span class="number">767</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.cli</span><span class="selector-class">.FlinkYarnSessionCli</span>                 - Found Yarn properties file under /var/folders/<span class="number">2</span>b/r6d49pcs23z43b8fqsyz885c0000gn/T/<span class="selector-class">.yarn-properties-baoniu</span>.</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">42</span>,<span class="number">767</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.cli</span><span class="selector-class">.FlinkYarnSessionCli</span>                 - Found Yarn properties file under /var/folders/<span class="number">2</span>b/r6d49pcs23z43b8fqsyz885c0000gn/T/<span class="selector-class">.yarn-properties-baoniu</span>.</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">43</span>,<span class="number">058</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.cli</span><span class="selector-class">.FlinkYarnSessionCli</span>                 - YARN properties set default parallelism to <span class="number">3</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">43</span>,<span class="number">058</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.cli</span><span class="selector-class">.FlinkYarnSessionCli</span>                 - YARN properties set default parallelism to <span class="number">3</span></span><br><span class="line">YARN properties set default parallelism to <span class="number">3</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">43</span>,<span class="number">097</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.yarn</span><span class="selector-class">.client</span><span class="selector-class">.RMProxy</span>                         - Connecting to ResourceManager at z05c05217<span class="selector-class">.sqa</span><span class="selector-class">.zth</span><span class="selector-class">.tbsite</span>.net/<span class="number">11.163</span>.<span class="number">188.29</span>:<span class="number">8050</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">43</span>,<span class="number">229</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.cli</span><span class="selector-class">.FlinkYarnSessionCli</span>                 - No <span class="selector-tag">path</span> <span class="keyword">for</span> the flink jar passed. Using the location of class org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.YarnClusterDescriptor</span> to locate the jar</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">43</span>,<span class="number">229</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.cli</span><span class="selector-class">.FlinkYarnSessionCli</span>                 - No <span class="selector-tag">path</span> <span class="keyword">for</span> the flink jar passed. Using the location of class org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.YarnClusterDescriptor</span> to locate the jar</span><br><span class="line"><span class="number">2019</span>-<span class="number">06</span>-<span class="number">17</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">43</span>,<span class="number">327</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.AbstractYarnClusterDescriptor</span>           - Found application JobManager host name <span class="string">&#x27;z05c07216.sqa.zth.tbsite.net&#x27;</span> and port <span class="string">&#x27;37109&#x27;</span> from supplied application id <span class="string">&#x27;application_1532332183347_0726&#x27;</span></span><br><span class="line">Starting execution of program</span><br><span class="line">Executing WordCount example with default <span class="selector-tag">input</span> data set.</span><br><span class="line">Use <span class="attr">--input</span> to specify file <span class="selector-tag">input</span>.</span><br><span class="line">Printing result to stdout. Use <span class="attr">--output</span> to specify output <span class="selector-tag">path</span>.</span><br><span class="line">^@(<span class="selector-tag">a</span>,<span class="number">5</span>)</span><br><span class="line">(action,<span class="number">1</span>)</span><br><span class="line">(after,<span class="number">1</span>)</span><br><span class="line">(against,<span class="number">1</span>)</span><br><span class="line">(<span class="attribute">all</span>,<span class="number">2</span>)</span><br><span class="line">(and,<span class="number">12</span>)</span><br><span class="line">... ...</span><br><span class="line">(wrong,<span class="number">1</span>)</span><br><span class="line">(you,<span class="number">1</span>)</span><br><span class="line">Program execution finished</span><br><span class="line">Job with JobID ad9b0f1feed6d0bf6ba4e0f18b1e65ef has finished.</span><br><span class="line">Job Runtime: <span class="number">9152</span> ms</span><br><span class="line">Accumulator Results:</span><br><span class="line">- fd07c75d503d0d9a99e4f27dd153114c (java<span class="selector-class">.util</span>.ArrayList) <span class="selector-attr">[170 elements]</span></span><br></pre></td></tr></table></figure>

<p>运行结束后 TM 的资源会释放。</p>
<p><img src="/img/flink/11e3e2176f5fe1402a9a8f1d4265a7c0.jpg" alt="img"></p>
<h5 id="提交到指定的-Session"><a href="#提交到指定的-Session" class="headerlink" title="提交到指定的 Session"></a>提交到指定的 Session</h5><p>通过 -yid 参数来提交到指定的 Session。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$./bin/flink run -d -<span class="selector-tag">p</span> <span class="number">30</span> -m yarn-cluster -yid application_1532332183347_0708 ./examples/streaming/TopSpeedWindowing<span class="selector-class">.jar</span></span><br><span class="line"> </span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">24</span> <span class="number">12</span>:<span class="number">36</span>:<span class="number">33</span>,<span class="number">668</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.hadoop</span><span class="selector-class">.yarn</span><span class="selector-class">.client</span><span class="selector-class">.RMProxy</span>                         - Connecting to ResourceManager at z05c05217<span class="selector-class">.sqa</span><span class="selector-class">.zth</span><span class="selector-class">.tbsite</span>.net/<span class="number">11.163</span>.<span class="number">188.29</span>:<span class="number">8050</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">24</span> <span class="number">12</span>:<span class="number">36</span>:<span class="number">33</span>,<span class="number">773</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.cli</span><span class="selector-class">.FlinkYarnSessionCli</span>                 - No <span class="selector-tag">path</span> <span class="keyword">for</span> the flink jar passed. Using the location of class org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.YarnClusterDescriptor</span> to locate the jar</span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">24</span> <span class="number">12</span>:<span class="number">36</span>:<span class="number">33</span>,<span class="number">773</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.cli</span><span class="selector-class">.FlinkYarnSessionCli</span>                 - No <span class="selector-tag">path</span> <span class="keyword">for</span> the flink jar passed. Using the location of class org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.YarnClusterDescriptor</span> to locate the jar</span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">24</span> <span class="number">12</span>:<span class="number">36</span>:<span class="number">33</span>,<span class="number">837</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.yarn</span><span class="selector-class">.AbstractYarnClusterDescriptor</span>           - Found application JobManager host name <span class="string">&#x27;z05c05218.sqa.zth.tbsite.net&#x27;</span> and port <span class="string">&#x27;60783&#x27;</span> from supplied application id <span class="string">&#x27;application_1532332183347_0708&#x27;</span></span><br><span class="line">Starting execution of program</span><br><span class="line">Executing TopSpeedWindowing example with default <span class="selector-tag">input</span> data set.</span><br><span class="line">Use <span class="attr">--input</span> to specify file <span class="selector-tag">input</span>.</span><br><span class="line">Printing result to stdout. Use <span class="attr">--output</span> to specify output <span class="selector-tag">path</span>.</span><br><span class="line">Job has been submitted with JobID <span class="number">58</span>d5049ebbf28d515159f2f88563f5fd</span><br></pre></td></tr></table></figure>

<p><img src="/img/flink/37d31bef13ddc686d6e2044cb6f43cca.jpg" alt="img"></p>
<p>注：<a href="https://github.com/apache/flink/commits/blink">Blink 版本</a> 的 Session 与 Flink 的 Session 的区别：</p>
<ul>
<li>Flink 的 session -n 参数不生效，而且不会提前启动 TM；</li>
<li>Blink 的 session 可以通过 -n 指定启动多少个 TM，而且 TM 会提前起来；</li>
</ul>
<h3 id="2-2-Scala-Shell"><a href="#2-2-Scala-Shell" class="headerlink" title="2.2 Scala Shell"></a>2.2 Scala Shell</h3><p><a href="100477.html">Scala Shell文档</a></p>
<h4 id="2-2-1-Deploy"><a href="#2-2-1-Deploy" class="headerlink" title="2.2.1 Deploy"></a>2.2.1 Deploy</h4><h5 id="Local"><a href="#Local" class="headerlink" title="Local"></a>Local</h5><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$bin</span>/start-<span class="keyword">scala</span>-<span class="keyword">shell</span>.<span class="keyword">sh</span> <span class="keyword">local</span></span><br><span class="line">Starting Flink <span class="keyword">Shell</span>:</span><br><span class="line">Starting <span class="keyword">local</span> Flink <span class="keyword">cluster</span> (host: localhost, port: 8081).</span><br><span class="line">Connecting to Flink <span class="keyword">cluster</span> (host: localhost, port: 8081).</span><br><span class="line">... ...</span><br><span class="line"><span class="keyword">scala</span>&gt;</span><br></pre></td></tr></table></figure>

<p>任务运行说明：</p>
<ul>
<li>Batch 任务内置了 benv 变量，通过 print() 将结果输出到控制台；</li>
<li>Streaming 任务内置了 senv 变量，通过 senv.execute(“job name”) 来提交任务，且 Datastream 的输出只有在 Local 模式下打印到控制台；</li>
</ul>
<h5 id="Remote"><a href="#Remote" class="headerlink" title="Remote"></a>Remote</h5><p>先启动一个 yarn session cluster：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$./bin/yarn-session<span class="selector-class">.sh</span>  -tm <span class="number">2048</span> -s <span class="number">3</span></span><br><span class="line"> </span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">25</span> <span class="number">09</span>:<span class="number">52</span>:<span class="number">16</span>,<span class="number">341</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.configuration</span><span class="selector-class">.GlobalConfiguration</span>            - Loading configuration property: jobmanager<span class="selector-class">.rpc</span><span class="selector-class">.address</span>, localhost</span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">25</span> <span class="number">09</span>:<span class="number">52</span>:<span class="number">16</span>,<span class="number">342</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.configuration</span><span class="selector-class">.GlobalConfiguration</span>            - Loading configuration property: jobmanager<span class="selector-class">.rpc</span><span class="selector-class">.port</span>, <span class="number">6123</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">25</span> <span class="number">09</span>:<span class="number">52</span>:<span class="number">16</span>,<span class="number">342</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.configuration</span><span class="selector-class">.GlobalConfiguration</span>            - Loading configuration property: jobmanager<span class="selector-class">.heap</span><span class="selector-class">.size</span>, <span class="number">1024</span>m</span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">25</span> <span class="number">09</span>:<span class="number">52</span>:<span class="number">16</span>,<span class="number">343</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.configuration</span><span class="selector-class">.GlobalConfiguration</span>            - Loading configuration property: taskmanager<span class="selector-class">.heap</span><span class="selector-class">.size</span>, <span class="number">1024</span>m</span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">25</span> <span class="number">09</span>:<span class="number">52</span>:<span class="number">16</span>,<span class="number">343</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.configuration</span><span class="selector-class">.GlobalConfiguration</span>            - Loading configuration property: taskmanager<span class="selector-class">.numberOfTaskSlots</span>, <span class="number">4</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">25</span> <span class="number">09</span>:<span class="number">52</span>:<span class="number">16</span>,<span class="number">343</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.configuration</span><span class="selector-class">.GlobalConfiguration</span>            - Loading configuration property: parallelism<span class="selector-class">.default</span>, <span class="number">1</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">25</span> <span class="number">09</span>:<span class="number">52</span>:<span class="number">16</span>,<span class="number">343</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.configuration</span><span class="selector-class">.GlobalConfiguration</span>            - Loading configuration property: state<span class="selector-class">.savepoints</span><span class="selector-class">.dir</span>, file:<span class="comment">///tmp/savepoint</span></span><br><span class="line"><span class="number">2019</span>-<span class="number">03</span>-<span class="number">25</span> <span class="number">09</span>:<span class="number">52</span>:<span class="number">16</span>,<span class="number">343</span> INFO  org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.configuration</span><span class="selector-class">.GlobalConfiguration</span>            </span><br><span class="line">… ...</span><br><span class="line">Flink JobManager is now running on z054<span class="selector-class">.sqa</span><span class="selector-class">.net</span>:<span class="number">28665</span> with leader id <span class="number">00000000</span>-<span class="number">0000</span>-<span class="number">0000</span>-<span class="number">0000</span>-<span class="number">000000000000</span>.</span><br><span class="line">JobManager Web Interface: http:<span class="comment">//z054.sqa.net:28665</span></span><br></pre></td></tr></table></figure>

<p>启动 scala shell，连到 jm：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$bin</span>/start-<span class="keyword">scala</span>-<span class="keyword">shell</span>.<span class="keyword">sh</span> remote z054.sqa.<span class="keyword">net</span> 28665</span><br><span class="line">Starting Flink <span class="keyword">Shell</span>:</span><br><span class="line">Connecting to Flink <span class="keyword">cluster</span> (host: z054.sqa.<span class="keyword">net</span>, port: 28665).</span><br><span class="line">... ...</span><br><span class="line"><span class="keyword">scala</span>&gt;</span><br></pre></td></tr></table></figure>

<h5 id="Yarn"><a href="#Yarn" class="headerlink" title="Yarn"></a>Yarn</h5><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$./bin/start-scala-shell.sh yarn -n <span class="number">2</span> -jm <span class="number">1024</span> -s <span class="number">2</span> -tm <span class="number">1024</span> -nm flink-yarn</span><br><span class="line"> </span><br><span class="line">Starting Flink Shell:</span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:44,695</span> INFO  org.apache.flink.configuration.GlobalConfiguration            - Loading configuration property: jobmanager.rpc.address, localhost</span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:44,697</span> INFO  org.apache.flink.configuration.GlobalConfiguration            - Loading configuration property: jobmanager.rpc.port, <span class="number">6123</span></span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:44,697</span> INFO  org.apache.flink.configuration.GlobalConfiguration            - Loading configuration property: jobmanager.heap.size, <span class="number">1024m</span></span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:44,697</span> INFO  org.apache.flink.configuration.GlobalConfiguration            - Loading configuration property: taskmanager.heap.size, <span class="number">1024m</span></span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:44,697</span> INFO  org.apache.flink.configuration.GlobalConfiguration            - Loading configuration property: taskmanager.numberOfTaskSlots, <span class="number">4</span></span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:44,698</span> INFO  org.apache.flink.configuration.GlobalConfiguration            - Loading configuration property: parallelism.default, <span class="number">1</span></span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:44,698</span> INFO  org.apache.flink.configuration.GlobalConfiguration            - Loading configuration property: state.savepoints.dir, file:///tmp/savepoint</span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:44,698</span> INFO  org.apache.flink.configuration.GlobalConfiguration            - Loading configuration property: rest.port, <span class="number">8081</span></span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:44,717</span> INFO  org.apache.flink.yarn.cli.FlinkYarnSessionCli                 - Found Yarn properties file under /tmp/.yarn-properties-admin.</span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:45,041</span> INFO  org.apache.hadoop.yarn.client.RMProxy                         - Connecting to ResourceManager at z<span class="number">05c05217</span>.sqa.zth.tbsite.net/<span class="number">11.163.188.29</span>:<span class="number">8050</span></span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:45,098</span> WARN  org.apache.hadoop.util.NativeCodeLoader                       - Unable to load native-hadoop library for your platform... using builtin-java classes where applicable</span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:45,266</span> INFO  org.apache.flink.yarn.cli.FlinkYarnSessionCli                 - No path for the flink jar passed. Using the location of class org.apache.flink.yarn.YarnClusterDescriptor to locate the jar</span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:45,275</span> INFO  org.apache.flink.yarn.cli.FlinkYarnSessionCli                 - The argument yn is deprecated in will be ignored.</span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:45,357</span> INFO  org.apache.flink.yarn.AbstractYarnClusterDescriptor           - Cluster specification: ClusterSpecification&#123;masterMemoryMB=<span class="number">1024</span>, taskManagerMemoryMB=<span class="number">1024</span>, numberTaskManagers=<span class="number">2</span>, slotsPerTaskManager=<span class="number">2</span>&#125;</span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:45,711</span> WARN  org.apache.hadoop.hdfs.shortcircuit.DomainSocketFactory       - The short-circuit local reads feature cannot be used because libhadoop cannot be loaded.</span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:45,718</span> WARN  org.apache.flink.yarn.AbstractYarnClusterDescriptor           - The configuration directory (&#x27;/home/admin/flink/flink-<span class="number">1</span>.<span class="number">7</span>.<span class="number">2</span>/conf&#x27;) contains both LOG4J and Logback configuration files. Please delete or rename one of them.</span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:46,514</span> INFO  org.apache.flink.yarn.AbstractYarnClusterDescriptor           - Submitting application master application_1532332<span class="number">183347_0710</span></span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:46,534</span> INFO  org.apache.hadoop.yarn.client.api.impl.YarnClientImpl         - Submitted application application_1532332<span class="number">183347_0710</span></span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:46,534</span> INFO  org.apache.flink.yarn.AbstractYarnClusterDescriptor           - Waiting for the cluster to be allocated</span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:46,535</span> INFO  org.apache.flink.yarn.AbstractYarnClusterDescriptor           - Deploying cluster, current state ACCEPTED</span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09</span>:<span class="number">47:51,051</span> INFO  org.apache.flink.yarn.AbstractYarnClusterDescriptor           - YARN application has been deployed successfully.</span><br><span class="line"><span class="number">2019-03-25</span> <span class="number">09:47:51,222</span> INFO  org.apache.flink.runtime.rest.RestClient                      - Rest client endpoint started.</span><br><span class="line"> </span><br><span class="line">Connecting to Flink cluster (host: <span class="number">10.10.10.10</span>, port: <span class="number">56942</span>).</span><br></pre></td></tr></table></figure>

<p><img src="/img/flink/2f74092aca0d3581da7ced24b5b87279.jpg" alt="img"></p>
<p>按 CTRL + C 退出 Shell 后，这个 Flink cluster 还会继续运行，不会退出。</p>
<h4 id="2-2-2-Execute"><a href="#2-2-2-Execute" class="headerlink" title="2.2.2 Execute"></a>2.2.2 Execute</h4><h5 id="DataSet"><a href="#DataSet" class="headerlink" title="DataSet"></a>DataSet</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">➜  flink-<span class="number">1.7</span>.<span class="number">2</span> bin/stop-cluster<span class="selector-class">.sh</span></span><br><span class="line">No taskexecutor daemon to <span class="selector-tag">stop</span> on host zkb-MBP<span class="selector-class">.local</span>.</span><br><span class="line">No standalonesession daemon to <span class="selector-tag">stop</span> on host zkb-MBP<span class="selector-class">.local</span>.</span><br><span class="line">➜  flink-<span class="number">1.7</span>.<span class="number">2</span> bin/start-scala-shell<span class="selector-class">.sh</span> local</span><br><span class="line">Starting Flink Shell:</span><br><span class="line">Starting local Flink cluster (host: localhost, port: <span class="number">8081</span>).</span><br><span class="line">Connecting to Flink cluster (host: localhost, port: <span class="number">8081</span>).</span><br><span class="line"> </span><br><span class="line">scala&gt; val <span class="selector-tag">text</span> = benv<span class="selector-class">.fromElements</span>(<span class="string">&quot;To be, or not to be,--that is the question:--&quot;</span>)</span><br><span class="line"><span class="selector-tag">text</span>: org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.api</span><span class="selector-class">.scala</span><span class="selector-class">.DataSet</span><span class="selector-attr">[String]</span> = org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.api</span><span class="selector-class">.scala</span>.DataSet@<span class="number">5</span>b407336</span><br><span class="line"> </span><br><span class="line">scala&gt; val counts = <span class="selector-tag">text</span><span class="selector-class">.flatMap</span> &#123; _<span class="selector-class">.toLowerCase</span><span class="selector-class">.split</span>(<span class="string">&quot;\\W+&quot;</span>) &#125;<span class="selector-class">.map</span> &#123; (_, <span class="number">1</span>) &#125;<span class="selector-class">.groupBy</span>(<span class="number">0</span>)<span class="selector-class">.sum</span>(<span class="number">1</span>)</span><br><span class="line">counts: org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.api</span><span class="selector-class">.scala</span><span class="selector-class">.AggregateDataSet</span><span class="selector-attr">[(String, Int)]</span> = org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.api</span><span class="selector-class">.scala</span>.AggregateDataSet@<span class="number">6</span>ee34fe4</span><br><span class="line"> </span><br><span class="line">scala&gt; counts<span class="selector-class">.print</span>()</span><br><span class="line">(be,<span class="number">2</span>)</span><br><span class="line">(is,<span class="number">1</span>)</span><br><span class="line">(not,<span class="number">1</span>)</span><br><span class="line">(or,<span class="number">1</span>)</span><br><span class="line">(question,<span class="number">1</span>)</span><br><span class="line">(that,<span class="number">1</span>)</span><br><span class="line">(the,<span class="number">1</span>)</span><br><span class="line">(to,<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>对 DataSet 任务来说，print() 会触发任务的执行。</p>
<p><img src="/img/flink/3a500f4719d9c7ff37ce1c6c4737599d.jpg" alt="img"></p>
<p>也可以将结果输出到文件（先删除 &#x2F;tmp&#x2F;out1，不然会报错同名文件已经存在），继续执行以下命令：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; counts<span class="selector-class">.writeAsText</span>(<span class="string">&quot;/tmp/out1&quot;</span>)</span><br><span class="line">res1: org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.api</span><span class="selector-class">.java</span><span class="selector-class">.operators</span><span class="selector-class">.DataSink</span><span class="selector-attr">[(String, Int)]</span> = DataSink <span class="string">&#x27;&lt;unnamed&gt;&#x27;</span> (TextOutputFormat (/tmp/out1) - UTF-<span class="number">8</span>)</span><br><span class="line"> </span><br><span class="line">scala&gt; benv<span class="selector-class">.execute</span>(<span class="string">&quot;batch test&quot;</span>)</span><br><span class="line">res2: org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.api</span><span class="selector-class">.common</span><span class="selector-class">.JobExecutionResult</span> = org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.api</span><span class="selector-class">.common</span>.JobExecutionResult@<span class="number">737652</span>a9</span><br></pre></td></tr></table></figure>

<p>查看 &#x2F;tmp&#x2F;out1 文件就能看到输出结果。</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  flink-<span class="number">1.7</span>.<span class="number">2</span> <span class="keyword">cat</span> /tmp/out1</span><br><span class="line">(<span class="keyword">be</span>,<span class="number">2</span>)</span><br><span class="line">(<span class="keyword">is</span>,<span class="number">1</span>)</span><br><span class="line">(not,<span class="number">1</span>)</span><br><span class="line">(<span class="built_in">or</span>,<span class="number">1</span>)</span><br><span class="line">(question,<span class="number">1</span>)</span><br><span class="line">(that,<span class="number">1</span>)</span><br><span class="line">(the,<span class="number">1</span>)</span><br><span class="line">(<span class="keyword">to</span>,<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/img/flink/a22a7a91e6b458a54a17ebdea8e3c662.jpg" alt="img"></p>
<h5 id="DataStream"><a href="#DataStream" class="headerlink" title="DataStream"></a>DataStream</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; val textStreaming = senv<span class="selector-class">.fromElements</span>(<span class="string">&quot;To be, or not to be,--that is the question:--&quot;</span>)</span><br><span class="line">textStreaming: org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.streaming</span><span class="selector-class">.api</span><span class="selector-class">.scala</span><span class="selector-class">.DataStream</span><span class="selector-attr">[String]</span> = org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.streaming</span><span class="selector-class">.api</span><span class="selector-class">.scala</span>.DataStream@<span class="number">4970</span>b93d</span><br><span class="line"> </span><br><span class="line">scala&gt; val countsStreaming = textStreaming<span class="selector-class">.flatMap</span> &#123; _<span class="selector-class">.toLowerCase</span><span class="selector-class">.split</span>(<span class="string">&quot;\\W+&quot;</span>) &#125;<span class="selector-class">.map</span> &#123; (_, <span class="number">1</span>) &#125;<span class="selector-class">.keyBy</span>(<span class="number">0</span>)<span class="selector-class">.sum</span>(<span class="number">1</span>)</span><br><span class="line">countsStreaming: org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.streaming</span><span class="selector-class">.api</span><span class="selector-class">.scala</span><span class="selector-class">.DataStream</span><span class="selector-attr">[(String, Int)]</span> = org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.streaming</span><span class="selector-class">.api</span><span class="selector-class">.scala</span>.DataStream@<span class="number">6</span>a478680</span><br><span class="line"> </span><br><span class="line">scala&gt; countsStreaming<span class="selector-class">.print</span>()</span><br><span class="line">res3: org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.streaming</span><span class="selector-class">.api</span><span class="selector-class">.datastream</span><span class="selector-class">.DataStreamSink</span><span class="selector-attr">[(String, Int)]</span> = org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.streaming</span><span class="selector-class">.api</span><span class="selector-class">.datastream</span>.DataStreamSink@<span class="number">42</span>bfc11f</span><br><span class="line"> </span><br><span class="line">scala&gt; senv<span class="selector-class">.execute</span>(<span class="string">&quot;Streaming Wordcount&quot;</span>)</span><br><span class="line">(to,<span class="number">1</span>)</span><br><span class="line">(be,<span class="number">1</span>)</span><br><span class="line">(or,<span class="number">1</span>)</span><br><span class="line">(not,<span class="number">1</span>)</span><br><span class="line">(to,<span class="number">2</span>)</span><br><span class="line">(be,<span class="number">2</span>)</span><br><span class="line">(that,<span class="number">1</span>)</span><br><span class="line">(is,<span class="number">1</span>)</span><br><span class="line">(the,<span class="number">1</span>)</span><br><span class="line">(question,<span class="number">1</span>)</span><br><span class="line">res4: org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.api</span><span class="selector-class">.common</span><span class="selector-class">.JobExecutionResult</span> = org<span class="selector-class">.apache</span><span class="selector-class">.flink</span><span class="selector-class">.api</span><span class="selector-class">.common</span>.JobExecutionResult@<span class="number">1878815</span>a</span><br></pre></td></tr></table></figure>

<p>对 DataStream 任务，print() 并不会触发任务的执行，需要显示调用 execute(“job name”) 才会执行任务。</p>
<p><img src="/img/flink/7adc81aee7c9319714614cbb12f41257.jpg" alt="img"></p>
<p><img src="/img/flink/fc3c3b81fa322ebf7881a74293090849.jpg" alt="img"></p>
<h5 id="TableAPI"><a href="#TableAPI" class="headerlink" title="TableAPI"></a>TableAPI</h5><p>在 Blink 开源版本里面，支持了 TableAPI 方式提交任务（可以用 btenv.sqlQuery 提交 SQL 查询），社区版本 Flink 1.8 会支持 TableAPI: <a href="https://issues.apache.org/jira/browse/FLINK-9555">https://issues.apache.org/jira/browse/FLINK-9555</a></p>
<h3 id="2-3-SQL-Client-Beta"><a href="#2-3-SQL-Client-Beta" class="headerlink" title="2.3 SQL Client Beta"></a>2.3 SQL Client Beta</h3><p>SQL Client 目前还只是测试版，处于开发阶段，只能用于 SQL 的原型验证，不推荐在生产环境使用。</p>
<h4 id="2-3-1-基本用法"><a href="#2-3-1-基本用法" class="headerlink" title="2.3.1 基本用法"></a>2.3.1 基本用法</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">➜  flink-1.7.2 bin/start-<span class="keyword">cluster</span>.<span class="keyword">sh</span></span><br><span class="line">Starting <span class="keyword">cluster</span>.</span><br><span class="line">Starting standalonesession daemon <span class="keyword">on</span> host zkb-MBP.<span class="keyword">local</span>.</span><br><span class="line">Starting taskexecutor daemon <span class="keyword">on</span> host zkb-MBP.<span class="keyword">local</span>.</span><br><span class="line"> </span><br><span class="line">➜  flink-1.7.2 ./bin/sql-client.<span class="keyword">sh</span> embedded</span><br><span class="line"><span class="keyword">No</span> default environment specified.</span><br><span class="line">Searching <span class="keyword">for</span> &#x27;/Users/baoniu/Documents/work/tool/flink/flink-1.7.2/<span class="keyword">conf</span>/sql-client-defaults.yaml&#x27;...found.</span><br><span class="line">Reading default environment from: <span class="keyword">file</span>:/Users/baoniu/Documents/work/tool/flink/flink-1.7.2/<span class="keyword">conf</span>/sql-client-defaults.yaml</span><br><span class="line"><span class="keyword">No</span> session environment specified.</span><br><span class="line">Validating current environment...done.</span><br><span class="line">… …</span><br><span class="line"> </span><br><span class="line">Flink SQL&gt; <span class="keyword">help</span>;</span><br><span class="line">The following commands are available:</span><br><span class="line"> </span><br><span class="line">QUIT		Quits the SQL <span class="keyword">CLI</span> client.</span><br><span class="line"><span class="keyword">CLEAR</span>		Clears the current terminal.</span><br><span class="line"><span class="keyword">HELP</span>		Prints the available commands.</span><br><span class="line">SHOW TABLES		Shows all registered tables.</span><br><span class="line">SHOW FUNCTIONS		Shows all registered user-defined functions.</span><br><span class="line"><span class="keyword">DESCRIBE</span>		Describes the schema of a <span class="keyword">table</span> with the given name.</span><br><span class="line">EXPLAIN		Describes the execution plan of a <span class="keyword">query</span> or <span class="keyword">table</span> with the given name.</span><br><span class="line">SELECT		Executes a SQL SELECT <span class="keyword">query</span> <span class="keyword">on</span> the Flink <span class="keyword">cluster</span>.</span><br><span class="line">INSERT INTO		Inserts the results of a SQL SELECT <span class="keyword">query</span> into a declared <span class="keyword">table</span> sink.</span><br><span class="line">CREATE <span class="keyword">VIEW</span>		Creates a virtual <span class="keyword">table</span> from a SQL <span class="keyword">query</span>. <span class="keyword">Syntax</span>: &#x27;CREATE <span class="keyword">VIEW</span> &lt;name&gt; <span class="keyword">AS</span> &lt;<span class="keyword">query</span>&gt;;&#x27;</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span>		Deletes a previously created virtual <span class="keyword">table</span>. <span class="keyword">Syntax</span>: &#x27;<span class="keyword">DROP</span> <span class="keyword">VIEW</span> &lt;name&gt;;&#x27;</span><br><span class="line">SOURCE		Reads a SQL SELECT <span class="keyword">query</span> from a <span class="keyword">file</span> and executes it <span class="keyword">on</span> the Flink <span class="keyword">cluster</span>.</span><br><span class="line"><span class="keyword">SET</span>		Sets a session configuration property. <span class="keyword">Syntax</span>: &#x27;<span class="keyword">SET</span> &lt;key&gt;=&lt;value&gt;;&#x27;. <span class="keyword">Use</span> &#x27;<span class="keyword">SET</span>;&#x27; <span class="keyword">for</span> listing all properties.</span><br><span class="line">RESET		Resets all session configuration properties.</span><br><span class="line"> </span><br><span class="line">Hint: Make sure that a statement ends with &#x27;;&#x27; <span class="keyword">for</span> finalizing (multi-<span class="keyword">line</span>) statements.</span><br></pre></td></tr></table></figure>

<h5 id="Select-查询"><a href="#Select-查询" class="headerlink" title="Select 查询"></a>Select 查询</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Flink <span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="string">&#x27;Hello World&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/img/flink/2cd5b52989398387eaf5e4197cdd0713.jpg" alt="img"></p>
<p>按 “Q” 退出这个界面</p>
<p>打开 <a href="http://127.0.0.1:8081/">http://127.0.0.1:8081</a> 能看到这条 Select 语句产生的查询任务已经结束了。这个查询采用的是读取固定数据集的 Custom Source，输出用的是 Stream Collect Sink，且只输出一条结果。</p>
<p>注意：如果本机的临时目录存在类似 .yarn-properties-baoniu 的文件，任务会提交到 Yarn 上。</p>
<p><img src="/img/flink/971c74361f15e7885cfd9f440664bed5.jpg" alt="img"></p>
<p><img src="/img/flink/56c77f19e723eb4660e1f6a300e48ab0.jpg" alt="img"></p>
<h5 id="Explain"><a href="#Explain" class="headerlink" title="Explain"></a>Explain</h5><p>Explain 命令可以查看 SQL 的执行计划。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Flink <span class="keyword">SQL</span>&gt; <span class="keyword">explain</span> <span class="keyword">SELECT</span> <span class="type">name</span>, COUNT(*) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> (<span class="keyword">VALUES</span> (<span class="string">&#x27;Bob&#x27;</span>), (<span class="string">&#x27;Alice&#x27;</span>), (<span class="string">&#x27;Greg&#x27;</span>), (<span class="string">&#x27;Bob&#x27;</span>)) <span class="keyword">AS</span> NameTable(<span class="type">name</span>) <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="type">name</span>;</span><br><span class="line"> </span><br><span class="line">== Abstract Syntax Tree ==        // 抽象语法树</span><br><span class="line">LogicalAggregate(<span class="keyword">group</span>=[&#123;<span class="number">0</span>&#125;], cnt=[COUNT()])</span><br><span class="line">  LogicalValues(tuples=[[&#123; _UTF<span class="number">-16</span>L<span class="string">E&#x27;Bob  &#x27;</span> &#125;, &#123; _UTF<span class="number">-16</span>L<span class="string">E&#x27;Alice&#x27;</span> &#125;, &#123; _UTF<span class="number">-16</span>L<span class="string">E&#x27;Greg &#x27;</span> &#125;, &#123; _UTF<span class="number">-16</span>L<span class="string">E&#x27;Bob  &#x27;</span> &#125;]])</span><br><span class="line"> </span><br><span class="line">== Optimized Logical Plan ==     // 优化后的逻辑执行计划</span><br><span class="line">DataStreamGroupAggregate(groupBy=[<span class="type">name</span>], <span class="keyword">select</span>=[<span class="type">name</span>, COUNT(*) <span class="keyword">AS</span> cnt])</span><br><span class="line">  DataStreamValues(tuples=[[&#123; _UTF<span class="number">-16</span>L<span class="string">E&#x27;Bob  &#x27;</span> &#125;, &#123; _UTF<span class="number">-16</span>L<span class="string">E&#x27;Alice&#x27;</span> &#125;, &#123; _UTF<span class="number">-16</span>L<span class="string">E&#x27;Greg &#x27;</span> &#125;, &#123; _UTF<span class="number">-16</span>L<span class="string">E&#x27;Bob  &#x27;</span> &#125;]])</span><br><span class="line"> </span><br><span class="line">== Physical Execution Plan ==   // 物理执行计划</span><br><span class="line">Stage <span class="number">3</span> : Data Source</span><br><span class="line">	content : collect elements <span class="keyword">with</span> CollectionInputFormat</span><br><span class="line"> </span><br><span class="line">	Stage <span class="number">5</span> : <span class="keyword">Operator</span></span><br><span class="line">		content : groupBy: (<span class="type">name</span>), <span class="keyword">select</span>: (<span class="type">name</span>, COUNT(*) <span class="keyword">AS</span> cnt)</span><br><span class="line">		ship_strategy : HASH</span><br></pre></td></tr></table></figure>

<h4 id="2-3-2-结果展示"><a href="#2-3-2-结果展示" class="headerlink" title="2.3.2 结果展示"></a>2.3.2 结果展示</h4><p>SQL Client 支持两种模式来维护并展示查询结果：</p>
<ul>
<li>table mode: 在内存中物化查询结果，并以分页 table 形式展示。用户可以通过以下命令启用 table mode;</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SET</span> execution.<span class="attribute">result-mode</span>=table</span><br></pre></td></tr></table></figure>

<ul>
<li>changlog mode: 不会物化查询结果，而是直接对 continuous query 产生的添加和撤回（retractions）结果进行展示。</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">SET</span> execution.<span class="attribute">result-mode</span>=changelog</span><br></pre></td></tr></table></figure>

<p>接下来通过实际的例子进行演示。</p>
<h5 id="Table-mode"><a href="#Table-mode" class="headerlink" title="Table mode"></a>Table mode</h5><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flink <span class="keyword">SQL</span>&gt; <span class="keyword">SET</span> execution.result-mode=<span class="keyword">table</span>;</span><br><span class="line">[<span class="keyword">INFO</span>] <span class="keyword">Session</span> property has been <span class="keyword">set</span>.</span><br><span class="line"> </span><br><span class="line">Flink <span class="keyword">SQL</span>&gt; <span class="keyword">SELECT</span> <span class="type">name</span>, COUNT(*) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> (<span class="keyword">VALUES</span> (<span class="string">&#x27;Bob&#x27;</span>), (<span class="string">&#x27;Alice&#x27;</span>), (<span class="string">&#x27;Greg&#x27;</span>), (<span class="string">&#x27;Bob&#x27;</span>)) <span class="keyword">AS</span> NameTable(<span class="type">name</span>) <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="type">name</span>;</span><br></pre></td></tr></table></figure>

<p>运行结果如下图所示：</p>
<p><img src="/img/flink/9c1ac2e4f5f8bd881d0a164407409c5b.jpg" alt="img"></p>
<p><img src="/img/flink/40383c49764af93f147e210a62a48fc9.jpg" alt="img"></p>
<p><img src="/img/flink/f9bb3e2ad159a8e1df62b4c59d21db83.jpg" alt="img"></p>
<h5 id="Changlog-mode"><a href="#Changlog-mode" class="headerlink" title="Changlog mode"></a>Changlog mode</h5><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Flink <span class="keyword">SQL</span>&gt; <span class="keyword">SET</span> execution.result-mode=changelog;</span><br><span class="line">[<span class="keyword">INFO</span>] <span class="keyword">Session</span> property has been <span class="keyword">set</span>.</span><br><span class="line"> </span><br><span class="line">Flink <span class="keyword">SQL</span>&gt; <span class="keyword">SELECT</span> <span class="type">name</span>, COUNT(*) <span class="keyword">AS</span> cnt <span class="keyword">FROM</span> (<span class="keyword">VALUES</span> (<span class="string">&#x27;Bob&#x27;</span>), (<span class="string">&#x27;Alice&#x27;</span>), (<span class="string">&#x27;Greg&#x27;</span>), (<span class="string">&#x27;Bob&#x27;</span>)) <span class="keyword">AS</span> NameTable(<span class="type">name</span>) <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="type">name</span>;</span><br></pre></td></tr></table></figure>

<p>运行结果如下图所示：</p>
<p><img src="/img/flink/90278520a1aa3009aa27d70d46d7c1bd.jpg" alt="img"></p>
<p>其中 ‘-’ 代表的就是撤回消息。</p>
<p><img src="/img/flink/6dda91cf0c1fc57e97203263f0c4b01c.jpg" alt="img"></p>
<p><img src="/img/flink/3f40a29b10f68dc94fab52327c7d9bfc.jpg" alt="img"></p>
<h4 id="2-3-3-Environment-Files"><a href="#2-3-3-Environment-Files" class="headerlink" title="2.3.3 Environment Files"></a>2.3.3 Environment Files</h4><p>目前的 SQL Client 还不支持 DDL 语句，只能通过 yaml 文件的方式来定义 SQL 查询需要的表，UDF 和运行参数等信息。</p>
<p>首先，准备 env.yaml 和 input.csv 两个文件。</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">➜  flink-<span class="number">1.7</span>.<span class="number">2</span> cat <span class="symbol">/tmp/env.yaml</span></span><br><span class="line"><span class="params">tables:</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> MyTableSource</span><br><span class="line">    <span class="params">type:</span> source-table</span><br><span class="line">    <span class="params">update-mode:</span> append</span><br><span class="line">    <span class="params">connector:</span></span><br><span class="line">      <span class="params">type:</span> filesystem</span><br><span class="line">      <span class="params">path:</span> <span class="string">&quot;/tmp/input.csv&quot;</span></span><br><span class="line">    <span class="params">format:</span></span><br><span class="line">      <span class="params">type:</span> csv</span><br><span class="line">      <span class="params">fields:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> MyField1</span><br><span class="line">          <span class="params">type:</span> INT</span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> MyField2</span><br><span class="line">          <span class="params">type:</span> VARCHAR</span><br><span class="line">      <span class="params">line-delimiter:</span> <span class="string">&quot;<span class="char escape_">\n</span>&quot;</span></span><br><span class="line">      <span class="params">comment-prefix:</span> <span class="string">&quot;#&quot;</span></span><br><span class="line">    <span class="params">schema:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> MyField1</span><br><span class="line">        <span class="params">type:</span> INT</span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> MyField2</span><br><span class="line">        <span class="params">type:</span> VARCHAR</span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> MyCustomView</span><br><span class="line">    <span class="params">type:</span> view</span><br><span class="line">    <span class="params">query:</span> <span class="string">&quot;SELECT MyField2 FROM MyTableSource&quot;</span></span><br><span class="line">  <span class="operator">-</span> <span class="params">name:</span> MyTableSink</span><br><span class="line">    <span class="params">type:</span> sink-table</span><br><span class="line">    <span class="params">update-mode:</span> append</span><br><span class="line">    <span class="params">connector:</span></span><br><span class="line">      <span class="params">type:</span> filesystem</span><br><span class="line">      <span class="params">path:</span> <span class="string">&quot;/tmp/output.csv&quot;</span></span><br><span class="line">    <span class="params">format:</span></span><br><span class="line">      <span class="params">type:</span> csv</span><br><span class="line">      <span class="params">fields:</span></span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> MyField1</span><br><span class="line">          <span class="params">type:</span> INT</span><br><span class="line">        <span class="operator">-</span> <span class="params">name:</span> MyField2</span><br><span class="line">          <span class="params">type:</span> VARCHAR</span><br><span class="line">    <span class="params">schema:</span></span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> MyField1</span><br><span class="line">        <span class="params">type:</span> INT</span><br><span class="line">      <span class="operator">-</span> <span class="params">name:</span> MyField2</span><br><span class="line">        <span class="params">type:</span> VARCHAR</span><br><span class="line">        </span><br><span class="line"><span class="comment"># Execution properties allow for changing the behavior of a table program.</span></span><br><span class="line"> </span><br><span class="line"><span class="params">execution:</span></span><br><span class="line">  <span class="params">type:</span> streaming                   <span class="comment"># required: execution mode either &#x27;batch&#x27; or &#x27;streaming&#x27;</span></span><br><span class="line">  <span class="params">result-mode:</span> table                <span class="comment"># required: either &#x27;table&#x27; or &#x27;changelog&#x27;</span></span><br><span class="line">  <span class="params">max-table-result-rows:</span> <span class="number">1000000</span>    <span class="comment"># optional: maximum number of maintained rows in</span></span><br><span class="line">                                    <span class="comment">#   &#x27;table&#x27; mode (1000000 by default, smaller 1 means unlimited)</span></span><br><span class="line">  <span class="params">time-characteristic:</span> event-time   <span class="comment"># optional: &#x27;processing-time&#x27; or &#x27;event-time&#x27; (default)</span></span><br><span class="line">  <span class="params">parallelism:</span> <span class="number">1</span>                    <span class="comment"># optional: Flink&#x27;s parallelism (1 by default)</span></span><br><span class="line">  <span class="params">periodic-watermarks-interval:</span> <span class="number">200</span> <span class="comment"># optional: interval for periodic watermarks (200 ms by default)</span></span><br><span class="line">  <span class="params">max-parallelism:</span> <span class="number">16</span>               <span class="comment"># optional: Flink&#x27;s maximum parallelism (128 by default)</span></span><br><span class="line">  <span class="params">min-idle-state-retention:</span> <span class="number">0</span>       <span class="comment"># optional: table program&#x27;s minimum idle state time</span></span><br><span class="line">  <span class="params">max-idle-state-retention:</span> <span class="number">0</span>       <span class="comment"># optional: table program&#x27;s maximum idle state time</span></span><br><span class="line">  <span class="params">restart-strategy:</span>                 <span class="comment"># optional: restart strategy</span></span><br><span class="line">    <span class="params">type:</span> fallback                  <span class="comment">#   &quot;fallback&quot; to global restart strategy by default</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># Deployment properties allow for describing the cluster to which table programs are submitted to.</span></span><br><span class="line"> </span><br><span class="line"><span class="params">deployment:</span></span><br><span class="line">  <span class="params">response-timeout:</span> <span class="number">5000</span></span><br><span class="line"> </span><br><span class="line">➜  flink-<span class="number">1.7</span>.<span class="number">2</span> cat <span class="symbol">/tmp/input.csv</span></span><br><span class="line"><span class="number">1</span>,hello</span><br><span class="line"><span class="number">2</span>,world</span><br><span class="line"><span class="number">3</span>,hello world</span><br><span class="line"><span class="number">1</span>,ok</span><br><span class="line"><span class="number">3</span>,bye bye</span><br><span class="line"><span class="number">4</span>,yes</span><br></pre></td></tr></table></figure>

<p>启动 SQL Client：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">➜  flink<span class="number">-1.7</span><span class="number">.2</span> .<span class="operator">/</span>bin<span class="operator">/</span><span class="keyword">sql</span><span class="operator">-</span>client.sh embedded <span class="operator">-</span>e <span class="operator">/</span>tmp<span class="operator">/</span>env.yaml</span><br><span class="line"><span class="keyword">No</span> <span class="keyword">default</span> environment specified.</span><br><span class="line">Searching <span class="keyword">for</span> <span class="string">&#x27;/Users/baoniu/Documents/work/tool/flink/flink-1.7.2/conf/sql-client-defaults.yaml&#x27;</span>...found.</span><br><span class="line">Reading <span class="keyword">default</span> environment <span class="keyword">from</span>: file:<span class="operator">/</span>Users<span class="operator">/</span>baoniu<span class="operator">/</span>Documents<span class="operator">/</span>work<span class="operator">/</span>tool<span class="operator">/</span>flink<span class="operator">/</span>flink<span class="number">-1.7</span><span class="number">.2</span><span class="operator">/</span>conf<span class="operator">/</span><span class="keyword">sql</span><span class="operator">-</span>client<span class="operator">-</span>defaults.yaml</span><br><span class="line">Reading session environment <span class="keyword">from</span>: file:<span class="operator">/</span>tmp<span class="operator">/</span>env.yaml</span><br><span class="line">Validating <span class="keyword">current</span> environment...done.</span><br><span class="line"> </span><br><span class="line">Flink <span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">MyCustomView</span><br><span class="line">MyTableSink</span><br><span class="line">MyTableSource</span><br><span class="line"> </span><br><span class="line">Flink <span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">describe</span> MyTableSource;</span><br><span class="line">root</span><br><span class="line"> <span class="operator">|</span><span class="comment">-- MyField1: Integer</span></span><br><span class="line"> <span class="operator">|</span><span class="comment">-- MyField2: String</span></span><br><span class="line"> </span><br><span class="line">Flink <span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">describe</span> MyCustomView;</span><br><span class="line">root</span><br><span class="line"> <span class="operator">|</span><span class="comment">-- MyField2: String</span></span><br><span class="line"> </span><br><span class="line">Flink <span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">create</span> <span class="keyword">view</span> MyView1 <span class="keyword">as</span> <span class="keyword">select</span> MyField1 <span class="keyword">from</span> MyTableSource;</span><br><span class="line">[INFO] <span class="keyword">View</span> has been created.</span><br><span class="line"> </span><br><span class="line">Flink <span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line">MyCustomView</span><br><span class="line">MyTableSource</span><br><span class="line">MyView1</span><br><span class="line"> </span><br><span class="line">Flink <span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">describe</span> MyView1;</span><br><span class="line">root</span><br><span class="line"> <span class="operator">|</span><span class="comment">-- MyField1: Integer</span></span><br><span class="line"> </span><br><span class="line">Flink <span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> MyTableSource;</span><br></pre></td></tr></table></figure>

<p><img src="/img/flink/26fce572e5077d30ed889f0fbf38d4ab.jpg" alt="img"></p>
<p><img src="/img/flink/8aa67f531a3135ee052491e531016e9b.jpg" alt="img"></p>
<p><img src="/img/flink/a81213ab811aaf27336af7f3e472fe24.jpg" alt="img"></p>
<p>使用 insert into 写入结果表：</p>
<figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Flink SQL&gt; <span class="keyword">insert</span> <span class="keyword">into</span> MyTableSink <span class="keyword">select</span> * <span class="keyword">from</span> MyTableSource;</span><br><span class="line">[INFO] Submitting SQL <span class="keyword">update</span> statement <span class="keyword">to</span> the <span class="keyword">cluster</span>...</span><br><span class="line">[INFO] Table <span class="keyword">update</span> statement has been successfully submitted <span class="keyword">to</span> the <span class="keyword">cluster</span>:</span><br><span class="line"><span class="keyword">Cluster</span> ID: StandaloneClusterId</span><br><span class="line">Job ID: <span class="number">3</span>fac2be1fd891e3e07595c684bb7b7a0</span><br><span class="line">Web interface: http://localhost:<span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/flink/5fa02e54b697970c51dac05ebf4bcce2.jpg" alt="img"></p>
<p><img src="/img/flink/8f93d15d22a784310e68f6ca2149756e.jpg" alt="img"></p>
<p>查询生成的结果数据文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  flink-1.7.2 <span class="built_in">cat</span> /tmp/output.csv</span><br><span class="line">1,hello</span><br><span class="line">2,world</span><br><span class="line">3,hello world</span><br><span class="line">1,ok</span><br><span class="line">3,<span class="built_in">bye</span> <span class="built_in">bye</span></span><br><span class="line">4,<span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<p>也可以在 Environment 文件里面定义 UDF，在 SQL Client 里面通过 「HOW FUNCTIONS」查询和使用，这里就不再说明了。</p>
<p>SQL Client 功能社区还在开发中，详见 <a href="https://cwiki.apache.org/confluence/display/FLINK/FLIP-24+-+SQL+Client">FLIP-24</a>。</p>
<h3 id="2-4-Restful-API"><a href="#2-4-Restful-API" class="headerlink" title="2.4 Restful API"></a>2.4 Restful API</h3><p>接下来我们演示如何通过 Rest API 来提交 Jar 包和执行任务。</p>
<p>更详细的操作请参考 Flink 的 Restful API 文档：<a href="https://ci.apache.org/projects/flink/flink-docs-stable/monitoring/rest_api.html">https://ci.apache.org/projects/flink/flink-docs-stable/monitoring/rest_api.html</a></p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  flink<span class="number">-1.7</span><span class="number">.2</span> curl http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8081</span>/overview</span><br><span class="line">&#123;<span class="string">&quot;taskmanagers&quot;</span>:<span class="number">1</span>,<span class="string">&quot;slots-total&quot;</span>:<span class="number">4</span>,<span class="string">&quot;slots-available&quot;</span>:<span class="number">0</span>,<span class="string">&quot;jobs-running&quot;</span>:<span class="number">3</span>,<span class="string">&quot;jobs-finished&quot;</span>:<span class="number">0</span>,<span class="string">&quot;jobs-cancelled&quot;</span>:<span class="number">0</span>,<span class="string">&quot;jobs-failed&quot;</span>:<span class="number">0</span>,<span class="string">&quot;flink-version&quot;</span>:<span class="string">&quot;1.7.2&quot;</span>,<span class="string">&quot;flink-commit&quot;</span>:<span class="string">&quot;ceba8af&quot;</span>&#125;<span class="comment">%</span></span><br><span class="line"> </span><br><span class="line">➜  flink<span class="number">-1.7</span><span class="number">.2</span> curl -<span class="symbol">X</span> <span class="symbol">POST</span> -<span class="symbol">H</span> <span class="string">&quot;Expect:&quot;</span> -<span class="symbol">F</span> <span class="string">&quot;jarfile=@/Users/baoniu/Documents/work/tool/flink/flink-1.7.2/examples/streaming/TopSpeedWindowing.jar&quot;</span> http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8081</span>/jars/upload</span><br><span class="line">&#123;<span class="string">&quot;filename&quot;</span>:<span class="string">&quot;/var/folders/2b/r6d49pcs23z43b8fqsyz885c0000gn/T/flink-web-124c4895-cf08-4eec-8e15-8263d347efc2/flink-web-upload/6077eca7-6db0-4570-a4d0-4c3e05a5dc59_TopSpeedWindowing.jar&quot;</span>,<span class="string">&quot;status&quot;</span>:<span class="string">&quot;success&quot;</span>&#125;<span class="comment">%       </span></span><br><span class="line">                                                                                                                                                                                                   ➜  flink<span class="number">-1.7</span><span class="number">.2</span> curl http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8081</span>/jars</span><br><span class="line">&#123;<span class="string">&quot;address&quot;</span>:<span class="string">&quot;http://localhost:8081&quot;</span>,<span class="string">&quot;files&quot;</span>:[&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;6077eca7-6db0-4570-a4d0-4c3e05a5dc59_TopSpeedWindowing.jar&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;TopSpeedWindowing.jar&quot;</span>,<span class="string">&quot;uploaded&quot;</span>:<span class="number">1553743438000</span>,<span class="string">&quot;entry&quot;</span>:[&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;org.apache.flink.streaming.examples.windowing.TopSpeedWindowing&quot;</span>,<span class="string">&quot;description&quot;</span>:null&#125;]&#125;]&#125;<span class="comment">%</span></span><br><span class="line">                                                                                                                                         </span><br><span class="line">➜  flink<span class="number">-1.7</span><span class="number">.2</span> curl http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8081</span>/jars/<span class="number">6077</span>eca7<span class="number">-6</span>db0<span class="number">-4570</span>-a4d0<span class="number">-4</span>c3e05a5dc59_TopSpeedWindowing.jar/plan</span><br><span class="line">&#123;<span class="string">&quot;plan&quot;</span>:&#123;<span class="string">&quot;jid&quot;</span>:<span class="string">&quot;41029eb3feb9132619e454ec9b2a89fb&quot;</span>,<span class="string">&quot;name&quot;</span>:<span class="string">&quot;CarTopSpeedWindowingExample&quot;</span>,<span class="string">&quot;nodes&quot;</span>:[&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;90bea66de1c231edf33913ecd54406c1&quot;</span>,<span class="string">&quot;parallelism&quot;</span>:<span class="number">1</span>,<span class="string">&quot;operator&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;operator_strategy&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;description&quot;</span>:<span class="string">&quot;Window(GlobalWindows(), DeltaTrigger, TimeEvictor, ComparableAggregator, PassThroughWindowFunction) -&amp;gt; Sink: Print to Std. Out&quot;</span>,<span class="string">&quot;inputs&quot;</span>:[&#123;<span class="string">&quot;num&quot;</span>:<span class="number">0</span>,<span class="string">&quot;id&quot;</span>:<span class="string">&quot;cbc357ccb763df2852fee8c4fc7d55f2&quot;</span>,<span class="string">&quot;ship_strategy&quot;</span>:<span class="string">&quot;HASH&quot;</span>,<span class="string">&quot;exchange&quot;</span>:<span class="string">&quot;pipelined_bounded&quot;</span>&#125;],<span class="string">&quot;optimizer_properties&quot;</span>:&#123;&#125;&#125;,&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;cbc357ccb763df2852fee8c4fc7d55f2&quot;</span>,<span class="string">&quot;parallelism&quot;</span>:<span class="number">1</span>,<span class="string">&quot;operator&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;operator_strategy&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;description&quot;</span>:<span class="string">&quot;Source: Custom Source -&amp;gt; Timestamps/Watermarks&quot;</span>,<span class="string">&quot;optimizer_properties&quot;</span>:&#123;&#125;&#125;]&#125;&#125;<span class="comment">%                                                                                                                                                    ➜  flink-1.7.2 curl -X POST http://127.0.0.1:8081/jars/6077eca7-6db0-4570-a4d0-4c3e05a5dc59_TopSpeedWindowing.jar/run</span></span><br><span class="line">&#123;<span class="string">&quot;jobid&quot;</span>:<span class="string">&quot;04d80a24b076523d3dc5fbaa0ad5e1ad&quot;</span>&#125;<span class="comment">%</span></span><br></pre></td></tr></table></figure>

<p><img src="/img/flink/63d7b8e1298072a33e3da4b700063b5f.jpg" alt="img"></p>
<p><img src="/img/flink/e3b8a48a4cb48af310fec05be971207d.jpg" alt="img"></p>
<p>Restful API 还提供了很多监控和 Metrics 相关的功能，对于任务提交的操作也支持的比较全面。</p>
<h3 id="2-5-Web"><a href="#2-5-Web" class="headerlink" title="2.5 Web"></a>2.5 Web</h3><p>在 Flink Dashboard 页面左侧可以看到有个「Submit new Job」的地方，用户可以上传 Jar 包和显示执行计划和提交任务。Web 提交功能主要用于新手入门和演示用。</p>
<p><img src="/img/flink/72dddcb88874256dcfe2564ecc7ebc42.jpg" alt="img"></p>
<h2 id="3-结语"><a href="#3-结语" class="headerlink" title="3. 结语"></a>3. 结语</h2><p>本文主要讲解了 Flink 的 5 种任务提交的方式。熟练掌握各种任务提交方式，有利于提高我们日常的开发和运维效率。</p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2019/07/100477.html" class="pre-post btn btn-default" title='Flink Scala REPL'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">Flink Scala REPL</span>
        </a>
    
    
        <a href="/archives/2019/07/100475.html" class="next-post btn btn-default" title='Flink DataStream API编程'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">Flink DataStream API编程</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>


    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%A6%82%E8%A6%81"><span class="toc-text">1. 概要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Flink-%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%93%8D%E4%BD%9C"><span class="toc-text">2.Flink 客户端操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Flink-%E5%91%BD%E4%BB%A4%E8%A1%8C"><span class="toc-text">2.1 Flink 命令行</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-1-Standalone"><span class="toc-text">2.1.1 Standalone</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Run"><span class="toc-text">Run</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#List"><span class="toc-text">List</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Stop"><span class="toc-text">Stop</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Cancel"><span class="toc-text">Cancel</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Savepoint"><span class="toc-text">Savepoint</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Modify"><span class="toc-text">Modify</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Info"><span class="toc-text">Info</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-2-Yarn-per-job"><span class="toc-text">2.1.2 Yarn per-job</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%95%E4%BB%BB%E5%8A%A1-Attach-%E6%A8%A1%E5%BC%8F"><span class="toc-text">单任务 Attach 模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%95%E4%BB%BB%E5%8A%A1-Detached-%E6%A8%A1%E5%BC%8F"><span class="toc-text">单任务 Detached 模式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-3-Yarn-session"><span class="toc-text">2.1.3 Yarn session</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-Session"><span class="toc-text">启动 Session</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E4%BB%BB%E5%8A%A1"><span class="toc-text">提交任务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E5%88%B0%E6%8C%87%E5%AE%9A%E7%9A%84-Session"><span class="toc-text">提交到指定的 Session</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Scala-Shell"><span class="toc-text">2.2 Scala Shell</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-Deploy"><span class="toc-text">2.2.1 Deploy</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Local"><span class="toc-text">Local</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Remote"><span class="toc-text">Remote</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Yarn"><span class="toc-text">Yarn</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-Execute"><span class="toc-text">2.2.2 Execute</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#DataSet"><span class="toc-text">DataSet</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#DataStream"><span class="toc-text">DataStream</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#TableAPI"><span class="toc-text">TableAPI</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-SQL-Client-Beta"><span class="toc-text">2.3 SQL Client Beta</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-1-%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-text">2.3.1 基本用法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Select-%E6%9F%A5%E8%AF%A2"><span class="toc-text">Select 查询</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Explain"><span class="toc-text">Explain</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-2-%E7%BB%93%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-text">2.3.2 结果展示</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Table-mode"><span class="toc-text">Table mode</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Changlog-mode"><span class="toc-text">Changlog mode</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-3-Environment-Files"><span class="toc-text">2.3.3 Environment Files</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-Restful-API"><span class="toc-text">2.4 Restful API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-Web"><span class="toc-text">2.5 Web</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E7%BB%93%E8%AF%AD"><span class="toc-text">3. 结语</span></a></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2025&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>








<script src="/js/app.js?rev=@@hash.js"></script>


</body>
</html>