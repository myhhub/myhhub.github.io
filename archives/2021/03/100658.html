<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="c++,cmake,qt">


    <meta name="description" content="本章的主要内容如下：

使用函数和宏重用代码
将CMake源代码分成模块
编写函数来测试和设置编译器标志
用指定参数定义函数或宏
重新定义函数和宏
使用废弃函数、宏和变量
add_subdire...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>CMake 完整使用教程 之八 构建项目 | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx">


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="CMake 完整使用教程 之八 构建项目">
            
	            CMake 完整使用教程 之八 构建项目
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/back/">后端</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/c/">c++</a> <a class="tag-link" href="/tags/cmake/">cmake</a> <a class="tag-link" href="/tags/qt/">qt</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2021/03/29</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>1059</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <p>本章的主要内容如下：</p>
<ul>
<li>使用函数和宏重用代码</li>
<li>将CMake源代码分成模块</li>
<li>编写函数来测试和设置编译器标志</li>
<li>用指定参数定义函数或宏</li>
<li>重新定义函数和宏</li>
<li>使用废弃函数、宏和变量</li>
<li>add_subdirectory的限定范围</li>
<li>使用target_sources避免全局变量</li>
<li>组织Fortran项目</li>
</ul>
<p>前几章中，我们已经使用了一些CMake构建块来配置和构建的项目。本章中，我们将讨论如何组合这些构建块，并引入抽象，并最小化代码重复、全局变量、全局状态和显式排序，以免CMakeLists.txt文件过于庞大。目标是为模块化CMake代码结构和限制变量范围提供模式。我们将讨论一些策略，也将帮助我们控制中大型代码项目的CMake代码复杂性。</p>
<h1 id="7-1-使用函数和宏重用代码"><a href="#7-1-使用函数和宏重用代码" class="headerlink" title="7.1 使用函数和宏重用代码"></a>7.1 使用函数和宏重用代码</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-01" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-01</a> 中找到，其中包含一个C++例子。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>任何编程语言中，函数允许我们抽象(隐藏)细节并避免代码重复，CMake也不例外。本示例中，我们将以宏和函数为例进行讨论，并介绍一个宏，以便方便地定义测试和设置测试的顺序。我们的目标是定义一个宏，能够替换<code>add_test</code>和<code>set_tests_properties</code>，用于定义每组和设置每个测试的预期开销(第4章，第8节)。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>我们将基于第4章第2节中的例子。<code>main.cpp</code>、<code>sum_integers.cpp</code>和<code>sum_integers.hpp</code>文件不变，用来计算命令行参数提供的整数队列的和。单元测试(<code>test.cpp</code>)的源代码也没有改变。我们还需要Catch 2头文件，<code>catch.hpp</code>。与第4章相反，我们将把源文件放到子目录中，并形成以下文件树(稍后我们将讨论CMake代码):</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── src</span><br><span class="line">│     ├── CMakeLists.txt</span><br><span class="line">│     ├── main.cpp</span><br><span class="line">│     ├── sum_integers.cpp</span><br><span class="line">│     └── sum_integers.hpp</span><br><span class="line">└── tests</span><br><span class="line">      ├── catch.hpp</span><br><span class="line">      ├── CMakeLists.txt</span><br><span class="line">      └── test.cpp</span><br></pre></td></tr></table></figure>
<h2 id="具体实施"><a href="#具体实施" class="headerlink" title="具体实施"></a>具体实施</h2><ol>
<li><p>定义了CMake最低版本、项目名称和支持的语言，并要求支持C++11标准:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">cmake_minimum_required</span><span class="params">(VERSION <span class="number">3.5</span> FATAL_ERROR)</span></span></span><br><span class="line"><span class="function"><span class="title">project</span><span class="params">(recipe-<span class="number">01</span> LANGUAGES CXX)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_STANDARD <span class="number">11</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_EXTENSIONS OFF)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_STANDARD_REQUIRED ON)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>根据GNU标准定义<code>binary</code>和<code>library</code>路径:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">include(GNUInstallDirs)</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">set</span>(CMAKE_ARCHIVE_OUTPUT_DIRECTORY</span><br><span class="line">	<span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/<span class="variable">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>)</span><br><span class="line"><span class="builtin-name">set</span>(CMAKE_LIBRARY_OUTPUT_DIRECTORY</span><br><span class="line">	<span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/<span class="variable">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>)</span><br><span class="line"><span class="builtin-name">set</span>(CMAKE_RUNTIME_OUTPUT_DIRECTORY</span><br><span class="line">	<span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/<span class="variable">$&#123;CMAKE_INSTALL_BINDIR&#125;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，使用<code>add_subdirectory</code>调用<code>src/CMakeLists.txt</code>和<code>tests/CMakeLists.txt</code>:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(src)</span></span></span><br><span class="line"><span class="function"><span class="title">enable_testing</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(tests)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>src/CMakeLists.txt</code>定义了源码目标:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_INCLUDE_CURRENT_DIR_IN_INTERFACE ON)</span></span></span><br><span class="line"><span class="function"><span class="title">add_library</span><span class="params">(sum_integers sum_integers.cpp)</span></span></span><br><span class="line"><span class="function"><span class="title">add_executable</span><span class="params">(sum_up main.cpp)</span></span></span><br><span class="line"><span class="function"><span class="title">target_link_libraries</span><span class="params">(sum_up sum_integers)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>tests/CMakeLists.txt</code>中，构建并链接<code>cpp_test</code>可执行文件:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_executable</span><span class="params">(cpp_test test.cpp)</span></span></span><br><span class="line"><span class="function"><span class="title">target_link_libraries</span><span class="params">(cpp_test sum_integers)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>定义一个新宏<code>add_catch_test</code>:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">macro</span>(add_catch_test _name _cost)</span><br><span class="line">  <span class="keyword">math</span>(EXPR num_macro_calls <span class="string">"$&#123;num_macro_calls&#125; + 1"</span>)</span><br><span class="line">  <span class="keyword">message</span>(STATUS <span class="string">"add_catch_test called with $&#123;ARGC&#125; arguments: $&#123;ARGV&#125;"</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">set</span>(_argn <span class="string">"$&#123;ARGN&#125;"</span>)</span><br><span class="line">  <span class="keyword">if</span>(_argn)</span><br><span class="line">  	<span class="keyword">message</span>(STATUS <span class="string">"oops - macro received argument(s) we did not expect: $&#123;ARGN&#125;"</span>)</span><br><span class="line">  <span class="keyword">endif</span>()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">add_test</span>(</span><br><span class="line">    NAME</span><br><span class="line">      <span class="variable">$&#123;_name&#125;</span></span><br><span class="line">    <span class="keyword">COMMAND</span></span><br><span class="line">      $&lt;TARGET_FILE:cpp_test&gt;</span><br><span class="line">    [<span class="variable">$&#123;_name&#125;</span>] --success --out</span><br><span class="line">    <span class="variable">$&#123;PROJECT_BINARY_DIR&#125;</span>/tests/<span class="variable">$&#123;_name&#125;</span>.log --durations yes</span><br><span class="line">    WORKING_DIRECTORY</span><br><span class="line">      <span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span></span><br><span class="line">    )</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">set_tests_properties</span>(</span><br><span class="line">    <span class="variable">$&#123;_name&#125;</span></span><br><span class="line">    PROPERTIES</span><br><span class="line">    	COST <span class="variable">$&#123;_cost&#125;</span></span><br><span class="line">    )</span><br><span class="line"><span class="keyword">endmacro</span>()</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，使用<code>add_catch_test</code>定义了两个测试。此外，还设置和打印了变量的值:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(num_macro_calls <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">add_catch_test</span><span class="params">(short <span class="number">1.5</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">add_catch_test</span><span class="params">(long <span class="number">2.5</span> extra_argument)</span></span></span><br><span class="line"><span class="function"><span class="title">message</span><span class="params">(STATUS <span class="string">"in total there were $&#123;num_macro_calls&#125; calls to add_catch_test"</span>)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>现在，进行测试。配置项目(输出行如下所示):</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p <span class="keyword">build</span></span><br><span class="line"><span class="keyword">$ </span>cd <span class="keyword">build</span></span><br><span class="line"><span class="keyword">$ </span>cmake ..</span><br><span class="line"></span><br><span class="line">-- ...</span><br><span class="line">-- <span class="keyword">add_catch_test </span>called with <span class="number">2</span> arguments: <span class="keyword">short;1.5</span></span><br><span class="line"><span class="keyword">-- </span><span class="keyword">add_catch_test </span>called with <span class="number">3</span> arguments: long<span class="comment">;2.5;extra_argument</span></span><br><span class="line">-- oops - macro received argument(s) we <span class="keyword">did </span>not expect: <span class="keyword">extra_argument</span></span><br><span class="line"><span class="keyword">-- </span>in total there were <span class="number">2</span> calls to <span class="keyword">add_catch_test</span></span><br><span class="line"><span class="keyword">-- </span>...</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，构建并运行测试:</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>cmake --build .</span><br><span class="line"><span class="variable">$ </span>ctest</span><br></pre></td></tr></table></figure>
</li>
<li><p>长时间的测试会先开始:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Start 2: long</span><br><span class="line">1/2 Test #2: long <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>. Passed 0.00 sec</span><br><span class="line">Start 1: short</span><br><span class="line">2/2 Test #1: short <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.00 sec</span><br><span class="line"></span><br><span class="line">100% tests passed, 0 tests failed out of 2</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>这个配置中的新添加了<code>add_catch_test</code>宏。这个宏需要两个参数<code>_name</code>和<code>_cost</code>，可以在宏中使用这些参数来调用<code>add_test</code>和<code>set_tests_properties</code>。参数前面的下划线，是为了向读者表明这些参数只能在宏中访问。另外，宏自动填充了<code>${ARGC}</code>(参数数量)和<code>${ARGV}</code>(参数列表)，我们可以在输出中验证了这一点:</p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- add_catch_test called <span class="keyword">with</span> <span class="number">2</span> arguments: <span class="built_in">short</span>;<span class="number">1.5</span></span><br><span class="line">-- add_catch_test called <span class="keyword">with</span> <span class="number">3</span> arguments: <span class="built_in">long</span>;<span class="number">2.5</span>;extra_argument</span><br></pre></td></tr></table></figure>
<p>宏还定义了<code>${ARGN}</code>，用于保存最后一个参数之后的参数列表。此外，我们还可以使用<code>${ARGV0}</code>、<code>${ARGV1}</code>等来处理参数。我们演示一下，如何捕捉到调用中的额外参数(<code>extra_argument</code>):</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_catch_test</span><span class="params">(long <span class="number">2.5</span> extra_argument)</span></span></span><br></pre></td></tr></table></figure>
<p>我们使用了以下方法:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(_argn <span class="string">"$&#123;ARGN&#125;"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">if</span><span class="params">(_argn)</span></span></span><br><span class="line">	message(STATUS <span class="string">"oops - macro received argument(s) we did not expect: $&#123;ARGN&#125;"</span>)</span><br><span class="line"><span class="function"><span class="title">endif</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>这个<code>if</code>语句中，我们引入一个新变量，但不能直接查询<code>ARGN</code>，因为它不是通常意义上的CMake变量。使用这个宏，我们可以通过它们的名称和命令来定义测试，还可以指示预期的开销，这会让耗时长的测试在耗时短测试之前启动，这要归功于<code>COST</code>属性。</p>
<p>我们可以用一个函数来实现它，而不是使用相同语法的宏:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">function</span><span class="params">(add_catch_test _name _cost)</span></span></span><br><span class="line">	...</span><br><span class="line"><span class="function"><span class="title">endfunction</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>宏和函数之间的区别在于它们的变量范围。宏在调用者的范围内执行，而函数有自己的变量范围。换句话说，如果我们使用宏，需要设置或修改对调用者可用的变量。如果不去设置或修改输出变量，最好使用函数。我们注意到，可以在函数中修改父作用域变量，但这必须使用<code>PARENT_SCOPE</code>显式表示:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(variable_visible_outside <span class="string">"some value"</span> PARENT_SCOPE)</span></span></span><br></pre></td></tr></table></figure>
<p>为了演示作用域，我们在定义宏之后编写了以下调用:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(num_macro_calls <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">add_catch_test</span><span class="params">(short <span class="number">1.5</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">add_catch_test</span><span class="params">(long <span class="number">2.5</span> extra_argument)</span></span></span><br><span class="line"><span class="function"><span class="title">message</span><span class="params">(STATUS <span class="string">"in total there were $&#123;num_macro_calls&#125; calls to add_catch_test"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>在宏内部，将<code>num_macro_calls</code>加1:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">math</span><span class="params">(EXPR num_macro_calls <span class="string">"$&#123;num_macro_calls&#125; + 1"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>这时产生的输出:</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-- <span class="keyword">in</span> total there were <span class="number">2</span> calls <span class="keyword">to</span> add_catch_test</span><br></pre></td></tr></table></figure>
<p>如果我们将宏更改为函数，测试仍然可以工作，但是<code>num_macro_calls</code>在父范围内的所有调用中始终为0。将CMake宏想象成类似函数是很有用的，这些函数被直接替换到它们被调用的地方(在C语言中内联)。将CMake函数想象成黑盒函数很有必要。黑盒中，除非显式地将其定义为<code>PARENT_SCOPE</code>，否则不会返回任何内容。CMake中的函数没有返回值。</p>
<h2 id="更多信息"><a href="#更多信息" class="headerlink" title="更多信息"></a>更多信息</h2><p>可以在宏中嵌套函数调用，也可以在函数中嵌套宏调用，但是这就需要仔细考虑变量的作用范围。如果功能可以使用函数实现，那么这可能比宏更好，因为它对父范围状态提供了更多的默认控制。</p>
<p>我们还应该提到在<code>src/cmakelist .txt</code>中使用<code>CMAKE_INCLUDE_CURRENT_DIR_IN_INTERFACE</code>:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_INCLUDE_CURRENT_DIR_IN_INTERFACE ON)</span></span></span><br></pre></td></tr></table></figure>
<p>这个命令会将当前目录，添加到<code>CMakeLists.txt</code>中定义的所有目标的<code>interface_include_directory</code>属性中。换句话说，我们不需要使用<code>target_include_directory</code>来添加<code>cpp_test</code>所需头文件的位置。</p>
<h1 id="7-2-将CMake源代码分成模块"><a href="#7-2-将CMake源代码分成模块" class="headerlink" title="7.2 将CMake源代码分成模块"></a>7.2 将CMake源代码分成模块</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-02" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-02</a> 中找到。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>项目通常从单个<code>CMakeLists.txt</code>文件开始，随着时间的推移，这个文件会逐渐增长。本示例中，我们将演示一种将<code>CMakeLists.txt</code>分割成更小单元的机制。将<code>CMakeLists.txt</code>拆分为模块有几个动机，这些模块可以包含在主<code>CMakeLists.txt</code>或其他模块中:</p>
<ul>
<li>主<code>CMakeLists.txt</code>更易于阅读。</li>
<li>CMake模块可以在其他项目中重用。</li>
<li>与函数相结合，模块可以帮助我们限制变量的作用范围。</li>
</ul>
<p>本示例中，我们将演示如何定义和包含一个宏，该宏允许我们获得CMake的彩色输出(用于重要的状态消息或警告)。</p>
<h2 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h2><p>本例中，我们将使用两个文件，主<code>CMakeLists.txt</code>和<code>cmake/colors.cmake</code>:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── <span class="selector-tag">cmake</span></span><br><span class="line">│     └── <span class="selector-tag">colors</span><span class="selector-class">.cmake</span></span><br><span class="line">└── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br></pre></td></tr></table></figure>
<p><code>cmake/colors.cmake</code>文件包含彩色输出的定义:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># colorize CMake output</span></span><br><span class="line"><span class="comment"># code adapted from stackoverflow: http://stackoverflow.com/a/19578320</span></span><br><span class="line"><span class="comment"># from post authored by https://stackoverflow.com/users/2556117/fraser</span></span><br><span class="line">macro(define_colors)</span><br><span class="line">  <span class="keyword">if</span>(WIN32)</span><br><span class="line">    # has <span class="literal">no</span> effect on WIN32</span><br><span class="line">    <span class="builtin-name">set</span>(ColourReset <span class="string">""</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(ColourBold <span class="string">""</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(Red <span class="string">""</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(Green <span class="string">""</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(Yellow <span class="string">""</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(Blue <span class="string">""</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(Magenta <span class="string">""</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(Cyan <span class="string">""</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(White <span class="string">""</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(BoldRed <span class="string">""</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(BoldGreen <span class="string">""</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(BoldYellow <span class="string">""</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(BoldBlue <span class="string">""</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(BoldMagenta <span class="string">""</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(BoldCyan <span class="string">""</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(BoldWhite <span class="string">""</span>)</span><br><span class="line">  <span class="keyword">else</span>()</span><br><span class="line">    string(ASCII 27 Esc)</span><br><span class="line">    <span class="builtin-name">set</span>(ColourReset <span class="string">"<span class="variable">$&#123;Esc&#125;</span>[m"</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(ColourBold <span class="string">"<span class="variable">$&#123;Esc&#125;</span>[1m"</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(Red <span class="string">"<span class="variable">$&#123;Esc&#125;</span>[31m"</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(Green <span class="string">"<span class="variable">$&#123;Esc&#125;</span>[32m"</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(Yellow <span class="string">"<span class="variable">$&#123;Esc&#125;</span>[33m"</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(Blue <span class="string">"<span class="variable">$&#123;Esc&#125;</span>[34m"</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(Magenta <span class="string">"<span class="variable">$&#123;Esc&#125;</span>[35m"</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(Cyan <span class="string">"<span class="variable">$&#123;Esc&#125;</span>[36m"</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(White <span class="string">"<span class="variable">$&#123;Esc&#125;</span>[37m"</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(BoldRed <span class="string">"<span class="variable">$&#123;Esc&#125;</span>[1;31m"</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(BoldGreen <span class="string">"<span class="variable">$&#123;Esc&#125;</span>[1;32m"</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(BoldYellow <span class="string">"<span class="variable">$&#123;Esc&#125;</span>[1;33m"</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(BoldBlue <span class="string">"<span class="variable">$&#123;Esc&#125;</span>[1;34m"</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(BoldMagenta <span class="string">"<span class="variable">$&#123;Esc&#125;</span>[1;35m"</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(BoldCyan <span class="string">"<span class="variable">$&#123;Esc&#125;</span>[1;36m"</span>)</span><br><span class="line">    <span class="builtin-name">set</span>(BoldWhite <span class="string">"<span class="variable">$&#123;Esc&#125;</span>[1;37m"</span>)</span><br><span class="line">  endif()</span><br><span class="line">endmacro()</span><br></pre></td></tr></table></figure>
<h2 id="具体实施-1"><a href="#具体实施-1" class="headerlink" title="具体实施"></a>具体实施</h2><p>来看下我们如何使用颜色定义，来生成彩色状态消息:</p>
<ol>
<li><p>从一个熟悉的头部开始:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">cmake_minimum_required</span><span class="params">(VERSION <span class="number">3.5</span> FATAL_ERROR)</span></span></span><br><span class="line"><span class="function"><span class="title">project</span><span class="params">(recipe-<span class="number">02</span> LANGUAGES NONE)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，将<code>cmake</code>子目录添加到CMake模块搜索的路径列表中:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">list</span><span class="params">(APPEND CMAKE_MODULE_PATH <span class="string">"$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/cmake"</span>)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>包括<code>colors.cmake</code>模块，调用其中定义的宏:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">include</span><span class="params">(colors)</span></span></span><br><span class="line"><span class="function"><span class="title">define_colors</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，打印了不同颜色的信息:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">message</span><span class="params">(STATUS <span class="string">"This is a normal message"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">message</span><span class="params">(STATUS <span class="string">"$&#123;Red&#125;This is a red$&#123;ColourReset&#125;"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">message</span><span class="params">(STATUS <span class="string">"$&#123;BoldRed&#125;This is a bold red$&#123;ColourReset&#125;"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">message</span><span class="params">(STATUS <span class="string">"$&#123;Green&#125;This is a green$&#123;ColourReset&#125;"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">message</span><span class="params">(STATUS <span class="string">"$&#123;BoldMagenta&#125;This is bold$&#123;ColourReset&#125;"</span>)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试一下(如果使用macOS或Linux，以下的输出应该出现屏幕上):<a href="https://github.com/xiaoweiChen/CMake-Cookbook/blob/master/images/chapter7/7-2-1.png" target="_blank" rel="noopener"><img src="https://github.com/xiaoweiChen/CMake-Cookbook/raw/master/images/chapter7/7-2-1.png" alt="img"></a></p>
</li>
</ol>
<h2 id="工作原理-1"><a href="#工作原理-1" class="headerlink" title="工作原理"></a>工作原理</h2><p>这个例子中，不需要编译代码，也不需要语言支持，我们已经用<code>LANGUAGES NONE</code>明确了这一点：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">project</span><span class="params">(recipe-<span class="number">02</span> LANGUAGES NONE)</span></span></span><br></pre></td></tr></table></figure>
<p>我们定义了<code>define_colors</code>宏，并将其放在<code>cmake/colors.cmake</code>。因为还是希望使用调用宏中定义的变量，来更改消息中的颜色，所以我们选择使用宏而不是函数。我们使用以下行包括宏和调用<code>define_colors</code>:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">include</span><span class="params">(colors)</span></span></span><br><span class="line"><span class="function"><span class="title">define_colors</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>我们还需要告诉CMake去哪里查找宏:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">list</span><span class="params">(APPEND CMAKE_MODULE_PATH <span class="string">"$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/cmake"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p><code>include(colors)</code>命令指示CMake搜索<code>${CMAKE_MODULE_PATH}</code>，查找名称为<code>colors.cmake</code>的模块。</p>
<p>例子中，我们没有按以下的方式进行：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">list</span><span class="params">(APPEND CMAKE_MODULE_PATH <span class="string">"$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/cmake"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">include</span><span class="params">(colors)</span></span></span><br></pre></td></tr></table></figure>
<p>而是使用一个显式包含的方式:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">include</span><span class="params">(cmake/colors.cmake)</span></span></span><br></pre></td></tr></table></figure>
<h2 id="更多信息-1"><a href="#更多信息-1" class="headerlink" title="更多信息"></a>更多信息</h2><p>推荐的做法是在模块中定义宏或函数，然后调用宏或函数。将包含模块用作函数调用不是很好的方式。除了定义函数和宏以及查找程序、库和路径之外，包含模块不应该做更多的事情。实际的<code>include</code>命令不应该定义或修改变量，其原因是重复的<code>include</code>(可能是偶然的)不应该引入任何不想要的副作用。在第5节中，我们将创建一个防止多次包含的保护机制。</p>
<h1 id="7-3-编写函数来测试和设置编译器标志"><a href="#7-3-编写函数来测试和设置编译器标志" class="headerlink" title="7.3 编写函数来测试和设置编译器标志"></a>7.3 编写函数来测试和设置编译器标志</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-03" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-03</a> 中找到，其中包含一个C/C++示例。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>前两个示例中，我们使用了宏。本示例中，将使用一个函数来抽象细节并避免代码重复。我们将实现一个接受编译器标志列表的函数。该函数将尝试用这些标志逐个编译测试代码，并返回编译器理解的第一个标志。这样，我们将了解几个新特性：函数、列表操作、字符串操作，以及检查编译器是否支持相应的标志。</p>
<h2 id="准备工作-2"><a href="#准备工作-2" class="headerlink" title="准备工作"></a>准备工作</h2><p>按照上一个示例的推荐，我们将在(<code>set_compiler_flag.cmake</code>)模块中定义函数，然后调用函数。该模块包含以下代码，我们将在后面详细讨论:</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">include(CheckCCompilerFlag)</span><br><span class="line">include(CheckCXXCompilerFlag)</span><br><span class="line">include(CheckFortranCompilerFlag)</span><br><span class="line">function(set_compiler_flag <span class="variable">_result</span> <span class="variable">_lang</span>)</span><br><span class="line">  <span class="meta"># build a list of flags from the arguments</span></span><br><span class="line">  <span class="built_in">set</span>(<span class="variable">_list_of_flags</span>)</span><br><span class="line">  <span class="meta"># also figure out whether the function</span></span><br><span class="line">  <span class="meta"># is required to find a flag</span></span><br><span class="line">  <span class="built_in">set</span>(<span class="variable">_flag_is_required</span> <span class="literal">FALSE</span>)</span><br><span class="line">  <span class="keyword">foreach</span>(<span class="variable">_arg</span> <span class="built_in">IN</span> <span class="built_in">ITEMS</span> $&#123;ARGN&#125;)</span><br><span class="line">  	string(<span class="built_in">TOUPPER</span> <span class="string">"$&#123;_arg&#125;"</span> <span class="variable">_arg_uppercase</span>)</span><br><span class="line">  	<span class="keyword">if</span>(<span class="variable">_arg_uppercase</span> STREQUAL <span class="string">"REQUIRED"</span>)</span><br><span class="line">  		<span class="built_in">set</span>(<span class="variable">_flag_is_required</span> <span class="literal">TRUE</span>)</span><br><span class="line">  	<span class="keyword">else</span>()</span><br><span class="line">  		<span class="built_in">list</span>(<span class="built_in">APPEND</span> <span class="variable">_list_of_flags</span> <span class="string">"$&#123;_arg&#125;"</span>)</span><br><span class="line">  	endif()</span><br><span class="line">  endforeach()</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">set</span>(<span class="variable">_flag_found</span> <span class="literal">FALSE</span>)</span><br><span class="line">  <span class="meta"># loop over all flags, try to find the first which works</span></span><br><span class="line">  <span class="keyword">foreach</span>(<span class="built_in">flag</span> <span class="built_in">IN</span> <span class="built_in">ITEMS</span> $&#123;<span class="variable">_list_of_flags</span>&#125;)</span><br><span class="line">  	unset(<span class="variable">_flag_works</span> CACHE)</span><br><span class="line">  	<span class="keyword">if</span>(<span class="variable">_lang</span> STREQUAL <span class="string">"C"</span>)</span><br><span class="line">  		check_c_compiler_flag(<span class="string">"$&#123;flag&#125;"</span> <span class="variable">_flag_works</span>)</span><br><span class="line">  	elseif(<span class="variable">_lang</span> STREQUAL <span class="string">"CXX"</span>)</span><br><span class="line">  		check_cxx_compiler_flag(<span class="string">"$&#123;flag&#125;"</span> <span class="variable">_flag_works</span>)</span><br><span class="line">  	elseif(<span class="variable">_lang</span> STREQUAL <span class="string">"Fortran"</span>)</span><br><span class="line">  		check_Fortran_compiler_flag(<span class="string">"$&#123;flag&#125;"</span> <span class="variable">_flag_works</span>)</span><br><span class="line">  	<span class="keyword">else</span>()</span><br><span class="line">  		message(FATAL_ERROR <span class="string">"Unknown language in set_compiler_flag: $&#123;_lang&#125;"</span>)</span><br><span class="line"> 	 	endif()</span><br><span class="line">  </span><br><span class="line">    <span class="meta"># <span class="meta-keyword">if</span> the flag works, use it, and exit</span></span><br><span class="line">    <span class="meta"># otherwise try next flag</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">_flag_works</span>)</span><br><span class="line">      <span class="built_in">set</span>($&#123;<span class="variable">_result</span>&#125; <span class="string">"$&#123;flag&#125;"</span> PARENT_SCOPE)</span><br><span class="line">      <span class="built_in">set</span>(<span class="variable">_flag_found</span> <span class="literal">TRUE</span>)</span><br><span class="line">      break()</span><br><span class="line">    endif()</span><br><span class="line">  endforeach()</span><br><span class="line">  </span><br><span class="line">  <span class="meta"># raise an <span class="meta-keyword">error</span> <span class="meta-keyword">if</span> no flag was found</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="variable">_flag_is_required</span> <span class="built_in">AND</span> <span class="built_in">NOT</span> <span class="variable">_flag_found</span>)</span><br><span class="line">  	message(FATAL_ERROR <span class="string">"None of the required flags were supported"</span>)</span><br><span class="line">  endif()</span><br><span class="line">endfunction()</span><br></pre></td></tr></table></figure>
<h2 id="具体实施-2"><a href="#具体实施-2" class="headerlink" title="具体实施"></a>具体实施</h2><p>展示如何在CMakeLists.txt中使用<code>set_compiler_flag</code>函数:</p>
<ol>
<li><p>定义最低CMake版本、项目名称和支持的语言(本例中是C和C++):</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">cmake_minimum_required</span><span class="params">(VERSION <span class="number">3.5</span> FATAL_ERROR)</span></span></span><br><span class="line"><span class="function"><span class="title">project</span><span class="params">(recipe-<span class="number">03</span> LANGUAGES C CXX)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>显示包含<code>set_compiler_flag.cmake</code>:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">include</span><span class="params">(set_compiler_flag.cmake)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试C标志列表:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">set_compiler_flag(</span><br><span class="line">  working_compile_flag C REQUIRED</span><br><span class="line">  <span class="string">"-foo"</span> <span class="comment"># this should fail</span></span><br><span class="line">  <span class="string">"-wrong"</span> <span class="comment"># this should fail</span></span><br><span class="line">  <span class="string">"-wrong"</span> <span class="comment"># this should fail</span></span><br><span class="line">  <span class="string">"-Wall"</span> <span class="comment"># this should work with GNU</span></span><br><span class="line">  <span class="string">"-warn all"</span> <span class="comment"># this should work with Intel</span></span><br><span class="line">  <span class="string">"-Minform=inform"</span> <span class="comment"># this should work with PGI</span></span><br><span class="line">  <span class="string">"-nope"</span> <span class="comment"># this should fail</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">message(STATUS <span class="string">"working C compile flag: <span class="variable">$&#123;working_compile_flag&#125;</span>"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试C++标志列表:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">set_compiler_flag(</span><br><span class="line">  working_compile_flag CXX REQUIRED</span><br><span class="line">  <span class="string">"-foo"</span> <span class="comment"># this should fail</span></span><br><span class="line">  <span class="string">"-g"</span> <span class="comment"># this should work with GNU, Intel, PGI</span></span><br><span class="line">  <span class="string">"/RTCcsu"</span> <span class="comment"># this should work with MSVC</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">message(STATUS <span class="string">"working CXX compile flag: <span class="variable">$&#123;working_compile_flag&#125;</span>"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在，我们可以配置项目并验证输出。只显示相关的输出，相应的输出可能会因编译器的不同而有所不同:</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p build</span><br><span class="line">$ cd build</span><br><span class="line">$ cmake ..</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ...</span></span><br><span class="line"><span class="comment">-- Performing Test _flag_works</span></span><br><span class="line"><span class="comment">-- Performing Test _flag_works - Failed</span></span><br><span class="line"><span class="comment">-- Performing Test _flag_works</span></span><br><span class="line"><span class="comment">-- Performing Test _flag_works - Failed</span></span><br><span class="line"><span class="comment">-- Performing Test _flag_works</span></span><br><span class="line"><span class="comment">-- Performing Test _flag_works - Failed</span></span><br><span class="line"><span class="comment">-- Performing Test _flag_works</span></span><br><span class="line"><span class="comment">-- Performing Test _flag_works - Success</span></span><br><span class="line"><span class="comment">-- working C compile flag: -Wall</span></span><br><span class="line"><span class="comment">-- Performing Test _flag_works</span></span><br><span class="line"><span class="comment">-- Performing Test _flag_works - Failed</span></span><br><span class="line"><span class="comment">-- Performing Test _flag_works</span></span><br><span class="line"><span class="comment">-- Performing Test _flag_works - Success</span></span><br><span class="line"><span class="comment">-- working CXX compile flag: -g</span></span><br><span class="line"><span class="comment">-- ...</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-2"><a href="#工作原理-2" class="headerlink" title="工作原理"></a>工作原理</h2><p>这里使用的模式是:</p>
<ol>
<li>定义一个函数或宏，并将其放入模块中</li>
<li>包含模块</li>
<li>调用函数或宏</li>
</ol>
<p>从输出中，可以看到代码检查列表中的每个标志。一旦检查成功，它就打印成功的编译标志。看看<code>set_compiler_flag.cmake</code>模块的内部，这个模块又包含三个模块:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">include</span><span class="params">(CheckCCompilerFlag)</span></span></span><br><span class="line"><span class="function"><span class="title">include</span><span class="params">(CheckCXXCompilerFlag)</span></span></span><br><span class="line"><span class="function"><span class="title">include</span><span class="params">(CheckFortranCompilerFlag)</span></span></span><br></pre></td></tr></table></figure>
<p>这都是标准的CMake模块，CMake将在<code>${CMAKE_MODULE_PATH}</code>中找到它们。这些模块分别提供<code>check_c_compiler_flag</code>、<code>check_cxx_compiler_flag</code>和<code>check_fortran_compiler_flag</code>宏。然后定义函数:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">function</span><span class="params">(set_compiler_flag _result _lang)</span></span></span><br><span class="line">	...</span><br><span class="line"><span class="function"><span class="title">endfunction</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p><code>set_compiler_flag</code>函数需要两个参数，<code>_result</code>(保存成功编译标志或为空字符串)和<code>_lang</code>(指定语言:C、C++或Fortran)。</p>
<p>我们也能这样调用函数:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set_compiler_flag</span><span class="params">(working_compile_flag C REQUIRED <span class="string">"-Wall"</span> <span class="string">"-warn all"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>这里有五个调用参数，但是函数头只需要两个参数。这意味着<code>REQUIRED</code>、<code>-Wall</code>和<code>-warn all</code>将放在<code>${ARGN}</code>中。从<code>${ARGN}</code>开始，我们首先使用<code>foreach</code>构建一个标志列表。同时，从标志列表中过滤出<code>REQUIRED</code>，并使用它来设置<code>_flag_is_required</code>:</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># build a list of flags from the arguments</span></span><br><span class="line"><span class="built_in">set</span>(<span class="variable">_list_of_flags</span>)</span><br><span class="line"><span class="meta"># also figure out whether the function</span></span><br><span class="line"><span class="meta"># is required to find a flag</span></span><br><span class="line"><span class="built_in">set</span>(<span class="variable">_flag_is_required</span> <span class="literal">FALSE</span>)</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">_arg</span> <span class="built_in">IN</span> <span class="built_in">ITEMS</span> $&#123;ARGN&#125;)</span><br><span class="line">  string(<span class="built_in">TOUPPER</span> <span class="string">"$&#123;_arg&#125;"</span> <span class="variable">_arg_uppercase</span>)</span><br><span class="line">  <span class="keyword">if</span>(<span class="variable">_arg_uppercase</span> STREQUAL <span class="string">"REQUIRED"</span>)</span><br><span class="line">  	<span class="built_in">set</span>(<span class="variable">_flag_is_required</span> <span class="literal">TRUE</span>)</span><br><span class="line">  <span class="keyword">else</span>()</span><br><span class="line">  	<span class="built_in">list</span>(<span class="built_in">APPEND</span> <span class="variable">_list_of_flags</span> <span class="string">"$&#123;_arg&#125;"</span>)</span><br><span class="line">  endif()</span><br><span class="line">endforeach()</span><br></pre></td></tr></table></figure>
<p>现在，我们将循环<code>${_list_of_flags}</code>，尝试每个标志，如果<code>_flag_works</code>被设置为<code>TRUE</code>，我们将<code>_flag_found</code>设置为<code>TRUE</code>，并中止进一步的搜索:</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span>(<span class="variable">_flag_found</span> <span class="literal">FALSE</span>)</span><br><span class="line"><span class="meta"># loop over all flags, try to find the first which works</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="built_in">flag</span> <span class="built_in">IN</span> <span class="built_in">ITEMS</span> $&#123;<span class="variable">_list_of_flags</span>&#125;)</span><br><span class="line"></span><br><span class="line">  unset(<span class="variable">_flag_works</span> CACHE)</span><br><span class="line">  <span class="keyword">if</span>(<span class="variable">_lang</span> STREQUAL <span class="string">"C"</span>)</span><br><span class="line">  	check_c_compiler_flag(<span class="string">"$&#123;flag&#125;"</span> <span class="variable">_flag_works</span>)</span><br><span class="line">  elseif(<span class="variable">_lang</span> STREQUAL <span class="string">"CXX"</span>)</span><br><span class="line">  	check_cxx_compiler_flag(<span class="string">"$&#123;flag&#125;"</span> <span class="variable">_flag_works</span>)</span><br><span class="line">  elseif(<span class="variable">_lang</span> STREQUAL <span class="string">"Fortran"</span>)</span><br><span class="line">  	check_Fortran_compiler_flag(<span class="string">"$&#123;flag&#125;"</span> <span class="variable">_flag_works</span>)</span><br><span class="line">  <span class="keyword">else</span>()</span><br><span class="line">  	message(FATAL_ERROR <span class="string">"Unknown language in set_compiler_flag: $&#123;_lang&#125;"</span>)</span><br><span class="line">  endif()</span><br><span class="line">  </span><br><span class="line">  <span class="meta"># <span class="meta-keyword">if</span> the flag works, use it, and exit</span></span><br><span class="line">  <span class="meta"># otherwise try next flag</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="variable">_flag_works</span>)</span><br><span class="line">  	<span class="built_in">set</span>($&#123;<span class="variable">_result</span>&#125; <span class="string">"$&#123;flag&#125;"</span> PARENT_SCOPE)</span><br><span class="line">  	<span class="built_in">set</span>(<span class="variable">_flag_found</span> <span class="literal">TRUE</span>)</span><br><span class="line">  	break()</span><br><span class="line">  endif()</span><br><span class="line">endforeach()</span><br></pre></td></tr></table></figure>
<p><code>unset(_flag_works CACHE)</code>确保<code>check_*_compiler_flag</code>的结果，不会在使用<code>_flag_works result</code>变量时，使用的是缓存结果。</p>
<p>如果找到了标志，并且<code>_flag_works</code>设置为<code>TRUE</code>，我们就将<code>_result</code>映射到的变量:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span>(<span class="variable">$&#123;_result&#125;</span> <span class="string">"<span class="variable">$&#123;flag&#125;</span>"</span> PARENT_SCOPE)</span><br></pre></td></tr></table></figure>
<p>这需要使用<code>PARENT_SCOPE</code>来完成，因为我们正在修改一个变量，希望打印并在函数体外部使用该变量。请注意，如何使用<code>${_result}</code>语法解引用，从父范围传递的变量<code>_result</code>的值。不管函数的名称是什么，这对于确保工作标志被设置非常有必要。如果没有找到任何标志，并且该标志设置了<code>REQUIRED</code>，那我们将使用一条错误消息停止配置:</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># raise an <span class="meta-keyword">error</span> <span class="meta-keyword">if</span> no flag was found</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">_flag_is_required</span> <span class="built_in">AND</span> <span class="built_in">NOT</span> <span class="variable">_flag_found</span>)</span><br><span class="line">	message(FATAL_ERROR <span class="string">"None of the required flags were supported"</span>)</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
<h2 id="更多信息-2"><a href="#更多信息-2" class="headerlink" title="更多信息"></a>更多信息</h2><p>我们也可以使用宏来完成这个任务，而使用函数可以对范围有更多的控制。我们知道函数只能可以修改结果变量。</p>
<p>另外，需要在编译和链接时设置一些标志，方法是为<code>check_&lt;lang&gt;_compiler_flag</code>函数设置<code>CMAKE_REQUIRED_FLAGS</code>。如第5章，第7节中讨论的那样，Sanitizer就是这种情况。</p>
<h1 id="7-4-用指定参数定义函数或宏"><a href="#7-4-用指定参数定义函数或宏" class="headerlink" title="7.4 用指定参数定义函数或宏"></a>7.4 用指定参数定义函数或宏</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-04" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-04</a> 中找到，其中包含一个C++示例。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>前面的示例中，我们研究了函数和宏，并使用了位置参数。这个示例中，我们将定义一个带有命名参数的函数。我们将复用第1节中的示例，使用函数和宏重用代码，而不是使用以下代码定义测试：<code>add_catch_test(short 1.5)</code>。</p>
<p>我们将这样调用函数:</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_catch_test(</span></span><br><span class="line"><span class="keyword">	</span>NAME</span><br><span class="line">  	<span class="keyword">short</span></span><br><span class="line"><span class="keyword"> </span> LABELS</span><br><span class="line">  	<span class="keyword">short</span></span><br><span class="line"><span class="keyword"> </span> 	cpp_test</span><br><span class="line">  COST</span><br><span class="line">  	<span class="number">1</span>.<span class="number">5</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<h2 id="准备工作-3"><a href="#准备工作-3" class="headerlink" title="准备工作"></a>准备工作</h2><p>我们使用第1节中的示例，使用函数和宏重用代码，并保持C++源代码不变，文件树保持不变：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── cmake</span><br><span class="line">│     └── testing.cmake</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── src</span><br><span class="line">│     ├── CMakeLists.txt</span><br><span class="line">│     ├── main.cpp</span><br><span class="line">│     ├── sum_integers.cpp</span><br><span class="line">│     └── sum_integers.hpp</span><br><span class="line">└── tests</span><br><span class="line">    ├── catch.hpp</span><br><span class="line">    ├── CMakeLists.txt</span><br><span class="line">    └── test.cpp</span><br></pre></td></tr></table></figure>
<h2 id="具体实施-3"><a href="#具体实施-3" class="headerlink" title="具体实施"></a>具体实施</h2><p>我们对CMake代码进行一些修改，如下所示:</p>
<ol>
<li><p><code>CMakeLists.txt</code>顶部中只增加了一行，因为我们将包括位于<code>cmake</code>下面的模块:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">list</span><span class="params">(APPEND CMAKE_MODULE_PATH <span class="string">"$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/cmake"</span>)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>保持<code>src/CMakeLists.txt</code>。</p>
</li>
<li><p><code>tests/CMakeLists.txt</code>中，将<code>add_catch_test</code>函数定义移动到<code>cmake/testing.cmake</code>，并且定义两个测试:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">add_executable(<span class="name">cpp_test</span> test.cpp)</span><br><span class="line">target_link_libraries(<span class="name">cpp_test</span> sum_integers)</span><br><span class="line">	</span><br><span class="line">include(<span class="name">testing</span>)</span><br><span class="line"></span><br><span class="line">add_catch_test(</span><br><span class="line">  NAME</span><br><span class="line">  	short</span><br><span class="line">  LABELS</span><br><span class="line">  	short</span><br><span class="line">  	cpp_test</span><br><span class="line">  COST</span><br><span class="line">  	<span class="number">1.5</span></span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">add_catch_test(</span><br><span class="line">  NAME</span><br><span class="line">  	long</span><br><span class="line">  LABELS</span><br><span class="line">  	long</span><br><span class="line">  	cpp_test</span><br><span class="line">  COST</span><br><span class="line">  	<span class="number">2.5</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>add_catch_test</code>在<code>cmake/testing.cmake</code>中定义:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">function(<span class="name">add_catch_test</span>)</span><br><span class="line">  set(<span class="name">options</span>)</span><br><span class="line">  set(<span class="name">oneValueArgs</span> NAME COST)</span><br><span class="line">  set(<span class="name">multiValueArgs</span> LABELS DEPENDS REFERENCE_FILES)</span><br><span class="line">  cmake_parse_arguments(<span class="name">add_catch_test</span></span><br><span class="line">    <span class="string">"$&#123;options&#125;"</span></span><br><span class="line">    <span class="string">"$&#123;oneValueArgs&#125;"</span></span><br><span class="line">    <span class="string">"$&#123;multiValueArgs&#125;"</span></span><br><span class="line">    $&#123;ARGN&#125;</span><br><span class="line">    )</span><br><span class="line">  message(<span class="name">STATUS</span> <span class="string">"defining a test ..."</span>)</span><br><span class="line">  message(<span class="name">STATUS</span> <span class="string">" NAME: $&#123;add_catch_test_NAME&#125;"</span>)</span><br><span class="line">  message(<span class="name">STATUS</span> <span class="string">" LABELS: $&#123;add_catch_test_LABELS&#125;"</span>)</span><br><span class="line">  message(<span class="name">STATUS</span> <span class="string">" COST: $&#123;add_catch_test_COST&#125;"</span>)</span><br><span class="line">  message(<span class="name">STATUS</span> <span class="string">" REFERENCE_FILES: $&#123;add_catch_test_REFERENCE_FILES&#125;"</span>)</span><br><span class="line">  </span><br><span class="line">  add_test(</span><br><span class="line">    NAME</span><br><span class="line">    	$&#123;add_catch_test_NAME&#125;</span><br><span class="line">    COMMAND</span><br><span class="line">    	$&lt;TARGET_FILE<span class="symbol">:cpp_test&gt;</span></span><br><span class="line">    [$&#123;add_catch_test_NAME&#125;] --success --out</span><br><span class="line">    	$&#123;PROJECT_BINARY_DIR&#125;/tests/$&#123;add_catch_test_NAME&#125;.log --durations yes</span><br><span class="line">    WORKING_DIRECTORY</span><br><span class="line">    	$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">  set_tests_properties($&#123;add_catch_test_NAME&#125;</span><br><span class="line">    PROPERTIES</span><br><span class="line">    	LABELS <span class="string">"$&#123;add_catch_test_LABELS&#125;"</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">  if(<span class="name">add_catch_test_COST</span>)</span><br><span class="line">    set_tests_properties($&#123;add_catch_test_NAME&#125;</span><br><span class="line">    PROPERTIES</span><br><span class="line">    	COST $&#123;add_catch_test_COST&#125;</span><br><span class="line">    )</span><br><span class="line">  endif()</span><br><span class="line">  </span><br><span class="line">  if(<span class="name">add_catch_test_DEPENDS</span>)</span><br><span class="line">    set_tests_properties($&#123;add_catch_test_NAME&#125;</span><br><span class="line">      PROPERTIES</span><br><span class="line">      	DEPENDS $&#123;add_catch_test_DEPENDS&#125;</span><br><span class="line">      )</span><br><span class="line">  endif()</span><br><span class="line">  </span><br><span class="line">  if(<span class="name">add_catch_test_REFERENCE_FILES</span>)</span><br><span class="line">    file(</span><br><span class="line">      COPY</span><br><span class="line">      	$&#123;add_catch_test_REFERENCE_FILES&#125;</span><br><span class="line">      DESTINATION</span><br><span class="line">      	$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span><br><span class="line">      )</span><br><span class="line">  endif()</span><br><span class="line">endfunction()</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试输出:</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p build</span><br><span class="line">$ cd build</span><br><span class="line">$ cmake ..</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ...</span></span><br><span class="line"><span class="comment">-- defining a test ...</span></span><br><span class="line"><span class="comment">-- NAME: short</span></span><br><span class="line"><span class="comment">-- LABELS: short;cpp_test</span></span><br><span class="line"><span class="comment">-- COST: 1.5</span></span><br><span class="line"><span class="comment">-- REFERENCE_FILES:</span></span><br><span class="line"><span class="comment">-- defining a test ...</span></span><br><span class="line"><span class="comment">-- NAME: long</span></span><br><span class="line"><span class="comment">-- LABELS: long;cpp_test</span></span><br><span class="line"><span class="comment">-- COST: 2.5</span></span><br><span class="line"><span class="comment">-- REFERENCE_FILES:</span></span><br><span class="line"><span class="comment">-- ...</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，编译并测试：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>cmake --build .</span><br><span class="line"><span class="variable">$ </span>ctest</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-3"><a href="#工作原理-3" class="headerlink" title="工作原理"></a>工作原理</h2><p>示例的特点是其命名参数，因此我们可以将重点放在<code>cmake/testing.cmake</code>模块上。CMake提供<code>cmake_parse_arguments</code>命令，我们使用函数名(<code>add_catch_test</code>)选项(我们的例子中是<code>none</code>)、单值参数(<code>NAME</code>和<code>COST</code>)和多值参数(<code>LABELS</code>、<code>DEPENDS</code>和<code>REFERENCE_FILES</code>)调用该命令:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function(add_catch_test)</span><br><span class="line">  <span class="builtin-name">set</span>(options)</span><br><span class="line">  <span class="builtin-name">set</span>(oneValueArgs NAME COST)</span><br><span class="line">  <span class="builtin-name">set</span>(multiValueArgs LABELS DEPENDS REFERENCE_FILES)</span><br><span class="line">  cmake_parse_arguments(add_catch_test</span><br><span class="line">    <span class="string">"<span class="variable">$&#123;options&#125;</span>"</span></span><br><span class="line">    <span class="string">"<span class="variable">$&#123;oneValueArgs&#125;</span>"</span></span><br><span class="line">    <span class="string">"<span class="variable">$&#123;multiValueArgs&#125;</span>"</span></span><br><span class="line">    <span class="variable">$&#123;ARGN&#125;</span></span><br><span class="line">    )</span><br><span class="line"><span class="built_in">..</span>.</span><br><span class="line">endfunction()</span><br></pre></td></tr></table></figure>
<p><code>cmake_parse_arguments</code>命令解析选项和参数，并在例子中定义如下:</p>
<ul>
<li>add_catch_test_NAME</li>
<li>add_catch_test_COST</li>
<li>add_catch_test_LABELS</li>
<li>add_catch_test_DEPENDS</li>
<li>add_catch_test_REFERENCE_FILES</li>
</ul>
<p>可以查询，并在函数中使用这些变量。这种方法使我们有机会用更健壮的接口和更具有可读的函数/宏调用，来实现函数和宏。</p>
<h2 id="更多信息-3"><a href="#更多信息-3" class="headerlink" title="更多信息"></a>更多信息</h2><p>选项关键字(本例中我们没有使用)由<code>cmake_parse_arguments</code>定义为<code>TRUE</code>或<code>FALSE</code>。<code>add_catch_test</code>函数，还提供<code>test</code>命令作为一个命名参数，为了更简洁的演示，我们省略了这个参数。</p>
<p><strong>TIPS</strong>:<em><code>cmake_parse_arguments</code>命令在cmake 3.5的版本前中的<code>CMakeParseArguments.cmake</code>定义。因此，可以在<code>CMake/test.cmake</code>顶部的使用<code>include(CMakeParseArguments)</code>命令使此示例能与CMake早期版本一起工作。</em></p>
<h1 id="7-5-重新定义函数和宏"><a href="#7-5-重新定义函数和宏" class="headerlink" title="7.5 重新定义函数和宏"></a>7.5 重新定义函数和宏</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-05" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-05</a> 中找到。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>我们已经提到模块包含不应该用作函数调用，因为模块可能被包含多次。本示例中，我们将编写我们自己的“包含保护”机制，如果多次包含一个模块，将触发警告。内置的<code>include_guard</code>命令从3.10版开始可以使用，对于C/C++头文件，它的行为就像<code>#pragma</code>一样。对于当前版本的CMake，我们将演示如何重新定义函数和宏，并且展示如何检查CMake版本，对于低于3.10的版本，我们将使用定制的“包含保护”机制。</p>
<h2 id="准备工作-4"><a href="#准备工作-4" class="headerlink" title="准备工作"></a>准备工作</h2><p>这个例子中，我们将使用三个文件:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── cmake</span><br><span class="line">│     ├── custom.cmake</span><br><span class="line">│     └── include_guard.cmake</span><br><span class="line">└── CMakeLists.txt</span><br></pre></td></tr></table></figure>
<p><code>custom.cmake</code>模块包含以下代码:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">include_guard</span><span class="params">(GLOBAL)</span></span></span><br><span class="line"><span class="function"><span class="title">message</span><span class="params">(STATUS <span class="string">"custom.cmake is included and processed"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>我们稍后会对<code>cmake/include_guard.cmake</code>进行讨论。</p>
<h2 id="具体实施-4"><a href="#具体实施-4" class="headerlink" title="具体实施"></a>具体实施</h2><p>我们对三个CMake文件的逐步分解:</p>
<ol>
<li><p>示例中，我们不会编译任何代码，因此我们的语言要求是<code>NONE</code>:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">cmake_minimum_required</span><span class="params">(VERSION <span class="number">3.5</span> FATAL_ERROR)</span></span></span><br><span class="line"><span class="function"><span class="title">project</span><span class="params">(recipe-<span class="number">05</span> LANGUAGES NONE)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>定义一个<code>include_guard</code>宏，将其放在一个单独的模块中:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># (<span class="name">re</span>)defines include_guard</span><br><span class="line">include(<span class="name">cmake/include_guard</span>.cmake)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>cmake/include_guard.cmake</code>文件包含以下内容(稍后将详细讨论):</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">macro</span>(<span class="keyword">include_guard</span>)</span><br><span class="line">  <span class="keyword">if</span> (CMAKE_VERSION <span class="keyword">VERSION_LESS</span> <span class="string">"3.10"</span>)</span><br><span class="line">    <span class="comment"># for CMake below 3.10 we define our</span></span><br><span class="line">    <span class="comment"># own include_guard(GLOBAL)</span></span><br><span class="line">    <span class="keyword">message</span>(STATUS <span class="string">"calling our custom include_guard"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if this macro is called the first time</span></span><br><span class="line">    <span class="comment"># we start with an empty list</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">NOT</span> <span class="keyword">DEFINED</span> included_modules)</span><br><span class="line">      <span class="keyword">set</span>(included_modules)</span><br><span class="line">    <span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"$&#123;CMAKE_CURRENT_LIST_FILE&#125;"</span> <span class="keyword">IN_LIST</span> included_modules)</span><br><span class="line">      <span class="keyword">message</span>(WARNING <span class="string">"module $&#123;CMAKE_CURRENT_LIST_FILE&#125; processed more than once"</span>)</span><br><span class="line">    <span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">list</span>(APPEND included_modules <span class="variable">$&#123;CMAKE_CURRENT_LIST_FILE&#125;</span>)</span><br><span class="line">    <span class="keyword">else</span>()</span><br><span class="line">    <span class="comment"># for CMake 3.10 or higher we augment</span></span><br><span class="line">    <span class="comment"># the built-in include_guard</span></span><br><span class="line">    <span class="keyword">message</span>(STATUS <span class="string">"calling the built-in include_guard"</span>)</span><br><span class="line">    </span><br><span class="line">    _include_guard(<span class="variable">$&#123;ARGV&#125;</span>)</span><br><span class="line">  <span class="keyword">endif</span>()</span><br><span class="line"><span class="keyword">endmacro</span>()</span><br></pre></td></tr></table></figure>
</li>
<li><p>主CMakeLists.txt中，我们模拟了两次包含自定义模块的情况:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">include</span><span class="params">(cmake/custom.cmake)</span></span></span><br><span class="line"><span class="function"><span class="title">include</span><span class="params">(cmake/custom.cmake)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，使用以下命令进行配置:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p build</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> build</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cmake ..</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用CMake 3.10及更高版本的结果如下:</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">- calling the built-<span class="keyword">in</span> include_guard</span></span><br><span class="line"><span class="ruby">-- custom.cmake is included <span class="keyword">and</span> processed</span></span><br><span class="line"><span class="ruby">-- calling the built-<span class="keyword">in</span> include_guard</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用CMake得到3.10以下的结果如下:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- calling our custom include_guard</span><br><span class="line">-- custom<span class="selector-class">.cmake</span> is included and processed</span><br><span class="line">-- calling our custom include_guard</span><br><span class="line">CMake Warning at cmake/include_guard<span class="selector-class">.cmake</span>:<span class="number">7</span> (message):</span><br><span class="line">module</span><br><span class="line">/home/user/example/cmake/custom.cmake</span><br><span class="line">processed more than once</span><br><span class="line">Call Stack (most recent call first):</span><br><span class="line">cmake/custom<span class="selector-class">.cmake</span>:<span class="number">1</span> (include_guard)</span><br><span class="line">CMakeLists<span class="selector-class">.txt</span>:<span class="number">12</span> (include)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-4"><a href="#工作原理-4" class="headerlink" title="工作原理"></a>工作原理</h2><p><code>include_guard</code>宏包含两个分支，一个用于CMake低于3.10，另一个用于CMake高于3.10:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">macro</span>(<span class="keyword">include_guard</span>)</span><br><span class="line">  <span class="keyword">if</span> (CMAKE_VERSION <span class="keyword">VERSION_LESS</span> <span class="string">"3.10"</span>)</span><br><span class="line">  	<span class="comment"># ...</span></span><br><span class="line">  <span class="keyword">else</span>()</span><br><span class="line">  	<span class="comment"># ...</span></span><br><span class="line">  <span class="keyword">endif</span>()</span><br><span class="line"><span class="keyword">endmacro</span>()</span><br></pre></td></tr></table></figure>
<p>如果CMake版本低于3.10，进入第一个分支，并且内置的<code>include_guard</code>不可用，所以我们自定义了一个:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message</span>(STATUS <span class="string">"calling our custom include_guard"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># if this macro is called the first time</span></span><br><span class="line"><span class="comment"># we start with an empty list</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">NOT</span> <span class="keyword">DEFINED</span> included_modules)</span><br><span class="line">	<span class="keyword">set</span>(included_modules)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="string">"$&#123;CMAKE_CURRENT_LIST_FILE&#125;"</span> <span class="keyword">IN_LIST</span> included_modules)</span><br><span class="line">	<span class="keyword">message</span>(WARNING <span class="string">"module $&#123;CMAKE_CURRENT_LIST_FILE&#125; processed more than once"</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">list</span>(APPEND included_modules <span class="variable">$&#123;CMAKE_CURRENT_LIST_FILE&#125;</span>)</span><br></pre></td></tr></table></figure>
<p>如果第一次调用宏，则<code>included_modules</code>变量没有定义，因此我们将其设置为空列表。然后检查<code>${CMAKE_CURRENT_LIST_FILE}</code>是否是<code>included_modules</code>列表中的元素。如果是，则会发出警告；如果没有，我们将<code>${CMAKE_CURRENT_LIST_FILE}</code>追加到这个列表。CMake输出中，我们可以验证自定义模块的第二个包含确实会导致警告。</p>
<p>CMake 3.10及更高版本的情况有所不同；在这种情况下，存在一个内置的<code>include_guard</code>，我们用自己的宏接收到参数并调用它:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">macro</span>(<span class="keyword">include_guard</span>)</span><br><span class="line">  <span class="keyword">if</span> (CMAKE_VERSION <span class="keyword">VERSION_LESS</span> <span class="string">"3.10"</span>)</span><br><span class="line">  	<span class="comment"># ...</span></span><br><span class="line">  <span class="keyword">else</span>()</span><br><span class="line">  	<span class="keyword">message</span>(STATUS <span class="string">"calling the built-in include_guard"</span>)</span><br><span class="line">  	</span><br><span class="line">  	_include_guard(<span class="variable">$&#123;ARGV&#125;</span>)</span><br><span class="line">  <span class="keyword">endif</span>()</span><br><span class="line"><span class="keyword">endmacro</span>()</span><br></pre></td></tr></table></figure>
<p>这里，<code>_include_guard(${ARGV})</code>指向内置的<code>include_guard</code>。本例中，使用自定义消息(“调用内置的<code>include_guard</code>”)进行了扩展。这种模式为我们提供了一种机制，来重新定义自己的或内置的函数和宏，这对于调试或记录日志来说非常有用。</p>
<p><strong>NOTE</strong>:<em>这种模式可能很有用，但是应该谨慎使用，因为CMake不会对重新定义的宏或函数进行警告。</em></p>
<h1 id="7-6-使用废弃函数、宏和变量"><a href="#7-6-使用废弃函数、宏和变量" class="headerlink" title="7.6 使用废弃函数、宏和变量"></a>7.6 使用废弃函数、宏和变量</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-06" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-06</a> 中找到。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>“废弃”是在不断发展的项目开发过程中一种重要机制，它向开发人员发出信号，表明将来某个函数、宏或变量将被删除或替换。在一段时间内，函数、宏或变量将继续可访问，但会发出警告，最终可能会上升为错误。</p>
<h2 id="准备工作-5"><a href="#准备工作-5" class="headerlink" title="准备工作"></a>准备工作</h2><p>我们将从以下CMake项目开始:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(<span class="name">VERSION</span> <span class="number">3.5</span> FATAL_ERROR)</span><br><span class="line"></span><br><span class="line">project(<span class="name">recipe-06</span> LANGUAGES NONE)</span><br><span class="line"></span><br><span class="line">macro(<span class="name">custom_include_guard</span>)</span><br><span class="line">  if(<span class="name">NOT</span> DEFINED included_modules)</span><br><span class="line">  	set(<span class="name">included_modules</span>)</span><br><span class="line">  endif()</span><br><span class="line">  </span><br><span class="line">  if (<span class="string">"$&#123;CMAKE_CURRENT_LIST_FILE&#125;"</span> IN_LIST included_modules)</span><br><span class="line">  	message(<span class="name">WARNING</span> <span class="string">"module $&#123;CMAKE_CURRENT_LIST_FILE&#125; processed more than once"</span>)</span><br><span class="line">  endif()</span><br><span class="line">  </span><br><span class="line">  list(<span class="name">APPEND</span> included_modules $&#123;CMAKE_CURRENT_LIST_FILE&#125;)</span><br><span class="line">endmacro()</span><br><span class="line"></span><br><span class="line">include(<span class="name">cmake/custom</span>.cmake)</span><br><span class="line"></span><br><span class="line">message(<span class="name">STATUS</span> <span class="string">"list of all included modules: $&#123;included_modules&#125;"</span>)</span><br></pre></td></tr></table></figure>
<p>这段代码定义了一个自定义的”包含保护”机制，包括一个自定义模块(与前一个示例中的模块相同)，并打印所有包含模块的列表。对于CMake 3.10或更高版本有内置的<code>include_guard</code>。但是，不能简单地删除<code>custom_include_guard</code>和<code>${included_modules}</code>，而是使用一个“废弃”警告来弃用宏和变量。某个时候，可以将该警告转换为<code>FATAL_ERROR</code>，使代码停止配置，并迫使开发人员对代码进行修改，切换到内置命令。</p>
<h2 id="具体实施-5"><a href="#具体实施-5" class="headerlink" title="具体实施"></a>具体实施</h2><p>“废弃”函数、宏和变量的方法如下:</p>
<ol>
<li><p>首先，定义一个函数，我们将使用它来弃用一个变量:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function(<span class="name">deprecate_variable</span> _variable _access)</span><br><span class="line">  if(<span class="name">_access</span> STREQUAL <span class="string">"READ_ACCESS"</span>)</span><br><span class="line">  	message(<span class="name">DEPRECATION</span> <span class="string">"variable $&#123;_variable&#125; is deprecated"</span>)</span><br><span class="line">  endif()</span><br><span class="line">endfunction()</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，如果CMake的版本大于3.9，我们重新定义<code>custom_include_guard</code>并将<code>variable_watch</code>附加到<code>included_modules</code>中:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">if (<span class="name">CMAKE_VERSION</span> VERSION_GREATER <span class="string">"3.9"</span>)</span><br><span class="line">  # deprecate custom_include_guard</span><br><span class="line">  macro(<span class="name">custom_include_guard</span>)</span><br><span class="line">    message(<span class="name">DEPRECATION</span> <span class="string">"custom_include_guard is deprecated - use built-in include_guard instead"</span>)</span><br><span class="line">    _custom_include_guard($&#123;ARGV&#125;)</span><br><span class="line">  endmacro()</span><br><span class="line">  </span><br><span class="line">  # deprecate variable included_modules</span><br><span class="line">  variable_watch(<span class="name">included_modules</span> deprecate_variable)</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
</li>
<li><p>CMake3.10以下版本的项目会产生以下结果:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -<span class="keyword">p</span> build</span><br><span class="line">$ <span class="keyword">cd</span> build</span><br><span class="line">$ cmake ..</span><br><span class="line"></span><br><span class="line">-- custom.cmake <span class="keyword">is</span> included <span class="built_in">and</span> processed</span><br><span class="line">-- <span class="keyword">list</span> of <span class="keyword">all</span> included module<span class="variable">s:</span> /home/user/example/cmake/custom.cmake</span><br></pre></td></tr></table></figure>
</li>
<li><p>CMake 3.10及以上将产生预期的“废弃”警告:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CMake Deprecation Warning at CMakeLists.tx<span class="variable">t:26</span> (message):</span><br><span class="line">custom_include_guard <span class="keyword">is</span> deprecated - use built-in include_guard instead</span><br><span class="line">Call Stack (most recent <span class="keyword">call</span> <span class="keyword">first</span>):</span><br><span class="line">cmake/custom.cmake:<span class="number">1</span> (custom_include_guard)</span><br><span class="line">CMakeLists.tx<span class="variable">t:34</span> (include)</span><br><span class="line">-- custom.cmake <span class="keyword">is</span> included <span class="built_in">and</span> processed</span><br><span class="line">CMake Deprecation Warning at CMakeLists.tx<span class="variable">t:19</span> (message):</span><br><span class="line">variable included_modules <span class="keyword">is</span> deprecated</span><br><span class="line">Call Stack (most recent <span class="keyword">call</span> <span class="keyword">first</span>):</span><br><span class="line">CMakeLists.tx<span class="variable">t:9999</span> (deprecate_variable)</span><br><span class="line">CMakeLists.tx<span class="variable">t:36</span> (message)</span><br><span class="line">-- <span class="keyword">list</span> of <span class="keyword">all</span> included module<span class="variable">s:</span> /home/user/example/cmake/custom.cmake</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-5"><a href="#工作原理-5" class="headerlink" title="工作原理"></a>工作原理</h2><p>弃用函数或宏相当于重新定义它，如前面的示例所示，并使用<code>DEPRECATION</code>打印消息:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">macro(<span class="name">somemacro</span>)</span><br><span class="line">  message(<span class="name">DEPRECATION</span> <span class="string">"somemacro is deprecated"</span>)</span><br><span class="line">  _somemacro($&#123;ARGV&#125;)</span><br><span class="line">endmacro()</span><br></pre></td></tr></table></figure>
<p>可以通过定义以下变量来实现对变量的弃用:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function(<span class="name">deprecate_variable</span> _variable _access)</span><br><span class="line">  if(<span class="name">_access</span> STREQUAL <span class="string">"READ_ACCESS"</span>)</span><br><span class="line">  	message(<span class="name">DEPRECATION</span> <span class="string">"variable $&#123;_variable&#125; is deprecated"</span>)</span><br><span class="line">  endif()</span><br><span class="line">endfunction()</span><br></pre></td></tr></table></figure>
<p>然后，这个函数被添加到将要“废弃”的变量上:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">variable_watch</span><span class="params">(somevariable deprecate_variable)</span></span></span><br></pre></td></tr></table></figure>
<p>如果在本例中<code>${included_modules}</code>是读取 (<code>READ_ACCESS</code>)，那么<code>deprecate_variable</code>函数将发出带有<code>DEPRECATION</code>的消息。</p>
<h1 id="7-7-add-subdirectory的限定范围"><a href="#7-7-add-subdirectory的限定范围" class="headerlink" title="7.7 add_subdirectory的限定范围"></a>7.7 add_subdirectory的限定范围</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-07" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-07</a> 中找到，其中有一个C++示例。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>本章剩下的示例中，我们将讨论构建项目的策略，并限制变量的范围和副作用，目的是降低代码的复杂性和简化项目的维护。这个示例中，我们将把一个项目分割成几个范围有限的CMakeLists.txt文件，这些文件将使用<code>add_subdirectory</code>命令进行处理。</p>
<h2 id="准备工作-6"><a href="#准备工作-6" class="headerlink" title="准备工作"></a>准备工作</h2><p>由于我们希望展示和讨论如何构造一个复杂的项目，所以需要一个比“hello world”项目更复杂的例子:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Cellular_automaton#Elementary_cellular_automata" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Cellular_automaton#Elementary_cellular_automata</a></li>
<li><a href="http://mathworld.wolfram.com/ElementaryCellularAutomaton.html" target="_blank" rel="noopener">http://mathworld.wolfram.com/ElementaryCellularAutomaton.html</a></li>
</ul>
<p>我们的代码将能够计算任何256个基本细胞自动机，例如：规则90 (Wolfram代码):</p>
<p>我们示例代码项目的结构如下:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br><span class="line">├── <span class="selector-tag">external</span></span><br><span class="line">│    ├── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br><span class="line">│    ├── <span class="selector-tag">conversion</span><span class="selector-class">.cpp</span></span><br><span class="line">│    ├── <span class="selector-tag">conversion</span><span class="selector-class">.hpp</span></span><br><span class="line">│    └── <span class="selector-tag">README</span><span class="selector-class">.md</span></span><br><span class="line">├── <span class="selector-tag">src</span></span><br><span class="line">│    ├── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br><span class="line">│    ├── <span class="selector-tag">evolution</span></span><br><span class="line">│    │    ├── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br><span class="line">│    │    ├── <span class="selector-tag">evolution</span><span class="selector-class">.cpp</span></span><br><span class="line">│    │    └── <span class="selector-tag">evolution</span><span class="selector-class">.hpp</span></span><br><span class="line">│    ├── <span class="selector-tag">initial</span></span><br><span class="line">│    │    ├── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br><span class="line">│    │    ├── <span class="selector-tag">initial</span><span class="selector-class">.cpp</span></span><br><span class="line">│    │    └── <span class="selector-tag">initial</span><span class="selector-class">.hpp</span></span><br><span class="line">│    ├── <span class="selector-tag">io</span></span><br><span class="line">│    │    ├── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br><span class="line">│    │    ├── <span class="selector-tag">io</span><span class="selector-class">.cpp</span></span><br><span class="line">│    │    └── <span class="selector-tag">io</span><span class="selector-class">.hpp</span></span><br><span class="line">│    ├── <span class="selector-tag">main</span><span class="selector-class">.cpp</span></span><br><span class="line">│    └── <span class="selector-tag">parser</span></span><br><span class="line">│        ├── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br><span class="line">│        ├── <span class="selector-tag">parser</span><span class="selector-class">.cpp</span></span><br><span class="line">│        └── <span class="selector-tag">parser</span><span class="selector-class">.hpp</span></span><br><span class="line">└── <span class="selector-tag">tests</span></span><br><span class="line">    ├── <span class="selector-tag">catch</span><span class="selector-class">.hpp</span></span><br><span class="line">    ├── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br><span class="line">    └── <span class="selector-tag">test</span><span class="selector-class">.cpp</span></span><br></pre></td></tr></table></figure>
<p>我们将代码分成许多库来模拟真实的大中型项目，可以将源代码组织到库中，然后将库链接到可执行文件中。</p>
<p>主要功能在<code>src/main.cpp</code>中:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"conversion.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"evolution.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"initial.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"io.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"parser.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">  <span class="comment">// parse arguments</span></span><br><span class="line">  <span class="keyword">int</span> length, num_steps, rule_decimal;</span><br><span class="line">  <span class="built_in">std</span>::tie(length, num_steps, rule_decimal) = parse_arguments(argc, argv);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// print information about parameters</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"length: "</span> &lt;&lt; length &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"number of steps: "</span> &lt;&lt; num_steps &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"rule: "</span> &lt;&lt; rule_decimal &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// obtain binary representation for the rule</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> rule_binary = binary_representation(rule_decimal);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// create initial distribution</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; row = initial_distribution(length);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// print initial configuration</span></span><br><span class="line">  print_row(row);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// the system evolves, print each step</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> step = <span class="number">0</span>; step &lt; num_steps; step++) &#123;</span><br><span class="line">    row = evolve(row, rule_binary);</span><br><span class="line">    print_row(row);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>external/conversion.cpp</code>文件包含要从十进制转换为二进制的代码。</p>
<p>我们在这里模拟这段代码是由<code>src</code>外部的“外部”库提供的:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"conversion.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bitset&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="built_in">std</span>::<span class="function"><span class="built_in">string</span> <span class="title">binary_representation</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> decimal)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">std</span>::<span class="built_in">bitset</span>&lt;<span class="number">8</span>&gt;(decimal).to_string();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>src/evolution/evolution.cpp</code>文件为一个时限传播系统:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"evolution.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; evolve(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; row, <span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> rule_binary) &#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; result;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">0</span>; i &lt; row.size(); ++i) &#123;</span><br><span class="line">    <span class="keyword">auto</span> left = (i == <span class="number">0</span> ? row.size() : i) - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">auto</span> center = i;</span><br><span class="line">    <span class="keyword">auto</span> right = (i + <span class="number">1</span>) % row.size();</span><br><span class="line">    <span class="keyword">auto</span> ancestors = <span class="number">4</span> * row[left] + <span class="number">2</span> * row[center] + <span class="number">1</span> * row[right];</span><br><span class="line">    ancestors = <span class="number">7</span> - ancestors;</span><br><span class="line">    <span class="keyword">auto</span> new_state = <span class="built_in">std</span>::stoi(rule_binary.substr(ancestors, <span class="number">1</span>));</span><br><span class="line">    result.push_back(new_state);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>src/initial/initial.cpp</code>文件，对出进行初始化:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"initial.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; initial_distribution(<span class="keyword">const</span> <span class="keyword">int</span> length) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// we start with a vector which is zeroed out</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; result(length, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// more or less in the middle we place a living cell</span></span><br><span class="line">  result[length / <span class="number">2</span>] = <span class="number">1</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>src/io/io.cpp</code>文件包含一个函数输出打印行:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"io.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_row</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; row)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">std</span>::for_each(row.begin(), row.end(), [](<span class="keyword">int</span> <span class="keyword">const</span> &amp;value) &#123;</span><br><span class="line">  	<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; (value == <span class="number">1</span> ? <span class="string">'*'</span> : <span class="string">' '</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>src/parser/parser.cpp</code>文件解析命令行输入:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"parser.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tuple&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">std</span>::tuple&lt;<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>&gt; parse_arguments(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[]) &#123;</span><br><span class="line">  assert(argc == <span class="number">4</span> &amp;&amp; <span class="string">"program called with wrong number of arguments"</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">auto</span> length = <span class="built_in">std</span>::stoi(argv[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">auto</span> num_steps = <span class="built_in">std</span>::stoi(argv[<span class="number">2</span>]);</span><br><span class="line">  <span class="keyword">auto</span> rule_decimal = <span class="built_in">std</span>::stoi(argv[<span class="number">3</span>]);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">std</span>::make_tuple(length, num_steps, rule_decimal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，<code>tests/test.cpp</code>包含两个使用Catch2库的单元测试:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"evolution.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// this tells catch to provide a main()</span></span><br><span class="line"><span class="comment">// only do this in one cpp file</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CATCH_CONFIG_MAIN</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"catch.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line">TEST_CASE(<span class="string">"Apply rule 90"</span>, <span class="string">"[rule-90]"</span>) &#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; row = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> rule = <span class="string">"01011010"</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; expected_result = &#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>&#125;;</span><br><span class="line">  REQUIRE(evolve(row, rule) == expected_result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TEST_CASE(<span class="string">"Apply rule 222"</span>, <span class="string">"[rule-222]"</span>) &#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; row = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span> rule = <span class="string">"11011110"</span>;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; expected_result = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">  REQUIRE(evolve(row, rule) == expected_result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相应的头文件包含函数声明。有人可能会说，对于这个小代码示例，项目包含了太多子目录。请注意，这只是一个项目的简化示例，通常包含每个库的许多源文件，理想情况下，这些文件被放在到单独的目录中。</p>
<h2 id="具体实施-6"><a href="#具体实施-6" class="headerlink" title="具体实施"></a>具体实施</h2><p>让我们来详细解释一下CMake所需的功能:</p>
<ol>
<li><p><code>CMakeLists.txt</code>顶部非常类似于第1节，代码重用与函数和宏:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.5</span> FATAL_ERROR)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span>(recipe-<span class="number">07</span> LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_EXTENSIONS <span class="keyword">OFF</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD_REQUIRED <span class="keyword">ON</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(GNUInstallDirs)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_ARCHIVE_OUTPUT_DIRECTORY</span><br><span class="line"><span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/<span class="variable">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_LIBRARY_OUTPUT_DIRECTORY</span><br><span class="line"><span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/<span class="variable">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_RUNTIME_OUTPUT_DIRECTORY</span><br><span class="line"><span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/<span class="variable">$&#123;CMAKE_INSTALL_BINDIR&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># defines targets and sources</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(src)</span><br><span class="line"></span><br><span class="line"><span class="comment"># contains an "external" library we will link to</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(external)</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable testing and define tests</span></span><br><span class="line"><span class="keyword">enable_testing</span>()</span><br><span class="line"><span class="keyword">add_subdirectory</span>(tests)</span><br></pre></td></tr></table></figure>
</li>
<li><p>目标和源在<code>src/CMakeLists.txt</code>中定义(转换目标除外):</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_executable</span><span class="params">(automata main.cpp)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(evolution)</span></span></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(initial)</span></span></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(io)</span></span></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(parser)</span></span></span><br><span class="line"></span><br><span class="line">target_link_libraries(automata</span><br><span class="line">  PRIVATE</span><br><span class="line">    conversion</span><br><span class="line">    evolution</span><br><span class="line">    <span class="attribute">initial</span></span><br><span class="line">    io</span><br><span class="line">    parser</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>转换库在<code>external/CMakeLists.txt</code>中定义:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_library</span><span class="params">(conversion <span class="string">""</span>)</span></span></span><br><span class="line"></span><br><span class="line">target_sources(conversion</span><br><span class="line">  PRIVATE</span><br><span class="line">    $&#123;CMAKE_CURRENT_LIST_DIR&#125;/conversion.cpp</span><br><span class="line">  PUBLIC</span><br><span class="line">    $&#123;CMAKE_CURRENT_LIST_DIR&#125;/conversion.hpp</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">target_include_directories(conversion</span><br><span class="line">  PUBLIC</span><br><span class="line">  	$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>src/CMakeLists.txt</code>文件添加了更多的子目录，这些子目录又包含<code>CMakeLists.txt</code>文件。<code>src/evolution/CMakeLists.txt</code>包含以下内容:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_library</span><span class="params">(evolution <span class="string">""</span>)</span></span></span><br><span class="line"></span><br><span class="line">target_sources(evolution</span><br><span class="line">  PRIVATE</span><br><span class="line">  	evolution.cpp</span><br><span class="line">  PUBLIC</span><br><span class="line">  	$&#123;CMAKE_CURRENT_LIST_DIR&#125;/evolution.hpp</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">target_include_directories(evolution</span><br><span class="line">  PUBLIC</span><br><span class="line">  	$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>单元测试在<code>tests/CMakeLists.txt</code>中注册:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">add_executable(<span class="name">cpp_test</span> test.cpp)</span><br><span class="line"></span><br><span class="line">target_link_libraries(<span class="name">cpp_test</span> evolution)</span><br><span class="line"></span><br><span class="line">add_test(</span><br><span class="line">  NAME</span><br><span class="line">  	test_evolution</span><br><span class="line">  COMMAND</span><br><span class="line">  	$&lt;TARGET_FILE<span class="symbol">:cpp_test&gt;</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置和构建项目产生以下输出:</p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p build</span><br><span class="line">$ cd build</span><br><span class="line">$ cmake ..</span><br><span class="line">$ cmake --build .</span><br><span class="line"></span><br><span class="line">Scanning dependencies <span class="keyword">of</span> target conversion</span><br><span class="line">[ <span class="number">7</span><span class="comment">%] Building CXX object external/CMakeFiles/conversion.dir/conversion.cpp.o</span></span><br><span class="line">[ <span class="number">14</span><span class="comment">%] Linking CXX static library ../lib64/libconversion.a</span></span><br><span class="line">[ <span class="number">14</span><span class="comment">%] Built target conversion</span></span><br><span class="line">Scanning dependencies <span class="keyword">of</span> target evolution</span><br><span class="line">[ <span class="number">21</span><span class="comment">%] Building CXX object src/evolution/CMakeFiles/evolution.dir/evolution.cpp.o</span></span><br><span class="line">[ <span class="number">28</span><span class="comment">%] Linking CXX static library ../../lib64/libevolution.a</span></span><br><span class="line">[ <span class="number">28</span><span class="comment">%] Built target evolution</span></span><br><span class="line">Scanning dependencies <span class="keyword">of</span> target initial</span><br><span class="line">[ <span class="number">35</span><span class="comment">%] Building CXX object src/initial/CMakeFiles/initial.dir/initial.cpp.o</span></span><br><span class="line">[ <span class="number">42</span><span class="comment">%] Linking CXX static library ../../lib64/libinitial.a</span></span><br><span class="line">[ <span class="number">42</span><span class="comment">%] Built target initial</span></span><br><span class="line">Scanning dependencies <span class="keyword">of</span> target io</span><br><span class="line">[ <span class="number">50</span><span class="comment">%] Building CXX object src/io/CMakeFiles/io.dir/io.cpp.o</span></span><br><span class="line">[ <span class="number">57</span><span class="comment">%] Linking CXX static library ../../lib64/libio.a</span></span><br><span class="line">[ <span class="number">57</span><span class="comment">%] Built target io</span></span><br><span class="line">Scanning dependencies <span class="keyword">of</span> target parser</span><br><span class="line">[ <span class="number">64</span><span class="comment">%] Building CXX object src/parser/CMakeFiles/parser.dir/parser.cpp.o</span></span><br><span class="line">[ <span class="number">71</span><span class="comment">%] Linking CXX static library ../../lib64/libparser.a</span></span><br><span class="line">[ <span class="number">71</span><span class="comment">%] Built target parser</span></span><br><span class="line">Scanning dependencies <span class="keyword">of</span> target automata</span><br><span class="line">[ <span class="number">78</span><span class="comment">%] Building CXX object src/CMakeFiles/automata.dir/main.cpp.o</span></span><br><span class="line">[ <span class="number">85</span><span class="comment">%] Linking CXX executable ../bin/automata</span></span><br><span class="line">[ <span class="number">85</span><span class="comment">%] Built target automata</span></span><br><span class="line">Scanning dependencies <span class="keyword">of</span> target cpp_test</span><br><span class="line">[ <span class="number">92</span><span class="comment">%] Building CXX object tests/CMakeFiles/cpp_test.dir/test.cpp.o</span></span><br><span class="line">[<span class="number">100</span><span class="comment">%] Linking CXX executable ../bin/cpp_test</span></span><br><span class="line">[<span class="number">100</span><span class="comment">%] Built target cpp_test</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，运行单元测试:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ctest</span><br><span class="line"></span><br><span class="line">Running tests<span class="built_in">..</span>.</span><br><span class="line">Start 1: test_evolution</span><br><span class="line">1/1 Test #1: test_evolution <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>. Passed 0.00 sec</span><br><span class="line">100% tests passed, 0 tests failed out of 1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-6"><a href="#工作原理-6" class="headerlink" title="工作原理"></a>工作原理</h2><p>我们可以将所有代码放到一个源文件中。不过，每次编辑都需要重新编译。将源文件分割成更小、更易于管理的单元是有意义的。可以将所有源代码都编译成一个库或可执行文件。实际上，项目更喜欢将源代码编译分成更小的、定义良好的库。这样做既是为了本地化和简化依赖项，也是为了简化代码维护。这意味着如在这里所做的那样，由许多库构建一个项目是一种常见的情况。</p>
<p>为了讨论CMake结构，我们可以从定义每个库的单个CMakeLists.txt文件开始，自底向上进行，例如<code>src/evolution/CMakeLists.txt</code>:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_library</span><span class="params">(evolution <span class="string">""</span>)</span></span></span><br><span class="line"></span><br><span class="line">target_sources(evolution</span><br><span class="line">  PRIVATE</span><br><span class="line">  	evolution.cpp</span><br><span class="line">  PUBLIC</span><br><span class="line">  	$&#123;CMAKE_CURRENT_LIST_DIR&#125;/evolution.hpp</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">target_include_directories(evolution</span><br><span class="line">  PUBLIC</span><br><span class="line">  	$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>这些单独的<code>CMakeLists.txt</code>文件定义了库。本例中，我们首先使用<code>add_library</code>定义库名，然后定义它的源和包含目录，以及它们的目标可见性：实现文件(<code>evolution.cpp</code>:<code>PRIVATE</code>)，而接口头文件<code>evolution.hpp</code>定义为<code>PUBLIC</code>，因为我们将在<code>main.cpp</code>和<code>test.cpp</code>中访问它。定义尽可能接近代码目标的好处是，对于该库的修改，只需要变更该目录中的文件即可；换句话说，也就是库依赖项被封装。</p>
<p>向上移动一层，库在<code>src/CMakeLists.txt</code>中封装:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_executable</span><span class="params">(automata main.cpp)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(evolution)</span></span></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(initial)</span></span></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(io)</span></span></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(parser)</span></span></span><br><span class="line"></span><br><span class="line">target_link_libraries(automata</span><br><span class="line">  PRIVATE</span><br><span class="line">    conversion</span><br><span class="line">    evolution</span><br><span class="line">    <span class="attribute">initial</span></span><br><span class="line">    io</span><br><span class="line">    parser</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>文件在主<code>CMakeLists.txt</code>中被引用。这意味着使用<code>CMakeLists.txt</code>文件，构建我们的项目。这种方法对于许多项目来说是可用的，并且它可以扩展到更大型的项目，而不需要在目录间的全局变量中包含源文件列表。<code>add_subdirectory</code>方法的另一个好处是它隔离了作用范围，因为子目录中定义的变量在父范围中不能访问。</p>
<h2 id="更多信息-4"><a href="#更多信息-4" class="headerlink" title="更多信息"></a>更多信息</h2><p>使用<code>add_subdirectory</code>调用树构建项目的一个限制是，CMake不允许将<code>target_link_libraries</code>与定义在当前目录范围之外的目标一起使用。对于本示例来说，这不是问题。在下一个示例中，我们将演示另一种方法，我们不使用<code>add_subdirectory</code>，而是使用<code>module include</code>来组装不同的<code>CMakeLists.txt</code>文件，它允许我们链接到当前目录之外定义的目标。</p>
<p>CMake可以使用Graphviz图形可视化软件(<a href="http://www.graphviz.org/" target="_blank" rel="noopener">http://www.graphviz.org</a> )生成项目的依赖关系图:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> build</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cmake --graphviz=example.dot ..</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> dot -T png example.dot -o example.png</span></span><br></pre></td></tr></table></figure>
<p>本书中，我们一直在构建源代码之外的代码，以保持源代码树和构建树是分开的。这是推荐的方式，允许我们使用相同的源代码配置不同的构建(顺序的或并行的，Debug或Release)，而不需要复制源代码，也不需要在源代码树中生成目标文件。使用以下代码片段，可以保护您的项目免受内部构建的影响:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span> <span class="keyword">STREQUAL</span> <span class="variable">$&#123;PROJECT_BINARY_DIR&#125;</span>)</span><br><span class="line">	<span class="keyword">message</span>(FATAL_ERROR <span class="string">"In-source builds not allowed. Please make a new directory (called a build directory) and run CMake from there."</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>
<p>认识到构建结构与源结构类似很有用。示例中，将<code>message</code>打印输出插入到<code>src/CMakeLists.txt</code>中:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">message</span><span class="params">(<span class="string">"current binary dir is $&#123;CMAKE_CURRENT_BINARY_DIR&#125;"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>在<code>build</code>下构建项目时，我们将看到<code>build/src</code>的打印输出。</p>
<p>在CMake的3.12版本中，<code>OBJECT</code>库是组织大型项目的另一种可行方法。对我们的示例的惟一修改是在库的<code>CMakeLists.tx</code>t中。源文件将被编译成目标文件：既不存档到静态库中，也不链接到动态库中。例如：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_library</span><span class="params">(io OBJECT <span class="string">""</span>)</span></span></span><br><span class="line"></span><br><span class="line">target_sources(io</span><br><span class="line">  PRIVATE</span><br><span class="line">  	io.cpp</span><br><span class="line">  PUBLIC</span><br><span class="line">  	$&#123;CMAKE_CURRENT_LIST_DIR&#125;/io.hpp</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">target_include_directories(io</span><br><span class="line">  PUBLIC</span><br><span class="line">  	$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>主<code>CMakeLists.txt</code>保持不变:<code>automata</code>可执行目标将这些目标文件链接到最终的可执行文件。使用也有要求需求，例如：在对象库上设置的目录、编译标志和链接库，将被正确地继承。有关CMake 3.12中引入的对象库新特性的更多细节，请参考官方文档: <a href="https://cmake.org/cmake/help/v3.12/manual/cmake-buildsystem.7.html#object-libraries" target="_blank" rel="noopener">https://cmake.org/cmake/help/v3.12/manual/cmake-buildsystem.7.html#object-libraries</a></p>
<h1 id="7-8-使用target-sources避免全局变量"><a href="#7-8-使用target-sources避免全局变量" class="headerlink" title="7.8 使用target_sources避免全局变量"></a>7.8 使用target_sources避免全局变量</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-08" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-08</a> 中找到，其中有一个C++示例。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>本示例中，我们将讨论前一个示例的另一种方法，并不使用<code>add_subdirectory</code>的情况下，使用<code>module include</code>组装不同的CMakeLists.txt文件。这种方法的灵感来自<a href="https://crascit.com/2016/01/31/enhance-sours-file-handling-with-target_sources/" target="_blank" rel="noopener">https://crascit.com/2016/01/31/enhance-sours-file-handling-with-target_sources/</a> ，其允许我们使用<code>target_link_libraries</code>链接到当前目录之外定义的目标。</p>
<h2 id="准备工作-7"><a href="#准备工作-7" class="headerlink" title="准备工作"></a>准备工作</h2><p>将使用与前一个示例相同的源代码。惟一的更改将出现在<code>CMakeLists.txt</code>文件中，我们将在下面的部分中讨论这些更改。</p>
<h2 id="具体实施-7"><a href="#具体实施-7" class="headerlink" title="具体实施"></a>具体实施</h2><ol>
<li><p>主<code>CMakeLists.txt</code>包含以下内容:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(<span class="name">VERSION</span> <span class="number">3.5</span> FATAL_ERROR)</span><br><span class="line"></span><br><span class="line">project(<span class="name">recipe-08</span> LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line">set(<span class="name">CMAKE_CXX_STANDARD</span> <span class="number">11</span>)</span><br><span class="line">set(<span class="name">CMAKE_CXX_EXTENSIONS</span> OFF)</span><br><span class="line">set(<span class="name">CMAKE_CXX_STANDARD_REQUIRED</span> ON)</span><br><span class="line"></span><br><span class="line">include(<span class="name">GNUInstallDirs</span>)</span><br><span class="line">set(<span class="name">CMAKE_ARCHIVE_OUTPUT_DIRECTORY</span></span><br><span class="line">$&#123;CMAKE_BINARY_DIR&#125;/$&#123;CMAKE_INSTALL_LIBDIR&#125;)</span><br><span class="line">set(<span class="name">CMAKE_LIBRARY_OUTPUT_DIRECTORY</span></span><br><span class="line">$&#123;CMAKE_BINARY_DIR&#125;/$&#123;CMAKE_INSTALL_LIBDIR&#125;)</span><br><span class="line">set(<span class="name">CMAKE_RUNTIME_OUTPUT_DIRECTORY</span></span><br><span class="line">$&#123;CMAKE_BINARY_DIR&#125;/$&#123;CMAKE_INSTALL_BINDIR&#125;)</span><br><span class="line"></span><br><span class="line"># defines targets and sources</span><br><span class="line">include(<span class="name">src/CMakeLists</span>.txt)</span><br><span class="line">include(<span class="name">external/CMakeLists</span>.txt)</span><br><span class="line"></span><br><span class="line">enable_testing()</span><br><span class="line">add_subdirectory(<span class="name">tests</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>与前一个示例相比，<code>external/CMakeLists.txt</code>文件没有变化。</p>
</li>
<li><p><code>src/CMakeLists.txt</code>文件定义了两个库(automaton和evolution):</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_library</span><span class="params">(automaton <span class="string">""</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">add_library</span><span class="params">(evolution <span class="string">""</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">include</span><span class="params">($&#123;CMAKE_CURRENT_LIST_DIR&#125;/evolution/CMakeLists.txt)</span></span></span><br><span class="line"><span class="function"><span class="title">include</span><span class="params">($&#123;CMAKE_CURRENT_LIST_DIR&#125;/initial/CMakeLists.txt)</span></span></span><br><span class="line"><span class="function"><span class="title">include</span><span class="params">($&#123;CMAKE_CURRENT_LIST_DIR&#125;/io/CMakeLists.txt)</span></span></span><br><span class="line"><span class="function"><span class="title">include</span><span class="params">($&#123;CMAKE_CURRENT_LIST_DIR&#125;/parser/CMakeLists.txt)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">add_executable</span><span class="params">(automata <span class="string">""</span>)</span></span></span><br><span class="line"></span><br><span class="line">target_sources(automata</span><br><span class="line">  PRIVATE</span><br><span class="line">  	$&#123;CMAKE_CURRENT_LIST_DIR&#125;/main.cpp</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">target_link_libraries(automata</span><br><span class="line">  PRIVATE</span><br><span class="line">    automaton</span><br><span class="line">    conversion</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>src/evolution/CMakeLists.txt</code>文件包含以下内容:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_sources</span>(automaton</span><br><span class="line">  PRIVATE</span><br><span class="line">  	<span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>/evolution.cpp</span><br><span class="line">  PUBLIC</span><br><span class="line">  	<span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>/evolution.hpp</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line"><span class="keyword">target_include_directories</span>(automaton</span><br><span class="line">  PUBLIC</span><br><span class="line">  	<span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span></span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line"><span class="keyword">target_sources</span>(evolution</span><br><span class="line">  PRIVATE</span><br><span class="line">  	<span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>/evolution.cpp</span><br><span class="line">  PUBLIC</span><br><span class="line">  	<span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>/evolution.hpp</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line"><span class="keyword">target_include_directories</span>(evolution</span><br><span class="line">  PUBLIC</span><br><span class="line">  	<span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>其余<code>CMakeLists.txt</code>文件和<code>src/initial/CMakeLists.txt</code>相同:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">target_sources</span>(automaton</span><br><span class="line">  PRIVATE</span><br><span class="line">  	<span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>/initial.cpp</span><br><span class="line">  PUBLIC</span><br><span class="line">  	<span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span>/initial.hpp</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_include_directories</span>(automaton</span><br><span class="line">  PUBLIC</span><br><span class="line">  	<span class="variable">$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置、构建和测试的结果与前面的方法相同:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p build</span><br><span class="line">$ cd build</span><br><span class="line">$ cmake <span class="built_in">..</span></span><br><span class="line">$ cmake --build build</span><br><span class="line">$ ctest</span><br><span class="line"></span><br><span class="line">Running tests<span class="built_in">..</span>.</span><br><span class="line">Start 1: test_evolution</span><br><span class="line">1/1 Test #1: test_evolution <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>. Passed 0.00 sec</span><br><span class="line">100% tests passed, 0 tests failed out of 1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-7"><a href="#工作原理-7" class="headerlink" title="工作原理"></a>工作原理</h2><p>与之前的示例不同，我们定义了三个库:</p>
<ul>
<li>conversion(在external定义)</li>
<li>automaton(包含除转换之外的所有源)</li>
<li>evolution(在<code>src/evolution</code>中定义，并通过<code>cpp_test</code>链接)</li>
</ul>
<p>本例中，通过使用<code>include()</code>引用<code>CMakeLists.txt</code>文件，我们在父范围内，仍然能保持所有目标可用:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">include</span><span class="params">(src/CMakeLists.txt)</span></span></span><br><span class="line"><span class="function"><span class="title">include</span><span class="params">(external/CMakeLists.txt)</span></span></span><br></pre></td></tr></table></figure>
<p>我们可以构建一个包含树，记住当进入子目录(<code>src/CMakeLists.txt</code>)时，我们需要使用相对于父范围的路径:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">include</span><span class="params">($&#123;CMAKE_CURRENT_LIST_DIR&#125;/evolution/CMakeLists.txt)</span></span></span><br><span class="line"><span class="function"><span class="title">include</span><span class="params">($&#123;CMAKE_CURRENT_LIST_DIR&#125;/initial/CMakeLists.txt)</span></span></span><br><span class="line"><span class="function"><span class="title">include</span><span class="params">($&#123;CMAKE_CURRENT_LIST_DIR&#125;/io/CMakeLists.txt)</span></span></span><br><span class="line"><span class="function"><span class="title">include</span><span class="params">($&#123;CMAKE_CURRENT_LIST_DIR&#125;/parser/CMakeLists.txt)</span></span></span><br></pre></td></tr></table></figure>
<p>这样，我们就可以定义并链接到通过<code>include()</code>语句访问文件树中任何位置的目标。但是，我们应该选择在对维护人员和代码贡献者容易看到的地方，去定义它们。</p>
<h2 id="更多信息-5"><a href="#更多信息-5" class="headerlink" title="更多信息"></a>更多信息</h2><p>我们可以再次使用CMake和Graphviz (<a href="http://www.graphviz.org/)生成这个项目的依赖关系图" target="_blank" rel="noopener">http://www.graphviz.org/)生成这个项目的依赖关系图</a>:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> build</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cmake --graphviz=example.dot ..</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> dot -T png example.dot -o example.png</span></span><br></pre></td></tr></table></figure>
<h1 id="7-9-组织Fortran项目"><a href="#7-9-组织Fortran项目" class="headerlink" title="7.9 组织Fortran项目"></a>7.9 组织Fortran项目</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-09" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-7/recipe-09</a> 中找到，其中有一个Fortran示例。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>我们来讨论如何构造和组织Fortran项目，原因有二:</p>
<ol>
<li>现在，仍然有很多Fortran项目，特别是在数字软件中(有关通用Fortran软件项目的更全面列表，请参见<a href="http://fortranwiki.org/fortran/show/Libraries" target="_blank" rel="noopener">http://fortranwiki.org/fortran/show/Libraries</a> )。</li>
<li>对于不使用CMake的项目，Fortran 90(以及更高版本)可能更难构建，因为Fortran模块强制执行编译顺序。换句话说，对于手工编写的Makefile，通常需要为Fortran模块文件编写依赖扫描程序。</li>
</ol>
<p>正如我们在本示例中所示，现代CMake允许我们以非常紧凑和模块化的方式配置和构建项目。作为一个例子，我们将使用前两个示例中的基本元胞自动机，现在将其移植到Fortran。</p>
<h2 id="准备工作-8"><a href="#准备工作-8" class="headerlink" title="准备工作"></a>准备工作</h2><p>文件树结构与前两个示例非常相似。我们用Fortran源代码替换了C++，现在就没有头文件了:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br><span class="line">├── <span class="selector-tag">external</span></span><br><span class="line">│    ├── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br><span class="line">│    ├── <span class="selector-tag">conversion</span><span class="selector-class">.f90</span></span><br><span class="line">│    └── <span class="selector-tag">README</span><span class="selector-class">.md</span></span><br><span class="line">├── <span class="selector-tag">src</span></span><br><span class="line">│    ├── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br><span class="line">│    ├── <span class="selector-tag">evolution</span></span><br><span class="line">│    │    ├── <span class="selector-tag">ancestors</span><span class="selector-class">.f90</span></span><br><span class="line">│    │    ├── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br><span class="line">│    │    ├── <span class="selector-tag">empty</span><span class="selector-class">.f90</span></span><br><span class="line">│    │    └── <span class="selector-tag">evolution</span><span class="selector-class">.f90</span></span><br><span class="line">│    ├── <span class="selector-tag">initial</span></span><br><span class="line">│    │    ├── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br><span class="line">│    │    └── <span class="selector-tag">initial</span><span class="selector-class">.f90</span></span><br><span class="line">│    ├── <span class="selector-tag">io</span></span><br><span class="line">│    │    ├── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br><span class="line">│    │    └── <span class="selector-tag">io</span><span class="selector-class">.f90</span></span><br><span class="line">│    ├── <span class="selector-tag">main</span><span class="selector-class">.f90</span></span><br><span class="line">│    └── <span class="selector-tag">parser</span></span><br><span class="line">│        ├── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br><span class="line">│        └── <span class="selector-tag">parser</span><span class="selector-class">.f90</span></span><br><span class="line">└── <span class="selector-tag">tests</span></span><br><span class="line">    ├── <span class="selector-tag">CMakeLists</span><span class="selector-class">.txt</span></span><br><span class="line">    └── <span class="selector-tag">test</span><span class="selector-class">.f90</span></span><br></pre></td></tr></table></figure>
<p>主程序在<code>src/main.f90</code>中:</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">program</span></span> example</span><br><span class="line"></span><br><span class="line">  <span class="keyword">use</span> parser, <span class="keyword">only</span>: get_arg_as_int</span><br><span class="line">  <span class="keyword">use</span> conversion, <span class="keyword">only</span>: binary_representation</span><br><span class="line">  <span class="keyword">use</span> initial, <span class="keyword">only</span>: initial_distribution</span><br><span class="line">  <span class="keyword">use</span> io, <span class="keyword">only</span>: print_row</span><br><span class="line">  <span class="keyword">use</span> evolution, <span class="keyword">only</span>: evolve</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">none</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">integer</span> :: num_steps</span><br><span class="line">  <span class="keyword">integer</span> :: length</span><br><span class="line">  <span class="keyword">integer</span> :: rule_decimal</span><br><span class="line">  <span class="keyword">integer</span> :: rule_binary(<span class="number">8</span>)</span><br><span class="line">  <span class="keyword">integer</span>, <span class="keyword">allocatable</span> :: row(:)</span><br><span class="line">  <span class="keyword">integer</span> :: step</span><br><span class="line">  </span><br><span class="line">  <span class="comment">! parse arguments</span></span><br><span class="line">  num_steps = get_arg_as_int(<span class="number">1</span>)</span><br><span class="line">  length = get_arg_as_int(<span class="number">2</span>)</span><br><span class="line">  rule_decimal = get_arg_as_int(<span class="number">3</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">! print information about parameters</span></span><br><span class="line">  <span class="built_in">print</span> *, <span class="string">"number of steps: "</span>, num_steps</span><br><span class="line">  <span class="built_in">print</span> *, <span class="string">"length: "</span>, length</span><br><span class="line">  <span class="built_in">print</span> *, <span class="string">"rule: "</span>, rule_decimal</span><br><span class="line">  </span><br><span class="line">  <span class="comment">! obtain binary representation for the rule</span></span><br><span class="line">  rule_binary = binary_representation(rule_decimal)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">! create initial distribution</span></span><br><span class="line">  <span class="built_in">allocate</span>(row(length))</span><br><span class="line">  <span class="keyword">call</span> initial_distribution(row)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">! print initial configuration</span></span><br><span class="line">  <span class="keyword">call</span> print_row(row)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">! the system evolves, print each step</span></span><br><span class="line">  <span class="keyword">do</span> step = <span class="number">1</span>, num_steps</span><br><span class="line">    <span class="keyword">call</span> evolve(row, rule_binary)</span><br><span class="line">    <span class="keyword">call</span> print_row(row)</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">do</span></span><br><span class="line">  </span><br><span class="line">  <span class="built_in">deallocate</span>(row)</span><br><span class="line"><span class="keyword">end</span> <span class="function"><span class="keyword">program</span></span></span><br></pre></td></tr></table></figure>
<p>与前面的示例一样，我们已经将conversion模块放入<code>external/conversion.f90</code>中：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> conversion</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">none</span></span><br><span class="line">  <span class="keyword">public</span> binary_representation</span><br><span class="line">  <span class="keyword">private</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">contains</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">pure</span> <span class="function"><span class="keyword">function</span></span> binary_representation(n_decimal)</span><br><span class="line">    <span class="keyword">integer</span>, <span class="keyword">intent</span>(<span class="keyword">in</span>) :: n_decimal</span><br><span class="line">    <span class="keyword">integer</span> :: binary_representation(<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">integer</span> :: pos</span><br><span class="line">    <span class="keyword">integer</span> :: n</span><br><span class="line">    </span><br><span class="line">    binary_representation = <span class="number">0</span></span><br><span class="line">    pos = <span class="number">8</span></span><br><span class="line">    n = n_decimal</span><br><span class="line">    <span class="keyword">do</span> <span class="keyword">while</span> (n &gt; <span class="number">0</span>)</span><br><span class="line">      binary_representation(pos) = <span class="built_in">mod</span>(n, <span class="number">2</span>)</span><br><span class="line">      n = (n - binary_representation(pos))/<span class="number">2</span></span><br><span class="line">      pos = pos - <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">end</span> <span class="function"><span class="keyword">function</span></span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">end</span> <span class="keyword">module</span></span><br></pre></td></tr></table></figure>
<p>evolution库分成三个文件，大部分在<code>src/evolution/evolution.f90</code>中:</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> evolution</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">none</span></span><br><span class="line">  <span class="keyword">public</span> evolve</span><br><span class="line">  <span class="keyword">private</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">contains</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">subroutine</span></span> not_visible()</span><br><span class="line">    <span class="comment">! no-op call to demonstrate private/public visibility</span></span><br><span class="line">    <span class="keyword">call</span> empty_subroutine_no_interface()</span><br><span class="line">  <span class="keyword">end</span> <span class="function"><span class="keyword">subroutine</span></span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">pure</span> <span class="function"><span class="keyword">subroutine</span></span> evolve(row, rule_binary)</span><br><span class="line">    <span class="keyword">use</span> ancestors, <span class="keyword">only</span>: compute_ancestors</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">integer</span>, <span class="keyword">intent</span>(inout) :: row(:)</span><br><span class="line">    <span class="keyword">integer</span>, <span class="keyword">intent</span>(<span class="keyword">in</span>) :: rule_binary(<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">integer</span> :: i</span><br><span class="line">    <span class="keyword">integer</span> :: left, center, right</span><br><span class="line">    <span class="keyword">integer</span> :: ancestry</span><br><span class="line">    <span class="keyword">integer</span>, <span class="keyword">allocatable</span> :: new_row(:)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">allocate</span>(new_row(<span class="built_in">size</span>(row)))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">do</span> i = <span class="number">1</span>, <span class="built_in">size</span>(row)</span><br><span class="line">      left = i - <span class="number">1</span></span><br><span class="line">      center = i</span><br><span class="line">      right = i + <span class="number">1</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (left &lt; <span class="number">1</span>) left = left + <span class="built_in">size</span>(row)</span><br><span class="line">      <span class="keyword">if</span> (right &gt; <span class="built_in">size</span>(row)) right = right - <span class="built_in">size</span>(row)</span><br><span class="line">      </span><br><span class="line">      ancestry = compute_ancestors(row, left, center, right)</span><br><span class="line">      new_row(i) = rule_binary(ancestry)</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">do</span></span><br><span class="line">    </span><br><span class="line">    row = new_row</span><br><span class="line">    <span class="built_in">deallocate</span>(new_row)</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">end</span> <span class="function"><span class="keyword">subroutine</span></span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">end</span> <span class="keyword">module</span></span><br></pre></td></tr></table></figure>
<p>祖先计算是在<code>src/evolution/ancestors.f90</code>：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> ancestors</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">none</span></span><br><span class="line">  <span class="keyword">public</span> compute_ancestors</span><br><span class="line">  <span class="keyword">private</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">contains</span></span><br><span class="line">  <span class="keyword">pure</span> <span class="keyword">integer</span> <span class="function"><span class="keyword">function</span></span> compute_ancestors(row, left, center, right) result(i)</span><br><span class="line">    <span class="keyword">integer</span>, <span class="keyword">intent</span>(<span class="keyword">in</span>) :: row(:)</span><br><span class="line">    <span class="keyword">integer</span>, <span class="keyword">intent</span>(<span class="keyword">in</span>) :: left, center, right</span><br><span class="line">    </span><br><span class="line">    i = <span class="number">4</span>*row(left) + <span class="number">2</span>*row(center) + <span class="number">1</span>*row(right)</span><br><span class="line">    i = <span class="number">8</span> - i</span><br><span class="line">  <span class="keyword">end</span> <span class="function"><span class="keyword">function</span></span></span><br><span class="line"><span class="keyword">end</span> <span class="keyword">module</span></span><br></pre></td></tr></table></figure>
<p>还有一个“空”模块在<code>src/evolution/empty.f90</code>中：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> empty</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">none</span></span><br><span class="line">  <span class="keyword">public</span> empty_subroutine</span><br><span class="line">  <span class="keyword">private</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">contains</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">subroutine</span></span> empty_subroutine()</span><br><span class="line">  <span class="keyword">end</span> <span class="function"><span class="keyword">subroutine</span></span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">end</span> <span class="keyword">module</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">subroutine</span></span> </span><br><span class="line">empty_subroutine_no_interface()</span><br><span class="line">  <span class="keyword">use</span> empty, <span class="keyword">only</span>: empty_subroutine</span><br><span class="line">  <span class="keyword">call</span> empty_subroutine()</span><br><span class="line"><span class="keyword">end</span> <span class="function"><span class="keyword">subroutine</span></span></span><br></pre></td></tr></table></figure>
<p>启动条件的代码位于<code>src/initial/initial.f90</code>：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> initial</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">none</span></span><br><span class="line">  <span class="keyword">public</span> initial_distribution</span><br><span class="line">  <span class="keyword">private</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">contains</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">pure</span> <span class="function"><span class="keyword">subroutine</span></span> initial_distribution(row)</span><br><span class="line">    <span class="keyword">integer</span>, <span class="keyword">intent</span>(<span class="keyword">out</span>) :: row(:)</span><br><span class="line">    </span><br><span class="line">    row = <span class="number">0</span></span><br><span class="line">    row(<span class="built_in">size</span>(row)/<span class="number">2</span>) = <span class="number">1</span></span><br><span class="line">	<span class="keyword">end</span> <span class="function"><span class="keyword">subroutine</span></span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">end</span> <span class="keyword">module</span></span><br></pre></td></tr></table></figure>
<p><code>src/io/io.f90</code>包含一个打印输出：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> io</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">none</span></span><br><span class="line">  <span class="keyword">public</span> print_row</span><br><span class="line">  <span class="keyword">private</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">contains</span></span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">subroutine</span></span> print_row(row)</span><br><span class="line">    <span class="keyword">integer</span>, <span class="keyword">intent</span>(<span class="keyword">in</span>) :: row(:)</span><br><span class="line">    <span class="keyword">character</span>(<span class="built_in">size</span>(row)) :: line</span><br><span class="line">    <span class="keyword">integer</span> :: i</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">do</span> i = <span class="number">1</span>, <span class="built_in">size</span>(row)</span><br><span class="line">      <span class="keyword">if</span> (row(i) == <span class="number">1</span>) <span class="keyword">then</span></span><br><span class="line">      	line(i:i) = <span class="string">'*'</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      	line(i:i) = <span class="string">' '</span></span><br><span class="line">      <span class="keyword">end</span> <span class="keyword">if</span></span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">do</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span> *, line</span><br><span class="line">  <span class="keyword">end</span> <span class="function"><span class="keyword">subroutine</span></span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">end</span> <span class="keyword">module</span></span><br></pre></td></tr></table></figure>
<p><code>src/parser/parser.f90</code>用于解析命令行参数：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> parser</span><br><span class="line"></span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">none</span></span><br><span class="line">  <span class="keyword">public</span> get_arg_as_int</span><br><span class="line">  <span class="keyword">private</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">contains</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">integer</span> <span class="function"><span class="keyword">function</span></span> get_arg_as_int(n) result(i)</span><br><span class="line">    <span class="keyword">integer</span>, <span class="keyword">intent</span>(<span class="keyword">in</span>) :: n</span><br><span class="line">    <span class="keyword">character</span>(len=<span class="number">32</span>) :: arg</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">call</span> <span class="built_in">get_command_argument</span>(n, arg)</span><br><span class="line">    read(arg , *) i</span><br><span class="line">  <span class="keyword">end</span> <span class="function"><span class="keyword">function</span></span></span><br><span class="line"><span class="keyword">end</span> <span class="keyword">module</span></span><br></pre></td></tr></table></figure>
<p>最后，使用<code>tests/test.f90</code>对上面的实现进行测试：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">program</span></span> test</span><br><span class="line"></span><br><span class="line">  <span class="keyword">use</span> evolution, <span class="keyword">only</span>: evolve</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">implicit</span> <span class="keyword">none</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">integer</span> :: row(<span class="number">9</span>)</span><br><span class="line">  <span class="keyword">integer</span> :: expected_result(<span class="number">9</span>)</span><br><span class="line">  <span class="keyword">integer</span> :: rule_binary(<span class="number">8</span>)</span><br><span class="line">  <span class="keyword">integer</span> :: i</span><br><span class="line">  </span><br><span class="line">  <span class="comment">! test rule 90</span></span><br><span class="line">  row = (/<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>/)</span><br><span class="line">  rule_binary = (/<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>/)</span><br><span class="line">  <span class="keyword">call</span> evolve(row, rule_binary)</span><br><span class="line">  expected_result = (/<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>/)</span><br><span class="line">  <span class="keyword">do</span> i = <span class="number">1</span>, <span class="number">9</span></span><br><span class="line">  	<span class="keyword">if</span> (row(i) /= expected_result(i)) <span class="keyword">then</span></span><br><span class="line">  		<span class="built_in">print</span> *, <span class="string">'ERROR: test for rule 90 failed'</span></span><br><span class="line">  		<span class="keyword">call</span> <span class="keyword">exit</span>(<span class="number">1</span>)</span><br><span class="line">  	<span class="keyword">end</span> <span class="keyword">if</span></span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">do</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">! test rule 222</span></span><br><span class="line">  row = (/<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>/)</span><br><span class="line">  rule_binary = (/<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>/)</span><br><span class="line">  <span class="keyword">call</span> evolve(row, rule_binary)</span><br><span class="line">  expected_result = (/<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>/)</span><br><span class="line">  <span class="keyword">do</span> i = <span class="number">1</span>, <span class="number">9</span></span><br><span class="line">  	<span class="keyword">if</span> (row(i) /= expected_result(i)) <span class="keyword">then</span></span><br><span class="line">  		<span class="built_in">print</span> *, <span class="string">'ERROR: test for rule 222 failed'</span></span><br><span class="line">  		<span class="keyword">call</span> <span class="keyword">exit</span>(<span class="number">1</span>)</span><br><span class="line">  	<span class="keyword">end</span> <span class="keyword">if</span></span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">do</span></span><br><span class="line"><span class="keyword">end</span> <span class="function"><span class="keyword">program</span></span></span><br></pre></td></tr></table></figure>
<h2 id="具体实施-8"><a href="#具体实施-8" class="headerlink" title="具体实施"></a>具体实施</h2><ol>
<li><p>主<code>CMakeLists.txt</code>类似于第7节，我们只是将CXX换成Fortran，去掉C++11的要求:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.5</span> FATAL_ERROR)</span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span>(recipe-<span class="number">09</span> LANGUAGES Fortran)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(GNUInstallDirs)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_ARCHIVE_OUTPUT_DIRECTORY</span><br><span class="line"><span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/<span class="variable">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_LIBRARY_OUTPUT_DIRECTORY</span><br><span class="line"><span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/<span class="variable">$&#123;CMAKE_INSTALL_LIBDIR&#125;</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_RUNTIME_OUTPUT_DIRECTORY</span><br><span class="line"><span class="variable">$&#123;CMAKE_BINARY_DIR&#125;</span>/<span class="variable">$&#123;CMAKE_INSTALL_BINDIR&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># defines targets and sources</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(src)</span><br><span class="line"></span><br><span class="line"><span class="comment"># contains an "external" library we will link to</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(external)</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable testing and define tests</span></span><br><span class="line"><span class="keyword">enable_testing</span>()</span><br><span class="line"><span class="keyword">add_subdirectory</span>(tests)</span><br></pre></td></tr></table></figure>
</li>
<li><p>目标和源在<code>src/CMakeLists.txt</code>中定义(conversion目标除外):</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_executable</span><span class="params">(automata main.f90)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(evolution)</span></span></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(initial)</span></span></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(io)</span></span></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(parser)</span></span></span><br><span class="line"></span><br><span class="line">target_link_libraries(automata</span><br><span class="line">  PRIVATE</span><br><span class="line">    conversion</span><br><span class="line">    evolution</span><br><span class="line">    <span class="attribute">initial</span></span><br><span class="line">    io</span><br><span class="line">    parser</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>conversion库在<code>external/CMakeLists.txt</code>中定义:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_library</span><span class="params">(conversion <span class="string">""</span>)</span></span></span><br><span class="line"></span><br><span class="line">target_sources(conversion</span><br><span class="line">  PUBLIC</span><br><span class="line">  	$&#123;CMAKE_CURRENT_LIST_DIR&#125;/conversion.f90</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>src/CMakeLists.txt</code>文件添加了更多的子目录，这些子目录又包含<code>CMakeLists.txt</code>文件。它们在结构上都是相似的，例如：<code>src/initial/CMakeLists.txt</code>包含以下内容:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add_library(<span class="name">initial</span> <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">target_sources(<span class="name">initial</span></span><br><span class="line">  PUBLIC</span><br><span class="line">  	$&#123;CMAKE_CURRENT_LIST_DIR&#125;/initial.f90</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>有个例外的是<code>src/evolution/CMakeLists.txt</code>中的evolution库，我们将其分为三个源文件:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_library</span><span class="params">(evolution <span class="string">""</span>)</span></span></span><br><span class="line"></span><br><span class="line">target_sources(evolution</span><br><span class="line">  PRIVATE</span><br><span class="line">  	empty.f90</span><br><span class="line">  PUBLIC</span><br><span class="line">  	$&#123;CMAKE_CURRENT_LIST_DIR&#125;/ancestors.f90</span><br><span class="line">  	$&#123;CMAKE_CURRENT_LIST_DIR&#125;/evolution.f90</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>单元测试在<code>tests/CMakeLists.txt</code>中注册:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">add_executable(<span class="name">fortran_test</span> test.f90)</span><br><span class="line"></span><br><span class="line">target_link_libraries(<span class="name">fortran_test</span> evolution)</span><br><span class="line"></span><br><span class="line">add_test(</span><br><span class="line">  NAME</span><br><span class="line">  	test_evolution</span><br><span class="line">  COMMAND</span><br><span class="line">  	$&lt;TARGET_FILE<span class="symbol">:fortran_test&gt;</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置和构建项目，将产生以下输出:</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p build</span><br><span class="line">$ cd build</span><br><span class="line">$ cmake ..</span><br><span class="line">$ cmake --build .</span><br><span class="line">Scanning <span class="built_in">dependencies</span> of target conversion</span><br><span class="line">[ <span class="number">4</span><span class="symbol">%</span>] Building Fortran object external/CMakeFiles/conversion.dir/conversion.<span class="built_in">f90</span>.o</span><br><span class="line">[ <span class="number">8</span><span class="symbol">%</span>] Linking Fortran static library ../lib64/libconversion.a</span><br><span class="line">[ <span class="number">8</span><span class="symbol">%</span>] Built target conversion</span><br><span class="line">Scanning <span class="built_in">dependencies</span> of target <span class="built_in">evolution</span></span><br><span class="line">[ <span class="number">12</span><span class="symbol">%</span>] Building Fortran object src/<span class="built_in">evolution</span>/CMakeFiles/<span class="built_in">evolution</span>.dir/ancestors.<span class="built_in">f90</span>.o</span><br><span class="line">[ <span class="number">16</span><span class="symbol">%</span>] Building Fortran object src/<span class="built_in">evolution</span>/CMakeFiles/<span class="built_in">evolution</span>.dir/empty.<span class="built_in">f90</span>.o</span><br><span class="line">[ <span class="number">20</span><span class="symbol">%</span>] Building Fortran object src/<span class="built_in">evolution</span>/CMakeFiles/<span class="built_in">evolution</span>.dir/<span class="built_in">evolution</span>.<span class="built_in">f90</span>.o</span><br><span class="line">[ <span class="number">25</span><span class="symbol">%</span>] Linking Fortran static library ../../lib64/libevolution.a</span><br><span class="line">[ <span class="number">25</span><span class="symbol">%</span>] Built target <span class="built_in">evolution</span></span><br><span class="line">Scanning <span class="built_in">dependencies</span> of target initial</span><br><span class="line">[ <span class="number">29</span><span class="symbol">%</span>] Building Fortran object src/initial/CMakeFiles/initial.dir/initial.<span class="built_in">f90</span>.o</span><br><span class="line">[ <span class="number">33</span><span class="symbol">%</span>] Linking Fortran static library ../../lib64/libinitial.a</span><br><span class="line">[ <span class="number">33</span><span class="symbol">%</span>] Built target initial</span><br><span class="line">Scanning <span class="built_in">dependencies</span> of target io</span><br><span class="line">[ <span class="number">37</span><span class="symbol">%</span>] Building Fortran object src/io/CMakeFiles/io.dir/io.<span class="built_in">f90</span>.o</span><br><span class="line">[ <span class="number">41</span><span class="symbol">%</span>] Linking Fortran static library ../../lib64/libio.a</span><br><span class="line">[ <span class="number">41</span><span class="symbol">%</span>] Built target io</span><br><span class="line">Scanning <span class="built_in">dependencies</span> of target parser</span><br><span class="line">[ <span class="number">45</span><span class="symbol">%</span>] Building Fortran object src/parser/CMakeFiles/parser.dir/parser.<span class="built_in">f90</span>.o</span><br><span class="line">[ <span class="number">50</span><span class="symbol">%</span>] Linking Fortran static library ../../lib64/libparser.a</span><br><span class="line">[ <span class="number">50</span><span class="symbol">%</span>] Built target parser</span><br><span class="line">Scanning <span class="built_in">dependencies</span> of target <span class="built_in">example</span></span><br><span class="line">[ <span class="number">54</span><span class="symbol">%</span>] Building Fortran object src/CMakeFiles/<span class="built_in">example</span>.dir/<span class="symbol">__</span>/external/conversion.<span class="built_in">f90</span>.o</span><br><span class="line">[ <span class="number">58</span><span class="symbol">%</span>] Building Fortran object src/CMakeFiles/<span class="built_in">example</span>.dir/<span class="built_in">evolution</span>/ancestors.<span class="built_in">f90</span>.o</span><br><span class="line">[ <span class="number">62</span><span class="symbol">%</span>] Building Fortran object src/CMakeFiles/<span class="built_in">example</span>.dir/<span class="built_in">evolution</span>/<span class="built_in">evolution</span>.<span class="built_in">f90</span>.o</span><br><span class="line">[ <span class="number">66</span><span class="symbol">%</span>] Building Fortran object src/CMakeFiles/<span class="built_in">example</span>.dir/initial/initial.<span class="built_in">f90</span>.o</span><br><span class="line">[ <span class="number">70</span><span class="symbol">%</span>] Building Fortran object src/CMakeFiles/<span class="built_in">example</span>.dir/io/io.<span class="built_in">f90</span>.o</span><br><span class="line">[ <span class="number">75</span><span class="symbol">%</span>] Building Fortran object src/CMakeFiles/<span class="built_in">example</span>.dir/parser/parser.<span class="built_in">f90</span>.o</span><br><span class="line">[ <span class="number">79</span><span class="symbol">%</span>] Building Fortran object src/CMakeFiles/<span class="built_in">example</span>.dir/main.<span class="built_in">f90</span>.o</span><br><span class="line">[ <span class="number">83</span><span class="symbol">%</span>] Linking Fortran executable ../bin/<span class="built_in">example</span></span><br><span class="line">[ <span class="number">83</span><span class="symbol">%</span>] Built target <span class="built_in">example</span></span><br><span class="line">Scanning <span class="built_in">dependencies</span> of target fortran_test</span><br><span class="line">[ <span class="number">87</span><span class="symbol">%</span>] Building Fortran object tests/CMakeFiles/fortran_test.dir/<span class="symbol">__</span>/src/<span class="built_in">evolution</span>/ancestors.<span class="built_in">f90</span>.o</span><br><span class="line">[ <span class="number">91</span><span class="symbol">%</span>] Building Fortran object tests/CMakeFiles/fortran_test.dir/<span class="symbol">__</span>/src/<span class="built_in">evolution</span>/<span class="built_in">evolution</span>.<span class="built_in">f90</span>.o</span><br><span class="line">[ <span class="number">95</span><span class="symbol">%</span>] Building Fortran object tests/CMakeFiles/fortran_test.dir/test.<span class="built_in">f90</span>.o</span><br><span class="line">[<span class="number">100</span><span class="symbol">%</span>] Linking Fortran executable</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，运行单元测试：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ctest</span><br><span class="line"></span><br><span class="line">Running tests<span class="built_in">..</span>.</span><br><span class="line">Start 1: test_evolution</span><br><span class="line">1/1 Test #1: test_evolution <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>. Passed 0.00 sec</span><br><span class="line"></span><br><span class="line">100% tests passed, 0 tests failed out of 1</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-8"><a href="#工作原理-8" class="headerlink" title="工作原理"></a>工作原理</h2><p>第7节中使用<code>add_subdirectory</code>限制范围，将从下往上讨论CMake结构，从定义每个库的单个<code>CMakeLists.txt</code>文件开始，比如<code>src/evolution/CMakeLists.txt</code>:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_library</span><span class="params">(evolution <span class="string">""</span>)</span></span></span><br><span class="line">target_sources(evolution</span><br><span class="line">  PRIVATE</span><br><span class="line">  	empty.f90</span><br><span class="line">  PUBLIC</span><br><span class="line">    $&#123;CMAKE_CURRENT_LIST_DIR&#125;/ancestors.f90</span><br><span class="line">    $&#123;CMAKE_CURRENT_LIST_DIR&#125;/evolution.f90</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>这些独立的<code>CMakeLists.txt</code>文件定义了源文件的库，遵循与前两个示例相同的方式：开发或维护人员可以对其中文件分而治之。</p>
<p>首先用<code>add_library</code>定义库名，然后定义它的源和包含目录，以及它们的目标可见性。这种情况下，因为它们的模块接口是在库之外访问，所以<code>ancestors.f90</code>和<code>evolution.f90</code>都是<code>PUBLIC</code>，而模块接口<code>empty.f90</code>不能在文件之外访问，因此将其标记为<code>PRIVATE</code>。</p>
<p>向上移动一层，库在<code>src/CMakeLists.txt</code>中封装：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_executable</span><span class="params">(automata main.f90)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(evolution)</span></span></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(initial)</span></span></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(io)</span></span></span><br><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(parser)</span></span></span><br><span class="line"></span><br><span class="line">target_link_libraries(automata</span><br><span class="line">  PRIVATE</span><br><span class="line">    conversion</span><br><span class="line">    evolution</span><br><span class="line">    <span class="attribute">initial</span></span><br><span class="line">    io</span><br><span class="line">    parser</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>这个文件在主<code>CMakeLists.txt</code>中被引用。这意味着我们使用<code>CMakeLists.txt</code>文件(使用<code>add_subdirectory</code>添加)构建项目。正如第7节中讨论的，使用<code>add_subdirectory</code>限制范围，这种方法可以扩展到更大型的项目，而不需要在多个目录之间的全局变量中携带源文件列表，还可以隔离范围和名称空间。</p>
<p>将这个Fortran示例与C++版本(第7节)进行比较，我们可以注意到，在Fortran的情况下，相对的CMake工作量比较小；我们不需要使用<code>target_include_directory</code>，因为没有头文件，接口是通过生成的Fortran模块文件进行通信。另外，我们既不需要担心<code>target_sources</code>中列出的源文件的顺序，也不需要在库之间强制执行任何显式依赖关系。CMake能够从源文件依赖项推断Fortran模块依赖项。使用<code>target_sources</code>与<code>PRIVATE</code>和<code>PUBLIC</code>资源结合使用，以紧凑和健壮的方式表示接口。</p>
<h2 id="更多信息-6"><a href="#更多信息-6" class="headerlink" title="更多信息"></a>更多信息</h2><p>这个示例中，我们没有指定应该放置Fortran模块文件的目录，并且保持了这个透明。模块文件的位置可以通过设置<code>CMAKE_Fortran_MODULE_DIRECTORY</code>变量来指定。注意，也可以将其设置为<code>Fortran_MODULE_DIRECTORY</code>，从而实现更好的控制。详细可见：<a href="https://cmake.org/cmake/help/v3.5/prop_tgt/Fortran_MODULE_DIRECTORY.html" target="_blank" rel="noopener">https://cmake.org/cmake/help/v3.5/prop_tgt/Fortran_MODULE_DIRECTORY.html</a></p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2021/03/100659.html" class="pre-post btn btn-default" title='CMake 完整使用教程 之九 超级构建模式'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">CMake 完整使用教程 之九 超级构建模式</span>
        </a>
    
    
        <a href="/archives/2021/03/100657.html" class="next-post btn btn-default" title='CMake 完整使用教程 之七 生成源码'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">CMake 完整使用教程 之七 生成源码</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#7-1-使用函数和宏重用代码"><span class="toc-text">7.1 使用函数和宏重用代码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-2-将CMake源代码分成模块"><span class="toc-text">7.2 将CMake源代码分成模块</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-1"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-1"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-1"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-1"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-3-编写函数来测试和设置编译器标志"><span class="toc-text">7.3 编写函数来测试和设置编译器标志</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-2"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-2"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-2"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-2"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-4-用指定参数定义函数或宏"><span class="toc-text">7.4 用指定参数定义函数或宏</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-3"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-3"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-3"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-3"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-5-重新定义函数和宏"><span class="toc-text">7.5 重新定义函数和宏</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-4"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-4"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-4"><span class="toc-text">工作原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-6-使用废弃函数、宏和变量"><span class="toc-text">7.6 使用废弃函数、宏和变量</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-5"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-5"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-5"><span class="toc-text">工作原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-7-add-subdirectory的限定范围"><span class="toc-text">7.7 add_subdirectory的限定范围</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-6"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-6"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-6"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-4"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-8-使用target-sources避免全局变量"><span class="toc-text">7.8 使用target_sources避免全局变量</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-7"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-7"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-7"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-5"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7-9-组织Fortran项目"><span class="toc-text">7.9 组织Fortran项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-8"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-8"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-8"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-6"><span class="toc-text">更多信息</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2024&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>