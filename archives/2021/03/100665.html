<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="cmake,qt,c++">


    <meta name="description" content="本章的主要内容有：

将测试部署到CDash面板
CDash面板显示测试覆盖率
使用AddressSanifier向CDash报告内存缺陷
使用ThreadSaniiser向CDash报告数据争...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>CMake 完整使用教程 之十五 测试面板 | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx">


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="CMake 完整使用教程 之十五 测试面板">
            
	            CMake 完整使用教程 之十五 测试面板
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/back/">后端</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/c/">c++</a> <a class="tag-link" href="/tags/cmake/">cmake</a> <a class="tag-link" href="/tags/qt/">qt</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2021/03/29</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>742</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <p>本章的主要内容有：</p>
<ul>
<li>将测试部署到CDash面板</li>
<li>CDash面板显示测试覆盖率</li>
<li>使用AddressSanifier向CDash报告内存缺陷</li>
<li>使用ThreadSaniiser向CDash报告数据争用</li>
</ul>
<p>CDash是一个web服务，用于汇集CTest在测试运行期间、夜间测试期间或在持续集成中的测试结果。</p>
<p>本章中，我们将向CDash报告测试结果。将讨论报告测试覆盖率的策略，以及分别使用AddressSanifier和ThreadSanifier等工具，收集的内存缺陷和数据争用问题。</p>
<p>有两种方法向CDash报告结果：</p>
<ol>
<li>通过构建的测试目标</li>
<li>使用CTest脚本</li>
</ol>
<p>在前两个示例中使用建立测试目标的方式，在后两个示例中使用CTest脚本。</p>
<h2 id="CDash环境"><a href="#CDash环境" class="headerlink" title="CDash环境"></a>CDash环境</h2><p>CDash的安装需要使用PHP和SSL的web服务器(Apache、NGINX或IIS)，并访问MySQL或PostgreSQL数据库服务器。详细讨论CDash web服务的设置超出了本书的范围，读者们可以参考官方文档：<a href="https://public.kitware.com/Wiki/CDash:Installation" target="_blank" rel="noopener">https://public.kitware.com/Wiki/CDash:Installation</a></p>
<p>Kitware提供了两个面板(<a href="https://my.cdash.org/" target="_blank" rel="noopener">https://my.cdash.org</a> 和 <a href="https://open.cdash.org/" target="_blank" rel="noopener">https://open.cdash.org</a> )，因此本章中的示例并不需要安装CDash。我们将在示例中参考已经提供的面板。</p>
<p>对于想要自己安装CDash的读者，我们建议使用MySQL作为后端，因为这是 <a href="https://my.cdash.org/" target="_blank" rel="noopener">https://my.cdash.org</a> 和 <a href="https://open.cdash.org/" target="_blank" rel="noopener">https://open.cdash.org</a> 的配置方式，而且社区也对这种搭配方式进行了测试。</p>
<p><strong>NOTE</strong>:<em>也可以使用Docker来安装CDash。官方镜像的请求在CDash的跟踪器上处于打开状态，网址是<a href="https://github.com/Kitware/CDash/issues/562" target="_blank" rel="noopener">https://github.com/Kitware/CDash/issues/562</a></em></p>
<h1 id="14-1-将测试部署到CDash"><a href="#14-1-将测试部署到CDash" class="headerlink" title="14.1 将测试部署到CDash"></a>14.1 将测试部署到CDash</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-14/recipe-01" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-14/recipe-01</a> 中找到，其中包含一个C++示例。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>本示例中，我们将扩展第4章第1节的测试示例，并将测试结果部署到<a href="https://my.cdash.org/index.php?project=cmake-cookbook" target="_blank" rel="noopener">https://my.cdash.org/index.php?project=cmake-cookbook</a> ，这是在Kitware为社区提供的公共面板( <a href="https://my.cdash.org/" target="_blank" rel="noopener">https://my.cdash.org</a> )的基础上，为本书创建的专属面板。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>我们将从重用第1节中的示例源代码，该测试将整数作为命令行参数进行求和。该示例由三个源文件组成:<code>main.cpp</code>、<code>sum_integer.cpp</code>和<code>sum_integers.hpp</code>。我们还将重用第4章(创建和运行测试)中的<code>test.cpp</code>文件，但这里将它重命名为<code>test_short.cpp</code>。我们将使用<code>test_long.cpp</code>扩展这个例子:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sum_integers.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;numeric&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// creates vector &#123;1, 2, 3, ..., 999, 1000&#125;</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="function"><span class="built_in">vector</span> <span class="title">integers</span><span class="params">(<span class="number">1000</span>)</span></span>;</span><br><span class="line">  <span class="built_in">std</span>::iota(integers.begin(), integers.end(), <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (sum_integers(integers) == <span class="number">500500</span>) &#123;</span><br><span class="line">  	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后，将这些文件组织成以下文件树:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── CTestConfig.cmake</span><br><span class="line">├── src</span><br><span class="line">│    ├── CMakeLists.txt</span><br><span class="line">│    ├── main.cpp</span><br><span class="line">│    ├── sum_integers.cpp</span><br><span class="line">│    └── sum_integers.hpp</span><br><span class="line">└── tests</span><br><span class="line">    ├── CMakeLists.txt</span><br><span class="line">    ├── test_long.cpp</span><br><span class="line">    └── test_short.cpp</span><br></pre></td></tr></table></figure>
<h2 id="具体实施"><a href="#具体实施" class="headerlink" title="具体实施"></a>具体实施</h2><p>现在，我们将演示如何配置、构建、测试。最后，将示例项目的测试结果提交到面板的过程：</p>
<ol>
<li><p>源目标在<code>src/CMakeLists.txt</code>中定义，如下：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># example library</span><br><span class="line">add_library(<span class="name">sum_integers</span> <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">target_sources(<span class="name">sum_integers</span></span><br><span class="line">  PRIVATE</span><br><span class="line">  	sum_integers.cpp</span><br><span class="line">  PUBLIC</span><br><span class="line">  	$&#123;CMAKE_CURRENT_LIST_DIR&#125;/sum_integers.hpp</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">target_include_directories(<span class="name">sum_integers</span></span><br><span class="line">  PUBLIC</span><br><span class="line">  	$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"># main code</span><br><span class="line">add_executable(<span class="name">sum_up</span> main.cpp)</span><br><span class="line"></span><br><span class="line">target_link_libraries(<span class="name">sum_up</span> sum_integers)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>tests/CMakeLists.txt</code>中定义了测试：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">add_executable(<span class="name">test_short</span> test_short.cpp)</span><br><span class="line">target_link_libraries(<span class="name">test_short</span> sum_integers)</span><br><span class="line"></span><br><span class="line">add_executable(<span class="name">test_long</span> test_long.cpp)</span><br><span class="line">target_link_libraries(<span class="name">test_long</span> sum_integers)</span><br><span class="line"></span><br><span class="line">add_test(</span><br><span class="line">  NAME</span><br><span class="line">  	test_short</span><br><span class="line">  COMMAND</span><br><span class="line">  	$&lt;TARGET_FILE<span class="symbol">:test_short&gt;</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">add_test(</span><br><span class="line">  NAME</span><br><span class="line">  	test_long</span><br><span class="line">  COMMAND</span><br><span class="line">  	$&lt;TARGET_FILE<span class="symbol">:test_long&gt;</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>主<code>CMakeLists.txt</code>文件引用前面的两个文件，这个配置中的新元素是<code>include(CTest)</code>，这样就可以向CDash仪表板报告结果：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set minimum cmake version</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.5</span> FATAL_ERROR)</span><br><span class="line"></span><br><span class="line"><span class="comment"># project name and language</span></span><br><span class="line"><span class="keyword">project</span>(recipe-<span class="number">01</span> LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line"><span class="comment"># require C++11</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_EXTENSIONS <span class="keyword">OFF</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD_REQUIRED <span class="keyword">ON</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># process src/CMakeLists.txt</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(src)</span><br><span class="line"><span class="keyword">enable_testing</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># allow to report to a cdash dashboard</span></span><br><span class="line"><span class="keyword">include</span>(CTest)</span><br><span class="line"></span><br><span class="line"><span class="comment"># process tests/CMakeLists.txt</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(tests)</span><br></pre></td></tr></table></figure>
</li>
<li><p>另外，我们创建文件<code>CTestConfig.cmake</code>与主<code>CMakeLists.txt</code>文件位于同一目录中。这个新文件包含以下几行：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_DROP_METHOD <span class="string">"http"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_DROP_SITE <span class="string">"my.cdash.org"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_DROP_LOCATION <span class="string">"/submit.php?project=cmake-cookbook"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_DROP_SITE_CDASH TRUE)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>我们现在已经准备好配置和构建项目：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p build</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> build</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cmake ..</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cmake --build .</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>构建后，运行测试集，并向面板报告测试结果：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ ctest <span class="comment">--dashboard Experimental</span></span><br><span class="line"></span><br><span class="line">Site: larry</span><br><span class="line">Build name: Linux-c++</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">new</span> tag: <span class="number">20180408</span><span class="number">-1449</span> - Experimental</span><br><span class="line">Configure <span class="keyword">project</span></span><br><span class="line"><span class="keyword">Each</span> . represents <span class="number">1024</span> <span class="keyword">bytes</span> <span class="keyword">of</span> <span class="keyword">output</span></span><br><span class="line">. <span class="keyword">Size</span> <span class="keyword">of</span> <span class="keyword">output</span>: <span class="number">0</span>K</span><br><span class="line"><span class="keyword">Build</span> <span class="keyword">project</span></span><br><span class="line"><span class="keyword">Each</span> symbol represents <span class="number">1024</span> <span class="keyword">bytes</span> <span class="keyword">of</span> output.</span><br><span class="line"><span class="string">'!'</span> represents an <span class="keyword">error</span> <span class="keyword">and</span> <span class="string">'*'</span> a warning.</span><br><span class="line">. <span class="keyword">Size</span> <span class="keyword">of</span> <span class="keyword">output</span>: <span class="number">0</span>K</span><br><span class="line"><span class="number">0</span> Compiler <span class="keyword">errors</span></span><br><span class="line"><span class="number">0</span> Compiler <span class="keyword">warnings</span></span><br><span class="line"><span class="keyword">Test</span> <span class="keyword">project</span> /home/<span class="keyword">user</span>/cmake-recipes/chapter<span class="number">-15</span>/recipe<span class="number">-01</span>/cxx-example/<span class="keyword">build</span></span><br><span class="line"><span class="keyword">Start</span> <span class="number">1</span>: test_short</span><br><span class="line"><span class="number">1</span>/<span class="number">2</span> <span class="keyword">Test</span> <span class="comment">#1: test_short ....................... Passed 0.00 sec</span></span><br><span class="line"><span class="keyword">Start</span> <span class="number">2</span>: test_long</span><br><span class="line"><span class="number">2</span>/<span class="number">2</span> <span class="keyword">Test</span> <span class="comment">#2: test_long ........................ Passed 0.00 sec</span></span><br><span class="line"><span class="number">100</span>% tests passed, <span class="number">0</span> tests <span class="keyword">failed</span> <span class="keyword">out</span> <span class="keyword">of</span> <span class="number">2</span></span><br><span class="line">Total <span class="keyword">Test</span> <span class="built_in">time</span> (<span class="built_in">real</span>) = <span class="number">0.01</span> sec</span><br><span class="line">Performing coverage</span><br><span class="line">Cannot find <span class="keyword">any</span> coverage files. Ignoring Coverage request.</span><br><span class="line">Submit files (<span class="keyword">using</span> <span class="keyword">http</span>)</span><br><span class="line"><span class="keyword">Using</span> <span class="keyword">HTTP</span> submit method</span><br><span class="line"><span class="keyword">Drop</span> site:<span class="keyword">http</span>://my.cdash.org/submit.php?<span class="keyword">project</span>=cmake-cookbook</span><br><span class="line">Uploaded: /home/<span class="keyword">user</span>/cmake-recipes/chapter<span class="number">-14</span>/recipe<span class="number">-01</span>/cxx-example/<span class="keyword">build</span>/Testing/<span class="number">20180408</span><span class="number">-1449</span>/Build.xml</span><br><span class="line">Uploaded: /home/<span class="keyword">user</span>/cmake-recipes/chapter<span class="number">-14</span>/recipe<span class="number">-01</span>/cxx-example/<span class="keyword">build</span>/Testing/<span class="number">20180408</span><span class="number">-1449</span>/Configure.xml</span><br><span class="line">Uploaded: /home/<span class="keyword">user</span>/cmake-recipes/chapter<span class="number">-14</span>/recipe<span class="number">-01</span>/cxx-example/<span class="keyword">build</span>/Testing/<span class="number">20180408</span><span class="number">-1449</span>/Test.xml</span><br><span class="line">Submission successful</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，可以在浏览器中看到测试结果(本例中，测试结果上报到 <a href="https://my.cdash.org/index.php?project=cmake-cookbook" target="_blank" rel="noopener">https://my.cdash.org/index.php?project=cmake-cookbook</a> ):</p>
</li>
</ol>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>可以从更高级的角度展示工作流，CTest运行测试并在XML文件中记录结果。然后，将这些XML文件发送到CDash服务器，在那里可以浏览和分析它们。通过单击数字<code>2</code>，获得关于通过或失败测试的更多的细节信息(本例中，没有失败的测试)。如下图所示，详细记录了运行测试的机器的信息，以及时间信息。同样，单个测试的测试输出也可以在线浏览。</p>
<p>CTest支持三种不同的提交模式：</p>
<ul>
<li>实验性构建</li>
<li>夜间构建</li>
<li>持续构建</li>
</ul>
<p>我们使用了<code>ctest --dashboard Experimental</code>(实验性构建提交)，因此，测试结果显示在实验模式之下。实验模式对于测试代码的当前状态、调试新的仪表板脚本、调试CDash服务器或项目非常有用。夜间构建模式，将把代码更新(或降级)到最接近最近夜间构建开始时的存储库，这些可以在<code>CTestConfig.cmake</code>中设置。其为接收更新频繁的项目的所有夜间测试提供一个定义良好的参考。例如，夜间开始时间可以设置为世界时的”午夜”：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_NIGHTLY_START_TIME <span class="string">"00:00:00 UTC"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>持续模式对于集成工作流非常有用，它将把代码更新到最新版本。</p>
<p><strong>TIPS</strong>:<em>构建、测试和提交到实验面板只需要一个命令—<code>cmake --build . --target Experimental</code></em></p>
<h2 id="更多信息"><a href="#更多信息" class="headerlink" title="更多信息"></a>更多信息</h2><p>这个示例中，我们直接从测试目标部署到CDash。我们将在本章后面的第3和第4部分中，使用专用的CTest脚本。</p>
<p>CDash不仅可以监视测试是否通过或失败，还可以看到测试时间。可以为测试计时进行配置：如果测试花费的时间超过分配的时间，它将被标记为失败。这对于基准测试非常有用，可以在重构代码时自动检测性能测试用例的性能情况。</p>
<p>有关CDash定义和配置设置的详细讨论，请参见官方CDash文档，网址为 <a href="https://public.kitware.com/Wiki/CDash:Documentation" target="_blank" rel="noopener">https://public.kitware.com/Wiki/CDash:Documentation</a></p>
<h1 id="14-2-CDash显示测试覆盖率"><a href="#14-2-CDash显示测试覆盖率" class="headerlink" title="14.2 CDash显示测试覆盖率"></a>14.2 CDash显示测试覆盖率</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-14/recipe-02" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-14/recipe-02</a> 中找到，其中包含一个C++示例。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>本示例中，我们将测试覆盖率报告给CDash，面板上将能够逐行浏览测试覆盖率分析，以便识别未测试或未使用的代码。</p>
<h2 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h2><p>我们将扩展前一节的源代码，在<code>src/sum_integers.cpp</code>中做一个小的修改，添加一个函数<code>sum_integers_unused</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sum_integers.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum_integers</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span> integers)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> sum = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> i : integers) &#123;</span><br><span class="line">  	sum += i;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum_integers_unused</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span> integers)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> sum = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> i : integers) &#123;</span><br><span class="line">  	sum += i;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们使用gcov(<a href="https://gcc.gnu.org/onlinedocs/gcc/Gcov.html" target="_blank" rel="noopener">https://gcc.gnu.org/onlinedocs/gcc/Gcov.html</a> )通过覆盖率分析检测这个未使用的代码。</p>
<h2 id="具体实施-1"><a href="#具体实施-1" class="headerlink" title="具体实施"></a>具体实施</h2><p>通过以下步骤，我们将使用覆盖率分析，并将结果上传到面板：</p>
<ol>
<li><p>主<code>CMakeLists.txt</code>和<code>tests/CMakeLists.txt</code>文件与前一个示例相同。</p>
</li>
<li><p>我们将扩展<code>src/CMakeLists.txt</code>，并提供一个选项来添加用于代码覆盖率的编译标志。此选项默认启用:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">option(<span class="name">ENABLE_COVERAGE</span> <span class="string">"Enable coverage"</span> ON)</span><br><span class="line"></span><br><span class="line">if(<span class="name">ENABLE_COVERAGE</span>)</span><br><span class="line">  if(<span class="name">CMAKE_CXX_COMPILER_ID</span> MATCHES GNU)</span><br><span class="line">    message(<span class="name">STATUS</span> <span class="string">"Coverage analysis with gcov enabled"</span>)</span><br><span class="line">    target_compile_options(<span class="name">sum_integers</span></span><br><span class="line">      PUBLIC</span><br><span class="line">      	-fprofile-arcs -ftest-coverage -g</span><br><span class="line">      )</span><br><span class="line">    target_link_libraries(<span class="name">sum_integers</span></span><br><span class="line">      PUBLIC</span><br><span class="line">      	gcov</span><br><span class="line">      )</span><br><span class="line">  else()</span><br><span class="line">  	message(<span class="name">WARNING</span> <span class="string">"Coverage not supported for this compiler"</span>)</span><br><span class="line">  endif()</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，配置、构建，并将结果上传CDash:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p build</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> build</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cmake ..</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cmake --build . --target Experimental</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最后一步，执行测试覆盖率分析:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  Performing coverage</span><br><span class="line">  Processing coverage (each . represents one file):</span><br><span class="line">  ...</span><br><span class="line">  Accumulating results (each . represents one file):</span><br><span class="line">  ...</span><br><span class="line">    Covered <span class="string">LOC:</span> <span class="number">14</span></span><br><span class="line">    Not covered <span class="string">LOC:</span> <span class="number">7</span></span><br><span class="line">    Total <span class="string">LOC:</span> <span class="number">21</span></span><br><span class="line">    Percentage <span class="string">Coverage:</span> <span class="number">66.67</span>%</span><br><span class="line">Submit files (using http)</span><br><span class="line">  Using HTTP submit method</span><br><span class="line">  Drop <span class="string">site:</span><span class="string">http:</span><span class="comment">//my.cdash.org/submit.php?project=cmake-cookbook</span></span><br><span class="line"><span class="symbol">  Uploaded:</span> <span class="regexp">/home/</span>user<span class="regexp">/cmake-recipes/</span>chapter<span class="number">-14</span><span class="regexp">/recipe-02/</span>cxx-example<span class="regexp">/build/</span>Testing<span class="regexp">/20180408-1530/</span>Build.xml</span><br><span class="line"><span class="symbol">  Uploaded:</span> <span class="regexp">/home/</span>user<span class="regexp">/cmake-recipes/</span>chapter<span class="number">-14</span><span class="regexp">/recipe-02/</span>cxx-example<span class="regexp">/build/</span>Testing<span class="regexp">/20180408-1530/</span>Configure.xml</span><br><span class="line"><span class="symbol">  Uploaded:</span> <span class="regexp">/home/</span>user<span class="regexp">/cmake-recipes/</span>chapter<span class="number">-14</span><span class="regexp">/recipe-02/</span>cxx-example<span class="regexp">/build/</span>Testing<span class="regexp">/20180408-1530/</span>Coverage.xml</span><br><span class="line"><span class="symbol">  Uploaded:</span> <span class="regexp">/home/</span>user<span class="regexp">/cmake-recipes/</span>chapter<span class="number">-14</span><span class="regexp">/recipe-02/</span>cxx-example<span class="regexp">/build/</span>Testing<span class="regexp">/20180408-1530/</span>CoverageLog<span class="number">-0.</span>xml</span><br><span class="line"><span class="symbol">  Uploaded:</span> <span class="regexp">/home/</span>user<span class="regexp">/cmake-recipes/</span>chapter<span class="number">-14</span><span class="regexp">/recipe-02/</span>cxx-example<span class="regexp">/build/</span>Testing<span class="regexp">/20180408-1530/</span>Test.xml</span><br><span class="line">  Submission successful</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，可以在浏览器中验证测试结果(本例的测试结果报告在 <a href="https://my.cdash.org/index.php?project=cmake-cookbook" target="_blank" rel="noopener">https://my.cdash.org/index.php?project=cmake-cookbook</a> ):</p>
</li>
</ol>
<h2 id="工作原理-1"><a href="#工作原理-1" class="headerlink" title="工作原理"></a>工作原理</h2><p>测试覆盖率为66.67%。为了得到更深入的了解，我们可以点击百分比，得到两个子目录的覆盖率分析:</p>
<p>通过浏览子目录链接，我们可以检查单个文件的测试覆盖率，甚至可以逐行浏览摘要(例如，<code>src/sum_integs.cpp</code>)：</p>
<p>运行测试时，绿线部分已经被覆盖，而红线部分则没有。通过这个方法，我们不仅可以标识未使用的/未测试的代码(使用<code>sum_integers_used</code>函数)，还可以查看每一行代码被遍历的频率。例如，代码行<code>sum += i</code>已经被访问了1005次(在<code>test_short</code>期间访问了5次，在<code>test_long</code>期间访问了1000次)。测试覆盖率分析是自动化测试不可或缺的功能，CDash为我们提供了一个界面，可以在浏览器中图形化地浏览分析结果。</p>
<h2 id="更多信息-1"><a href="#更多信息-1" class="headerlink" title="更多信息"></a>更多信息</h2><p>为了更多的了解该特性，我们推荐读者阅读下面的博客文章，它更深入的讨论了CDash的覆盖特性：<a href="https://blog.kitware.com/additional-coverage-features-in-cdash/" target="_blank" rel="noopener">https://blog.kitware.com/additional-coverage-features-in-cdash/</a></p>
<h1 id="14-3-使用AddressSanifier向CDash报告内存缺陷"><a href="#14-3-使用AddressSanifier向CDash报告内存缺陷" class="headerlink" title="14.3 使用AddressSanifier向CDash报告内存缺陷"></a>14.3 使用AddressSanifier向CDash报告内存缺陷</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-14/recipe-03" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-14/recipe-03</a> 中找到，其中包含一个C++示例和一个Fortran例子。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>AddressSanitizer(ASan)是可用于C++、C和Fortran的内存检测。它可以发现内存缺陷，比如：在空闲后使用、返回后使用、作用域后使用、缓冲区溢出、初始化顺序错误和内存泄漏(请参见 <a href="https://github.com/google/sanitizers/wiki/AddressSanitizer" target="_blank" rel="noopener">https://github.com/google/sanitizers/wiki/AddressSanitizer</a> )。从3.1版本开始，AddressSanitizer是LLVM的一部分；从4.8版本开始，作为GCC的一部分。在这个示例中，我们将在代码中加入两个bug，正常的测试中可能无法检测到。为了检测这些bug，我们将使用AddressSanitizer工具，并将CTest与动态分析结合起来，从而将缺陷报告给CDash。</p>
<h2 id="准备工作-2"><a href="#准备工作-2" class="headerlink" title="准备工作"></a>准备工作</h2><p>这个例子中，我们将使用两个源文件和两个测试集：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── CTestConfig.cmake</span><br><span class="line">├── dashboard.cmake</span><br><span class="line">├── src</span><br><span class="line">│    ├── buggy.cpp</span><br><span class="line">│    ├── buggy.hpp</span><br><span class="line">│    └── CMakeLists.txt</span><br><span class="line">└── tests</span><br><span class="line">    ├── CMakeLists.txt</span><br><span class="line">    ├── leaky.cpp</span><br><span class="line">    └── use_after_free.cpp</span><br></pre></td></tr></table></figure>
<p><code>buggy.cpp</code>包含有两个bug：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"buggy.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">function_leaky</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">double</span> *my_array = <span class="keyword">new</span> <span class="keyword">double</span>[<span class="number">1000</span>];</span><br><span class="line">  <span class="comment">// do some work ...</span></span><br><span class="line">  <span class="comment">// we forget to deallocate the array</span></span><br><span class="line">  <span class="comment">// delete[] my_array;</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">function_use_after_free</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">double</span> *another_array = <span class="keyword">new</span> <span class="keyword">double</span>[<span class="number">1000</span>];</span><br><span class="line">  <span class="comment">// do some work ...</span></span><br><span class="line">  <span class="comment">// deallocate it, good!</span></span><br><span class="line">  <span class="keyword">delete</span>[] another_array;</span><br><span class="line">  <span class="comment">// however, we accidentally use the array</span></span><br><span class="line">  <span class="comment">// after it has been deallocated</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"not sure what we get: "</span> &lt;&lt; another_array[<span class="number">123</span>] &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这些函数在相应的头文件中声明(<code>buggy.hpp</code>）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">function_leaky</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">function_use_after_free</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>测试文件<code>leaky.cpp</code>中将会验证<code>function_leaky</code>的返回值：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"buggy.hpp"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> return_code = function_leaky();</span><br><span class="line">  <span class="keyword">return</span> return_code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相应地，<code>use_after_free.cpp</code>会检查<code>function_use_after_free</code>的返回值:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"buggy.hpp"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> return_code = function_use_after_free();</span><br><span class="line">  <span class="keyword">return</span> return_code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="具体实施-2"><a href="#具体实施-2" class="headerlink" title="具体实施"></a>具体实施</h2><p>为了使用ASan，我们需要使用特定的标志来编译代码。然后，我们将运行测试并将它们提交到面板。</p>
<ol>
<li><p>生成bug库的工作将在<code>src/CMakeLists.txt</code>中完成：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_library</span><span class="params">(buggy <span class="string">""</span>)</span></span></span><br><span class="line"></span><br><span class="line">target_sources(buggy</span><br><span class="line">  PRIVATE</span><br><span class="line">  	buggy.cpp</span><br><span class="line">  PUBLIC</span><br><span class="line">  	$&#123;CMAKE_CURRENT_LIST_DIR&#125;/buggy.hpp</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">target_include_directories(buggy</span><br><span class="line">  PUBLIC</span><br><span class="line">  	$&#123;CMAKE_CURRENT_LIST_DIR&#125;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>在文件<code>src/CMakeLists.txt</code>中，我们将添加一个选项用于使用ASan：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">option(<span class="name">ENABLE_ASAN</span> <span class="string">"Enable AddressSanitizer"</span> OFF)</span><br><span class="line"></span><br><span class="line">if(<span class="name">ENABLE_ASAN</span>)</span><br><span class="line">  if(<span class="name">CMAKE_CXX_COMPILER_ID</span> MATCHES GNU)</span><br><span class="line">    message(<span class="name">STATUS</span> <span class="string">"AddressSanitizer enabled"</span>)</span><br><span class="line">    target_compile_options(<span class="name">buggy</span></span><br><span class="line">      PUBLIC</span><br><span class="line">      	-g -O1 -fsanitize=address -fno-omit-frame-pointer</span><br><span class="line">      )</span><br><span class="line">    target_link_libraries(<span class="name">buggy</span></span><br><span class="line">      PUBLIC</span><br><span class="line">      	asan</span><br><span class="line">      )</span><br><span class="line">  else()</span><br><span class="line">  	message(<span class="name">WARNING</span> <span class="string">"AddressSanitizer not supported for this compiler"</span>)</span><br><span class="line">  endif()</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试在<code>tests/CMakeLists.txt</code>中定义:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>(_test IN ITEMS leaky use_after_free)</span><br><span class="line">  <span class="keyword">add_executable</span>(<span class="variable">$&#123;_test&#125;</span> <span class="variable">$&#123;_test&#125;</span>.cpp)</span><br><span class="line">  <span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;_test&#125;</span> buggy)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">add_test</span>(</span><br><span class="line">    NAME</span><br><span class="line">    	<span class="variable">$&#123;_test&#125;</span></span><br><span class="line">    <span class="keyword">COMMAND</span></span><br><span class="line">    	$&lt;TARGET_FILE:<span class="variable">$&#123;_test&#125;</span>&gt;</span><br><span class="line">    )</span><br><span class="line"><span class="keyword">endforeach</span>()</span><br></pre></td></tr></table></figure>
</li>
<li><p>主<code>CMakeLists.txt</code>与之前的示例基本相同：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set minimum cmake version</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.5</span> FATAL_ERROR)</span><br><span class="line"></span><br><span class="line"><span class="comment"># project name and language</span></span><br><span class="line"><span class="keyword">project</span>(recipe-<span class="number">03</span> LANGUAGES CXX)</span><br><span class="line"></span><br><span class="line"><span class="comment"># require C++11</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_EXTENSIONS <span class="keyword">OFF</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD_REQUIRED <span class="keyword">ON</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># process src/CMakeLists.txt</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(src)</span><br><span class="line"><span class="keyword">enable_testing</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># allow to report to a cdash dashboard</span></span><br><span class="line"><span class="keyword">include</span>(CTest)</span><br><span class="line"></span><br><span class="line"><span class="comment"># process tests/CMakeLists.txt</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(tests)</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>CTestConfig.cmake</code>也没有修改：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_DROP_METHOD <span class="string">"http"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_DROP_SITE <span class="string">"my.cdash.org"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_DROP_LOCATION <span class="string">"/submit.php?project=cmake-cookbook"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_DROP_SITE_CDASH TRUE)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>这个示例中，我们使用CTest脚本向CDash提交结果；为此，我们将创建一个文件<code>dashboard.cmake</code>(与主<code>CMakeLists.txt</code>和<code></code> CTestConfig.cmake`位于同一个目录下)：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_PROJECT_NAME <span class="string">"example"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">cmake_host_system_information</span><span class="params">(RESULT _site QUERY HOSTNAME)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_SITE $&#123;_site&#125;)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_BUILD_NAME <span class="string">"$&#123;CMAKE_SYSTEM_NAME&#125;-$&#123;CMAKE_HOST_SYSTEM_PROCESSOR&#125;"</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_SOURCE_DIRECTORY <span class="string">"$&#123;CTEST_SCRIPT_DIRECTORY&#125;"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_BINARY_DIRECTORY <span class="string">"$&#123;CTEST_SCRIPT_DIRECTORY&#125;/build"</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">include</span><span class="params">(ProcessorCount)</span></span></span><br><span class="line"><span class="function"><span class="title">ProcessorCount</span><span class="params">(N)</span></span></span><br><span class="line"><span class="function"><span class="title">if</span><span class="params">(NOT N EQUAL <span class="number">0</span>)</span></span></span><br><span class="line">  set(CTEST_BUILD_FLAGS -j$&#123;N&#125;)</span><br><span class="line">  set(ctest_test_args $&#123;ctest_test_args&#125; PARALLEL_LEVEL $&#123;N&#125;)</span><br><span class="line"><span class="function"><span class="title">endif</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">ctest_start</span><span class="params">(Experimental)</span></span></span><br><span class="line"></span><br><span class="line">ctest_configure(</span><br><span class="line">  OPTIONS</span><br><span class="line">  	-DENABLE_ASAN:BOOL=ON</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">ctest_build</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">ctest_test</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_MEMORYCHECK_TYPE <span class="string">"AddressSanitizer"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">ctest_memcheck</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">ctest_submit</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>我们将执行<code>dashboard.cmake</code>脚本。注意，我们使用<code>CTEST_CMAKE_GENERATOR</code>与生成器选项的方式：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ ctest -S dashboard.cmake -D </span><br><span class="line"></span><br><span class="line">CTEST_CMAKE_GENERATOR=<span class="string">"Unix Makefiles"</span></span><br><span class="line">Each . represents <span class="number">1024</span> <span class="keyword">bytes</span> <span class="keyword">of</span> output</span><br><span class="line">. Size <span class="keyword">of</span> output: <span class="number">0</span>K</span><br><span class="line">Each symbol represents <span class="number">1024</span> <span class="keyword">bytes</span> <span class="keyword">of</span> output.</span><br><span class="line"><span class="string">'!'</span> represents <span class="keyword">an</span> error <span class="keyword">and</span> <span class="string">'*'</span> <span class="keyword">a</span> warning.</span><br><span class="line">. Size <span class="keyword">of</span> output: <span class="number">1</span>K</span><br></pre></td></tr></table></figure>
</li>
<li><p>结果将会出现在CDash网站上:</p>
</li>
</ol>
<h2 id="具体实施-3"><a href="#具体实施-3" class="headerlink" title="具体实施"></a>具体实施</h2><p>这个示例中，成功地向仪表板的动态分析部分报告了内存错误。我们可以通过浏览缺陷详细信息，得到进一步的了解:</p>
<p>通过单击各个链接，可以浏览完整信息的输出。</p>
<p>注意，也可以在本地生成AddressSanitizer报告。这个例子中，我们需要设置<code>ENABLE_ASAN</code>:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p build</span><br><span class="line">$ cd build</span><br><span class="line">$ cmake <span class="attribute">-DENABLE_ASAN</span>=ON <span class="built_in">..</span></span><br><span class="line">$ cmake --build .</span><br><span class="line">$ cmake --build . --target test</span><br><span class="line"></span><br><span class="line">Start 1: leaky</span><br><span class="line">1/2 Test #1: leaky <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>**<span class="number">*Fa</span>iled 0.07 sec</span><br><span class="line">Start 2: use_after_free</span><br><span class="line">2/2 Test #2: use_after_free <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.**<span class="number">*Fa</span>iled 0.04 sec</span><br><span class="line">0% tests passed, 2 tests failed out of 2</span><br></pre></td></tr></table></figure>
<p>运行<code>leaky</code>测试，直接产生以下结果:</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ./build/tests/leaky</span><br><span class="line"></span><br><span class="line">=================================================================</span><br><span class="line">==<span class="number">18536</span>==ERROR: LeakSanitizer: detected memory leaks</span><br><span class="line">Direct leak <span class="keyword">of</span> <span class="number">8000</span> byte(s) <span class="keyword">in</span> <span class="number">1</span> object(s) allocated <span class="keyword">from</span>:</span><br><span class="line"><span class="string">#0</span> <span class="number">0</span>x7ff984da1669 <span class="keyword">in</span> <span class="keyword">operator</span> <span class="keyword">new</span>[](unsigned long) /build/gcc/src/gcc/libsanitizer/asan/asan_new_delete.cc:<span class="number">82</span></span><br><span class="line"><span class="string">#1</span> <span class="number">0</span>x564925c93fd2 <span class="keyword">in</span> function_leaky() /home/user/cmake-recipes/chapter-<span class="number">14</span>/recipe-<span class="number">03</span>/cxx-example/src/buggy.cpp:<span class="number">7</span></span><br><span class="line"><span class="string">#2</span> <span class="number">0</span>x564925c93fb2 <span class="keyword">in</span> main /home/user/cmake-recipes/chapter-<span class="number">14</span>/recipe-<span class="number">03</span>/cxx-example/tests/leaky.cpp:<span class="number">4</span></span><br><span class="line"><span class="string">#3</span> <span class="number">0</span>x7ff98403df49 <span class="keyword">in</span> __libc_start_main (/usr/lib/libc.so.<span class="number">6</span>+<span class="number">0</span>x20f49)</span><br><span class="line">SUMMARY: AddressSanitizer: <span class="number">8000</span> byte(s) leaked <span class="keyword">in</span> <span class="number">1</span> allocation(s).</span><br></pre></td></tr></table></figure>
<p>相应地，我们可以直接运行<code>use_after_free</code>，得到详细的输出:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">$ ./build/tests/use_after_free</span><br><span class="line"></span><br><span class="line">=================================================================</span><br><span class="line">==18571==ERROR: AddressSanitizer: heap-<span class="keyword">use</span>-<span class="keyword">after</span>-free <span class="keyword">on</span> address <span class="number">0x6250000004d8</span> <span class="keyword">at</span> pc <span class="number">0x557ffa8b0102</span> bp <span class="number">0x7ffe8c560200</span> sp <span class="number">0x7ffe8c5601f0</span></span><br><span class="line"><span class="keyword">READ</span> <span class="keyword">of</span> <span class="keyword">size</span> <span class="number">8</span> <span class="keyword">at</span> <span class="number">0x6250000004d8</span> <span class="keyword">thread</span> T0</span><br><span class="line"><span class="comment">#0 0x557ffa8b0101 in function_use_after_free() /home/user/cmake-recipes/chapter-14/recipe-03/cxx-example/src/buggy.cpp:28</span></span><br><span class="line"><span class="comment">#1 0x557ffa8affb2 in main /home/user/cmake-recipes/chapter-14/recipe-03/cxx-example/tests/use_after_free.cpp:4</span></span><br><span class="line"><span class="comment">#2 0x7ff1d6088f49 in __libc_start_main (/usr/lib/libc.so.6+0x20f49)</span></span><br><span class="line"><span class="comment">#3 0x557ffa8afec9 in _start (/home/user/cmake-recipes/chapter-14/recipe-03/cxx-example/build/tests/use_after_free+0xec9)</span></span><br><span class="line"><span class="number">0x6250000004d8</span> <span class="keyword">is</span> located <span class="number">984</span> <span class="keyword">bytes</span> inside <span class="keyword">of</span> <span class="number">8000</span>-<span class="keyword">byte</span> region [<span class="number">0x625000000100</span>,<span class="number">0x625000002040</span>)</span><br><span class="line">freed <span class="keyword">by</span> <span class="keyword">thread</span> T0 here:</span><br><span class="line"><span class="comment">#0 0x7ff1d6ded5a9 in operator delete[](void*) /build/gcc/src/gcc/libsanitizer/asan/asan_new_delete.cc:128</span></span><br><span class="line"><span class="comment">#1 0x557ffa8afffa in function_use_after_free() /home/user/cmake-recipes/chapter-14/recipe-03/cxx-example/src/buggy.cpp:24</span></span><br><span class="line"><span class="comment">#2 0x557ffa8affb2 in main /home/user/cmake-recipes/chapter-14/recipe-03/cxx-example/tests/use_after_free.cpp:4</span></span><br><span class="line"><span class="comment">#3 0x7ff1d6088f49 in __libc_start_main (/usr/lib/libc.so.6+0x20f49)</span></span><br><span class="line">previously allocated <span class="keyword">by</span> <span class="keyword">thread</span> T0 here:</span><br><span class="line"><span class="comment">#0 0x7ff1d6dec669 in operator new[](unsigned long) /build/gcc/src/gcc/libsanitizer/asan/asan_new_delete.cc:82</span></span><br><span class="line"><span class="comment">#1 0x557ffa8affea in function_use_after_free() /home/user/cmake-recipes/chapter-14/recipe-03/cxx-example/src/buggy.cpp:19</span></span><br><span class="line"><span class="comment">#2 0x557ffa8affb2 in main /home/user/cmake-recipes/chapter-14/recipe-03/cxx-example/tests/use_after_free.cpp:4</span></span><br><span class="line"><span class="comment">#3 0x7ff1d6088f49 in __libc_start_main (/usr/lib/libc.so.6+0x20f49)</span></span><br><span class="line">SUMMARY: AddressSanitizer: <span class="keyword">heap</span>-<span class="keyword">use</span>-<span class="keyword">after</span>-free /home/<span class="keyword">user</span>/cmake-recipes/chapter<span class="number">-14</span>/recipe<span class="number">-03</span>/cxx-example/src/buggy.cpp:<span class="number">28</span> <span class="keyword">in</span> function_use_after_free()</span><br><span class="line">Shadow <span class="keyword">bytes</span> around the buggy address:</span><br><span class="line"><span class="number">0x0c4a7fff8040</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</span><br><span class="line"><span class="number">0x0c4a7fff8050</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</span><br><span class="line"><span class="number">0x0c4a7fff8060</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</span><br><span class="line"><span class="number">0x0c4a7fff8070</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</span><br><span class="line"><span class="number">0x0c4a7fff8080</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</span><br><span class="line">=&gt;<span class="number">0x0c4a7fff8090</span>: fd fd fd fd fd fd fd fd fd fd fd[fd]fd fd fd fd</span><br><span class="line"><span class="number">0x0c4a7fff80a0</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</span><br><span class="line"><span class="number">0x0c4a7fff80b0</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</span><br><span class="line"><span class="number">0x0c4a7fff80c0</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</span><br><span class="line"><span class="number">0x0c4a7fff80d0</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</span><br><span class="line"><span class="number">0x0c4a7fff80e0</span>: fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd fd</span><br><span class="line">Shadow <span class="keyword">byte</span> legend (one shadow <span class="keyword">byte</span> represents <span class="number">8</span> application <span class="keyword">bytes</span>):</span><br><span class="line">Addressable: <span class="number">00</span></span><br><span class="line">Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span></span><br><span class="line"><span class="keyword">Heap</span> <span class="keyword">left</span> redzone: fa</span><br><span class="line">Freed <span class="keyword">heap</span> region: fd</span><br><span class="line">Stack <span class="keyword">left</span> redzone: f1</span><br><span class="line">Stack <span class="keyword">mid</span> redzone: f2</span><br><span class="line">Stack <span class="keyword">right</span> redzone: f3</span><br><span class="line">Stack <span class="keyword">after</span> <span class="keyword">return</span>: f5</span><br><span class="line">Stack <span class="keyword">use</span> <span class="keyword">after</span> <span class="keyword">scope</span>: f8</span><br><span class="line"><span class="keyword">Global</span> redzone: f9</span><br><span class="line"><span class="keyword">Global</span> init <span class="keyword">order</span>: f6</span><br><span class="line">Poisoned <span class="keyword">by</span> <span class="keyword">user</span>: f7</span><br><span class="line"><span class="keyword">Container</span> <span class="keyword">overflow</span>: fc</span><br><span class="line"><span class="built_in">Array</span> cookie: ac</span><br><span class="line">Intra <span class="keyword">object</span> redzone: bb</span><br><span class="line">ASan internal: fe</span><br><span class="line"><span class="keyword">Left</span> alloca redzone: ca</span><br><span class="line"><span class="keyword">Right</span> alloca redzone: cb</span><br><span class="line">==<span class="number">18571</span>==ABORTING</span><br></pre></td></tr></table></figure>
<p>如果我们在没有AddressSanitizer的情况下进行测试(默认情况下<code>ENABLE_ASAN</code>是关闭的)，就不会报告错误：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p build_no_asan</span><br><span class="line">$ cd build_no_asan</span><br><span class="line">$ cmake <span class="built_in">..</span></span><br><span class="line">$ cmake --build .</span><br><span class="line">$ cmake --build . --target test</span><br><span class="line"></span><br><span class="line">Start 1: leaky</span><br><span class="line">1/2 Test #1: leaky <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.00 sec</span><br><span class="line">Start 2: use_after_free</span><br><span class="line">2/2 Test #2: use_after_free <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>. Passed 0.00 sec</span><br><span class="line">100% tests passed, 0 tests failed out of 2</span><br></pre></td></tr></table></figure>
<p>实际上，泄漏只会浪费内存，而<code>use_after_free</code>可能会导致未定义行为。调试这些问题的一种方法是使用valgrind (<a href="http://valgrind.org/" target="_blank" rel="noopener">http://valgrind.org</a> )。</p>
<p>与前两个示例相反，我们使用了CTest脚本来配置、构建和测试代码，并将报告提交到面板。要了解此示例的工作原理，请仔细查看<code>dashboard.cmake</code>脚本。首先，我们定义项目名称并设置主机报告和构建名称:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_PROJECT_NAME <span class="string">"example"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">cmake_host_system_information</span><span class="params">(RESULT _site QUERY HOSTNAME)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_SITE $&#123;_site&#125;)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_BUILD_NAME <span class="string">"$&#123;CMAKE_SYSTEM_NAME&#125;-$&#123;CMAKE_HOST_SYSTEM_PROCESSOR&#125;"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>我们的例子中，<code>CTEST_BUILD_NAME</code>的计算结果是<code>Linux-x86_64</code>。不同的操作系统下，可能会观察到不同的结果。</p>
<p>接下来，我们为源和构建目录指定路径:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span>(CTEST_SOURCE_DIRECTORY <span class="string">"<span class="variable">$&#123;CTEST_SCRIPT_DIRECTORY&#125;</span>"</span>)</span><br><span class="line"><span class="builtin-name">set</span>(CTEST_BINARY_DIRECTORY <span class="string">"<span class="variable">$&#123;CTEST_SCRIPT_DIRECTORY&#125;</span>/build"</span>)</span><br></pre></td></tr></table></figure>
<p>我们可以将生成器设置为<code>Unix Makefile</code>:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_CMAKE_GENERATOR <span class="string">"Unix Makefiles"</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>但是，对于更具可移植性的测试脚本，我们更愿意通过命令行提供生成器:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ctest -S dashboard<span class="selector-class">.cmake</span> -D CTEST_CMAKE_GENERATOR=<span class="string">"Unix Makefiles"</span></span><br></pre></td></tr></table></figure>
<p><code>dashboard.cmake</code>中的下一个代码片段，将计算出机器上可用的CPU芯数量，并将测试步骤的并行级设置为可用CPU芯数量，以使总测试时间最小化:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">include</span><span class="params">(ProcessorCount)</span></span></span><br><span class="line"><span class="function"><span class="title">ProcessorCount</span><span class="params">(N)</span></span></span><br><span class="line"><span class="function"><span class="title">if</span><span class="params">(NOT N EQUAL <span class="number">0</span>)</span></span></span><br><span class="line">	set(CTEST_BUILD_FLAGS -j$&#123;N&#125;)</span><br><span class="line">	set(ctest_test_args $&#123;ctest_test_args&#125; PARALLEL_LEVEL $&#123;N&#125;)</span><br><span class="line"><span class="function"><span class="title">endif</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>接下来，我们开始测试步骤并配置代码，将<code>ENABLE_ASAN</code>设置为<code>ON</code>:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ctest_start(<span class="name">Experimental</span>)</span><br><span class="line"></span><br><span class="line">ctest_configure(</span><br><span class="line">  OPTIONS</span><br><span class="line">  	-DENABLE_ASAN<span class="symbol">:BOOL=ON</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p><code>dashboard.cmake</code>其他命令为映射到构建、测试、内存检查和提交步骤:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">ctest_build</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">ctest_test</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_MEMORYCHECK_TYPE <span class="string">"AddressSanitizer"</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">ctest_memcheck</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">ctest_submit</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<h2 id="更多信息-2"><a href="#更多信息-2" class="headerlink" title="更多信息"></a>更多信息</h2><p>细心的读者会注意到，在链接目标之前，我们没有在系统上搜索AddressSanitizer。实际中，库查找工作已经提前做完，以避免在链接阶段出现意外。</p>
<p>有关AddressSanitizer文档和示例的更多信息，请参见<a href="https://github.com/google/sanitizers/wiki/AddressSanitizer" target="_blank" rel="noopener">https://github.com/google/sanitizers/wiki/AddressSanitizer</a> 。AddressSanitizer并不仅限于C和C++。对于Fortran示例，读者可以参考 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-14/recipe-03/fortran-example" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-14/recipe-03/fortran-example</a> 。</p>
<p><strong>NOTE</strong>:<em>可以在<a href="https://github.com/arsenm/sanitizers-cmake" target="_blank" rel="noopener">https://github.com/arsenm/sanitizers-cmake</a> 上找到CMake程序，用来查找杀毒程序和调整编译器标志</em></p>
<p>下面的博客文章讨论了如何添加对动态分析工具的支持，对我们很有启发性：<a href="https://blog.kitware.com/ctest-cdash-add-support-for-new-dynamic-analysis-tools/" target="_blank" rel="noopener">https://blog.kitware.com/ctest-cdash-add-support-for-new-dynamic-analysis-tools/</a></p>
<h1 id="14-4-使用ThreadSaniiser向CDash报告数据争用"><a href="#14-4-使用ThreadSaniiser向CDash报告数据争用" class="headerlink" title="14.4 使用ThreadSaniiser向CDash报告数据争用"></a>14.4 使用ThreadSaniiser向CDash报告数据争用</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-14/recipe-03" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-14/recipe-03</a> 中找到，其中包含一个C++示例。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>在这个示例中，我们将重用前一个示例中的方法，但是使用ThreadSanitizer或TSan，结合CTest和CDash，来检查数据竞争，并将它们报告给CDash。ThreadSanitizer的文档可以在网上找到，<a href="https://github.com/google/sanitizers/wiki/ThreadSanitizerCppManual" target="_blank" rel="noopener">https://github.com/google/sanitizers/wiki/ThreadSanitizerCppManual</a></p>
<h2 id="准备工作-3"><a href="#准备工作-3" class="headerlink" title="准备工作"></a>准备工作</h2><p>这个示例中，我们将使用以下示例代码(<code>example.cpp</code>):</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> num_threads = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">increase</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> &amp;s)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">1</span>));</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"thread "</span> &lt;&lt; i &lt;&lt; <span class="string">" increases "</span> &lt;&lt; s++ &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">std</span>::thread t[num_threads];</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> s = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// start threads</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">0</span>; i &lt; num_threads; i++) &#123;</span><br><span class="line">  	t[i] = <span class="built_in">std</span>::thread(increase, i, <span class="built_in">std</span>::ref(s));</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// join threads with main thread</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">0</span>; i &lt; num_threads; i++) &#123;</span><br><span class="line">  	t[i].join();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"final s: "</span> &lt;&lt; s &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个示例代码中，我们启动16个线程，每个线程都调用<code>increase</code>函数。<code>increase</code>函数休眠1s，然后打印并递增一个整数<code>s</code>。我们预计此示例代码将显示数据竞争，因为所有线程读取和修改相同的地址，而不需要任何显式同步或协调。换句话说，我们期望在代码末尾打印的最终<code>s</code>，每次的结果都不同。代码有bug，我们将尝试在ThreadSanitizer的帮助下识别数据竞争。如果不运行ThreadSanitizer，我们可能不会看到代码有任何问题:</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ ./example</span><br><span class="line"></span><br><span class="line"><span class="keyword">thread</span> <span class="keyword">thread</span> <span class="number">0</span> increases <span class="number">01</span> increases <span class="number">1</span></span><br><span class="line"><span class="keyword">thread</span> <span class="number">9</span> increases <span class="number">2</span></span><br><span class="line"><span class="keyword">thread</span> <span class="number">4</span> increases <span class="number">3</span></span><br><span class="line"><span class="keyword">thread</span> <span class="number">10</span> increases <span class="number">4</span></span><br><span class="line"><span class="keyword">thread</span> <span class="number">2</span> increases <span class="number">5</span></span><br><span class="line"><span class="keyword">thread</span> <span class="number">3</span> increases <span class="number">6</span></span><br><span class="line"><span class="keyword">thread</span> <span class="number">13</span> increases <span class="number">7</span></span><br><span class="line"><span class="keyword">thread</span> <span class="keyword">thread</span> <span class="number">7</span> increases <span class="number">8</span></span><br><span class="line"><span class="keyword">thread</span> <span class="number">14</span> increases <span class="number">9</span></span><br><span class="line"><span class="keyword">thread</span> <span class="number">8</span> increases <span class="number">10</span></span><br><span class="line"><span class="keyword">thread</span> <span class="number">12</span> increases <span class="number">11</span></span><br><span class="line"><span class="keyword">thread</span> <span class="number">15</span> increases <span class="number">12</span></span><br><span class="line"><span class="keyword">thread</span> <span class="number">11</span> increases <span class="number">13</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> increases <span class="number">14</span></span><br><span class="line"><span class="keyword">thread</span> <span class="number">6</span> increases <span class="number">15</span></span><br><span class="line"><span class="symbol">final s:</span> <span class="number">16</span></span><br></pre></td></tr></table></figure>
<h2 id="具体实施-4"><a href="#具体实施-4" class="headerlink" title="具体实施"></a>具体实施</h2><ol>
<li><p>文件<code>CMakeLists.txt</code>首先定义一个受支持的最低版本、项目名称、受支持的语言。在本例中，定义了C++11标准项目:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">cmake_minimum_required</span><span class="params">(VERSION <span class="number">3.5</span> FATAL_ERROR)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">project</span><span class="params">(recipe-<span class="number">04</span> LANGUAGES CXX)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_STANDARD <span class="number">11</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_EXTENSIONS OFF)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_STANDARD_REQUIRED ON)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来，找到线程库，定义可执行文件，并将其链接到线程库:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">find_package(<span class="name">Threads</span> REQUIRED)</span><br><span class="line"></span><br><span class="line">add_executable(<span class="name">example</span> example.cpp)</span><br><span class="line"></span><br><span class="line">target_link_libraries(<span class="name">example</span></span><br><span class="line">  PUBLIC</span><br><span class="line">  	Threads:<span class="symbol">:Threads</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，提供编译选项和代码，并链接到ThreadSanitizer:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">option(<span class="name">ENABLE_TSAN</span> <span class="string">"Enable ThreadSanitizer"</span> OFF)</span><br><span class="line"></span><br><span class="line">if(<span class="name">ENABLE_TSAN</span>)</span><br><span class="line">  if(<span class="name">CMAKE_CXX_COMPILER_ID</span> MATCHES GNU)</span><br><span class="line">    message(<span class="name">STATUS</span> <span class="string">"ThreadSanitizer enabled"</span>)</span><br><span class="line">    target_compile_options(<span class="name">example</span></span><br><span class="line">    PUBLIC</span><br><span class="line">    	-g -O1 -fsanitize=thread -fno-omit-frame-pointer -fPIC</span><br><span class="line">    )</span><br><span class="line">    target_link_libraries(<span class="name">example</span></span><br><span class="line">      PUBLIC</span><br><span class="line">        tsan</span><br><span class="line">      )</span><br><span class="line">  else()</span><br><span class="line">  	message(<span class="name">WARNING</span> <span class="string">"ThreadSanitizer not supported for this compiler"</span>)</span><br><span class="line">  endif()</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，编译测试用例:</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">enable_testing</span>()</span><br><span class="line"></span><br><span class="line"># allow to re<span class="keyword">port</span> to a cdash dashboard</span><br><span class="line">include(<span class="type">CTest</span>)</span><br><span class="line"></span><br><span class="line">add_test(</span><br><span class="line">  <span class="type">NAME</span></span><br><span class="line">  	example</span><br><span class="line">  <span class="type">COMMAND</span></span><br><span class="line">  	$&lt;<span class="type">TARGET_FILE</span>:example&gt;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>CTestConfig.cmake</code>没有变化:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_DROP_METHOD <span class="string">"http"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_DROP_SITE <span class="string">"my.cdash.org"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_DROP_LOCATION <span class="string">"/submit.php?project=cmake-cookbook"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_DROP_SITE_CDASH TRUE)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>dashboard.cmake</code>需要为TSan进行简单修改:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_PROJECT_NAME <span class="string">"example"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">cmake_host_system_information</span><span class="params">(RESULT _site QUERY HOSTNAME)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_SITE $&#123;_site&#125;)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_BUILD_NAME <span class="string">"$&#123;CMAKE_SYSTEM_NAME&#125;-$&#123;CMAKE_HOST_SYSTEM_PROCESSOR&#125;"</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_SOURCE_DIRECTORY <span class="string">"$&#123;CTEST_SCRIPT_DIRECTORY&#125;"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_BINARY_DIRECTORY <span class="string">"$&#123;CTEST_SCRIPT_DIRECTORY&#125;/build"</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">include</span><span class="params">(ProcessorCount)</span></span></span><br><span class="line"><span class="function"><span class="title">ProcessorCount</span><span class="params">(N)</span></span></span><br><span class="line"><span class="function"><span class="title">if</span><span class="params">(NOT N EQUAL <span class="number">0</span>)</span></span></span><br><span class="line">  set(CTEST_BUILD_FLAGS -j$&#123;N&#125;)</span><br><span class="line">  set(ctest_test_args $&#123;ctest_test_args&#125; PARALLEL_LEVEL $&#123;N&#125;)</span><br><span class="line"><span class="function"><span class="title">endif</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">ctest_start</span><span class="params">(Experimental)</span></span></span><br><span class="line"></span><br><span class="line">ctest_configure(</span><br><span class="line">  OPTIONS</span><br><span class="line">  	-DENABLE_TSAN:BOOL=ON</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="title">ctest_build</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">ctest_test</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CTEST_MEMORYCHECK_TYPE <span class="string">"ThreadSanitizer"</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">ctest_memcheck</span><span class="params">()</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">ctest_submit</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>让我们以这个例子为例。通过<code>CTEST_CMAKE_GENERATOR</code>选项来设置生成器:</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ctest -S dashboard.cmake -D CTEST_CMAKE_GENERATOR=<span class="string">"Unix Makefiles"</span></span><br><span class="line"></span><br><span class="line">Each . represents <span class="number">1024</span> <span class="keyword">bytes</span> <span class="keyword">of</span> output</span><br><span class="line">. Size <span class="keyword">of</span> output: <span class="number">0</span>K</span><br><span class="line">Each symbol represents <span class="number">1024</span> <span class="keyword">bytes</span> <span class="keyword">of</span> output.</span><br><span class="line"><span class="string">'!'</span> represents <span class="keyword">an</span> error <span class="keyword">and</span> <span class="string">'*'</span> <span class="keyword">a</span> warning.</span><br><span class="line">. Size <span class="keyword">of</span> output: <span class="number">0</span>K</span><br></pre></td></tr></table></figure>
</li>
<li><p>在面板上，我们将看到以下内容:</p>
</li>
<li><p>我们可以看到更详细的动态分析:</p>
</li>
</ol>
<h2 id="工作原理-2"><a href="#工作原理-2" class="headerlink" title="工作原理"></a>工作原理</h2><p>该示例<code>CMakeLists.txt</code>的核心部分:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">option(<span class="name">ENABLE_TSAN</span> <span class="string">"Enable ThreadSanitizer"</span> OFF)</span><br><span class="line"></span><br><span class="line">if(<span class="name">ENABLE_TSAN</span>)</span><br><span class="line">  if(<span class="name">CMAKE_CXX_COMPILER_ID</span> MATCHES GNU)</span><br><span class="line">    message(<span class="name">STATUS</span> <span class="string">"ThreadSanitizer enabled"</span>)</span><br><span class="line">    target_compile_options(<span class="name">example</span></span><br><span class="line">    PUBLIC</span><br><span class="line">    	-g -O1 -fsanitize=thread -fno-omit-frame-pointer -fPIC</span><br><span class="line">    )</span><br><span class="line">    target_link_libraries(<span class="name">example</span></span><br><span class="line">      PUBLIC</span><br><span class="line">        tsan</span><br><span class="line">      )</span><br><span class="line">  else()</span><br><span class="line">  	message(<span class="name">WARNING</span> <span class="string">"ThreadSanitizer not supported for this compiler"</span>)</span><br><span class="line">  endif()</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
<p><code>dashboard.cmake</code>也需要更新:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ctest_start</span>(Experimental)</span><br><span class="line"></span><br><span class="line"><span class="keyword">ctest_configure</span>(</span><br><span class="line">  OPTIONS</span><br><span class="line">  	-DENABLE_TSAN:BOOL=<span class="keyword">ON</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line"><span class="keyword">ctest_build</span>()</span><br><span class="line"><span class="keyword">ctest_test</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(CTEST_MEMORYCHECK_TYPE <span class="string">"ThreadSanitizer"</span>)</span><br><span class="line"><span class="keyword">ctest_memcheck</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">ctest_submit</span>()</span><br></pre></td></tr></table></figure>
<p>和上一个示例一样，我们也可以在本地查看ThreadSanitizer的输出:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p build</span><br><span class="line">$ cd build</span><br><span class="line">$ cmake <span class="attribute">-DENABLE_TSAN</span>=ON <span class="built_in">..</span></span><br><span class="line">$ cmake --build .</span><br><span class="line">$ cmake --build . --target test</span><br><span class="line"></span><br><span class="line">Start 1: example</span><br><span class="line">1/1 Test #1: example <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>**<span class="number">*Fa</span>iled 1.07 sec</span><br><span class="line">0% tests passed, 1 tests failed out of 1</span><br><span class="line">$ ./build/example</span><br><span class="line">thread 0 increases 0</span><br><span class="line">==================</span><br><span class="line">WARNING: ThreadSanitizer: data race (<span class="attribute">pid</span>=24563)</span><br><span class="line"><span class="built_in">..</span>. lots of output <span class="built_in">..</span>.</span><br><span class="line">SUMMARY: ThreadSanitizer: data race /home/user/cmake-recipes/chapter-14/recipe-04/cxx-example/example</span><br></pre></td></tr></table></figure>
<h2 id="更多信息-3"><a href="#更多信息-3" class="headerlink" title="更多信息"></a>更多信息</h2><p>对使用OpenMP的应用TSan是很常见的，但是请注意，在某些情况下，OpenMP会在TSan下生成误检的结果。对于Clang编译器，一个解决方案是用<code>-DLIBOMP_TSAN_SUPPORT=TRUE</code>重新编译编译器本身及其<code>libomp</code>。通常，以合理的方式使用TSan可能需要重新编译整个工具堆栈，以避免误报。在使用pybind11的C++项目的情况，我们可能需要重新编译Python，并启用TSan来获得有意义的东西。或者，Python绑定可以通过使用TSan抑制而被排除在外，如 <a href="https://github.com/google/sanitizers/wiki/threadsanitizersuppression" target="_blank" rel="noopener">https://github.com/google/sanitizers/wiki/threadsanitizersuppression</a> 。例如：如果一个动态库同时被一个经过TSan的二进制文件和一个Python插件调用，那么这种情况可能是不可能使用TSan。</p>
<p>下面的博客文章讨论了如何添加对动态分析工具的支持：<a href="https://blog.kitware.com/ctest-cdash-add-support-for-new-dynamic-analysis-tools/" target="_blank" rel="noopener">https://blog.kitware.com/ctest-cdash-add-support-for-new-dynamic-analysis-tools/</a></p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2021/03/100666.html" class="pre-post btn btn-default" title='CMake 完整使用教程 之十六 使用CMake构建已有项目'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">CMake 完整使用教程 之十六 使用CMake构建已有项目</span>
        </a>
    
    
        <a href="/archives/2021/03/100664.html" class="next-post btn btn-default" title='CMake 完整使用教程 之十四 选择生成器和交叉编译'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">CMake 完整使用教程 之十四 选择生成器和交叉编译</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#CDash环境"><span class="toc-text">CDash环境</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14-1-将测试部署到CDash"><span class="toc-text">14.1 将测试部署到CDash</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14-2-CDash显示测试覆盖率"><span class="toc-text">14.2 CDash显示测试覆盖率</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-1"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-1"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-1"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-1"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14-3-使用AddressSanifier向CDash报告内存缺陷"><span class="toc-text">14.3 使用AddressSanifier向CDash报告内存缺陷</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-2"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-2"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-3"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-2"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14-4-使用ThreadSaniiser向CDash报告数据争用"><span class="toc-text">14.4 使用ThreadSaniiser向CDash报告数据争用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-3"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-4"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-2"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-3"><span class="toc-text">更多信息</span></a></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2023&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>