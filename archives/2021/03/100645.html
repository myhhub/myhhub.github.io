<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="qt,ctk">


    <meta name="description" content="CTK框架实际应用比较可靠，但网上资料很少。本教程围绕 CTK Plugin Framework，探索 C++ 中的模块化技术，并能够基于 CTK 快速搭建 C++ 组件化框架，避免后来的人走弯...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>CTK完整教程(OSGI for C++ 实现 C++ Qt 模块化) | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx">


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="CTK完整教程(OSGI for C++ 实现 C++ Qt 模块化)">
            
	            CTK完整教程(OSGI for C++ 实现 C++ Qt 模块化)
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/back/">后端</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/ctk/">ctk</a> <a class="tag-link" href="/tags/qt/">qt</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2021/03/10</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>760</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <p>CTK框架实际应用比较可靠，但网上资料很少。本教程围绕 CTK Plugin Framework，探索 C++ 中的模块化技术，并能够基于 CTK 快速搭建 C++ 组件化框架，避免后来的人走弯路。本教程的源码下载地址：<a href="https://github.com/myhhub/CTK-project" target="_blank" rel="noopener">项目源代码</a>。</p>
<h1 id="CTK介绍"><a href="#CTK介绍" class="headerlink" title="CTK介绍"></a>CTK介绍</h1><p><a href="http://www.commontk.org/" target="_blank" rel="noopener">CTK</a> 为支持生物医学图像计算的公共开发包，其全称为 Common Toolkit。CTK插件框架的设计有很大的灵感来自OSGi并且使得应用程序由许多不同的组件组合成一个可扩展模型。这个模型允许通过那些组件间共享对象的服务通信。</p>
<p>当前，CTK 工作的主要范围包括：</p>
<ul>
<li><p><a href="http://www.commontk.org/index.php/Documentation/Dicom_Overview" target="_blank" rel="noopener">DICOM</a>：提供了从 PACS 和本地数据库中查询和检索的高级类。包含 Qt 部件，可以轻松地设置服务器连接，并发送查询和查看结果。</p>
</li>
<li><p><a href="http://www.commontk.org/index.php/Documentation/DicomApplicationHosting" target="_blank" rel="noopener">DICOM Application Hosting</a>：目标是创建 DICOM Part 19 Application Hosting specifications 的 C++ 参考实现。它提供了用于创建主机和托管应用程序的基础设。</p>
</li>
<li><p><a href="http://www.commontk.org/index.php/Documentation/Widgets" target="_blank" rel="noopener">Widgets</a>：用于生物医学成像应用的 Qt Widgets 集合。</p>
</li>
<li><p><a href="http://www.commontk.org/index.php/Documentation/Plugin_Framework" target="_blank" rel="noopener">Plugin Framework</a>：用于 C++ 的动态组件系统，以 OSGi 规范为模型。它支持一个开发模型，在这个模型中，应用程序（动态地）由许多不同（可重用的）组件组成，遵循面向服务的方法。</p>
</li>
<li><p><a href="http://www.commontk.org/index.php/Documentation/Command_Line_Interface" target="_blank" rel="noopener">Command Line Interfaces</a>：一种允许将算法编写为自包含可执行程序的技术，可以在多个终端用户应用程序环境中使用，而无需修改。</p>
<h1 id="CTK-Plugin-Framework"><a href="#CTK-Plugin-Framework" class="headerlink" title="CTK Plugin Framework"></a>CTK Plugin Framework</h1></li>
</ul>
<h2 id="CTK-Plugin-Framework-架构策略"><a href="#CTK-Plugin-Framework-架构策略" class="headerlink" title="CTK Plugin Framework 架构策略"></a>CTK Plugin Framework 架构策略</h2><ul>
<li>Qt Creator 的可扩展性。<br>Qt Creator 通过一种简单、优雅的方式来实现可扩展性，它使用一个通用的 QObject 池来实现某些可用的接口。同时，通过使用嵌入式文本文件（.pluginspec 文件）来向插件添加元数据（例如：Name、Version 等）。</li>
</ul>
<p>其实严格来说，CTK Plugin Framework 同时借鉴了 OSGi 和 Qt Creator 的思想。</p>
<ul>
<li>Qt 提供了 Qt Plugin System 和 Qt Service Framework。<br>Qt Plugin System 提供了两套用于创建插件的 API，高级 API 用于扩展 Qt 本身（例如：自定义数据库驱动、图像格式、文本编解码、自定义样式等），低级 API 用于扩展 Qt 应用程序。</li>
</ul>
<p>对于 Qt Service Framework 来说，它能使服务的开发和访问方式变得更加容易。Qt 服务提供者可以与特定于平台的服务进行交互，而无需向客户端公开平台的细节。每个服务都通过 QObject 指针公开，这意味着客户端可以通过 Qt MetaObject 系统与服务对象进行交互。</p>
<ul>
<li><p>CTK Plugin Framework 的架构策略是什么？<br>CTK Plugin Framework 是基于 Qt Plugin System 和 Qt Service Framework 实现的，并且它还添加了以下特性来增强这两个系统：</p>
<ul>
<li>插件元数据（由 MANIFEST.MF 文件提供）；</li>
<li>一个定义良好的插件生命周期和上下文；</li>
<li>综合服务发现和注册；</li>
<li>……<br>注意： 在 Qt Plugin System 中，插件的元数据由 JSON 文件提供。</li>
</ul>
</li>
</ul>
<p>CTK Plugin Framework 的核心架构主要包含两个组件：Plugin System 本身和 Service Registry。然而，这两个组件是相互关联的，它们在 API 级别上的组合使得系统更加全面、灵活。</p>
<ul>
<li>Plugin System<br>CTK Core 依赖于 QtCore 模块，因此 CTK Plugin Framework 基于 Qt Plugin System。Qt API 允许在运行时加载和卸载插件，这个功能在 CTK Plugin Framework 中得到了加强，以支持透明化延迟加载和解决依赖关系。</li>
</ul>
<p>插件的元数据被编译进插件内部，可以通过 API 进行提取。此外，插件系统还使用 SQLite 缓存了元数据，以避免应用程序加载时间问题。另外，Plugin System 支持通过中央注册中心使用服务。</p>
<ul>
<li>Service Registry<br>Qt Service Framework 是 Qt Mobility 项目发布的一个 Qt 解决方案，这种服务框架允许“声明式服务”（Getting Started with OSGi: Introducing Declarative Services ）和按需加载服务实现。为了启用动态（非持久性）服务，Qt Mobility 服务框架可以与 Service Registry 一起使用，类似于 OSGi Core Specifications 中描述的一样。</li>
</ul>
<h2 id="CTK-Plugin-Framework-优点"><a href="#CTK-Plugin-Framework-优点" class="headerlink" title="CTK Plugin Framework 优点"></a>CTK Plugin Framework 优点</h2><p>  由于 CTK Plugin Framework 基于 OSGi，因此它继承了一种非常成熟且完全设计的组件系统，这在 Java 中用于构建高度复杂的应用程序，它将这些好处带给了本地（基于 Qt 的）C++ 应用程序。以下内容摘自 <a href="https://www.osgi.org/developer/benefits-of-using-osgi/" target="_blank" rel="noopener">Benefits of Using OSGi</a>，并适应于 CTK Plugin Framework：</p>
<ul>
<li><p>降低复杂性</p>
<p>使用 CTK Plugin Framework 开发意味着开发插件，它们隐藏了内部实现，并通过定义良好的服务来和其它插件通信。隐藏内部机制意味着以后可以自由地更改实现，这不仅有助于 Bug 数量的减少，还使得插件的开发变得更加简单，因为只需要实现已经定义好的一定数量的功能接口即可。</p>
</li>
<li><p>复用</p>
<p>标准化的组件模型，使得在应用程序中使用第三方组件变得非常容易。</p>
</li>
<li><p>现实情况</p>
<p>CTK Plugin Framework 是一个动态框架，它可以动态地更新插件和服务。在现实世界中，有很多场景都和动态服务模型相匹配。因此，应用程序可以在其所属的领域中重用 Service Registry 的强大基元（注册、获取、用富有表现力的过滤语言列表、等待服务的出现和消失）。这不仅节省了编写代码，还提供了全局可见性、调试工具以及比为专用解决方案实现的更多的功能。在这样的动态环境下编写代码听起来似乎是个噩梦，但幸运的是，有支持类和框架可以消除大部分（如果不是全部的话）痛苦。</p>
</li>
<li><p>开发简单</p>
<p>CTK Plugin Framework 不仅仅是组件的标准，它还指定了如何安装和管理组件。这个 API 可以被插件用来提供一个管理代理，这个管理代理可以非常简单，如命令 shell、图形桌面应用程序、Amazon EC2 的云计算接口、或 IBM Tivoli 管理系统。标准化的管理 API 使得在现有和未来的系统中集成 CTK Plugin Framework 变得非常容易。</p>
</li>
<li><p>动态更新</p>
<p>OSGi 组件模型是一个动态模型，插件可以在不关闭整个系统的情况下被安装、启动、停止、更新和卸载。</p>
</li>
<li><p>自适应</p>
<p>OSGi 组件模型是从头设计的，以允许组件的混合和匹配。这就要求必须指定组件的依赖关系，并且需要组件在其可选依赖性并不总是可用的环境中生存。Service Registry 是一个动态注册表，其中插件可以注册、获取和监听服务。这种动态服务模型允许插件找出系统中可用的功能，并调整它们所能提供的功能。这使得代码更加灵活，并且能够更好地适应变化。</p>
</li>
<li><p>透明性</p>
<p>插件和服务是 CTK 插件环境中的一等公民。管理 API 提供了对插件的内部状态的访问，以及插件之间的连接方式。可以停止部分应用程序来调试某个问题，或者可以引入诊断插件。</p>
</li>
<li><p>版本控制</p>
<p>在 CTK Plugin Framework 中，所有的插件都经过严格的版本控制，只有能够协作的插件才会被连接在一起。</p>
</li>
<li><p>简单</p>
<p>CTK 插件相关的 API 非常简单，核心 API 不到 25 个类。这个核心 API 足以编写插件、安装、启动、停止、更新和卸载它们，并且还包含了所有的监听类。</p>
</li>
<li><p>懒加载</p>
<p>懒加载是软件中一个很好的点，OSGi 技术有很多的机制来保证只有当类真正需要的时候才开始加载它们。例如，插件可以用饿汉式启动，但是也可以被配置为仅当其它插件使用它们时才启动。服务可以被注册，但只有在使用时才创建。这些懒加载场景，可以节省大量的运行时成本。</p>
</li>
<li><p>非独占性</p>
<p>CTK Plugin Framework 不会接管整个应用程序，你可以选择性地将所提供的功能暴露给应用程序的某些部分，或者甚至可以在同一个进程中运行该框架的多个实例。</p>
</li>
<li><p>非侵入</p>
<p>在一个 CTK 插件环境中，不同插件均有自己的环境。它们可以使用任何设施，框架对此并无限制。CTK 服务没有特殊的接口需求，每个 QObject 都可以作为一个服务，每个类（也包括非 QObject）都可以作为一个接口。</p>
</li>
</ul>
<h1 id="CTK编译"><a href="#CTK编译" class="headerlink" title="CTK编译"></a>CTK编译</h1><p>使用cmake编译出与系统版本相应的动态库。参见<a href="../02/100643.html">CTK编译教程(64位环境 Windows + Qt + MinGW或MSVC + CMake)</a>。</p>
<h1 id="使用-CTKWidgets"><a href="#使用-CTKWidgets" class="headerlink" title="使用 CTKWidgets"></a>使用 CTKWidgets</h1><p>新项目-Application(Qt)-Qt Console Application，项目名称为UseCTKWidgets，pro文件的代码：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">QT += core gui widgets</span><br><span class="line"></span><br><span class="line">TARGET = UseCTKWidgets</span><br><span class="line">TEMPLATE = app</span><br><span class="line"></span><br><span class="line"><span class="comment"># CTK 安装路径</span></span><br><span class="line">CTK_INSTALL_PATH = $$PWD/../../CTKInstall</span><br><span class="line"></span><br><span class="line"><span class="comment"># CTK 相关库所在路径（例如：CTKCore.lib、CTKWidgets.lib）</span></span><br><span class="line">CTK_LIB_PATH = $$CTK_INSTALL_PATH/lib/ctk-0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># CTK 相关头文件所在路径（例如：ctkPluginFramework.h）</span></span><br><span class="line">CTK_INCLUDE_PATH = $$CTK_INSTALL_PATH/<span class="keyword">include</span>/ctk-0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 相关库文件（CTKCore.lib、CTKWidgets.lib）</span></span><br><span class="line">LIBS += -L$$CTK_LIB_PATH -lCTKCore -lCTKWidgets</span><br><span class="line"></span><br><span class="line">INCLUDEPATH += $$CTK_INCLUDE_PATH</span><br></pre></td></tr></table></figure>
<p>主函数main加载部件，代码如下：<em>main.cpp</em></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QApplication&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QFormLayout&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QVBoxLayout&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctkCheckablePushButton.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctkCollapsibleButton.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctkColorPickerButton.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctkRangeWidget.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">QApplication <span class="title">app</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 可折叠按钮</span></span><br><span class="line">  ctkCollapsibleButton* buttons = <span class="keyword">new</span> ctkCollapsibleButton(<span class="string">"Buttons"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 可勾选按钮</span></span><br><span class="line">  ctkCheckablePushButton* checkablePushButton = <span class="keyword">new</span> ctkCheckablePushButton();</span><br><span class="line">  checkablePushButton-&gt;setText(<span class="string">"Checkable"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 颜色拾取器</span></span><br><span class="line">  ctkColorPickerButton* colorPickerButton = <span class="keyword">new</span> ctkColorPickerButton();</span><br><span class="line">  colorPickerButton-&gt;setColor(QColor(<span class="string">"#9e1414"</span>));</span><br><span class="line"></span><br><span class="line">  ctkCollapsibleButton* sliders = <span class="keyword">new</span> ctkCollapsibleButton(<span class="string">"Sliders"</span>);</span><br><span class="line"></span><br><span class="line">  QFormLayout* buttonsLayout = <span class="keyword">new</span> QFormLayout;</span><br><span class="line">  buttonsLayout-&gt;setFieldGrowthPolicy(QFormLayout::AllNonFixedFieldsGrow);</span><br><span class="line">  buttonsLayout-&gt;addRow(<span class="string">"ctkCheckablePushButton"</span>, checkablePushButton);</span><br><span class="line">  buttonsLayout-&gt;addRow(<span class="string">"ctkColorPickerButton"</span>, colorPickerButton);</span><br><span class="line">  buttons-&gt;setLayout(buttonsLayout);</span><br><span class="line"></span><br><span class="line">  QVBoxLayout* topLevelLayout = <span class="keyword">new</span> QVBoxLayout();</span><br><span class="line">  topLevelLayout-&gt;addWidget(buttons);</span><br><span class="line">  topLevelLayout-&gt;addWidget(sliders);</span><br><span class="line"></span><br><span class="line">  QFormLayout* slidersLayout = <span class="keyword">new</span> QFormLayout;</span><br><span class="line">  ctkRangeWidget* rangeWidget = <span class="keyword">new</span> ctkRangeWidget();</span><br><span class="line">  slidersLayout-&gt;addRow(<span class="string">"ctkRangeWidget"</span>, rangeWidget);</span><br><span class="line">  sliders-&gt;setLayout(slidersLayout);</span><br><span class="line"></span><br><span class="line">  QWidget topLevel;</span><br><span class="line">  topLevel.setLayout(topLevelLayout);</span><br><span class="line">  topLevel.show();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> app.exec();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>项目代码：<a href="https://github.com/myhhub/CTK-project/tree/main/UseCTKWidgets" target="_blank" rel="noopener">UseCTKWidgets</a></p>
<h1 id="初步使用-CTK-Plugin-Framework"><a href="#初步使用-CTK-Plugin-Framework" class="headerlink" title="初步使用 CTK Plugin Framework"></a>初步使用 CTK Plugin Framework</h1><h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><p>由于每一个插件都要建一个子项目，本项目刚开始创建时在QtCreator中选择<em>新建-其他项目-子目录项目</em>，新建项目名称为<a href="https://github.com/myhhub/CTK-project/tree/main/SampleCTK" target="_blank" rel="noopener">SampleCTK</a>，然后建立主程序入口项目，这里建立一个<em>控制台项目</em>，取名叫App。</p>
<p>更改项目输出路径：<em>app.pro</em></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">DESTDIR</span> = $<span class="variable">$OUT_PWD</span>/../bin</span><br></pre></td></tr></table></figure>
<p>主函数中加载插件，启动框架：<em>main.cpp</em></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QCoreApplication&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"ctkPluginFrameworkFactory.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"ctkPluginFramework.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"ctkPluginException.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">QCoreApplication <span class="title">app</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line">    app.setApplicationName(<span class="string">"SampleCTK"</span>);<span class="comment">//给框架创建名称，Linux下没有会报错</span></span><br><span class="line">    ctkPluginFrameworkFactory frameWorkFactory;</span><br><span class="line">    QSharedPointer&lt;ctkPluginFramework&gt; framework = frameWorkFactory.getFramework();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 初始化并启动插件框架</span></span><br><span class="line">        framework-&gt;init();</span><br><span class="line">        framework-&gt;start();</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"CTK Plugin Framework start ..."</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">const</span> ctkPluginException &amp;e) &#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"Failed to initialize the plugin framework: "</span> &lt;&lt; e.what();</span><br><span class="line">        qDebug() &lt;&lt; e.message() &lt;&lt; e.getType();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> app.exec();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果想把CTK初始化、插件安装启动、获取等操作封装成一个类，那么要注意：需要把CTK相关的变量定义成类属性，不能是局部变量，否则会出现各种问题如获取不了服务、服务引用为空等。</p>
<p>没有报错的话及表示插件加载成功！</p>
<p> 其中QSharedPointer<ctkpluginframework> framework这个对象比较有意思，既可以作为对象也可以作为对象指针，但要作为插件框架使用必须要用指针方法调用，所以代码里使用“-&gt;”。</ctkpluginframework></p>
<h2 id="项目加载CTK框架插件"><a href="#项目加载CTK框架插件" class="headerlink" title="项目加载CTK框架插件"></a>项目加载CTK框架插件</h2><p>项目SampleCTK新建文本文件<em>CTK</em>，然后更改扩展名为pri。文件加载CTK安装目录及源代码目录，编译出的动态库就可以当普通动态库使用加载了，<em>CTK.pri</em>里面加载代码为：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CTK 安装路径</span></span><br><span class="line">CTK_INSTALL_PATH = $$PWD/../../CTKInstall</span><br><span class="line"></span><br><span class="line"><span class="comment"># CTK 插件相关库所在路径（例如：CTKCore.lib、CTKPluginFramework.lib）</span></span><br><span class="line">CTK_LIB_PATH = $$CTK_INSTALL_PATH/lib/ctk-0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># CTK 插件相关头文件所在路径（例如：ctkPluginFramework.h）</span></span><br><span class="line">CTK_INCLUDE_PATH = $$CTK_INSTALL_PATH/<span class="keyword">include</span>/ctk-0.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># CTK 插件相关头文件所在路径（主要因为用到了 service 相关东西）</span></span><br><span class="line">CTK_INCLUDE_FRAMEWORK_PATH = $$PWD/../../CTK-master/Libs/PluginFramework</span><br><span class="line"></span><br><span class="line">LIBS += -L$$CTK_LIB_PATH -lCTKCore -lCTKPluginFramework</span><br><span class="line"></span><br><span class="line">INCLUDEPATH += $$CTK_INCLUDE_PATH \</span><br><span class="line">               $$CTK_INCLUDE_FRAMEWORK_PATH</span><br></pre></td></tr></table></figure>
<p>将CTK.pri文件的内容引入 pro 文件：<em>app.pro</em></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">include</span><span class="params">($<span class="variable">$PWD</span>/../CTK.pri)</span></span></span><br></pre></td></tr></table></figure>
<h2 id="CTK插件的接口处理"><a href="#CTK插件的接口处理" class="headerlink" title="CTK插件的接口处理"></a>CTK插件的接口处理</h2><p>CTK框架由一个一个可分离的插件组成，框架对插件识别有一定要求，目前网上很多一整块扔出来对新人不太友好，博主这里讲解是尽量拆。单个插件最基本的格式要求分成Activator，qrc文件，以及MANIFEST.MF，以say Hello模块HelloCTK为例。</p>
<h3 id="Activator注册器"><a href="#Activator注册器" class="headerlink" title="Activator注册器"></a>Activator注册器</h3><p>每个插件都有自己的注册器Activator。</p>
<p>右键项目选择<em>新建子项目-其他项目-Empty qmake Project</em>，项目名称为HelloCTK，pro文件中添加代码：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">QT += core</span><br><span class="line">QT -= gui</span><br><span class="line"></span><br><span class="line">TEMPLATE = lib</span><br><span class="line">CONFIG += plugin</span><br><span class="line">TARGET = HelloCTK</span><br><span class="line">DESTDIR = $<span class="variable">$OUT_PWD</span>/<span class="built_in">..</span>/bin/plugins</span><br><span class="line"></span><br><span class="line">include($<span class="variable">$PWD</span>/<span class="built_in">..</span>/CTK.pri)</span><br></pre></td></tr></table></figure>
<p><strong><em>生成的插件名(TARGET)不要有下划线，因为CTK会默认将插件名中的下划线替换成点号，最后后就导致找不到插件。</em></strong></p>
<p>项目中添加C++类HelloActivator，代码如下：</p>
<p><em>hello_activator.h</em></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HELLO_ACTIVATOR_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HELLO_ACTIVATOR_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"ctkPluginActivator.h"</span></span></span><br><span class="line"></span><br><span class="line">class HelloActivator : <span class="keyword">public</span> QObject, <span class="keyword">public</span> ctkPluginActivator</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line">    Q_INTERFACES(ctkPluginActivator)</span><br><span class="line">    Q_PLUGIN_METADATA(IID <span class="string">"HELLO_CTK"</span>)</span><br><span class="line">    <span class="comment">//向Qt的插件框架声明，希望将xxx插件放入到框架中。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">void</span> start(ctkPluginContext* context);</span><br><span class="line">    <span class="keyword">void</span> <span class="built_in">stop</span>(ctkPluginContext* context);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// HELLO_ACTIVATOR_H</span></span></span><br></pre></td></tr></table></figure>
<p><em>hello_activator.cpp</em></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"hello_activator.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> HelloActivator::start(ctkPluginContext* context)</span><br><span class="line">&#123;</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">"HelloCTK start"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> HelloActivator::stop(ctkPluginContext* context)</span><br><span class="line">&#123;</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">"HelloCTK stop"</span>;</span><br><span class="line">    Q_UNUSED(context)</span><br><span class="line">    <span class="comment">//Q_UNUSED,如果一个函数的有些参数没有用到、某些变量只声明不使用，但是又不想编译器、编辑器报警报，其他没有什么实际性作用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>activator是标准的Qt插件类，它实现ctkPluginActivator的start、stop函数并对外提供接口。我这里是Qt5的版本，所以使用Q_PLUGIN_METADATA申明插件，Qt4需要用自己的方法实现插件。</p>
<h3 id="qrc文件"><a href="#qrc文件" class="headerlink" title="qrc文件"></a>qrc文件</h3><p>创建插件的资源文件，格式如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">RCC</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">qresource</span> <span class="attr">prefix</span>=<span class="string">"/HelloCTK/META-INF"</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">file</span>&gt;</span>MANIFEST.MF<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">qresource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">RCC</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>插件加载后会寻找<em>同名前缀/META-INF</em>，所以前缀格式固定，将MANIFEST.MF文件添加进来</p>
<p>MENIFEST.MF文件内容如下：</p>
<p>可直接在MF文件里添加自己特有的元数据</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Plugin</span>-SymbolicName:HelloCTK</span><br><span class="line"><span class="keyword">Plugin</span>-<span class="keyword">Version</span>:1.0.0</span><br><span class="line"><span class="keyword">Plugin</span>-Number:100 #元数据</span><br></pre></td></tr></table></figure>
<p><strong><em>注意：Plugin-SymbolicName要满足这里的前缀是：TARGET/META-INF格式。TARGET的名字最好和工程名一致，不然可能出现device not open错误。</em></strong></p>
<p>文件包含ctk插件的基本信息，只要ctk框架正常识别到文件中Plugin-SymbolicName等信息，则判定它是一个ctk插件，能够正常调用activator中的start、stop函数。这个文件需要拷到插件生成路径下，pro文件中添加代码：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file<span class="selector-class">.path</span> = $<span class="variable">$DESTDIR</span></span><br><span class="line">file<span class="selector-class">.files</span> = MANIFEST.MF</span><br><span class="line">INSTALLS += file</span><br></pre></td></tr></table></figure>
<h2 id="CTK插件启用"><a href="#CTK插件启用" class="headerlink" title="CTK插件启用"></a>CTK插件启用</h2><p>根据以上步骤，一个CTK插件接口定义基本完成，我们在App项目下调用观察插件是否能够正常加载。main函数中框架启动成功后添加以下代码：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">QString <span class="keyword">dir </span>= QCoreApplication::applicationDirPath()<span class="comment">;</span></span><br><span class="line">    <span class="keyword">dir </span>+= <span class="string">"/plugins/HelloCTK.dll"</span><span class="comment">;</span></span><br><span class="line">    qDebug() &lt;&lt; <span class="keyword">dir;</span></span><br><span class="line"><span class="keyword"> </span>   QUrl url = QUrl::fromLocalFile(<span class="keyword">dir);</span></span><br><span class="line"><span class="keyword"> </span>   QSharedPointer&lt;ctkPlugin&gt; plugin<span class="comment">;</span></span><br><span class="line">    try</span><br><span class="line">    &#123;</span><br><span class="line">        plugin = framework-&gt;getPluginContext()-&gt;<span class="keyword">installPlugin(url);</span></span><br><span class="line"><span class="keyword"> </span>   &#125;catch(ctkPluginException e)&#123;</span><br><span class="line">        qDebug() &lt;&lt; e.message() &lt;&lt; e.getType()<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">    try&#123;</span><br><span class="line">        plugin-&gt;start(ctkPlugin::START_TRANSIENT)<span class="comment">;</span></span><br><span class="line">    &#125;catch(ctkPluginException e)&#123;</span><br><span class="line">        qDebug() &lt;&lt; e.message() &lt;&lt; e.getType()<span class="comment">;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>控制台打印输出：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:/d/mmm/qt/ctk/CTK-examples/build-SampleCTK-Desktop_Qt_5_15_1_MSVC2019_64bit-Release/bin/plugins"</span></span><br><span class="line"> HelloCTK <span class="literal">start</span></span><br></pre></td></tr></table></figure>
<p>成功调用HelloCTK中start内打印输出，则表明ctk插件接口正常定义并能成功加载。其中<em>start</em>(ctkPlugin::START_TRANSIENT)表示立即启用插件，不设置参数的话加载后也不会立即打印输出。</p>
<h1 id="基本使用-CTK-Plugin-Framework"><a href="#基本使用-CTK-Plugin-Framework" class="headerlink" title="基本使用 CTK Plugin Framework"></a>基本使用 CTK Plugin Framework</h1><h2 id="CTK插件间通信"><a href="#CTK插件间通信" class="headerlink" title="CTK插件间通信"></a>CTK插件间通信</h2><p>CTK框架插件化开发实现功能的隔离，插件通信需要参照固定标准，这里介绍两种插件间通信的方法。</p>
<h3 id="通信方法一-注册接口调用"><a href="#通信方法一-注册接口调用" class="headerlink" title="通信方法一. 注册接口调用"></a><strong>通信方法一. 注册接口调用</strong></h3><h4 id="注册接口调用"><a href="#注册接口调用" class="headerlink" title="注册接口调用"></a><strong>注册接口调用</strong></h4><h5 id="函数接口"><a href="#函数接口" class="headerlink" title="函数接口"></a><strong>函数接口</strong></h5><p>接口就是纯虚函数类，也就是最终的服务的前身。</p>
<p>上面我们已经编译出需要的动态库，首先确定我们需要插件向外部暴露的功能有什么，比如这里我们需要说”Hello,CTK!”的操作，定义头文件如下：<em>hello_service.h</em></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HELLO_SERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HELLO_SERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtPlugin&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloService</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~HelloService() &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HelloService_iid <span class="meta-string">"org.commontk.service.demos.HelloService"</span></span></span><br><span class="line">Q_DECLARE_INTERFACE(HelloService, HelloService_iid)</span><br><span class="line"><span class="comment">//此宏将当前这个接口类声明为接口，后面的一长串就是这个接口的唯一标识。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// HELLO_SERVICE_H</span></span></span><br></pre></td></tr></table></figure>
<p> Q_DECLARE_INTERFACE将接口类向Qt系统申明，然后添加它的实现对象：</p>
<h5 id="接口的实现"><a href="#接口的实现" class="headerlink" title="接口的实现"></a><strong>接口的实现</strong></h5><p>插件就是实现这个接口类的实现类，所以理论上有多少个实现类就有多少个插件。</p>
<p><em>hello_impl.h</em></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HELLO_IMPL_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HELLO_IMPL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"hello_service.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"></span><br><span class="line">class ctkPluginContext;</span><br><span class="line"></span><br><span class="line">class HelloImpl : <span class="keyword">public</span> QObject, <span class="keyword">public</span> HelloService</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line">    Q_INTERFACES(HelloService)</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    此宏与Q_DECLARE_INTERFACE宏配合使用。</span></span><br><span class="line"><span class="comment">    Q_DECLARE_INTERFACE：声明一个接口类</span></span><br><span class="line"><span class="comment">    Q_INTERFACES：当一个类继承这个接口类，表明需要实现这个接口类</span></span><br><span class="line"><span class="comment">    */</span>    </span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    HelloImpl(ctkPluginContext* context);</span><br><span class="line">    <span class="keyword">void</span> sayHello() Q_DECL_OVERRIDE;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// HELLO_IMPL_H</span></span></span><br></pre></td></tr></table></figure>
<p><em>hello_impl.cpp</em></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"hello_impl.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctkPluginContext.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="symbol">HelloImpl:</span>:HelloImpl(ctkPluginContext* context)</span><br><span class="line">&#123;</span><br><span class="line">    context-&gt;registerService<span class="params">&lt;HelloService&gt;</span>(this);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void <span class="symbol">HelloImpl::</span>sayHello()</span><br><span class="line">&#123;</span><br><span class="line">    qDebug() <span class="params">&lt;&lt; "Hello,CTK!";</span></span><br><span class="line"><span class="params">&#125;</span></span><br></pre></td></tr></table></figure>
<p>这仍是Qt的插件定义格式，但是不会作为插件导出，外部功能接口可以自定义。</p>
<h5 id="服务注册-Activator注册服务"><a href="#服务注册-Activator注册服务" class="headerlink" title="服务注册(Activator注册服务)"></a><strong>服务注册(Activator注册服务)</strong></h5><p>激活类里有一个独占智能指针，指向接口类【使用多态，指针都指向父类】，然后在start里new一个实现类，注册这个实现类为服务，功能是实现接口类的接口，然后将智能指针指向这个实现类。可以理解为以后向框架索取这个服务的时候，实际获取的就是这个new出来的实现类。如果不用智能指针，就需要在stop里手动delete这个实现类。</p>
<p>每个插件都有自己的注册器Activator，功能节接口完成后，在插件启动时注册到ctk框架的服务中，代码如下：<em>hello_activator.cpp</em></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"hello_activator.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"hello_impl.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> HelloActivator::start(ctkPluginContext* context)</span><br><span class="line">&#123;</span><br><span class="line">    s.reset(<span class="keyword">new</span> HelloImpl(context));</span><br><span class="line">    <span class="comment">//调用注册服务context-&gt;registerService&lt;HelloService&gt;(this);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="接口调用"><a href="#接口调用" class="headerlink" title="接口调用"></a><strong>接口调用</strong></h5><p><strong><em>CTK插件启用后，就可以调用接口。</em></strong></p>
<p>主函数框架及插件加载完成后，即可调用插件接口，代码如下：<em>main.cpp</em></p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#include <span class="string">"../HelloCTK/hello_service.h"</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取服务引用</span></span><br><span class="line">    <span class="function"><span class="title">ctkServiceReference</span> reference = context-&gt;</span>getServiceReference&lt;HelloService&gt;();</span><br><span class="line">    <span class="keyword">if</span> (reference) &#123;</span><br><span class="line">        <span class="comment">// 获取指定 ctkServiceReference 引用的服务对象</span></span><br><span class="line">        H<span class="function"><span class="title">elloService</span>* service = qobject_cast&lt;HelloService *&gt;(context-&gt;</span>getService(reference));</span><br><span class="line">        <span class="keyword">if</span> (service != Q_NULLPTR) &#123;</span><br><span class="line">            <span class="comment">// 调用服务</span></span><br><span class="line">            <span class="function"><span class="title">service</span>-&gt;</span>sayHello();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在获取服务的时候，有两个重载方式【可直接使用的】</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1、HelloService*<span class="built_in"> service </span>= context-&gt;getService&lt;HelloService&gt;(reference);</span><br><span class="line">2、HelloService*<span class="built_in"> service </span>= qobject_cast&lt;HelloService*&gt;(context-&gt;getService(reference));</span><br></pre></td></tr></table></figure>
<p><strong><em>服务就是根据接口的实例，每生成一个服务就会调用一次注册器的start。把接口当做类，服务是根据类new出的对象，插件就是动态库dll。</em></strong></p>
<p>项目代码：<a href="https://github.com/myhhub/CTK-project/tree/main/SampleCTK" target="_blank" rel="noopener">SampleCTK</a></p>
<h4 id="优化解耦-实现类和激活类分离"><a href="#优化解耦-实现类和激活类分离" class="headerlink" title="优化解耦(实现类和激活类分离)"></a><strong>优化解耦(实现类和激活类分离)</strong></h4><p>编写插件主要有3个步骤：接口类、实现类、激活类。不在实现类的构造函数里注册服务，降低耦合性，接口类就只做接口声明，实现类就只实现接口，激活类就负责将服务整合到ctk框架中。</p>
<p>接口类没有什么变化，实现类少了注册的代码，构造函数也无参数，注册的过程放在了激活类里。</p>
<p><strong>1. 实现类</strong></p>
<p><em>.h</em></p>
<figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HelloImpl( )<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p><em>.cpp</em></p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HelloImpl::HelloImpl<span class="comment">( )</span></span><br><span class="line">&#123;</span><br><span class="line">     qDebug<span class="comment">()</span>&lt;&lt;<span class="string">"this is imp"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>2. 激活类</strong></p>
<p><em>.cpp</em></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void HelloActivator::start(ctkPluginContext* <span class="built_in">context</span>)</span><br><span class="line">&#123;</span><br><span class="line">    HelloImpl* helloImpl = new HelloImpl(<span class="built_in">context</span>)<span class="comment">;</span></span><br><span class="line">    <span class="built_in">context</span>-&gt;registerService&lt;HelloService&gt;(helloImpl)<span class="comment">;</span></span><br><span class="line">    s.reset(helloImpl)<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="接口、插件、服务的关系"><a href="#接口、插件、服务的关系" class="headerlink" title="接口、插件、服务的关系"></a><strong>接口、插件、服务的关系</strong></h4><p><strong>1、1对1</strong></p>
<p> 1个接口类由1个类实现，输出1个服务和1个插件。</p>
<p>上面项目为典型1对1关系。</p>
<p><strong>2、多对1</strong></p>
<p>1个类实现了多个接口类，输出多个服务和1个插件，无论想使用哪个服务最终都通过这同一个插件来实现。</p>
<p><strong>实现类</strong>，实现多个接口。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"greet_impl.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line">GreetImpl::GreetImpl()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> GreetImpl::sayHello()</span><br><span class="line">&#123;</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">"Hello,CTK!"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> GreetImpl::sayBye()</span><br><span class="line">&#123;</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">"Bye,CTK!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>获取不同服务</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取服务引用</span></span><br><span class="line">ctkServiceReference <span class="keyword">ref</span> = context-&gt;getServiceReference&lt;HelloService&gt;();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">ref</span>) &#123;</span><br><span class="line">    HelloService* service = qobject_cast&lt;HelloService *&gt;(context-&gt;getService(<span class="keyword">ref</span>));</span><br><span class="line">    <span class="keyword">if</span> (service != Q_NULLPTR)</span><br><span class="line">        service-&gt;sayHello();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ref</span> = context-&gt;getServiceReference&lt;ByeService&gt;();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">ref</span>) &#123;</span><br><span class="line">    ByeService* service = qobject_cast&lt;ByeService *&gt;(context-&gt;getService(<span class="keyword">ref</span>));</span><br><span class="line">    <span class="keyword">if</span> (service != Q_NULLPTR)</span><br><span class="line">        service-&gt;sayBye();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体实现参见项目：<a href="https://github.com/myhhub/CTK-project/tree/main/PluginAndService/MultipleInterfaces" target="_blank" rel="noopener">PluginAndService/MultipleInterfaces</a></p>
<p><strong>3、1对多</strong></p>
<p>1接口由多个个类实现，也就是某一个问题提供了多种解决思路，输出1个服务和多个插件，通过ctkPluginConstants::SERVICE_RANKING和ctkPluginConstants::SERVICE_ID来调用不同的插件。这里虽然有两个插件，但都是被编译到同一个dll中的。服务的获取策略如下：容器会返回排行最低的服务，返回注册时SERVICE_RANKING属性值最小的服务。如果有多个服务的排行值相等，那么容器将返回PID值最小的那个服务。</p>
<p>某插件每次调用另一个插件的时候，只会生成一个实例，然后把实例存到内存当中，不会因为多次调用而生成多个服务实例。</p>
<p>在使用1接口2插件的时候，虽然是两个插件，也会有两个激活类【从原理上来讲1个激活类就行了，但是在start里注册两次】，其中的IID只能有一个。从Qt插件基础上来说，一个dll只能有一个IID。</p>
<p><strong>多个实现类</strong>，实现1个接口。</p>
<p><em>welcome_ctk_impl.cpp</em></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"welcome_ctk_impl.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line">WelcomeCTKImpl::WelcomeCTKImpl()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> WelcomeCTKImpl::welcome()</span><br><span class="line">&#123;</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">"Welcome CTK!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>welcome_qt_impl.cpp</em></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"welcome_qt_impl.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line">WelcomeQtImpl::WelcomeQtImpl()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> WelcomeQtImpl::welcome()</span><br><span class="line">&#123;</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">"Welcome Qt!"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>对应的多个激活类</em></strong></p>
<p><em>welcome_ctk_activator.cpp</em></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"welcome_ctk_impl.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"welcome_ctk_activator.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line">void <span class="symbol">WelcomeCTKActivator::</span>start(ctkPluginContext* context)</span><br><span class="line">&#123;</span><br><span class="line">    ctkDictionary properties;</span><br><span class="line">    properties.insert(<span class="symbol">ctkPluginConstants::</span>SERVICE_RANKING, <span class="number">2</span>);</span><br><span class="line">    properties.insert(<span class="string">"name"</span>, <span class="string">"CTK"</span>);</span><br><span class="line"></span><br><span class="line">    m_pImpl = new WelcomeCTKImpl();</span><br><span class="line">    context-&gt;registerService<span class="params">&lt;WelcomeService&gt;</span>(m_pImpl, properties);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void <span class="symbol">WelcomeCTKActivator::</span>stop(ctkPluginContext* context)</span><br><span class="line">&#123;</span><br><span class="line">    Q_UNUSED(context)</span><br><span class="line"></span><br><span class="line">    delete m_pImpl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>welcome_qt_activator.cpp</em></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"welcome_qt_impl.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"welcome_qt_activator.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line">void <span class="symbol">WelcomeQtActivator::</span>start(ctkPluginContext* context)</span><br><span class="line">&#123;</span><br><span class="line">    ctkDictionary properties;</span><br><span class="line">    properties.insert(<span class="symbol">ctkPluginConstants::</span>SERVICE_RANKING, <span class="number">1</span>);</span><br><span class="line">    properties.insert(<span class="string">"name"</span>, <span class="string">"Qt"</span>);</span><br><span class="line"></span><br><span class="line">    m_pImpl = new WelcomeQtImpl();</span><br><span class="line">    context-&gt;registerService<span class="params">&lt;WelcomeService&gt;</span>(m_pImpl, properties);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void <span class="symbol">WelcomeQtActivator::</span>stop(ctkPluginContext* context)</span><br><span class="line">&#123;</span><br><span class="line">    Q_UNUSED(context)</span><br><span class="line"></span><br><span class="line">    delete m_pImpl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>获取服务</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 获取所有服务</span></span><br><span class="line">QList&lt;ctkServiceReference&gt; refs = context-&gt;getServiceReferences&lt;WelcomeService&gt;();</span><br><span class="line">foreach (ctkServiceReference <span class="keyword">ref</span>, refs) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">ref</span>) &#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"Name:"</span> &lt;&lt; <span class="keyword">ref</span>.getProperty(<span class="string">"name"</span>).toString()</span><br><span class="line">                 &lt;&lt;  <span class="string">"Service ranking:"</span> &lt;&lt; <span class="keyword">ref</span>.getProperty(ctkPluginConstants::SERVICE_RANKING).toLongLong()</span><br><span class="line">                  &lt;&lt; <span class="string">"Service id:"</span> &lt;&lt; <span class="keyword">ref</span>.getProperty(ctkPluginConstants::SERVICE_ID).toLongLong();</span><br><span class="line">        WelcomeService* service = qobject_cast&lt;WelcomeService *&gt;(context-&gt;getService(<span class="keyword">ref</span>));</span><br><span class="line">        <span class="keyword">if</span> (service != Q_NULLPTR)</span><br><span class="line">            service-&gt;welcome();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 使用过滤表达式，获取感兴趣的服务</span></span><br><span class="line">refs = context-&gt;getServiceReferences&lt;WelcomeService&gt;(<span class="string">"(&amp;(name=CTK))"</span>);</span><br><span class="line">foreach (ctkServiceReference <span class="keyword">ref</span>, refs) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">ref</span>) &#123;</span><br><span class="line">        WelcomeService* service = qobject_cast&lt;WelcomeService *&gt;(context-&gt;getService(<span class="keyword">ref</span>));</span><br><span class="line">        <span class="keyword">if</span> (service != Q_NULLPTR)</span><br><span class="line">            service-&gt;welcome();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. 获取某一个服务（由 Service Ranking 和 Service ID 决定）</span></span><br><span class="line">ctkServiceReference <span class="keyword">ref</span> = context-&gt;getServiceReference&lt;WelcomeService&gt;();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">ref</span>) &#123;</span><br><span class="line">    WelcomeService* service = qobject_cast&lt;WelcomeService *&gt;(context-&gt;getService(<span class="keyword">ref</span>));</span><br><span class="line">    <span class="keyword">if</span> (service != Q_NULLPTR)</span><br><span class="line">        service-&gt;welcome();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体实现参见项目：<a href="https://github.com/myhhub/CTK-project/tree/main/PluginAndService/OneInterface" target="_blank" rel="noopener">PluginAndService/OneInterface</a></p>
<h3 id="通信方法二-事件监听"><a href="#通信方法二-事件监听" class="headerlink" title="通信方法二. 事件监听"></a><strong>通信方法二. 事件监听</strong></h3><p>CTK框架中的事件监听，即观察者模式流程上是这样：接收者注册监听事件-&gt;发送者发送事件-&gt;接收者接收到事件并响应；相比调用插件接口，监听事件插件间依赖关系更弱，不用指定事件的接收方和发送方是谁。</p>
<p>要使用CTK框架的事件服务，准备工作应该从cmake开始，编译出支持事件监听的动态库，名称为liborg_commontk_eventadmin.dll。现在要完成的内容是，从上面生成的主窗体中，以事件监听的方式调用一个子窗体。</p>
<p>1、通信主要用到了ctkEventAdmin结构体，主要定义了如下接口：</p>
<p>postEvent：类通信形式异步发送事件</p>
<p>sendEvent：类通信形式同步发送事件</p>
<p>publishSignal：信号与槽通信形式发送事件</p>
<p>unpublishSignal：取消发送事件</p>
<p>subscribeSlot：信号与槽通信形式订阅时间，返回订阅的ID</p>
<p>unsubscribeSlot：取消订阅事件</p>
<p>updateProperties：更新某个订阅ID的主题</p>
<p>2、通信的数据是：ctkDictionary</p>
<p>其实就是个hash表：typedef QHash&lt;QString,QVariant&gt; ctkDictionary</p>
<h4 id="事件监听"><a href="#事件监听" class="headerlink" title="事件监听"></a><strong>事件监听</strong></h4><p>具体项目：EventAdmin/SendEvent</p>
<h5 id="加载EventAdmin动态库"><a href="#加载EventAdmin动态库" class="headerlink" title="加载EventAdmin动态库"></a><strong>加载EventAdmin动态库</strong></h5><p>添加动态库可以使用ctkPluginFrameworkLauncher，代码如下：<em>main.cpp</em></p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    /<span class="regexp">/ 获取插件所在位置</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ 在插件的搜索路径列表中添加一条路径</span></span><br><span class="line"><span class="regexp">    ctkPluginFrameworkLauncher::addSearchPath("../</span>../../../CTKInstall/<span class="class"><span class="keyword">lib</span>/<span class="title">ctk</span>-0.1/<span class="title">plugins</span>");</span></span><br><span class="line">    /<span class="regexp">/ 设置并启动 CTK 插件框架</span></span><br><span class="line"><span class="regexp">    ctkPluginFrameworkLauncher::start("org.commontk.eventadmin");</span></span><br><span class="line"><span class="regexp"> ……</span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 停止插件</span></span><br><span class="line"><span class="regexp">ctkPluginFrameworkLauncher::stop();</span></span><br></pre></td></tr></table></figure>
<h5 id="事件注册监听-接收插件"><a href="#事件注册监听-接收插件" class="headerlink" title="事件注册监听(接收插件)"></a><strong>事件注册监听(接收插件)</strong></h5><p>首先编写我们需要的接收者模块，并注册监听事件，这里我们新建一个模块BlogEventHandler，模块的接口处理参见上面“CTK插件的接口处理”。插件部分代码如下：</p>
<p><em>blog_event_handler.h</em> </p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> BLOG_EVENT_HANDLER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BLOG_EVENT_HANDLER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;service/event/ctkEventHandler.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 事件处理程序（或订阅者）</span></span><br><span class="line">class BlogEventHandler : <span class="keyword">public</span> QObject, <span class="keyword">public</span> ctkEventHandler</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line">    Q_INTERFACES(ctkEventHandler)</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 处理事件</span></span><br><span class="line">    <span class="keyword">void</span> handleEvent(<span class="keyword">const</span> ctkEvent&amp; event) Q_DECL_OVERRIDE</span><br><span class="line">    &#123;</span><br><span class="line">        QString title = event.getProperty(<span class="string">"title"</span>).toString();</span><br><span class="line">        QString content = event.getProperty(<span class="string">"content"</span>).toString();</span><br><span class="line">        QString author = event.getProperty(<span class="string">"author"</span>).toString();</span><br><span class="line"></span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"EventHandler received the message, topic:"</span> &lt;&lt; event.getTopic()</span><br><span class="line">                 &lt;&lt; <span class="string">"properties:"</span> &lt;&lt; <span class="string">"title:"</span> &lt;&lt; title &lt;&lt; <span class="string">"content:"</span> &lt;&lt; content &lt;&lt; <span class="string">"author:"</span> &lt;&lt; author;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// BLOG_EVENT_HANDLER_H</span></span></span><br></pre></td></tr></table></figure>
<p>与上面自定义接口不同，这里我们实例化ctkEventHandler对象，并实现<em>handleEvent</em>接口。构造函数中注册的服务对象是ctkEventHandler，在注册时指定触发的事件，当事件触发时调用该对象的<em>handleEvent</em>实现指定操作。</p>
<h5 id="事件发送-发送插件"><a href="#事件发送-发送插件" class="headerlink" title="事件发送(发送插件)"></a><strong>事件发送(发送插件)</strong></h5><p>监听对象完成后调用比较简单，代码如下：<em>blog_manager.cpp</em></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"blog_manager.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;service/event/ctkEventAdmin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="symbol">BlogManager:</span>:BlogManager(ctkPluginContext* context)</span><br><span class="line">    : m_pContext(context)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发布事件</span></span><br><span class="line">void <span class="symbol">BlogManager::</span>publishBlog(const Blog&amp; blog)</span><br><span class="line">&#123;</span><br><span class="line">    ctkServiceReference ref = m_pContext-&gt;getServiceReference<span class="params">&lt;ctkEventAdmin&gt;</span>();</span><br><span class="line">    if (ref) &#123;</span><br><span class="line">        ctkEventAdmin* eventAdmin = m_pContext-&gt;getService<span class="params">&lt;ctkEventAdmin&gt;</span>(ref);</span><br><span class="line"></span><br><span class="line">        ctkDictionary props;</span><br><span class="line">        props[<span class="string">"title"</span>] = blog.title;</span><br><span class="line">        props[<span class="string">"content"</span>] = blog.content;</span><br><span class="line">        props[<span class="string">"author"</span>] = blog.author;</span><br><span class="line">        ctkEvent event(<span class="string">"org/commontk/bloggenerator/published"</span>, props);</span><br><span class="line"></span><br><span class="line">        qDebug() <span class="params">&lt;&lt; "Publisher sends a message, properties:" &lt;&lt; props;</span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">        eventAdmin-&gt;</span>sendEvent(event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>项目代码：<a href="https://github.com/myhhub/CTK-project/tree/main/EventAdmin/SendEvent" target="_blank" rel="noopener">EventAdmin/SendEvent</a></p>
<h4 id="事件发送方式-类通信、信号槽通信"><a href="#事件发送方式-类通信、信号槽通信" class="headerlink" title="事件发送方式(类通信、信号槽通信)"></a><strong>事件发送方式(类通信、信号槽通信)</strong></h4><h5 id="1、类通信"><a href="#1、类通信" class="headerlink" title="1、类通信"></a><strong>1、类通信</strong></h5><p>原理就是直接将信息使用CTK的eventAdmin接口send/post出去。</p>
<p>上面项目为典型类通信。</p>
<h5 id="2、信号槽通信"><a href="#2、信号槽通信" class="headerlink" title="2、信号槽通信"></a><strong>2、信号槽通信</strong></h5><p>原理是将Qt自己的信号与CTK的发送事件绑定、槽与事件订阅绑定。</p>
<p><strong>接收槽</strong></p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">void <span class="keyword">BlogEventHandlerUsingSlotsActivator::start(ctkPluginContext* </span><span class="built_in">context</span>)</span><br><span class="line">&#123;</span><br><span class="line">    m_pEventHandler = new <span class="keyword">BlogEventHandlerUsingSlots();</span></span><br><span class="line"><span class="keyword"></span></span><br><span class="line"><span class="keyword"> </span>   ctkDictionary props<span class="comment">;</span></span><br><span class="line">    props[ctkEventConstants::EVENT_TOPIC] = <span class="string">"org/commontk/bloggenerator/published"</span><span class="comment">;</span></span><br><span class="line">    ctkServiceReference ref = <span class="built_in">context</span>-&gt;getServiceReference&lt;ctkEventAdmin&gt;()<span class="comment">;</span></span><br><span class="line">    if (ref) &#123;</span><br><span class="line">        ctkEventAdmin* eventAdmin = <span class="built_in">context</span>-&gt;getService&lt;ctkEventAdmin&gt;(ref)<span class="comment">;</span></span><br><span class="line">        eventAdmin-&gt;<span class="keyword">subscribeSlot(m_pEventHandler, </span>SLOT(onBlogPublished(ctkEvent)), props, Qt::<span class="keyword">DirectConnection);</span></span><br><span class="line"><span class="keyword"> </span>   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>发送信号</strong></p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">BlogManagerUsingSignals::BlogManagerUsingSignals(ctkPluginContext *context)</span><br><span class="line">&#123;</span><br><span class="line">    ctkServiceReference <span class="keyword">ref</span> = context-&gt;getServiceReference&lt;ctkEventAdmin&gt;();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">ref</span>) &#123;</span><br><span class="line">        ctkEventAdmin* eventAdmin = context-&gt;getService&lt;ctkEventAdmin&gt;(<span class="keyword">ref</span>);</span><br><span class="line">        <span class="comment">// 使用 Qt::DirectConnection 等同于 ctkEventAdmin::sendEvent()</span></span><br><span class="line">        eventAdmin-&gt;publishSignal(this, SIGNAL(blogPublished(ctkDictionary)), <span class="string">"org/commontk/bloggenerator/published"</span>, Qt::DirectConnection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体项目：项目代码：<a href="https://github.com/myhhub/CTK-project/tree/main/EventAdmin/SignalSlot" target="_blank" rel="noopener">EventAdmin/SignalSlot</a></p>
<h5 id="二者的区别"><a href="#二者的区别" class="headerlink" title="二者的区别"></a><strong>二者的区别</strong></h5><p>1、通过event事件通信，是直接调用CTK的接口，把数据发送到CTK框架；通过信号槽方式，会先在Qt的信号槽机制中转一次，再发送到CTK框架。故效率上来讲，event方式性能高于信号槽方式。</p>
<p>2、两种方式发送数据到CTK框架，这个数据包含：主题+属性。主题就是topic，属性就是ctkDictionary。 一定要注意signal方式的信号定义，参数不能是自定义的，一定要是ctkDictionary，不然会报信号槽参数异常错误。</p>
<p>3、两种方式可以混用，如发送event事件，再通过槽去接收；发送signal事件，再通过event是接收。</p>
<p>4、同步：sendEvent、Qt::DirectConnection；异步：postEvent、Qt::QueuedConnection</p>
<p>这里的同步是指：发送事件之后，订阅了这个主题的数据便会处理数据【handleEvent、slot】，处理的过程是在发送者的线程完成的。可以理解为在发送了某个事件之后，会立即执行所有订阅此事件的回调函数。</p>
<p>异步：发送事件之后，发送者便会返回不管，订阅了此事件的所有插件会根据自己的消息循环，轮到了处理事件后才会去处理。不过如果长时间没处理，CTK也有自己的超时机制。如果事件处理程序花费的时间比配置的超时时间长，那么就会被列入黑名单。一旦处理程序被列入黑名单，它就不会再被发送任何事件。</p>
<h2 id="插件依赖"><a href="#插件依赖" class="headerlink" title="插件依赖"></a>插件依赖</h2><p>插件加载时一般根据首字母大小自动加载，所以在插件启用时，某个插件还没有被调用，所以发送事件没有接收方，这样就要考虑到插件依赖关系，在MANIFEST.MF中添加依赖：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Plugin</span>-SymbolicName:<span class="keyword">Plugin</span>-xxx-1</span><br><span class="line"><span class="keyword">Plugin</span>-<span class="keyword">Version</span>:1.0.0</span><br><span class="line">Require-<span class="keyword">Plugin</span>:<span class="keyword">Plugin</span>-xxx-2; <span class="keyword">plugin</span>-<span class="keyword">version</span>=<span class="string">"[1.0,2.0)"</span>; resolution:=<span class="string">"mandatory"</span></span><br></pre></td></tr></table></figure>
<p>Plugin-xxx-2：为需要依赖的插件名【就是另一个插件在MANIFEST.MF里的Plugin-SymbolicName】；</p>
<p>[1.0,2.0)：为Plugin-xxx-2的版本，这里是左闭右开区间，默认是1.0,；</p>
<p>resolution：有两个选择，optional、mandatory。前者是弱依赖，就算依赖的插件没有，当前插件也能正常使用，后者是强依赖，如果没有依赖的插件，就当前插件就不能被start。</p>
<p>这样就向框架申明了，该插件加载时需要先加载Plugin-xxx-2插件，所有用户插件都应该有这样一份申明。</p>
<p>具体实现参见项目：<a href="https://github.com/myhhub/CTK-project/tree/main/RequirePlugin" target="_blank" rel="noopener">RequirePlugin</a></p>
<h2 id="插件元数据"><a href="#插件元数据" class="headerlink" title="插件元数据"></a>插件元数据</h2><p>获取MANIFEST.MF中的数据 </p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">QHash<span class="params">&lt;QString, QString&gt;</span> headers = plugin-&gt;getHeaders();</span><br><span class="line">ctkVersion version = <span class="symbol">ctkVersion::</span>parseVersion(headers.value(<span class="symbol">ctkPluginConstants::</span>PLUGIN_VERSION)); </span><br><span class="line">QString name = headers.value(<span class="symbol">ctkPluginConstants::</span>PLUGIN_NAME);</span><br></pre></td></tr></table></figure>
<p>具体实现参见项目：<a href="https://github.com/myhhub/CTK-project/tree/main/GetMetaData" target="_blank" rel="noopener">GetMetaData</a></p>
<h1 id="高级使用-CTK-Plugin-Framework"><a href="#高级使用-CTK-Plugin-Framework" class="headerlink" title="高级使用 CTK Plugin Framework"></a>高级使用 CTK Plugin Framework</h1><h2 id="CTK-服务工厂"><a href="#CTK-服务工厂" class="headerlink" title="CTK 服务工厂"></a>CTK 服务工厂</h2><p>注册服务的时候能够用服务工厂来注册，访问服务<br>getService中的plugin参数是执行ctkPluginContext::getService(const ctkServiceReference&amp;)的插件,从而这里工厂根据执行的不同插件名称返回了不同的服务实现。</p>
<p>服务工厂的作用：</p>
<ol>
<li><p>在服务中可以知道是哪个其他插件在使用它；</p>
</li>
<li><p>懒汉式使用服务，需要的时候才new；</p>
</li>
<li><p>厂其他插件使用有服务工厂和使用无服务工的服务，没有任何区别，代码都一样；</p>
</li>
<li><p>可根据需要创建多种实现的服务，就是：多种服务对应一个插件。</p>
</li>
</ol>
<h3 id="接口类"><a href="#接口类" class="headerlink" title="接口类"></a><strong>接口类</strong></h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HELLO_SERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HELLO_SERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtPlugin&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloService</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~HelloService() &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HelloService_iid <span class="meta-string">"org.commontk.service.demos.HelloService"</span></span></span><br><span class="line">Q_DECLARE_INTERFACE(HelloService, HelloService_iid)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// HELLO_SERVICE_H</span></span></span><br></pre></td></tr></table></figure>
<h3 id="多实现类"><a href="#多实现类" class="headerlink" title="多实现类"></a><strong>多实现类</strong></h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HELLO_IMPL_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HELLO_IMPL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"hello_service.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// HelloWorld</span></span><br><span class="line">class HelloWorldImpl : <span class="keyword">public</span> QObject, <span class="keyword">public</span> HelloService</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line">    Q_INTERFACES(HelloService)</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">void</span> sayHello() Q_DECL_OVERRIDE &#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"Hello,World!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HelloCTK</span></span><br><span class="line">class HelloCTKImpl : <span class="keyword">public</span> QObject, <span class="keyword">public</span> HelloService</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line">    Q_INTERFACES(HelloService)</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">void</span> sayHello() Q_DECL_OVERRIDE &#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"Hello,CTK!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// HELLO_IMPL_H</span></span></span><br></pre></td></tr></table></figure>
<h3 id="服务工厂类"><a href="#服务工厂类" class="headerlink" title="服务工厂类"></a><strong>服务工厂类</strong></h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> SERVICE_FACTORY_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERVICE_FACTORY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctkServiceFactory.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctkPluginConstants.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctkVersion.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"hello_impl.h"</span></span></span><br><span class="line"></span><br><span class="line">class ServiceFactory : <span class="keyword">public</span> QObject, <span class="keyword">public</span> ctkServiceFactory</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line">    Q_INTERFACES(ctkServiceFactory)</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ServiceFactory() : m_counter(<span class="number">0</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建服务对象</span></span><br><span class="line">    QObject* getService(QSharedPointer&lt;ctkPlugin&gt; plugin, ctkServiceRegistration registration) Q_DECL_OVERRIDE &#123;</span><br><span class="line">        Q_UNUSED(registration)</span><br><span class="line"></span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"Create object of HelloService for: "</span> &lt;&lt; plugin-&gt;getSymbolicName();</span><br><span class="line">        m_counter++;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"Number of plugins using service: "</span> &lt;&lt; m_counter;</span><br><span class="line"></span><br><span class="line">        QHash&lt;QString, QString&gt; headers = plugin-&gt;getHeaders();</span><br><span class="line">        ctkVersion version = ctkVersion::parseVersion(headers.value(ctkPluginConstants::PLUGIN_VERSION));</span><br><span class="line">        QString name = headers.value(ctkPluginConstants::PLUGIN_NAME);</span><br><span class="line"></span><br><span class="line">        QObject* hello = getHello(version);</span><br><span class="line">        <span class="built_in">return</span> hello;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放服务对象</span></span><br><span class="line">    <span class="keyword">void</span> ungetService(QSharedPointer&lt;ctkPlugin&gt; plugin, ctkServiceRegistration registration, QObject* service) Q_DECL_OVERRIDE &#123;</span><br><span class="line">        Q_UNUSED(plugin)</span><br><span class="line">        Q_UNUSED(registration)</span><br><span class="line">        Q_UNUSED(service)</span><br><span class="line"></span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"Release object of HelloService for: "</span>  &lt;&lt; plugin-&gt;getSymbolicName();</span><br><span class="line">        m_counter--;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"Number of plugins using service: "</span>  &lt;&lt; m_counter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">// 根据不同的版本，获取不同的服务</span></span><br><span class="line">    QObject* getHello(ctkVersion version) &#123;</span><br><span class="line">        <span class="built_in">if</span> (version.toString().contains(<span class="string">"alpha"</span>)) &#123;</span><br><span class="line">            <span class="built_in">return</span> <span class="keyword">new</span> HelloWorldImpl();</span><br><span class="line">        &#125; <span class="built_in">else</span> &#123;</span><br><span class="line">            <span class="built_in">return</span> <span class="keyword">new</span> HelloCTKImpl();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> m_counter;  <span class="comment">// 计数器</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// SERVICE_FACTORY_H</span></span></span><br></pre></td></tr></table></figure>
<p>可以根据插件，获取不同的服务。若主框架【main.cpp】的symbolicName是system.plugin</p>
<h3 id="激活类"><a href="#激活类" class="headerlink" title="激活类"></a><strong>激活类</strong></h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HELLO_ACTIVATOR_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HELLO_ACTIVATOR_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctkPluginActivator.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctkPluginContext.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"hello_service.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"service_factory.h"</span></span></span><br><span class="line"></span><br><span class="line">class HelloActivator : <span class="keyword">public</span> QObject, <span class="keyword">public</span> ctkPluginActivator</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line">    Q_INTERFACES(ctkPluginActivator)</span><br><span class="line">    Q_PLUGIN_METADATA(IID <span class="string">"HELLO"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">// 注册服务工厂</span></span><br><span class="line">    <span class="keyword">void</span> start(ctkPluginContext* context) &#123;</span><br><span class="line">        ServiceFactory *factory = <span class="keyword">new</span> ServiceFactory();</span><br><span class="line">        context-&gt;registerService&lt;HelloService&gt;(factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="built_in">stop</span>(ctkPluginContext* context) &#123;</span><br><span class="line">        Q_UNUSED(context)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// HELLO_ACTIVATOR_H</span></span></span><br></pre></td></tr></table></figure>
<h3 id="插件中访问服务"><a href="#插件中访问服务" class="headerlink" title="插件中访问服务"></a><strong>插件中访问服务</strong></h3><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 访问服务</span></span><br><span class="line"><span class="function"><span class="title">ctkServiceReference</span> reference = context-&gt;</span>getServiceReference&lt;HelloService&gt;();</span><br><span class="line"><span class="keyword">if</span> (reference) &#123;</span><br><span class="line">    H<span class="function"><span class="title">elloService</span>* service = qobject_cast&lt;HelloService *&gt;(context-&gt;</span>getService(reference));</span><br><span class="line">    <span class="keyword">if</span> (service != Q_NULLPTR) &#123;</span><br><span class="line">        <span class="function"><span class="title">service</span>-&gt;</span>sayHello();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体实现参见项目：<a href="https://github.com/myhhub/CTK-project/tree/main/ServiceFactory" target="_blank" rel="noopener">ServiceFactory</a></p>
<h2 id="CTK-事件监听"><a href="#CTK-事件监听" class="headerlink" title="CTK 事件监听"></a>CTK 事件监听</h2><p>CTK一共有三种事件可以监听：框架事件、插件事件、服务事件。但是这些事件只有再变化时才能监听到，如果已经变化过后，进入一个稳定的状态，这时才去监听，那么是无法监听到的。</p>
<h3 id="框架事件"><a href="#框架事件" class="headerlink" title="框架事件"></a>框架事件</h3><p>针对整个框架的，相当于只有一个，因为框架只有一个，但是这里有个问题，就是监听这个事件是在框架初始化之后的，所以根本没法监听到框架事件的初始化，只能监听到结束的事件。类型有</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FRAMEWORK_STARTED</span><br><span class="line">PLUGIN_ERROR</span><br><span class="line">PLUGIN_WARNING</span><br><span class="line">PLUGIN_INFO</span><br><span class="line">FRAMEWORK_STOPPED</span><br><span class="line">FRAMEWORK_STOPPED_UPDATE</span><br><span class="line">FRAMEWORK_WAIT_TIMEDOUT</span><br></pre></td></tr></table></figure>
<h3 id="服务事件"><a href="#服务事件" class="headerlink" title="服务事件"></a>服务事件</h3><p>在创建、回收插件时的事情，主要体现在服务的注册和注销。类型有</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">REGISTERED</span><br><span class="line">MODIFIED</span><br><span class="line">MODIFIED_ENDMATCH</span><br><span class="line">UNREGISTERING</span><br></pre></td></tr></table></figure>
<h3 id="插件事件"><a href="#插件事件" class="headerlink" title="插件事件"></a>插件事件</h3><p>在安装、启动插件的过程中呈现的，主要就是插件的一个状态的变化。类型有</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED</span><br><span class="line">RESOLVED</span><br><span class="line">LAZY_ACTIVATION</span><br><span class="line">STARTING</span><br><span class="line"><span class="literal">STARTED</span></span><br><span class="line">STOPPING</span><br><span class="line"><span class="literal">STOPPED</span></span><br><span class="line">UPDATED</span><br><span class="line">UNRESOLVED</span><br><span class="line">UNINSTALLED</span><br></pre></td></tr></table></figure>
<h3 id="监听例子"><a href="#监听例子" class="headerlink" title="监听例子"></a>监听例子</h3><p>监听类，<strong>event_listener.h</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> EVENT_LISTENER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EVENT_LISTENER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctkPluginFrameworkEvent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctkPluginEvent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctkServiceEvent.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventListener</span> :</span> <span class="keyword">public</span> QObject</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">EventListener</span><span class="params">(QObject *parent = Q_NULLPTR)</span></span>;</span><br><span class="line">    ~EventListener();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">    <span class="comment">// 监听框架事件</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onFrameworkEvent</span><span class="params">(<span class="keyword">const</span> ctkPluginFrameworkEvent&amp; event)</span></span>;</span><br><span class="line">    <span class="comment">// 监听插件事件</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onPluginEvent</span><span class="params">(<span class="keyword">const</span> ctkPluginEvent&amp; event)</span></span>;</span><br><span class="line">    <span class="comment">// 监听服务事件</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onServiceEvent</span><span class="params">(<span class="keyword">const</span> ctkServiceEvent&amp; event)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// EVENT_LISTENER_H</span></span></span><br></pre></td></tr></table></figure>
<p><strong>event_listener.cpp</strong></p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#<span class="keyword">include</span> <span class="string">"event_listener.h"</span></span><br><span class="line"></span><br><span class="line">EventListener::EventListener(QObject *parent)</span><br><span class="line">    : QObject(parent)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">EventListener::~EventListener()</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听框架事件</span></span><br><span class="line"><span class="keyword">void</span> EventListener::onFrameworkEvent(<span class="keyword">const</span> ctkPluginFrameworkEvent&amp; <span class="keyword">event</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">event</span><span class="variable">.isNull</span>()) &#123;</span><br><span class="line">        QSharedPointer&lt;ctkPlugin&gt; plugin = <span class="keyword">event</span><span class="variable">.getPlugin</span>();</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"FrameworkEvent: ["</span> &lt;&lt; plugin-&gt;getSymbolicName() &lt;&lt; <span class="string">"]"</span> &lt;&lt; <span class="keyword">event</span><span class="variable">.getType</span>() &lt;&lt; <span class="keyword">event</span><span class="variable">.getErrorString</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"The framework event is null"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听插件事件</span></span><br><span class="line"><span class="keyword">void</span> EventListener::onPluginEvent(<span class="keyword">const</span> ctkPluginEvent&amp; <span class="keyword">event</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">event</span><span class="variable">.isNull</span>()) &#123;</span><br><span class="line">        QSharedPointer&lt;ctkPlugin&gt; plugin = <span class="keyword">event</span><span class="variable">.getPlugin</span>();</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"PluginEvent: ["</span> &lt;&lt; plugin-&gt;getSymbolicName() &lt;&lt; <span class="string">"]"</span> &lt;&lt; <span class="keyword">event</span><span class="variable">.getType</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"The plugin event is null"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听服务事件</span></span><br><span class="line"><span class="keyword">void</span> EventListener::onServiceEvent(<span class="keyword">const</span> ctkServiceEvent &amp;<span class="keyword">event</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">event</span><span class="variable">.isNull</span>()) &#123;</span><br><span class="line">        ctkServiceReference <span class="keyword">ref</span> = <span class="keyword">event</span><span class="variable">.getServiceReference</span>();</span><br><span class="line">        QSharedPointer&lt;ctkPlugin&gt; plugin = <span class="keyword">ref</span><span class="variable">.getPlugin</span>();</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"ServiceEvent: ["</span> &lt;&lt; <span class="keyword">event</span><span class="variable">.getType</span>() &lt;&lt; <span class="string">"]"</span> &lt;&lt; plugin-&gt;getSymbolicName() &lt;&lt; <span class="keyword">ref</span><span class="variable">.getUsingPlugins</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"The service event is null"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启用监听,<strong>main.cpp</strong>：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 事件监听</span></span><br><span class="line">EventListener listener;</span><br><span class="line"><span class="function"><span class="title">context</span>-&gt;</span>connectFrameworkListener(&amp;listener, SLOT(onFrameworkEvent(ctkPluginFrameworkEvent)));</span><br><span class="line"><span class="function"><span class="title">context</span>-&gt;</span>connectPluginListener(&amp;listener, SLOT(onPluginEvent(ctkPluginEvent)));</span><br><span class="line"><span class="comment">// 过滤 ctkEventAdmin 服务</span></span><br><span class="line"><span class="comment">// QString filter = QString("(%1=%2)").arg(ctkPluginConstants::OBJECTCLASS).arg("org.commontk.eventadmin");</span></span><br><span class="line"><span class="function"><span class="title">context</span>-&gt;</span>connectServiceListener(&amp;listener, <span class="string">"onServiceEvent"</span>); <span class="comment">//, filter);</span></span><br></pre></td></tr></table></figure>
<p>具体实现参见项目：<a href="https://github.com/myhhub/CTK-project/tree/main/EventListener" target="_blank" rel="noopener">EventListener</a></p>
<h2 id="CTK-服务追踪"><a href="#CTK-服务追踪" class="headerlink" title="CTK 服务追踪"></a>CTK 服务追踪</h2><p>服务追踪：如果想在B插件里使用A服务，可以专门写一个类继承ctkServiceTracker，在这个类里完成对A服务的底层操作，然后在B插件里通过这个类提供的接口来使用回收A服务。</p>
<p>理论上ctkServiceTracker和A服务应该是一起的，这里有点像服务工厂。优点就是获取服务的代码简单，不用各种判断空指针。</p>
<h3 id="服务A"><a href="#服务A" class="headerlink" title="服务A"></a>服务A</h3><p><strong><em>服务A实现类</em></strong>，<strong>log_impl.cpp</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"log_impl.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line">LogImpl::LogImpl()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> LogImpl::debug(QString msg)</span><br><span class="line">&#123;</span><br><span class="line">    qDebug() &lt;&lt; <span class="string">"This is a debug message: "</span> &lt;&lt; msg;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>服务A激活类</em></strong>，<strong>log_activator.cpp</strong></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"log_impl.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"log_activator.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctkPluginContext.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtDebug&gt;</span></span></span><br><span class="line"></span><br><span class="line">void <span class="symbol">LogActivator::</span>start(ctkPluginContext* context)</span><br><span class="line">&#123;</span><br><span class="line">    m_pPlugin = new LogImpl();</span><br><span class="line">    context-&gt;registerService<span class="params">&lt;LogService&gt;</span>(m_pPlugin);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void <span class="symbol">LogActivator::</span>stop(ctkPluginContext* context)</span><br><span class="line">&#123;</span><br><span class="line">    Q_UNUSED(context)</span><br><span class="line"></span><br><span class="line">    delete m_pPlugin;</span><br><span class="line">    m_pPlugin = Q_NULLPTR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="服务A的服务追踪类"><a href="#服务A的服务追踪类" class="headerlink" title="服务A的服务追踪类"></a>服务A的服务追踪类</h3><p><strong><em>服务A的服务追踪类</em></strong></p>
<p>追踪类，建立时机：</p>
<p>1、可以在封装A服务的时候就建立，作为一种工具向外提供，但是不应该被编译进插件中，它并不是插件的功能而是访问插件的工具；</p>
<p>2、也可以在B插件中建立，完全和A服务独立开，作为访问A服务的一种手段；</p>
<p>3、单独建立一个空工程，为项目中的所有服务建立对应的追踪类，然后放在同一个文件夹中，其他想要的自己使用就行。</p>
<p>注意：B插件如果想要使用A服务，需要service_tracker.h、service_tracker.cpp、A服务的接口类。</p>
<p>本例采用第二种。</p>
<p><strong>service_tracker.h</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> SERVICE_TRACKER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SERVICE_TRACKER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctkPluginContext.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctkServiceTracker.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"../Log/log_service.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceTracker</span> :</span> <span class="keyword">public</span> ctkServiceTracker&lt;LogService *&gt;</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    ServiceTracker(ctkPluginContext* context) : ctkServiceTracker&lt;LogService *&gt;(context) &#123;&#125;</span><br><span class="line">    ~ServiceTracker() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">    <span class="comment">// 在 Service 注册时访问</span></span><br><span class="line">    <span class="function">LogService* <span class="title">addingService</span><span class="params">(<span class="keyword">const</span> ctkServiceReference&amp; reference)</span> Q_DECL_OVERRIDE </span>&#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"Adding service:"</span> &lt;&lt; reference.getPlugin()-&gt;getSymbolicName();</span><br><span class="line">        <span class="comment">// return ctkServiceTracker::addingService(reference);</span></span><br><span class="line"></span><br><span class="line">        LogService* service = (LogService*)(ctkServiceTracker::addingService(reference));</span><br><span class="line">        <span class="keyword">if</span> (service != Q_NULLPTR) &#123;</span><br><span class="line">            service-&gt;debug(<span class="string">"Ok"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">modifiedService</span><span class="params">(<span class="keyword">const</span> ctkServiceReference&amp; reference, LogService* service)</span> Q_DECL_OVERRIDE </span>&#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"Modified service:"</span> &lt;&lt; reference.getPlugin()-&gt;getSymbolicName();</span><br><span class="line">        ctkServiceTracker::modifiedService(reference, service);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">removedService</span><span class="params">(<span class="keyword">const</span> ctkServiceReference&amp; reference, LogService* service)</span> Q_DECL_OVERRIDE </span>&#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"Removed service:"</span> &lt;&lt; reference.getPlugin()-&gt;getSymbolicName();</span><br><span class="line">        ctkServiceTracker::removedService(reference, service);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// SERVICE_TRACKER_H</span></span></span><br></pre></td></tr></table></figure>
<h3 id="插件B"><a href="#插件B" class="headerlink" title="插件B"></a>插件B</h3><p><strong><em>插件B实现类</em></strong>, <strong>login_impl.cpp</strong></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include "login_impl.h"</span></span><br><span class="line"><span class="comment">#include "service_tracker.h"</span></span><br><span class="line"></span><br><span class="line">LoginImpl::LoginImpl(ServiceTracker *tracker)</span><br><span class="line">    : m_pTracker(tracker)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bool LoginImpl::login(const QString&amp; username, const QString&amp; password)</span><br><span class="line">&#123; </span><br><span class="line">    LogService*<span class="built_in"> service </span>= (LogService*)(m_pTracker-&gt;getService());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (QString::compare(username, <span class="string">"root"</span>) == 0 &amp;&amp; QString::compare(password, <span class="string">"123456"</span>) == 0) &#123;</span><br><span class="line">        <span class="keyword">if</span> (service != Q_NULLPTR)</span><br><span class="line">            service-&gt;<span class="builtin-name">debug</span>(<span class="string">"Login successfully"</span>);</span><br><span class="line">        return <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (service != Q_NULLPTR)</span><br><span class="line">            service-&gt;<span class="builtin-name">debug</span>(<span class="string">"Login failed"</span>);</span><br><span class="line">        return <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong><em>插件B激活类</em></strong>，<strong>login_activator.cpp</strong></p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"login_impl.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"login_activator.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"service_tracker.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> &lt;ctkPluginContext.h&gt;</span></span><br><span class="line"></span><br><span class="line">void LoginActivator::<span class="built_in">start</span>(ctkPluginContext* context)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 开启服务跟踪器</span></span><br><span class="line">    m_pTracker = <span class="keyword">new</span> <span class="built_in">ServiceTracker</span>(context);</span><br><span class="line">    m_pTracker-&gt;<span class="keyword">open</span>();</span><br><span class="line"></span><br><span class="line">    m_pPlugin = <span class="keyword">new</span> <span class="built_in">LoginImpl</span>(m_pTracker);</span><br><span class="line">    m_registration = context-&gt;registerService&lt;LoginService&gt;(m_pPlugin);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void LoginActivator::<span class="keyword">stop</span>(ctkPluginContext* context)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">Q_UNUSED</span>(context)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注销服务</span></span><br><span class="line">    m_registration.unregister();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 关闭服务跟踪器</span></span><br><span class="line">    m_pTracker-&gt;<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> m_pPlugin;</span><br><span class="line">    m_pPlugin = Q_NULLPTR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用插件B"><a href="#使用插件B" class="headerlink" title="使用插件B"></a>使用插件B</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取插件所在位置</span></span><br><span class="line">QString path = QCoreApplication::applicationDirPath() + <span class="string">"/plugins"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历路径下的所有插件</span></span><br><span class="line">QDirIterator itPlugin(path, QStringList() &lt;&lt; <span class="string">"*.dll"</span> &lt;&lt; <span class="string">"*.so"</span>, QDir::Files);</span><br><span class="line"><span class="keyword">while</span> (itPlugin.hasNext()) &#123;</span><br><span class="line">    QString strPlugin = itPlugin.next();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 安装插件</span></span><br><span class="line">        QSharedPointer&lt;ctkPlugin&gt; plugin = context-&gt;installPlugin(QUrl::fromLocalFile(strPlugin));</span><br><span class="line">        <span class="comment">// 启动插件</span></span><br><span class="line">        plugin-&gt;start(ctkPlugin::START_TRANSIENT);</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"Plugin start ..."</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">const</span> ctkPluginException &amp;e) &#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"Failed to install plugin"</span> &lt;&lt; e.what();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取服务引用</span></span><br><span class="line">ctkServiceReference reference = context-&gt;getServiceReference&lt;LoginService&gt;();</span><br><span class="line"><span class="keyword">if</span> (reference) &#123;</span><br><span class="line">    <span class="comment">// 获取指定 ctkServiceReference 引用的服务对象</span></span><br><span class="line">    LoginService* service = qobject_cast&lt;LoginService *&gt;(context-&gt;getService(reference));</span><br><span class="line">    <span class="keyword">if</span> (service != Q_NULLPTR) &#123;</span><br><span class="line">        <span class="comment">// 调用服务</span></span><br><span class="line">        service-&gt;login(<span class="string">"root"</span>, <span class="string">"123456"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体参见项目：<a href="https://github.com/myhhub/CTK-project/tree/main/ServiceTracker" target="_blank" rel="noopener">ServiceTracker</a></p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2021/03/100646.html" class="pre-post btn btn-default" title='Log4Qt使用教程(Log4j for C++ 构建系统日志)'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">Log4Qt使用教程(Log4j for C++ 构建系统日志)</span>
        </a>
    
    
        <a href="/archives/2021/03/100644.html" class="next-post btn btn-default" title='CTK框架使用简明教程'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">CTK框架使用简明教程</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#CTK介绍"><span class="toc-text">CTK介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CTK-Plugin-Framework"><span class="toc-text">CTK Plugin Framework</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CTK-Plugin-Framework-架构策略"><span class="toc-text">CTK Plugin Framework 架构策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CTK-Plugin-Framework-优点"><span class="toc-text">CTK Plugin Framework 优点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CTK编译"><span class="toc-text">CTK编译</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#使用-CTKWidgets"><span class="toc-text">使用 CTKWidgets</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#初步使用-CTK-Plugin-Framework"><span class="toc-text">初步使用 CTK Plugin Framework</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#项目结构"><span class="toc-text">项目结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目加载CTK框架插件"><span class="toc-text">项目加载CTK框架插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CTK插件的接口处理"><span class="toc-text">CTK插件的接口处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Activator注册器"><span class="toc-text">Activator注册器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#qrc文件"><span class="toc-text">qrc文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CTK插件启用"><span class="toc-text">CTK插件启用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#基本使用-CTK-Plugin-Framework"><span class="toc-text">基本使用 CTK Plugin Framework</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CTK插件间通信"><span class="toc-text">CTK插件间通信</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#通信方法一-注册接口调用"><span class="toc-text">通信方法一. 注册接口调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#注册接口调用"><span class="toc-text">注册接口调用</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#函数接口"><span class="toc-text">函数接口</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#接口的实现"><span class="toc-text">接口的实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#服务注册-Activator注册服务"><span class="toc-text">服务注册(Activator注册服务)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#接口调用"><span class="toc-text">接口调用</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#优化解耦-实现类和激活类分离"><span class="toc-text">优化解耦(实现类和激活类分离)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#接口、插件、服务的关系"><span class="toc-text">接口、插件、服务的关系</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通信方法二-事件监听"><span class="toc-text">通信方法二. 事件监听</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#事件监听"><span class="toc-text">事件监听</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#加载EventAdmin动态库"><span class="toc-text">加载EventAdmin动态库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#事件注册监听-接收插件"><span class="toc-text">事件注册监听(接收插件)</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#事件发送-发送插件"><span class="toc-text">事件发送(发送插件)</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#事件发送方式-类通信、信号槽通信"><span class="toc-text">事件发送方式(类通信、信号槽通信)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1、类通信"><span class="toc-text">1、类通信</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2、信号槽通信"><span class="toc-text">2、信号槽通信</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#二者的区别"><span class="toc-text">二者的区别</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#插件依赖"><span class="toc-text">插件依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#插件元数据"><span class="toc-text">插件元数据</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#高级使用-CTK-Plugin-Framework"><span class="toc-text">高级使用 CTK Plugin Framework</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CTK-服务工厂"><span class="toc-text">CTK 服务工厂</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#接口类"><span class="toc-text">接口类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#多实现类"><span class="toc-text">多实现类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务工厂类"><span class="toc-text">服务工厂类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#激活类"><span class="toc-text">激活类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#插件中访问服务"><span class="toc-text">插件中访问服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CTK-事件监听"><span class="toc-text">CTK 事件监听</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#框架事件"><span class="toc-text">框架事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务事件"><span class="toc-text">服务事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#插件事件"><span class="toc-text">插件事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#监听例子"><span class="toc-text">监听例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CTK-服务追踪"><span class="toc-text">CTK 服务追踪</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#服务A"><span class="toc-text">服务A</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#服务A的服务追踪类"><span class="toc-text">服务A的服务追踪类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#插件B"><span class="toc-text">插件B</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用插件B"><span class="toc-text">使用插件B</span></a></li></ol></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2023&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>