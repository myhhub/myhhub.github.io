<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="c++,cmake,qt">


    <meta name="description" content="本章的主要内容有：

创建一个简单的单元测试
使用Catch2库进行单元测试
使用Google Test库进行单元测试
使用Boost Test进行单元测试
使用动态分析来检测内存缺陷
预期测试...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>CMake 完整使用教程 之五 创建和运行测试 | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx">


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="CMake 完整使用教程 之五 创建和运行测试">
            
	            CMake 完整使用教程 之五 创建和运行测试
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/back/">后端</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/c/">c++</a> <a class="tag-link" href="/tags/cmake/">cmake</a> <a class="tag-link" href="/tags/qt/">qt</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2021/03/29</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>1204</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <p>本章的主要内容有：</p>
<ul>
<li>创建一个简单的单元测试</li>
<li>使用Catch2库进行单元测试</li>
<li>使用Google Test库进行单元测试</li>
<li>使用Boost Test进行单元测试</li>
<li>使用动态分析来检测内存缺陷</li>
<li>预期测试失败</li>
<li>使用超时测试运行时间过长的测试</li>
<li>并行测试</li>
<li>运行测试子集</li>
<li>使用测试固件</li>
</ul>
<p>测试代码是开发工具的核心组件。通过单元测试和集成测试自动化测试，不仅可以帮助开发人员尽早回归功能检测，还可以帮助开发人员参与，并了解项目。它可以帮助新开发人员向项目代码提交修改，并确保预期的功能性。对于验证安装是否保留了代码的功能时，自动化测试必不可少。从一开始对单元、模块或库进行测试，可以使用一种纯函数式的风格，将全局变量和全局状态最小化，可让开发者的具有更模块化、更简单的编程风格。</p>
<p>本章中，我们将演示如何使用流行的测试库和框架，将测试集成到CMake构建结构中，并谨记以下目标：</p>
<ul>
<li>让用户、开发人员和持续集成服务很容易地运行测试集。应该像使用<code>Unix Makefile</code>时，键入<code>make test</code>一样简单。</li>
<li>通过最小化测试时间，高效地运行测试，最大限度地提高运行测试的概率——理想情况下，每次代码修改都该如此。</li>
</ul>
<h1 id="4-1-创建一个简单的单元测试"><a href="#4-1-创建一个简单的单元测试" class="headerlink" title="4.1 创建一个简单的单元测试"></a>4.1 创建一个简单的单元测试</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-01" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-01</a> 中找到，包含一个C++的示例。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>CTest是CMake的测试工具，本示例中，我们将使用CTest进行单元测试。为了保持对CMake/CTest的关注，我们的测试代码会尽可能的简单。计划是编写和测试能够对整数求和的代码，示例代码只会对整数进行累加，不处理浮点数。就像年轻的卡尔•弗里德里希•高斯(Carl Friedrich Gauss)，被他的老师测试从1到100求和所有自然数一样，我们将要求代码做同样的事情。为了说明CMake没有对实际测试的语言进行任何限制，我们不仅使用C++可执行文件测试代码，还使用Python脚本和shell脚本作为测试代码。为了简单起见，我们将不使用任何测试库来实现，但是我们将在 后面的示例中介绍C++测试框架。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>代码示例由三个文件组成。实现源文件<code>sum_integs.cpp</code>对整数向量进行求和，并返回累加结果：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sum_integers.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum_integers</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; integers)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> sum = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span> i : integers) &#123;</span><br><span class="line">		sum += i;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个示例是否是优雅的实现并不重要，接口以<code>sum_integers</code>的形式导出。接口在<code>sum_integers.hpp</code>文件中声明，详情如下:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum_integers</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; integers)</span></span>;</span><br></pre></td></tr></table></figure>
<p>最后，main函数在<code>main.cpp</code>中定义，从<code>argv[]</code>中收集命令行参数，将它们转换成整数向量，调用<code>sum_integers</code>函数，并将结果打印到输出中:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sum_integers.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// we assume all arguments are integers and we sum them up</span></span><br><span class="line"><span class="comment">// for simplicity we do not verify the type of arguments</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; integers;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">1</span>; i &lt; argc; i++) &#123;</span><br><span class="line">		integers.push_back(<span class="built_in">std</span>::stoi(argv[i]));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">auto</span> sum = sum_integers(integers);</span><br><span class="line">  </span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; sum &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试这段代码使用C++实现(<code>test.cpp</code>)，Bash shell脚本实现(<code>test.sh</code>)和Python脚本实现(<code>test.py</code>)，只要实现可以返回一个零或非零值，从而CMake可以解释为成功或失败。</p>
<p>C++例子(<code>test.cpp</code>)中，我们通过调用<code>sum_integers</code>来验证1 + 2 + 3 + 4 + 5 = 15：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sum_integers.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> integers = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line">	</span><br><span class="line">  <span class="keyword">if</span> (sum_integers(integers) == <span class="number">15</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Bash shell脚本调用可执行文件：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line">EXECUTABLE=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line">OUTPUT=$(<span class="variable">$EXECUTABLE</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"$OUTPUT"</span> = <span class="string">"10"</span> ]</span><br><span class="line">then</span><br><span class="line">	<span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="keyword">exit</span> <span class="number">1</span></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<p>此外，Python脚本调用可执行文件(使用<code>--executable</code>命令行参数传递)，并使用<code>--short</code>命令行参数执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import subprocess</span><br><span class="line">import argparse</span><br><span class="line"></span><br><span class="line"><span class="comment"># test script expects the executable as argument</span></span><br><span class="line">parser = argparse.ArgumentParser()</span><br><span class="line">parser.add_argument('<span class="comment">--executable',</span></span><br><span class="line">										 <span class="keyword">help</span>=<span class="string">'full path to executable'</span>)</span><br><span class="line">parser.add_argument(<span class="string">'--short'</span>,</span><br><span class="line">										 <span class="keyword">default</span>=<span class="literal">False</span>,</span><br><span class="line">                    <span class="keyword">action</span>=<span class="string">'store_true'</span>,</span><br><span class="line">                    <span class="keyword">help</span>=<span class="string">'run a shorter test'</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> execute_cpp_code(integers):</span><br><span class="line">	<span class="keyword">result</span> = subprocess.check_output([args.executable] + integers)</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">int</span>(<span class="keyword">result</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args.short:</span><br><span class="line">	<span class="comment"># we collect [1, 2, ..., 100] as a list of strings</span></span><br><span class="line">	<span class="keyword">result</span> = execute_cpp_code([<span class="keyword">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(<span class="number">1</span>, <span class="number">101</span>)])</span><br><span class="line">	assert <span class="keyword">result</span> == <span class="number">5050</span>, <span class="string">'summing up to 100 failed'</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">	<span class="comment"># we collect [1, 2, ..., 1000] as a list of strings</span></span><br><span class="line">	<span class="keyword">result</span> = execute_cpp_code([<span class="keyword">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="keyword">range</span>(<span class="number">1</span>, <span class="number">1001</span>)])</span><br><span class="line">	assert <span class="keyword">result</span> == <span class="number">500500</span>, <span class="string">'summing up to 1000 failed'</span></span><br></pre></td></tr></table></figure>
<h2 id="具体实施"><a href="#具体实施" class="headerlink" title="具体实施"></a>具体实施</h2><p>现在，我们将逐步描述如何为项目设置测试：</p>
<ol>
<li><p>对于这个例子，我们需要C++11支持，可用的Python解释器，以及Bash shell:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">cmake_minimum_required</span><span class="params">(VERSION <span class="number">3.5</span> FATAL_ERROR)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">project</span><span class="params">(recipe-<span class="number">01</span> LANGUAGES CXX)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_STANDARD <span class="number">11</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_EXTENSIONS OFF)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_STANDARD_REQUIRED ON)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">find_package</span><span class="params">(PythonInterp REQUIRED)</span></span></span><br><span class="line"><span class="function"><span class="title">find_program</span><span class="params">(BASH_EXECUTABLE NAMES bash REQUIRED)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，定义库及主要可执行文件的依赖关系，以及测试可执行文件：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># example library</span><br><span class="line">add_library(<span class="name">sum_integers</span> sum_integers.cpp)</span><br><span class="line"></span><br><span class="line"># main code</span><br><span class="line">add_executable(<span class="name">sum_up</span> main.cpp)</span><br><span class="line">target_link_libraries(<span class="name">sum_up</span> sum_integers)</span><br><span class="line"></span><br><span class="line"># testing binary</span><br><span class="line">add_executable(<span class="name">cpp_test</span> test.cpp)</span><br><span class="line">target_link_libraries(<span class="name">cpp_test</span> sum_integers)</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，打开测试功能并定义四个测试。最后两个测试， 调用相同的Python脚本，先没有任何命令行参数，再使用<code>--short</code>：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enable_testing</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME bash_test</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;BASH_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>.sh $&lt;TARGET_FILE:sum_up&gt;</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME cpp_test</span><br><span class="line">  <span class="keyword">COMMAND</span> $&lt;TARGET_FILE:cpp_test&gt;</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME python_test_long</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>.py --executable $&lt;TARGET_FILE:sum_up&gt;</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME python_test_short</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>.py --short --executable $&lt;TARGET_FILE:sum_up&gt;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在，我们已经准备好配置和构建代码。先手动进行测试：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p build</span><br><span class="line">$ cd build</span><br><span class="line">$ cmake ..</span><br><span class="line">$ cmake --build .</span><br><span class="line">$ ./sum_up <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="number">15</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，我们可以用<code>ctest</code>运行测试集：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ ctest</span><br><span class="line"></span><br><span class="line">Test project /home/user/cmake-recipes/chapter-04/recipe-01/cxx-example/build</span><br><span class="line">Start 1: bash_test</span><br><span class="line">1/4 Test #1: bash_test <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.01 sec</span><br><span class="line">Start 2: cpp_test</span><br><span class="line">2/4 Test #2: cpp_test <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>. Passed 0.00 sec</span><br><span class="line">Start 3: python_test_long</span><br><span class="line">3/4 Test #3: python_test_long <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>. Passed 0.06 sec</span><br><span class="line">Start 4: python_test_short</span><br><span class="line">4/4 Test #4: python_test_short <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.05 sec</span><br><span class="line">100% tests passed, 0 tests failed out of 4</span><br><span class="line">Total Test time (real) = 0.12 sec</span><br></pre></td></tr></table></figure>
</li>
<li><p>还应该尝试中断实现，以验证测试集是否能捕捉到更改。</p>
</li>
</ol>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>这里的两个关键命令：</p>
<ul>
<li><code>enable_testing()</code>，测试这个目录和所有子文件夹(因为我们把它放在主<code>CMakeLists.txt</code>)。</li>
<li><code>add_test()</code>，定义了一个新的测试，并设置测试名称和运行命令。</li>
</ul>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add_test(</span><br><span class="line">  NAME cpp_test</span><br><span class="line">  COMMAND $&lt;TARGET_FILE<span class="symbol">:cpp_test&gt;</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>上面的例子中，使用了生成器表达式:<code>$&lt;TARGET_FILE:cpp_test&gt;</code>。生成器表达式，是在生成<strong>构建系统生成时</strong>的表达式。我们将在第5章第9节中详细地描述生成器表达式。此时，我们可以声明<code>$&lt;TARGET_FILE:cpp_test&gt;</code>变量，将使用<code>cpp_test</code>可执行目标的完整路径进行替换。</p>
<p>生成器表达式在测试时非常方便，因为不必显式地将可执行程序的位置和名称，可以硬编码到测试中。以一种可移植的方式实现这一点非常麻烦，因为可执行文件和可执行后缀(例如，Windows上是<code>.exe</code>后缀)的位置在不同的操作系统、构建类型和生成器之间可能有所不同。使用生成器表达式，我们不必显式地了解位置和名称。</p>
<p>也可以将参数传递给要运行的<code>test</code>命令，例如：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME python_test_short</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>.py --short --executable $&lt;TARGET_FILE:sum_up&gt;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>这个例子中，我们按顺序运行测试，并展示如何缩短总测试时间并行执行测试(第8节)，执行测试用例的子集(第9节)。这里，可以自定义测试命令，可以以任何编程语言运行测试集。CTest关心的是，通过命令的返回码测试用例是否通过。CTest遵循的标准约定是，返回零意味着成功，非零返回意味着失败。可以返回零或非零的脚本，都可以做测试用例。</p>
<p>既然知道了如何定义和执行测试，那么了解如何诊断测试失败也很重要。为此，我们可以在代码中引入一个bug，让所有测试都失败:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Start 1: bash_test</span><br><span class="line">1/4 Test #1: bash_test <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>**<span class="number">*Fa</span>iled 0.01 sec</span><br><span class="line">	Start 2: cpp_test</span><br><span class="line">2/4 Test #2: cpp_test <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.**<span class="number">*Fa</span>iled 0.00 sec</span><br><span class="line">	Start 3: python_test_long</span><br><span class="line">3/4 Test #3: python_test_long <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.**<span class="number">*Fa</span>iled 0.06 sec</span><br><span class="line">	Start 4: python_test_short</span><br><span class="line">4/4 Test #4: python_test_short <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>**<span class="number">*Fa</span>iled 0.06 sec</span><br><span class="line"></span><br><span class="line">0% tests passed, 4 tests failed out of 4</span><br><span class="line"></span><br><span class="line">Total Test time (real) = 0.13 sec</span><br><span class="line"></span><br><span class="line">The following tests FAILED:</span><br><span class="line">1 - bash_test (Failed)</span><br><span class="line">2 - cpp_test (Failed)</span><br><span class="line">3 - python_test_long (Failed)</span><br><span class="line">4 - python_test_short (Failed)</span><br><span class="line">Errors <span class="keyword">while</span> running CTest</span><br></pre></td></tr></table></figure>
<p>如果我们想了解更多，可以查看文件<code>test/Temporary/lasttestsfailure.log</code>。这个文件包含测试命令的完整输出，并且在分析阶段，要查看的第一个地方。使用以下CLI开关，可以从CTest获得更详细的测试输出：</p>
<ul>
<li><code>--output-on-failure</code>:将测试程序生成的任何内容打印到屏幕上，以免测试失败。</li>
<li><code>-v</code>:将启用测试的详细输出。</li>
<li><code>-vv</code>:启用更详细的输出。</li>
</ul>
<p>CTest提供了一个非常方快捷的方式，可以重新运行以前失败的测试；要使用的CLI开关是<code>--rerun-failed</code>，在调试期间非常有用。</p>
<h2 id="更多信息"><a href="#更多信息" class="headerlink" title="更多信息"></a>更多信息</h2><p>考虑以下定义:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME python_test_long</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>.py --executable $&lt;TARGET_FILE:sum_up&gt;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>前面的定义可以通过显式指定脚本运行的<code>WORKING_DIRECTORY</code>重新表达，如下:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME python_test_long</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="keyword">test</span>.py --executable $&lt;TARGET_FILE:sum_up&gt;</span><br><span class="line">  WORKING_DIRECTORY <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>测试名称可以包含<code>/</code>字符，按名称组织相关测试也很有用，例如：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME python/long</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="keyword">test</span>.py --executable $&lt;TARGET_FILE:sum_up&gt;</span><br><span class="line">  WORKING_DIRECTORY <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>有时候，我们需要为测试脚本设置环境变量。这可以通过<code>set_tests_properties</code>实现:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">set_tests_properties(python_test</span><br><span class="line">  PROPERTIES</span><br><span class="line">    ENVIRONMENT</span><br><span class="line">      <span class="attribute">ACCOUNT_MODULE_PATH</span>=<span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span></span><br><span class="line">      <span class="attribute">ACCOUNT_HEADER_FILE</span>=<span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/account/account.h</span><br><span class="line">      <span class="attribute">ACCOUNT_LIBRARY_FILE</span>=$&lt;TARGET_FILE:account&gt;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>这种方法在不同的平台上并不总可行，CMake提供了解决这个问题的方法。下面的代码片段与上面给出的代码片段相同，在执行实际的Python测试脚本之前，通过<code>CMAKE_COMMAND</code>调用CMake来预先设置环境变量:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">add_test(</span><br><span class="line">  NAME</span><br><span class="line">  	python_test</span><br><span class="line">  COMMAND</span><br><span class="line">    <span class="variable">$&#123;CMAKE_COMMAND&#125;</span> -E env</span><br><span class="line">    <span class="attribute">ACCOUNT_MODULE_PATH</span>=<span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span></span><br><span class="line">    <span class="attribute">ACCOUNT_HEADER_FILE</span>=<span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/account/account.h</span><br><span class="line">    <span class="attribute">ACCOUNT_LIBRARY_FILE</span>=$&lt;TARGET_FILE:account&gt;</span><br><span class="line">    <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span></span><br><span class="line">    <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/account/test.py</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>同样，要注意使用生成器表达式<code>$&lt;TARGET_FILE:account&gt;</code>来传递库文件的位置。</p>
<p>我们已经使用<code>ctest</code>命令执行测试，CMake还将为生成器创建目标(Unix Makefile生成器为<code>make test</code>，Ninja工具为<code>ninja test</code>，或者Visual Studio为<code>RUN_TESTS</code>)。这意味着，还有另一种(几乎)可移植的方法来运行测试：</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">$</span> <span class="comment">cmake</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">build</span> <span class="string">.</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">target</span> <span class="comment">test</span></span><br></pre></td></tr></table></figure>
<p>不幸的是，当使用Visual Studio生成器时，我们需要使用<code>RUN_TESTS</code>来代替:</p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">$</span> <span class="comment">cmake</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">build</span> <span class="string">.</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">target</span> <span class="comment">RUN_TESTS</span></span><br></pre></td></tr></table></figure>
<p><strong>NOTE</strong>:<em><code>ctest</code>提供了丰富的命令行参数。其中一些内容将在以后的示例中探讨。要获得完整的列表，需要使用<code>ctest --help</code>来查看。命令<code>cmake --help-manual ctest</code>会将向屏幕输出完整的ctest手册。</em></p>
<h1 id="4-2-使用Catch2库进行单元测试"><a href="#4-2-使用Catch2库进行单元测试" class="headerlink" title="4.2 使用Catch2库进行单元测试"></a>4.2 使用Catch2库进行单元测试</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-02" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-02</a> 中找到，包含一个C++的示例。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>前面的配置中，使用返回码来表示<code>test.cpp</code>测试的成功或失败。对于简单功能没问题，但是通常情况下，我们想要使用一个测试框架，它提供了相关基础设施来运行更复杂的测试，包括固定方式进行测试，与数值公差的比较，以及在测试失败时输出更好的错误报告。这里，我们用目前比较流行的测试库Catch2( <a href="https://github.com/catchorg/Catch2" target="_blank" rel="noopener">https://github.com/catchorg/Catch2</a> )来进行演示。这个测试框架有个很好的特性，它可以通过单个头库包含在项目中进行测试，这使得编译和更新框架特别容易。这个配置中，我们将CMake和Catch2结合使用，来测试上一个求和代码。</p>
<p>我们需要<code>catch.hpp</code>头文件，可以从 <a href="https://github.com/catchorg/Catch2" target="_blank" rel="noopener">https://github.com/catchorg/Catch2</a> (我们使用的是版本2.0.1)下载，并将它与<code>test.cpp</code>一起放在项目的根目录下。</p>
<h2 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h2><p><code>main.cpp</code>、<code>sum_integers.cpp</code>和<code>sum_integers.hpp</code>与之前的示例相同，但将更新<code>test.cpp</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sum_integers.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// this tells catch to provide a main()</span></span><br><span class="line"><span class="comment">// only do this in one cpp file</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CATCH_CONFIG_MAIN</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"catch.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line">TEST_CASE(<span class="string">"Sum of integers for a short vector"</span>, <span class="string">"[short]"</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">auto</span> integers = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line">  REQUIRE(sum_integers(integers) == <span class="number">15</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TEST_CASE(<span class="string">"Sum of integers for a longer vector"</span>, <span class="string">"[long]"</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">int</span>&gt; integers;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">1001</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    integers.push_back(i);</span><br><span class="line">  &#125;</span><br><span class="line">  REQUIRE(sum_integers(integers) == <span class="number">500500</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>catch.hpp</code>头文件可以从<a href="https://github.com/catchorg/Catch2" target="_blank" rel="noopener">https://github.com/catchorg/Catch2</a> (版本为2.0.1)下载，并将它与<code>test.cpp</code>放在项目的根目录中。</p>
<h2 id="具体实施-1"><a href="#具体实施-1" class="headerlink" title="具体实施"></a>具体实施</h2><p>使用Catch2库，需要修改之前的所使用<code>CMakeList.txt</code>：</p>
<ol>
<li><p>保持<code>CMakeLists.txt</code>大多数部分内容不变:</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">set</span> minimum <span class="comment">cmake version</span></span><br><span class="line">cmake_minimum_required(VERSION <span class="comment">3.5 FATAL_ERROR)</span></span><br><span class="line"></span><br><span class="line"># project <span class="comment">name and language</span></span><br><span class="line">project(recipe-02 LANGUAGES <span class="comment">CXX)</span></span><br><span class="line"></span><br><span class="line"># require <span class="comment">C++11</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="comment">11)</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_EXTENSIONS <span class="comment">OFF)</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD_REQUIRED <span class="comment">ON)</span></span><br><span class="line"></span><br><span class="line"># example <span class="comment">library</span></span><br><span class="line">add_library(sum_integers <span class="comment">sum_integers.cpp)</span></span><br><span class="line"></span><br><span class="line"># main <span class="comment">code</span></span><br><span class="line">add_executable(sum_up <span class="comment">main.cpp)</span></span><br><span class="line">target_link_libraries(sum_up <span class="comment">sum_integers)</span></span><br><span class="line"></span><br><span class="line"># testing <span class="comment">binary</span></span><br><span class="line">add_executable(cpp_test <span class="comment">test.cpp)</span></span><br><span class="line">target_link_libraries(cpp_test <span class="comment">sum_integers)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>对于上一个示例的配置，需要保留一个测试，并重命名它。注意，<code>--success</code>选项可传递给单元测试的可执行文件。这是一个Catch2选项，测试成功时，也会有输出:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">enable_testing()</span><br><span class="line"></span><br><span class="line">add_test(</span><br><span class="line">  NAME catch_test</span><br><span class="line">  COMMAND $&lt;TARGET_FILE<span class="symbol">:cpp_test&gt;</span> --success</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>就是这样！让我们来配置、构建和测试。CTest中，使用<code>-V</code>选项运行测试，以获得单元测试可执行文件的输出:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p build</span><br><span class="line">$ cd build</span><br><span class="line">$ cmake <span class="built_in">..</span></span><br><span class="line">$ cmake --build .</span><br><span class="line">$ ctest -V</span><br><span class="line"></span><br><span class="line">UpdateCTestConfiguration <span class="keyword">from</span> :/home/user/cmake-cookbook/chapter-04/recipe-02/cxx-example/build/DartConfiguration.tcl</span><br><span class="line">UpdateCTestConfiguration <span class="keyword">from</span> :/home/user/cmake-cookbook/chapter-04/recipe-02/cxx-example/build/DartConfiguration.tcl</span><br><span class="line">Test project /home/user/cmake-cookbook/chapter-04/recipe-02/cxx-example/build</span><br><span class="line">Constructing a list of tests</span><br><span class="line">Done constructing a list of tests</span><br><span class="line">Updating test list <span class="keyword">for</span> fixtures</span><br><span class="line">Added 0 tests <span class="keyword">to</span> meet fixture requirements</span><br><span class="line">Checking test dependency graph<span class="built_in">..</span>.</span><br><span class="line">Checking test dependency graph end</span><br><span class="line">test 1</span><br><span class="line">Start 1: catch_test</span><br><span class="line">1: Test command: /home/user/cmake-cookbook/chapter-04/recipe-02/cxx-example/build/cpp_test <span class="string">"--success"</span></span><br><span class="line">1: Test timeout computed <span class="keyword">to</span> be: 10000000</span><br><span class="line">1:</span><br><span class="line">1: ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">1: cpp_test is a Catch v2.0.1 host application.</span><br><span class="line">1: <span class="builtin-name">Run</span> with -? <span class="keyword">for</span> options</span><br><span class="line">1:</span><br><span class="line">1: ----------------------------------------------------------------</span><br><span class="line">1: Sum of integers <span class="keyword">for</span> a short vector</span><br><span class="line">1: ----------------------------------------------------------------</span><br><span class="line">1: /home/user/cmake-cookbook/chapter-04/recipe-02/cxx-example/test.cpp:10</span><br><span class="line">1: <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line">1:</span><br><span class="line">1: /home/user/cmake-cookbook/chapter-04/recipe-02/cxx-example/test.cpp:12:</span><br><span class="line">1: PASSED:</span><br><span class="line">1: REQUIRE( sum_integers(integers) == 15 )</span><br><span class="line">1: with expansion:</span><br><span class="line">1: 15 == 15</span><br><span class="line">1:</span><br><span class="line">1: ----------------------------------------------------------------</span><br><span class="line">1: Sum of integers <span class="keyword">for</span> a longer vector</span><br><span class="line">1: ----------------------------------------------------------------</span><br><span class="line">1: /home/user/cmake-cookbook/chapter-04/recipe-02/cxx-example/test.cpp:15</span><br><span class="line">1: <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line">1:</span><br><span class="line">1: /home/user/cmake-cookbook/chapter-04/recipe-02/cxx-example/test.cpp:20:</span><br><span class="line">1: PASSED:</span><br><span class="line">1: REQUIRE( sum_integers(integers) == 500500 )</span><br><span class="line">1: with expansion:</span><br><span class="line">1: 500500 (0x7a314) == 500500 (0x7a314)</span><br><span class="line">1:</span><br><span class="line">1: ===================================================================</span><br><span class="line">1: All tests passed (2 assertions <span class="keyword">in</span> 2 test cases)</span><br><span class="line">1:</span><br><span class="line">1/1 Test #1: catch_test <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>. Passed 0.00 s</span><br><span class="line"></span><br><span class="line">100% tests passed, 0 tests failed out of 1</span><br><span class="line"></span><br><span class="line">Total Test time (real) = 0.00 se</span><br></pre></td></tr></table></figure>
</li>
<li><p>我们也可以测试<code>cpp_test</code>的二进制文件，可以直接从Catch2中看到输出:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ ./cpp_test --success</span><br><span class="line"></span><br><span class="line">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">cpp_test is a Catch v2.0.1 host application.</span><br><span class="line"><span class="builtin-name">Run</span> with -? <span class="keyword">for</span> options</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">Sum of integers <span class="keyword">for</span> a short vector</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">/home/user/cmake-cookbook/chapter-04/recipe-02/cxx-example/test.cpp:10</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line">/home/user/cmake-cookbook/chapter-04/recipe-02/cxx-example/test.cpp:12:</span><br><span class="line">PASSED:</span><br><span class="line">REQUIRE( sum_integers(integers) == 15 )</span><br><span class="line">with expansion:</span><br><span class="line">15 == 15</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">Sum of integers <span class="keyword">for</span> a longer vector</span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">/home/user/cmake-cookbook/chapter-04/recipe-02/cxx-example/test.cpp:15</span><br><span class="line"><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>.</span><br><span class="line">/home/user/cmake-cookbook/chapter-04/recipe-02/cxx-example/test.cpp:20:</span><br><span class="line">PASSED:</span><br><span class="line">REQUIRE( sum_integers(integers) == 500500 )</span><br><span class="line">with expansion:</span><br><span class="line">500500 (0x7a314) == 500500 (0x7a314)</span><br><span class="line">===================================================================</span><br><span class="line">All tests passed (2 assertions <span class="keyword">in</span> 2 test cases)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Catch2将生成一个可执行文件，还可以尝试执行以下命令，以探索单元测试框架提供的选项:</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="string">./cpp_test</span> <span class="params">--help</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-1"><a href="#工作原理-1" class="headerlink" title="工作原理"></a>工作原理</h2><p>Catch2是一个单头文件测试框架，所以不需要定义和构建额外的目标。只需要确保CMake能找到<code>catch.hpp</code>，从而构建<code>test.cpp</code>即可。为了方便起见，将它放在与<code>test.cpp</code>相同的目录中，我们可以选择一个不同的位置，并使用<code>target_include_directory</code>指示该位置。另一种方法是将头部封装到接口库中，这可以在Catch2文档中说明( <a href="https://github.com/catchorg/catch2/blob/maste/docs/build.systems.md#cmake" target="_blank" rel="noopener">https://github.com/catchorg/catch2/blob/maste/docs/build.systems.md#cmake</a> ):</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Prepare "Catch" library for other executables </span></span><br><span class="line"><span class="builtin-name">set</span>(CATCH_INCLUDE_DIR</span><br><span class="line"><span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/catch) </span><br><span class="line"></span><br><span class="line">add_library(Catch</span><br><span class="line">INTERFACE) </span><br><span class="line"></span><br><span class="line">target_include_directories(Catch INTERFACE</span><br><span class="line"><span class="variable">$&#123;CATCH_INCLUDE_DIR&#125;</span>)</span><br></pre></td></tr></table></figure>
<p>然后，我们对库进行如下链接:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">target_link_libraries</span><span class="params">(cpp_test Catch)</span></span></span><br></pre></td></tr></table></figure>
<p>回想一下第3中的讨论，在第1章从简单的可执行库到接口库，是CMake提供的伪目标库，这些伪目标库对于指定项目外部目标的需求非常有用。</p>
<h2 id="更多信息-1"><a href="#更多信息-1" class="headerlink" title="更多信息"></a>更多信息</h2><p>这是一个简单的例子，主要关注CMake。当然，Catch2提供了更多功能。有关Catch2框架的完整文档，可访问 <a href="https://github.com/catchorg/Catch2" target="_blank" rel="noopener">https://github.com/catchorg/Catch2</a> 。</p>
<p>Catch2代码库包含有CMake函数，用于解析Catch测试并自动创建CMake测试，不需要显式地输入<code>add_test()</code>函数，可见 <a href="https://github.com/catchorg/Catch2/blob/master/contrib/ParseAndAddCatchTests.cmake" target="_blank" rel="noopener">https://github.com/catchorg/Catch2/blob/master/contrib/ParseAndAddCatchTests.cmake</a> 。</p>
<h1 id="4-3-使用Google-Test库进行单元测试"><a href="#4-3-使用Google-Test库进行单元测试" class="headerlink" title="4.3 使用Google Test库进行单元测试"></a>4.3 使用Google Test库进行单元测试</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-03" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-03</a> 中找到，包含一个C++的示例。该示例在CMake 3.11版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。在代码库中，有一个支持CMake 3.5的例子。</em></p>
<p>本示例中，我们将演示如何在CMake的帮助下使用Google Test框架实现单元测试。与前一个配置相比，Google Test框架不仅仅是一个头文件，也是一个库，包含两个需要构建和链接的文件。可以将它们与我们的代码项目放在一起，但是为了使代码项目更加轻量级，我们将选择在配置时，下载一个定义良好的Google Test，然后构建框架并链接它。我们将使用较新的<code>FetchContent</code>模块(从CMake版本3.11开始可用)。第8章中会继续讨论<code>FetchContent</code>，在这里将讨论模块在底层是如何工作的，并且还将演示如何使用<code>ExternalProject_Add</code>进行模拟。此示例的灵感来自(改编自) <a href="https://cmake.org/cmake/help/v3.11/module/FetchContent.html" target="_blank" rel="noopener">https://cmake.org/cmake/help/v3.11/module/FetchContent.html</a> 示例。</p>
<h2 id="准备工作-2"><a href="#准备工作-2" class="headerlink" title="准备工作"></a>准备工作</h2><p><code>main.cpp</code>、<code>sum_integers.cpp</code>和<code>sum_integers.hpp</code>与之前相同，修改<code>test.cpp</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sum_integers.hpp"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"gtest/gtest.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">  ::testing::InitGoogleTest(&amp;argc, argv);</span><br><span class="line">  <span class="keyword">return</span> RUN_ALL_TESTS();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TEST(example, sum_zero) &#123;</span><br><span class="line">  <span class="keyword">auto</span> integers = &#123;<span class="number">1</span>, <span class="number">-1</span>, <span class="number">2</span>, <span class="number">-2</span>, <span class="number">3</span>, <span class="number">-3</span>&#125;;</span><br><span class="line">  <span class="keyword">auto</span> result = sum_integers(integers);</span><br><span class="line">  ASSERT_EQ(result, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TEST(example, sum_five) &#123;</span><br><span class="line">  <span class="keyword">auto</span> integers = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line">  <span class="keyword">auto</span> result = sum_integers(integers);</span><br><span class="line">  ASSERT_EQ(result, <span class="number">15</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上面的代码所示，我们显式地将<code>gtest.h</code>，而不将其他Google Test源放在代码项目存储库中，会在配置时使用<code>FetchContent</code>模块下载它们。</p>
<h2 id="具体实施-2"><a href="#具体实施-2" class="headerlink" title="具体实施"></a>具体实施</h2><p>下面的步骤描述了如何设置<code>CMakeLists.txt</code>，使用GTest编译可执行文件及其相应的测试:</p>
<ol>
<li><p>与前两个示例相比，<code>CMakeLists.txt</code>的开头基本没有变化，CMake 3.11才能使用<code>FetchContent</code>模块:</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">set</span> minimum <span class="comment">cmake version</span></span><br><span class="line">cmake_minimum_required(VERSION <span class="comment">3.11 FATAL_ERROR)</span></span><br><span class="line"></span><br><span class="line"># project <span class="comment">name and language</span></span><br><span class="line">project(recipe-03 LANGUAGES <span class="comment">CXX)</span></span><br><span class="line"></span><br><span class="line"># require <span class="comment">C++11</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="comment">11)</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_EXTENSIONS <span class="comment">OFF)</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD_REQUIRED <span class="comment">ON)</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_WINDOWS_EXPORT_ALL_SYMBOLS <span class="comment">ON)</span></span><br><span class="line"></span><br><span class="line"># example <span class="comment">library</span></span><br><span class="line">add_library(sum_integers <span class="comment">sum_integers.cpp)</span></span><br><span class="line"></span><br><span class="line"># main <span class="comment">code</span></span><br><span class="line">add_executable(sum_up <span class="comment">main.cpp)</span></span><br><span class="line">target_link_libraries(sum_up <span class="comment">sum_integers)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>然后引入一个<code>if</code>，检查<code>ENABLE_UNIT_TESTS</code>。默认情况下，它为<code>ON</code>，但有时需要设置为<code>OFF</code>，以免在没有网络连接时，也能使用Google Test:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">option</span>(ENABLE_UNIT_TESTS <span class="string">"Enable unit tests"</span> <span class="keyword">ON</span>)</span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">"Enable testing: $&#123;ENABLE_UNIT_TESTS&#125;"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(ENABLE_UNIT_TESTS)</span><br><span class="line">	<span class="comment"># all the remaining CMake code will be placed here</span></span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>if</code>内部包含<code>FetchContent</code>模块，声明要获取的新内容，并查询其属性:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">include(<span class="name">FetchContent</span>)</span><br><span class="line"></span><br><span class="line">FetchContent_Declare(</span><br><span class="line">  googletest</span><br><span class="line">  GIT_REPOSITORY https<span class="symbol">://github</span>.com/google/googletest.git</span><br><span class="line">  GIT_TAG release-1.<span class="number">8.0</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">FetchContent_GetProperties(<span class="name">googletest</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果内容还没有获取到，将尝试获取并配置它。这需要添加几个可以链接的目标。本例中，我们对<code>gtest_main</code>感兴趣。该示例还包含一些变通方法，用于使用在Visual Studio下的编译:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">NOT</span> googletest_POPULATED)</span><br><span class="line">  FetchContent_Populate(googletest)</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Prevent GoogleTest from overriding our compiler/linker options</span></span><br><span class="line">  <span class="comment"># when building with Visual Studio</span></span><br><span class="line">  <span class="keyword">set</span>(gtest_force_shared_crt <span class="keyword">ON</span> CACHE BOOL <span class="string">""</span> FORCE)</span><br><span class="line">  <span class="comment"># Prevent GoogleTest from using PThreads</span></span><br><span class="line">  <span class="keyword">set</span>(gtest_disable_pthreads <span class="keyword">ON</span> CACHE BOOL <span class="string">""</span> FORCE)</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># adds the targers: gtest, gtest_main, gmock, gmock_main</span></span><br><span class="line">  <span class="keyword">add_subdirectory</span>(</span><br><span class="line">    <span class="variable">$&#123;googletest_SOURCE_DIR&#125;</span></span><br><span class="line">    <span class="variable">$&#123;googletest_BINARY_DIR&#125;</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">  <span class="comment"># Silence std::tr1 warning on MSVC</span></span><br><span class="line">  <span class="keyword">if</span>(MSVC)</span><br><span class="line">    <span class="keyword">foreach</span>(_tgt gtest gtest_main gmock gmock_main)</span><br><span class="line">      <span class="keyword">target_compile_definitions</span>(<span class="variable">$&#123;_tgt&#125;</span></span><br><span class="line">        PRIVATE</span><br><span class="line">        	<span class="string">"_SILENCE_TR1_NAMESPACE_DEPRECATION_WARNING"</span></span><br><span class="line">      )</span><br><span class="line">    <span class="keyword">endforeach</span>()</span><br><span class="line">  <span class="keyword">endif</span>()</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，使用<code>target_sources</code>和<code>target_link_libraries</code>命令，定义<code>cpp_test</code>可执行目标并指定它的源文件:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">add_executable(<span class="name">cpp_test</span> <span class="string">""</span>)</span><br><span class="line"></span><br><span class="line">target_sources(<span class="name">cpp_test</span></span><br><span class="line">  PRIVATE</span><br><span class="line">  	test.cpp</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">target_link_libraries(<span class="name">cpp_test</span></span><br><span class="line">  PRIVATE</span><br><span class="line">    sum_integers</span><br><span class="line">    gtest_main</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，使用<code>enable_test</code>和<code>add_test</code>命令来定义单元测试:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">enable_testing()</span><br><span class="line"></span><br><span class="line">add_test(</span><br><span class="line">  NAME google_test</span><br><span class="line">  COMMAND $&lt;TARGET_FILE<span class="symbol">:cpp_test&gt;</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在，准备配置、构建和测试项目:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p build</span><br><span class="line">$ cd build</span><br><span class="line">$ cmake <span class="built_in">..</span></span><br><span class="line">$ cmake --build .</span><br><span class="line">$ ctest</span><br><span class="line"></span><br><span class="line">Test project /home/user/cmake-cookbook/chapter-04/recipe-03/cxx-example/build</span><br><span class="line">	Start 1: google_test</span><br><span class="line">1/1 Test #1: google_test <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.00 sec</span><br><span class="line"></span><br><span class="line">100% tests passed, 0 tests failed out of 1</span><br><span class="line"></span><br><span class="line">Total Test time (real) = 0.00 sec</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以直接运行<code>cpp_test</code>:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ./cpp_test</span><br><span class="line"></span><br><span class="line">[<span class="meta">==========</span>] Running <span class="number">2</span> tests <span class="keyword">from</span> <span class="number">1</span> test <span class="keyword">case</span>.</span><br><span class="line">[<span class="meta">----------</span>] Global test environment <span class="keyword">set</span>-up.</span><br><span class="line">[<span class="meta">----------</span>] <span class="number">2</span> tests <span class="keyword">from</span> example</span><br><span class="line">[<span class="meta"> RUN </span>] example.sum_zero</span><br><span class="line">[<span class="meta"> OK </span>] example.sum_zero (<span class="number">0</span> ms)</span><br><span class="line">[<span class="meta"> RUN </span>] example.sum_five</span><br><span class="line">[<span class="meta"> OK </span>] example.sum_five (<span class="number">0</span> ms)</span><br><span class="line">[<span class="meta">----------</span>] <span class="number">2</span> <span class="function">tests <span class="keyword">from</span> <span class="title">example</span> (<span class="params"><span class="number">0</span> ms total</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">[----------] Global test environment tear-down</span></span><br><span class="line"><span class="function">[</span>==========] <span class="number">2</span> tests <span class="keyword">from</span> <span class="number">1</span> test <span class="keyword">case</span> ran. (<span class="number">0</span> ms total)</span><br><span class="line">[<span class="meta"> PASSED </span>] <span class="number">2</span> tests.</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-2"><a href="#工作原理-2" class="headerlink" title="工作原理"></a>工作原理</h2><p><code>FetchContent</code>模块支持通过<code>ExternalProject</code>模块，在配置时填充内容，并在其3.11版本中成为CMake的标准部分。而<code>ExternalProject_Add()</code>在构建时(见第8章)进行下载操作，这样<code>FetchContent</code>模块使得构建可以立即进行，这样获取的主要项目和外部项目(在本例中为Google Test)仅在第一次执行CMake时调用，使用<code>add_subdirectory</code>可以嵌套。</p>
<p>为了获取Google Test，首先声明外部内容:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">include(<span class="name">FetchContent</span>)</span><br><span class="line"></span><br><span class="line">FetchContent_Declare(</span><br><span class="line">	googletest</span><br><span class="line">  GIT_REPOSITORY https<span class="symbol">://github</span>.com/google/googletest.git</span><br><span class="line">  GIT_TAG release-1.<span class="number">8.0</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>本例中，我们获取了一个带有特定标记的Git库(release-1.8.0)，但是我们也可以从Subversion、Mercurial或HTTP(S)源获取一个外部项目。有关可用选项，可参考相应的<code>ExternalProject_Add</code>命令的选项，网址是<a href="https://cmake.org/cmake/help/v3.11/module/ExternalProject.html" target="_blank" rel="noopener">https://cmake.org/cmake/help/v3.11/module/ExternalProject.html</a> 。</p>
<p>调用<code>FetchContent_Populate()</code>之前，检查是否已经使用<code>FetchContent_GetProperties()</code>命令处理了内容填充；否则，调用<code>FetchContent_Populate()</code>超过一次后，就会抛出错误。</p>
<p><code>FetchContent_Populate(googletest)</code>用于填充源并定义<code>googletest_SOURCE_DIR</code>和<code>googletest_BINARY_DIR</code>，可以使用它们来处理Google Test项目(使用<code>add_subdirectory()</code>，因为它恰好也是一个CMake项目):</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_subdirectory</span>(</span><br><span class="line">  <span class="variable">$&#123;googletest_SOURCE_DIR&#125;</span></span><br><span class="line">  <span class="variable">$&#123;googletest_BINARY_DIR&#125;</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>前面定义了以下目标：<code>gtest</code>、<code>gtest_main</code>、<code>gmock</code>和<code>gmock_main</code>。这个配置中，作为单元测试示例的库依赖项，我们只对<code>gtest_main</code>目标感兴趣：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">target_link_libraries(<span class="name">cpp_test</span></span><br><span class="line">  PRIVATE</span><br><span class="line">    sum_integers</span><br><span class="line">    gtest_main</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>构建代码时，可以看到如何正确地对Google Test进行配置和构建。有时，我们希望升级到更新的Google Test版本，这时需要更改的唯一一行就是详细说明<code>GIT_TAG</code>的那一行。</p>
<h2 id="更多信息-2"><a href="#更多信息-2" class="headerlink" title="更多信息"></a>更多信息</h2><p>了解了<code>FetchContent</code>及其构建时的近亲<code>ExternalProject_Add</code>，我们将在第8章中重新讨论这些命令。有关可用选项的详细讨论，可参考<a href="https://cmake.org/cmake/help/v3.11/module/FetchContent.html" target="_blank" rel="noopener">https://cmake.org/cmake/help/v3.11/module/FetchContent.html</a> 。</p>
<p>本示例中，我们在配置时获取源代码，也可以将它们安装在系统环境中，并使用<code>FindGTest</code>模块来检测库和头文件(<a href="https://cmake.org/cmake/help/v3.5/module/FindTest.html" target="_blank" rel="noopener">https://cmake.org/cmake/help/v3.5/module/FindTest.html</a> )。从3.9版开始，CMake还提供了一个Google Test模块(<a href="https://cmake.org/cmake/help/v3.9/module/GoogleTest.html" target="_blank" rel="noopener">https://cmake.org/cmake/help/v3.9/module/GoogleTest.html</a> )，它提供了一个<code>gtest_add_tests</code>函数。通过搜索Google Test宏的源代码，可以使用此函数自动添加测试。</p>
<p>当然，Google Test有许多有趣的的特性，可在 <a href="https://github.com/google/googletest" target="_blank" rel="noopener">https://github.com/google/googletest</a> 查看。</p>
<h1 id="4-4-使用Boost-Test进行单元测试"><a href="#4-4-使用Boost-Test进行单元测试" class="headerlink" title="4.4 使用Boost Test进行单元测试"></a>4.4 使用Boost Test进行单元测试</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-04" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-04</a> 中找到，包含一个C++的示例。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>Boost Test是在C++社区中，一个非常流行的单元测试框架。本例中，我们将演示如何使用Boost Test，对求和示例代码进行单元测试。</p>
<h2 id="准备工作-3"><a href="#准备工作-3" class="headerlink" title="准备工作"></a>准备工作</h2><p><code>main.cpp</code>、<code>sum_integers.cpp</code>和<code>sum_integers.hpp</code>与之前的示例相同，将更新<code>test.cpp</code>作为使用Boost Test库进行的单元测试：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="string">"sum_integers.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BOOST_TEST_MODULE example_test_suite</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/test/unit_test.hpp&gt;</span></span></span><br><span class="line">BOOST_AUTO_TEST_CASE(add_example)</span><br><span class="line">&#123;</span><br><span class="line">  auto integers = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125;;</span><br><span class="line">  auto result = sum_integers(integers);</span><br><span class="line">  BOOST_REQUIRE(result == <span class="number">15</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="具体实施-3"><a href="#具体实施-3" class="headerlink" title="具体实施"></a>具体实施</h2><p>以下是使用Boost Test构建项目的步骤:</p>
<ol>
<li><p>先从<code>CMakeLists.txt</code>开始:</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">set</span> minimum <span class="comment">cmake version</span></span><br><span class="line">cmake_minimum_required(VERSION <span class="comment">3.5 FATAL_ERROR)</span></span><br><span class="line"></span><br><span class="line"># project <span class="comment">name and language</span></span><br><span class="line">project(recipe-04 LANGUAGES <span class="comment">CXX)</span></span><br><span class="line"></span><br><span class="line"># require <span class="comment">C++11</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="comment">11)</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_EXTENSIONS <span class="comment">OFF)</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD_REQUIRED <span class="comment">ON)</span></span><br><span class="line"></span><br><span class="line"># example <span class="comment">library</span></span><br><span class="line">add_library(sum_integers <span class="comment">sum_integers.cpp)</span></span><br><span class="line"></span><br><span class="line"># main <span class="comment">code</span></span><br><span class="line">add_executable(sum_up <span class="comment">main.cpp)</span></span><br><span class="line">target_link_libraries(sum_up <span class="comment">sum_integers)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>检测Boost库并将<code>cpp_test</code>链接到它:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(Boost <span class="number">1.54</span> REQUIRED COMPONENTS unit_test_framework)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(cpp_test <span class="keyword">test</span>.cpp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(cpp_test</span><br><span class="line">  PRIVATE</span><br><span class="line">    sum_integers</span><br><span class="line">    Boost::unit_test_framework</span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line"><span class="comment"># avoid undefined reference to "main" in test.cpp</span></span><br><span class="line"><span class="keyword">target_compile_definitions</span>(cpp_test</span><br><span class="line">  PRIVATE</span><br><span class="line">  	BOOST_TEST_DYN_LINK</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，定义单元测试:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">enable_testing()</span><br><span class="line"></span><br><span class="line">add_test(</span><br><span class="line">  NAME boost_test</span><br><span class="line">  COMMAND $&lt;TARGET_FILE<span class="symbol">:cpp_test&gt;</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>下面是需要配置、构建和测试代码的所有内容:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p build</span><br><span class="line">$ cd build</span><br><span class="line">$ cmake <span class="built_in">..</span></span><br><span class="line">$ cmake --build .</span><br><span class="line">$ ctest</span><br><span class="line"></span><br><span class="line">Test project /home/user/cmake-recipes/chapter-04/recipe-04/cxx-example/build</span><br><span class="line">Start 1: boost_test</span><br><span class="line">1/1 Test #1: boost_test <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>. Passed 0.01 sec</span><br><span class="line">100% tests passed, 0 tests failed out of 1</span><br><span class="line">Total Test time (real) = 0.01 sec</span><br><span class="line"></span><br><span class="line">$ ./cpp_test</span><br><span class="line"></span><br><span class="line">Running 1 test case<span class="built_in">..</span>.</span><br><span class="line">*** <span class="literal">No</span> errors detected</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-3"><a href="#工作原理-3" class="headerlink" title="工作原理"></a>工作原理</h2><p>使用<code>find_package</code>来检测Boost的<code>unit_test_framework</code>组件(参见第3章，第8节)。我们认为这个组件是<code>REQUIRED</code>的，如果在系统环境中找不到它，配置将停止。<code>cpp_test</code>目标需要知道在哪里可以找到Boost头文件，并且需要链接到相应的库；它们都由<code>IMPORTED</code>库目标<code>Boost::unit_test_framework</code>提供，该目标由<code>find_package</code>设置。</p>
<h2 id="更多信息-3"><a href="#更多信息-3" class="headerlink" title="更多信息"></a>更多信息</h2><p>本示例中，我们假设系统上安装了Boost。或者，我们可以在编译时获取并构建Boost依赖项。然而，Boost不是轻量级依赖项。我们的示例代码中，我们只使用了最基本的设施，但是Boost提供了丰富的特性和选项，有感兴趣的读者可以去这里看看：<a href="http://www.boost.org/doc/libs/1_65_1/libs/test/doc/html/index.html" target="_blank" rel="noopener">http://www.boost.org/doc/libs/1_65_1/libs/test/doc/html/index.html</a> 。</p>
<h1 id="4-5-使用动态分析来检测内存缺陷"><a href="#4-5-使用动态分析来检测内存缺陷" class="headerlink" title="4.5 使用动态分析来检测内存缺陷"></a>4.5 使用动态分析来检测内存缺陷</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-05" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-05</a> 中找到，包含一个C++的示例。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>内存缺陷：写入或读取越界，或者内存泄漏(已分配但从未释放的内存)，会产生难以跟踪的bug，最好尽早将它们检查出来。Valgrind( <a href="http://valgrind.org/" target="_blank" rel="noopener">http://valgrind.org</a> )是一个通用的工具，用来检测内存缺陷和内存泄漏。本节中，我们将在使用CMake/CTest测试时使用Valgrind对内存问题进行警告。</p>
<h2 id="准备工作-4"><a href="#准备工作-4" class="headerlink" title="准备工作"></a>准备工作</h2><p>对于这个配置，需要三个文件。第一个是测试的实现(我们可以调用文件<code>leaky_implementation.cpp</code>):</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"leaky_implementation.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_some_work</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// we allocate an array</span></span><br><span class="line">  <span class="keyword">double</span> *my_array = <span class="keyword">new</span> <span class="keyword">double</span>[<span class="number">1000</span>];</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// do some work</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// we forget to deallocate it</span></span><br><span class="line">  <span class="comment">// delete[] my_array;</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还需要相应的头文件(<code>leaky_implementation.hpp</code>):</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_some_work</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>并且，需要测试文件(<code>test.cpp</code>):</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"leaky_implementation.hpp"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> return_code = do_some_work();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> return_code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们希望测试通过，因为<code>return_code</code>硬编码为<code>0</code>。这里我们也期望检测到内存泄漏，因为<code>my_array</code>没有释放。</p>
<h2 id="具体实施-4"><a href="#具体实施-4" class="headerlink" title="具体实施"></a>具体实施</h2><p>下面展示了如何设置CMakeLists.txt来执行代码动态分析:</p>
<ol>
<li><p>我们首先定义CMake最低版本、项目名称、语言、目标和依赖关系:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">cmake_minimum_required</span><span class="params">(VERSION <span class="number">3.5</span> FATAL_ERROR)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">project</span><span class="params">(recipe-<span class="number">05</span> LANGUAGES CXX)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_STANDARD <span class="number">11</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_EXTENSIONS OFF)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_STANDARD_REQUIRED ON)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">add_library</span><span class="params">(example_library leaky_implementation.cpp)</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">add_executable</span><span class="params">(cpp_test test.cpp)</span></span></span><br><span class="line"><span class="function"><span class="title">target_link_libraries</span><span class="params">(cpp_test example_library)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，定义测试目标，还定义了<code>MEMORYCHECK_COMMAND</code>:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">find_program(<span class="name">MEMORYCHECK_COMMAND</span> NAMES valgrind)</span><br><span class="line">set(<span class="name">MEMORYCHECK_COMMAND_OPTIONS</span> <span class="string">"--trace-children=yes --leak-check=full"</span>)</span><br><span class="line"></span><br><span class="line"># add memcheck test action</span><br><span class="line">include(<span class="name">CTest</span>)</span><br><span class="line"></span><br><span class="line">enable_testing()</span><br><span class="line"></span><br><span class="line">add_test(</span><br><span class="line">  NAME cpp_test</span><br><span class="line">  COMMAND $&lt;TARGET_FILE<span class="symbol">:cpp_test&gt;</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行测试集，报告测试通过情况，如下所示:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ctest</span><br><span class="line"></span><br><span class="line">Test project /home/user/cmake-recipes/chapter-04/recipe-05/cxx-example/build</span><br><span class="line">Start 1: cpp_test</span><br><span class="line">1/1 Test #1: cpp_test <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>. Passed 0.00 sec</span><br><span class="line">100% tests passed, 0 tests failed out of 1</span><br><span class="line">Total Test time (real) = 0.00 sec</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在，我们希望检查内存缺陷，可以观察到被检测到的内存泄漏:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ ctest -T memcheck</span><br><span class="line"></span><br><span class="line">Site: myhost</span><br><span class="line">Build name: Linux-c++</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">new</span> tag: <span class="number">20171127</span><span class="number">-1717</span> - Experimental</span><br><span class="line"><span class="keyword">Memory</span> <span class="keyword">check</span> <span class="keyword">project</span> /home/<span class="keyword">user</span>/cmake-recipes/chapter<span class="number">-04</span>/recipe<span class="number">-05</span>/cxx-example/<span class="keyword">build</span></span><br><span class="line"><span class="keyword">Start</span> <span class="number">1</span>: cpp_test</span><br><span class="line"><span class="number">1</span>/<span class="number">1</span> MemCheck <span class="comment">#1: cpp_test ......................... Passed 0.40 sec</span></span><br><span class="line"><span class="number">100</span>% tests passed, <span class="number">0</span> tests <span class="keyword">failed</span> <span class="keyword">out</span> <span class="keyword">of</span> <span class="number">1</span></span><br><span class="line">Total <span class="keyword">Test</span> <span class="built_in">time</span> (<span class="built_in">real</span>) = <span class="number">0.40</span> sec</span><br><span class="line"><span class="comment">-- Processing memory checking output:</span></span><br><span class="line"><span class="number">1</span>/<span class="number">1</span> MemCheck: <span class="comment">#1: cpp_test ......................... Defects: 1</span></span><br><span class="line">MemCheck <span class="keyword">log</span> files can be <span class="keyword">found</span> here: ( * corresponds <span class="keyword">to</span> <span class="keyword">test</span> <span class="built_in">number</span>)</span><br><span class="line">/home/<span class="keyword">user</span>/cmake-recipes/chapter<span class="number">-04</span>/recipe<span class="number">-05</span>/cxx-example/<span class="keyword">build</span>/Testing/<span class="keyword">Temporary</span>/MemoryChecker.*.log</span><br><span class="line"><span class="keyword">Memory</span> checking results:</span><br><span class="line"><span class="keyword">Memory</span> Leak - <span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最后一步，应该尝试修复内存泄漏，并验证<code>ctest -T memcheck</code>没有报告错误。</p>
</li>
</ol>
<h2 id="工作原理-4"><a href="#工作原理-4" class="headerlink" title="工作原理"></a>工作原理</h2><p>使用<code>find_program(MEMORYCHECK_COMMAND NAMES valgrind)</code>查找valgrind，并将<code>MEMORYCHECK_COMMAND</code>设置为其绝对路径。我们显式地包含CTest模块来启用<code>memcheck</code>测试操作，可以使用<code>CTest -T memcheck</code>来启用这个操作。此外，使用<code>set(MEMORYCHECK_COMMAND_OPTIONS &quot;--trace-children=yes --leak-check=full&quot;)</code>，将相关参数传递给Valgrind。内存检查会创建一个日志文件，该文件可用于详细记录内存缺陷信息。</p>
<p><strong>NOTE</strong>:<em>一些工具，如代码覆盖率和静态分析工具，可以进行类似地设置。然而，其中一些工具的使用更加复杂，因为需要专门的构建和工具链。Sanitizers就是这样一个例子。有关更多信息，请参见<a href="https://github.com/arsenm/sanitizers-cmake" target="_blank" rel="noopener">https://github.com/arsenm/sanitizers-cmake</a> 。另外，请参阅第14章，其中讨论了AddressSanitizer和ThreadSanitizer。</em></p>
<h2 id="更多信息-4"><a href="#更多信息-4" class="headerlink" title="更多信息"></a>更多信息</h2><p>该方法可向测试面板报告内存缺陷，这里演示的功能也可以独立于测试面板使用。我们将在第14章中重新讨论，与CDash一起使用的情况。</p>
<p>有关Valgrind及其特性和选项的文档，请参见<a href="http://valgrind.org/" target="_blank" rel="noopener">http://valgrind.org</a> 。</p>
<h1 id="4-6-预期测试失败"><a href="#4-6-预期测试失败" class="headerlink" title="4.6 预期测试失败"></a>4.6 预期测试失败</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-06" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-06</a> 中找到，包含一个C++的示例。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>理想情况下，我们希望所有的测试能在每个平台上通过。然而，也可能想要测试预期的失败或异常是否会在受控的设置中进行。这种情况下，我们将把预期的失败定义为成功。我们认为，这通常应该交给测试框架(例如：Catch2或Google Test)的任务，它应该检查预期的失败并向CMake报告成功。但是，在某些情况下，您可能希望将测试的非零返回代码定义为成功；换句话说，您可能想要颠倒成功和失败的定义。在本示例中，我们将演示这种情况。</p>
<h2 id="准备工作-5"><a href="#准备工作-5" class="headerlink" title="准备工作"></a>准备工作</h2><p>这个配置的测试用例是一个很小的Python脚本(<code>test.py</code>)，它总是返回1，CMake将其解释为失败:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># simulate a failing test</span></span><br><span class="line">sys.<span class="keyword">exit</span>(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<h2 id="实施步骤"><a href="#实施步骤" class="headerlink" title="实施步骤"></a>实施步骤</h2><p>如何编写CMakeLists.txt来完成我们的任务:</p>
<ol>
<li><p>这个示例中，不需要任何语言支持从CMake，但需要Python:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">cmake_minimum_required</span><span class="params">(VERSION <span class="number">3.5</span> FATAL_ERROR)</span></span></span><br><span class="line"><span class="function"><span class="title">project</span><span class="params">(recipe-<span class="number">06</span> LANGUAGES NONE)</span></span></span><br><span class="line"><span class="function"><span class="title">find_package</span><span class="params">(PythonInterp REQUIRED)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，定义测试并告诉CMake，测试预期会失败:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">enable_testing</span><span class="params">()</span></span></span><br><span class="line"><span class="function"><span class="title">add_test</span><span class="params">(example $&#123;PYTHON_EXECUTABLE&#125; $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/test.py)</span></span></span><br><span class="line"><span class="function"><span class="title">set_tests_properties</span><span class="params">(example PROPERTIES WILL_FAIL true)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，报告是一个成功的测试，如下所示:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p build</span><br><span class="line">$ cd build</span><br><span class="line">$ cmake <span class="built_in">..</span></span><br><span class="line">$ cmake --build .</span><br><span class="line">$ ctest</span><br><span class="line"></span><br><span class="line">Test project /home/user/cmake-recipes/chapter-04/recipe-06/example/build</span><br><span class="line">Start 1: example</span><br><span class="line">1/1 Test #1: example <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.00 sec</span><br><span class="line">100% tests passed, 0 tests failed out of 1</span><br><span class="line">Total Test time (real) = 0.01 sec</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-5"><a href="#工作原理-5" class="headerlink" title="工作原理"></a>工作原理</h2><p>使用<code>set_tests_properties(example PROPERTIES WILL_FAIL true)</code>，将属性<code>WILL_FAIL</code>设置为<code>true</code>，这将转换成功与失败。但是，这个特性不应该用来临时修复损坏的测试。</p>
<h2 id="更多信息-5"><a href="#更多信息-5" class="headerlink" title="更多信息"></a>更多信息</h2><p>如果需要更大的灵活性，可以将测试属性<code>PASS_REGULAR_EXPRESSION</code>和<code>FAIL_REGULAR_EXPRESSION</code>与<code>set_tests_properties</code>组合使用。如果设置了这些参数，测试输出将根据参数给出的正则表达式列表进行检查，如果匹配了正则表达式，测试将通过或失败。可以在测试中设置其他属性，完整的属性列表可以参考：<a href="https://cmake.org/cmake/help/v3.5/manual/cmake-properties.7.html#properties-on-tests" target="_blank" rel="noopener">https://cmake.org/cmake/help/v3.5/manual/cmake-properties.7.html#properties-on-tests</a> 。</p>
<h1 id="4-7-使用超时测试运行时间过长的测试"><a href="#4-7-使用超时测试运行时间过长的测试" class="headerlink" title="4.7 使用超时测试运行时间过长的测试"></a>4.7 使用超时测试运行时间过长的测试</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-07" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-07</a> 中找到。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>理想情况下，测试集应该花很短的时间进行，以便开发人员经常运行测试，并使每个提交(变更集)进行测试成为可能(或更容易)。然而，有些测试可能会花费更长的时间或者被卡住(例如，由于高文件I/O负载)，我们可能需要设置超时来终止耗时过长的测试，它们延迟了整个测试，并阻塞了部署管道。本示例中，我们将演示一种设置超时的方法，可以针对每个测试设置不同的超时。</p>
<h2 id="准备工作-6"><a href="#准备工作-6" class="headerlink" title="准备工作"></a>准备工作</h2><p>这个示例是一个Python脚本(<code>test.py</code>)，它总是返回0。为了保持这种简单性，并保持对CMake方面的关注，测试脚本除了等待两秒钟外什么也不做。实际中，这个测试脚本将执行更有意义的工作:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"><span class="comment"># wait for 2 seconds</span></span><br><span class="line">time.sleep(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># report success</span></span><br><span class="line">sys.<span class="keyword">exit</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h2 id="具体实施-5"><a href="#具体实施-5" class="headerlink" title="具体实施"></a>具体实施</h2><p>我们需要通知CTest终止测试，如下:</p>
<ol>
<li><p>我们定义项目名称，启用测试，并定义测试:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set minimum cmake version</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.5</span> FATAL_ERROR)</span><br><span class="line"></span><br><span class="line"><span class="comment"># project name</span></span><br><span class="line"><span class="keyword">project</span>(recipe-<span class="number">07</span> LANGUAGES NONE)</span><br><span class="line"></span><br><span class="line"><span class="comment"># detect python</span></span><br><span class="line"><span class="keyword">find_package</span>(PythonInterp REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="comment"># define tests</span></span><br><span class="line"><span class="keyword">enable_testing</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment"># we expect this test to run for 2 seconds</span></span><br><span class="line"><span class="keyword">add_test</span>(example <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>.py)</span><br></pre></td></tr></table></figure>
</li>
<li><p>另外，我们为测试指定时限，设置为10秒:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set_tests_properties</span><span class="params">(example PROPERTIES TIMEOUT <span class="number">10</span>)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>知道了如何进行配置和构建，并希望测试能够通过:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ ctest</span><br><span class="line"></span><br><span class="line">Test project /home/user/cmake-recipes/chapter-04/recipe-07/example/build</span><br><span class="line">Start 1: example</span><br><span class="line">1/1 Test #1: example <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 2.01 sec</span><br><span class="line">100% tests passed, 0 tests failed out of 1</span><br><span class="line">Total Test time (real) = 2.01 sec</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在，为了验证超时是否有效，我们将<code>test.py</code>中的<code>sleep</code>命令增加到11秒，并重新运行测试:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ctest</span><br><span class="line"></span><br><span class="line">Test project /home/user/cmake-recipes/chapter-04/recipe-07/example/build</span><br><span class="line">Start 1: example</span><br><span class="line">1/1 Test #1: example <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span>***Timeout 10.01 sec</span><br><span class="line">0% tests passed, 1 tests failed out of 1</span><br><span class="line">Total Test time (real) = 10.01 sec</span><br><span class="line">The following tests FAILED:</span><br><span class="line">1 - example (Timeout)</span><br><span class="line">Errors <span class="keyword">while</span> running CTest</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-6"><a href="#工作原理-6" class="headerlink" title="工作原理"></a>工作原理</h2><p><code>TIMEOUT</code>是一个方便的属性，可以使用<code>set_tests_properties</code>为单个测试指定超时时间。如果测试运行超过了这个设置时间，不管出于什么原因(测试已经停止或者机器太慢)，测试将被终止并标记为失败。</p>
<h1 id="4-8-并行测试"><a href="#4-8-并行测试" class="headerlink" title="4.8 并行测试"></a>4.8 并行测试</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-08" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-08</a> 中找到。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>大多数现代计算机都有4个或更多个CPU核芯。CTest有个非常棒的特性，能够并行运行测试，如果您有多个可用的核。这可以减少测试的总时间，而减少总测试时间才是真正重要的，从而开发人员频繁地进行测试。本示例中，我们将演示这个特性，并讨论如何优化测试以获得最大的性能。</p>
<p>其他测试可以进行相应地表示，我们把这些测试脚本放在<code>CMakeLists.txt</code>同目录下面的test目录中。</p>
<h2 id="准备工作-7"><a href="#准备工作-7" class="headerlink" title="准备工作"></a>准备工作</h2><p>我们假设测试集包含标记为a, b，…，j的测试用例，每一个都有特定的持续时间:</p>
<table>
<thead>
<tr>
<th>测试用例</th>
<th>该单元的耗时</th>
</tr>
</thead>
<tbody>
<tr>
<td>a, b, c, d</td>
<td>0.5</td>
</tr>
<tr>
<td>e, f, g</td>
<td>1.5</td>
</tr>
<tr>
<td>h</td>
<td>2.5</td>
</tr>
<tr>
<td>i</td>
<td>3.5</td>
</tr>
<tr>
<td>j</td>
<td>4.5</td>
</tr>
</tbody>
</table>
<p>时间单位可以是分钟，但是为了保持简单和简短，我们将使用秒。为简单起见，我们可以用Python脚本表示<code>test a</code>，它消耗0.5个时间单位:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"><span class="comment"># wait for 0.5 seconds</span></span><br><span class="line">time.sleep(<span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># finally report success</span></span><br><span class="line">sys.<span class="keyword">exit</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>其他测试同理。我们将把这些脚本放在<code>CMakeLists.txt</code>下面，一个名为<code>test</code>的目录中。</p>
<h2 id="具体实施-6"><a href="#具体实施-6" class="headerlink" title="具体实施"></a>具体实施</h2><p>对于这个示例，我们需要声明一个测试列表，如下:</p>
<ol>
<li><p><code>CMakeLists.txt</code>非常简单：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set minimum cmake version</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.5</span> FATAL_ERROR)</span><br><span class="line"></span><br><span class="line"><span class="comment"># project name</span></span><br><span class="line"><span class="keyword">project</span>(recipe-<span class="number">08</span> LANGUAGES NONE)</span><br><span class="line"></span><br><span class="line"><span class="comment"># detect python</span></span><br><span class="line"><span class="keyword">find_package</span>(PythonInterp REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="comment"># define tests</span></span><br><span class="line"><span class="keyword">enable_testing</span>()</span><br><span class="line"><span class="keyword">add_test</span>(a <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/a.py)</span><br><span class="line"><span class="keyword">add_test</span>(b <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/b.py)</span><br><span class="line"><span class="keyword">add_test</span>(c <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/c.py)</span><br><span class="line"><span class="keyword">add_test</span>(d <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/d.py)</span><br><span class="line"><span class="keyword">add_test</span>(e <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/e.py)</span><br><span class="line"><span class="keyword">add_test</span>(f <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/f.py)</span><br><span class="line"><span class="keyword">add_test</span>(g <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/g.py)</span><br><span class="line"><span class="keyword">add_test</span>(h <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/h.py)</span><br><span class="line"><span class="keyword">add_test</span>(i <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/i.py)</span><br><span class="line"><span class="keyword">add_test</span>(j <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/j.py)</span><br></pre></td></tr></table></figure>
</li>
<li><p>我们可以配置项目，使用<code>ctest</code>运行测试，总共需要17秒:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p build</span><br><span class="line">$ cd build</span><br><span class="line">$ cmake <span class="built_in">..</span></span><br><span class="line">$ ctest</span><br><span class="line"></span><br><span class="line">Start 1: a</span><br><span class="line">1/10 Test #1: a <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.51 sec</span><br><span class="line">Start 2: b</span><br><span class="line">2/10 Test #2: b <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.51 sec</span><br><span class="line">Start 3: c</span><br><span class="line">3/10 Test #3: c <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.51 sec</span><br><span class="line">Start 4: d</span><br><span class="line">4/10 Test #4: d <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.51 sec</span><br><span class="line">Start 5: e</span><br><span class="line">5/10 Test #5: e <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 1.51 sec</span><br><span class="line">Start 6: f</span><br><span class="line">6/10 Test #6: f <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 1.51 sec</span><br><span class="line">Start 7: g</span><br><span class="line">7/10 Test #7: g <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 1.51 sec</span><br><span class="line">Start 8: h</span><br><span class="line">8/10 Test #8: h <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 2.51 sec</span><br><span class="line">Start 9: i</span><br><span class="line">9/10 Test #9: i <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 3.51 sec</span><br><span class="line">Start 10: j</span><br><span class="line">10/10 Test #10: j <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 4.51 sec</span><br><span class="line">100% tests passed, 0 tests failed out of 10</span><br><span class="line">Total Test time (real) = 17.11 sec</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在，如果机器有4个内核可用，我们可以在不到5秒的时间内在4个内核上运行测试集:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">$ ctest --parallel 4</span><br><span class="line"></span><br><span class="line">Start 10: j</span><br><span class="line">Start 9: i</span><br><span class="line">Start 8: h</span><br><span class="line">Start 5: e</span><br><span class="line">1/10 Test #5: e <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 1.51 sec</span><br><span class="line">Start 7: g</span><br><span class="line">2/10 Test #8: h <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 2.51 sec</span><br><span class="line">Start 6: f</span><br><span class="line">3/10 Test #7: g <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 1.51 sec</span><br><span class="line">Start 3: c</span><br><span class="line">4/10 Test #9: i <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 3.63 sec</span><br><span class="line">5/10 Test #3: c <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.60 sec</span><br><span class="line">Start 2: b</span><br><span class="line">Start 4: d</span><br><span class="line">6/10 Test #6: f <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 1.51 sec</span><br><span class="line">7/10 Test #4: d <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.59 sec</span><br><span class="line">8/10 Test #2: b <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.59 sec</span><br><span class="line">Start 1: a</span><br><span class="line">9/10 Test #10: j <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 4.51 sec</span><br><span class="line">10/10 Test #1: a <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.51 sec</span><br><span class="line">100% tests passed, 0 tests failed out of 10</span><br><span class="line">Total Test time (real) = 4.74 sec</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-7"><a href="#工作原理-7" class="headerlink" title="工作原理"></a>工作原理</h2><p>可以观察到，在并行情况下，测试j、i、h和e同时开始。当并行运行时，总测试时间会有显著的减少。观察<code>ctest --parallel 4</code>的输出，我们可以看到并行测试运行从最长的测试开始，最后运行最短的测试。从最长的测试开始是一个非常好的策略。这就像打包移动的盒子：从较大的项目开始，然后用较小的项目填补空白。a-j测试在4个核上的叠加比较，从最长的开始，如下图所示:</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">--&gt; time</span></span><br><span class="line"><span class="attribute">core 1</span>: jjjjjjjjj</span><br><span class="line"><span class="attribute">core 2</span>: iiiiiiibd</span><br><span class="line"><span class="attribute">core 3</span>: hhhhhggg</span><br><span class="line"><span class="attribute">core 4</span>: eeefffac</span><br></pre></td></tr></table></figure>
<p>按照定义测试的顺序运行，运行结果如下:</p>
<figure class="highlight ldif"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">--&gt; time</span></span><br><span class="line"><span class="attribute">core 1</span>: aeeeiiiiiii</span><br><span class="line"><span class="attribute">core 2</span>: bfffjjjjjjjjj</span><br><span class="line"><span class="attribute">core 3</span>: cggg</span><br><span class="line"><span class="attribute">core 4</span>: dhhhhh</span><br></pre></td></tr></table></figure>
<p>按照定义测试的顺序运行测试，总的来说需要更多的时间，因为这会让2个核大部分时间处于空闲状态(这里的核3和核4)。CMake知道每个测试的时间成本，是因为我们先顺序运行了测试，将每个测试的成本数据记录在<code>test/Temporary/CTestCostData.txt</code>文件中:</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a <span class="number">1</span> <span class="number">0.506776</span></span><br><span class="line">b <span class="number">1</span> <span class="number">0.507882</span></span><br><span class="line">c <span class="number">1</span> <span class="number">0.508175</span></span><br><span class="line">d <span class="number">1</span> <span class="number">0.504618</span></span><br><span class="line">e <span class="number">1</span> <span class="number">1.51006</span></span><br><span class="line">f <span class="number">1</span> <span class="number">1.50975</span></span><br><span class="line">g <span class="number">1</span> <span class="number">1.50648</span></span><br><span class="line">h <span class="number">1</span> <span class="number">2.51032</span></span><br><span class="line">i <span class="number">1</span> <span class="number">3.50475</span></span><br><span class="line">j <span class="number">1</span> <span class="number">4.51111</span></span><br></pre></td></tr></table></figure>
<p>如果在配置项目之后立即开始并行测试，它将按照定义测试的顺序运行测试，在4个核上的总测试时间明显会更长。这意味着什么呢？这意味着，我们应该减少的时间成本来安排测试？这是一种决策，但事实证明还有另一种方法，我们可以自己表示每次测试的时间成本:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_test</span>(a <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/a.py)</span><br><span class="line"><span class="keyword">add_test</span>(b <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/b.py)</span><br><span class="line"><span class="keyword">add_test</span>(c <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/c.py)</span><br><span class="line"><span class="keyword">add_test</span>(d <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/d.py)</span><br><span class="line"><span class="keyword">set_tests_properties</span>(a b c d PROPERTIES COST <span class="number">0.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_test</span>(e <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/e.py)</span><br><span class="line"><span class="keyword">add_test</span>(f <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/f.py)</span><br><span class="line"><span class="keyword">add_test</span>(g <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/g.py)</span><br><span class="line"><span class="keyword">set_tests_properties</span>(e f g PROPERTIES COST <span class="number">1.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_test</span>(h <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/h.py)</span><br><span class="line"><span class="keyword">set_tests_properties</span>(h PROPERTIES COST <span class="number">2.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_test</span>(i <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/i.py)</span><br><span class="line"><span class="keyword">set_tests_properties</span>(i PROPERTIES COST <span class="number">3.5</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_test</span>(j <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/j.py)</span><br><span class="line"><span class="keyword">set_tests_properties</span>(j PROPERTIES COST <span class="number">4.5</span>)</span><br></pre></td></tr></table></figure>
<p>成本参数可以是一个估计值，也可以从<code>test/Temporary/CTestCostData.txt</code>中提取。</p>
<h2 id="更多信息-6"><a href="#更多信息-6" class="headerlink" title="更多信息"></a>更多信息</h2><p>除了使用<code>ctest --parallel N</code>，还可以使用环境变量<code>CTEST_PARALLEL_LEVEL</code>将其设置为所需的级别。</p>
<h1 id="4-9-运行测试子集"><a href="#4-9-运行测试子集" class="headerlink" title="4.9 运行测试子集"></a>4.9 运行测试子集</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-09" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-09</a> 中找到。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>前面的示例中，我们学习了如何在CMake的帮助下并行运行测试，并讨论了从最长的测试开始是最高效的。虽然，这种策略将总测试时间最小化，但是在特定特性的代码开发期间，或者在调试期间，我们可能不希望运行整个测试集。对于调试和代码开发，我们只需要能够运行选定的测试子集。在本示例中，我们将实现这一策略。</p>
<h2 id="准备工作-8"><a href="#准备工作-8" class="headerlink" title="准备工作"></a>准备工作</h2><p>在这个例子中，我们假设总共有六个测试：前三个测试比较短，名称分别为<code>feature-a</code>、<code>feature-b</code>和<code>feature-c</code>，还有三个长测试，名称分别是<code>feature-d</code>、<code>benchmark-a</code>和<code>benchmark-b</code>。这个示例中，我们可以用Python脚本表示这些测试，可以在其中调整休眠时间:</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line"><span class="comment"># wait for 0.1 seconds</span></span><br><span class="line">time.sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># finally report success</span></span><br><span class="line">sys.<span class="keyword">exit</span>(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h2 id="具体实施-7"><a href="#具体实施-7" class="headerlink" title="具体实施"></a>具体实施</h2><p>以下是我们CMakeLists.txt文件内容的详细内容:</p>
<ol>
<li><p><code>CMakeLists.txt</code>中，定义了六个测试:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.5</span> FATAL_ERROR)</span><br><span class="line"></span><br><span class="line"><span class="comment"># project name</span></span><br><span class="line"><span class="keyword">project</span>(recipe-<span class="number">09</span> LANGUAGES NONE)</span><br><span class="line"></span><br><span class="line"><span class="comment"># detect python</span></span><br><span class="line"><span class="keyword">find_package</span>(PythonInterp REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="comment"># define tests</span></span><br><span class="line"><span class="keyword">enable_testing</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME feature-a</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/feature-a.py</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME feature-b</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/feature-b.py</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME feature-c</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/feature-c.py</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME feature-d</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/feature-d.py</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME benchmark-a</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/benchmark-a.py</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME benchmark-b</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/benchmark-b.py</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>此外，我们给较短的测试贴上<code>quick</code>的标签，给较长的测试贴上<code>long</code>的标签:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">set_tests_properties(</span><br><span class="line">  feature-a</span><br><span class="line">  feature-b</span><br><span class="line">  feature-c</span><br><span class="line">  PROPERTIES</span><br><span class="line">  	LABELS <span class="string">"quick"</span></span><br><span class="line">  )</span><br><span class="line">set_tests_properties(</span><br><span class="line">  feature-d</span><br><span class="line">  benchmark-a</span><br><span class="line">  benchmark-b</span><br><span class="line">  PROPERTIES</span><br><span class="line">  	LABELS <span class="string">"long"</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>我们现在可以运行测试集了，如下:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p build</span><br><span class="line">$ cd build</span><br><span class="line">$ cmake <span class="built_in">..</span></span><br><span class="line">$ ctest</span><br><span class="line"></span><br><span class="line">Start 1: feature-a</span><br><span class="line">1/6 Test #1: feature-a <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.11 sec</span><br><span class="line">Start 2: feature-b</span><br><span class="line">2/6 Test #2: feature-b <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.11 sec</span><br><span class="line">Start 3: feature-c</span><br><span class="line">3/6 Test #3: feature-c <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.11 sec</span><br><span class="line">Start 4: feature-d</span><br><span class="line">4/6 Test #4: feature-d <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.51 sec</span><br><span class="line">Start 5: benchmark-a</span><br><span class="line">5/6 Test #5: benchmark-a <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.51 sec</span><br><span class="line">Start 6: benchmark-b</span><br><span class="line">6/6 Test #6: benchmark-b <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.51 sec</span><br><span class="line">100% tests passed, 0 tests failed out of 6</span><br><span class="line">Label Time Summary:</span><br><span class="line">long = 1.54 sec*proc (3 tests)</span><br><span class="line">quick = 0.33 sec*proc (3 tests)</span><br><span class="line">Total Test time (real) = 1.87 sec</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-8"><a href="#工作原理-8" class="headerlink" title="工作原理"></a>工作原理</h2><p>现在每个测试都有一个名称和一个标签。CMake中所有的测试都是有编号的，所以它们也带有唯一编号。定义了测试标签之后，我们现在可以运行整个集合，或者根据它们的名称(使用正则表达式)、标签或编号运行测试。</p>
<p>按名称运行测试(运行所有具有名称匹配功能的测试):</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ctest -R feature</span><br><span class="line"></span><br><span class="line">Start 1: feature-a</span><br><span class="line">1/4 Test #1: feature-a <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.11 sec</span><br><span class="line">Start 2: feature-b</span><br><span class="line">2/4 Test #2: feature-b <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.11 sec</span><br><span class="line">Start 3: feature-c</span><br><span class="line">3/4 Test #3: feature-c <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.11 sec</span><br><span class="line">Start 4: feature-d</span><br><span class="line">4/4 Test #4: feature-d <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.51 sec</span><br><span class="line">100% tests passed, 0 tests failed out of 4</span><br></pre></td></tr></table></figure>
<p>按照标签运行测试(运行所有的长测试):</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ctest -L long</span><br><span class="line"></span><br><span class="line">Start 4: feature-d</span><br><span class="line">1/3 Test #4: feature-d <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.51 sec</span><br><span class="line">Start 5: benchmark-a</span><br><span class="line">2/3 Test #5: benchmark-a <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.51 sec</span><br><span class="line">Start 6: benchmark-b</span><br><span class="line">3/3 Test #6: benchmark-b <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.51 sec</span><br><span class="line">100% tests passed, 0 tests failed out of 3</span><br></pre></td></tr></table></figure>
<p>根据数量运行测试(运行测试2到4)产生的结果是:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ ctest -I 2,4</span><br><span class="line"></span><br><span class="line">Start 2: feature-b</span><br><span class="line">1/3 Test #2: feature-b <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.11 sec</span><br><span class="line">Start 3: feature-c</span><br><span class="line">2/3 Test #3: feature-c <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.11 sec</span><br><span class="line">Start 4: feature-d</span><br><span class="line">3/3 Test #4: feature-d <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.51 sec</span><br><span class="line">100% tests passed, 0 tests failed out of 3</span><br></pre></td></tr></table></figure>
<h2 id="更多信息-7"><a href="#更多信息-7" class="headerlink" title="更多信息"></a>更多信息</h2><p>尝试使用<code>$ ctest --help</code>，将看到有大量的选项可供用来定制测试。</p>
<h1 id="4-10-使用测试固件"><a href="#4-10-使用测试固件" class="headerlink" title="4.10 使用测试固件"></a>4.10 使用测试固件</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-10" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-04/recipe-10</a> 中找到。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>这个示例的灵感来自于Craig Scott，我们建议读者也参考相应的博客文章来了解更多的背景知识，<a href="https://crascit.com/2016/10/18/test-fixtures-withcmake-ctest/" target="_blank" rel="noopener">https://crascit.com/2016/10/18/test-fixtures-withcmake-ctest/</a> ，此示例的动机是演示如何使用测试固件。这对于更复杂的测试非常有用，这些测试需要在测试运行前进行设置，以及在测试完成后执行清理操作(例如：创建示例数据库、设置连接、断开连接、清理测试数据库等等)。我们需要运行一个设置或清理操作的测试，并能够以一种可预测和健壮的方式自动触发这些步骤，而不需要引入代码重复。这些设置和清理步骤可以委托给测试框架(例如Google Test或Catch2)，我们在这里将演示如何在CMake级别实现测试固件。</p>
<h2 id="准备工作-9"><a href="#准备工作-9" class="headerlink" title="准备工作"></a>准备工作</h2><p>我们将准备4个Python脚本，并将它们放在<code>test</code>目录下:<code>setup.py</code>、<code>features-a.py</code>、<code>features-b.py</code>和<code>clean-up.py</code>。</p>
<h2 id="具体实施-8"><a href="#具体实施-8" class="headerlink" title="具体实施"></a>具体实施</h2><p>我们从<code>CMakeLists.txt</code>结构开始，附加一些步骤如下:</p>
<ol>
<li><p>基础CMake语句:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set minimum cmake version</span></span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.5</span> FATAL_ERROR)</span><br><span class="line"></span><br><span class="line"><span class="comment"># project name</span></span><br><span class="line"><span class="keyword">project</span>(recipe-<span class="number">10</span> LANGUAGES NONE)</span><br><span class="line"></span><br><span class="line"><span class="comment"># detect python</span></span><br><span class="line"><span class="keyword">find_package</span>(PythonInterp REQUIRED)</span><br><span class="line"></span><br><span class="line"><span class="comment"># define tests</span></span><br><span class="line"><span class="keyword">enable_testing</span>()</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，定义了4个测试步骤，并将它们绑定到一个固件上:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME setup</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/setup.py</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">set_tests_properties</span>(</span><br><span class="line">  setup</span><br><span class="line">  PROPERTIES</span><br><span class="line">  	FIXTURES_SETUP my-fixture</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME feature-a</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/feature-a.py</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME feature-b</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/feature-b.py</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">set_tests_properties</span>(</span><br><span class="line">  feature-a</span><br><span class="line">  feature-b</span><br><span class="line">  PROPERTIES</span><br><span class="line">  	FIXTURES_REQUIRED my-fixture</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">add_test</span>(</span><br><span class="line">  NAME cleanup</span><br><span class="line">  <span class="keyword">COMMAND</span> <span class="variable">$&#123;PYTHON_EXECUTABLE&#125;</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">test</span>/cleanup.py</span><br><span class="line">  )</span><br><span class="line"><span class="keyword">set_tests_properties</span>(</span><br><span class="line">  cleanup</span><br><span class="line">  PROPERTIES</span><br><span class="line">  	FIXTURES_CLEANUP my-fixture</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行整个集合，如下面的输出所示:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -p build</span><br><span class="line">$ cd build</span><br><span class="line">$ cmake <span class="built_in">..</span></span><br><span class="line">$ ctest</span><br><span class="line"></span><br><span class="line">Start 1: setup</span><br><span class="line">1/4 Test #1: setup <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.01 sec</span><br><span class="line">Start 2: feature-a</span><br><span class="line">2/4 Test #2: feature-a <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.01 sec</span><br><span class="line">Start 3: feature-b</span><br><span class="line">3/4 Test #3: feature-b <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.00 sec</span><br><span class="line">Start 4: cleanup</span><br><span class="line">4/4 Test #4: cleanup <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.01 sec</span><br><span class="line"></span><br><span class="line">100% tests passed, 0 tests failed out of 4</span><br></pre></td></tr></table></figure>
</li>
<li><p>然而，当我们试图单独运行测试特性时。它正确地调用设置步骤和清理步骤:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ctest -R feature-a</span><br><span class="line"></span><br><span class="line">Start 1: setup</span><br><span class="line">1/3 Test #1: setup <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.01 sec</span><br><span class="line">Start 2: feature-a</span><br><span class="line">2/3 Test #2: feature-a <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.00 sec</span><br><span class="line">Start 4: cleanup</span><br><span class="line">3/3 Test #4: cleanup <span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span><span class="built_in">..</span> Passed 0.01 sec</span><br><span class="line"></span><br><span class="line">100% tests passed, 0 tests failed out of 3</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-9"><a href="#工作原理-9" class="headerlink" title="工作原理"></a>工作原理</h2><p>在本例中，我们定义了一个文本固件，并将其称为<code>my-fixture</code>。我们为安装测试提供了<code>FIXTURES_SETUP</code>属性，并为清理测试了<code>FIXTURES_CLEANUP</code>属性，并且使用<code>FIXTURES_REQUIRED</code>，我们确保测试<code>feature-a</code>和<code>feature-b</code>都需要安装和清理步骤才能运行。将它们绑定在一起，可以确保在定义良好的状态下，进入和离开相应的步骤。</p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2021/03/100656.html" class="pre-post btn btn-default" title='CMake 完整使用教程 之六 配置时和构建时的操作'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">CMake 完整使用教程 之六 配置时和构建时的操作</span>
        </a>
    
    
        <a href="/archives/2021/03/100654.html" class="next-post btn btn-default" title='CMake 完整使用教程 之四 检测外部库和程序'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">CMake 完整使用教程 之四 检测外部库和程序</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#4-1-创建一个简单的单元测试"><span class="toc-text">4.1 创建一个简单的单元测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-2-使用Catch2库进行单元测试"><span class="toc-text">4.2 使用Catch2库进行单元测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-1"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-1"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-1"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-1"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-3-使用Google-Test库进行单元测试"><span class="toc-text">4.3 使用Google Test库进行单元测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-2"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-2"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-2"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-2"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-4-使用Boost-Test进行单元测试"><span class="toc-text">4.4 使用Boost Test进行单元测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-3"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-3"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-3"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-3"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-5-使用动态分析来检测内存缺陷"><span class="toc-text">4.5 使用动态分析来检测内存缺陷</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-4"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-4"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-4"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-4"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-6-预期测试失败"><span class="toc-text">4.6 预期测试失败</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-5"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实施步骤"><span class="toc-text">实施步骤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-5"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-5"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-7-使用超时测试运行时间过长的测试"><span class="toc-text">4.7 使用超时测试运行时间过长的测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-6"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-5"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-6"><span class="toc-text">工作原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-8-并行测试"><span class="toc-text">4.8 并行测试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-7"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-6"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-7"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-6"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-9-运行测试子集"><span class="toc-text">4.9 运行测试子集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-8"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-7"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-8"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-7"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-10-使用测试固件"><span class="toc-text">4.10 使用测试固件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-9"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-8"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-9"><span class="toc-text">工作原理</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2024&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>