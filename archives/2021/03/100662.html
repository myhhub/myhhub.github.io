<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="cmake,qt,c++">


    <meta name="description" content="本章的主要内容有：

生成源代码和二进制包
使用CMake/pybind11构建的C++/Python项目，通过PyPI发布
使用CMake/CFFI构建C/Fortran/Python项目，通...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>CMake 完整使用教程 之十二 打包项目 | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx">


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="CMake 完整使用教程 之十二 打包项目">
            
	            CMake 完整使用教程 之十二 打包项目
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/back/">后端</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/c/">c++</a> <a class="tag-link" href="/tags/cmake/">cmake</a> <a class="tag-link" href="/tags/qt/">qt</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2021/03/29</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>742</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <p>本章的主要内容有：</p>
<ul>
<li>生成源代码和二进制包</li>
<li>使用CMake/pybind11构建的C++/Python项目，通过PyPI发布</li>
<li>使用CMake/CFFI构建C/Fortran/Python项目，通过PyPI发布</li>
<li>以Conda包的形式发布一个简单的项目</li>
<li>将Conda包作为依赖项发布给项目</li>
</ul>
<p>目前为止，已经从源代码编译并安装了软件包——这意味着可以通过Git获取项目，并手动执行配置、构建、测试和安装。然而，在实际中，软件包通常是使用管理器来安装的，比如Apt、DNF、Pacman、pip和Conda。我们需要以各种格式发布我们的代码项目——作为源文件或二进制安装程序。</p>
<p>本章中，我们将探讨不同的打包策略。首先，讨论使用CMake中的工具CPack进行打包，还提供打包和上传CMake项目到Python包索引(PyPI, <a href="https://pypi.xn--org" target="_blank" rel="noopener">https://pypi.org)和Anaconda云(https://anaconda.org</a>anaconda(https-oi98au39f//anaconda.org) )的方法，这些都是通过包管理器pip和Conda (<a href="https://conda.io/docs/" target="_blank" rel="noopener">https://conda.io/docs/</a> )分发包的平台。对于PyPI，我们将演示如何打包和分发混合C++/Python或C/Fortran/Python的项目。对于Conda，我们将展示如何对依赖于其他库的C++项目进行打包。</p>
<h1 id="11-1-生成源代码和二进制包"><a href="#11-1-生成源代码和二进制包" class="headerlink" title="11.1 生成源代码和二进制包"></a>11.1 生成源代码和二进制包</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-11/recipe-01" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-11/recipe-01</a> 中找到。该示例在CMake 3.6版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>如果代码是开源的，用户将能够下载项目的源代码，并使用完全定制的CMake脚本自行构建。当然，打包操作也可以使用脚本完成，但是CPack提供了更简单和可移植的替代方案。本示例将指导您创建一些包:</p>
<ul>
<li><p><strong>源代码包</strong>：可以将源代码直接压缩成归档文件，进行发送。用户将不必为特定的版本控制系统操心。</p>
</li>
<li><p><strong>二进制包</strong>：工具将新构建的目标以打包的方式到归档文件中。这个功能非常有用，但可能不够健壮，无法发布库和可执行程序。</p>
</li>
<li><p>平台原生的二进制安装</p>
<p>：CPack能够以许多不同的格式生成二进制安装程序，因此可以将软件发布到不同的平台。我们将展示如何生成安装程序:</p>
<ul>
<li>基于Debian的GNU/Linux发行版的<code>.deb</code>格式： <a href="https://manpages.debian.org/unstable/dpkg-dev/deb.5.en.html" target="_blank" rel="noopener">https://manpages.debian.org/unstable/dpkg-dev/deb.5.en.html</a></li>
<li>基于Red Hat的GNU/Linux发行版的<code>.rpm</code>格式： <a href="http://rpm.org/" target="_blank" rel="noopener">http://rpm.org/</a></li>
<li>macOS包的<code>.dmg</code>格式: <a href="https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFBundles/BundleTypes/BundleTypes.html" target="_blank" rel="noopener">https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFBundles/BundleTypes/BundleTypes.html</a></li>
<li>Windows的NSIS格式: <a href="http://nsis.sourceforge.net/Main_Page" target="_blank" rel="noopener">http://nsis.sourceforge.net/Main_Page</a></li>
</ul>
</li>
</ul>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>我们将使用第10章第3节的示例，项目树由以下目录和文件组成:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── cmake</span><br><span class="line">│    ├── coffee.icns</span><br><span class="line">│    ├── Info<span class="selector-class">.plist</span><span class="selector-class">.in</span></span><br><span class="line">│    └── messageConfig<span class="selector-class">.cmake</span><span class="selector-class">.in</span></span><br><span class="line">├── CMakeCPack.cmake</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── INSTALL.md</span><br><span class="line">├── LICENSE</span><br><span class="line">├── src</span><br><span class="line">│    ├── CMakeLists.txt</span><br><span class="line">│    ├── hello-world.cpp</span><br><span class="line">│    ├── Message.cpp</span><br><span class="line">│    └── Message.hpp</span><br><span class="line">└── tests</span><br><span class="line">    ├── CMakeLists.txt</span><br><span class="line">    └── use_target</span><br><span class="line">        ├── CMakeLists.txt</span><br><span class="line">        └── use_message.cpp</span><br></pre></td></tr></table></figure>
<p>由于本示例的重点是使用CPack，所以不会讨论源码。我们只会在<code>CMakeCPack.cmake</code>中添加打包指令。此外，还添加了<code>INSTALL.md</code>和<code>LICENSE</code>文件：打包要求需要包含安装说明和项目许可信息。</p>
<h2 id="具体实施"><a href="#具体实施" class="headerlink" title="具体实施"></a>具体实施</h2><p>让我们看看需要添加到这个项目中的打包指令。我们将在<code>CMakeCPack.cmake</code>中收集它们，并在在<code>CMakeLists.txt</code>的末尾包含这个模块<code>include(cmakecpackage.cmake)</code>:</p>
<ol>
<li><p>我们声明包的名称，与项目的名称相同，因此我们使用<code>PROJECT_NAME</code>的CMake变量:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span>(CPACK_PACKAGE_NAME <span class="string">"<span class="variable">$&#123;PROJECT_NAME&#125;</span>"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>声明包的供应商：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(CPACK_PACKAGE_VENDOR <span class="string">"CMake Cookbook"</span>)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>打包的源代码将包括一个描述文件。这是带有安装说明的纯文本文件:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span>(CPACK_PACKAGE_DESCRIPTION_FILE <span class="string">"<span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/INSTALL.md"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>还添加了一个包的描述:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(CPACK_PACKAGE_DESCRIPTION_SUMMARY <span class="string">"message: a small messaging library"</span>)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>许可证文件也将包括在包中:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span>(CPACK_RESOURCE_FILE_LICENSE <span class="string">"<span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/LICENSE"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>从发布包中安装时，文件将放在<code>/opt/recipe-01</code>目录下:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span>(CPACK_PACKAGING_INSTALL_PREFIX <span class="string">"/opt/<span class="variable">$&#123;PROJECT_NAME&#125;</span>"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>CPack所需的主要、次要和补丁版本:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span>(CPACK_PACKAGE_VERSION_MAJOR <span class="string">"<span class="variable">$&#123;PROJECT_VERSION_MAJOR&#125;</span>"</span>)</span><br><span class="line"><span class="builtin-name">set</span>(CPACK_PACKAGE_VERSION_MINOR <span class="string">"<span class="variable">$&#123;PROJECT_VERSION_MINOR&#125;</span>"</span>)</span><br><span class="line"><span class="builtin-name">set</span>(CPACK_PACKAGE_VERSION_PATCH <span class="string">"<span class="variable">$&#123;PROJECT_VERSION_PATCH&#125;</span>"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置了在包装的时候需要忽略的文件列表和目录:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span>(CPACK_SOURCE_IGNORE_FILES <span class="string">"<span class="variable">$&#123;PROJECT_BINARY_DIR&#125;</span>;/.git/;.gitignore"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>列出了源代码归档的打包生成器——在我们的例子中是<code>ZIP</code>，用于生成<code>.ZIP</code>归档，<code>TGZ</code>用于<code>.tar.gz</code>归档:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(CPACK_SOURCE_GENERATOR <span class="string">"ZIP;TGZ"</span>)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>我们还列出了二进制存档生成器:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">set</span><span class="params">(CPACK_GENERATOR <span class="string">"ZIP;TGZ"</span>)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>现在也可声明平台原生二进制安装程序，从DEB和RPM包生成器开始，不过只适用于GNU/Linux:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if(<span class="name">UNIX</span>)</span><br><span class="line">  if(<span class="name">CMAKE_SYSTEM_NAME</span> MATCHES Linux)</span><br><span class="line">    list(<span class="name">APPEND</span> CPACK_GENERATOR <span class="string">"DEB"</span>)</span><br><span class="line">    set(<span class="name">CPACK_DEBIAN_PACKAGE_MAINTAINER</span> <span class="string">"robertodr"</span>)</span><br><span class="line">    set(<span class="name">CPACK_DEBIAN_PACKAGE_SECTION</span> <span class="string">"devel"</span>)</span><br><span class="line">    set(<span class="name">CPACK_DEBIAN_PACKAGE_DEPENDS</span> <span class="string">"uuid-dev"</span>)</span><br><span class="line">    </span><br><span class="line">    list(<span class="name">APPEND</span> CPACK_GENERATOR <span class="string">"RPM"</span>)</span><br><span class="line">    set(<span class="name">CPACK_RPM_PACKAGE_RELEASE</span> <span class="string">"1"</span>)</span><br><span class="line">    set(<span class="name">CPACK_RPM_PACKAGE_LICENSE</span> <span class="string">"MIT"</span>)</span><br><span class="line">    set(<span class="name">CPACK_RPM_PACKAGE_REQUIRES</span> <span class="string">"uuid-devel"</span>)</span><br><span class="line">  endif()</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果我们在Windows上，我们会想要生成一个NSIS安装程序:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if(<span class="name">WIN32</span> OR MINGW)</span><br><span class="line">  list(<span class="name">APPEND</span> CPACK_GENERATOR <span class="string">"NSIS"</span>)</span><br><span class="line">  set(<span class="name">CPACK_NSIS_PACKAGE_NAME</span> <span class="string">"message"</span>)</span><br><span class="line">  set(<span class="name">CPACK_NSIS_CONTACT</span> <span class="string">"robertdr"</span>)</span><br><span class="line">  set(<span class="name">CPACK_NSIS_ENABLE_UNINSTALL_BEFORE_INSTALL</span> ON)</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
</li>
<li><p>另一方面，在macOS上，bundle包是我们的安装程序的选择:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if(<span class="name">APPLE</span>)</span><br><span class="line">  list(<span class="name">APPEND</span> CPACK_GENERATOR <span class="string">"Bundle"</span>)</span><br><span class="line">  set(<span class="name">CPACK_BUNDLE_NAME</span> <span class="string">"message"</span>)</span><br><span class="line">  configure_file($&#123;PROJECT_SOURCE_DIR&#125;/cmake/Info.plist.in Info.plist @ONLY)</span><br><span class="line">  set(<span class="name">CPACK_BUNDLE_PLIST</span> $&#123;CMAKE_CURRENT_BINARY_DIR&#125;/Info.plist)</span><br><span class="line">  set(<span class="name">CPACK_BUNDLE_ICON</span> $&#123;PROJECT_SOURCE_DIR&#125;/cmake/coffee.icns)</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
</li>
<li><p>我们在现有系统的包装生成器上，向用户打印一条信息:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">message</span><span class="params">(STATUS <span class="string">"CPack generators: $&#123;CPACK_GENERATOR&#125;"</span>)</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，我们包括了<code>CPack.cmake</code>标准模块。这将向构建系统添加一个包和一个<code>package_source</code>目标:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">include</span><span class="params">(CPack)</span></span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>现在来配置这个项目：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p build</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> build</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cmake ..</span></span><br></pre></td></tr></table></figure>
<p>使用下面的命令，我们可以列出可用的目标(示例输出是在使用Unix Makefile作为生成器的GNU/Linux系统上获得的):</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ cmake --build . --target help</span><br><span class="line"></span><br><span class="line">The following are some of the valid targets <span class="keyword">for</span> this Makefile:</span><br><span class="line"><span class="built_in">..</span>. all (the<span class="built_in"> default </span><span class="keyword">if</span> <span class="literal">no</span> target is provided)</span><br><span class="line"><span class="built_in">..</span>. clean</span><br><span class="line"><span class="built_in">..</span>. depend</span><br><span class="line"><span class="built_in">..</span>. install/strip</span><br><span class="line"><span class="built_in">..</span>. install</span><br><span class="line"><span class="built_in">..</span>. package_source</span><br><span class="line"><span class="built_in">..</span>. package</span><br><span class="line"><span class="built_in">..</span>. install/local</span><br><span class="line"><span class="built_in">..</span>. test</span><br><span class="line"><span class="built_in">..</span>. list_install_components</span><br><span class="line"><span class="built_in">..</span>. edit_cache</span><br><span class="line"><span class="built_in">..</span>. rebuild_cache</span><br><span class="line"><span class="built_in">..</span>. hello- world</span><br><span class="line"><span class="built_in">..</span>. message</span><br></pre></td></tr></table></figure>
<p>我们可以看到<code>package</code>和<code>package_source</code>目标是可用的。可以使用以下命令生成源包:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ cmake --build . --target package_source</span><br><span class="line"></span><br><span class="line">Run CPack packaging tool <span class="keyword">for</span> source...</span><br><span class="line"><span class="string">CPack:</span> Create <span class="keyword">package</span> using ZIP</span><br><span class="line"><span class="string">CPack:</span> Install projects</span><br><span class="line"><span class="string">CPack:</span> - Install <span class="string">directory:</span> <span class="regexp">/home/</span>user<span class="regexp">/cmake-cookbook/</span>chapter<span class="number">-11</span><span class="regexp">/recipe-01/</span>cxx-example</span><br><span class="line"><span class="string">CPack:</span> Create <span class="keyword">package</span></span><br><span class="line"><span class="string">CPack:</span> - <span class="string">package:</span> <span class="regexp">/home/</span>user<span class="regexp">/cmake-cookbook/</span>chapter- <span class="number">11</span><span class="regexp">/recipe-01/</span>cxx-example<span class="regexp">/build/</span>recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source.zip generated.</span><br><span class="line"><span class="string">CPack:</span> Create <span class="keyword">package</span> using TGZ</span><br><span class="line"><span class="string">CPack:</span> Install projects</span><br><span class="line"><span class="string">CPack:</span> - Install <span class="string">directory:</span> <span class="regexp">/home/</span>user<span class="regexp">/cmake-cookbook/</span>chapter- <span class="number">11</span><span class="regexp">/recipe-01/</span>cxx-example</span><br><span class="line"><span class="string">CPack:</span> Create <span class="keyword">package</span></span><br><span class="line"><span class="string">CPack:</span> - <span class="string">package:</span> <span class="regexp">/home/</span>user<span class="regexp">/cmake-cookbook/</span>chapter<span class="number">-11</span><span class="regexp">/recipe-01/</span>cxx-example<span class="regexp">/build/</span>recipe<span class="number">-01</span>- <span class="number">1.0</span><span class="number">.0</span>-Source.tar.gz generated.</span><br></pre></td></tr></table></figure>
<p>同样，也可以构建二进制包:</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cmake --build . --<span class="keyword">target</span> <span class="keyword">package</span> message<span class="number">-1.0</span><span class="number">.0</span>-Linux.deb</span><br></pre></td></tr></table></figure>
<p>例子中，最后得到了以下二进制包:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">message-1</span><span class="selector-class">.0</span><span class="selector-class">.0-Linux</span><span class="selector-class">.rpm</span></span><br><span class="line"><span class="selector-tag">message-1</span><span class="selector-class">.0</span><span class="selector-class">.0-Linux</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line"><span class="selector-tag">message-1</span><span class="selector-class">.0</span><span class="selector-class">.0-Linux</span><span class="selector-class">.zip</span></span><br></pre></td></tr></table></figure>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>CPack可用于生成用于分发的包。生成构建系统时，我们在<code>CMakeCPack.cmake</code>中列出了CPack指令，用于在构建目录下生成<code>CPackConfig.cmake</code>。当运行以<code>package</code>或<code>package_source</code>目标的CMake命令时，CPack会自动调用，参数是自动生成的配置文件。实际上，这两个新目标是对CPack简单规则的使用。与CMake一样，CPack也有生成器的概念。CMake上下文中的生成器是用于生成本地构建脚本的工具，例如Unix Makefile或Visual Studio项目文件，而CPack上下文中的生成器是用于打包的工具。我们列出了这些变量，并对不同的平台进行了特别的关注，为源包和二进制包定义了<code>CPACK_SOURCE_GENERATOR</code>和<code>CPACK_GENERATOR</code>变量。因此，<code>DEB</code>包生成器将调用<code>Debian</code>打包实用程序，而<code>TGZ</code>生成器将调用给定平台上的归档工具。我们可以直接在<code>build</code>目录中调用CPack，并选择要与<code>-G</code>命令行选项一起使用的生成器。<code>RPM</code>包可以通过以下步骤生成:</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cd build</span><br><span class="line">$ cpack -G RPM</span><br><span class="line"></span><br><span class="line"><span class="string">CPack:</span> Create <span class="keyword">package</span> using RPM</span><br><span class="line"><span class="string">CPack:</span> Install projects</span><br><span class="line"><span class="string">CPack:</span> - Run preinstall target <span class="string">for:</span> recipe<span class="number">-01</span></span><br><span class="line"><span class="string">CPack:</span> - Install <span class="string">project:</span> recipe<span class="number">-01</span></span><br><span class="line"><span class="string">CPack:</span> Create <span class="keyword">package</span></span><br><span class="line"><span class="string">CPackRPM:</span> Will use GENERATED spec <span class="string">file:</span> <span class="regexp">/home/</span>user<span class="regexp">/cmake-cookbook/</span>chapter<span class="number">-11</span><span class="regexp">/recipe-01/</span>cxx-example<span class="regexp">/build/</span>_CPack_Packages<span class="regexp">/Linux/</span>RPM<span class="regexp">/SPECS/</span>recipe<span class="number">-01.</span>spec</span><br><span class="line"><span class="string">CPack:</span> - <span class="string">package:</span> <span class="regexp">/home/</span>user<span class="regexp">/cmake-cookbook/</span>chapter<span class="number">-11</span><span class="regexp">/recipe-01/</span>cxx-example<span class="regexp">/build/</span>recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux.rpm generated.</span><br></pre></td></tr></table></figure>
<p>对于任何发行版，无论是源代码还是二进制文件，我们只需要打包用户需要的内容，因此整个构建目录和其他与版本控制相关的文件，都必须从要打包的文件列表中排除。我们的例子中，排除列表使用下面的命令声明：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="builtin-name">set</span>(CPACK_SOURCE_IGNORE_FILES <span class="string">"<span class="variable">$&#123;PROJECT_BINARY_DIR&#125;</span>;/.git/;.gitignore"</span>)</span><br></pre></td></tr></table></figure>
<p>我们还需要指定包的基本信息，例如：名称、简短描述和版本。这个信息是通过CMake变量设置的，当包含相应的模块时，CMake变量被传递给CPack。</p>
<p><strong>NOTE</strong>:<em>由于CMake 3.9中的<code>project()</code>命令接受<code>DESCRIPTION</code>字段，该字段带有一个描述项目的短字符串。CMake将设置一个<code>PROJECT_DESCRIPTION</code>，可以用它来重置<code>CPACK_PACKAGE_DESCRIPTION_SUMMARY</code>。</em></p>
<p>让我们详细看看，可以为示例项目生成的不同类型包的说明。</p>
<h3 id="打包源码"><a href="#打包源码" class="headerlink" title="打包源码"></a>打包源码</h3><p>我们的示例中，决定对源存档使用<code>TGZ</code>和<code>ZIP</code>生成器。这些文件将分别生成<code>.tar.gz</code>和<code>.zip</code>压缩文件。我们可以检查生成的<code>.tar.gz</code>文件的内容:</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ tar tzf recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source.tar.gz</span><br><span class="line"></span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/cmake/</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/cmake/coffee.icns</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/cmake/Info.plist.in</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/cmake/messageConfig.cmake.in</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/CMakeLists.txt</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/src/</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/src/Message.hpp</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/src/CMakeLists.txt</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/src/Message.cpp</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/src/hello-world.cpp</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/LICENSE</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/tests/</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/tests/CMakeLists.txt</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/tests/use_target/</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/tests/use_target/CMakeLists.txt</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/tests/use_target/use_message.cpp</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Source/opt/recipe<span class="number">-01</span>/INSTALL.md</span><br></pre></td></tr></table></figure>
<p>与预期相同，只包含源码树的内容。注意<code>INSTALL.md</code>和<code>LICENSE</code>文件也包括在内，可以通过<code>CPACK_PACKAGE_DESCRIPTION_FILE</code>和<code>CPACK_RESOURCE_FILE_LICENSE</code>变量指定。</p>
<p><strong>NOTE</strong>:<em>Visual Studio生成器无法解析<code>package_source</code>目标:<a href="https://gitlab.kitware.com/cmake/cmake/issues/13058。" target="_blank" rel="noopener">https://gitlab.kitware.com/cmake/cmake/issues/13058。</a></em></p>
<h3 id="二进制包"><a href="#二进制包" class="headerlink" title="二进制包"></a>二进制包</h3><p>创建二进制存档时，CPack将打包<code>CMakeCPack.cmake</code>中描述的目标的内容。因此，在我们的示例中，hello-world可执行文件、消息动态库以及相应的头文件都将以<code>.tar.gz</code>和<code>.zip</code>的格式打包。此外，还将打包CMake配置文件。这对于需要链接到我们的库的其他项目非常有用。包中使用的安装目录可能与从构建树中安装项目时使用的前缀不同，可以使用<code>CPACK_PACKAGING_INSTALL_PREFIX</code>变量来实现这一点。我们的示例中，我们将它设置为系统上的特定位置:<code>/opt/recipe-01</code>。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ tar tzf recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux.tar.gz</span><br><span class="line"></span><br><span class="line">recipe<span class="number">-01</span>- <span class="number">1.0</span><span class="number">.0</span>-Linux/opt/</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux/opt/recipe<span class="number">-01</span>/</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>- Linux/opt/recipe<span class="number">-01</span>/bin/</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux/opt/recipe<span class="number">-01</span>/bin/hello- world</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux/opt/recipe<span class="number">-01</span>/share/</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>- Linux/opt/recipe<span class="number">-01</span>/share/cmake/</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux/opt/recipe- <span class="number">01</span>/share/cmake/recipe<span class="number">-01</span>/</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux/opt/recipe- <span class="number">01</span>/share/cmake/recipe<span class="number">-01</span>/messageConfig.cmake</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>- Linux/opt/recipe<span class="number">-01</span>/share/cmake/recipe<span class="number">-01</span>/messageTargets-hello- world.cmake</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux/opt/recipe<span class="number">-01</span>/share/cmake/recipe- <span class="number">01</span>/messageConfigVersion.cmake</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux/opt/recipe- <span class="number">01</span>/share/cmake/recipe<span class="number">-01</span>/messageTargets-hello-world- release.cmake</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux/opt/recipe<span class="number">-01</span>/share/cmake/recipe- <span class="number">01</span>/messageTargets-release.cmake</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux/opt/recipe- <span class="number">01</span>/share/cmake/recipe<span class="number">-01</span>/messageTargets.cmake</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>- Linux/opt/recipe<span class="number">-01</span>/include/</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux/opt/recipe- <span class="number">01</span>/include/message/</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux/opt/recipe- <span class="number">01</span>/include/message/Message.hpp</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux/opt/recipe- <span class="number">01</span>/include/message/messageExport.h</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux/opt/recipe- <span class="number">01</span>/lib64/</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux/opt/recipe- <span class="number">01</span>/lib64/libmessage.so</span><br><span class="line">recipe<span class="number">-01</span><span class="number">-1.0</span><span class="number">.0</span>-Linux/opt/recipe- <span class="number">01</span>/lib64/libmessage.so<span class="number">.1</span>`</span><br></pre></td></tr></table></figure>
<h3 id="平台原生的二进制安装"><a href="#平台原生的二进制安装" class="headerlink" title="平台原生的二进制安装"></a>平台原生的二进制安装</h3><p>我们希望每个平台原生二进制安装程序的配置略有不同。可以在单个<code>CMakeCPack.cmake</code>中使用CPack管理这些差异，就像例子中做的那样。</p>
<p>对于GNU/Linux系统，配置了<code>DEB</code>和<code>RPM</code>生成器:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if(<span class="name">UNIX</span>)</span><br><span class="line">  if(<span class="name">CMAKE_SYSTEM_NAME</span> MATCHES Linux)</span><br><span class="line">    list(<span class="name">APPEND</span> CPACK_GENERATOR <span class="string">"DEB"</span>)</span><br><span class="line">    set(<span class="name">CPACK_DEBIAN_PACKAGE_MAINTAINER</span> <span class="string">"robertodr"</span>)</span><br><span class="line">    set(<span class="name">CPACK_DEBIAN_PACKAGE_SECTION</span> <span class="string">"devel"</span>)</span><br><span class="line">    set(<span class="name">CPACK_DEBIAN_PACKAGE_DEPENDS</span> <span class="string">"uuid-dev"</span>)</span><br><span class="line">    </span><br><span class="line">    list(<span class="name">APPEND</span> CPACK_GENERATOR <span class="string">"RPM"</span>)</span><br><span class="line">    set(<span class="name">CPACK_RPM_PACKAGE_RELEASE</span> <span class="string">"1"</span>)</span><br><span class="line">    set(<span class="name">CPACK_RPM_PACKAGE_LICENSE</span> <span class="string">"MIT"</span>)</span><br><span class="line">    set(<span class="name">CPACK_RPM_PACKAGE_REQUIRES</span> <span class="string">"uuid-devel"</span>)</span><br><span class="line">  endif()</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
<p>我们的示例依赖于UUID库，<code>CPACK_DEBIAN_PACKAGE_DEPENDS</code>和<code>cpack_rpm_package_require</code>选项允许指定，包和数据库中对其他包的依赖关系。可以使用dpkg和rpm程序分别分析生成的<code>.deb</code>和<code>.rpm</code>包的内容。</p>
<p>注意，<code>CPACK_PACKAGING_INSTALL_PREFIX</code>也会影响这些包生成器：我们的包将安装到<code>/opt/recipe-01</code>。</p>
<p>CMake真正提供了跨平台和可移植构建系统的支持。下面将使用Nullsoft脚本安装系统(NSIS)创建一个安装程序:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if(<span class="name">WIN32</span> OR MINGW)</span><br><span class="line">  list(<span class="name">APPEND</span> CPACK_GENERATOR <span class="string">"NSIS"</span>)</span><br><span class="line">  set(<span class="name">CPACK_NSIS_PACKAGE_NAME</span> <span class="string">"message"</span>)</span><br><span class="line">  set(<span class="name">CPACK_NSIS_CONTACT</span> <span class="string">"robertdr"</span>)</span><br><span class="line">  set(<span class="name">CPACK_NSIS_ENABLE_UNINSTALL_BEFORE_INSTALL</span> ON)</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
<p>如果在macOS上构建项目，将启用<code>Bundle packager</code>:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if(<span class="name">APPLE</span>)</span><br><span class="line">  list(<span class="name">APPEND</span> CPACK_GENERATOR <span class="string">"Bundle"</span>)</span><br><span class="line">  set(<span class="name">CPACK_BUNDLE_NAME</span> <span class="string">"message"</span>)</span><br><span class="line">  configure_file($&#123;PROJECT_SOURCE_DIR&#125;/cmake/Info.plist.in Info.plist @ONLY)</span><br><span class="line">  set(<span class="name">CPACK_BUNDLE_PLIST</span> $&#123;CMAKE_CURRENT_BINARY_DIR&#125;/Info.plist)</span><br><span class="line">  set(<span class="name">CPACK_BUNDLE_ICON</span> $&#123;PROJECT_SOURCE_DIR&#125;/cmake/coffee.icns)</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
<p>macOS的示例中，需要为包配置属性列表文件，这是通过<code>configure_file</code>实现的。<code>Info.plist</code>的位置和包的图标，这些都可以通过CPack的变量进行设置。</p>
<p><strong>NOTE</strong>:<em>可以在这里阅读，关于属性列表格式的更多信息:<a href="https://en.wikipedia.org/wiki/Property_list" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Property_list</a></em></p>
<h2 id="更多信息"><a href="#更多信息" class="headerlink" title="更多信息"></a>更多信息</h2><p>对<code>CMakeCPack.cmake</code>进行设置，要比列出CPack的配置选项简单的多，我们可以将<code>CPACK_*</code>变量的每个生成器设置放在单独的文件中，比如<code>CMakeCPackOptions.cmake</code>，并将这些设置包含到<code>CMakeCPack.cmake</code>使用<code>set(CPACK_PROJECT_CONFIG_FILE &quot;${PROJECT_SOUsRCE_DIR}/CMakeCPackOptions.cmake&quot;)</code>将设置包含入<code>CMakeCPack.cmake</code>中。还可以在CMake时配置该文件，然后在CPack时包含该文件，这为配置多格式包生成器提供了一种简洁的方法(参见<a href="https://cmake.org/cmake/help/v3.6/module/CPack.html" target="_blank" rel="noopener">https://cmake.org/cmake/help/v3.6/module/CPack.html</a> )。</p>
<p>与CMake中的所有工具一样，CPack功能强大、功能多样，并且提供了更多的灵活性和选项。感兴趣的读者应该看官方文档的命令行界面CPack (<a href="https://cmake.org/cmake/help/v3.6/manual/cpack.1.html" target="_blank" rel="noopener">https://cmake.org/cmake/help/v3.6/manual/cpack.1.html</a> )手册页，如何使用CPack生成器打包相关项目的更多细节(<a href="https://cmake.org/cmake/help/v3.6/module/CPack.html" target="_blank" rel="noopener">https://cmake.org/cmake/help/v3.6/module/CPack.html</a> )。</p>
<h1 id="11-2-通过PyPI发布使用CMake-pybind11构建的C-Python项目"><a href="#11-2-通过PyPI发布使用CMake-pybind11构建的C-Python项目" class="headerlink" title="11.2 通过PyPI发布使用CMake/pybind11构建的C++/Python项目"></a>11.2 通过PyPI发布使用CMake/pybind11构建的C++/Python项目</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-11/recipe-02" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-11/recipe-02</a> 中找到。该示例在CMake 3.11版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>本示例中，我们将以第9章第5节的代码的pybind11为例，为其添加相关的安装目标和pip打包信息，并将项目上传到PyPI。我们要实现一个可以使用pip安装，并运行CMake从而获取底层pybind11依赖项的项目。</p>
<h2 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h2><p>要通过PyPI分发包的话，需要一个<a href="https://pypi.org/" target="_blank" rel="noopener">https://pypi.org</a> 帐户。当然，也可以先从本地路径进行安装练习。</p>
<p><strong>TIPS</strong>:<em>建议使用Pipenv (<a href="https://docs.pipenv.org/" target="_blank" rel="noopener">https://docs.pipenv.org</a> )或虚拟环境(<a href="https://virtualenv.pypa/" target="_blank" rel="noopener">https://virtualenv.pypa</a> )安装这个包和其他的Python包。</em></p>
<p>我们基于第9章第5节的项目，它包含一个主<code>CMakeLists.txt</code>文件和一个<code>account/CMakeLists.txt</code>文件，配置帐户示例目标时，使用如下的项目树：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── account</span><br><span class="line">│    ├── account.cpp</span><br><span class="line">│    ├── account.hpp</span><br><span class="line">│    ├── CMakeLists.txt</span><br><span class="line">│    s└── test.py</span><br><span class="line">└── CMakeLists.txt</span><br></pre></td></tr></table></figure>
<p>示例中，<code>account.cpp</code>,<code>account.hpp</code>和<code>test.py</code>没有任何变化。修改<code>account/CMakeLists.txt</code>，并为pip添加几个文件，以便能够构建安装包。为此，需要根目录中的另外三个文件：<code>README.rst</code>，<code>MANIFEST.in</code>和<code>setup.py</code>。</p>
<p><code>README.rst</code>中包含关于项目的s文档：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Example project</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">Project description in here ...</span><br></pre></td></tr></table></figure>
<p><code>MANIFEST.in</code>列出了需要安装的Python模块：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">include README<span class="selector-class">.rst</span> CMakeLists.txt</span><br><span class="line">recursive-include account *<span class="selector-class">.cpp</span> *<span class="selector-class">.hpp</span> CMakeLists.txt</span><br></pre></td></tr></table></figure>
<p>最后，<code>setup.py</code>包含构建指令和安装项目的说明：</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">import distutils.command.build as <span class="variable">_build</span></span><br><span class="line">import os</span><br><span class="line">import sys</span><br><span class="line"><span class="keyword">from</span> distutils import <span class="built_in">spawn</span></span><br><span class="line"><span class="keyword">from</span> distutils.sysconfig import get_python_lib</span><br><span class="line"><span class="keyword">from</span> setuptools import setup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def extend_build():</span><br><span class="line">  class build(<span class="variable">_build</span>.build):</span><br><span class="line">    def run(self):</span><br><span class="line">      cwd = os.getcwd()</span><br><span class="line">      <span class="keyword">if</span> <span class="built_in">spawn</span>.find_executable(<span class="string">'cmake'</span>) is None:</span><br><span class="line">        sys.stderr.write(<span class="string">"CMake is required to build this package.\n"</span>)</span><br><span class="line">        sys.<span class="keyword">exit</span>(-<span class="number">1</span>)</span><br><span class="line">        <span class="variable">_source_dir</span> = os.path.split(<span class="variable">__file__</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="variable">_build_dir</span> = os.path.<span class="built_in">join</span>(<span class="variable">_source_dir</span>, <span class="string">'build_setup_py'</span>)</span><br><span class="line">        <span class="variable">_prefix</span> = get_python_lib()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">          cmake_configure_command = [</span><br><span class="line">              <span class="string">'cmake'</span>,</span><br><span class="line">              <span class="string">'-H&#123;0&#125;'</span>.<span class="built_in">format</span>(<span class="variable">_source_dir</span>),</span><br><span class="line">              <span class="string">'-B&#123;0&#125;'</span>.<span class="built_in">format</span>(<span class="variable">_build_dir</span>),</span><br><span class="line">              <span class="string">'-DCMAKE_INSTALL_PREFIX=&#123;0&#125;'</span>.<span class="built_in">format</span>(<span class="variable">_prefix</span>),</span><br><span class="line">          ]</span><br><span class="line">          <span class="variable">_generator</span> = os.getenv(<span class="string">'CMAKE_GENERATOR'</span>)</span><br><span class="line">          <span class="keyword">if</span> <span class="variable">_generator</span> is <span class="built_in">not</span> None:</span><br><span class="line">            cmake_configure_command.<span class="built_in">append</span>(<span class="string">'-</span></span><br><span class="line"><span class="string">                                          G&#123;0&#125;'</span>.<span class="built_in">format</span>(<span class="variable">_generator</span>))</span><br><span class="line">          <span class="built_in">spawn</span>.<span class="built_in">spawn</span>(cmake_configure_command)</span><br><span class="line">          <span class="built_in">spawn</span>.<span class="built_in">spawn</span>(</span><br><span class="line">                [<span class="string">'cmake'</span>, <span class="string">'--build'</span>, <span class="variable">_build_dir</span>, <span class="string">'--target'</span>, <span class="string">'install'</span>])</span><br><span class="line">          os.chdir(cwd)</span><br><span class="line">        except <span class="built_in">spawn</span>.DistutilsExecError:</span><br><span class="line">          sys.stderr.write(<span class="string">"Error while building with CMake\n"</span>)</span><br><span class="line">          sys.<span class="keyword">exit</span>(-<span class="number">1</span>)</span><br><span class="line">          <span class="variable">_build</span>.build.run(self)</span><br><span class="line">  return build</span><br><span class="line"></span><br><span class="line"><span class="variable">_here</span> = os.path.abspath(os.path.dirname(<span class="variable">__file__</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> sys.version_info[<span class="number">0</span>] &lt; <span class="number">3</span>:</span><br><span class="line">  <span class="keyword">with</span> open(os.path.<span class="built_in">join</span>(<span class="variable">_here</span>, <span class="string">'README.rst'</span>)) as f:</span><br><span class="line">    long_description = f.read()</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  <span class="keyword">with</span> open(os.path.<span class="built_in">join</span>(<span class="variable">_here</span>, <span class="string">'README.rst'</span>), encoding=<span class="string">'utf-8'</span>) as f:</span><br><span class="line">    long_description = f.read()</span><br><span class="line"></span><br><span class="line"><span class="variable">_this_package</span> = <span class="string">'account'</span></span><br><span class="line"></span><br><span class="line">version = &#123;&#125;</span><br><span class="line"><span class="keyword">with</span> open(os.path.<span class="built_in">join</span>(<span class="variable">_here</span>, <span class="variable">_this_package</span>, <span class="string">'version.py'</span>)) as f:</span><br><span class="line">  <span class="built_in">exec</span>(f.read(), version)</span><br><span class="line">  </span><br><span class="line">setup(</span><br><span class="line">    <span class="built_in">name</span>=<span class="variable">_this_package</span>,</span><br><span class="line">    version=version[<span class="string">'__version__'</span>],</span><br><span class="line">    description=<span class="string">'Description in here.'</span>,</span><br><span class="line">    long_description=long_description,</span><br><span class="line">    author=<span class="string">'Bruce Wayne'</span>,</span><br><span class="line">    author_email=<span class="string">'bruce.wayne@example.com'</span>,</span><br><span class="line">    url=<span class="string">'http://example.com'</span>,</span><br><span class="line">    license=<span class="string">'MIT'</span>,</span><br><span class="line">    packages=[<span class="variable">_this_package</span>],</span><br><span class="line">    include_package_data=<span class="literal">True</span>,</span><br><span class="line">    classifiers=[</span><br><span class="line">        <span class="string">'Development Status :: 3 - Alpha'</span>,</span><br><span class="line">        <span class="string">'Intended Audience :: Science/Research'</span>,</span><br><span class="line">        <span class="string">'Programming Language :: Python :: 2.7'</span>,</span><br><span class="line">        <span class="string">'Programming Language :: Python :: 3.6'</span></span><br><span class="line">    ],</span><br><span class="line">    cmdclass=&#123;<span class="string">'build'</span>: extend_build()&#125;)</span><br></pre></td></tr></table></figure>
<p><code>account</code>子目录中放置一个<code>__init__.py</code>脚本：</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .version <span class="keyword">import</span> __version__</span><br><span class="line"><span class="keyword">from</span> .account <span class="keyword">import</span> Account</span><br><span class="line">__all__ = [</span><br><span class="line">  <span class="string">'__version__'</span>,</span><br><span class="line">  <span class="string">'Account'</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>再放一个<code>version.py</code>脚本：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">__version__</span> = <span class="string">'0.0.0'</span></span><br></pre></td></tr></table></figure>
<p>项目的文件结构如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── account</span><br><span class="line">│    ├── account.cpp</span><br><span class="line">│    ├── account.hpp</span><br><span class="line">│    ├── CMakeLists.txt</span><br><span class="line">│    ├── __init__.py</span><br><span class="line">│    ├── test.py</span><br><span class="line">│    └── version.py</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── MANIFEST.<span class="keyword">in</span></span><br><span class="line">├── README.rst</span><br><span class="line">└── setup.py</span><br></pre></td></tr></table></figure>
<h2 id="具体实施-1"><a href="#具体实施-1" class="headerlink" title="具体实施"></a>具体实施</h2><p>本示例基于第9章第5节项目的基础上。</p>
<p>首先，修改<code>account/CMakeLists.txt</code>，添加安装目标：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(</span><br><span class="line">  TARGETS</span><br><span class="line">  	<span class="keyword">account</span></span><br><span class="line">  <span class="keyword">LIBRARY</span></span><br><span class="line">  	DESTINATION <span class="keyword">account</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>安装目标时，<code>README.rst</code>, <code>MANIFEST.in</code>，<code>setup.py</code>、<code>__init__.py</code>和<code>version.py</code>将放置在对应的位置上，我们准备使用pybind11测试安装过程：</p>
<ol>
<li><p>为此，在某处创建一个新目录，我们将在那里测试安装。</p>
</li>
<li><p>在创建的目录中，从本地路径运行<code>pipenv install</code>。调整本地路径，指向<code>setup.py</code>的目录：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pipenv <span class="keyword">install</span> /<span class="keyword">path</span>/<span class="keyword">to</span>/cxx-example</span><br></pre></td></tr></table></figure>
</li>
<li><p>在Pipenv环境中打开一个Python shell：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pipenv <span class="keyword">run</span><span class="bash"> python</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Python shell中，可以测试我们的CMake包：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; from account import Account</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; account1 = Account()</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; account1.deposit(<span class="number">100.0</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; account1.deposit(<span class="number">100.0</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; account1.withdraw(<span class="number">50.0</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(account1.get_balance())</span><br><span class="line"><span class="number">150.0</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-1"><a href="#工作原理-1" class="headerlink" title="工作原理"></a>工作原理</h2><p><code>${CMAKE_CURRENT_BINARY_DIR}</code>目录包含编译后的<code>account.cpython-36m-x86_64-linux-gnu.so</code>，这个动态库就是使用pybind11构建Python模块。但是请注意，它的名称取决于操作系统(本例中是64位Linux)和Python环境(本例中是Python 3.6)。<code>setup.py</code>s脚本将运行CMake，并根据所选的Python环境(系统Python，Pipenv或虚拟环境)将Python模块安装到正确的路径下。</p>
<p>不过，在安装模块时面临两个挑战：</p>
<ul>
<li>名称可变</li>
<li>CMake外部设置路径</li>
</ul>
<p>可以使用下面的安装目标来解决这个问题，将在setup.py中定义安装目标位置：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">install</span>(</span><br><span class="line">  TARGETS</span><br><span class="line">  	<span class="keyword">account</span></span><br><span class="line">  <span class="keyword">LIBRARY</span></span><br><span class="line">  	DESTINATION <span class="keyword">account</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>指示CMake将编译好的Python模块文件安装到相对于安装目标位置的<code>account</code>子目录中(第10章中详细讨论了如何设置目标位置)。<code>setup.py</code>将通过设置<code>CMAKE_INSTALL_PREFIX</code>来设置安装位置，并根据Python环境指向正确的路径。</p>
<p>让我们看看<code>setup.py</code>如何实现的。自下而上来看一下脚本：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">setup(</span><br><span class="line">  name=_this_package,</span><br><span class="line">  version=version['__version__'],</span><br><span class="line">  description='Description in here.',</span><br><span class="line">  long_description=long_description,</span><br><span class="line">  author='Bruce Wayne',</span><br><span class="line">  author_email='bruce.wayne@example.com',</span><br><span class="line">  url='http<span class="symbol">://example</span>.com',</span><br><span class="line">  license='MIT',</span><br><span class="line">  packages=[_this_package],</span><br><span class="line">  include_package_data=True,</span><br><span class="line">  classifiers=[</span><br><span class="line">    'Development Status :: <span class="number">3</span> - Alpha',</span><br><span class="line">    'Intended Audience :: Science/Research',</span><br><span class="line">    'Programming Language :: Python :: <span class="number">2.7</span>',</span><br><span class="line">    'Programming Language :: Python :: <span class="number">3.6</span>'</span><br><span class="line">  ],</span><br><span class="line">  cmdclass=&#123;'build': extend_build()&#125;)</span><br></pre></td></tr></table></figure>
<p>该脚本包含许多占位符，还包含一些自解释的语句。这里我们将重点介绍最后一个指令<code>cmdclass</code>。这个指令中，通过自定义<code>extend_build</code>函数扩展默认的构建步骤。这个默认的构建步骤如下：</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">def extend_build():</span><br><span class="line">  class build(<span class="variable">_build</span>.build):</span><br><span class="line">    def run(self):</span><br><span class="line">      cwd = os.getcwd()</span><br><span class="line">      <span class="keyword">if</span> <span class="built_in">spawn</span>.find_executable(<span class="string">'cmake'</span>) is None:</span><br><span class="line">        sys.stderr.write(<span class="string">"CMake is required to build this package.\n"</span>)</span><br><span class="line">        sys.<span class="keyword">exit</span>(-<span class="number">1</span>)</span><br><span class="line">        <span class="variable">_source_dir</span> = os.path.split(<span class="variable">__file__</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="variable">_build_dir</span> = os.path.<span class="built_in">join</span>(<span class="variable">_source_dir</span>, <span class="string">'build_setup_py'</span>)</span><br><span class="line">        <span class="variable">_prefix</span> = get_python_lib()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">          cmake_configure_command = [</span><br><span class="line">              <span class="string">'cmake'</span>,</span><br><span class="line">              <span class="string">'-H&#123;0&#125;'</span>.<span class="built_in">format</span>(<span class="variable">_source_dir</span>),</span><br><span class="line">              <span class="string">'-B&#123;0&#125;'</span>.<span class="built_in">format</span>(<span class="variable">_build_dir</span>),</span><br><span class="line">              <span class="string">'-DCMAKE_INSTALL_PREFIX=&#123;0&#125;'</span>.<span class="built_in">format</span>(<span class="variable">_prefix</span>),</span><br><span class="line">          ]</span><br><span class="line">          <span class="variable">_generator</span> = os.getenv(<span class="string">'CMAKE_GENERATOR'</span>)</span><br><span class="line">          <span class="keyword">if</span> <span class="variable">_generator</span> is <span class="built_in">not</span> None:</span><br><span class="line">            cmake_configure_command.<span class="built_in">append</span>(<span class="string">'-</span></span><br><span class="line"><span class="string">                                          G&#123;0&#125;'</span>.<span class="built_in">format</span>(<span class="variable">_generator</span>))</span><br><span class="line">          <span class="built_in">spawn</span>.<span class="built_in">spawn</span>(cmake_configure_command)</span><br><span class="line">          <span class="built_in">spawn</span>.<span class="built_in">spawn</span>(</span><br><span class="line">                [<span class="string">'cmake'</span>, <span class="string">'--build'</span>, <span class="variable">_build_dir</span>, <span class="string">'--target'</span>, <span class="string">'install'</span>])</span><br><span class="line">          os.chdir(cwd)</span><br><span class="line">        except <span class="built_in">spawn</span>.DistutilsExecError:</span><br><span class="line">          sys.stderr.write(<span class="string">"Error while building with CMake\n"</span>)</span><br><span class="line">          sys.<span class="keyword">exit</span>(-<span class="number">1</span>)</span><br><span class="line">          <span class="variable">_build</span>.build.run(self)</span><br><span class="line">  return build</span><br></pre></td></tr></table></figure>
<p>首先，检查CMake是否可用。函数执行了两个CMake命令：</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">cmake_configure_command = [</span><br><span class="line">    <span class="string">'cmake'</span>,</span><br><span class="line">    <span class="string">'-H&#123;0&#125;'</span>.<span class="built_in">format</span>(<span class="variable">_source_dir</span>),</span><br><span class="line">    <span class="string">'-B&#123;0&#125;'</span>.<span class="built_in">format</span>(<span class="variable">_build_dir</span>),</span><br><span class="line">    <span class="string">'-DCMAKE_INSTALL_PREFIX=&#123;0&#125;'</span>.<span class="built_in">format</span>(<span class="variable">_prefix</span>),</span><br><span class="line">]</span><br><span class="line"><span class="variable">_generator</span> = os.getenv(<span class="string">'CMAKE_GENERATOR'</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="variable">_generator</span> is <span class="built_in">not</span> None:</span><br><span class="line">  cmake_configure_command.<span class="built_in">append</span>(<span class="string">'-</span></span><br><span class="line"><span class="string">                                G&#123;0&#125;'</span>.<span class="built_in">format</span>(<span class="variable">_generator</span>))</span><br><span class="line"><span class="built_in">spawn</span>.<span class="built_in">spawn</span>(cmake_configure_command)</span><br><span class="line"><span class="built_in">spawn</span>.<span class="built_in">spawn</span>(</span><br><span class="line">      [<span class="string">'cmake'</span>, <span class="string">'--build'</span>, <span class="variable">_build_dir</span>, <span class="string">'--target'</span>, <span class="string">'install'</span>])</span><br></pre></td></tr></table></figure>
<p>我们可以设置<code>CMAKE_GENERATOR</code>环境变量来修改生成器。安装目录如下方式设置：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">_prefix</span> = get_python_lib()</span><br></pre></td></tr></table></figure>
<p>从安装目录的根目录下，通过<code>distutils.sysconfig</code>导入<code>get_python_lib</code>函数。<code>cmake --build _build_dir --target install</code>命令以一种可移植的方式，构建和安装我们的项目。使用<code>_build_dir</code>而不使用<code>build</code>的原因是，在测试本地安装时，项目可能已经包含了一个<code>build</code>目录，这将与新安装过程发生冲突。对于已经上传到PyPI的包，构建目录的名称并不会带来什么影响。</p>
<h2 id="更多信息-1"><a href="#更多信息-1" class="headerlink" title="更多信息"></a>更多信息</h2><p>现在我们已经测试了本地安装，准备将包上传到PyPI。在此之前，请确保<code>setup.py</code>中的元数据(例如：项目名称、联系方式和许可协议信息)是合理的，并且项目名称没有与PyPI已存在项目重名。在上传到<a href="https://pypi.org/" target="_blank" rel="noopener">https://pypi.org</a> 之前，先测试PyPI(<a href="https://test.pypi.org/" target="_blank" rel="noopener">https://test.pypi.org</a> )上，进行上载和下载的尝试。</p>
<p>上传之前，我们需要在主目录中创建一个名为<code>.pypirc</code>的文件，其中包含(替换成自己的<code>yourusername</code>和<code>yourpassword</code>)：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[distutils]account</span><br><span class="line">index-servers=</span><br><span class="line">  pypi</span><br><span class="line">  pypitest</span><br><span class="line"></span><br><span class="line">[pypi]</span><br><span class="line">username = yourusername</span><br><span class="line">password = yourpassword</span><br><span class="line"></span><br><span class="line">[pypitest]</span><br><span class="line">repository = https://test.pypi.org/legacy/</span><br><span class="line">username = yourusername</span><br><span class="line">password = yourpassword</span><br></pre></td></tr></table></figure>
<p>我们将分两步进行。首先，我们在本地创建Release包：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python setup<span class="selector-class">.py</span> sdist</span><br></pre></td></tr></table></figure>
<p>第二步中，使用Twine上传生成的分布数据(我们将Twine安装到本地的Pipenv中):</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ pipenv <span class="keyword">run</span><span class="bash"> twine upload dist/* -r pypitest</span></span><br><span class="line"></span><br><span class="line">Uploading distributions to https://test.pypi.org/legacy/</span><br><span class="line">Uploading yourpackage-<span class="number">0.0</span>.<span class="number">0</span>.tar.gz</span><br></pre></td></tr></table></figure>
<p>下一步，从测试实例到，将包安装到一个隔离的环境中：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>pipenv shell</span><br><span class="line"><span class="variable">$ </span>pip install --index-url <span class="symbol">https:</span>/<span class="regexp">/test.pypi.org/simple</span><span class="regexp">/ yourpackage</span></span><br></pre></td></tr></table></figure>
<p>当一切正常，就将我们的包上传到了PyPI：</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pipenv <span class="keyword">run</span><span class="bash"> twine upload dist/* -r pypi</span></span><br></pre></td></tr></table></figure>
<h1 id="11-3-通过PyPI发布使用CMake-CFFI构建C-Fortran-Python项目"><a href="#11-3-通过PyPI发布使用CMake-CFFI构建C-Fortran-Python项目" class="headerlink" title="11.3 通过PyPI发布使用CMake/CFFI构建C/Fortran/Python项目"></a>11.3 通过PyPI发布使用CMake/CFFI构建C/Fortran/Python项目</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-11/recipe-03" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-11/recipe-03</a> 中找到，其中有一个C++和Fortran示例。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>基于第9章第6节的示例，我们将重用前一个示例中的构建块，不过这次使用Python CFFI来提供Python接口，而不是pybind11。这个示例中，我们通过PyPI共享一个Fortran项目，这个项目可以是C或C++项目，也可以是任何公开C接口的语言，非Fortran就可以。</p>
<h2 id="准备工作-2"><a href="#准备工作-2" class="headerlink" title="准备工作"></a>准备工作</h2><p>项目将使用如下的目录结构：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── account</span><br><span class="line">│    ├── account.h</span><br><span class="line">│    ├── CMakeLists.txt</span><br><span class="line">│    ├── implementation</span><br><span class="line">│    │    └── fortran_implementation.f90</span><br><span class="line">│    ├── __init__.py</span><br><span class="line">│    ├── interface_file_names<span class="selector-class">.cfg</span><span class="selector-class">.in</span></span><br><span class="line">│    ├── test.py</span><br><span class="line">│    └── version.py</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── MANIFEST.<span class="keyword">in</span></span><br><span class="line">├── README.rst</span><br><span class="line">└── setup.py</span><br></pre></td></tr></table></figure>
<p>主<code>CMakeLists.txt</code>文件和<code>account</code>下面的所有源文件(<code>account/CMakeLists.txt</code>除外)与第9章中的使用方式相同。<code>README.rst</code>文件与前面的示例相同。<code>setup.py</code>脚本比上一个示例多了一行(包含<code>install_require =[&#39;cffi&#39;]</code>的那一行):</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># ... <span class="keyword">up</span> <span class="keyword">to</span> this <span class="built_in">line</span> the script <span class="keyword">is</span> unchanged</span><br><span class="line">setup(</span><br><span class="line">  name=_this_package,</span><br><span class="line">  <span class="keyword">version</span>=<span class="keyword">version</span>[<span class="string">'__version__'</span>],</span><br><span class="line">  description=<span class="string">'Description in here.'</span>,</span><br><span class="line">  long_description=long_description,</span><br><span class="line">  author=<span class="string">'Bruce Wayne'</span>,</span><br><span class="line">  author_email=<span class="string">'bruce.wayne@example.com'</span>,</span><br><span class="line">  url=<span class="string">'http://example.com'</span>,</span><br><span class="line">  license=<span class="string">'MIT'</span>,</span><br><span class="line">  packages=[_this_package],</span><br><span class="line">  install_requires=[<span class="string">'cffi'</span>],</span><br><span class="line">  include_package_data=True,</span><br><span class="line">  classifiers=[</span><br><span class="line">    <span class="string">'Development Status :: 3 - Alpha'</span>,</span><br><span class="line">    <span class="string">'Intended Audience :: Science/Research'</span>,</span><br><span class="line">    <span class="string">'Programming Language :: Python :: 2.7'</span>,</span><br><span class="line">    <span class="string">'Programming Language :: Python :: 3.6'</span></span><br><span class="line">  ],</span><br><span class="line">  cmdclass=&#123;<span class="string">'build'</span>: extend_build()&#125;)</span><br></pre></td></tr></table></figure>
<p><code>MANIFEST.in</code>应该与Python模块和包一起安装，并包含以下内容:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">include README<span class="selector-class">.rst</span> CMakeLists.txt</span><br><span class="line">recursive-include account *<span class="selector-class">.h</span> *<span class="selector-class">.f90</span> CMakeLists.txt</span><br></pre></td></tr></table></figure>
<p><code>account</code>子目录下，我们看到两个新文件。一个<code>version.py</code>文件，其为<code>setup.py</code>保存项目的版本信息：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">__version__</span> = <span class="string">'0.0.0'</span></span><br></pre></td></tr></table></figure>
<p>子目录还包含<code>interface_file_names.cfg.in</code>文件:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[configuration]</span></span><br><span class="line"><span class="attr">header_file_name</span> = account.h</span><br><span class="line"><span class="attr">library_file_name</span> = $&lt;TARGET_FILE_NAME:account&gt;</span><br></pre></td></tr></table></figure>
<h2 id="具体实施-2"><a href="#具体实施-2" class="headerlink" title="具体实施"></a>具体实施</h2><p>讨论一下实现打包的步骤：</p>
<ol>
<li><p>示例基于第9章第6节，使用Python CFFI扩展了<code>account/CMakeLists.txt</code>，增加以下指令:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">file(</span><br><span class="line">  GENERATE OUTPUT <span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/interface_file_names.cfg</span><br><span class="line">  INPUT <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/interface_file_names.cfg.<span class="keyword">in</span></span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">set_target_properties(account</span><br><span class="line">  PROPERTIES</span><br><span class="line">    PUBLIC_HEADER <span class="string">"account.h;<span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/account_export.h"</span></span><br><span class="line">   <span class="built_in"> RESOURCE </span><span class="string">"<span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/interface_file_names.cfg"</span></span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">install(</span><br><span class="line">  TARGETS</span><br><span class="line">    account</span><br><span class="line">  LIBRARY</span><br><span class="line">    DESTINATION account/lib</span><br><span class="line">  RUNTIME</span><br><span class="line">    DESTINATION account/lib</span><br><span class="line">  PUBLIC_HEADER</span><br><span class="line">    DESTINATION account/include</span><br><span class="line">  RESOURCE</span><br><span class="line">    DESTINATION account</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>安装目标和附加文件准备好之后，就可以测试安装了。为此，会在某处创建一个新目录，我们将在那里测试安装。</p>
</li>
<li><p>新创建的目录中，我们从本地路径运行pipenv install。调整本地路径，指向<code>setup.py</code>脚本保存的目录:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pipenv <span class="keyword">install</span> /<span class="keyword">path</span>/<span class="keyword">to</span>/fortran-example</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在在Pipenv环境中生成一个Python shell:</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pipenv <span class="keyword">run</span><span class="bash"> python</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Python shell中，可以测试CMake包:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;</span>&gt; import account</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; account1 = account.new()</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; account.deposit(account1, <span class="number">100.0</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; account.deposit(account1, <span class="number">100.0</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; account.withdraw(account1, <span class="number">50.0</span>)</span><br><span class="line"><span class="meta">&gt;&gt;</span>&gt; print(account.get_balance(account1))</span><br><span class="line"></span><br><span class="line"><span class="number">150.0</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-2"><a href="#工作原理-2" class="headerlink" title="工作原理"></a>工作原理</h2><p>使用Python CFFI和CMake安装混合语言项目的扩展与第9章第6节的例子相对比，和使用Python CFFI的Python包多了两个额外的步骤:</p>
<ol>
<li>需要<code>setup.py</code>s</li>
<li>安装目标时，CFFI所需的头文件和动态库文件，需要安装在正确的路径中，具体路径取决于所选择的Python环境</li>
</ol>
<p><code>setup.py</code>的结构与前面的示例几乎一致，唯一的修改是包含<code>install_require =[&#39;cffi&#39;]</code>，以确保安装示例包时，也获取并安装了所需的Python CFFI。<code>setup.py</code>脚本会自动安装<code>__init__.py</code>和<code>version.py</code>。<code>MANIFEST.in</code>中的改变不仅有<code>README.rst</code>和CMake文件，还有头文件和Fortran源文件:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">include README<span class="selector-class">.rst</span> CMakeLists.txt</span><br><span class="line">recursive-include account *<span class="selector-class">.h</span> *<span class="selector-class">.f90</span> CMakeLists.txt</span><br></pre></td></tr></table></figure>
<p>这个示例中，使用Python CFFI和<code>setup.py</code>打包CMake项目时，我们会面临三个挑战:</p>
<ul>
<li>需要将<code>account.h</code>和<code>account_export.h</code>头文件，以及动态库复制到系统环境中Python模块的位置。</li>
<li>需要告诉<code>__init__.py</code>，在哪里可以找到这些头文件和库。第9章第6节中，我们使用环境变量解决了这些问题，不过使用Python模块时，不可能每次去都设置这些变量。</li>
<li>Python方面，我们不知道动态库文件的确切名称(后缀)，因为这取决于操作系统。</li>
</ul>
<p>让我们从最后一点开始说起：不知道确切的名称，但在CMake生成构建系统时是知道的，因此我们在<code>interface_file_names.cfg,in</code>中使用生成器表达式，对占位符进行展开：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[configuration]</span></span><br><span class="line"><span class="attr">header_file_name</span> = account.h</span><br><span class="line"><span class="attr">library_file_name</span> = $&lt;TARGET_FILE_NAME:account&gt;</span><br></pre></td></tr></table></figure>
<p>输入文件用来生成<code>${CMAKE_CURRENT_BINARY_DIR}/interface_file_names.cfg</code>：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">file</span>(</span><br><span class="line">  <span class="keyword">GENERATE</span> OUTPUT <span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/interface_file_names.cfg</span><br><span class="line">  <span class="keyword">INPUT</span> <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/interface_file_names.cfg.<span class="keyword">in</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>然后，将两个头文件定义为<code>PUBLIC_HEADER</code>(参见第10章)，配置文件定义为<code>RESOURCE</code>：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set_target_properties(account</span><br><span class="line">  PROPERTIES</span><br><span class="line">  	PUBLIC_HEADER <span class="string">"account.h;<span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/account_export.h"</span></span><br><span class="line">  <span class="built_in">	RESOURCE </span><span class="string">"<span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/interface_file_names.cfg"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>最后，将库、头文件和配置文件安装到<code>setup.py</code>定义的安装路径中:</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">install(</span><br><span class="line">  TARGETS</span><br><span class="line">  	account</span><br><span class="line">  LIBRARY</span><br><span class="line">  	DESTINATION account/<span class="class"><span class="keyword">lib</span></span></span><br><span class="line">  RUNTIME</span><br><span class="line">  	DESTINATION account/<span class="class"><span class="keyword">lib</span></span></span><br><span class="line">  PUBLIC_HEADER</span><br><span class="line">  	DESTINATION account/<span class="keyword">include</span></span><br><span class="line">  RESOURCE</span><br><span class="line">  	DESTINATION account</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>注意，我们为库和运行时都设置了指向<code>account/lib</code>的目标。这对于Windows很重要，因为动态库具有可执行入口点，因此我们必须同时指定这两个入口点。</p>
<p>Python包将能够找到这些文件，要使用<code>account/__init__.py</code>来完成：</p>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># this interface requires the header file and library file</span></span><br><span class="line"><span class="meta"># and these can be either provided by interface_file_names.cfg</span></span><br><span class="line"><span class="meta"># in the same path as this file</span></span><br><span class="line"><span class="meta"># or <span class="meta-keyword">if</span> this is not found then using environment variables</span></span><br><span class="line"><span class="variable">_this_path</span> = Path(os.path.dirname(os.path.realpath(<span class="variable">__file__</span>)))</span><br><span class="line"><span class="variable">_cfg_file</span> = <span class="variable">_this_path</span> / <span class="string">'interface_file_names.cfg'</span></span><br><span class="line"><span class="keyword">if</span> <span class="variable">_cfg_file</span>.exists():</span><br><span class="line">  config = ConfigParser()</span><br><span class="line">  config.read(<span class="variable">_cfg_file</span>)</span><br><span class="line">  header_file_name = config.get(<span class="string">'configuration'</span>, <span class="string">'header_file_name'</span>)</span><br><span class="line">  <span class="variable">_header_file</span> = <span class="variable">_this_path</span> / <span class="string">'include'</span> / header_file_name</span><br><span class="line">  <span class="variable">_header_file</span> = <span class="built_in">str</span>(<span class="variable">_header_file</span>)</span><br><span class="line">  library_file_name = config.get(<span class="string">'configuration'</span>, <span class="string">'library_file_name'</span>)</span><br><span class="line">  <span class="variable">_library_file</span> = <span class="variable">_this_path</span> / <span class="string">'lib'</span> / library_file_name</span><br><span class="line">  <span class="variable">_library_file</span> = <span class="built_in">str</span>(<span class="variable">_library_file</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  <span class="variable">_header_file</span> = os.getenv(<span class="string">'ACCOUNT_HEADER_FILE'</span>)</span><br><span class="line">  <span class="built_in">assert</span> <span class="variable">_header_file</span> is <span class="built_in">not</span> None</span><br><span class="line">  <span class="variable">_library_file</span> = os.getenv(<span class="string">'ACCOUNT_LIBRARY_FILE'</span>)</span><br><span class="line">  <span class="built_in">assert</span> <span class="variable">_library_file</span> is <span class="built_in">not</span> None</span><br></pre></td></tr></table></figure>
<p>本例中，将找到<code>_cfg_file</code>并进行解析，<code>setup.py</code>将找到<code>include</code>下的头文件和<code>lib</code>下的库，并将它们传递给CFFI，从而构造库对象。这也是为什么，使用<code>lib</code>作为安装目标<code>DESTINATION</code>，而不使用<code>CMAKE_INSTALL_LIBDIR</code>的原因(否则可能会让<code>account/__init__.py</code>混淆)。</p>
<h2 id="更多信息-2"><a href="#更多信息-2" class="headerlink" title="更多信息"></a>更多信息</h2><p>将包放到PyPI测试和生产实例中的后续步骤，因为有些步骤是类似的，所以可以直接参考前面的示例。</p>
<h1 id="11-4-以Conda包的形式发布一个简单的项目"><a href="#11-4-以Conda包的形式发布一个简单的项目" class="headerlink" title="11.4 以Conda包的形式发布一个简单的项目"></a>11.4 以Conda包的形式发布一个简单的项目</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-11/recipe-04" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-11/recipe-04</a> 中找到。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>虽然PyPI是发布Python包的标准平台，但Anaconda (<a href="https://anaconda.org/" target="_blank" rel="noopener">https://anaconda.org</a> )更为可能更为流行，因为它不仅允许使用Python接口发布Python或混合项目，还允许对非Python项目进行打包和依赖关系管理。这个示例中，我们将为一个非常简单的C++示例项目准备一个Conda包，该项目使用CMake配置和构建，除了C++之外没有依赖关系。下一个示例中，我们将会来看看一个更复杂的Conda包。</p>
<h2 id="准备工作-3"><a href="#准备工作-3" class="headerlink" title="准备工作"></a>准备工作</h2><p>我们的目标是打包以下示例代码(<code>example.cpp</code>)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"hello from your conda package!"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="具体实施-3"><a href="#具体实施-3" class="headerlink" title="具体实施"></a>具体实施</h2><ol>
<li><code>CMakeLists.txt</code>文件给出了最低版本要求、项目名称和支持的语言:</li>
</ol>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">cmake_minimum_required</span><span class="params">(VERSION <span class="number">3.5</span> FATAL_ERROR)</span></span></span><br><span class="line"><span class="function"><span class="title">project</span><span class="params">(recipe-<span class="number">04</span> LANGUAGES CXX)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_STANDARD <span class="number">11</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_EXTENSIONS OFF)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_STANDARD_REQUIRED ON)</span></span></span><br></pre></td></tr></table></figure>
<ol>
<li><p>使用<code>example.cpp</code>构建<code>hello-conda</code>可执行目标：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_executable</span><span class="params">(hello-conda <span class="string">""</span>)</span></span></span><br><span class="line">target_sources(hello-conda</span><br><span class="line">  PRIVATE</span><br><span class="line">  	example.cpp</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>CMakeLists.txt</code>定义安装目标：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">nstall(</span><br><span class="line">  TARGETS</span><br><span class="line">  	hello-conda</span><br><span class="line">  DESTINATION</span><br><span class="line">  	bin</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>将在一个名为<code>meta.yaml</code>的文件中，对Conda包进行描述。我们将把它放在<code>conda-recipe</code>目录下，文件结构如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── conda-recipe</span><br><span class="line">│    └── meta.yaml</span><br><span class="line">└── example.cpp</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>meta.yaml</code>包含如下内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">package:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">conda-example-simple</span></span><br><span class="line"><span class="attr">  version:</span> <span class="string">"0.0.0"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">source:</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">..</span> <span class="string">/</span>  <span class="comment"># this can be changed to git-url</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">build:</span></span><br><span class="line"><span class="attr">  number:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">  binary_relocation:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">cmake</span> <span class="bullet">-H.</span> <span class="bullet">-Bbuild_conda</span> <span class="bullet">-G</span> <span class="string">"$&#123;CMAKE_GENERATOR&#125;"</span> <span class="bullet">-DCMAKE_INSTALL_PREFIX=$&#123;PREFIX&#125;</span> <span class="comment"># [not win]</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">cmake</span> <span class="bullet">-H.</span> <span class="bullet">-Bbuild_conda</span> <span class="bullet">-G</span> <span class="string">"%CMAKE_GENERATOR%"</span> <span class="bullet">-DCMAKE_INSTALL_PREFIX="%LIBRARY_PREFIX%"</span> <span class="comment"># [win]</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">cmake</span> <span class="bullet">-</span> <span class="bullet">-build</span> <span class="string">build_conda</span> <span class="bullet">-</span> <span class="bullet">-target</span> <span class="string">install</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">requirements:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">cmake</span> <span class="string">&gt;=3.5</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;</span> <span class="string">&#123;</span> <span class="string">compiler('cxx')</span> <span class="string">&#125;</span> <span class="string">&#125;</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">about:</span></span><br><span class="line"><span class="attr">  home:</span> <span class="attr">http://www.example.com</span></span><br><span class="line"><span class="attr">  license:</span> <span class="string">MIT</span></span><br><span class="line"><span class="attr">  summary:</span> <span class="string">"Summary in here ..."</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>现在来构建包：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ conda <span class="keyword">build </span>conda-recipe</span><br></pre></td></tr></table></figure>
</li>
<li><p>过程中屏幕上看到大量输出，但是一旦构建完成，就可以对包进行安装。首先，在本地进行测试：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>conda install --<span class="keyword">use</span>-local conda-example-simple</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在准备测试安装包，打开一个新的终端(假设Anaconda处于激活状态)，并输入以下内容：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ hello-conda</span><br><span class="line"></span><br><span class="line">hello <span class="keyword">from</span> your conda <span class="keyword">package</span>!</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试成功后，再移除包装：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ conda <span class="built_in">remove</span> conda-<span class="built_in">example</span>-simple</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-3"><a href="#工作原理-3" class="headerlink" title="工作原理"></a>工作原理</h2><p><code>CMakeLists.txt</code>中，安装目标是这个示例的一个基本组件:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">install(</span><br><span class="line">  TARGETS</span><br><span class="line">  	hello-conda</span><br><span class="line">  DESTINATION</span><br><span class="line">  	bin</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>目标的二进制文件会安装到<code>${CMAKE_INSTALL_PREFIX}/bin</code>中。变量由Conda定义，并且构建步骤中定义在<code>meta.yaml</code>：</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">build:</span></span><br><span class="line"><span class="keyword"> </span> number: <span class="number">0</span></span><br><span class="line"><span class="symbol">  binary_relocation:</span> true</span><br><span class="line"><span class="symbol">  script:</span></span><br><span class="line">    - cmake -H. -<span class="keyword">Bbuild_conda </span>-G <span class="string">"$&#123;CMAKE_GENERATOR&#125;"</span> -DCMAKE_INSTALL_PREFIX=$&#123;<span class="keyword">PREFIX&#125; </span><span class="comment"># [not win]</span></span><br><span class="line">    - cmake -H. -<span class="keyword">Bbuild_conda </span>-G <span class="string">"%CMAKE_GENERATOR%"</span> -DCMAKE_INSTALL_PREFIX=<span class="string">"%LIBRARY_PREFIX%"</span> <span class="comment"># [win]</span></span><br><span class="line">    - cmake - -<span class="keyword">build </span><span class="keyword">build_conda </span>- -target <span class="keyword">install</span></span><br></pre></td></tr></table></figure>
<p>将安装目录设置为<code>${prefix}</code> (Conda的内部变量)，然后构建并安装项目。调用构建目录命名为<code>build_conda</code>的动机与前面的示例类似：特定的构建目录名可能已经命名为<code>build</code>。</p>
<h2 id="更多信息-3"><a href="#更多信息-3" class="headerlink" title="更多信息"></a>更多信息</h2><p>配置文件<code>meta.yaml</code>可为任何项目指定构建、测试和安装步骤。详情请参考官方文档：<a href="https://conda.io/docs/user-guide/tasks/build-packages/define-metadata.html" target="_blank" rel="noopener">https://conda.io/docs/user-guide/tasks/build-packages/define-metadata.html</a></p>
<p>要将Conda包上传到Anaconda云，请遵循官方的Anaconda文档: <a href="https://docs.anaconda.com/anaconda-cloud/user-guide/" target="_blank" rel="noopener">https://docs.anaconda.com/anaconda-cloud/user-guide/</a></p>
<p>此外，也可以考虑将Miniconda，作为Anaconda的轻量级替代品：<a href="https://conda.io/miniconda.html" target="_blank" rel="noopener">https://conda.io/miniconda.html</a></p>
<h1 id="11-5-将Conda包作为依赖项发布给项目"><a href="#11-5-将Conda包作为依赖项发布给项目" class="headerlink" title="11.5 将Conda包作为依赖项发布给项目"></a>11.5 将Conda包作为依赖项发布给项目</h1><p><strong>NOTE</strong>:<em>此示例代码可以在 <a href="https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-11/recipe-05" target="_blank" rel="noopener">https://github.com/dev-cafe/cmake-cookbook/tree/v1.0/chapter-11/recipe-05</a> 中找到。该示例在CMake 3.5版(或更高版本)中是有效的，并且已经在GNU/Linux、macOS和Windows上进行过测试。</em></p>
<p>这个示例中，我们将基于之前示例的结果，并且为CMake项目准备一个更真实和复杂的Conda包，这将取决于DGEMM的函数实现，对于矩阵与矩阵的乘法，可以使用Intel的MKL库进行。Intel的MKL库可以以Conda包的形式提供。此示例将为我们提供一个工具集，用于准备和共享具有依赖关系的Conda包。</p>
<h2 id="准备工作-4"><a href="#准备工作-4" class="headerlink" title="准备工作"></a>准备工作</h2><p>对于这个示例，我们将使用与前一个示例中的Conda配置，和相同的文件命名和目录结构：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">├── conda-recipe</span><br><span class="line">│    └── meta.yaml</span><br><span class="line">└── example.cpp</span><br></pre></td></tr></table></figure>
<p>示例文件(<code>example.cpp</code>)将执行矩阵-矩阵乘法，并将MKL库返回的结果与“noddy”实现进行比较:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"mkl.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cassert&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;random&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// generate a uniform distribution of real number between -1.0 and 1.0</span></span><br><span class="line">  <span class="built_in">std</span>::random_device rd;</span><br><span class="line">  <span class="built_in">std</span>::<span class="function">mt19937 <span class="title">mt</span><span class="params">(rd())</span></span>;</span><br><span class="line">  <span class="built_in">std</span>:: uniform_real_distribution &lt; <span class="keyword">double</span> &gt; dist(<span class="number">-1.0</span>, <span class="number">1.0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> m = <span class="number">500</span>;</span><br><span class="line">  <span class="keyword">int</span> k = <span class="number">1000</span>;</span><br><span class="line">  <span class="keyword">int</span> n = <span class="number">2000</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">double</span> *A = (<span class="keyword">double</span> *)mkl_malloc(m * k * <span class="keyword">sizeof</span>(<span class="keyword">double</span>), <span class="number">64</span>);</span><br><span class="line">  <span class="keyword">double</span> *B = (<span class="keyword">double</span> *)mkl_malloc(k * n * <span class="keyword">sizeof</span>(<span class="keyword">double</span>), <span class="number">64</span>);</span><br><span class="line">  <span class="keyword">double</span> *C = (<span class="keyword">double</span> *)mkl_malloc(m * n * <span class="keyword">sizeof</span>(<span class="keyword">double</span>), <span class="number">64</span>);</span><br><span class="line">  <span class="keyword">double</span> * D = <span class="keyword">new</span> <span class="keyword">double</span>[m * n];</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (m * k); i++) &#123;</span><br><span class="line">    A[i] = dist(mt);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (k * n); i++) &#123;</span><br><span class="line">    B[i] = dist(mt);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (m * n); i++) &#123;</span><br><span class="line">    C[i] = <span class="number">0.0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">double</span> alpha = <span class="number">1.0</span>;</span><br><span class="line">  <span class="keyword">double</span> beta = <span class="number">0.0</span>;</span><br><span class="line">  cblas_dgemm(CblasRowMajor,</span><br><span class="line">              CblasNoTrans,</span><br><span class="line">              CblasNoTrans,</span><br><span class="line">              m,</span><br><span class="line">              n,</span><br><span class="line">              k,</span><br><span class="line">              alpha,</span><br><span class="line">              A,</span><br><span class="line">              k,</span><br><span class="line">              B,</span><br><span class="line">              n,</span><br><span class="line">              beta,</span><br><span class="line">              C,</span><br><span class="line">              n);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// D_mn = A_mk B_kn</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> r = <span class="number">0</span>; r &lt; m; r++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; n; c++) &#123;</span><br><span class="line">      D[r * n + c] = <span class="number">0.0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; k; i++) &#123;</span><br><span class="line">        D[r * n + c] += A[r * k + i] * B[i * n + c];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// compare the two matrices</span></span><br><span class="line">  <span class="keyword">double</span> r = <span class="number">0.0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; (m * n); i++) &#123;</span><br><span class="line">    r += <span class="built_in">std</span>::<span class="built_in">pow</span>(C[i] - D[i], <span class="number">2.0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  assert (r &lt; <span class="number">1.0e-12</span> &amp; &amp; <span class="string">"ERROR: matrices C and D do not match"</span>);</span><br><span class="line">  </span><br><span class="line">  mkl_free(A);</span><br><span class="line">  mkl_free(B);</span><br><span class="line">  mkl_free(C);</span><br><span class="line">  <span class="keyword">delete</span>[] D;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">std</span>:: <span class="built_in">cout</span> &lt;&lt; <span class="string">"MKL DGEMM example worked!"</span> &lt;&lt; <span class="built_in">std</span>:: <span class="built_in">endl</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;`</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们还需要修改<code>meta.yaml</code>。然而，与上一个示例相比，唯一的变化是在依赖项中加入了<code>mkl-devel</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">package:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">conda-example-dgemm</span></span><br><span class="line"><span class="attr">  version:</span> <span class="string">"0.0.0"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">source:</span></span><br><span class="line"><span class="attr">  path:</span> <span class="string">../</span> <span class="comment"># this can be changed to git-url</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line"><span class="attr">  number:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">cmake</span> <span class="bullet">-H.</span> <span class="bullet">-Bbuild_conda</span> <span class="bullet">-G</span> <span class="string">"$&#123;CMAKE_GENERATOR&#125;"</span></span><br><span class="line"><span class="bullet">  -</span><span class="string">DCMAKE_INSTALL_PREFIX=$&#123;PREFIX&#125;</span> <span class="comment"># [not win]</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">cmake</span> <span class="bullet">-H.</span> <span class="bullet">-Bbuild_conda</span> <span class="bullet">-G</span> <span class="string">"%CMAKE_GENERATOR%"</span></span><br><span class="line"><span class="bullet">  -</span><span class="string">DCMAKE_INSTALL_PREFIX="%LIBRARY_PREFIX%"</span> <span class="comment"># [win]</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">cmake</span> <span class="bullet">-</span> <span class="bullet">-build</span> <span class="string">build_conda</span> <span class="bullet">-</span> <span class="bullet">-target</span> <span class="string">install</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">requirements:</span></span><br><span class="line"><span class="attr">  build:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">cmake</span> <span class="string">&gt;=3.5</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">&#123;&#123;</span> <span class="string">compiler('cxx')</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="attr">  host:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">mkl</span> <span class="bullet">-</span> <span class="string">devel</span> <span class="number">2018</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">about:</span></span><br><span class="line"><span class="attr">  home:</span> <span class="attr">http://www.example.com</span></span><br><span class="line"><span class="attr">  license:</span> <span class="string">MIT</span></span><br><span class="line"><span class="attr">  summary:</span> <span class="string">"Summary in here ..."</span></span><br></pre></td></tr></table></figure>
<h2 id="具体实施-4"><a href="#具体实施-4" class="headerlink" title="具体实施"></a>具体实施</h2><ol>
<li><code>CMakeLists.txt</code>文件声明了最低版本、项目名称和支持的语言：</li>
</ol>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">cmake_minimum_required</span><span class="params">(VERSION <span class="number">3.5</span> FATAL_ERROR)</span></span></span><br><span class="line"><span class="function"><span class="title">project</span><span class="params">(recipe-<span class="number">05</span> LANGUAGES CXX)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_STANDARD <span class="number">11</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_EXTENSIONS OFF)</span></span></span><br><span class="line"><span class="function"><span class="title">set</span><span class="params">(CMAKE_CXX_STANDARD_REQUIRED ON)</span></span></span><br></pre></td></tr></table></figure>
<ol>
<li><p>使用<code>example.cpp</code>构建<code>dgem-example</code>可执行目标：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add_executable(<span class="built_in">dgemm</span>-<span class="built_in">example</span> <span class="string">""</span>)</span><br><span class="line">target_sources(<span class="built_in">dgemm</span>-<span class="built_in">example</span></span><br><span class="line">  PRIVATE</span><br><span class="line">  	<span class="built_in">example</span>.cpp</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，需要找到通过<code>MKL-devel</code>安装的MKL库。我们准备了一个名为<code>IntelMKL</code>的<code>INTERFACE</code>库，该库可以用于其他目标，并将为依赖的目标设置包括目录、编译器选项和链接库。根据Intel的建议(<a href="https://software.intel.com/en-us/articles/intel-mml-link-line-advisor/" target="_blank" rel="noopener">https://software.intel.com/en-us/articles/intel-mml-link-line-advisor/</a> )进行设置。首先，设置编译器选项：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add_library(IntelMKL INTERFACE)</span><br><span class="line"></span><br><span class="line">target_compile_options(IntelMKL</span><br><span class="line">  INTERFACE</span><br><span class="line">  	$&lt;$&lt;<span class="keyword">OR</span>:$&lt;CXX_COMPILER_ID:GNU&gt;,$&lt;CXX_COMPILER_ID:AppleClang&gt;&gt;:-m64&gt;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来，查找<code>mkl.h</code>头文件，并为<code>IntelMKL</code>目标设置<code>include</code>目录：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">find_path(_mkl_h</span><br><span class="line">  NAMES</span><br><span class="line">  	mkl.h</span><br><span class="line">  HINTS</span><br><span class="line">  	<span class="variable">$&#123;CMAKE_INSTALL_PREFIX&#125;</span>/include</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">target_include_directories(IntelMKL</span><br><span class="line">  INTERFACE</span><br><span class="line">  	<span class="variable">$&#123;_mkl_h&#125;</span></span><br><span class="line">  )</span><br><span class="line">  </span><br><span class="line">message(STATUS <span class="string">"MKL header file FOUND: <span class="variable">$&#123;_mkl_h&#125;</span>"</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，为<code>IntelMKL</code>目标设置链接库:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">find_library(_mkl_libs</span><br><span class="line">  NAMES</span><br><span class="line">    mkl_rt</span><br><span class="line">  HINTS</span><br><span class="line">    $&#123;CMAKE_INSTALL_PREFIX&#125;/lib</span><br><span class="line">  )</span><br><span class="line">message(STATUS <span class="string">"MKL single dynamic library FOUND: $&#123;_mkl_libs&#125;"</span>)</span><br><span class="line"></span><br><span class="line">find_package(Threads QUIET)</span><br><span class="line">target_link_libraries(IntelMKL</span><br><span class="line">  INTERFACE</span><br><span class="line">    $&#123;_mkl_libs&#125;</span><br><span class="line">    $&lt;$&lt;<span class="symbol">OR:</span>$&lt;<span class="symbol">CXX_COMPILER_ID:</span>GNU&gt;,$&lt;<span class="symbol">CXX_COMPILER_ID:</span>AppleClang<span class="meta">&gt;&gt;</span><span class="symbol">:Threads</span><span class="symbol">:</span><span class="symbol">:Threads&gt;</span></span><br><span class="line">    $&lt;$&lt;<span class="symbol">OR:</span>$&lt;<span class="symbol">CXX_COMPILER_ID:</span>GNU&gt;,$&lt;<span class="symbol">CXX_COMPILER_ID:</span>AppleClang<span class="meta">&gt;&gt;</span><span class="symbol">:m&gt;</span></span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用<code>cmake_print_properties</code>函数，打印<code>IntelMKL</code>目标的信息：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">include(<span class="name">CMakePrintHelpers</span>)</span><br><span class="line">cmake_print_properties(</span><br><span class="line">  TARGETS</span><br><span class="line">  	IntelMKL</span><br><span class="line">  PROPERTIES</span><br><span class="line">    INTERFACE_COMPILE_OPTIONS</span><br><span class="line">    INTERFACE_INCLUDE_DIRECTORIES</span><br><span class="line">    INTERFACE_LINK_LIBRARIES</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>将这些库连接到<code>dgem-example</code>:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">target_link_libraries(<span class="name">dgemm-example</span></span><br><span class="line">  PRIVATE</span><br><span class="line">  	IntelMKL</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>CMakeLists.txt</code>中定义了安装目标:</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">install(</span><br><span class="line">  TARGETS</span><br><span class="line">  	dgemm-example</span><br><span class="line">  DESTINATION</span><br><span class="line">  	bin</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
</li>
<li><p>尝试构建包：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ conda <span class="keyword">build </span>conda-recipe</span><br></pre></td></tr></table></figure>
</li>
<li><p>过程中屏幕上将看到大量输出，但是一旦构建完成，就可以对包进行安装包。首先，在本地进行安装测试：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ conda install --use-<span class="built_in">local</span> conda-<span class="built_in">example</span>-<span class="built_in">dgemm</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>现在测试安装，打开一个新的终端(假设Anaconda处于激活状态)，并输入：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">dgemm</span>-<span class="built_in">example</span></span><br><span class="line"></span><br><span class="line">MKL DGEMM <span class="built_in">example</span> worked!</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装成功之后，再进行卸载：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ conda <span class="built_in">remove</span> conda-<span class="built_in">example</span>-<span class="built_in">dgemm</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="工作原理-4"><a href="#工作原理-4" class="headerlink" title="工作原理"></a>工作原理</h2><p><code>meta.yaml</code>中的变化就是<code>mml-devel</code>依赖项。从CMake的角度来看，这里的挑战是定位Anaconda安装的MKL库。幸运的是，我们知道它位于<code>${CMAKE_INSTALL_PREFIX}</code>中。可以使用在线的<code>Intel MKL link line advisor</code>(<a href="https://software.intel.com/en-us/articles/intel-mml-link-line-advisor/" target="_blank" rel="noopener">https://software.intel.com/en-us/articles/intel-mml-link-line-advisor/</a>) 查看如何根据选择的平台和编译器，将MKL链接到我们的项目中，我们会将此信息封装到<code>INTERFACE</code>库中。这个解决方案非常适合类MKL的情况：库不是由我们的项目或任何子项目创建的目标，但是它仍然需要以一种方式进行处理；也就是：设置编译器标志，包括目录和链接库。<code>INTERFACE</code>库是构建系统中的目标，但不创建任何构建输出(至少不会直接创建)。但由于它们是目标，我们可对它们的属性进行设置。这样与“实际”目标一样，可以安装、导出和导入。</p>
<p>首先，我们用<code>INTERFACE</code>属性声明一个名为<code>IntelMKL</code>的新库。然后，根据需要设置属性，并使用<code>INTERFACE</code>属性在目标上调用适当的CMake命令：</p>
<ul>
<li>target_compile_options：用于设置<code>INTERFACE_COMPILE_OPTIONS</code>。示例中，设置了<code>-m64</code>，不过这个标志只有GNU和AppleClange编译器能够识别。并且，我们使用生成器表达式来实现。</li>
<li>target_include_directories：用于设置<code>INTERFACE_INCLUDE_DIRECTORIES</code>。使用<code>find_path</code>，可以在找到系统上的<code>mkl.h</code>头文件后设置这些参数。</li>
<li>target_link_libraries：用于设置<code>INTERFACE_LINK_LIBRARIES</code>。我们决定链接动态库<code>libmkl_rt.so</code>，并用<code>find_library</code>搜索它。GNU或AppleClang编译器还需要将可执行文件链接到线程和数学库。同样，这些情况可以使用生成器表达式优雅地进行处理。</li>
</ul>
<p>在<code>IntelMKL</code>目标上设置的属性后，可以通过<code>cmake_print_properties</code>命令将属性进行打印。最后，链接到<code>IntelMKL</code>目标，这将设置编译器标志，包括目录和链接库：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">target_link_libraries(<span class="name">dgemm-example</span></span><br><span class="line">  PRIVATE</span><br><span class="line">  	IntelMKL</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<h2 id="更多信息-4"><a href="#更多信息-4" class="headerlink" title="更多信息"></a>更多信息</h2><p>Anaconda云上包含大量包。使用上述方法，可以为CMake项目构建依赖于其他Conda包的Conda包。这样，就可以探索软件功能的各种可能性，并与他人分享您的软件包!</p>

    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2021/03/100663.html" class="pre-post btn btn-default" title='CMake 完整使用教程 之十三 构建文档'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">CMake 完整使用教程 之十三 构建文档</span>
        </a>
    
    
        <a href="/archives/2021/03/100661.html" class="next-post btn btn-default" title='CMake 完整使用教程 之十一 编写安装程序'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">CMake 完整使用教程 之十一 编写安装程序</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#11-1-生成源代码和二进制包"><span class="toc-text">11.1 生成源代码和二进制包</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理"><span class="toc-text">工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#打包源码"><span class="toc-text">打包源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二进制包"><span class="toc-text">二进制包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#平台原生的二进制安装"><span class="toc-text">平台原生的二进制安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-2-通过PyPI发布使用CMake-pybind11构建的C-Python项目"><span class="toc-text">11.2 通过PyPI发布使用CMake/pybind11构建的C++/Python项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-1"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-1"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-1"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-1"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-3-通过PyPI发布使用CMake-CFFI构建C-Fortran-Python项目"><span class="toc-text">11.3 通过PyPI发布使用CMake/CFFI构建C/Fortran/Python项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-2"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-2"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-2"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-2"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-4-以Conda包的形式发布一个简单的项目"><span class="toc-text">11.4 以Conda包的形式发布一个简单的项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-3"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-3"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-3"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-3"><span class="toc-text">更多信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-5-将Conda包作为依赖项发布给项目"><span class="toc-text">11.5 将Conda包作为依赖项发布给项目</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#准备工作-4"><span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#具体实施-4"><span class="toc-text">具体实施</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理-4"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#更多信息-4"><span class="toc-text">更多信息</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2023&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>