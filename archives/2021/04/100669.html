<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <meta name="theme-version" content="1.2.3">
    <meta name="root" content="/">
    <link rel="dns-prefetch" href="https://www.ljjyy.com">
    <!--SEO-->

    <meta name="keywords" content="qt,c++">


    <meta name="description" content="教程源码：https://github.com/myhhub/qtPluginApp
初识QtPlugin概述为什么我们要学习插件化，其和 windows 导出 dll 有什么区别呢？

导出的...">



<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">

    <!--Title-->


<title>QT 插件(QtPlugin)教程 | 来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</title>


    <link rel="alternate" href="/atom.xml" title="来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟" type="application/atom+xml">


    <link rel="icon" href="/favicon.ico">

    



<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    
	<div class="hide">
        <script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
        <script>LA.init({id: "JgbNOaw1xxsmUUsQ",ck: "JgbNOaw1xxsmUUsQ"})</script>
	</div>






    
    <meta name="baidu-site-verification" content="dTHILoORpx">


    <script>
        (function(){
            var bp = document.createElement('script');
            var curProtocol = window.location.protocol.split(':')[0];
            if (curProtocol === 'https') {
                bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
            }
            else {
                bp.src = 'http://push.zhanzhang.baidu.com/push.js';
            }
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(bp, s);
        })();
    </script>

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  >
    <div class="main-header-box">
        <!--a class="header-avatar" href="/" title='Ljjyy.com'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a-->
        <div class="branding">
            
                <h2> 多读书多实践，勤思考善领悟 </h2>
            
    	  </div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">

        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="web-logo"  href="/" title='Ljjyy.com'></a>
                    <!--a class="navbar-brand" href="https://www.ljjyy.com">来唧唧歪歪(Ljjyy.com) - 多读书多实践，勤思考善领悟</a-->
                </div>
                <div class="collapse navbar-collapse" id="main-menu" style="">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/cloud/"><i class="fa "></i>云计算</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/front/"><i class="fa "></i>前端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/back/"><i class="fa "></i>后端</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/devops/"><i class="fa "></i>运维</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/crack/"><i class="fa "></i>破解</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/penetration/"><i class="fa "></i>渗透</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/tool/"><i class="fa "></i>工具</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/categories/other/"><i class="fa "></i>其他</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="QT 插件(QtPlugin)教程">
            
	            QT 插件(QtPlugin)教程
            
        </h1>
        <div class="post-meta">
    
        <span class="categories-meta fa-wrap">
            <i class="fa fa-folder-open-o"></i>
            <a class="category-link" href="/categories/back/">后端</a>
        </span>
    

    
        <span class="fa-wrap">
            <i class="fa fa-tags"></i>
            <span class="tags-meta">
                
                    <a class="tag-link" href="/tags/c/">c++</a> <a class="tag-link" href="/tags/qt/">qt</a>
                
            </span>
        </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2021/04/21</span>
        </span>
        
    
</div>
            
            
            <p class="fa fa-exclamation-triangle warning">
                本文于<strong>718</strong>天之前发表，文中内容可能已经过时。
            </p>
        
    </div>
    
    <div class="post-body post-content">
        <p>教程源码：<a href="https://github.com/myhhub/qtPluginApp" target="_blank" rel="noopener">https://github.com/myhhub/qtPluginApp</a></p>
<h1 id="初识QtPlugin"><a href="#初识QtPlugin" class="headerlink" title="初识QtPlugin"></a>初识QtPlugin</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>为什么我们要学习插件化，其和 windows 导出 dll 有什么区别呢？</p>
<ol>
<li>导出的动态库如果缺失，程序不能运行。但插件可以。</li>
<li>同一套代码，即可分别在 windows 下和 linux 下生成插件。</li>
</ol>
<p>QT 本身提供两种插件支持，一种称为高级 API，一种称为低级 API。</p>
<ol>
<li>高级API的作用是扩展 QT 程序本身，需要子类化 QT 提供的插件基类，例如现有的 QTSqlDriver，因此你可也以编写自己的 QTStyle 扩展 QT。</li>
<li>低级 API 的作用是扩展自己的程序，也就是动态库的形式，在windows下就是个dll。同时因为高级 API 基于低级 API 创建，因此掌握低级 API 用法，高级 API 的用法也不在话下。</li>
</ol>
<p>QT 的插件加载需要用到类 QPluginloader，你可以编写支持任意功能的插件。如何创建一个插件和加载这个插件 QT Assist 中是这样描述的：</p>
<p>创建一个扩展应用程序的插件：</p>
<ol>
<li>定义一组用于与插件对话的接口（仅具有纯虚拟函数的类）。（预留好接口，方便建立通信）。</li>
<li>接口内使用 Q_DECLARE_INTERFACE() 宏告诉qt的元对象系统有关接口的信息。</li>
<li>使用 QPluginLoader 加载插件。</li>
<li>使用 qobject_cast 检验插件是否实现了既定的接口（以防外部插件注入），转换成功即可得到插件实例。</li>
</ol>
<p>插件编写具体步骤（代码编写）：</p>
<ol>
<li>声明插件类，并继承 QObject 和 实现上面提到的既定接口。</li>
<li>使用 Q_INTERFACES 告诉 QT 元对象系统有关这个接口的信息（虚方法）。</li>
<li>使用 Q_PLUGIN_METADATA 导出插件。（Q_PLUGIN_METADATA 是 QT5的宏，QT4 使用的是 Q_EXPORT_PLUGIN2）</li>
<li>编写合适的 .pro 文件。</li>
</ol>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>1、 新建子目录项目 PluginApp<br>2、 在 PluginApp 下 新建 QWidget 项目，名为 Main<br>3、 右键 PluginApp 新建子项目 pluginA<br>4、 编写接口，在 Main 下新建头文件 interfaceplugin.h</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> INTERFACEPLUGIN_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INTERFACEPLUGIN_H</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QString&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtPlugin&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//定义接口</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InterfacePlugin</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~InterfacePlugin() &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> QString <span class="title">output</span><span class="params">(<span class="keyword">const</span> QString &amp;message)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> InterfacePlugin_iid <span class="meta-string">"Test.Plugin.InterfacePlugin"</span>   <span class="comment">// 唯一标识符</span></span></span><br><span class="line"> </span><br><span class="line">Q_DECLARE_INTERFACE(InterfacePlugin, InterfacePlugin_iid)</span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>5、 加载插件</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"widget.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QApplication&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDir&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QPluginLoader&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"interfaceplugin.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QDebug&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">QApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line"><span class="comment">//    Widget w;</span></span><br><span class="line"><span class="comment">//    w.show();</span></span><br><span class="line"> </span><br><span class="line">    <span class="comment">//加载exe所在目录下  plugin文件夹的所有插件</span></span><br><span class="line">        QDir path = QDir(qApp-&gt;applicationDirPath());</span><br><span class="line">        path.cd(<span class="string">"plugins"</span>);</span><br><span class="line">        foreach (QFileInfo info, path.entryInfoList(QDir::Files | QDir::NoDotAndDotDot))</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="function">QPluginLoader <span class="title">pluginLoader</span><span class="params">(info.absoluteFilePath())</span></span>;</span><br><span class="line">                QObject *plugin = pluginLoader.instance();</span><br><span class="line">                <span class="keyword">if</span> (plugin)</span><br><span class="line">                &#123;</span><br><span class="line">                    InterfacePlugin *app = qobject_cast&lt;InterfacePlugin*&gt;(plugin);</span><br><span class="line">                    <span class="keyword">if</span> (app)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">// 获取元数据（名称、版本、依赖）</span></span><br><span class="line">                        QJsonObject json = pluginLoader.metaData().value(<span class="string">"MetaData"</span>).toObject();</span><br><span class="line">                        qDebug() &lt;&lt; <span class="string">"********** MetaData **********"</span>;</span><br><span class="line">                        qDebug() &lt;&lt; json.value(<span class="string">"author"</span>).toVariant();</span><br><span class="line">                        qDebug() &lt;&lt; json.value(<span class="string">"date"</span>).toVariant();</span><br><span class="line">                        qDebug() &lt;&lt; json.value(<span class="string">"name"</span>).toVariant();</span><br><span class="line">                        qDebug() &lt;&lt; json.value(<span class="string">"version"</span>).toVariant();</span><br><span class="line">                        qDebug() &lt;&lt; json.value(<span class="string">"dependencies"</span>).toArray().toVariantList();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 访问感兴趣的接口                    </span></span><br><span class="line">                        app-&gt;output(<span class="string">"i am a plugin"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> a.exec();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>6、 编写插件 .pro 文件、头文件、 cpp 文件</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATE        = lib           <span class="comment">#表示这个makefile是一个lib的makefile</span></span><br><span class="line">CONFIG         += plugin        <span class="comment">#应用程序是一个插件</span></span><br><span class="line">TARGET          = pluginA       <span class="comment">#生成插件的名称</span></span><br><span class="line">win32 &#123;</span><br><span class="line">    CONFIG(debug, debug|release) &#123;</span><br><span class="line">        DESTDIR  = ../Main/debug/plugins</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        DESTDIR  = ../Main/release/plugins</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="comment">#生成插件的目录</span></span><br><span class="line"> </span><br><span class="line">HEADERS += \</span><br><span class="line">    pluginA.h</span><br><span class="line"> </span><br><span class="line">SOURCES += \</span><br><span class="line">    pluginA.cpp</span><br><span class="line"> </span><br><span class="line">DISTFILES += \</span><br><span class="line">    programmer.json             <span class="comment">#插件描述文件</span></span><br></pre></td></tr></table></figure>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PLUGINA_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PLUGINA_H</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtPlugin&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"../Main/interfaceplugin.h"</span></span></span><br><span class="line"> </span><br><span class="line">class PluginA : <span class="keyword">public</span> QObject, <span class="keyword">public</span> InterfacePlugin</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// programmer.json 插件的信息描述类</span></span><br><span class="line">    Q_OBJECT</span><br><span class="line">    Q_PLUGIN_METADATA(IID InterfacePlugin_iid FILE <span class="string">"programmer.json"</span>) <span class="comment">// QT5.0 引入</span></span><br><span class="line">    Q_INTERFACES(InterfacePlugin)</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">explicit</span> PluginA(QObject *parent = <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">virtual</span>  QString output(<span class="keyword">const</span> QString &amp;message) Q_DECL_OVERRIDE;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// PLUGINA_H</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pluginA.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtDebug&gt;</span></span></span><br><span class="line"> </span><br><span class="line">PluginA::PluginA(QObject *parent) :</span><br><span class="line">    QObject(parent)</span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">QString PluginA::output(<span class="keyword">const</span> QString &amp;message)</span><br><span class="line">&#123;</span><br><span class="line">    qDebug() &lt;&lt; message + <span class="string">"插件A加载成功"</span>;</span><br><span class="line">    <span class="keyword">return</span> message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>“programmer.json” 为插件描述文件，会作为元数据被加载到插件中，可在需要的时候手动读取。其中包含了插件的基本信息，更重要的是包含了插件的依赖项，这些依赖项决定了插件的加载顺序，关于插件依赖解决后面再讲。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"author"</span> : <span class="string">"myh"</span>,</span><br><span class="line">    <span class="attr">"date"</span> : <span class="string">"2021/04/22"</span>,</span><br><span class="line">    <span class="attr">"name"</span> : <span class="string">"pluginA"</span>,</span><br><span class="line">    <span class="attr">"version"</span> : <span class="string">"1.0.0"</span>,</span><br><span class="line">    <span class="attr">"des"</span> : <span class="string">"这是一个插件A，按此方法加载插件B、C等"</span>,</span><br><span class="line">    <span class="attr">"dependencies"</span> : []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：<br>1、Main 项目选择 QWidget GUI项目是有原因的，下篇再说是为什么。<br>2、windows 下生成的插件为 dll 后缀，linux 下生成的即为 .so后缀（下篇出 linux 测试结果）。</p>
<h1 id="元信息metaData"><a href="#元信息metaData" class="headerlink" title="元信息metaData"></a>元信息metaData</h1><h2 id="JSON-与Qt插件的元信息-MetaData"><a href="#JSON-与Qt插件的元信息-MetaData" class="headerlink" title="JSON 与Qt插件的元信息 MetaData"></a>JSON 与Qt插件的元信息 MetaData</h2><p>Qt插件的源码中，基本都能见到一个 xxx.json 的文件，这个文件中通常只包含一句：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"Keys"</span>: [ <span class="string">"yyy"</span> ]</span><br><span class="line">&#125;<span class="number">123</span></span><br></pre></td></tr></table></figure>
<p>我们可以猜到这个文件中的”Keys”应该是指定了与插件相关的关键字。那这个 .json 文件到底是如何起作用的？先来认识一下 JSON 。</p>
<p>JSON是一种存储结构化数据的格式，它有6中基本数据类型，分别是：</p>
<ul>
<li>bool 布尔型，取值可以是 true 或 false</li>
<li>double 数字类型</li>
<li>string 字符串类型</li>
<li>array 数组类型</li>
<li>object 对象类型</li>
<li>null 空类型</li>
</ul>
<p>具体可参见 Qt Assistant 中关于”JSON Support in Qt “的介绍。</p>
<p>A simple JSON document encoding a person, his/her age, address and phone numbers could look like:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> &#123;  </span><br><span class="line">2.     "FirstName": "John",    # FirstName是变量(字段)的名称；John是变量的值  </span><br><span class="line">3.     "LastName": "Doe",  </span><br><span class="line">4.     "Age": 43,  </span><br><span class="line">5.     "Address": &#123;  </span><br><span class="line">6.         "Street": "Downing Street 10",  </span><br><span class="line">7.         "City": "London",  </span><br><span class="line">8.         "Country": "Great Britain"  </span><br><span class="line">9.     &#125;,  </span><br><span class="line">10.     "Phone numbers": [  </span><br><span class="line">11.         "+44 1234567",  </span><br><span class="line"><span class="number">12.</span>         <span class="string">"+44 2345678"</span>  </span><br><span class="line">13.     ]  </span><br><span class="line">14. &#125;</span><br></pre></td></tr></table></figure>
<p>值得一提的是，数组类型的字段在.json文件中赋值时应该用方括号 ‘[’ 和 ‘]’ 括起来，对象类型的字段在赋值时应用花括号 ‘{’ 和 ‘}’ 括起来，普通类型的数据则不需要括。每一个 .json 文件描述了一个 JSON对象，而一个JSON对象中的对象类型字段，又可以看做是一个子JSON对象（JSON对象的嵌套）。</p>
<p>.json在Qt插件中主要用于存储Qt插件的元信息(metaData)，在Qt中，有一个专门的类 QJsonObject 来描述一个JSON。</p>
<h2 id="Qt中的JSON相关类"><a href="#Qt中的JSON相关类" class="headerlink" title="Qt中的JSON相关类"></a><strong>Qt中的JSON相关类</strong></h2><table>
<thead>
<tr>
<th>QJsonArray</th>
<th>Encapsulates a JSON array</th>
<th>封装JSON数组</th>
</tr>
</thead>
<tbody>
<tr>
<td>QJsonDocument</td>
<td>Way to read and write JSON documents</td>
<td>读取和写入JSON文本的方式</td>
</tr>
<tr>
<td>QJsonObject</td>
<td>Encapsulates a JSON object</td>
<td>封装JSON对象</td>
</tr>
<tr>
<td>QJsonObject::iterator</td>
<td>QJsonObject::iterator class provides an STL-style non-const iterator for QJsonObject</td>
<td>JSON迭代器</td>
</tr>
<tr>
<td>QJsonObject::const_iterator</td>
<td>QJsonObject::const_iterator class provides an STL-style const iterator for QJsonObject</td>
<td>JSON const迭代器</td>
</tr>
<tr>
<td>QJsonParseError</td>
<td>Used to report errors during JSON parsing</td>
<td>用于报告JSON解析期间的错误</td>
</tr>
<tr>
<td>QJsonValue</td>
<td>Encapsulates a value in JSON</td>
<td>封装JSON中的值</td>
</tr>
</tbody>
</table>
<h1 id="接口间通信"><a href="#接口间通信" class="headerlink" title="接口间通信"></a>接口间通信</h1><p>插件接口（Interface）的作用，就是提供一个与其他系统交互的方法。其他系统无需（也无法）了解内部的具体细节，只能通过对外提供的接口来与进行通信。</p>
<p>纯虚函数（包括槽）很容易理解，那么信号呢？</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在 Qt 中，定义一个纯虚信号有效吗？</span><br></pre></td></tr></table></figure>
<p>的确，这个话题非常有意思。。。通常，我们会定义一些纯虚的槽函数，但关于纯虚信号这个话题讨论的比较少！那么，信号可不可以是纯虚的呢？</p>
<h2 id="一些尝试"><a href="#一些尝试" class="headerlink" title="一些尝试"></a>一些尝试</h2><p>关于信号和纯虚，我们知道：</p>
<ul>
<li>信号永远不会有实现（也就是说，在 <code>.h</code> 中定义了信号，在 <code>.cpp</code> 中不需要实现）</li>
<li>声明一个纯虚函数的主要目的，是强制继承的类提供一个实现。</li>
</ul>
<p>信号没有实现，如果将其声明为纯虚的，需要继承的类来提供一个实现，这与“信号没有实现”直接冲突。就好比让一个人同时出现在两个地方，这是不可能的。因此，似乎声明一个纯虚信号是一个错误。</p>
<p>在编写完一个接口时，为了能使用 Qt 的信号槽特性，很多人可能会写出类似下面的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PLUGININTERFACE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PLUGININTERFACE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QStringList&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtWidgets/qwidget.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PluginInterface</span> :</span> <span class="keyword">public</span> QObject</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~PluginInterface() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">setInitData</span><span class="params">(QStringList &amp;strlist)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">getResultData</span><span class="params">(QStringList &amp;strlist)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">information</span><span class="params">(<span class="keyword">const</span> QString&amp;)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PluginInterface_iid <span class="meta-string">"QtPluginsTest.QtPluginsManager.PluginInterface"</span></span></span><br><span class="line"></span><br><span class="line">Q_DECLARE_INTERFACE(PluginInterface, PluginInterface_iid)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// PLUGININTERFACE_H</span></span></span><br></pre></td></tr></table></figure>
<p>很遗憾，Qt 发出了警告：</p>
<blockquote>
<p>warning: Signals cannot be declared virtual</p>
</blockquote>
<p>那么，如何解决这个问题呢？</p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>下面，列出三种解决方案：</p>
<ul>
<li>派生自 <code>QObject</code>，信号不使用 <code>virtual</code></li>
<li>将“信号”定义为一个纯虚函数</li>
<li>在接口中定义信号槽的连接方式</li>
</ul>
<h3 id="派生自-QObject，信号不使用-virtual"><a href="#派生自-QObject，信号不使用-virtual" class="headerlink" title="派生自 QObject，信号不使用 virtual"></a>派生自 <code>QObject</code>，信号不使用 <code>virtual</code></h3><p>不让用 <code>virtual</code>，好吧，那就不用了，这算是最简单的解决方式！</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PLUGININTERFACE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PLUGININTERFACE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QStringList&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtWidgets/qwidget.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PluginInterface</span> :</span> <span class="keyword">public</span> QObject</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~PluginInterface() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">setInitData</span><span class="params">(QStringList &amp;strlist)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">getResultData</span><span class="params">(QStringList &amp;strlist)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">information</span><span class="params">(<span class="keyword">const</span> QString&amp;)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PluginInterface_iid <span class="meta-string">"QtPluginsTest.QtPluginsManager.PluginInterface"</span></span></span><br><span class="line"></span><br><span class="line">Q_DECLARE_INTERFACE(PluginInterface, PluginInterface_iid)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// PLUGININTERFACE_H</span></span></span><br></pre></td></tr></table></figure>
<p>具体的实现也与信号无关了，只需要实现其他接口即可：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> GENERICPLUGIN1_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERICPLUGIN1_H</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtDebug&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;../pluginmanager/plugininterface.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericPlugin1</span> :</span> <span class="keyword">public</span> PluginInterface</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    GenericPlugin1() &#123;&#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setInitData</span><span class="params">(QStringList &amp;strlist)</span> Q_DECL_OVERRIDE </span>&#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"setInitDat..."</span>&lt;&lt;strlist;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getResultData</span><span class="params">(QStringList &amp;strlist)</span> Q_DECL_OVERRIDE </span>&#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"getResultData..."</span>&lt;&lt;strlist;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// GENERICPLUGIN1_H</span></span></span><br></pre></td></tr></table></figure></p>
<p>但是这种方式并不算理想，因为一般来说，接口是一个简单的 C++ 类，不需要派生自 <code>QObject</code> 。</p>
<h3 id="将“信号”定义为一个纯虚函数"><a href="#将“信号”定义为一个纯虚函数" class="headerlink" title="将“信号”定义为一个纯虚函数"></a>将“信号”定义为一个纯虚函数</h3><p>将“信号”定义为一个纯虚函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PLUGININTERFACE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PLUGININTERFACE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QStringList&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtWidgets/qwidget.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PluginInterface</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~PluginInterface() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">setInitData</span><span class="params">(QStringList &amp;strlist)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">getResultData</span><span class="params">(QStringList &amp;strlist)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不是一个信号（但可以当做信号来用），因为 PluginInterface 不是 QObject</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="title">information</span><span class="params">(<span class="keyword">const</span> QString&amp;)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PluginInterface_iid <span class="meta-string">"QtPluginsTest.QtPluginsManager.PluginInterface"</span></span></span><br><span class="line"></span><br><span class="line">Q_DECLARE_INTERFACE(PluginInterface, PluginInterface_iid)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// PLUGININTERFACE_H</span></span></span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong> 对于 <code>PluginInterface</code>来说，<code>information()</code> 只是一个纯虚函数，并不是一个“信号”（但可以当做信号来用），因为 <code>PluginInterface</code> 不是 <code>QObject</code>。</p>
<p>由于需要信号支持，所以具体实现需要派生自 <code>QObject</code>。此外，还需要将 <code>information()</code> 定义为 <code>signals</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> GENERICPLUGIN1_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERICPLUGIN1_H</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtPlugin&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtDebug&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;../pluginmanager/plugininterface.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericPlugin1</span> :</span> <span class="keyword">public</span> QObject, <span class="keyword">public</span> PluginInterface</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    GenericPlugin1() &#123;&#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setInitData</span><span class="params">(QStringList &amp;strlist)</span> Q_DECL_OVERRIDE </span>&#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"setInitDat..."</span>&lt;&lt;strlist;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getResultData</span><span class="params">(QStringList &amp;strlist)</span> Q_DECL_OVERRIDE </span>&#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"getResultData..."</span>&lt;&lt;strlist;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">signals:</span><br><span class="line">    <span class="comment">// 实现由 moc 来完成</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">information</span><span class="params">(<span class="keyword">const</span> QString&amp;)</span> Q_DECL_OVERRIDE</span>;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// GENERICPLUGIN1_H</span></span></span><br></pre></td></tr></table></figure>
<p>这时，<code>information()</code> 的具体的实现在内部是由 <code>moc</code> 来完成的。</p>
<p>为了测试是否有效，再定义一个类 - <code>monitor.h</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MONITOR_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MONITOR_H</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtDebug&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;../pluginmanager/plugininterface.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Monitor</span> :</span> <span class="keyword">public</span> QObject</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"> </span><br><span class="line"><span class="keyword">private</span> slots:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onInformation</span><span class="params">(<span class="keyword">const</span> QString&amp; info)</span> </span>&#123;</span><br><span class="line">        qDebug()  &lt;&lt;<span class="string">"Information..."</span>&lt;&lt; info;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">monitorInformation</span><span class="params">(PluginInterface *plugin)</span> </span>&#123;</span><br><span class="line">        QObject *Object = <span class="keyword">dynamic_cast</span>&lt;QObject *&gt;(plugin);</span><br><span class="line">        <span class="keyword">if</span> (Object) &#123;</span><br><span class="line">            connect(Object, SIGNAL(information(<span class="keyword">const</span> QString&amp;)), <span class="keyword">this</span>, SLOT(onInformation(<span class="keyword">const</span> QString&amp;)));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            qWarning() &lt;&lt; <span class="string">"cannot monitor Information"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// MONITOR_H</span></span></span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong> 连接信号时，需要将其转换为 <code>QObject</code>。</p>
<p>在 <code>main.cpp</code> 中进行测试：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QCoreApplication&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"genericplugin1.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"monitor.h"</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">QCoreApplication <span class="title">a</span><span class="params">(argc, argv)</span></span>;</span><br><span class="line"> </span><br><span class="line">    GenericPlugin1 plugin;</span><br><span class="line">    Monitor monitor;</span><br><span class="line">    monitor.monitorInformation(&amp;plugin);</span><br><span class="line">    emit plugin.information(<span class="string">"ddddddddd"</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> a.exec();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="在接口中定义信号槽的连接方式"><a href="#在接口中定义信号槽的连接方式" class="headerlink" title="在接口中定义信号槽的连接方式"></a>在接口中定义信号槽的连接方式</h3><p>除了上述方式之外，还可以在接口中定义信号槽的连接方式。</p>
<p>首先，定义一个连接信号槽的接口 - <code>connectToInformation()</code>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PLUGININTERFACE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PLUGININTERFACE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QStringList&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtWidgets/qwidget.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PluginInterface</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~PluginInterface() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">setInitData</span><span class="params">(QStringList &amp;strlist)</span> </span>= <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">getResultData</span><span class="params">(QStringList &amp;strlist)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//connect to signals</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">connectToInformation</span><span class="params">(QObject *receiver, <span class="keyword">const</span> <span class="keyword">char</span>* pszSlot, <span class="keyword">bool</span> isConnect = <span class="literal">true</span>)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PluginInterface_iid <span class="meta-string">"QtPluginsTest.QtPluginsManager.PluginInterface"</span></span></span><br><span class="line"></span><br><span class="line">Q_DECLARE_INTERFACE(PluginInterface, PluginInterface_iid)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// PLUGININTERFACE_H</span></span></span><br></pre></td></tr></table></figure>
<p>然后，在派生类中实现信号槽的具体连接：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> GENERICPLUGIN1_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERICPLUGIN1_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtPlugin&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;../pluginmanager/plugininterface.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericPlugin1</span> :</span> <span class="keyword">public</span> QObject, <span class="keyword">public</span> PluginInterface</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// programmer.json 插件的信息描述类</span></span><br><span class="line">    Q_OBJECT</span><br><span class="line">    Q_PLUGIN_METADATA(IID PluginInterface_iid FILE <span class="string">"programmer.json"</span>) <span class="comment">// QT5.0 引入</span></span><br><span class="line">    Q_INTERFACES(PluginInterface)</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    GenericPlugin1() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setInitData</span><span class="params">(QStringList &amp;strlist)</span> Q_DECL_OVERRIDE </span>&#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"setInitDat..."</span> &lt;&lt; strlist;</span><br><span class="line">        <span class="comment">//发射信号</span></span><br><span class="line">        <span class="function">emit <span class="title">information</span><span class="params">(strlist.at(<span class="number">0</span>))</span></span>;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">getResultData</span><span class="params">(QStringList &amp;strlist)</span> Q_DECL_OVERRIDE </span>&#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"getResultData..."</span> &lt;&lt; strlist;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">connectToInformation</span><span class="params">(QObject *receiver, <span class="keyword">const</span> <span class="keyword">char</span> *pszSlot, <span class="keyword">bool</span> isConnect)</span> <span class="keyword">const</span> Q_DECL_OVERRIDE </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(isConnect)</span><br><span class="line">            <span class="keyword">return</span> connect(<span class="keyword">this</span>, SIGNAL(information(<span class="keyword">const</span> QString&amp;)), receiver, pszSlot);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> disconnect(<span class="keyword">this</span>, SIGNAL(information(<span class="keyword">const</span> QString&amp;)), receiver, pszSlot);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">information</span><span class="params">(<span class="keyword">const</span> QString&amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// GENERICPLUGIN1_H</span></span></span><br></pre></td></tr></table></figure>
<p>这样以来，连接方式就变得简单多了。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> MONITOR_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MONITOR_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtDebug&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;../pluginmanager/plugininterface.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Monitor</span> :</span> <span class="keyword">public</span> QObject</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> slots:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onInformation</span><span class="params">(<span class="keyword">const</span> QString&amp; info)</span> </span>&#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"Information..."</span> &lt;&lt; info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">monitorInformation</span><span class="params">(PluginInterface *plugin)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">bool</span> isConnect = plugin-&gt;connectToInformation(<span class="keyword">this</span>, SLOT(<span class="keyword">const</span> onInformation()), <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (isConnect) &#123;</span><br><span class="line">            qWarning() &lt;&lt; <span class="string">"connectToInformation"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            qWarning() &lt;&lt; <span class="string">"cannot monitor Information"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// MONITOR_H</span></span></span><br></pre></td></tr></table></figure>
<p>除了信号槽之外，Qt 还可以通过事件机制（<code>sendEvent()</code> 和 <code>postEvent()</code>）来实现接口之间的通信。正如上所示，只要通过接口来获得 <code>QObject</code> 即可。</p>
<h1 id="插件管理器"><a href="#插件管理器" class="headerlink" title="插件管理器"></a>插件管理器</h1><p>Qt 本身提供了插件相关的技术，但并没有提供一个通用的插件框架！倘若要开发一个较大的 GUI 应用程序，并希望使其可扩展，那么拥有这样一个插件框架无疑会带来很大的好处。</p>
<h2 id="插件系统构成"><a href="#插件系统构成" class="headerlink" title="插件系统构成"></a>插件系统构成</h2><p>插件系统，可以分为三部分：</p>
<ul>
<li>主系统<br>通过插件管理器加载插件，并创建插件对象。一旦插件对象被创建，主系统就会获得相应的指针/引用，它可以像任何其他对象一样使用。</li>
<li>插件管理器<br>用于管理插件的生命周期，并将其暴露给主系统。它负责查找并加载插件，初始化它们，并且能够进行卸载。它还应该让主系统迭代加载的插件或注册的插件对象。</li>
<li>插件<br>插件本身应符合插件管理器协议，并提供符合主系统期望的对象。</li>
</ul>
<p>实际上，很少能看到这样一个相对独立的分离，插件管理器通常与主系统紧密耦合，因为插件管理器需要最终提供（定制）某些类型的插件对象的实例。</p>
<h2 id="程序流"><a href="#程序流" class="headerlink" title="程序流"></a>程序流</h2><p>框架的基本程序流，如下所示：</p>
<p><img src="/img/qt/20171026094150554.png" alt="img"></p>
<h2 id="插件管理器-1"><a href="#插件管理器-1" class="headerlink" title="插件管理器"></a>插件管理器</h2><p>上面提到，插件管理器有一个职责 - 加载插件。那么，是不是所有的插件都需要加载呢？当然不是！只有符合我们约定的插件，才会被认为是标准的、有效的插件，外来插件一律认定为无效。</p>
<p>创建空项目pluginmanager</p>
<p>.pro 文件为：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">QT       -= gui</span><br><span class="line"></span><br><span class="line">TARGET = qtpluginmanager</span><br><span class="line">TEMPLATE = lib</span><br><span class="line"></span><br><span class="line">DEFINES += QTPLUGINSMANAGER_LIBRARY</span><br><span class="line"></span><br><span class="line">win32 &#123;</span><br><span class="line">    CONFIG(debug, debug|release) &#123;</span><br><span class="line">        DESTDIR  = ../Main/debug</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        DESTDIR  = ../Main/release</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DEFINES += QT_DEPRECATED_WARNINGS</span><br><span class="line"></span><br><span class="line">SOURCES += \</span><br><span class="line">    qtpluginmanager.cpp \</span><br><span class="line">    qtpluginsmanagerprivate.cpp</span><br><span class="line"></span><br><span class="line">HEADERS += plugininterface.h \</span><br><span class="line">    pluginmetadata.h \</span><br><span class="line">    qtpluginmanager.h \</span><br><span class="line">    qtpluginsmanager_global.h \</span><br><span class="line">    qtpluginsmanagerprivate.h</span><br></pre></td></tr></table></figure>
<p>为了解决这个问题，可以为插件设定一个“标识(Interface)” - <code>PluginInterface.h</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PLUGININTERFACE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PLUGININTERFACE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pluginmetadata.h"</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PluginInterface</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~PluginInterface() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">setInitData</span><span class="params">(QMap&lt;QString,QVariant&gt; &amp;data)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> QMap&lt;QString,QVariant&gt;&amp; getResultData() = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">recMsgFromManager</span><span class="params">(PluginMetaData &amp;msg)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//connect to signals sendMsgToManager</span></span><br><span class="line">    <span class="comment">//virtual void sendMsgToManager(PluginMetaData &amp;msg) = 0;</span></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">connectTosendMsgToManager</span><span class="params">(QObject *receiver, <span class="keyword">const</span> <span class="keyword">char</span>* pszSlot, <span class="keyword">bool</span> isConnect = <span class="literal">true</span>)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PluginInterface_iid <span class="meta-string">"QtPlugins.QtPluginsManager.PluginInterface"</span></span></span><br><span class="line"></span><br><span class="line">Q_DECLARE_INTERFACE(PluginInterface, PluginInterface_iid)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// PLUGININTERFACE_H</span></span></span><br></pre></td></tr></table></figure>
<p>后期实现的所有插件，都必须继承自 <code>PluginInterface</code>，这样才会被认定是自己的插件，以防外部插件注入。</p>
<p><strong>注意：</strong>使用 <code>Q_DECLARE_INTERFACE</code> 宏，将 <code>PluginInterface</code>接口与标识符一起公开。</p>
<p>插件的基本约束有了，插件的具体实现插件管理器并不关心，它所要做的工作是加载插件、卸载插件、检测插件的依赖、以及扫描插件的元数据（Json 文件中的内容）。。。为了便于操作，将其实现为一个单例。</p>
<p><code>qtpluginsmanager_global.h</code>内容如下：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> QTPLUGINSMANAGER_GLOBAL_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> QTPLUGINSMANAGER_GLOBAL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtCore/qglobal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(QTPLUGINSMANAGER_LIBRARY)</span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> QTPLUGINSMANAGERSHARED_EXPORT Q_DECL_EXPORT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> QTPLUGINSMANAGERSHARED_EXPORT Q_DECL_IMPORT</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// QTPLUGINSMANAGER_GLOBAL_H</span></span></span><br></pre></td></tr></table></figure>
<p><code>qtpluginmanager.h</code>内容如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> QTPLUGINSMANAGER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> QTPLUGINSMANAGER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"qtpluginsmanager_global.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pluginmetadata.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QPluginLoader&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QVariant&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QtPluginsManagerPrivate</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QTPLUGINSMANAGERSHARED_EXPORT</span> <span class="title">QtPluginsManager</span> :</span> <span class="keyword">public</span> QObject</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    QtPluginsManager();</span><br><span class="line">    ~QtPluginsManager();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> QtPluginsManager *<span class="title">instance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(m_instance==<span class="literal">nullptr</span>)</span><br><span class="line">            m_instance=<span class="keyword">new</span> QtPluginsManager();</span><br><span class="line">        <span class="keyword">return</span> m_instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载所有插件</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">loadAllPlugins</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//扫描JSON文件中的插件元数据</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">scanMetaData</span><span class="params">(<span class="keyword">const</span> QString &amp;filepath)</span></span>;</span><br><span class="line">    <span class="comment">//加载其中某个插件</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">loadPlugin</span><span class="params">(<span class="keyword">const</span> QString &amp;filepath)</span></span>;</span><br><span class="line">    <span class="comment">//卸载所有插件</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unloadAllPlugins</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//卸载某个插件</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unloadPlugin</span><span class="params">(<span class="keyword">const</span> QString &amp;filepath)</span></span>;</span><br><span class="line">    <span class="comment">//获取所有插件</span></span><br><span class="line">    QList&lt;QPluginLoader *&gt; allPlugins();</span><br><span class="line">    <span class="comment">//获取某个插件</span></span><br><span class="line">    <span class="function">QPluginLoader* <span class="title">getPlugin</span><span class="params">(<span class="keyword">const</span> QString &amp;name)</span></span>;</span><br><span class="line">    <span class="comment">//获取所有插件名称</span></span><br><span class="line">    QList&lt;QVariant&gt; allPluginsName();</span><br><span class="line">    <span class="comment">//获取某个插件名称</span></span><br><span class="line">    <span class="function">QVariant <span class="title">getPluginName</span><span class="params">(QPluginLoader *loader)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">static</span> QtPluginsManager *m_instance;</span><br><span class="line">    QtPluginsManagerPrivate *d;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> slots:</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">recMsgFromManager</span><span class="params">(PluginMetaData&amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>可以看到，插件管理器中有一个 <code>d</code> 指针，它包含了插件元数据的哈希表。此外，由于其拥有所有插件的元数据，所以还为其赋予了另外一个职能 - 检测插件的依赖关系：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> QTPLUGINSMANAGERPRIVATE_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> QTPLUGINSMANAGERPRIVATE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QHash&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QVariant&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QPluginLoader&gt;</span></span></span><br><span class="line"></span><br><span class="line">class QtPluginsManagerPrivate</span><br><span class="line">&#123;</span><br><span class="line"><span class="symbol">public:</span></span><br><span class="line">    <span class="comment">//插件依赖检测</span></span><br><span class="line">    bool check(const QString <span class="variable">&amp;filepath</span>);</span><br><span class="line"></span><br><span class="line">    QHash<span class="params">&lt;QString, QVariant&gt;</span> m_names; <span class="comment">//插件路径--插件名称</span></span><br><span class="line">    QHash<span class="params">&lt;QString, QVariant&gt;</span> m_versions; <span class="comment">//插件路径--插件版本</span></span><br><span class="line">    QHash<span class="params">&lt;QString, QVariantList&gt;</span>m_dependencies; <span class="comment">//插件路径--插件额外依赖的其他插件</span></span><br><span class="line">    QHash<span class="params">&lt;QString, QPluginLoader *&gt;</span>m_loaders; <span class="comment">//插件路径--QPluginLoader实例</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// QTPLUGINSMANAGERPRIVATE_H</span></span></span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong> 这里的 <code>check()</code> 是一个递归调用，因为很有可能存在“插件A”依赖于“插件B”，而“插件B”又依赖于“插件C”的连续依赖情况。</p>
<p><code>QtPluginsManagerPrivate</code>中的哈希表在初始化插件管理器时被填充：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="string">QtPluginsManager:</span>:loadAllPlugins()</span><br><span class="line">&#123;</span><br><span class="line">    QDir pluginsdir = QDir(qApp-&gt;applicationDirPath());</span><br><span class="line">    pluginsdir.cd(<span class="string">"plugins"</span>);</span><br><span class="line"></span><br><span class="line">    QFileInfoList pluginsInfo = pluginsdir.entryInfoList(<span class="string">QDir:</span>:Files | <span class="string">QDir:</span>:NoDotAndDotDot);</span><br><span class="line">    <span class="comment">//初始化插件中的元数据</span></span><br><span class="line">    <span class="keyword">for</span>(QFileInfo <span class="string">fileinfo :</span> pluginsInfo)</span><br><span class="line">        scanMetaData(fileinfo.absoluteFilePath());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载插件</span></span><br><span class="line">    <span class="keyword">for</span>(QFileInfo <span class="string">fileinfo :</span> pluginsInfo)</span><br><span class="line">        loadPlugin(fileinfo.absoluteFilePath());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>元数据的具体扫描由 <code>scan()</code> 负责：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">void QtPluginsManager::scanMetaData(<span class="keyword">const</span> QString &amp;filepath)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//判断是否为库（后缀有效性）</span></span><br><span class="line">    <span class="keyword">if</span>(!QLibrary::isLibrary(filepath))</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    <span class="comment">//获取元数据</span></span><br><span class="line">    QPluginLoader *loader = <span class="keyword">new</span> QPluginLoader(filepath);</span><br><span class="line">    QJsonObject json = loader-&gt;metaData().value(<span class="string">"MetaData"</span>).toObject();</span><br><span class="line"></span><br><span class="line">    QVariant <span class="keyword">var</span> = json.value(<span class="string">"name"</span>).toVariant();</span><br><span class="line">    d-&gt;m_names.insert(filepath, json.value(<span class="string">"name"</span>).toVariant());</span><br><span class="line">    d-&gt;m_versions.insert(filepath, json.value(<span class="string">"version"</span>).toVariant());</span><br><span class="line">    d-&gt;m_dependencies.insert(filepath, json.value(<span class="string">"dependencies"</span>).toArray().toVariantList());</span><br><span class="line"></span><br><span class="line">    delete loader;</span><br><span class="line">    loader = nullptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一旦所有元数据被扫描，便可以检查是否能够加载插件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">void QtPluginsManager::loadPlugin(<span class="keyword">const</span> QString &amp;filepath)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(!QLibrary::isLibrary(filepath))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检测依赖</span></span><br><span class="line">    <span class="keyword">if</span>(!d-&gt;check(filepath))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加载插件</span></span><br><span class="line">    QPluginLoader *loader = <span class="keyword">new</span> QPluginLoader(filepath);</span><br><span class="line">    <span class="keyword">if</span>(loader-&gt;load())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 如果继承自 Plugin，则认为是自己的插件（防止外部插件注入）。</span></span><br><span class="line">        PluginInterface *plugin = qobject_cast&lt;PluginInterface *&gt;(loader-&gt;instance());</span><br><span class="line">        <span class="keyword">if</span>(plugin)</span><br><span class="line">        &#123;</span><br><span class="line">            d-&gt;m_loaders.insert(filepath, loader);</span><br><span class="line">            plugin-&gt;connectTosendMsgToManager(this, SLOT(recMsgFromManager(PluginMetaData&amp;)), <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            delete loader;</span><br><span class="line">            loader = nullptr;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong> 这里用到了前面提到的标识 - <code>PluginInterface</code>，只有 <code>qobject_cast</code> 转换成功，才会加载到主系统中，这可以算作是真正意义上的第一道防线。</p>
<p>实际上，在内部检查是通过调用 <code>QtPluginManagerPrivate::check()</code> 递归地查询依赖元数据来完成的。</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">bool QtPluginsManagerPrivate::check(const QString &amp;filepath)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(QVariant <span class="type">item</span> : m_dependencies.<span class="keyword">value</span>(filepath))</span><br><span class="line">    &#123;</span><br><span class="line">        QVariantMap <span class="keyword">map</span> = <span class="type">item</span>.toMap();</span><br><span class="line">        //依赖的插件名称、版本、路径</span><br><span class="line">        QVariant<span class="built_in"> name</span> = <span class="keyword">map</span>.<span class="keyword">value</span>(<span class="string">"name"</span>);</span><br><span class="line">        QVariant version = <span class="keyword">map</span>.<span class="keyword">value</span>(<span class="string">"version"</span>);</span><br><span class="line">        QString<span class="built_in"> path</span> = m_names<span class="built_in">.key</span><span class="built_in">(name</span>);</span><br><span class="line"></span><br><span class="line">        /********** 检测插件是否依赖于其他插件 **********/</span><br><span class="line">        // 先检测插件名称</span><br><span class="line">        <span class="keyword">if</span>(!m_names.values()<span class="built_in">.contains</span><span class="built_in">(name</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            QString strcons = <span class="string">"Missing dependency: "</span>+<span class="built_in"> name</span>.toString()+<span class="string">" for plugin "</span><span class="built_in">+path</span>;</span><br><span class="line">            qDebug()&lt;&lt;Q_FUNC_INFO&lt;&lt;strcons;</span><br><span class="line">            //QMessageBox::warning(nullptr, (<span class="string">"Plugins Loader Error"</span>), strcons, QMessageBox::Ok);</span><br><span class="line">            <span class="keyword">return</span><span class="built_in"> false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        //再检测插件版本</span><br><span class="line">        <span class="keyword">if</span>(m_versions.<span class="keyword">value</span><span class="built_in">(path</span>) != version)</span><br><span class="line">        &#123;</span><br><span class="line">            QString strcons = <span class="string">"Version mismatch: "</span> +<span class="built_in"> name</span>.toString() +<span class="string">" version "</span>+m_versions.<span class="keyword">value</span>(m_names<span class="built_in">.key</span><span class="built_in">(name</span>)).toString()+</span><br><span class="line">                              <span class="string">" but "</span> + version.toString() + <span class="string">" required for plugin "</span><span class="built_in">+path</span>;</span><br><span class="line">            qDebug()&lt;&lt;Q_FUNC_INFO&lt;&lt;strcons;</span><br><span class="line">            //QMessageBox::warning(nullptr, <span class="string">"Plugins Loader Error"</span>, strcons, QMessageBox::Ok);</span><br><span class="line">            <span class="keyword">return</span><span class="built_in"> false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        //最后检测被依赖的插件是否还依赖其他的插件</span><br><span class="line">        <span class="keyword">if</span>(!check<span class="built_in">(path</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            QString strcons = <span class="string">"Corrupted dependency: "</span><span class="built_in">+name</span>.toString()+<span class="string">" for plugin "</span><span class="built_in">+path</span>;</span><br><span class="line">            qDebug()&lt;&lt;Q_FUNC_INFO&lt;&lt;strcons;</span><br><span class="line">            //QMessageBox::warning(nullptr, <span class="string">"Plugins Loader Error"</span>, strcons, QMessageBox::Ok);</span><br><span class="line">            <span class="keyword">return</span><span class="built_in"> false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span><span class="built_in"> true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>插件卸载的过程正好相反：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="string">QtPluginsManager:</span>:unloadAllPlugins()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(QString <span class="string">filepath :</span> d-&gt;m_loaders.keys())</span><br><span class="line">        unloadPlugin(filepath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而具体的卸载由 <code>unloadPlugin()</code> 来完成：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> QtPluginsManager::unloadPlugin(<span class="keyword">const</span> QString &amp;filepath)</span><br><span class="line">&#123;</span><br><span class="line">    QPluginLoader *loader = d-&gt;m_loaders.value(filepath);</span><br><span class="line">    <span class="comment">//卸载插件，并从内部数据结构中移除</span></span><br><span class="line">    <span class="keyword">if</span>(loader-&gt;unload())</span><br><span class="line">    &#123;</span><br><span class="line">        d-&gt;m_loaders.remove(filepath);</span><br><span class="line">        <span class="keyword">delete</span> loader;</span><br><span class="line">        loader = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>万事俱备，然后返回所有的插件，以便主系统访问：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">QList&lt;QPluginLoader *&gt; QtPluginsManager::allPlugins()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> d-&gt;m_loaders.values();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>槽recMsgFromManager：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> QtPluginsManager::recMsgFromManager(PluginMetaData &amp;msg)</span><br><span class="line">&#123;</span><br><span class="line">     qDebug()  &lt;&lt;<span class="string">"QtPluginsManager::recMsgFromManager..."</span>&lt;&lt; msg.dest;</span><br><span class="line">     <span class="keyword">auto</span> loader = getPlugin(msg.dest);</span><br><span class="line">     <span class="keyword">if</span>(loader)</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">auto</span> plugin = qobject_cast&lt;PluginInterface*&gt;(loader-&gt;instance());;</span><br><span class="line">         <span class="keyword">if</span>(plugin)</span><br><span class="line">         &#123;</span><br><span class="line">             plugin-&gt;recMsgFromManager(msg);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，整个插件管理的机制已经建立起来了，剩下的事基本就比较简单了！插件的编写、插件之间的交互。</p>
<h2 id="编写插件"><a href="#编写插件" class="headerlink" title="编写插件"></a>编写插件</h2><p>插件1：GenericPlugin1，.pro、.h文件如下：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATE        = <span class="class"><span class="keyword">lib</span>           <span class="comment">#表示这个makefile是一个lib的makefile</span></span></span><br><span class="line">CONFIG         += plugin        <span class="comment">#应用程序是一个插件</span></span><br><span class="line">TARGET          = GenericPlugin1       <span class="comment">#生成插件的名称</span></span><br><span class="line">win32 &#123;</span><br><span class="line">    CONFIG(debug, debug|release) &#123;</span><br><span class="line">        DESTDIR  = ../Main/debug/plugins</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        DESTDIR  = ../Main/release/plugins</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="comment">#生成插件的目录</span></span><br><span class="line"></span><br><span class="line">HEADERS += \</span><br><span class="line">    genericplugin1.h</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DISTFILES += \</span><br><span class="line">    programmer.json             <span class="comment">#插件描述文件</span></span><br><span class="line"></span><br><span class="line">msvc &#123;</span><br><span class="line">    <span class="comment">#QMAKE_CFLAGS += /utf-8</span></span><br><span class="line">    QMAKE_CXXFLAGS += <span class="regexp">/utf-8</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> GENERICPLUGIN1_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERICPLUGIN1_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtPlugin&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"../qtpluginmanager/pluginmetadata.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"../qtpluginmanager/plugininterface.h"</span></span></span><br><span class="line"></span><br><span class="line">class GenericPlugin1 : <span class="keyword">public</span> QObject, <span class="keyword">public</span> PluginInterface</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// programmer.json 插件的信息描述类</span></span><br><span class="line">    Q_OBJECT</span><br><span class="line">    Q_PLUGIN_METADATA(IID PluginInterface_iid FILE <span class="string">"programmer.json"</span>) <span class="comment">// QT5.0 引入</span></span><br><span class="line">    Q_INTERFACES(PluginInterface)</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    GenericPlugin1() &#123;&#125;</span><br><span class="line">    ~GenericPlugin1() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setInitData(QMap&lt;QString,QVariant&gt; &amp;data) Q_DECL_OVERRIDE &#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"GenericPlugin1 setInitDat..."</span> &lt;&lt; data;</span><br><span class="line">        <span class="built_in">map</span>=&amp;data;</span><br><span class="line">        </span><br><span class="line">        #测试插件<span class="number">1</span>发送信息给插件<span class="number">2</span>  </span><br><span class="line">        PluginMetaData metadata;</span><br><span class="line">        metadata.from = <span class="string">"GenericPlugin1"</span>;</span><br><span class="line">        metadata.dest = <span class="string">"GenericPlugin2"</span>;</span><br><span class="line">        metadata.type = <span class="number">1</span>;</span><br><span class="line">        emit sendMsgToManager(metadata);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    QMap&lt;QString,QVariant&gt;&amp; getResultData() Q_DECL_OVERRIDE &#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"GenericPlugin1 getResultData..."</span>;</span><br><span class="line">        <span class="built_in">return</span> *<span class="built_in">map</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> recMsgFromManager(PluginMetaData &amp;msg) Q_DECL_OVERRIDE &#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"GenericPlugin1 recMsgFromManager..."</span> &lt;&lt; msg.from;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> connectTosendMsgToManager(QObject *receiver, <span class="keyword">const</span> <span class="keyword">char</span> *pszSlot, <span class="keyword">bool</span> isConnect) <span class="keyword">const</span> Q_DECL_OVERRIDE &#123;</span><br><span class="line">        <span class="built_in">if</span>(isConnect)</span><br><span class="line">            <span class="built_in">return</span> <span class="built_in">connect</span>(<span class="keyword">this</span>, SIGNAL(sendMsgToManager(PluginMetaData&amp;)), receiver, pszSlot);</span><br><span class="line">        <span class="built_in">else</span></span><br><span class="line">            <span class="built_in">return</span> <span class="built_in">disconnect</span>(<span class="keyword">this</span>, SIGNAL(sendMsgToManager(PluginMetaData&amp;)), receiver, pszSlot);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    QMap&lt;QString,QVariant&gt; *<span class="built_in">map</span>;</span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line">    <span class="keyword">void</span> sendMsgToManager(PluginMetaData&amp;);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// GENERICPLUGIN1_H</span></span></span><br></pre></td></tr></table></figure>
<p>插件2：GenericPlugin1，.pro、.h文件如下：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATE        = <span class="class"><span class="keyword">lib</span>           <span class="comment">#表示这个makefile是一个lib的makefile</span></span></span><br><span class="line">CONFIG         += plugin        <span class="comment">#应用程序是一个插件</span></span><br><span class="line">TARGET          = GenericPlugin2       <span class="comment">#生成插件的名称</span></span><br><span class="line">win32 &#123;</span><br><span class="line">    CONFIG(debug, debug|release) &#123;</span><br><span class="line">        DESTDIR  = ../Main/debug/plugins</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        DESTDIR  = ../Main/release/plugins</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="comment">#生成插件的目录</span></span><br><span class="line"></span><br><span class="line">HEADERS += \</span><br><span class="line">    genericplugin2.h</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DISTFILES += \</span><br><span class="line">    programmer.json             <span class="comment">#插件描述文件</span></span><br><span class="line"></span><br><span class="line">msvc &#123;</span><br><span class="line">    <span class="comment">#QMAKE_CFLAGS += /utf-8</span></span><br><span class="line">    QMAKE_CXXFLAGS += <span class="regexp">/utf-8</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> GENERICPLUGIN2_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GENERICPLUGIN2_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QObject&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QtPlugin&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"../qtpluginmanager/pluginmetadata.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"../qtpluginmanager/plugininterface.h"</span></span></span><br><span class="line"></span><br><span class="line">class GenericPlugin2 : <span class="keyword">public</span> QObject, <span class="keyword">public</span> PluginInterface</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// programmer.json 插件的信息描述类</span></span><br><span class="line">    Q_OBJECT</span><br><span class="line">    Q_PLUGIN_METADATA(IID PluginInterface_iid FILE <span class="string">"programmer.json"</span>) <span class="comment">// QT5.0 引入</span></span><br><span class="line">    Q_INTERFACES(PluginInterface)</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    GenericPlugin2() &#123;&#125;</span><br><span class="line">    ~GenericPlugin2() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> setInitData(QMap&lt;QString,QVariant&gt; &amp;data) Q_DECL_OVERRIDE &#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"GenericPlugin2 setInitDat..."</span> &lt;&lt; data;</span><br><span class="line">        <span class="built_in">map</span>=&amp;data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    QMap&lt;QString,QVariant&gt;&amp; getResultData() Q_DECL_OVERRIDE &#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"GenericPlugin2 getResultData..."</span>;</span><br><span class="line">        <span class="built_in">return</span> *<span class="built_in">map</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> recMsgFromManager(PluginMetaData &amp;msg) Q_DECL_OVERRIDE &#123;</span><br><span class="line">        qDebug() &lt;&lt; <span class="string">"GenericPlugin2 recMsgFromManager..."</span> &lt;&lt; msg.from;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> connectTosendMsgToManager(QObject *receiver, <span class="keyword">const</span> <span class="keyword">char</span> *pszSlot, <span class="keyword">bool</span> isConnect) <span class="keyword">const</span> Q_DECL_OVERRIDE &#123;</span><br><span class="line">        <span class="built_in">if</span>(isConnect)</span><br><span class="line">            <span class="built_in">return</span> <span class="built_in">connect</span>(<span class="keyword">this</span>, SIGNAL(sendMsgToManager(PluginMetaData&amp;)), receiver, pszSlot);</span><br><span class="line">        <span class="built_in">else</span></span><br><span class="line">            <span class="built_in">return</span> <span class="built_in">disconnect</span>(<span class="keyword">this</span>, SIGNAL(sendMsgToManager(PluginMetaData&amp;)), receiver, pszSlot);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    QMap&lt;QString,QVariant&gt; *<span class="built_in">map</span>;</span><br><span class="line"></span><br><span class="line">signals:</span><br><span class="line">    <span class="keyword">void</span> sendMsgToManager(PluginMetaData&amp;);</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">// GENERICPLUGIN2_H</span></span></span><br></pre></td></tr></table></figure>
<h2 id="测试插件通讯"><a href="#测试插件通讯" class="headerlink" title="测试插件通讯"></a>测试插件通讯</h2><p>测试插件1发送信息给插件2：</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Q<span class="function"><span class="title">tPluginsManager</span>::instance()-&gt;</span>loadAllPlugins();<span class="comment">//插件管理器 加载所有插件</span></span><br><span class="line"><span class="function"><span class="title">auto</span> plugins=QtPluginsManager::instance()-&gt;</span>allPlugins();</span><br><span class="line">foreach(auto plugin,plugins)</span><br><span class="line">&#123;</span><br><span class="line">    P<span class="function"><span class="title">luginInterface</span> *app = qobject_cast&lt;PluginInterface*&gt;(plugin-&gt;</span>instance());</span><br><span class="line">    <span class="keyword">if</span> (app)</span><br><span class="line">    &#123;</span><br><span class="line">        QMap&lt;QString,QVariant&gt; <span class="keyword">data</span>;</span><br><span class="line">        <span class="keyword">data</span>.insert(<span class="string">"0001"</span>,<span class="number">10000</span>);</span><br><span class="line">        <span class="function"><span class="title">app</span>-&gt;</span>setInitData(<span class="keyword">data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Q<span class="function"><span class="title">tPluginsManager</span>::instance()-&gt;</span>unloadAllPlugins();</span><br></pre></td></tr></table></figure>
<p>打印出如下信息，说明成功。</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">GenericPlugin2</span></span> setInitDat... QMap((<span class="string">"0001"</span>, QVariant(int, <span class="number">10000</span>)))</span><br><span class="line"><span class="function"><span class="title">GenericPlugin1</span></span> setInitDat... QMap((<span class="string">"0001"</span>, QVariant(int, <span class="number">10000</span>)))</span><br><span class="line">QtPluginsManager::recMsgFromManager... <span class="string">"GenericPlugin2"</span></span><br><span class="line"><span class="function"><span class="title">GenericPlugin2</span></span> recMsgFromManager... <span class="string">"GenericPlugin1"</span></span><br></pre></td></tr></table></figure>
    </div>
    
    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 © <a href="/" target="_blank">Ljjyy.com</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/archives/2021/05/100670.html" class="pre-post btn btn-default" title='C/C++ 开源算法库'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">C/C++ 开源算法库</span>
        </a>
    
    
        <a href="/archives/2021/04/100668.html" class="next-post btn btn-default" title='Qt 编程风格与规范'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">Qt 编程风格与规范</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	
    <div id="vcomments" class="valine"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="/assets/valine.min.js"></script>

    <script>
        new Valine({
            av: AV,
            el: '#vcomments',
            appId: '5MzTXYXkt03k101j0PmSDN34-gzGzoHsz',
            appKey: 'iwjYgwno6qj3wtDVVSbe8nYQ',
            placeholder: '说点什么吧',
            notify: false,
            verify: true,
            avatar: 'mm',
            meta: 'nick,mail'.split(','),
            pageSize: '10',
            path: window.location.pathname,
            lang: 'zh-CN'.toLowerCase()
        })
    </script>


    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#初识QtPlugin"><span class="toc-text">初识QtPlugin</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实例"><span class="toc-text">实例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#元信息metaData"><span class="toc-text">元信息metaData</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JSON-与Qt插件的元信息-MetaData"><span class="toc-text">JSON 与Qt插件的元信息 MetaData</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Qt中的JSON相关类"><span class="toc-text">Qt中的JSON相关类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#接口间通信"><span class="toc-text">接口间通信</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一些尝试"><span class="toc-text">一些尝试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解决方案"><span class="toc-text">解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#派生自-QObject，信号不使用-virtual"><span class="toc-text">派生自 QObject，信号不使用 virtual</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#将“信号”定义为一个纯虚函数"><span class="toc-text">将“信号”定义为一个纯虚函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在接口中定义信号槽的连接方式"><span class="toc-text">在接口中定义信号槽的连接方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#插件管理器"><span class="toc-text">插件管理器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#插件系统构成"><span class="toc-text">插件系统构成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#程序流"><span class="toc-text">程序流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#插件管理器-1"><span class="toc-text">插件管理器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编写插件"><span class="toc-text">编写插件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试插件通讯"><span class="toc-text">测试插件通讯</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="busuanzi">
    
</div>

            </div>
            <div class="col-sm-12">
                <span>Copyright &copy; 2019-2023&emsp;<a href="/" class="copyright-links" target="_blank" rel="nofollow">Ljjyy.com</a>
                </span> |
                <span>
                    <a href="/about/" class="copyright-links" target="_blank" rel="nofollow">关于我们</a>
                </span> |                
                <span>
                    <a href="/sitemap.xml" class="copyright-links" target="_blank" rel="nofollow">网站地图</a>
                </span> |
                <span>
                    <a href="/archives/" class="copyright-links" target="_blank" rel="nofollow">时间轴</a>
                </span>              
            </div>
        </div>
    </div>
</div>







<script src="/js/app.js?rev=@@hash"></script>

</body>
</html>